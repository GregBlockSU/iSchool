/**
 * Global config object that can be require'd anywhere in the code
 * @returns {Object}   Global config object
 */
define('home/config',[
], function (
) {
    'use strict';

    // global config object
    return {
        appRoot: '/',
    };
});

/*!
 * jQuery JavaScript Library v2.2.4
 * http://jquery.com/
 *
 * Includes Sizzle.js
 * http://sizzlejs.com/
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license
 * http://jquery.org/license
 *
 * Date: 2016-05-20T17:23Z
 */

(function( global, factory ) {

	if ( typeof module === "object" && typeof module.exports === "object" ) {
		// For CommonJS and CommonJS-like environments where a proper `window`
		// is present, execute the factory and get jQuery.
		// For environments that do not have a `window` with a `document`
		// (such as Node.js), expose a factory as module.exports.
		// This accentuates the need for the creation of a real `window`.
		// e.g. var jQuery = require("jquery")(window);
		// See ticket #14549 for more info.
		module.exports = global.document ?
			factory( global, true ) :
			function( w ) {
				if ( !w.document ) {
					throw new Error( "jQuery requires a window with a document" );
				}
				return factory( w );
			};
	} else {
		factory( global );
	}

// Pass this if window is not defined yet
}(typeof window !== "undefined" ? window : this, function( window, noGlobal ) {

// Support: Firefox 18+
// Can't be in strict mode, several libs including ASP.NET trace
// the stack via arguments.caller.callee and Firefox dies if
// you try to trace through "use strict" call chains. (#13335)
//"use strict";
var arr = [];

var document = window.document;

var slice = arr.slice;

var concat = arr.concat;

var push = arr.push;

var indexOf = arr.indexOf;

var class2type = {};

var toString = class2type.toString;

var hasOwn = class2type.hasOwnProperty;

var support = {};



var
	version = "2.2.4",

	// Define a local copy of jQuery
	jQuery = function( selector, context ) {

		// The jQuery object is actually just the init constructor 'enhanced'
		// Need init if jQuery is called (just allow error to be thrown if not included)
		return new jQuery.fn.init( selector, context );
	},

	// Support: Android<4.1
	// Make sure we trim BOM and NBSP
	rtrim = /^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,

	// Matches dashed string for camelizing
	rmsPrefix = /^-ms-/,
	rdashAlpha = /-([\da-z])/gi,

	// Used by jQuery.camelCase as callback to replace()
	fcamelCase = function( all, letter ) {
		return letter.toUpperCase();
	};

jQuery.fn = jQuery.prototype = {

	// The current version of jQuery being used
	jquery: version,

	constructor: jQuery,

	// Start with an empty selector
	selector: "",

	// The default length of a jQuery object is 0
	length: 0,

	toArray: function() {
		return slice.call( this );
	},

	// Get the Nth element in the matched element set OR
	// Get the whole matched element set as a clean array
	get: function( num ) {
		return num != null ?

			// Return just the one element from the set
			( num < 0 ? this[ num + this.length ] : this[ num ] ) :

			// Return all the elements in a clean array
			slice.call( this );
	},

	// Take an array of elements and push it onto the stack
	// (returning the new matched element set)
	pushStack: function( elems ) {

		// Build a new jQuery matched element set
		var ret = jQuery.merge( this.constructor(), elems );

		// Add the old object onto the stack (as a reference)
		ret.prevObject = this;
		ret.context = this.context;

		// Return the newly-formed element set
		return ret;
	},

	// Execute a callback for every element in the matched set.
	each: function( callback ) {
		return jQuery.each( this, callback );
	},

	map: function( callback ) {
		return this.pushStack( jQuery.map( this, function( elem, i ) {
			return callback.call( elem, i, elem );
		} ) );
	},

	slice: function() {
		return this.pushStack( slice.apply( this, arguments ) );
	},

	first: function() {
		return this.eq( 0 );
	},

	last: function() {
		return this.eq( -1 );
	},

	eq: function( i ) {
		var len = this.length,
			j = +i + ( i < 0 ? len : 0 );
		return this.pushStack( j >= 0 && j < len ? [ this[ j ] ] : [] );
	},

	end: function() {
		return this.prevObject || this.constructor();
	},

	// For internal use only.
	// Behaves like an Array's method, not like a jQuery method.
	push: push,
	sort: arr.sort,
	splice: arr.splice
};

jQuery.extend = jQuery.fn.extend = function() {
	var options, name, src, copy, copyIsArray, clone,
		target = arguments[ 0 ] || {},
		i = 1,
		length = arguments.length,
		deep = false;

	// Handle a deep copy situation
	if ( typeof target === "boolean" ) {
		deep = target;

		// Skip the boolean and the target
		target = arguments[ i ] || {};
		i++;
	}

	// Handle case when target is a string or something (possible in deep copy)
	if ( typeof target !== "object" && !jQuery.isFunction( target ) ) {
		target = {};
	}

	// Extend jQuery itself if only one argument is passed
	if ( i === length ) {
		target = this;
		i--;
	}

	for ( ; i < length; i++ ) {

		// Only deal with non-null/undefined values
		if ( ( options = arguments[ i ] ) != null ) {

			// Extend the base object
			for ( name in options ) {
				src = target[ name ];
				copy = options[ name ];

				// Prevent never-ending loop
				if ( target === copy ) {
					continue;
				}

				// Recurse if we're merging plain objects or arrays
				if ( deep && copy && ( jQuery.isPlainObject( copy ) ||
					( copyIsArray = jQuery.isArray( copy ) ) ) ) {

					if ( copyIsArray ) {
						copyIsArray = false;
						clone = src && jQuery.isArray( src ) ? src : [];

					} else {
						clone = src && jQuery.isPlainObject( src ) ? src : {};
					}

					// Never move original objects, clone them
					target[ name ] = jQuery.extend( deep, clone, copy );

				// Don't bring in undefined values
				} else if ( copy !== undefined ) {
					target[ name ] = copy;
				}
			}
		}
	}

	// Return the modified object
	return target;
};

jQuery.extend( {

	// Unique for each copy of jQuery on the page
	expando: "jQuery" + ( version + Math.random() ).replace( /\D/g, "" ),

	// Assume jQuery is ready without the ready module
	isReady: true,

	error: function( msg ) {
		throw new Error( msg );
	},

	noop: function() {},

	isFunction: function( obj ) {
		return jQuery.type( obj ) === "function";
	},

	isArray: Array.isArray,

	isWindow: function( obj ) {
		return obj != null && obj === obj.window;
	},

	isNumeric: function( obj ) {

		// parseFloat NaNs numeric-cast false positives (null|true|false|"")
		// ...but misinterprets leading-number strings, particularly hex literals ("0x...")
		// subtraction forces infinities to NaN
		// adding 1 corrects loss of precision from parseFloat (#15100)
		var realStringObj = obj && obj.toString();
		return !jQuery.isArray( obj ) && ( realStringObj - parseFloat( realStringObj ) + 1 ) >= 0;
	},

	isPlainObject: function( obj ) {
		var key;

		// Not plain objects:
		// - Any object or value whose internal [[Class]] property is not "[object Object]"
		// - DOM nodes
		// - window
		if ( jQuery.type( obj ) !== "object" || obj.nodeType || jQuery.isWindow( obj ) ) {
			return false;
		}

		// Not own constructor property must be Object
		if ( obj.constructor &&
				!hasOwn.call( obj, "constructor" ) &&
				!hasOwn.call( obj.constructor.prototype || {}, "isPrototypeOf" ) ) {
			return false;
		}

		// Own properties are enumerated firstly, so to speed up,
		// if last one is own, then all properties are own
		for ( key in obj ) {}

		return key === undefined || hasOwn.call( obj, key );
	},

	isEmptyObject: function( obj ) {
		var name;
		for ( name in obj ) {
			return false;
		}
		return true;
	},

	type: function( obj ) {
		if ( obj == null ) {
			return obj + "";
		}

		// Support: Android<4.0, iOS<6 (functionish RegExp)
		return typeof obj === "object" || typeof obj === "function" ?
			class2type[ toString.call( obj ) ] || "object" :
			typeof obj;
	},

	// Evaluates a script in a global context
	globalEval: function( code ) {
		var script,
			indirect = eval;

		code = jQuery.trim( code );

		if ( code ) {

			// If the code includes a valid, prologue position
			// strict mode pragma, execute code by injecting a
			// script tag into the document.
			if ( code.indexOf( "use strict" ) === 1 ) {
				script = document.createElement( "script" );
				script.text = code;
				document.head.appendChild( script ).parentNode.removeChild( script );
			} else {

				// Otherwise, avoid the DOM node creation, insertion
				// and removal by using an indirect global eval

				indirect( code );
			}
		}
	},

	// Convert dashed to camelCase; used by the css and data modules
	// Support: IE9-11+
	// Microsoft forgot to hump their vendor prefix (#9572)
	camelCase: function( string ) {
		return string.replace( rmsPrefix, "ms-" ).replace( rdashAlpha, fcamelCase );
	},

	nodeName: function( elem, name ) {
		return elem.nodeName && elem.nodeName.toLowerCase() === name.toLowerCase();
	},

	each: function( obj, callback ) {
		var length, i = 0;

		if ( isArrayLike( obj ) ) {
			length = obj.length;
			for ( ; i < length; i++ ) {
				if ( callback.call( obj[ i ], i, obj[ i ] ) === false ) {
					break;
				}
			}
		} else {
			for ( i in obj ) {
				if ( callback.call( obj[ i ], i, obj[ i ] ) === false ) {
					break;
				}
			}
		}

		return obj;
	},

	// Support: Android<4.1
	trim: function( text ) {
		return text == null ?
			"" :
			( text + "" ).replace( rtrim, "" );
	},

	// results is for internal usage only
	makeArray: function( arr, results ) {
		var ret = results || [];

		if ( arr != null ) {
			if ( isArrayLike( Object( arr ) ) ) {
				jQuery.merge( ret,
					typeof arr === "string" ?
					[ arr ] : arr
				);
			} else {
				push.call( ret, arr );
			}
		}

		return ret;
	},

	inArray: function( elem, arr, i ) {
		return arr == null ? -1 : indexOf.call( arr, elem, i );
	},

	merge: function( first, second ) {
		var len = +second.length,
			j = 0,
			i = first.length;

		for ( ; j < len; j++ ) {
			first[ i++ ] = second[ j ];
		}

		first.length = i;

		return first;
	},

	grep: function( elems, callback, invert ) {
		var callbackInverse,
			matches = [],
			i = 0,
			length = elems.length,
			callbackExpect = !invert;

		// Go through the array, only saving the items
		// that pass the validator function
		for ( ; i < length; i++ ) {
			callbackInverse = !callback( elems[ i ], i );
			if ( callbackInverse !== callbackExpect ) {
				matches.push( elems[ i ] );
			}
		}

		return matches;
	},

	// arg is for internal usage only
	map: function( elems, callback, arg ) {
		var length, value,
			i = 0,
			ret = [];

		// Go through the array, translating each of the items to their new values
		if ( isArrayLike( elems ) ) {
			length = elems.length;
			for ( ; i < length; i++ ) {
				value = callback( elems[ i ], i, arg );

				if ( value != null ) {
					ret.push( value );
				}
			}

		// Go through every key on the object,
		} else {
			for ( i in elems ) {
				value = callback( elems[ i ], i, arg );

				if ( value != null ) {
					ret.push( value );
				}
			}
		}

		// Flatten any nested arrays
		return concat.apply( [], ret );
	},

	// A global GUID counter for objects
	guid: 1,

	// Bind a function to a context, optionally partially applying any
	// arguments.
	proxy: function( fn, context ) {
		var tmp, args, proxy;

		if ( typeof context === "string" ) {
			tmp = fn[ context ];
			context = fn;
			fn = tmp;
		}

		// Quick check to determine if target is callable, in the spec
		// this throws a TypeError, but we will just return undefined.
		if ( !jQuery.isFunction( fn ) ) {
			return undefined;
		}

		// Simulated bind
		args = slice.call( arguments, 2 );
		proxy = function() {
			return fn.apply( context || this, args.concat( slice.call( arguments ) ) );
		};

		// Set the guid of unique handler to the same of original handler, so it can be removed
		proxy.guid = fn.guid = fn.guid || jQuery.guid++;

		return proxy;
	},

	now: Date.now,

	// jQuery.support is not used in Core but other projects attach their
	// properties to it so it needs to exist.
	support: support
} );

// JSHint would error on this code due to the Symbol not being defined in ES5.
// Defining this global in .jshintrc would create a danger of using the global
// unguarded in another place, it seems safer to just disable JSHint for these
// three lines.
/* jshint ignore: start */
if ( typeof Symbol === "function" ) {
	jQuery.fn[ Symbol.iterator ] = arr[ Symbol.iterator ];
}
/* jshint ignore: end */

// Populate the class2type map
jQuery.each( "Boolean Number String Function Array Date RegExp Object Error Symbol".split( " " ),
function( i, name ) {
	class2type[ "[object " + name + "]" ] = name.toLowerCase();
} );

function isArrayLike( obj ) {

	// Support: iOS 8.2 (not reproducible in simulator)
	// `in` check used to prevent JIT error (gh-2145)
	// hasOwn isn't used here due to false negatives
	// regarding Nodelist length in IE
	var length = !!obj && "length" in obj && obj.length,
		type = jQuery.type( obj );

	if ( type === "function" || jQuery.isWindow( obj ) ) {
		return false;
	}

	return type === "array" || length === 0 ||
		typeof length === "number" && length > 0 && ( length - 1 ) in obj;
}
var Sizzle =
/*!
 * Sizzle CSS Selector Engine v2.2.1
 * http://sizzlejs.com/
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license
 * http://jquery.org/license
 *
 * Date: 2015-10-17
 */
(function( window ) {

var i,
	support,
	Expr,
	getText,
	isXML,
	tokenize,
	compile,
	select,
	outermostContext,
	sortInput,
	hasDuplicate,

	// Local document vars
	setDocument,
	document,
	docElem,
	documentIsHTML,
	rbuggyQSA,
	rbuggyMatches,
	matches,
	contains,

	// Instance-specific data
	expando = "sizzle" + 1 * new Date(),
	preferredDoc = window.document,
	dirruns = 0,
	done = 0,
	classCache = createCache(),
	tokenCache = createCache(),
	compilerCache = createCache(),
	sortOrder = function( a, b ) {
		if ( a === b ) {
			hasDuplicate = true;
		}
		return 0;
	},

	// General-purpose constants
	MAX_NEGATIVE = 1 << 31,

	// Instance methods
	hasOwn = ({}).hasOwnProperty,
	arr = [],
	pop = arr.pop,
	push_native = arr.push,
	push = arr.push,
	slice = arr.slice,
	// Use a stripped-down indexOf as it's faster than native
	// http://jsperf.com/thor-indexof-vs-for/5
	indexOf = function( list, elem ) {
		var i = 0,
			len = list.length;
		for ( ; i < len; i++ ) {
			if ( list[i] === elem ) {
				return i;
			}
		}
		return -1;
	},

	booleans = "checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",

	// Regular expressions

	// http://www.w3.org/TR/css3-selectors/#whitespace
	whitespace = "[\\x20\\t\\r\\n\\f]",

	// http://www.w3.org/TR/CSS21/syndata.html#value-def-identifier
	identifier = "(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+",

	// Attribute selectors: http://www.w3.org/TR/selectors/#attribute-selectors
	attributes = "\\[" + whitespace + "*(" + identifier + ")(?:" + whitespace +
		// Operator (capture 2)
		"*([*^$|!~]?=)" + whitespace +
		// "Attribute values must be CSS identifiers [capture 5] or strings [capture 3 or capture 4]"
		"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|(" + identifier + "))|)" + whitespace +
		"*\\]",

	pseudos = ":(" + identifier + ")(?:\\((" +
		// To reduce the number of selectors needing tokenize in the preFilter, prefer arguments:
		// 1. quoted (capture 3; capture 4 or capture 5)
		"('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|" +
		// 2. simple (capture 6)
		"((?:\\\\.|[^\\\\()[\\]]|" + attributes + ")*)|" +
		// 3. anything else (capture 2)
		".*" +
		")\\)|)",

	// Leading and non-escaped trailing whitespace, capturing some non-whitespace characters preceding the latter
	rwhitespace = new RegExp( whitespace + "+", "g" ),
	rtrim = new RegExp( "^" + whitespace + "+|((?:^|[^\\\\])(?:\\\\.)*)" + whitespace + "+$", "g" ),

	rcomma = new RegExp( "^" + whitespace + "*," + whitespace + "*" ),
	rcombinators = new RegExp( "^" + whitespace + "*([>+~]|" + whitespace + ")" + whitespace + "*" ),

	rattributeQuotes = new RegExp( "=" + whitespace + "*([^\\]'\"]*?)" + whitespace + "*\\]", "g" ),

	rpseudo = new RegExp( pseudos ),
	ridentifier = new RegExp( "^" + identifier + "$" ),

	matchExpr = {
		"ID": new RegExp( "^#(" + identifier + ")" ),
		"CLASS": new RegExp( "^\\.(" + identifier + ")" ),
		"TAG": new RegExp( "^(" + identifier + "|[*])" ),
		"ATTR": new RegExp( "^" + attributes ),
		"PSEUDO": new RegExp( "^" + pseudos ),
		"CHILD": new RegExp( "^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\(" + whitespace +
			"*(even|odd|(([+-]|)(\\d*)n|)" + whitespace + "*(?:([+-]|)" + whitespace +
			"*(\\d+)|))" + whitespace + "*\\)|)", "i" ),
		"bool": new RegExp( "^(?:" + booleans + ")$", "i" ),
		// For use in libraries implementing .is()
		// We use this for POS matching in `select`
		"needsContext": new RegExp( "^" + whitespace + "*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\(" +
			whitespace + "*((?:-\\d)?\\d*)" + whitespace + "*\\)|)(?=[^-]|$)", "i" )
	},

	rinputs = /^(?:input|select|textarea|button)$/i,
	rheader = /^h\d$/i,

	rnative = /^[^{]+\{\s*\[native \w/,

	// Easily-parseable/retrievable ID or TAG or CLASS selectors
	rquickExpr = /^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,

	rsibling = /[+~]/,
	rescape = /'|\\/g,

	// CSS escapes http://www.w3.org/TR/CSS21/syndata.html#escaped-characters
	runescape = new RegExp( "\\\\([\\da-f]{1,6}" + whitespace + "?|(" + whitespace + ")|.)", "ig" ),
	funescape = function( _, escaped, escapedWhitespace ) {
		var high = "0x" + escaped - 0x10000;
		// NaN means non-codepoint
		// Support: Firefox<24
		// Workaround erroneous numeric interpretation of +"0x"
		return high !== high || escapedWhitespace ?
			escaped :
			high < 0 ?
				// BMP codepoint
				String.fromCharCode( high + 0x10000 ) :
				// Supplemental Plane codepoint (surrogate pair)
				String.fromCharCode( high >> 10 | 0xD800, high & 0x3FF | 0xDC00 );
	},

	// Used for iframes
	// See setDocument()
	// Removing the function wrapper causes a "Permission Denied"
	// error in IE
	unloadHandler = function() {
		setDocument();
	};

// Optimize for push.apply( _, NodeList )
try {
	push.apply(
		(arr = slice.call( preferredDoc.childNodes )),
		preferredDoc.childNodes
	);
	// Support: Android<4.0
	// Detect silently failing push.apply
	arr[ preferredDoc.childNodes.length ].nodeType;
} catch ( e ) {
	push = { apply: arr.length ?

		// Leverage slice if possible
		function( target, els ) {
			push_native.apply( target, slice.call(els) );
		} :

		// Support: IE<9
		// Otherwise append directly
		function( target, els ) {
			var j = target.length,
				i = 0;
			// Can't trust NodeList.length
			while ( (target[j++] = els[i++]) ) {}
			target.length = j - 1;
		}
	};
}

function Sizzle( selector, context, results, seed ) {
	var m, i, elem, nid, nidselect, match, groups, newSelector,
		newContext = context && context.ownerDocument,

		// nodeType defaults to 9, since context defaults to document
		nodeType = context ? context.nodeType : 9;

	results = results || [];

	// Return early from calls with invalid selector or context
	if ( typeof selector !== "string" || !selector ||
		nodeType !== 1 && nodeType !== 9 && nodeType !== 11 ) {

		return results;
	}

	// Try to shortcut find operations (as opposed to filters) in HTML documents
	if ( !seed ) {

		if ( ( context ? context.ownerDocument || context : preferredDoc ) !== document ) {
			setDocument( context );
		}
		context = context || document;

		if ( documentIsHTML ) {

			// If the selector is sufficiently simple, try using a "get*By*" DOM method
			// (excepting DocumentFragment context, where the methods don't exist)
			if ( nodeType !== 11 && (match = rquickExpr.exec( selector )) ) {

				// ID selector
				if ( (m = match[1]) ) {

					// Document context
					if ( nodeType === 9 ) {
						if ( (elem = context.getElementById( m )) ) {

							// Support: IE, Opera, Webkit
							// TODO: identify versions
							// getElementById can match elements by name instead of ID
							if ( elem.id === m ) {
								results.push( elem );
								return results;
							}
						} else {
							return results;
						}

					// Element context
					} else {

						// Support: IE, Opera, Webkit
						// TODO: identify versions
						// getElementById can match elements by name instead of ID
						if ( newContext && (elem = newContext.getElementById( m )) &&
							contains( context, elem ) &&
							elem.id === m ) {

							results.push( elem );
							return results;
						}
					}

				// Type selector
				} else if ( match[2] ) {
					push.apply( results, context.getElementsByTagName( selector ) );
					return results;

				// Class selector
				} else if ( (m = match[3]) && support.getElementsByClassName &&
					context.getElementsByClassName ) {

					push.apply( results, context.getElementsByClassName( m ) );
					return results;
				}
			}

			// Take advantage of querySelectorAll
			if ( support.qsa &&
				!compilerCache[ selector + " " ] &&
				(!rbuggyQSA || !rbuggyQSA.test( selector )) ) {

				if ( nodeType !== 1 ) {
					newContext = context;
					newSelector = selector;

				// qSA looks outside Element context, which is not what we want
				// Thanks to Andrew Dupont for this workaround technique
				// Support: IE <=8
				// Exclude object elements
				} else if ( context.nodeName.toLowerCase() !== "object" ) {

					// Capture the context ID, setting it first if necessary
					if ( (nid = context.getAttribute( "id" )) ) {
						nid = nid.replace( rescape, "\\$&" );
					} else {
						context.setAttribute( "id", (nid = expando) );
					}

					// Prefix every selector in the list
					groups = tokenize( selector );
					i = groups.length;
					nidselect = ridentifier.test( nid ) ? "#" + nid : "[id='" + nid + "']";
					while ( i-- ) {
						groups[i] = nidselect + " " + toSelector( groups[i] );
					}
					newSelector = groups.join( "," );

					// Expand context for sibling selectors
					newContext = rsibling.test( selector ) && testContext( context.parentNode ) ||
						context;
				}

				if ( newSelector ) {
					try {
						push.apply( results,
							newContext.querySelectorAll( newSelector )
						);
						return results;
					} catch ( qsaError ) {
					} finally {
						if ( nid === expando ) {
							context.removeAttribute( "id" );
						}
					}
				}
			}
		}
	}

	// All others
	return select( selector.replace( rtrim, "$1" ), context, results, seed );
}

/**
 * Create key-value caches of limited size
 * @returns {function(string, object)} Returns the Object data after storing it on itself with
 *	property name the (space-suffixed) string and (if the cache is larger than Expr.cacheLength)
 *	deleting the oldest entry
 */
function createCache() {
	var keys = [];

	function cache( key, value ) {
		// Use (key + " ") to avoid collision with native prototype properties (see Issue #157)
		if ( keys.push( key + " " ) > Expr.cacheLength ) {
			// Only keep the most recent entries
			delete cache[ keys.shift() ];
		}
		return (cache[ key + " " ] = value);
	}
	return cache;
}

/**
 * Mark a function for special use by Sizzle
 * @param {Function} fn The function to mark
 */
function markFunction( fn ) {
	fn[ expando ] = true;
	return fn;
}

/**
 * Support testing using an element
 * @param {Function} fn Passed the created div and expects a boolean result
 */
function assert( fn ) {
	var div = document.createElement("div");

	try {
		return !!fn( div );
	} catch (e) {
		return false;
	} finally {
		// Remove from its parent by default
		if ( div.parentNode ) {
			div.parentNode.removeChild( div );
		}
		// release memory in IE
		div = null;
	}
}

/**
 * Adds the same handler for all of the specified attrs
 * @param {String} attrs Pipe-separated list of attributes
 * @param {Function} handler The method that will be applied
 */
function addHandle( attrs, handler ) {
	var arr = attrs.split("|"),
		i = arr.length;

	while ( i-- ) {
		Expr.attrHandle[ arr[i] ] = handler;
	}
}

/**
 * Checks document order of two siblings
 * @param {Element} a
 * @param {Element} b
 * @returns {Number} Returns less than 0 if a precedes b, greater than 0 if a follows b
 */
function siblingCheck( a, b ) {
	var cur = b && a,
		diff = cur && a.nodeType === 1 && b.nodeType === 1 &&
			( ~b.sourceIndex || MAX_NEGATIVE ) -
			( ~a.sourceIndex || MAX_NEGATIVE );

	// Use IE sourceIndex if available on both nodes
	if ( diff ) {
		return diff;
	}

	// Check if b follows a
	if ( cur ) {
		while ( (cur = cur.nextSibling) ) {
			if ( cur === b ) {
				return -1;
			}
		}
	}

	return a ? 1 : -1;
}

/**
 * Returns a function to use in pseudos for input types
 * @param {String} type
 */
function createInputPseudo( type ) {
	return function( elem ) {
		var name = elem.nodeName.toLowerCase();
		return name === "input" && elem.type === type;
	};
}

/**
 * Returns a function to use in pseudos for buttons
 * @param {String} type
 */
function createButtonPseudo( type ) {
	return function( elem ) {
		var name = elem.nodeName.toLowerCase();
		return (name === "input" || name === "button") && elem.type === type;
	};
}

/**
 * Returns a function to use in pseudos for positionals
 * @param {Function} fn
 */
function createPositionalPseudo( fn ) {
	return markFunction(function( argument ) {
		argument = +argument;
		return markFunction(function( seed, matches ) {
			var j,
				matchIndexes = fn( [], seed.length, argument ),
				i = matchIndexes.length;

			// Match elements found at the specified indexes
			while ( i-- ) {
				if ( seed[ (j = matchIndexes[i]) ] ) {
					seed[j] = !(matches[j] = seed[j]);
				}
			}
		});
	});
}

/**
 * Checks a node for validity as a Sizzle context
 * @param {Element|Object=} context
 * @returns {Element|Object|Boolean} The input node if acceptable, otherwise a falsy value
 */
function testContext( context ) {
	return context && typeof context.getElementsByTagName !== "undefined" && context;
}

// Expose support vars for convenience
support = Sizzle.support = {};

/**
 * Detects XML nodes
 * @param {Element|Object} elem An element or a document
 * @returns {Boolean} True iff elem is a non-HTML XML node
 */
isXML = Sizzle.isXML = function( elem ) {
	// documentElement is verified for cases where it doesn't yet exist
	// (such as loading iframes in IE - #4833)
	var documentElement = elem && (elem.ownerDocument || elem).documentElement;
	return documentElement ? documentElement.nodeName !== "HTML" : false;
};

/**
 * Sets document-related variables once based on the current document
 * @param {Element|Object} [doc] An element or document object to use to set the document
 * @returns {Object} Returns the current document
 */
setDocument = Sizzle.setDocument = function( node ) {
	var hasCompare, parent,
		doc = node ? node.ownerDocument || node : preferredDoc;

	// Return early if doc is invalid or already selected
	if ( doc === document || doc.nodeType !== 9 || !doc.documentElement ) {
		return document;
	}

	// Update global variables
	document = doc;
	docElem = document.documentElement;
	documentIsHTML = !isXML( document );

	// Support: IE 9-11, Edge
	// Accessing iframe documents after unload throws "permission denied" errors (jQuery #13936)
	if ( (parent = document.defaultView) && parent.top !== parent ) {
		// Support: IE 11
		if ( parent.addEventListener ) {
			parent.addEventListener( "unload", unloadHandler, false );

		// Support: IE 9 - 10 only
		} else if ( parent.attachEvent ) {
			parent.attachEvent( "onunload", unloadHandler );
		}
	}

	/* Attributes
	---------------------------------------------------------------------- */

	// Support: IE<8
	// Verify that getAttribute really returns attributes and not properties
	// (excepting IE8 booleans)
	support.attributes = assert(function( div ) {
		div.className = "i";
		return !div.getAttribute("className");
	});

	/* getElement(s)By*
	---------------------------------------------------------------------- */

	// Check if getElementsByTagName("*") returns only elements
	support.getElementsByTagName = assert(function( div ) {
		div.appendChild( document.createComment("") );
		return !div.getElementsByTagName("*").length;
	});

	// Support: IE<9
	support.getElementsByClassName = rnative.test( document.getElementsByClassName );

	// Support: IE<10
	// Check if getElementById returns elements by name
	// The broken getElementById methods don't pick up programatically-set names,
	// so use a roundabout getElementsByName test
	support.getById = assert(function( div ) {
		docElem.appendChild( div ).id = expando;
		return !document.getElementsByName || !document.getElementsByName( expando ).length;
	});

	// ID find and filter
	if ( support.getById ) {
		Expr.find["ID"] = function( id, context ) {
			if ( typeof context.getElementById !== "undefined" && documentIsHTML ) {
				var m = context.getElementById( id );
				return m ? [ m ] : [];
			}
		};
		Expr.filter["ID"] = function( id ) {
			var attrId = id.replace( runescape, funescape );
			return function( elem ) {
				return elem.getAttribute("id") === attrId;
			};
		};
	} else {
		// Support: IE6/7
		// getElementById is not reliable as a find shortcut
		delete Expr.find["ID"];

		Expr.filter["ID"] =  function( id ) {
			var attrId = id.replace( runescape, funescape );
			return function( elem ) {
				var node = typeof elem.getAttributeNode !== "undefined" &&
					elem.getAttributeNode("id");
				return node && node.value === attrId;
			};
		};
	}

	// Tag
	Expr.find["TAG"] = support.getElementsByTagName ?
		function( tag, context ) {
			if ( typeof context.getElementsByTagName !== "undefined" ) {
				return context.getElementsByTagName( tag );

			// DocumentFragment nodes don't have gEBTN
			} else if ( support.qsa ) {
				return context.querySelectorAll( tag );
			}
		} :

		function( tag, context ) {
			var elem,
				tmp = [],
				i = 0,
				// By happy coincidence, a (broken) gEBTN appears on DocumentFragment nodes too
				results = context.getElementsByTagName( tag );

			// Filter out possible comments
			if ( tag === "*" ) {
				while ( (elem = results[i++]) ) {
					if ( elem.nodeType === 1 ) {
						tmp.push( elem );
					}
				}

				return tmp;
			}
			return results;
		};

	// Class
	Expr.find["CLASS"] = support.getElementsByClassName && function( className, context ) {
		if ( typeof context.getElementsByClassName !== "undefined" && documentIsHTML ) {
			return context.getElementsByClassName( className );
		}
	};

	/* QSA/matchesSelector
	---------------------------------------------------------------------- */

	// QSA and matchesSelector support

	// matchesSelector(:active) reports false when true (IE9/Opera 11.5)
	rbuggyMatches = [];

	// qSa(:focus) reports false when true (Chrome 21)
	// We allow this because of a bug in IE8/9 that throws an error
	// whenever `document.activeElement` is accessed on an iframe
	// So, we allow :focus to pass through QSA all the time to avoid the IE error
	// See http://bugs.jquery.com/ticket/13378
	rbuggyQSA = [];

	if ( (support.qsa = rnative.test( document.querySelectorAll )) ) {
		// Build QSA regex
		// Regex strategy adopted from Diego Perini
		assert(function( div ) {
			// Select is set to empty string on purpose
			// This is to test IE's treatment of not explicitly
			// setting a boolean content attribute,
			// since its presence should be enough
			// http://bugs.jquery.com/ticket/12359
			docElem.appendChild( div ).innerHTML = "<a id='" + expando + "'></a>" +
				"<select id='" + expando + "-\r\\' msallowcapture=''>" +
				"<option selected=''></option></select>";

			// Support: IE8, Opera 11-12.16
			// Nothing should be selected when empty strings follow ^= or $= or *=
			// The test attribute must be unknown in Opera but "safe" for WinRT
			// http://msdn.microsoft.com/en-us/library/ie/hh465388.aspx#attribute_section
			if ( div.querySelectorAll("[msallowcapture^='']").length ) {
				rbuggyQSA.push( "[*^$]=" + whitespace + "*(?:''|\"\")" );
			}

			// Support: IE8
			// Boolean attributes and "value" are not treated correctly
			if ( !div.querySelectorAll("[selected]").length ) {
				rbuggyQSA.push( "\\[" + whitespace + "*(?:value|" + booleans + ")" );
			}

			// Support: Chrome<29, Android<4.4, Safari<7.0+, iOS<7.0+, PhantomJS<1.9.8+
			if ( !div.querySelectorAll( "[id~=" + expando + "-]" ).length ) {
				rbuggyQSA.push("~=");
			}

			// Webkit/Opera - :checked should return selected option elements
			// http://www.w3.org/TR/2011/REC-css3-selectors-20110929/#checked
			// IE8 throws error here and will not see later tests
			if ( !div.querySelectorAll(":checked").length ) {
				rbuggyQSA.push(":checked");
			}

			// Support: Safari 8+, iOS 8+
			// https://bugs.webkit.org/show_bug.cgi?id=136851
			// In-page `selector#id sibing-combinator selector` fails
			if ( !div.querySelectorAll( "a#" + expando + "+*" ).length ) {
				rbuggyQSA.push(".#.+[+~]");
			}
		});

		assert(function( div ) {
			// Support: Windows 8 Native Apps
			// The type and name attributes are restricted during .innerHTML assignment
			var input = document.createElement("input");
			input.setAttribute( "type", "hidden" );
			div.appendChild( input ).setAttribute( "name", "D" );

			// Support: IE8
			// Enforce case-sensitivity of name attribute
			if ( div.querySelectorAll("[name=d]").length ) {
				rbuggyQSA.push( "name" + whitespace + "*[*^$|!~]?=" );
			}

			// FF 3.5 - :enabled/:disabled and hidden elements (hidden elements are still enabled)
			// IE8 throws error here and will not see later tests
			if ( !div.querySelectorAll(":enabled").length ) {
				rbuggyQSA.push( ":enabled", ":disabled" );
			}

			// Opera 10-11 does not throw on post-comma invalid pseudos
			div.querySelectorAll("*,:x");
			rbuggyQSA.push(",.*:");
		});
	}

	if ( (support.matchesSelector = rnative.test( (matches = docElem.matches ||
		docElem.webkitMatchesSelector ||
		docElem.mozMatchesSelector ||
		docElem.oMatchesSelector ||
		docElem.msMatchesSelector) )) ) {

		assert(function( div ) {
			// Check to see if it's possible to do matchesSelector
			// on a disconnected node (IE 9)
			support.disconnectedMatch = matches.call( div, "div" );

			// This should fail with an exception
			// Gecko does not error, returns false instead
			matches.call( div, "[s!='']:x" );
			rbuggyMatches.push( "!=", pseudos );
		});
	}

	rbuggyQSA = rbuggyQSA.length && new RegExp( rbuggyQSA.join("|") );
	rbuggyMatches = rbuggyMatches.length && new RegExp( rbuggyMatches.join("|") );

	/* Contains
	---------------------------------------------------------------------- */
	hasCompare = rnative.test( docElem.compareDocumentPosition );

	// Element contains another
	// Purposefully self-exclusive
	// As in, an element does not contain itself
	contains = hasCompare || rnative.test( docElem.contains ) ?
		function( a, b ) {
			var adown = a.nodeType === 9 ? a.documentElement : a,
				bup = b && b.parentNode;
			return a === bup || !!( bup && bup.nodeType === 1 && (
				adown.contains ?
					adown.contains( bup ) :
					a.compareDocumentPosition && a.compareDocumentPosition( bup ) & 16
			));
		} :
		function( a, b ) {
			if ( b ) {
				while ( (b = b.parentNode) ) {
					if ( b === a ) {
						return true;
					}
				}
			}
			return false;
		};

	/* Sorting
	---------------------------------------------------------------------- */

	// Document order sorting
	sortOrder = hasCompare ?
	function( a, b ) {

		// Flag for duplicate removal
		if ( a === b ) {
			hasDuplicate = true;
			return 0;
		}

		// Sort on method existence if only one input has compareDocumentPosition
		var compare = !a.compareDocumentPosition - !b.compareDocumentPosition;
		if ( compare ) {
			return compare;
		}

		// Calculate position if both inputs belong to the same document
		compare = ( a.ownerDocument || a ) === ( b.ownerDocument || b ) ?
			a.compareDocumentPosition( b ) :

			// Otherwise we know they are disconnected
			1;

		// Disconnected nodes
		if ( compare & 1 ||
			(!support.sortDetached && b.compareDocumentPosition( a ) === compare) ) {

			// Choose the first element that is related to our preferred document
			if ( a === document || a.ownerDocument === preferredDoc && contains(preferredDoc, a) ) {
				return -1;
			}
			if ( b === document || b.ownerDocument === preferredDoc && contains(preferredDoc, b) ) {
				return 1;
			}

			// Maintain original order
			return sortInput ?
				( indexOf( sortInput, a ) - indexOf( sortInput, b ) ) :
				0;
		}

		return compare & 4 ? -1 : 1;
	} :
	function( a, b ) {
		// Exit early if the nodes are identical
		if ( a === b ) {
			hasDuplicate = true;
			return 0;
		}

		var cur,
			i = 0,
			aup = a.parentNode,
			bup = b.parentNode,
			ap = [ a ],
			bp = [ b ];

		// Parentless nodes are either documents or disconnected
		if ( !aup || !bup ) {
			return a === document ? -1 :
				b === document ? 1 :
				aup ? -1 :
				bup ? 1 :
				sortInput ?
				( indexOf( sortInput, a ) - indexOf( sortInput, b ) ) :
				0;

		// If the nodes are siblings, we can do a quick check
		} else if ( aup === bup ) {
			return siblingCheck( a, b );
		}

		// Otherwise we need full lists of their ancestors for comparison
		cur = a;
		while ( (cur = cur.parentNode) ) {
			ap.unshift( cur );
		}
		cur = b;
		while ( (cur = cur.parentNode) ) {
			bp.unshift( cur );
		}

		// Walk down the tree looking for a discrepancy
		while ( ap[i] === bp[i] ) {
			i++;
		}

		return i ?
			// Do a sibling check if the nodes have a common ancestor
			siblingCheck( ap[i], bp[i] ) :

			// Otherwise nodes in our document sort first
			ap[i] === preferredDoc ? -1 :
			bp[i] === preferredDoc ? 1 :
			0;
	};

	return document;
};

Sizzle.matches = function( expr, elements ) {
	return Sizzle( expr, null, null, elements );
};

Sizzle.matchesSelector = function( elem, expr ) {
	// Set document vars if needed
	if ( ( elem.ownerDocument || elem ) !== document ) {
		setDocument( elem );
	}

	// Make sure that attribute selectors are quoted
	expr = expr.replace( rattributeQuotes, "='$1']" );

	if ( support.matchesSelector && documentIsHTML &&
		!compilerCache[ expr + " " ] &&
		( !rbuggyMatches || !rbuggyMatches.test( expr ) ) &&
		( !rbuggyQSA     || !rbuggyQSA.test( expr ) ) ) {

		try {
			var ret = matches.call( elem, expr );

			// IE 9's matchesSelector returns false on disconnected nodes
			if ( ret || support.disconnectedMatch ||
					// As well, disconnected nodes are said to be in a document
					// fragment in IE 9
					elem.document && elem.document.nodeType !== 11 ) {
				return ret;
			}
		} catch (e) {}
	}

	return Sizzle( expr, document, null, [ elem ] ).length > 0;
};

Sizzle.contains = function( context, elem ) {
	// Set document vars if needed
	if ( ( context.ownerDocument || context ) !== document ) {
		setDocument( context );
	}
	return contains( context, elem );
};

Sizzle.attr = function( elem, name ) {
	// Set document vars if needed
	if ( ( elem.ownerDocument || elem ) !== document ) {
		setDocument( elem );
	}

	var fn = Expr.attrHandle[ name.toLowerCase() ],
		// Don't get fooled by Object.prototype properties (jQuery #13807)
		val = fn && hasOwn.call( Expr.attrHandle, name.toLowerCase() ) ?
			fn( elem, name, !documentIsHTML ) :
			undefined;

	return val !== undefined ?
		val :
		support.attributes || !documentIsHTML ?
			elem.getAttribute( name ) :
			(val = elem.getAttributeNode(name)) && val.specified ?
				val.value :
				null;
};

Sizzle.error = function( msg ) {
	throw new Error( "Syntax error, unrecognized expression: " + msg );
};

/**
 * Document sorting and removing duplicates
 * @param {ArrayLike} results
 */
Sizzle.uniqueSort = function( results ) {
	var elem,
		duplicates = [],
		j = 0,
		i = 0;

	// Unless we *know* we can detect duplicates, assume their presence
	hasDuplicate = !support.detectDuplicates;
	sortInput = !support.sortStable && results.slice( 0 );
	results.sort( sortOrder );

	if ( hasDuplicate ) {
		while ( (elem = results[i++]) ) {
			if ( elem === results[ i ] ) {
				j = duplicates.push( i );
			}
		}
		while ( j-- ) {
			results.splice( duplicates[ j ], 1 );
		}
	}

	// Clear input after sorting to release objects
	// See https://github.com/jquery/sizzle/pull/225
	sortInput = null;

	return results;
};

/**
 * Utility function for retrieving the text value of an array of DOM nodes
 * @param {Array|Element} elem
 */
getText = Sizzle.getText = function( elem ) {
	var node,
		ret = "",
		i = 0,
		nodeType = elem.nodeType;

	if ( !nodeType ) {
		// If no nodeType, this is expected to be an array
		while ( (node = elem[i++]) ) {
			// Do not traverse comment nodes
			ret += getText( node );
		}
	} else if ( nodeType === 1 || nodeType === 9 || nodeType === 11 ) {
		// Use textContent for elements
		// innerText usage removed for consistency of new lines (jQuery #11153)
		if ( typeof elem.textContent === "string" ) {
			return elem.textContent;
		} else {
			// Traverse its children
			for ( elem = elem.firstChild; elem; elem = elem.nextSibling ) {
				ret += getText( elem );
			}
		}
	} else if ( nodeType === 3 || nodeType === 4 ) {
		return elem.nodeValue;
	}
	// Do not include comment or processing instruction nodes

	return ret;
};

Expr = Sizzle.selectors = {

	// Can be adjusted by the user
	cacheLength: 50,

	createPseudo: markFunction,

	match: matchExpr,

	attrHandle: {},

	find: {},

	relative: {
		">": { dir: "parentNode", first: true },
		" ": { dir: "parentNode" },
		"+": { dir: "previousSibling", first: true },
		"~": { dir: "previousSibling" }
	},

	preFilter: {
		"ATTR": function( match ) {
			match[1] = match[1].replace( runescape, funescape );

			// Move the given value to match[3] whether quoted or unquoted
			match[3] = ( match[3] || match[4] || match[5] || "" ).replace( runescape, funescape );

			if ( match[2] === "~=" ) {
				match[3] = " " + match[3] + " ";
			}

			return match.slice( 0, 4 );
		},

		"CHILD": function( match ) {
			/* matches from matchExpr["CHILD"]
				1 type (only|nth|...)
				2 what (child|of-type)
				3 argument (even|odd|\d*|\d*n([+-]\d+)?|...)
				4 xn-component of xn+y argument ([+-]?\d*n|)
				5 sign of xn-component
				6 x of xn-component
				7 sign of y-component
				8 y of y-component
			*/
			match[1] = match[1].toLowerCase();

			if ( match[1].slice( 0, 3 ) === "nth" ) {
				// nth-* requires argument
				if ( !match[3] ) {
					Sizzle.error( match[0] );
				}

				// numeric x and y parameters for Expr.filter.CHILD
				// remember that false/true cast respectively to 0/1
				match[4] = +( match[4] ? match[5] + (match[6] || 1) : 2 * ( match[3] === "even" || match[3] === "odd" ) );
				match[5] = +( ( match[7] + match[8] ) || match[3] === "odd" );

			// other types prohibit arguments
			} else if ( match[3] ) {
				Sizzle.error( match[0] );
			}

			return match;
		},

		"PSEUDO": function( match ) {
			var excess,
				unquoted = !match[6] && match[2];

			if ( matchExpr["CHILD"].test( match[0] ) ) {
				return null;
			}

			// Accept quoted arguments as-is
			if ( match[3] ) {
				match[2] = match[4] || match[5] || "";

			// Strip excess characters from unquoted arguments
			} else if ( unquoted && rpseudo.test( unquoted ) &&
				// Get excess from tokenize (recursively)
				(excess = tokenize( unquoted, true )) &&
				// advance to the next closing parenthesis
				(excess = unquoted.indexOf( ")", unquoted.length - excess ) - unquoted.length) ) {

				// excess is a negative index
				match[0] = match[0].slice( 0, excess );
				match[2] = unquoted.slice( 0, excess );
			}

			// Return only captures needed by the pseudo filter method (type and argument)
			return match.slice( 0, 3 );
		}
	},

	filter: {

		"TAG": function( nodeNameSelector ) {
			var nodeName = nodeNameSelector.replace( runescape, funescape ).toLowerCase();
			return nodeNameSelector === "*" ?
				function() { return true; } :
				function( elem ) {
					return elem.nodeName && elem.nodeName.toLowerCase() === nodeName;
				};
		},

		"CLASS": function( className ) {
			var pattern = classCache[ className + " " ];

			return pattern ||
				(pattern = new RegExp( "(^|" + whitespace + ")" + className + "(" + whitespace + "|$)" )) &&
				classCache( className, function( elem ) {
					return pattern.test( typeof elem.className === "string" && elem.className || typeof elem.getAttribute !== "undefined" && elem.getAttribute("class") || "" );
				});
		},

		"ATTR": function( name, operator, check ) {
			return function( elem ) {
				var result = Sizzle.attr( elem, name );

				if ( result == null ) {
					return operator === "!=";
				}
				if ( !operator ) {
					return true;
				}

				result += "";

				return operator === "=" ? result === check :
					operator === "!=" ? result !== check :
					operator === "^=" ? check && result.indexOf( check ) === 0 :
					operator === "*=" ? check && result.indexOf( check ) > -1 :
					operator === "$=" ? check && result.slice( -check.length ) === check :
					operator === "~=" ? ( " " + result.replace( rwhitespace, " " ) + " " ).indexOf( check ) > -1 :
					operator === "|=" ? result === check || result.slice( 0, check.length + 1 ) === check + "-" :
					false;
			};
		},

		"CHILD": function( type, what, argument, first, last ) {
			var simple = type.slice( 0, 3 ) !== "nth",
				forward = type.slice( -4 ) !== "last",
				ofType = what === "of-type";

			return first === 1 && last === 0 ?

				// Shortcut for :nth-*(n)
				function( elem ) {
					return !!elem.parentNode;
				} :

				function( elem, context, xml ) {
					var cache, uniqueCache, outerCache, node, nodeIndex, start,
						dir = simple !== forward ? "nextSibling" : "previousSibling",
						parent = elem.parentNode,
						name = ofType && elem.nodeName.toLowerCase(),
						useCache = !xml && !ofType,
						diff = false;

					if ( parent ) {

						// :(first|last|only)-(child|of-type)
						if ( simple ) {
							while ( dir ) {
								node = elem;
								while ( (node = node[ dir ]) ) {
									if ( ofType ?
										node.nodeName.toLowerCase() === name :
										node.nodeType === 1 ) {

										return false;
									}
								}
								// Reverse direction for :only-* (if we haven't yet done so)
								start = dir = type === "only" && !start && "nextSibling";
							}
							return true;
						}

						start = [ forward ? parent.firstChild : parent.lastChild ];

						// non-xml :nth-child(...) stores cache data on `parent`
						if ( forward && useCache ) {

							// Seek `elem` from a previously-cached index

							// ...in a gzip-friendly way
							node = parent;
							outerCache = node[ expando ] || (node[ expando ] = {});

							// Support: IE <9 only
							// Defend against cloned attroperties (jQuery gh-1709)
							uniqueCache = outerCache[ node.uniqueID ] ||
								(outerCache[ node.uniqueID ] = {});

							cache = uniqueCache[ type ] || [];
							nodeIndex = cache[ 0 ] === dirruns && cache[ 1 ];
							diff = nodeIndex && cache[ 2 ];
							node = nodeIndex && parent.childNodes[ nodeIndex ];

							while ( (node = ++nodeIndex && node && node[ dir ] ||

								// Fallback to seeking `elem` from the start
								(diff = nodeIndex = 0) || start.pop()) ) {

								// When found, cache indexes on `parent` and break
								if ( node.nodeType === 1 && ++diff && node === elem ) {
									uniqueCache[ type ] = [ dirruns, nodeIndex, diff ];
									break;
								}
							}

						} else {
							// Use previously-cached element index if available
							if ( useCache ) {
								// ...in a gzip-friendly way
								node = elem;
								outerCache = node[ expando ] || (node[ expando ] = {});

								// Support: IE <9 only
								// Defend against cloned attroperties (jQuery gh-1709)
								uniqueCache = outerCache[ node.uniqueID ] ||
									(outerCache[ node.uniqueID ] = {});

								cache = uniqueCache[ type ] || [];
								nodeIndex = cache[ 0 ] === dirruns && cache[ 1 ];
								diff = nodeIndex;
							}

							// xml :nth-child(...)
							// or :nth-last-child(...) or :nth(-last)?-of-type(...)
							if ( diff === false ) {
								// Use the same loop as above to seek `elem` from the start
								while ( (node = ++nodeIndex && node && node[ dir ] ||
									(diff = nodeIndex = 0) || start.pop()) ) {

									if ( ( ofType ?
										node.nodeName.toLowerCase() === name :
										node.nodeType === 1 ) &&
										++diff ) {

										// Cache the index of each encountered element
										if ( useCache ) {
											outerCache = node[ expando ] || (node[ expando ] = {});

											// Support: IE <9 only
											// Defend against cloned attroperties (jQuery gh-1709)
											uniqueCache = outerCache[ node.uniqueID ] ||
												(outerCache[ node.uniqueID ] = {});

											uniqueCache[ type ] = [ dirruns, diff ];
										}

										if ( node === elem ) {
											break;
										}
									}
								}
							}
						}

						// Incorporate the offset, then check against cycle size
						diff -= last;
						return diff === first || ( diff % first === 0 && diff / first >= 0 );
					}
				};
		},

		"PSEUDO": function( pseudo, argument ) {
			// pseudo-class names are case-insensitive
			// http://www.w3.org/TR/selectors/#pseudo-classes
			// Prioritize by case sensitivity in case custom pseudos are added with uppercase letters
			// Remember that setFilters inherits from pseudos
			var args,
				fn = Expr.pseudos[ pseudo ] || Expr.setFilters[ pseudo.toLowerCase() ] ||
					Sizzle.error( "unsupported pseudo: " + pseudo );

			// The user may use createPseudo to indicate that
			// arguments are needed to create the filter function
			// just as Sizzle does
			if ( fn[ expando ] ) {
				return fn( argument );
			}

			// But maintain support for old signatures
			if ( fn.length > 1 ) {
				args = [ pseudo, pseudo, "", argument ];
				return Expr.setFilters.hasOwnProperty( pseudo.toLowerCase() ) ?
					markFunction(function( seed, matches ) {
						var idx,
							matched = fn( seed, argument ),
							i = matched.length;
						while ( i-- ) {
							idx = indexOf( seed, matched[i] );
							seed[ idx ] = !( matches[ idx ] = matched[i] );
						}
					}) :
					function( elem ) {
						return fn( elem, 0, args );
					};
			}

			return fn;
		}
	},

	pseudos: {
		// Potentially complex pseudos
		"not": markFunction(function( selector ) {
			// Trim the selector passed to compile
			// to avoid treating leading and trailing
			// spaces as combinators
			var input = [],
				results = [],
				matcher = compile( selector.replace( rtrim, "$1" ) );

			return matcher[ expando ] ?
				markFunction(function( seed, matches, context, xml ) {
					var elem,
						unmatched = matcher( seed, null, xml, [] ),
						i = seed.length;

					// Match elements unmatched by `matcher`
					while ( i-- ) {
						if ( (elem = unmatched[i]) ) {
							seed[i] = !(matches[i] = elem);
						}
					}
				}) :
				function( elem, context, xml ) {
					input[0] = elem;
					matcher( input, null, xml, results );
					// Don't keep the element (issue #299)
					input[0] = null;
					return !results.pop();
				};
		}),

		"has": markFunction(function( selector ) {
			return function( elem ) {
				return Sizzle( selector, elem ).length > 0;
			};
		}),

		"contains": markFunction(function( text ) {
			text = text.replace( runescape, funescape );
			return function( elem ) {
				return ( elem.textContent || elem.innerText || getText( elem ) ).indexOf( text ) > -1;
			};
		}),

		// "Whether an element is represented by a :lang() selector
		// is based solely on the element's language value
		// being equal to the identifier C,
		// or beginning with the identifier C immediately followed by "-".
		// The matching of C against the element's language value is performed case-insensitively.
		// The identifier C does not have to be a valid language name."
		// http://www.w3.org/TR/selectors/#lang-pseudo
		"lang": markFunction( function( lang ) {
			// lang value must be a valid identifier
			if ( !ridentifier.test(lang || "") ) {
				Sizzle.error( "unsupported lang: " + lang );
			}
			lang = lang.replace( runescape, funescape ).toLowerCase();
			return function( elem ) {
				var elemLang;
				do {
					if ( (elemLang = documentIsHTML ?
						elem.lang :
						elem.getAttribute("xml:lang") || elem.getAttribute("lang")) ) {

						elemLang = elemLang.toLowerCase();
						return elemLang === lang || elemLang.indexOf( lang + "-" ) === 0;
					}
				} while ( (elem = elem.parentNode) && elem.nodeType === 1 );
				return false;
			};
		}),

		// Miscellaneous
		"target": function( elem ) {
			var hash = window.location && window.location.hash;
			return hash && hash.slice( 1 ) === elem.id;
		},

		"root": function( elem ) {
			return elem === docElem;
		},

		"focus": function( elem ) {
			return elem === document.activeElement && (!document.hasFocus || document.hasFocus()) && !!(elem.type || elem.href || ~elem.tabIndex);
		},

		// Boolean properties
		"enabled": function( elem ) {
			return elem.disabled === false;
		},

		"disabled": function( elem ) {
			return elem.disabled === true;
		},

		"checked": function( elem ) {
			// In CSS3, :checked should return both checked and selected elements
			// http://www.w3.org/TR/2011/REC-css3-selectors-20110929/#checked
			var nodeName = elem.nodeName.toLowerCase();
			return (nodeName === "input" && !!elem.checked) || (nodeName === "option" && !!elem.selected);
		},

		"selected": function( elem ) {
			// Accessing this property makes selected-by-default
			// options in Safari work properly
			if ( elem.parentNode ) {
				elem.parentNode.selectedIndex;
			}

			return elem.selected === true;
		},

		// Contents
		"empty": function( elem ) {
			// http://www.w3.org/TR/selectors/#empty-pseudo
			// :empty is negated by element (1) or content nodes (text: 3; cdata: 4; entity ref: 5),
			//   but not by others (comment: 8; processing instruction: 7; etc.)
			// nodeType < 6 works because attributes (2) do not appear as children
			for ( elem = elem.firstChild; elem; elem = elem.nextSibling ) {
				if ( elem.nodeType < 6 ) {
					return false;
				}
			}
			return true;
		},

		"parent": function( elem ) {
			return !Expr.pseudos["empty"]( elem );
		},

		// Element/input types
		"header": function( elem ) {
			return rheader.test( elem.nodeName );
		},

		"input": function( elem ) {
			return rinputs.test( elem.nodeName );
		},

		"button": function( elem ) {
			var name = elem.nodeName.toLowerCase();
			return name === "input" && elem.type === "button" || name === "button";
		},

		"text": function( elem ) {
			var attr;
			return elem.nodeName.toLowerCase() === "input" &&
				elem.type === "text" &&

				// Support: IE<8
				// New HTML5 attribute values (e.g., "search") appear with elem.type === "text"
				( (attr = elem.getAttribute("type")) == null || attr.toLowerCase() === "text" );
		},

		// Position-in-collection
		"first": createPositionalPseudo(function() {
			return [ 0 ];
		}),

		"last": createPositionalPseudo(function( matchIndexes, length ) {
			return [ length - 1 ];
		}),

		"eq": createPositionalPseudo(function( matchIndexes, length, argument ) {
			return [ argument < 0 ? argument + length : argument ];
		}),

		"even": createPositionalPseudo(function( matchIndexes, length ) {
			var i = 0;
			for ( ; i < length; i += 2 ) {
				matchIndexes.push( i );
			}
			return matchIndexes;
		}),

		"odd": createPositionalPseudo(function( matchIndexes, length ) {
			var i = 1;
			for ( ; i < length; i += 2 ) {
				matchIndexes.push( i );
			}
			return matchIndexes;
		}),

		"lt": createPositionalPseudo(function( matchIndexes, length, argument ) {
			var i = argument < 0 ? argument + length : argument;
			for ( ; --i >= 0; ) {
				matchIndexes.push( i );
			}
			return matchIndexes;
		}),

		"gt": createPositionalPseudo(function( matchIndexes, length, argument ) {
			var i = argument < 0 ? argument + length : argument;
			for ( ; ++i < length; ) {
				matchIndexes.push( i );
			}
			return matchIndexes;
		})
	}
};

Expr.pseudos["nth"] = Expr.pseudos["eq"];

// Add button/input type pseudos
for ( i in { radio: true, checkbox: true, file: true, password: true, image: true } ) {
	Expr.pseudos[ i ] = createInputPseudo( i );
}
for ( i in { submit: true, reset: true } ) {
	Expr.pseudos[ i ] = createButtonPseudo( i );
}

// Easy API for creating new setFilters
function setFilters() {}
setFilters.prototype = Expr.filters = Expr.pseudos;
Expr.setFilters = new setFilters();

tokenize = Sizzle.tokenize = function( selector, parseOnly ) {
	var matched, match, tokens, type,
		soFar, groups, preFilters,
		cached = tokenCache[ selector + " " ];

	if ( cached ) {
		return parseOnly ? 0 : cached.slice( 0 );
	}

	soFar = selector;
	groups = [];
	preFilters = Expr.preFilter;

	while ( soFar ) {

		// Comma and first run
		if ( !matched || (match = rcomma.exec( soFar )) ) {
			if ( match ) {
				// Don't consume trailing commas as valid
				soFar = soFar.slice( match[0].length ) || soFar;
			}
			groups.push( (tokens = []) );
		}

		matched = false;

		// Combinators
		if ( (match = rcombinators.exec( soFar )) ) {
			matched = match.shift();
			tokens.push({
				value: matched,
				// Cast descendant combinators to space
				type: match[0].replace( rtrim, " " )
			});
			soFar = soFar.slice( matched.length );
		}

		// Filters
		for ( type in Expr.filter ) {
			if ( (match = matchExpr[ type ].exec( soFar )) && (!preFilters[ type ] ||
				(match = preFilters[ type ]( match ))) ) {
				matched = match.shift();
				tokens.push({
					value: matched,
					type: type,
					matches: match
				});
				soFar = soFar.slice( matched.length );
			}
		}

		if ( !matched ) {
			break;
		}
	}

	// Return the length of the invalid excess
	// if we're just parsing
	// Otherwise, throw an error or return tokens
	return parseOnly ?
		soFar.length :
		soFar ?
			Sizzle.error( selector ) :
			// Cache the tokens
			tokenCache( selector, groups ).slice( 0 );
};

function toSelector( tokens ) {
	var i = 0,
		len = tokens.length,
		selector = "";
	for ( ; i < len; i++ ) {
		selector += tokens[i].value;
	}
	return selector;
}

function addCombinator( matcher, combinator, base ) {
	var dir = combinator.dir,
		checkNonElements = base && dir === "parentNode",
		doneName = done++;

	return combinator.first ?
		// Check against closest ancestor/preceding element
		function( elem, context, xml ) {
			while ( (elem = elem[ dir ]) ) {
				if ( elem.nodeType === 1 || checkNonElements ) {
					return matcher( elem, context, xml );
				}
			}
		} :

		// Check against all ancestor/preceding elements
		function( elem, context, xml ) {
			var oldCache, uniqueCache, outerCache,
				newCache = [ dirruns, doneName ];

			// We can't set arbitrary data on XML nodes, so they don't benefit from combinator caching
			if ( xml ) {
				while ( (elem = elem[ dir ]) ) {
					if ( elem.nodeType === 1 || checkNonElements ) {
						if ( matcher( elem, context, xml ) ) {
							return true;
						}
					}
				}
			} else {
				while ( (elem = elem[ dir ]) ) {
					if ( elem.nodeType === 1 || checkNonElements ) {
						outerCache = elem[ expando ] || (elem[ expando ] = {});

						// Support: IE <9 only
						// Defend against cloned attroperties (jQuery gh-1709)
						uniqueCache = outerCache[ elem.uniqueID ] || (outerCache[ elem.uniqueID ] = {});

						if ( (oldCache = uniqueCache[ dir ]) &&
							oldCache[ 0 ] === dirruns && oldCache[ 1 ] === doneName ) {

							// Assign to newCache so results back-propagate to previous elements
							return (newCache[ 2 ] = oldCache[ 2 ]);
						} else {
							// Reuse newcache so results back-propagate to previous elements
							uniqueCache[ dir ] = newCache;

							// A match means we're done; a fail means we have to keep checking
							if ( (newCache[ 2 ] = matcher( elem, context, xml )) ) {
								return true;
							}
						}
					}
				}
			}
		};
}

function elementMatcher( matchers ) {
	return matchers.length > 1 ?
		function( elem, context, xml ) {
			var i = matchers.length;
			while ( i-- ) {
				if ( !matchers[i]( elem, context, xml ) ) {
					return false;
				}
			}
			return true;
		} :
		matchers[0];
}

function multipleContexts( selector, contexts, results ) {
	var i = 0,
		len = contexts.length;
	for ( ; i < len; i++ ) {
		Sizzle( selector, contexts[i], results );
	}
	return results;
}

function condense( unmatched, map, filter, context, xml ) {
	var elem,
		newUnmatched = [],
		i = 0,
		len = unmatched.length,
		mapped = map != null;

	for ( ; i < len; i++ ) {
		if ( (elem = unmatched[i]) ) {
			if ( !filter || filter( elem, context, xml ) ) {
				newUnmatched.push( elem );
				if ( mapped ) {
					map.push( i );
				}
			}
		}
	}

	return newUnmatched;
}

function setMatcher( preFilter, selector, matcher, postFilter, postFinder, postSelector ) {
	if ( postFilter && !postFilter[ expando ] ) {
		postFilter = setMatcher( postFilter );
	}
	if ( postFinder && !postFinder[ expando ] ) {
		postFinder = setMatcher( postFinder, postSelector );
	}
	return markFunction(function( seed, results, context, xml ) {
		var temp, i, elem,
			preMap = [],
			postMap = [],
			preexisting = results.length,

			// Get initial elements from seed or context
			elems = seed || multipleContexts( selector || "*", context.nodeType ? [ context ] : context, [] ),

			// Prefilter to get matcher input, preserving a map for seed-results synchronization
			matcherIn = preFilter && ( seed || !selector ) ?
				condense( elems, preMap, preFilter, context, xml ) :
				elems,

			matcherOut = matcher ?
				// If we have a postFinder, or filtered seed, or non-seed postFilter or preexisting results,
				postFinder || ( seed ? preFilter : preexisting || postFilter ) ?

					// ...intermediate processing is necessary
					[] :

					// ...otherwise use results directly
					results :
				matcherIn;

		// Find primary matches
		if ( matcher ) {
			matcher( matcherIn, matcherOut, context, xml );
		}

		// Apply postFilter
		if ( postFilter ) {
			temp = condense( matcherOut, postMap );
			postFilter( temp, [], context, xml );

			// Un-match failing elements by moving them back to matcherIn
			i = temp.length;
			while ( i-- ) {
				if ( (elem = temp[i]) ) {
					matcherOut[ postMap[i] ] = !(matcherIn[ postMap[i] ] = elem);
				}
			}
		}

		if ( seed ) {
			if ( postFinder || preFilter ) {
				if ( postFinder ) {
					// Get the final matcherOut by condensing this intermediate into postFinder contexts
					temp = [];
					i = matcherOut.length;
					while ( i-- ) {
						if ( (elem = matcherOut[i]) ) {
							// Restore matcherIn since elem is not yet a final match
							temp.push( (matcherIn[i] = elem) );
						}
					}
					postFinder( null, (matcherOut = []), temp, xml );
				}

				// Move matched elements from seed to results to keep them synchronized
				i = matcherOut.length;
				while ( i-- ) {
					if ( (elem = matcherOut[i]) &&
						(temp = postFinder ? indexOf( seed, elem ) : preMap[i]) > -1 ) {

						seed[temp] = !(results[temp] = elem);
					}
				}
			}

		// Add elements to results, through postFinder if defined
		} else {
			matcherOut = condense(
				matcherOut === results ?
					matcherOut.splice( preexisting, matcherOut.length ) :
					matcherOut
			);
			if ( postFinder ) {
				postFinder( null, results, matcherOut, xml );
			} else {
				push.apply( results, matcherOut );
			}
		}
	});
}

function matcherFromTokens( tokens ) {
	var checkContext, matcher, j,
		len = tokens.length,
		leadingRelative = Expr.relative[ tokens[0].type ],
		implicitRelative = leadingRelative || Expr.relative[" "],
		i = leadingRelative ? 1 : 0,

		// The foundational matcher ensures that elements are reachable from top-level context(s)
		matchContext = addCombinator( function( elem ) {
			return elem === checkContext;
		}, implicitRelative, true ),
		matchAnyContext = addCombinator( function( elem ) {
			return indexOf( checkContext, elem ) > -1;
		}, implicitRelative, true ),
		matchers = [ function( elem, context, xml ) {
			var ret = ( !leadingRelative && ( xml || context !== outermostContext ) ) || (
				(checkContext = context).nodeType ?
					matchContext( elem, context, xml ) :
					matchAnyContext( elem, context, xml ) );
			// Avoid hanging onto element (issue #299)
			checkContext = null;
			return ret;
		} ];

	for ( ; i < len; i++ ) {
		if ( (matcher = Expr.relative[ tokens[i].type ]) ) {
			matchers = [ addCombinator(elementMatcher( matchers ), matcher) ];
		} else {
			matcher = Expr.filter[ tokens[i].type ].apply( null, tokens[i].matches );

			// Return special upon seeing a positional matcher
			if ( matcher[ expando ] ) {
				// Find the next relative operator (if any) for proper handling
				j = ++i;
				for ( ; j < len; j++ ) {
					if ( Expr.relative[ tokens[j].type ] ) {
						break;
					}
				}
				return setMatcher(
					i > 1 && elementMatcher( matchers ),
					i > 1 && toSelector(
						// If the preceding token was a descendant combinator, insert an implicit any-element `*`
						tokens.slice( 0, i - 1 ).concat({ value: tokens[ i - 2 ].type === " " ? "*" : "" })
					).replace( rtrim, "$1" ),
					matcher,
					i < j && matcherFromTokens( tokens.slice( i, j ) ),
					j < len && matcherFromTokens( (tokens = tokens.slice( j )) ),
					j < len && toSelector( tokens )
				);
			}
			matchers.push( matcher );
		}
	}

	return elementMatcher( matchers );
}

function matcherFromGroupMatchers( elementMatchers, setMatchers ) {
	var bySet = setMatchers.length > 0,
		byElement = elementMatchers.length > 0,
		superMatcher = function( seed, context, xml, results, outermost ) {
			var elem, j, matcher,
				matchedCount = 0,
				i = "0",
				unmatched = seed && [],
				setMatched = [],
				contextBackup = outermostContext,
				// We must always have either seed elements or outermost context
				elems = seed || byElement && Expr.find["TAG"]( "*", outermost ),
				// Use integer dirruns iff this is the outermost matcher
				dirrunsUnique = (dirruns += contextBackup == null ? 1 : Math.random() || 0.1),
				len = elems.length;

			if ( outermost ) {
				outermostContext = context === document || context || outermost;
			}

			// Add elements passing elementMatchers directly to results
			// Support: IE<9, Safari
			// Tolerate NodeList properties (IE: "length"; Safari: <number>) matching elements by id
			for ( ; i !== len && (elem = elems[i]) != null; i++ ) {
				if ( byElement && elem ) {
					j = 0;
					if ( !context && elem.ownerDocument !== document ) {
						setDocument( elem );
						xml = !documentIsHTML;
					}
					while ( (matcher = elementMatchers[j++]) ) {
						if ( matcher( elem, context || document, xml) ) {
							results.push( elem );
							break;
						}
					}
					if ( outermost ) {
						dirruns = dirrunsUnique;
					}
				}

				// Track unmatched elements for set filters
				if ( bySet ) {
					// They will have gone through all possible matchers
					if ( (elem = !matcher && elem) ) {
						matchedCount--;
					}

					// Lengthen the array for every element, matched or not
					if ( seed ) {
						unmatched.push( elem );
					}
				}
			}

			// `i` is now the count of elements visited above, and adding it to `matchedCount`
			// makes the latter nonnegative.
			matchedCount += i;

			// Apply set filters to unmatched elements
			// NOTE: This can be skipped if there are no unmatched elements (i.e., `matchedCount`
			// equals `i`), unless we didn't visit _any_ elements in the above loop because we have
			// no element matchers and no seed.
			// Incrementing an initially-string "0" `i` allows `i` to remain a string only in that
			// case, which will result in a "00" `matchedCount` that differs from `i` but is also
			// numerically zero.
			if ( bySet && i !== matchedCount ) {
				j = 0;
				while ( (matcher = setMatchers[j++]) ) {
					matcher( unmatched, setMatched, context, xml );
				}

				if ( seed ) {
					// Reintegrate element matches to eliminate the need for sorting
					if ( matchedCount > 0 ) {
						while ( i-- ) {
							if ( !(unmatched[i] || setMatched[i]) ) {
								setMatched[i] = pop.call( results );
							}
						}
					}

					// Discard index placeholder values to get only actual matches
					setMatched = condense( setMatched );
				}

				// Add matches to results
				push.apply( results, setMatched );

				// Seedless set matches succeeding multiple successful matchers stipulate sorting
				if ( outermost && !seed && setMatched.length > 0 &&
					( matchedCount + setMatchers.length ) > 1 ) {

					Sizzle.uniqueSort( results );
				}
			}

			// Override manipulation of globals by nested matchers
			if ( outermost ) {
				dirruns = dirrunsUnique;
				outermostContext = contextBackup;
			}

			return unmatched;
		};

	return bySet ?
		markFunction( superMatcher ) :
		superMatcher;
}

compile = Sizzle.compile = function( selector, match /* Internal Use Only */ ) {
	var i,
		setMatchers = [],
		elementMatchers = [],
		cached = compilerCache[ selector + " " ];

	if ( !cached ) {
		// Generate a function of recursive functions that can be used to check each element
		if ( !match ) {
			match = tokenize( selector );
		}
		i = match.length;
		while ( i-- ) {
			cached = matcherFromTokens( match[i] );
			if ( cached[ expando ] ) {
				setMatchers.push( cached );
			} else {
				elementMatchers.push( cached );
			}
		}

		// Cache the compiled function
		cached = compilerCache( selector, matcherFromGroupMatchers( elementMatchers, setMatchers ) );

		// Save selector and tokenization
		cached.selector = selector;
	}
	return cached;
};

/**
 * A low-level selection function that works with Sizzle's compiled
 *  selector functions
 * @param {String|Function} selector A selector or a pre-compiled
 *  selector function built with Sizzle.compile
 * @param {Element} context
 * @param {Array} [results]
 * @param {Array} [seed] A set of elements to match against
 */
select = Sizzle.select = function( selector, context, results, seed ) {
	var i, tokens, token, type, find,
		compiled = typeof selector === "function" && selector,
		match = !seed && tokenize( (selector = compiled.selector || selector) );

	results = results || [];

	// Try to minimize operations if there is only one selector in the list and no seed
	// (the latter of which guarantees us context)
	if ( match.length === 1 ) {

		// Reduce context if the leading compound selector is an ID
		tokens = match[0] = match[0].slice( 0 );
		if ( tokens.length > 2 && (token = tokens[0]).type === "ID" &&
				support.getById && context.nodeType === 9 && documentIsHTML &&
				Expr.relative[ tokens[1].type ] ) {

			context = ( Expr.find["ID"]( token.matches[0].replace(runescape, funescape), context ) || [] )[0];
			if ( !context ) {
				return results;

			// Precompiled matchers will still verify ancestry, so step up a level
			} else if ( compiled ) {
				context = context.parentNode;
			}

			selector = selector.slice( tokens.shift().value.length );
		}

		// Fetch a seed set for right-to-left matching
		i = matchExpr["needsContext"].test( selector ) ? 0 : tokens.length;
		while ( i-- ) {
			token = tokens[i];

			// Abort if we hit a combinator
			if ( Expr.relative[ (type = token.type) ] ) {
				break;
			}
			if ( (find = Expr.find[ type ]) ) {
				// Search, expanding context for leading sibling combinators
				if ( (seed = find(
					token.matches[0].replace( runescape, funescape ),
					rsibling.test( tokens[0].type ) && testContext( context.parentNode ) || context
				)) ) {

					// If seed is empty or no tokens remain, we can return early
					tokens.splice( i, 1 );
					selector = seed.length && toSelector( tokens );
					if ( !selector ) {
						push.apply( results, seed );
						return results;
					}

					break;
				}
			}
		}
	}

	// Compile and execute a filtering function if one is not provided
	// Provide `match` to avoid retokenization if we modified the selector above
	( compiled || compile( selector, match ) )(
		seed,
		context,
		!documentIsHTML,
		results,
		!context || rsibling.test( selector ) && testContext( context.parentNode ) || context
	);
	return results;
};

// One-time assignments

// Sort stability
support.sortStable = expando.split("").sort( sortOrder ).join("") === expando;

// Support: Chrome 14-35+
// Always assume duplicates if they aren't passed to the comparison function
support.detectDuplicates = !!hasDuplicate;

// Initialize against the default document
setDocument();

// Support: Webkit<537.32 - Safari 6.0.3/Chrome 25 (fixed in Chrome 27)
// Detached nodes confoundingly follow *each other*
support.sortDetached = assert(function( div1 ) {
	// Should return 1, but returns 4 (following)
	return div1.compareDocumentPosition( document.createElement("div") ) & 1;
});

// Support: IE<8
// Prevent attribute/property "interpolation"
// http://msdn.microsoft.com/en-us/library/ms536429%28VS.85%29.aspx
if ( !assert(function( div ) {
	div.innerHTML = "<a href='#'></a>";
	return div.firstChild.getAttribute("href") === "#" ;
}) ) {
	addHandle( "type|href|height|width", function( elem, name, isXML ) {
		if ( !isXML ) {
			return elem.getAttribute( name, name.toLowerCase() === "type" ? 1 : 2 );
		}
	});
}

// Support: IE<9
// Use defaultValue in place of getAttribute("value")
if ( !support.attributes || !assert(function( div ) {
	div.innerHTML = "<input/>";
	div.firstChild.setAttribute( "value", "" );
	return div.firstChild.getAttribute( "value" ) === "";
}) ) {
	addHandle( "value", function( elem, name, isXML ) {
		if ( !isXML && elem.nodeName.toLowerCase() === "input" ) {
			return elem.defaultValue;
		}
	});
}

// Support: IE<9
// Use getAttributeNode to fetch booleans when getAttribute lies
if ( !assert(function( div ) {
	return div.getAttribute("disabled") == null;
}) ) {
	addHandle( booleans, function( elem, name, isXML ) {
		var val;
		if ( !isXML ) {
			return elem[ name ] === true ? name.toLowerCase() :
					(val = elem.getAttributeNode( name )) && val.specified ?
					val.value :
				null;
		}
	});
}

return Sizzle;

})( window );



jQuery.find = Sizzle;
jQuery.expr = Sizzle.selectors;
jQuery.expr[ ":" ] = jQuery.expr.pseudos;
jQuery.uniqueSort = jQuery.unique = Sizzle.uniqueSort;
jQuery.text = Sizzle.getText;
jQuery.isXMLDoc = Sizzle.isXML;
jQuery.contains = Sizzle.contains;



var dir = function( elem, dir, until ) {
	var matched = [],
		truncate = until !== undefined;

	while ( ( elem = elem[ dir ] ) && elem.nodeType !== 9 ) {
		if ( elem.nodeType === 1 ) {
			if ( truncate && jQuery( elem ).is( until ) ) {
				break;
			}
			matched.push( elem );
		}
	}
	return matched;
};


var siblings = function( n, elem ) {
	var matched = [];

	for ( ; n; n = n.nextSibling ) {
		if ( n.nodeType === 1 && n !== elem ) {
			matched.push( n );
		}
	}

	return matched;
};


var rneedsContext = jQuery.expr.match.needsContext;

var rsingleTag = ( /^<([\w-]+)\s*\/?>(?:<\/\1>|)$/ );



var risSimple = /^.[^:#\[\.,]*$/;

// Implement the identical functionality for filter and not
function winnow( elements, qualifier, not ) {
	if ( jQuery.isFunction( qualifier ) ) {
		return jQuery.grep( elements, function( elem, i ) {
			/* jshint -W018 */
			return !!qualifier.call( elem, i, elem ) !== not;
		} );

	}

	if ( qualifier.nodeType ) {
		return jQuery.grep( elements, function( elem ) {
			return ( elem === qualifier ) !== not;
		} );

	}

	if ( typeof qualifier === "string" ) {
		if ( risSimple.test( qualifier ) ) {
			return jQuery.filter( qualifier, elements, not );
		}

		qualifier = jQuery.filter( qualifier, elements );
	}

	return jQuery.grep( elements, function( elem ) {
		return ( indexOf.call( qualifier, elem ) > -1 ) !== not;
	} );
}

jQuery.filter = function( expr, elems, not ) {
	var elem = elems[ 0 ];

	if ( not ) {
		expr = ":not(" + expr + ")";
	}

	return elems.length === 1 && elem.nodeType === 1 ?
		jQuery.find.matchesSelector( elem, expr ) ? [ elem ] : [] :
		jQuery.find.matches( expr, jQuery.grep( elems, function( elem ) {
			return elem.nodeType === 1;
		} ) );
};

jQuery.fn.extend( {
	find: function( selector ) {
		var i,
			len = this.length,
			ret = [],
			self = this;

		if ( typeof selector !== "string" ) {
			return this.pushStack( jQuery( selector ).filter( function() {
				for ( i = 0; i < len; i++ ) {
					if ( jQuery.contains( self[ i ], this ) ) {
						return true;
					}
				}
			} ) );
		}

		for ( i = 0; i < len; i++ ) {
			jQuery.find( selector, self[ i ], ret );
		}

		// Needed because $( selector, context ) becomes $( context ).find( selector )
		ret = this.pushStack( len > 1 ? jQuery.unique( ret ) : ret );
		ret.selector = this.selector ? this.selector + " " + selector : selector;
		return ret;
	},
	filter: function( selector ) {
		return this.pushStack( winnow( this, selector || [], false ) );
	},
	not: function( selector ) {
		return this.pushStack( winnow( this, selector || [], true ) );
	},
	is: function( selector ) {
		return !!winnow(
			this,

			// If this is a positional/relative selector, check membership in the returned set
			// so $("p:first").is("p:last") won't return true for a doc with two "p".
			typeof selector === "string" && rneedsContext.test( selector ) ?
				jQuery( selector ) :
				selector || [],
			false
		).length;
	}
} );


// Initialize a jQuery object


// A central reference to the root jQuery(document)
var rootjQuery,

	// A simple way to check for HTML strings
	// Prioritize #id over <tag> to avoid XSS via location.hash (#9521)
	// Strict HTML recognition (#11290: must start with <)
	rquickExpr = /^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]*))$/,

	init = jQuery.fn.init = function( selector, context, root ) {
		var match, elem;

		// HANDLE: $(""), $(null), $(undefined), $(false)
		if ( !selector ) {
			return this;
		}

		// Method init() accepts an alternate rootjQuery
		// so migrate can support jQuery.sub (gh-2101)
		root = root || rootjQuery;

		// Handle HTML strings
		if ( typeof selector === "string" ) {
			if ( selector[ 0 ] === "<" &&
				selector[ selector.length - 1 ] === ">" &&
				selector.length >= 3 ) {

				// Assume that strings that start and end with <> are HTML and skip the regex check
				match = [ null, selector, null ];

			} else {
				match = rquickExpr.exec( selector );
			}

			// Match html or make sure no context is specified for #id
			if ( match && ( match[ 1 ] || !context ) ) {

				// HANDLE: $(html) -> $(array)
				if ( match[ 1 ] ) {
					context = context instanceof jQuery ? context[ 0 ] : context;

					// Option to run scripts is true for back-compat
					// Intentionally let the error be thrown if parseHTML is not present
					jQuery.merge( this, jQuery.parseHTML(
						match[ 1 ],
						context && context.nodeType ? context.ownerDocument || context : document,
						true
					) );

					// HANDLE: $(html, props)
					if ( rsingleTag.test( match[ 1 ] ) && jQuery.isPlainObject( context ) ) {
						for ( match in context ) {

							// Properties of context are called as methods if possible
							if ( jQuery.isFunction( this[ match ] ) ) {
								this[ match ]( context[ match ] );

							// ...and otherwise set as attributes
							} else {
								this.attr( match, context[ match ] );
							}
						}
					}

					return this;

				// HANDLE: $(#id)
				} else {
					elem = document.getElementById( match[ 2 ] );

					// Support: Blackberry 4.6
					// gEBID returns nodes no longer in the document (#6963)
					if ( elem && elem.parentNode ) {

						// Inject the element directly into the jQuery object
						this.length = 1;
						this[ 0 ] = elem;
					}

					this.context = document;
					this.selector = selector;
					return this;
				}

			// HANDLE: $(expr, $(...))
			} else if ( !context || context.jquery ) {
				return ( context || root ).find( selector );

			// HANDLE: $(expr, context)
			// (which is just equivalent to: $(context).find(expr)
			} else {
				return this.constructor( context ).find( selector );
			}

		// HANDLE: $(DOMElement)
		} else if ( selector.nodeType ) {
			this.context = this[ 0 ] = selector;
			this.length = 1;
			return this;

		// HANDLE: $(function)
		// Shortcut for document ready
		} else if ( jQuery.isFunction( selector ) ) {
			return root.ready !== undefined ?
				root.ready( selector ) :

				// Execute immediately if ready is not present
				selector( jQuery );
		}

		if ( selector.selector !== undefined ) {
			this.selector = selector.selector;
			this.context = selector.context;
		}

		return jQuery.makeArray( selector, this );
	};

// Give the init function the jQuery prototype for later instantiation
init.prototype = jQuery.fn;

// Initialize central reference
rootjQuery = jQuery( document );


var rparentsprev = /^(?:parents|prev(?:Until|All))/,

	// Methods guaranteed to produce a unique set when starting from a unique set
	guaranteedUnique = {
		children: true,
		contents: true,
		next: true,
		prev: true
	};

jQuery.fn.extend( {
	has: function( target ) {
		var targets = jQuery( target, this ),
			l = targets.length;

		return this.filter( function() {
			var i = 0;
			for ( ; i < l; i++ ) {
				if ( jQuery.contains( this, targets[ i ] ) ) {
					return true;
				}
			}
		} );
	},

	closest: function( selectors, context ) {
		var cur,
			i = 0,
			l = this.length,
			matched = [],
			pos = rneedsContext.test( selectors ) || typeof selectors !== "string" ?
				jQuery( selectors, context || this.context ) :
				0;

		for ( ; i < l; i++ ) {
			for ( cur = this[ i ]; cur && cur !== context; cur = cur.parentNode ) {

				// Always skip document fragments
				if ( cur.nodeType < 11 && ( pos ?
					pos.index( cur ) > -1 :

					// Don't pass non-elements to Sizzle
					cur.nodeType === 1 &&
						jQuery.find.matchesSelector( cur, selectors ) ) ) {

					matched.push( cur );
					break;
				}
			}
		}

		return this.pushStack( matched.length > 1 ? jQuery.uniqueSort( matched ) : matched );
	},

	// Determine the position of an element within the set
	index: function( elem ) {

		// No argument, return index in parent
		if ( !elem ) {
			return ( this[ 0 ] && this[ 0 ].parentNode ) ? this.first().prevAll().length : -1;
		}

		// Index in selector
		if ( typeof elem === "string" ) {
			return indexOf.call( jQuery( elem ), this[ 0 ] );
		}

		// Locate the position of the desired element
		return indexOf.call( this,

			// If it receives a jQuery object, the first element is used
			elem.jquery ? elem[ 0 ] : elem
		);
	},

	add: function( selector, context ) {
		return this.pushStack(
			jQuery.uniqueSort(
				jQuery.merge( this.get(), jQuery( selector, context ) )
			)
		);
	},

	addBack: function( selector ) {
		return this.add( selector == null ?
			this.prevObject : this.prevObject.filter( selector )
		);
	}
} );

function sibling( cur, dir ) {
	while ( ( cur = cur[ dir ] ) && cur.nodeType !== 1 ) {}
	return cur;
}

jQuery.each( {
	parent: function( elem ) {
		var parent = elem.parentNode;
		return parent && parent.nodeType !== 11 ? parent : null;
	},
	parents: function( elem ) {
		return dir( elem, "parentNode" );
	},
	parentsUntil: function( elem, i, until ) {
		return dir( elem, "parentNode", until );
	},
	next: function( elem ) {
		return sibling( elem, "nextSibling" );
	},
	prev: function( elem ) {
		return sibling( elem, "previousSibling" );
	},
	nextAll: function( elem ) {
		return dir( elem, "nextSibling" );
	},
	prevAll: function( elem ) {
		return dir( elem, "previousSibling" );
	},
	nextUntil: function( elem, i, until ) {
		return dir( elem, "nextSibling", until );
	},
	prevUntil: function( elem, i, until ) {
		return dir( elem, "previousSibling", until );
	},
	siblings: function( elem ) {
		return siblings( ( elem.parentNode || {} ).firstChild, elem );
	},
	children: function( elem ) {
		return siblings( elem.firstChild );
	},
	contents: function( elem ) {
		return elem.contentDocument || jQuery.merge( [], elem.childNodes );
	}
}, function( name, fn ) {
	jQuery.fn[ name ] = function( until, selector ) {
		var matched = jQuery.map( this, fn, until );

		if ( name.slice( -5 ) !== "Until" ) {
			selector = until;
		}

		if ( selector && typeof selector === "string" ) {
			matched = jQuery.filter( selector, matched );
		}

		if ( this.length > 1 ) {

			// Remove duplicates
			if ( !guaranteedUnique[ name ] ) {
				jQuery.uniqueSort( matched );
			}

			// Reverse order for parents* and prev-derivatives
			if ( rparentsprev.test( name ) ) {
				matched.reverse();
			}
		}

		return this.pushStack( matched );
	};
} );
var rnotwhite = ( /\S+/g );



// Convert String-formatted options into Object-formatted ones
function createOptions( options ) {
	var object = {};
	jQuery.each( options.match( rnotwhite ) || [], function( _, flag ) {
		object[ flag ] = true;
	} );
	return object;
}

/*
 * Create a callback list using the following parameters:
 *
 *	options: an optional list of space-separated options that will change how
 *			the callback list behaves or a more traditional option object
 *
 * By default a callback list will act like an event callback list and can be
 * "fired" multiple times.
 *
 * Possible options:
 *
 *	once:			will ensure the callback list can only be fired once (like a Deferred)
 *
 *	memory:			will keep track of previous values and will call any callback added
 *					after the list has been fired right away with the latest "memorized"
 *					values (like a Deferred)
 *
 *	unique:			will ensure a callback can only be added once (no duplicate in the list)
 *
 *	stopOnFalse:	interrupt callings when a callback returns false
 *
 */
jQuery.Callbacks = function( options ) {

	// Convert options from String-formatted to Object-formatted if needed
	// (we check in cache first)
	options = typeof options === "string" ?
		createOptions( options ) :
		jQuery.extend( {}, options );

	var // Flag to know if list is currently firing
		firing,

		// Last fire value for non-forgettable lists
		memory,

		// Flag to know if list was already fired
		fired,

		// Flag to prevent firing
		locked,

		// Actual callback list
		list = [],

		// Queue of execution data for repeatable lists
		queue = [],

		// Index of currently firing callback (modified by add/remove as needed)
		firingIndex = -1,

		// Fire callbacks
		fire = function() {

			// Enforce single-firing
			locked = options.once;

			// Execute callbacks for all pending executions,
			// respecting firingIndex overrides and runtime changes
			fired = firing = true;
			for ( ; queue.length; firingIndex = -1 ) {
				memory = queue.shift();
				while ( ++firingIndex < list.length ) {

					// Run callback and check for early termination
					if ( list[ firingIndex ].apply( memory[ 0 ], memory[ 1 ] ) === false &&
						options.stopOnFalse ) {

						// Jump to end and forget the data so .add doesn't re-fire
						firingIndex = list.length;
						memory = false;
					}
				}
			}

			// Forget the data if we're done with it
			if ( !options.memory ) {
				memory = false;
			}

			firing = false;

			// Clean up if we're done firing for good
			if ( locked ) {

				// Keep an empty list if we have data for future add calls
				if ( memory ) {
					list = [];

				// Otherwise, this object is spent
				} else {
					list = "";
				}
			}
		},

		// Actual Callbacks object
		self = {

			// Add a callback or a collection of callbacks to the list
			add: function() {
				if ( list ) {

					// If we have memory from a past run, we should fire after adding
					if ( memory && !firing ) {
						firingIndex = list.length - 1;
						queue.push( memory );
					}

					( function add( args ) {
						jQuery.each( args, function( _, arg ) {
							if ( jQuery.isFunction( arg ) ) {
								if ( !options.unique || !self.has( arg ) ) {
									list.push( arg );
								}
							} else if ( arg && arg.length && jQuery.type( arg ) !== "string" ) {

								// Inspect recursively
								add( arg );
							}
						} );
					} )( arguments );

					if ( memory && !firing ) {
						fire();
					}
				}
				return this;
			},

			// Remove a callback from the list
			remove: function() {
				jQuery.each( arguments, function( _, arg ) {
					var index;
					while ( ( index = jQuery.inArray( arg, list, index ) ) > -1 ) {
						list.splice( index, 1 );

						// Handle firing indexes
						if ( index <= firingIndex ) {
							firingIndex--;
						}
					}
				} );
				return this;
			},

			// Check if a given callback is in the list.
			// If no argument is given, return whether or not list has callbacks attached.
			has: function( fn ) {
				return fn ?
					jQuery.inArray( fn, list ) > -1 :
					list.length > 0;
			},

			// Remove all callbacks from the list
			empty: function() {
				if ( list ) {
					list = [];
				}
				return this;
			},

			// Disable .fire and .add
			// Abort any current/pending executions
			// Clear all callbacks and values
			disable: function() {
				locked = queue = [];
				list = memory = "";
				return this;
			},
			disabled: function() {
				return !list;
			},

			// Disable .fire
			// Also disable .add unless we have memory (since it would have no effect)
			// Abort any pending executions
			lock: function() {
				locked = queue = [];
				if ( !memory ) {
					list = memory = "";
				}
				return this;
			},
			locked: function() {
				return !!locked;
			},

			// Call all callbacks with the given context and arguments
			fireWith: function( context, args ) {
				if ( !locked ) {
					args = args || [];
					args = [ context, args.slice ? args.slice() : args ];
					queue.push( args );
					if ( !firing ) {
						fire();
					}
				}
				return this;
			},

			// Call all the callbacks with the given arguments
			fire: function() {
				self.fireWith( this, arguments );
				return this;
			},

			// To know if the callbacks have already been called at least once
			fired: function() {
				return !!fired;
			}
		};

	return self;
};


jQuery.extend( {

	Deferred: function( func ) {
		var tuples = [

				// action, add listener, listener list, final state
				[ "resolve", "done", jQuery.Callbacks( "once memory" ), "resolved" ],
				[ "reject", "fail", jQuery.Callbacks( "once memory" ), "rejected" ],
				[ "notify", "progress", jQuery.Callbacks( "memory" ) ]
			],
			state = "pending",
			promise = {
				state: function() {
					return state;
				},
				always: function() {
					deferred.done( arguments ).fail( arguments );
					return this;
				},
				then: function( /* fnDone, fnFail, fnProgress */ ) {
					var fns = arguments;
					return jQuery.Deferred( function( newDefer ) {
						jQuery.each( tuples, function( i, tuple ) {
							var fn = jQuery.isFunction( fns[ i ] ) && fns[ i ];

							// deferred[ done | fail | progress ] for forwarding actions to newDefer
							deferred[ tuple[ 1 ] ]( function() {
								var returned = fn && fn.apply( this, arguments );
								if ( returned && jQuery.isFunction( returned.promise ) ) {
									returned.promise()
										.progress( newDefer.notify )
										.done( newDefer.resolve )
										.fail( newDefer.reject );
								} else {
									newDefer[ tuple[ 0 ] + "With" ](
										this === promise ? newDefer.promise() : this,
										fn ? [ returned ] : arguments
									);
								}
							} );
						} );
						fns = null;
					} ).promise();
				},

				// Get a promise for this deferred
				// If obj is provided, the promise aspect is added to the object
				promise: function( obj ) {
					return obj != null ? jQuery.extend( obj, promise ) : promise;
				}
			},
			deferred = {};

		// Keep pipe for back-compat
		promise.pipe = promise.then;

		// Add list-specific methods
		jQuery.each( tuples, function( i, tuple ) {
			var list = tuple[ 2 ],
				stateString = tuple[ 3 ];

			// promise[ done | fail | progress ] = list.add
			promise[ tuple[ 1 ] ] = list.add;

			// Handle state
			if ( stateString ) {
				list.add( function() {

					// state = [ resolved | rejected ]
					state = stateString;

				// [ reject_list | resolve_list ].disable; progress_list.lock
				}, tuples[ i ^ 1 ][ 2 ].disable, tuples[ 2 ][ 2 ].lock );
			}

			// deferred[ resolve | reject | notify ]
			deferred[ tuple[ 0 ] ] = function() {
				deferred[ tuple[ 0 ] + "With" ]( this === deferred ? promise : this, arguments );
				return this;
			};
			deferred[ tuple[ 0 ] + "With" ] = list.fireWith;
		} );

		// Make the deferred a promise
		promise.promise( deferred );

		// Call given func if any
		if ( func ) {
			func.call( deferred, deferred );
		}

		// All done!
		return deferred;
	},

	// Deferred helper
	when: function( subordinate /* , ..., subordinateN */ ) {
		var i = 0,
			resolveValues = slice.call( arguments ),
			length = resolveValues.length,

			// the count of uncompleted subordinates
			remaining = length !== 1 ||
				( subordinate && jQuery.isFunction( subordinate.promise ) ) ? length : 0,

			// the master Deferred.
			// If resolveValues consist of only a single Deferred, just use that.
			deferred = remaining === 1 ? subordinate : jQuery.Deferred(),

			// Update function for both resolve and progress values
			updateFunc = function( i, contexts, values ) {
				return function( value ) {
					contexts[ i ] = this;
					values[ i ] = arguments.length > 1 ? slice.call( arguments ) : value;
					if ( values === progressValues ) {
						deferred.notifyWith( contexts, values );
					} else if ( !( --remaining ) ) {
						deferred.resolveWith( contexts, values );
					}
				};
			},

			progressValues, progressContexts, resolveContexts;

		// Add listeners to Deferred subordinates; treat others as resolved
		if ( length > 1 ) {
			progressValues = new Array( length );
			progressContexts = new Array( length );
			resolveContexts = new Array( length );
			for ( ; i < length; i++ ) {
				if ( resolveValues[ i ] && jQuery.isFunction( resolveValues[ i ].promise ) ) {
					resolveValues[ i ].promise()
						.progress( updateFunc( i, progressContexts, progressValues ) )
						.done( updateFunc( i, resolveContexts, resolveValues ) )
						.fail( deferred.reject );
				} else {
					--remaining;
				}
			}
		}

		// If we're not waiting on anything, resolve the master
		if ( !remaining ) {
			deferred.resolveWith( resolveContexts, resolveValues );
		}

		return deferred.promise();
	}
} );


// The deferred used on DOM ready
var readyList;

jQuery.fn.ready = function( fn ) {

	// Add the callback
	jQuery.ready.promise().done( fn );

	return this;
};

jQuery.extend( {

	// Is the DOM ready to be used? Set to true once it occurs.
	isReady: false,

	// A counter to track how many items to wait for before
	// the ready event fires. See #6781
	readyWait: 1,

	// Hold (or release) the ready event
	holdReady: function( hold ) {
		if ( hold ) {
			jQuery.readyWait++;
		} else {
			jQuery.ready( true );
		}
	},

	// Handle when the DOM is ready
	ready: function( wait ) {

		// Abort if there are pending holds or we're already ready
		if ( wait === true ? --jQuery.readyWait : jQuery.isReady ) {
			return;
		}

		// Remember that the DOM is ready
		jQuery.isReady = true;

		// If a normal DOM Ready event fired, decrement, and wait if need be
		if ( wait !== true && --jQuery.readyWait > 0 ) {
			return;
		}

		// If there are functions bound, to execute
		readyList.resolveWith( document, [ jQuery ] );

		// Trigger any bound ready events
		if ( jQuery.fn.triggerHandler ) {
			jQuery( document ).triggerHandler( "ready" );
			jQuery( document ).off( "ready" );
		}
	}
} );

/**
 * The ready event handler and self cleanup method
 */
function completed() {
	document.removeEventListener( "DOMContentLoaded", completed );
	window.removeEventListener( "load", completed );
	jQuery.ready();
}

jQuery.ready.promise = function( obj ) {
	if ( !readyList ) {

		readyList = jQuery.Deferred();

		// Catch cases where $(document).ready() is called
		// after the browser event has already occurred.
		// Support: IE9-10 only
		// Older IE sometimes signals "interactive" too soon
		if ( document.readyState === "complete" ||
			( document.readyState !== "loading" && !document.documentElement.doScroll ) ) {

			// Handle it asynchronously to allow scripts the opportunity to delay ready
			window.setTimeout( jQuery.ready );

		} else {

			// Use the handy event callback
			document.addEventListener( "DOMContentLoaded", completed );

			// A fallback to window.onload, that will always work
			window.addEventListener( "load", completed );
		}
	}
	return readyList.promise( obj );
};

// Kick off the DOM ready check even if the user does not
jQuery.ready.promise();




// Multifunctional method to get and set values of a collection
// The value/s can optionally be executed if it's a function
var access = function( elems, fn, key, value, chainable, emptyGet, raw ) {
	var i = 0,
		len = elems.length,
		bulk = key == null;

	// Sets many values
	if ( jQuery.type( key ) === "object" ) {
		chainable = true;
		for ( i in key ) {
			access( elems, fn, i, key[ i ], true, emptyGet, raw );
		}

	// Sets one value
	} else if ( value !== undefined ) {
		chainable = true;

		if ( !jQuery.isFunction( value ) ) {
			raw = true;
		}

		if ( bulk ) {

			// Bulk operations run against the entire set
			if ( raw ) {
				fn.call( elems, value );
				fn = null;

			// ...except when executing function values
			} else {
				bulk = fn;
				fn = function( elem, key, value ) {
					return bulk.call( jQuery( elem ), value );
				};
			}
		}

		if ( fn ) {
			for ( ; i < len; i++ ) {
				fn(
					elems[ i ], key, raw ?
					value :
					value.call( elems[ i ], i, fn( elems[ i ], key ) )
				);
			}
		}
	}

	return chainable ?
		elems :

		// Gets
		bulk ?
			fn.call( elems ) :
			len ? fn( elems[ 0 ], key ) : emptyGet;
};
var acceptData = function( owner ) {

	// Accepts only:
	//  - Node
	//    - Node.ELEMENT_NODE
	//    - Node.DOCUMENT_NODE
	//  - Object
	//    - Any
	/* jshint -W018 */
	return owner.nodeType === 1 || owner.nodeType === 9 || !( +owner.nodeType );
};




function Data() {
	this.expando = jQuery.expando + Data.uid++;
}

Data.uid = 1;

Data.prototype = {

	register: function( owner, initial ) {
		var value = initial || {};

		// If it is a node unlikely to be stringify-ed or looped over
		// use plain assignment
		if ( owner.nodeType ) {
			owner[ this.expando ] = value;

		// Otherwise secure it in a non-enumerable, non-writable property
		// configurability must be true to allow the property to be
		// deleted with the delete operator
		} else {
			Object.defineProperty( owner, this.expando, {
				value: value,
				writable: true,
				configurable: true
			} );
		}
		return owner[ this.expando ];
	},
	cache: function( owner ) {

		// We can accept data for non-element nodes in modern browsers,
		// but we should not, see #8335.
		// Always return an empty object.
		if ( !acceptData( owner ) ) {
			return {};
		}

		// Check if the owner object already has a cache
		var value = owner[ this.expando ];

		// If not, create one
		if ( !value ) {
			value = {};

			// We can accept data for non-element nodes in modern browsers,
			// but we should not, see #8335.
			// Always return an empty object.
			if ( acceptData( owner ) ) {

				// If it is a node unlikely to be stringify-ed or looped over
				// use plain assignment
				if ( owner.nodeType ) {
					owner[ this.expando ] = value;

				// Otherwise secure it in a non-enumerable property
				// configurable must be true to allow the property to be
				// deleted when data is removed
				} else {
					Object.defineProperty( owner, this.expando, {
						value: value,
						configurable: true
					} );
				}
			}
		}

		return value;
	},
	set: function( owner, data, value ) {
		var prop,
			cache = this.cache( owner );

		// Handle: [ owner, key, value ] args
		if ( typeof data === "string" ) {
			cache[ data ] = value;

		// Handle: [ owner, { properties } ] args
		} else {

			// Copy the properties one-by-one to the cache object
			for ( prop in data ) {
				cache[ prop ] = data[ prop ];
			}
		}
		return cache;
	},
	get: function( owner, key ) {
		return key === undefined ?
			this.cache( owner ) :
			owner[ this.expando ] && owner[ this.expando ][ key ];
	},
	access: function( owner, key, value ) {
		var stored;

		// In cases where either:
		//
		//   1. No key was specified
		//   2. A string key was specified, but no value provided
		//
		// Take the "read" path and allow the get method to determine
		// which value to return, respectively either:
		//
		//   1. The entire cache object
		//   2. The data stored at the key
		//
		if ( key === undefined ||
				( ( key && typeof key === "string" ) && value === undefined ) ) {

			stored = this.get( owner, key );

			return stored !== undefined ?
				stored : this.get( owner, jQuery.camelCase( key ) );
		}

		// When the key is not a string, or both a key and value
		// are specified, set or extend (existing objects) with either:
		//
		//   1. An object of properties
		//   2. A key and value
		//
		this.set( owner, key, value );

		// Since the "set" path can have two possible entry points
		// return the expected data based on which path was taken[*]
		return value !== undefined ? value : key;
	},
	remove: function( owner, key ) {
		var i, name, camel,
			cache = owner[ this.expando ];

		if ( cache === undefined ) {
			return;
		}

		if ( key === undefined ) {
			this.register( owner );

		} else {

			// Support array or space separated string of keys
			if ( jQuery.isArray( key ) ) {

				// If "name" is an array of keys...
				// When data is initially created, via ("key", "val") signature,
				// keys will be converted to camelCase.
				// Since there is no way to tell _how_ a key was added, remove
				// both plain key and camelCase key. #12786
				// This will only penalize the array argument path.
				name = key.concat( key.map( jQuery.camelCase ) );
			} else {
				camel = jQuery.camelCase( key );

				// Try the string as a key before any manipulation
				if ( key in cache ) {
					name = [ key, camel ];
				} else {

					// If a key with the spaces exists, use it.
					// Otherwise, create an array by matching non-whitespace
					name = camel;
					name = name in cache ?
						[ name ] : ( name.match( rnotwhite ) || [] );
				}
			}

			i = name.length;

			while ( i-- ) {
				delete cache[ name[ i ] ];
			}
		}

		// Remove the expando if there's no more data
		if ( key === undefined || jQuery.isEmptyObject( cache ) ) {

			// Support: Chrome <= 35-45+
			// Webkit & Blink performance suffers when deleting properties
			// from DOM nodes, so set to undefined instead
			// https://code.google.com/p/chromium/issues/detail?id=378607
			if ( owner.nodeType ) {
				owner[ this.expando ] = undefined;
			} else {
				delete owner[ this.expando ];
			}
		}
	},
	hasData: function( owner ) {
		var cache = owner[ this.expando ];
		return cache !== undefined && !jQuery.isEmptyObject( cache );
	}
};
var dataPriv = new Data();

var dataUser = new Data();



//	Implementation Summary
//
//	1. Enforce API surface and semantic compatibility with 1.9.x branch
//	2. Improve the module's maintainability by reducing the storage
//		paths to a single mechanism.
//	3. Use the same single mechanism to support "private" and "user" data.
//	4. _Never_ expose "private" data to user code (TODO: Drop _data, _removeData)
//	5. Avoid exposing implementation details on user objects (eg. expando properties)
//	6. Provide a clear path for implementation upgrade to WeakMap in 2014

var rbrace = /^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,
	rmultiDash = /[A-Z]/g;

function dataAttr( elem, key, data ) {
	var name;

	// If nothing was found internally, try to fetch any
	// data from the HTML5 data-* attribute
	if ( data === undefined && elem.nodeType === 1 ) {
		name = "data-" + key.replace( rmultiDash, "-$&" ).toLowerCase();
		data = elem.getAttribute( name );

		if ( typeof data === "string" ) {
			try {
				data = data === "true" ? true :
					data === "false" ? false :
					data === "null" ? null :

					// Only convert to a number if it doesn't change the string
					+data + "" === data ? +data :
					rbrace.test( data ) ? jQuery.parseJSON( data ) :
					data;
			} catch ( e ) {}

			// Make sure we set the data so it isn't changed later
			dataUser.set( elem, key, data );
		} else {
			data = undefined;
		}
	}
	return data;
}

jQuery.extend( {
	hasData: function( elem ) {
		return dataUser.hasData( elem ) || dataPriv.hasData( elem );
	},

	data: function( elem, name, data ) {
		return dataUser.access( elem, name, data );
	},

	removeData: function( elem, name ) {
		dataUser.remove( elem, name );
	},

	// TODO: Now that all calls to _data and _removeData have been replaced
	// with direct calls to dataPriv methods, these can be deprecated.
	_data: function( elem, name, data ) {
		return dataPriv.access( elem, name, data );
	},

	_removeData: function( elem, name ) {
		dataPriv.remove( elem, name );
	}
} );

jQuery.fn.extend( {
	data: function( key, value ) {
		var i, name, data,
			elem = this[ 0 ],
			attrs = elem && elem.attributes;

		// Gets all values
		if ( key === undefined ) {
			if ( this.length ) {
				data = dataUser.get( elem );

				if ( elem.nodeType === 1 && !dataPriv.get( elem, "hasDataAttrs" ) ) {
					i = attrs.length;
					while ( i-- ) {

						// Support: IE11+
						// The attrs elements can be null (#14894)
						if ( attrs[ i ] ) {
							name = attrs[ i ].name;
							if ( name.indexOf( "data-" ) === 0 ) {
								name = jQuery.camelCase( name.slice( 5 ) );
								dataAttr( elem, name, data[ name ] );
							}
						}
					}
					dataPriv.set( elem, "hasDataAttrs", true );
				}
			}

			return data;
		}

		// Sets multiple values
		if ( typeof key === "object" ) {
			return this.each( function() {
				dataUser.set( this, key );
			} );
		}

		return access( this, function( value ) {
			var data, camelKey;

			// The calling jQuery object (element matches) is not empty
			// (and therefore has an element appears at this[ 0 ]) and the
			// `value` parameter was not undefined. An empty jQuery object
			// will result in `undefined` for elem = this[ 0 ] which will
			// throw an exception if an attempt to read a data cache is made.
			if ( elem && value === undefined ) {

				// Attempt to get data from the cache
				// with the key as-is
				data = dataUser.get( elem, key ) ||

					// Try to find dashed key if it exists (gh-2779)
					// This is for 2.2.x only
					dataUser.get( elem, key.replace( rmultiDash, "-$&" ).toLowerCase() );

				if ( data !== undefined ) {
					return data;
				}

				camelKey = jQuery.camelCase( key );

				// Attempt to get data from the cache
				// with the key camelized
				data = dataUser.get( elem, camelKey );
				if ( data !== undefined ) {
					return data;
				}

				// Attempt to "discover" the data in
				// HTML5 custom data-* attrs
				data = dataAttr( elem, camelKey, undefined );
				if ( data !== undefined ) {
					return data;
				}

				// We tried really hard, but the data doesn't exist.
				return;
			}

			// Set the data...
			camelKey = jQuery.camelCase( key );
			this.each( function() {

				// First, attempt to store a copy or reference of any
				// data that might've been store with a camelCased key.
				var data = dataUser.get( this, camelKey );

				// For HTML5 data-* attribute interop, we have to
				// store property names with dashes in a camelCase form.
				// This might not apply to all properties...*
				dataUser.set( this, camelKey, value );

				// *... In the case of properties that might _actually_
				// have dashes, we need to also store a copy of that
				// unchanged property.
				if ( key.indexOf( "-" ) > -1 && data !== undefined ) {
					dataUser.set( this, key, value );
				}
			} );
		}, null, value, arguments.length > 1, null, true );
	},

	removeData: function( key ) {
		return this.each( function() {
			dataUser.remove( this, key );
		} );
	}
} );


jQuery.extend( {
	queue: function( elem, type, data ) {
		var queue;

		if ( elem ) {
			type = ( type || "fx" ) + "queue";
			queue = dataPriv.get( elem, type );

			// Speed up dequeue by getting out quickly if this is just a lookup
			if ( data ) {
				if ( !queue || jQuery.isArray( data ) ) {
					queue = dataPriv.access( elem, type, jQuery.makeArray( data ) );
				} else {
					queue.push( data );
				}
			}
			return queue || [];
		}
	},

	dequeue: function( elem, type ) {
		type = type || "fx";

		var queue = jQuery.queue( elem, type ),
			startLength = queue.length,
			fn = queue.shift(),
			hooks = jQuery._queueHooks( elem, type ),
			next = function() {
				jQuery.dequeue( elem, type );
			};

		// If the fx queue is dequeued, always remove the progress sentinel
		if ( fn === "inprogress" ) {
			fn = queue.shift();
			startLength--;
		}

		if ( fn ) {

			// Add a progress sentinel to prevent the fx queue from being
			// automatically dequeued
			if ( type === "fx" ) {
				queue.unshift( "inprogress" );
			}

			// Clear up the last queue stop function
			delete hooks.stop;
			fn.call( elem, next, hooks );
		}

		if ( !startLength && hooks ) {
			hooks.empty.fire();
		}
	},

	// Not public - generate a queueHooks object, or return the current one
	_queueHooks: function( elem, type ) {
		var key = type + "queueHooks";
		return dataPriv.get( elem, key ) || dataPriv.access( elem, key, {
			empty: jQuery.Callbacks( "once memory" ).add( function() {
				dataPriv.remove( elem, [ type + "queue", key ] );
			} )
		} );
	}
} );

jQuery.fn.extend( {
	queue: function( type, data ) {
		var setter = 2;

		if ( typeof type !== "string" ) {
			data = type;
			type = "fx";
			setter--;
		}

		if ( arguments.length < setter ) {
			return jQuery.queue( this[ 0 ], type );
		}

		return data === undefined ?
			this :
			this.each( function() {
				var queue = jQuery.queue( this, type, data );

				// Ensure a hooks for this queue
				jQuery._queueHooks( this, type );

				if ( type === "fx" && queue[ 0 ] !== "inprogress" ) {
					jQuery.dequeue( this, type );
				}
			} );
	},
	dequeue: function( type ) {
		return this.each( function() {
			jQuery.dequeue( this, type );
		} );
	},
	clearQueue: function( type ) {
		return this.queue( type || "fx", [] );
	},

	// Get a promise resolved when queues of a certain type
	// are emptied (fx is the type by default)
	promise: function( type, obj ) {
		var tmp,
			count = 1,
			defer = jQuery.Deferred(),
			elements = this,
			i = this.length,
			resolve = function() {
				if ( !( --count ) ) {
					defer.resolveWith( elements, [ elements ] );
				}
			};

		if ( typeof type !== "string" ) {
			obj = type;
			type = undefined;
		}
		type = type || "fx";

		while ( i-- ) {
			tmp = dataPriv.get( elements[ i ], type + "queueHooks" );
			if ( tmp && tmp.empty ) {
				count++;
				tmp.empty.add( resolve );
			}
		}
		resolve();
		return defer.promise( obj );
	}
} );
var pnum = ( /[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/ ).source;

var rcssNum = new RegExp( "^(?:([+-])=|)(" + pnum + ")([a-z%]*)$", "i" );


var cssExpand = [ "Top", "Right", "Bottom", "Left" ];

var isHidden = function( elem, el ) {

		// isHidden might be called from jQuery#filter function;
		// in that case, element will be second argument
		elem = el || elem;
		return jQuery.css( elem, "display" ) === "none" ||
			!jQuery.contains( elem.ownerDocument, elem );
	};



function adjustCSS( elem, prop, valueParts, tween ) {
	var adjusted,
		scale = 1,
		maxIterations = 20,
		currentValue = tween ?
			function() { return tween.cur(); } :
			function() { return jQuery.css( elem, prop, "" ); },
		initial = currentValue(),
		unit = valueParts && valueParts[ 3 ] || ( jQuery.cssNumber[ prop ] ? "" : "px" ),

		// Starting value computation is required for potential unit mismatches
		initialInUnit = ( jQuery.cssNumber[ prop ] || unit !== "px" && +initial ) &&
			rcssNum.exec( jQuery.css( elem, prop ) );

	if ( initialInUnit && initialInUnit[ 3 ] !== unit ) {

		// Trust units reported by jQuery.css
		unit = unit || initialInUnit[ 3 ];

		// Make sure we update the tween properties later on
		valueParts = valueParts || [];

		// Iteratively approximate from a nonzero starting point
		initialInUnit = +initial || 1;

		do {

			// If previous iteration zeroed out, double until we get *something*.
			// Use string for doubling so we don't accidentally see scale as unchanged below
			scale = scale || ".5";

			// Adjust and apply
			initialInUnit = initialInUnit / scale;
			jQuery.style( elem, prop, initialInUnit + unit );

		// Update scale, tolerating zero or NaN from tween.cur()
		// Break the loop if scale is unchanged or perfect, or if we've just had enough.
		} while (
			scale !== ( scale = currentValue() / initial ) && scale !== 1 && --maxIterations
		);
	}

	if ( valueParts ) {
		initialInUnit = +initialInUnit || +initial || 0;

		// Apply relative offset (+=/-=) if specified
		adjusted = valueParts[ 1 ] ?
			initialInUnit + ( valueParts[ 1 ] + 1 ) * valueParts[ 2 ] :
			+valueParts[ 2 ];
		if ( tween ) {
			tween.unit = unit;
			tween.start = initialInUnit;
			tween.end = adjusted;
		}
	}
	return adjusted;
}
var rcheckableType = ( /^(?:checkbox|radio)$/i );

var rtagName = ( /<([\w:-]+)/ );

var rscriptType = ( /^$|\/(?:java|ecma)script/i );



// We have to close these tags to support XHTML (#13200)
var wrapMap = {

	// Support: IE9
	option: [ 1, "<select multiple='multiple'>", "</select>" ],

	// XHTML parsers do not magically insert elements in the
	// same way that tag soup parsers do. So we cannot shorten
	// this by omitting <tbody> or other required elements.
	thead: [ 1, "<table>", "</table>" ],
	col: [ 2, "<table><colgroup>", "</colgroup></table>" ],
	tr: [ 2, "<table><tbody>", "</tbody></table>" ],
	td: [ 3, "<table><tbody><tr>", "</tr></tbody></table>" ],

	_default: [ 0, "", "" ]
};

// Support: IE9
wrapMap.optgroup = wrapMap.option;

wrapMap.tbody = wrapMap.tfoot = wrapMap.colgroup = wrapMap.caption = wrapMap.thead;
wrapMap.th = wrapMap.td;


function getAll( context, tag ) {

	// Support: IE9-11+
	// Use typeof to avoid zero-argument method invocation on host objects (#15151)
	var ret = typeof context.getElementsByTagName !== "undefined" ?
			context.getElementsByTagName( tag || "*" ) :
			typeof context.querySelectorAll !== "undefined" ?
				context.querySelectorAll( tag || "*" ) :
			[];

	return tag === undefined || tag && jQuery.nodeName( context, tag ) ?
		jQuery.merge( [ context ], ret ) :
		ret;
}


// Mark scripts as having already been evaluated
function setGlobalEval( elems, refElements ) {
	var i = 0,
		l = elems.length;

	for ( ; i < l; i++ ) {
		dataPriv.set(
			elems[ i ],
			"globalEval",
			!refElements || dataPriv.get( refElements[ i ], "globalEval" )
		);
	}
}


var rhtml = /<|&#?\w+;/;

function buildFragment( elems, context, scripts, selection, ignored ) {
	var elem, tmp, tag, wrap, contains, j,
		fragment = context.createDocumentFragment(),
		nodes = [],
		i = 0,
		l = elems.length;

	for ( ; i < l; i++ ) {
		elem = elems[ i ];

		if ( elem || elem === 0 ) {

			// Add nodes directly
			if ( jQuery.type( elem ) === "object" ) {

				// Support: Android<4.1, PhantomJS<2
				// push.apply(_, arraylike) throws on ancient WebKit
				jQuery.merge( nodes, elem.nodeType ? [ elem ] : elem );

			// Convert non-html into a text node
			} else if ( !rhtml.test( elem ) ) {
				nodes.push( context.createTextNode( elem ) );

			// Convert html into DOM nodes
			} else {
				tmp = tmp || fragment.appendChild( context.createElement( "div" ) );

				// Deserialize a standard representation
				tag = ( rtagName.exec( elem ) || [ "", "" ] )[ 1 ].toLowerCase();
				wrap = wrapMap[ tag ] || wrapMap._default;
				tmp.innerHTML = wrap[ 1 ] + jQuery.htmlPrefilter( elem ) + wrap[ 2 ];

				// Descend through wrappers to the right content
				j = wrap[ 0 ];
				while ( j-- ) {
					tmp = tmp.lastChild;
				}

				// Support: Android<4.1, PhantomJS<2
				// push.apply(_, arraylike) throws on ancient WebKit
				jQuery.merge( nodes, tmp.childNodes );

				// Remember the top-level container
				tmp = fragment.firstChild;

				// Ensure the created nodes are orphaned (#12392)
				tmp.textContent = "";
			}
		}
	}

	// Remove wrapper from fragment
	fragment.textContent = "";

	i = 0;
	while ( ( elem = nodes[ i++ ] ) ) {

		// Skip elements already in the context collection (trac-4087)
		if ( selection && jQuery.inArray( elem, selection ) > -1 ) {
			if ( ignored ) {
				ignored.push( elem );
			}
			continue;
		}

		contains = jQuery.contains( elem.ownerDocument, elem );

		// Append to fragment
		tmp = getAll( fragment.appendChild( elem ), "script" );

		// Preserve script evaluation history
		if ( contains ) {
			setGlobalEval( tmp );
		}

		// Capture executables
		if ( scripts ) {
			j = 0;
			while ( ( elem = tmp[ j++ ] ) ) {
				if ( rscriptType.test( elem.type || "" ) ) {
					scripts.push( elem );
				}
			}
		}
	}

	return fragment;
}


( function() {
	var fragment = document.createDocumentFragment(),
		div = fragment.appendChild( document.createElement( "div" ) ),
		input = document.createElement( "input" );

	// Support: Android 4.0-4.3, Safari<=5.1
	// Check state lost if the name is set (#11217)
	// Support: Windows Web Apps (WWA)
	// `name` and `type` must use .setAttribute for WWA (#14901)
	input.setAttribute( "type", "radio" );
	input.setAttribute( "checked", "checked" );
	input.setAttribute( "name", "t" );

	div.appendChild( input );

	// Support: Safari<=5.1, Android<4.2
	// Older WebKit doesn't clone checked state correctly in fragments
	support.checkClone = div.cloneNode( true ).cloneNode( true ).lastChild.checked;

	// Support: IE<=11+
	// Make sure textarea (and checkbox) defaultValue is properly cloned
	div.innerHTML = "<textarea>x</textarea>";
	support.noCloneChecked = !!div.cloneNode( true ).lastChild.defaultValue;
} )();


var
	rkeyEvent = /^key/,
	rmouseEvent = /^(?:mouse|pointer|contextmenu|drag|drop)|click/,
	rtypenamespace = /^([^.]*)(?:\.(.+)|)/;

function returnTrue() {
	return true;
}

function returnFalse() {
	return false;
}

// Support: IE9
// See #13393 for more info
function safeActiveElement() {
	try {
		return document.activeElement;
	} catch ( err ) { }
}

function on( elem, types, selector, data, fn, one ) {
	var origFn, type;

	// Types can be a map of types/handlers
	if ( typeof types === "object" ) {

		// ( types-Object, selector, data )
		if ( typeof selector !== "string" ) {

			// ( types-Object, data )
			data = data || selector;
			selector = undefined;
		}
		for ( type in types ) {
			on( elem, type, selector, data, types[ type ], one );
		}
		return elem;
	}

	if ( data == null && fn == null ) {

		// ( types, fn )
		fn = selector;
		data = selector = undefined;
	} else if ( fn == null ) {
		if ( typeof selector === "string" ) {

			// ( types, selector, fn )
			fn = data;
			data = undefined;
		} else {

			// ( types, data, fn )
			fn = data;
			data = selector;
			selector = undefined;
		}
	}
	if ( fn === false ) {
		fn = returnFalse;
	} else if ( !fn ) {
		return elem;
	}

	if ( one === 1 ) {
		origFn = fn;
		fn = function( event ) {

			// Can use an empty set, since event contains the info
			jQuery().off( event );
			return origFn.apply( this, arguments );
		};

		// Use same guid so caller can remove using origFn
		fn.guid = origFn.guid || ( origFn.guid = jQuery.guid++ );
	}
	return elem.each( function() {
		jQuery.event.add( this, types, fn, data, selector );
	} );
}

/*
 * Helper functions for managing events -- not part of the public interface.
 * Props to Dean Edwards' addEvent library for many of the ideas.
 */
jQuery.event = {

	global: {},

	add: function( elem, types, handler, data, selector ) {

		var handleObjIn, eventHandle, tmp,
			events, t, handleObj,
			special, handlers, type, namespaces, origType,
			elemData = dataPriv.get( elem );

		// Don't attach events to noData or text/comment nodes (but allow plain objects)
		if ( !elemData ) {
			return;
		}

		// Caller can pass in an object of custom data in lieu of the handler
		if ( handler.handler ) {
			handleObjIn = handler;
			handler = handleObjIn.handler;
			selector = handleObjIn.selector;
		}

		// Make sure that the handler has a unique ID, used to find/remove it later
		if ( !handler.guid ) {
			handler.guid = jQuery.guid++;
		}

		// Init the element's event structure and main handler, if this is the first
		if ( !( events = elemData.events ) ) {
			events = elemData.events = {};
		}
		if ( !( eventHandle = elemData.handle ) ) {
			eventHandle = elemData.handle = function( e ) {

				// Discard the second event of a jQuery.event.trigger() and
				// when an event is called after a page has unloaded
				return typeof jQuery !== "undefined" && jQuery.event.triggered !== e.type ?
					jQuery.event.dispatch.apply( elem, arguments ) : undefined;
			};
		}

		// Handle multiple events separated by a space
		types = ( types || "" ).match( rnotwhite ) || [ "" ];
		t = types.length;
		while ( t-- ) {
			tmp = rtypenamespace.exec( types[ t ] ) || [];
			type = origType = tmp[ 1 ];
			namespaces = ( tmp[ 2 ] || "" ).split( "." ).sort();

			// There *must* be a type, no attaching namespace-only handlers
			if ( !type ) {
				continue;
			}

			// If event changes its type, use the special event handlers for the changed type
			special = jQuery.event.special[ type ] || {};

			// If selector defined, determine special event api type, otherwise given type
			type = ( selector ? special.delegateType : special.bindType ) || type;

			// Update special based on newly reset type
			special = jQuery.event.special[ type ] || {};

			// handleObj is passed to all event handlers
			handleObj = jQuery.extend( {
				type: type,
				origType: origType,
				data: data,
				handler: handler,
				guid: handler.guid,
				selector: selector,
				needsContext: selector && jQuery.expr.match.needsContext.test( selector ),
				namespace: namespaces.join( "." )
			}, handleObjIn );

			// Init the event handler queue if we're the first
			if ( !( handlers = events[ type ] ) ) {
				handlers = events[ type ] = [];
				handlers.delegateCount = 0;

				// Only use addEventListener if the special events handler returns false
				if ( !special.setup ||
					special.setup.call( elem, data, namespaces, eventHandle ) === false ) {

					if ( elem.addEventListener ) {
						elem.addEventListener( type, eventHandle );
					}
				}
			}

			if ( special.add ) {
				special.add.call( elem, handleObj );

				if ( !handleObj.handler.guid ) {
					handleObj.handler.guid = handler.guid;
				}
			}

			// Add to the element's handler list, delegates in front
			if ( selector ) {
				handlers.splice( handlers.delegateCount++, 0, handleObj );
			} else {
				handlers.push( handleObj );
			}

			// Keep track of which events have ever been used, for event optimization
			jQuery.event.global[ type ] = true;
		}

	},

	// Detach an event or set of events from an element
	remove: function( elem, types, handler, selector, mappedTypes ) {

		var j, origCount, tmp,
			events, t, handleObj,
			special, handlers, type, namespaces, origType,
			elemData = dataPriv.hasData( elem ) && dataPriv.get( elem );

		if ( !elemData || !( events = elemData.events ) ) {
			return;
		}

		// Once for each type.namespace in types; type may be omitted
		types = ( types || "" ).match( rnotwhite ) || [ "" ];
		t = types.length;
		while ( t-- ) {
			tmp = rtypenamespace.exec( types[ t ] ) || [];
			type = origType = tmp[ 1 ];
			namespaces = ( tmp[ 2 ] || "" ).split( "." ).sort();

			// Unbind all events (on this namespace, if provided) for the element
			if ( !type ) {
				for ( type in events ) {
					jQuery.event.remove( elem, type + types[ t ], handler, selector, true );
				}
				continue;
			}

			special = jQuery.event.special[ type ] || {};
			type = ( selector ? special.delegateType : special.bindType ) || type;
			handlers = events[ type ] || [];
			tmp = tmp[ 2 ] &&
				new RegExp( "(^|\\.)" + namespaces.join( "\\.(?:.*\\.|)" ) + "(\\.|$)" );

			// Remove matching events
			origCount = j = handlers.length;
			while ( j-- ) {
				handleObj = handlers[ j ];

				if ( ( mappedTypes || origType === handleObj.origType ) &&
					( !handler || handler.guid === handleObj.guid ) &&
					( !tmp || tmp.test( handleObj.namespace ) ) &&
					( !selector || selector === handleObj.selector ||
						selector === "**" && handleObj.selector ) ) {
					handlers.splice( j, 1 );

					if ( handleObj.selector ) {
						handlers.delegateCount--;
					}
					if ( special.remove ) {
						special.remove.call( elem, handleObj );
					}
				}
			}

			// Remove generic event handler if we removed something and no more handlers exist
			// (avoids potential for endless recursion during removal of special event handlers)
			if ( origCount && !handlers.length ) {
				if ( !special.teardown ||
					special.teardown.call( elem, namespaces, elemData.handle ) === false ) {

					jQuery.removeEvent( elem, type, elemData.handle );
				}

				delete events[ type ];
			}
		}

		// Remove data and the expando if it's no longer used
		if ( jQuery.isEmptyObject( events ) ) {
			dataPriv.remove( elem, "handle events" );
		}
	},

	dispatch: function( event ) {

		// Make a writable jQuery.Event from the native event object
		event = jQuery.event.fix( event );

		var i, j, ret, matched, handleObj,
			handlerQueue = [],
			args = slice.call( arguments ),
			handlers = ( dataPriv.get( this, "events" ) || {} )[ event.type ] || [],
			special = jQuery.event.special[ event.type ] || {};

		// Use the fix-ed jQuery.Event rather than the (read-only) native event
		args[ 0 ] = event;
		event.delegateTarget = this;

		// Call the preDispatch hook for the mapped type, and let it bail if desired
		if ( special.preDispatch && special.preDispatch.call( this, event ) === false ) {
			return;
		}

		// Determine handlers
		handlerQueue = jQuery.event.handlers.call( this, event, handlers );

		// Run delegates first; they may want to stop propagation beneath us
		i = 0;
		while ( ( matched = handlerQueue[ i++ ] ) && !event.isPropagationStopped() ) {
			event.currentTarget = matched.elem;

			j = 0;
			while ( ( handleObj = matched.handlers[ j++ ] ) &&
				!event.isImmediatePropagationStopped() ) {

				// Triggered event must either 1) have no namespace, or 2) have namespace(s)
				// a subset or equal to those in the bound event (both can have no namespace).
				if ( !event.rnamespace || event.rnamespace.test( handleObj.namespace ) ) {

					event.handleObj = handleObj;
					event.data = handleObj.data;

					ret = ( ( jQuery.event.special[ handleObj.origType ] || {} ).handle ||
						handleObj.handler ).apply( matched.elem, args );

					if ( ret !== undefined ) {
						if ( ( event.result = ret ) === false ) {
							event.preventDefault();
							event.stopPropagation();
						}
					}
				}
			}
		}

		// Call the postDispatch hook for the mapped type
		if ( special.postDispatch ) {
			special.postDispatch.call( this, event );
		}

		return event.result;
	},

	handlers: function( event, handlers ) {
		var i, matches, sel, handleObj,
			handlerQueue = [],
			delegateCount = handlers.delegateCount,
			cur = event.target;

		// Support (at least): Chrome, IE9
		// Find delegate handlers
		// Black-hole SVG <use> instance trees (#13180)
		//
		// Support: Firefox<=42+
		// Avoid non-left-click in FF but don't block IE radio events (#3861, gh-2343)
		if ( delegateCount && cur.nodeType &&
			( event.type !== "click" || isNaN( event.button ) || event.button < 1 ) ) {

			for ( ; cur !== this; cur = cur.parentNode || this ) {

				// Don't check non-elements (#13208)
				// Don't process clicks on disabled elements (#6911, #8165, #11382, #11764)
				if ( cur.nodeType === 1 && ( cur.disabled !== true || event.type !== "click" ) ) {
					matches = [];
					for ( i = 0; i < delegateCount; i++ ) {
						handleObj = handlers[ i ];

						// Don't conflict with Object.prototype properties (#13203)
						sel = handleObj.selector + " ";

						if ( matches[ sel ] === undefined ) {
							matches[ sel ] = handleObj.needsContext ?
								jQuery( sel, this ).index( cur ) > -1 :
								jQuery.find( sel, this, null, [ cur ] ).length;
						}
						if ( matches[ sel ] ) {
							matches.push( handleObj );
						}
					}
					if ( matches.length ) {
						handlerQueue.push( { elem: cur, handlers: matches } );
					}
				}
			}
		}

		// Add the remaining (directly-bound) handlers
		if ( delegateCount < handlers.length ) {
			handlerQueue.push( { elem: this, handlers: handlers.slice( delegateCount ) } );
		}

		return handlerQueue;
	},

	// Includes some event props shared by KeyEvent and MouseEvent
	props: ( "altKey bubbles cancelable ctrlKey currentTarget detail eventPhase " +
		"metaKey relatedTarget shiftKey target timeStamp view which" ).split( " " ),

	fixHooks: {},

	keyHooks: {
		props: "char charCode key keyCode".split( " " ),
		filter: function( event, original ) {

			// Add which for key events
			if ( event.which == null ) {
				event.which = original.charCode != null ? original.charCode : original.keyCode;
			}

			return event;
		}
	},

	mouseHooks: {
		props: ( "button buttons clientX clientY offsetX offsetY pageX pageY " +
			"screenX screenY toElement" ).split( " " ),
		filter: function( event, original ) {
			var eventDoc, doc, body,
				button = original.button;

			// Calculate pageX/Y if missing and clientX/Y available
			if ( event.pageX == null && original.clientX != null ) {
				eventDoc = event.target.ownerDocument || document;
				doc = eventDoc.documentElement;
				body = eventDoc.body;

				event.pageX = original.clientX +
					( doc && doc.scrollLeft || body && body.scrollLeft || 0 ) -
					( doc && doc.clientLeft || body && body.clientLeft || 0 );
				event.pageY = original.clientY +
					( doc && doc.scrollTop  || body && body.scrollTop  || 0 ) -
					( doc && doc.clientTop  || body && body.clientTop  || 0 );
			}

			// Add which for click: 1 === left; 2 === middle; 3 === right
			// Note: button is not normalized, so don't use it
			if ( !event.which && button !== undefined ) {
				event.which = ( button & 1 ? 1 : ( button & 2 ? 3 : ( button & 4 ? 2 : 0 ) ) );
			}

			return event;
		}
	},

	fix: function( event ) {
		if ( event[ jQuery.expando ] ) {
			return event;
		}

		// Create a writable copy of the event object and normalize some properties
		var i, prop, copy,
			type = event.type,
			originalEvent = event,
			fixHook = this.fixHooks[ type ];

		if ( !fixHook ) {
			this.fixHooks[ type ] = fixHook =
				rmouseEvent.test( type ) ? this.mouseHooks :
				rkeyEvent.test( type ) ? this.keyHooks :
				{};
		}
		copy = fixHook.props ? this.props.concat( fixHook.props ) : this.props;

		event = new jQuery.Event( originalEvent );

		i = copy.length;
		while ( i-- ) {
			prop = copy[ i ];
			event[ prop ] = originalEvent[ prop ];
		}

		// Support: Cordova 2.5 (WebKit) (#13255)
		// All events should have a target; Cordova deviceready doesn't
		if ( !event.target ) {
			event.target = document;
		}

		// Support: Safari 6.0+, Chrome<28
		// Target should not be a text node (#504, #13143)
		if ( event.target.nodeType === 3 ) {
			event.target = event.target.parentNode;
		}

		return fixHook.filter ? fixHook.filter( event, originalEvent ) : event;
	},

	special: {
		load: {

			// Prevent triggered image.load events from bubbling to window.load
			noBubble: true
		},
		focus: {

			// Fire native event if possible so blur/focus sequence is correct
			trigger: function() {
				if ( this !== safeActiveElement() && this.focus ) {
					this.focus();
					return false;
				}
			},
			delegateType: "focusin"
		},
		blur: {
			trigger: function() {
				if ( this === safeActiveElement() && this.blur ) {
					this.blur();
					return false;
				}
			},
			delegateType: "focusout"
		},
		click: {

			// For checkbox, fire native event so checked state will be right
			trigger: function() {
				if ( this.type === "checkbox" && this.click && jQuery.nodeName( this, "input" ) ) {
					this.click();
					return false;
				}
			},

			// For cross-browser consistency, don't fire native .click() on links
			_default: function( event ) {
				return jQuery.nodeName( event.target, "a" );
			}
		},

		beforeunload: {
			postDispatch: function( event ) {

				// Support: Firefox 20+
				// Firefox doesn't alert if the returnValue field is not set.
				if ( event.result !== undefined && event.originalEvent ) {
					event.originalEvent.returnValue = event.result;
				}
			}
		}
	}
};

jQuery.removeEvent = function( elem, type, handle ) {

	// This "if" is needed for plain objects
	if ( elem.removeEventListener ) {
		elem.removeEventListener( type, handle );
	}
};

jQuery.Event = function( src, props ) {

	// Allow instantiation without the 'new' keyword
	if ( !( this instanceof jQuery.Event ) ) {
		return new jQuery.Event( src, props );
	}

	// Event object
	if ( src && src.type ) {
		this.originalEvent = src;
		this.type = src.type;

		// Events bubbling up the document may have been marked as prevented
		// by a handler lower down the tree; reflect the correct value.
		this.isDefaultPrevented = src.defaultPrevented ||
				src.defaultPrevented === undefined &&

				// Support: Android<4.0
				src.returnValue === false ?
			returnTrue :
			returnFalse;

	// Event type
	} else {
		this.type = src;
	}

	// Put explicitly provided properties onto the event object
	if ( props ) {
		jQuery.extend( this, props );
	}

	// Create a timestamp if incoming event doesn't have one
	this.timeStamp = src && src.timeStamp || jQuery.now();

	// Mark it as fixed
	this[ jQuery.expando ] = true;
};

// jQuery.Event is based on DOM3 Events as specified by the ECMAScript Language Binding
// http://www.w3.org/TR/2003/WD-DOM-Level-3-Events-20030331/ecma-script-binding.html
jQuery.Event.prototype = {
	constructor: jQuery.Event,
	isDefaultPrevented: returnFalse,
	isPropagationStopped: returnFalse,
	isImmediatePropagationStopped: returnFalse,
	isSimulated: false,

	preventDefault: function() {
		var e = this.originalEvent;

		this.isDefaultPrevented = returnTrue;

		if ( e && !this.isSimulated ) {
			e.preventDefault();
		}
	},
	stopPropagation: function() {
		var e = this.originalEvent;

		this.isPropagationStopped = returnTrue;

		if ( e && !this.isSimulated ) {
			e.stopPropagation();
		}
	},
	stopImmediatePropagation: function() {
		var e = this.originalEvent;

		this.isImmediatePropagationStopped = returnTrue;

		if ( e && !this.isSimulated ) {
			e.stopImmediatePropagation();
		}

		this.stopPropagation();
	}
};

// Create mouseenter/leave events using mouseover/out and event-time checks
// so that event delegation works in jQuery.
// Do the same for pointerenter/pointerleave and pointerover/pointerout
//
// Support: Safari 7 only
// Safari sends mouseenter too often; see:
// https://code.google.com/p/chromium/issues/detail?id=470258
// for the description of the bug (it existed in older Chrome versions as well).
jQuery.each( {
	mouseenter: "mouseover",
	mouseleave: "mouseout",
	pointerenter: "pointerover",
	pointerleave: "pointerout"
}, function( orig, fix ) {
	jQuery.event.special[ orig ] = {
		delegateType: fix,
		bindType: fix,

		handle: function( event ) {
			var ret,
				target = this,
				related = event.relatedTarget,
				handleObj = event.handleObj;

			// For mouseenter/leave call the handler if related is outside the target.
			// NB: No relatedTarget if the mouse left/entered the browser window
			if ( !related || ( related !== target && !jQuery.contains( target, related ) ) ) {
				event.type = handleObj.origType;
				ret = handleObj.handler.apply( this, arguments );
				event.type = fix;
			}
			return ret;
		}
	};
} );

jQuery.fn.extend( {
	on: function( types, selector, data, fn ) {
		return on( this, types, selector, data, fn );
	},
	one: function( types, selector, data, fn ) {
		return on( this, types, selector, data, fn, 1 );
	},
	off: function( types, selector, fn ) {
		var handleObj, type;
		if ( types && types.preventDefault && types.handleObj ) {

			// ( event )  dispatched jQuery.Event
			handleObj = types.handleObj;
			jQuery( types.delegateTarget ).off(
				handleObj.namespace ?
					handleObj.origType + "." + handleObj.namespace :
					handleObj.origType,
				handleObj.selector,
				handleObj.handler
			);
			return this;
		}
		if ( typeof types === "object" ) {

			// ( types-object [, selector] )
			for ( type in types ) {
				this.off( type, selector, types[ type ] );
			}
			return this;
		}
		if ( selector === false || typeof selector === "function" ) {

			// ( types [, fn] )
			fn = selector;
			selector = undefined;
		}
		if ( fn === false ) {
			fn = returnFalse;
		}
		return this.each( function() {
			jQuery.event.remove( this, types, fn, selector );
		} );
	}
} );


var
	rxhtmlTag = /<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:-]+)[^>]*)\/>/gi,

	// Support: IE 10-11, Edge 10240+
	// In IE/Edge using regex groups here causes severe slowdowns.
	// See https://connect.microsoft.com/IE/feedback/details/1736512/
	rnoInnerhtml = /<script|<style|<link/i,

	// checked="checked" or checked
	rchecked = /checked\s*(?:[^=]|=\s*.checked.)/i,
	rscriptTypeMasked = /^true\/(.*)/,
	rcleanScript = /^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g;

// Manipulating tables requires a tbody
function manipulationTarget( elem, content ) {
	return jQuery.nodeName( elem, "table" ) &&
		jQuery.nodeName( content.nodeType !== 11 ? content : content.firstChild, "tr" ) ?

		elem.getElementsByTagName( "tbody" )[ 0 ] ||
			elem.appendChild( elem.ownerDocument.createElement( "tbody" ) ) :
		elem;
}

// Replace/restore the type attribute of script elements for safe DOM manipulation
function disableScript( elem ) {
	elem.type = ( elem.getAttribute( "type" ) !== null ) + "/" + elem.type;
	return elem;
}
function restoreScript( elem ) {
	var match = rscriptTypeMasked.exec( elem.type );

	if ( match ) {
		elem.type = match[ 1 ];
	} else {
		elem.removeAttribute( "type" );
	}

	return elem;
}

function cloneCopyEvent( src, dest ) {
	var i, l, type, pdataOld, pdataCur, udataOld, udataCur, events;

	if ( dest.nodeType !== 1 ) {
		return;
	}

	// 1. Copy private data: events, handlers, etc.
	if ( dataPriv.hasData( src ) ) {
		pdataOld = dataPriv.access( src );
		pdataCur = dataPriv.set( dest, pdataOld );
		events = pdataOld.events;

		if ( events ) {
			delete pdataCur.handle;
			pdataCur.events = {};

			for ( type in events ) {
				for ( i = 0, l = events[ type ].length; i < l; i++ ) {
					jQuery.event.add( dest, type, events[ type ][ i ] );
				}
			}
		}
	}

	// 2. Copy user data
	if ( dataUser.hasData( src ) ) {
		udataOld = dataUser.access( src );
		udataCur = jQuery.extend( {}, udataOld );

		dataUser.set( dest, udataCur );
	}
}

// Fix IE bugs, see support tests
function fixInput( src, dest ) {
	var nodeName = dest.nodeName.toLowerCase();

	// Fails to persist the checked state of a cloned checkbox or radio button.
	if ( nodeName === "input" && rcheckableType.test( src.type ) ) {
		dest.checked = src.checked;

	// Fails to return the selected option to the default selected state when cloning options
	} else if ( nodeName === "input" || nodeName === "textarea" ) {
		dest.defaultValue = src.defaultValue;
	}
}

function domManip( collection, args, callback, ignored ) {

	// Flatten any nested arrays
	args = concat.apply( [], args );

	var fragment, first, scripts, hasScripts, node, doc,
		i = 0,
		l = collection.length,
		iNoClone = l - 1,
		value = args[ 0 ],
		isFunction = jQuery.isFunction( value );

	// We can't cloneNode fragments that contain checked, in WebKit
	if ( isFunction ||
			( l > 1 && typeof value === "string" &&
				!support.checkClone && rchecked.test( value ) ) ) {
		return collection.each( function( index ) {
			var self = collection.eq( index );
			if ( isFunction ) {
				args[ 0 ] = value.call( this, index, self.html() );
			}
			domManip( self, args, callback, ignored );
		} );
	}

	if ( l ) {
		fragment = buildFragment( args, collection[ 0 ].ownerDocument, false, collection, ignored );
		first = fragment.firstChild;

		if ( fragment.childNodes.length === 1 ) {
			fragment = first;
		}

		// Require either new content or an interest in ignored elements to invoke the callback
		if ( first || ignored ) {
			scripts = jQuery.map( getAll( fragment, "script" ), disableScript );
			hasScripts = scripts.length;

			// Use the original fragment for the last item
			// instead of the first because it can end up
			// being emptied incorrectly in certain situations (#8070).
			for ( ; i < l; i++ ) {
				node = fragment;

				if ( i !== iNoClone ) {
					node = jQuery.clone( node, true, true );

					// Keep references to cloned scripts for later restoration
					if ( hasScripts ) {

						// Support: Android<4.1, PhantomJS<2
						// push.apply(_, arraylike) throws on ancient WebKit
						jQuery.merge( scripts, getAll( node, "script" ) );
					}
				}

				callback.call( collection[ i ], node, i );
			}

			if ( hasScripts ) {
				doc = scripts[ scripts.length - 1 ].ownerDocument;

				// Reenable scripts
				jQuery.map( scripts, restoreScript );

				// Evaluate executable scripts on first document insertion
				for ( i = 0; i < hasScripts; i++ ) {
					node = scripts[ i ];
					if ( rscriptType.test( node.type || "" ) &&
						!dataPriv.access( node, "globalEval" ) &&
						jQuery.contains( doc, node ) ) {

						if ( node.src ) {

							// Optional AJAX dependency, but won't run scripts if not present
							if ( jQuery._evalUrl ) {
								jQuery._evalUrl( node.src );
							}
						} else {
							jQuery.globalEval( node.textContent.replace( rcleanScript, "" ) );
						}
					}
				}
			}
		}
	}

	return collection;
}

function remove( elem, selector, keepData ) {
	var node,
		nodes = selector ? jQuery.filter( selector, elem ) : elem,
		i = 0;

	for ( ; ( node = nodes[ i ] ) != null; i++ ) {
		if ( !keepData && node.nodeType === 1 ) {
			jQuery.cleanData( getAll( node ) );
		}

		if ( node.parentNode ) {
			if ( keepData && jQuery.contains( node.ownerDocument, node ) ) {
				setGlobalEval( getAll( node, "script" ) );
			}
			node.parentNode.removeChild( node );
		}
	}

	return elem;
}

jQuery.extend( {
	htmlPrefilter: function( html ) {
		return html.replace( rxhtmlTag, "<$1></$2>" );
	},

	clone: function( elem, dataAndEvents, deepDataAndEvents ) {
		var i, l, srcElements, destElements,
			clone = elem.cloneNode( true ),
			inPage = jQuery.contains( elem.ownerDocument, elem );

		// Fix IE cloning issues
		if ( !support.noCloneChecked && ( elem.nodeType === 1 || elem.nodeType === 11 ) &&
				!jQuery.isXMLDoc( elem ) ) {

			// We eschew Sizzle here for performance reasons: http://jsperf.com/getall-vs-sizzle/2
			destElements = getAll( clone );
			srcElements = getAll( elem );

			for ( i = 0, l = srcElements.length; i < l; i++ ) {
				fixInput( srcElements[ i ], destElements[ i ] );
			}
		}

		// Copy the events from the original to the clone
		if ( dataAndEvents ) {
			if ( deepDataAndEvents ) {
				srcElements = srcElements || getAll( elem );
				destElements = destElements || getAll( clone );

				for ( i = 0, l = srcElements.length; i < l; i++ ) {
					cloneCopyEvent( srcElements[ i ], destElements[ i ] );
				}
			} else {
				cloneCopyEvent( elem, clone );
			}
		}

		// Preserve script evaluation history
		destElements = getAll( clone, "script" );
		if ( destElements.length > 0 ) {
			setGlobalEval( destElements, !inPage && getAll( elem, "script" ) );
		}

		// Return the cloned set
		return clone;
	},

	cleanData: function( elems ) {
		var data, elem, type,
			special = jQuery.event.special,
			i = 0;

		for ( ; ( elem = elems[ i ] ) !== undefined; i++ ) {
			if ( acceptData( elem ) ) {
				if ( ( data = elem[ dataPriv.expando ] ) ) {
					if ( data.events ) {
						for ( type in data.events ) {
							if ( special[ type ] ) {
								jQuery.event.remove( elem, type );

							// This is a shortcut to avoid jQuery.event.remove's overhead
							} else {
								jQuery.removeEvent( elem, type, data.handle );
							}
						}
					}

					// Support: Chrome <= 35-45+
					// Assign undefined instead of using delete, see Data#remove
					elem[ dataPriv.expando ] = undefined;
				}
				if ( elem[ dataUser.expando ] ) {

					// Support: Chrome <= 35-45+
					// Assign undefined instead of using delete, see Data#remove
					elem[ dataUser.expando ] = undefined;
				}
			}
		}
	}
} );

jQuery.fn.extend( {

	// Keep domManip exposed until 3.0 (gh-2225)
	domManip: domManip,

	detach: function( selector ) {
		return remove( this, selector, true );
	},

	remove: function( selector ) {
		return remove( this, selector );
	},

	text: function( value ) {
		return access( this, function( value ) {
			return value === undefined ?
				jQuery.text( this ) :
				this.empty().each( function() {
					if ( this.nodeType === 1 || this.nodeType === 11 || this.nodeType === 9 ) {
						this.textContent = value;
					}
				} );
		}, null, value, arguments.length );
	},

	append: function() {
		return domManip( this, arguments, function( elem ) {
			if ( this.nodeType === 1 || this.nodeType === 11 || this.nodeType === 9 ) {
				var target = manipulationTarget( this, elem );
				target.appendChild( elem );
			}
		} );
	},

	prepend: function() {
		return domManip( this, arguments, function( elem ) {
			if ( this.nodeType === 1 || this.nodeType === 11 || this.nodeType === 9 ) {
				var target = manipulationTarget( this, elem );
				target.insertBefore( elem, target.firstChild );
			}
		} );
	},

	before: function() {
		return domManip( this, arguments, function( elem ) {
			if ( this.parentNode ) {
				this.parentNode.insertBefore( elem, this );
			}
		} );
	},

	after: function() {
		return domManip( this, arguments, function( elem ) {
			if ( this.parentNode ) {
				this.parentNode.insertBefore( elem, this.nextSibling );
			}
		} );
	},

	empty: function() {
		var elem,
			i = 0;

		for ( ; ( elem = this[ i ] ) != null; i++ ) {
			if ( elem.nodeType === 1 ) {

				// Prevent memory leaks
				jQuery.cleanData( getAll( elem, false ) );

				// Remove any remaining nodes
				elem.textContent = "";
			}
		}

		return this;
	},

	clone: function( dataAndEvents, deepDataAndEvents ) {
		dataAndEvents = dataAndEvents == null ? false : dataAndEvents;
		deepDataAndEvents = deepDataAndEvents == null ? dataAndEvents : deepDataAndEvents;

		return this.map( function() {
			return jQuery.clone( this, dataAndEvents, deepDataAndEvents );
		} );
	},

	html: function( value ) {
		return access( this, function( value ) {
			var elem = this[ 0 ] || {},
				i = 0,
				l = this.length;

			if ( value === undefined && elem.nodeType === 1 ) {
				return elem.innerHTML;
			}

			// See if we can take a shortcut and just use innerHTML
			if ( typeof value === "string" && !rnoInnerhtml.test( value ) &&
				!wrapMap[ ( rtagName.exec( value ) || [ "", "" ] )[ 1 ].toLowerCase() ] ) {

				value = jQuery.htmlPrefilter( value );

				try {
					for ( ; i < l; i++ ) {
						elem = this[ i ] || {};

						// Remove element nodes and prevent memory leaks
						if ( elem.nodeType === 1 ) {
							jQuery.cleanData( getAll( elem, false ) );
							elem.innerHTML = value;
						}
					}

					elem = 0;

				// If using innerHTML throws an exception, use the fallback method
				} catch ( e ) {}
			}

			if ( elem ) {
				this.empty().append( value );
			}
		}, null, value, arguments.length );
	},

	replaceWith: function() {
		var ignored = [];

		// Make the changes, replacing each non-ignored context element with the new content
		return domManip( this, arguments, function( elem ) {
			var parent = this.parentNode;

			if ( jQuery.inArray( this, ignored ) < 0 ) {
				jQuery.cleanData( getAll( this ) );
				if ( parent ) {
					parent.replaceChild( elem, this );
				}
			}

		// Force callback invocation
		}, ignored );
	}
} );

jQuery.each( {
	appendTo: "append",
	prependTo: "prepend",
	insertBefore: "before",
	insertAfter: "after",
	replaceAll: "replaceWith"
}, function( name, original ) {
	jQuery.fn[ name ] = function( selector ) {
		var elems,
			ret = [],
			insert = jQuery( selector ),
			last = insert.length - 1,
			i = 0;

		for ( ; i <= last; i++ ) {
			elems = i === last ? this : this.clone( true );
			jQuery( insert[ i ] )[ original ]( elems );

			// Support: QtWebKit
			// .get() because push.apply(_, arraylike) throws
			push.apply( ret, elems.get() );
		}

		return this.pushStack( ret );
	};
} );


var iframe,
	elemdisplay = {

		// Support: Firefox
		// We have to pre-define these values for FF (#10227)
		HTML: "block",
		BODY: "block"
	};

/**
 * Retrieve the actual display of a element
 * @param {String} name nodeName of the element
 * @param {Object} doc Document object
 */

// Called only from within defaultDisplay
function actualDisplay( name, doc ) {
	var elem = jQuery( doc.createElement( name ) ).appendTo( doc.body ),

		display = jQuery.css( elem[ 0 ], "display" );

	// We don't have any data stored on the element,
	// so use "detach" method as fast way to get rid of the element
	elem.detach();

	return display;
}

/**
 * Try to determine the default display value of an element
 * @param {String} nodeName
 */
function defaultDisplay( nodeName ) {
	var doc = document,
		display = elemdisplay[ nodeName ];

	if ( !display ) {
		display = actualDisplay( nodeName, doc );

		// If the simple way fails, read from inside an iframe
		if ( display === "none" || !display ) {

			// Use the already-created iframe if possible
			iframe = ( iframe || jQuery( "<iframe frameborder='0' width='0' height='0'/>" ) )
				.appendTo( doc.documentElement );

			// Always write a new HTML skeleton so Webkit and Firefox don't choke on reuse
			doc = iframe[ 0 ].contentDocument;

			// Support: IE
			doc.write();
			doc.close();

			display = actualDisplay( nodeName, doc );
			iframe.detach();
		}

		// Store the correct default display
		elemdisplay[ nodeName ] = display;
	}

	return display;
}
var rmargin = ( /^margin/ );

var rnumnonpx = new RegExp( "^(" + pnum + ")(?!px)[a-z%]+$", "i" );

var getStyles = function( elem ) {

		// Support: IE<=11+, Firefox<=30+ (#15098, #14150)
		// IE throws on elements created in popups
		// FF meanwhile throws on frame elements through "defaultView.getComputedStyle"
		var view = elem.ownerDocument.defaultView;

		if ( !view || !view.opener ) {
			view = window;
		}

		return view.getComputedStyle( elem );
	};

var swap = function( elem, options, callback, args ) {
	var ret, name,
		old = {};

	// Remember the old values, and insert the new ones
	for ( name in options ) {
		old[ name ] = elem.style[ name ];
		elem.style[ name ] = options[ name ];
	}

	ret = callback.apply( elem, args || [] );

	// Revert the old values
	for ( name in options ) {
		elem.style[ name ] = old[ name ];
	}

	return ret;
};


var documentElement = document.documentElement;



( function() {
	var pixelPositionVal, boxSizingReliableVal, pixelMarginRightVal, reliableMarginLeftVal,
		container = document.createElement( "div" ),
		div = document.createElement( "div" );

	// Finish early in limited (non-browser) environments
	if ( !div.style ) {
		return;
	}

	// Support: IE9-11+
	// Style of cloned element affects source element cloned (#8908)
	div.style.backgroundClip = "content-box";
	div.cloneNode( true ).style.backgroundClip = "";
	support.clearCloneStyle = div.style.backgroundClip === "content-box";

	container.style.cssText = "border:0;width:8px;height:0;top:0;left:-9999px;" +
		"padding:0;margin-top:1px;position:absolute";
	container.appendChild( div );

	// Executing both pixelPosition & boxSizingReliable tests require only one layout
	// so they're executed at the same time to save the second computation.
	function computeStyleTests() {
		div.style.cssText =

			// Support: Firefox<29, Android 2.3
			// Vendor-prefix box-sizing
			"-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;" +
			"position:relative;display:block;" +
			"margin:auto;border:1px;padding:1px;" +
			"top:1%;width:50%";
		div.innerHTML = "";
		documentElement.appendChild( container );

		var divStyle = window.getComputedStyle( div );
		pixelPositionVal = divStyle.top !== "1%";
		reliableMarginLeftVal = divStyle.marginLeft === "2px";
		boxSizingReliableVal = divStyle.width === "4px";

		// Support: Android 4.0 - 4.3 only
		// Some styles come back with percentage values, even though they shouldn't
		div.style.marginRight = "50%";
		pixelMarginRightVal = divStyle.marginRight === "4px";

		documentElement.removeChild( container );
	}

	jQuery.extend( support, {
		pixelPosition: function() {

			// This test is executed only once but we still do memoizing
			// since we can use the boxSizingReliable pre-computing.
			// No need to check if the test was already performed, though.
			computeStyleTests();
			return pixelPositionVal;
		},
		boxSizingReliable: function() {
			if ( boxSizingReliableVal == null ) {
				computeStyleTests();
			}
			return boxSizingReliableVal;
		},
		pixelMarginRight: function() {

			// Support: Android 4.0-4.3
			// We're checking for boxSizingReliableVal here instead of pixelMarginRightVal
			// since that compresses better and they're computed together anyway.
			if ( boxSizingReliableVal == null ) {
				computeStyleTests();
			}
			return pixelMarginRightVal;
		},
		reliableMarginLeft: function() {

			// Support: IE <=8 only, Android 4.0 - 4.3 only, Firefox <=3 - 37
			if ( boxSizingReliableVal == null ) {
				computeStyleTests();
			}
			return reliableMarginLeftVal;
		},
		reliableMarginRight: function() {

			// Support: Android 2.3
			// Check if div with explicit width and no margin-right incorrectly
			// gets computed margin-right based on width of container. (#3333)
			// WebKit Bug 13343 - getComputedStyle returns wrong value for margin-right
			// This support function is only executed once so no memoizing is needed.
			var ret,
				marginDiv = div.appendChild( document.createElement( "div" ) );

			// Reset CSS: box-sizing; display; margin; border; padding
			marginDiv.style.cssText = div.style.cssText =

				// Support: Android 2.3
				// Vendor-prefix box-sizing
				"-webkit-box-sizing:content-box;box-sizing:content-box;" +
				"display:block;margin:0;border:0;padding:0";
			marginDiv.style.marginRight = marginDiv.style.width = "0";
			div.style.width = "1px";
			documentElement.appendChild( container );

			ret = !parseFloat( window.getComputedStyle( marginDiv ).marginRight );

			documentElement.removeChild( container );
			div.removeChild( marginDiv );

			return ret;
		}
	} );
} )();


function curCSS( elem, name, computed ) {
	var width, minWidth, maxWidth, ret,
		style = elem.style;

	computed = computed || getStyles( elem );
	ret = computed ? computed.getPropertyValue( name ) || computed[ name ] : undefined;

	// Support: Opera 12.1x only
	// Fall back to style even without computed
	// computed is undefined for elems on document fragments
	if ( ( ret === "" || ret === undefined ) && !jQuery.contains( elem.ownerDocument, elem ) ) {
		ret = jQuery.style( elem, name );
	}

	// Support: IE9
	// getPropertyValue is only needed for .css('filter') (#12537)
	if ( computed ) {

		// A tribute to the "awesome hack by Dean Edwards"
		// Android Browser returns percentage for some values,
		// but width seems to be reliably pixels.
		// This is against the CSSOM draft spec:
		// http://dev.w3.org/csswg/cssom/#resolved-values
		if ( !support.pixelMarginRight() && rnumnonpx.test( ret ) && rmargin.test( name ) ) {

			// Remember the original values
			width = style.width;
			minWidth = style.minWidth;
			maxWidth = style.maxWidth;

			// Put in the new values to get a computed value out
			style.minWidth = style.maxWidth = style.width = ret;
			ret = computed.width;

			// Revert the changed values
			style.width = width;
			style.minWidth = minWidth;
			style.maxWidth = maxWidth;
		}
	}

	return ret !== undefined ?

		// Support: IE9-11+
		// IE returns zIndex value as an integer.
		ret + "" :
		ret;
}


function addGetHookIf( conditionFn, hookFn ) {

	// Define the hook, we'll check on the first run if it's really needed.
	return {
		get: function() {
			if ( conditionFn() ) {

				// Hook not needed (or it's not possible to use it due
				// to missing dependency), remove it.
				delete this.get;
				return;
			}

			// Hook needed; redefine it so that the support test is not executed again.
			return ( this.get = hookFn ).apply( this, arguments );
		}
	};
}


var

	// Swappable if display is none or starts with table
	// except "table", "table-cell", or "table-caption"
	// See here for display values: https://developer.mozilla.org/en-US/docs/CSS/display
	rdisplayswap = /^(none|table(?!-c[ea]).+)/,

	cssShow = { position: "absolute", visibility: "hidden", display: "block" },
	cssNormalTransform = {
		letterSpacing: "0",
		fontWeight: "400"
	},

	cssPrefixes = [ "Webkit", "O", "Moz", "ms" ],
	emptyStyle = document.createElement( "div" ).style;

// Return a css property mapped to a potentially vendor prefixed property
function vendorPropName( name ) {

	// Shortcut for names that are not vendor prefixed
	if ( name in emptyStyle ) {
		return name;
	}

	// Check for vendor prefixed names
	var capName = name[ 0 ].toUpperCase() + name.slice( 1 ),
		i = cssPrefixes.length;

	while ( i-- ) {
		name = cssPrefixes[ i ] + capName;
		if ( name in emptyStyle ) {
			return name;
		}
	}
}

function setPositiveNumber( elem, value, subtract ) {

	// Any relative (+/-) values have already been
	// normalized at this point
	var matches = rcssNum.exec( value );
	return matches ?

		// Guard against undefined "subtract", e.g., when used as in cssHooks
		Math.max( 0, matches[ 2 ] - ( subtract || 0 ) ) + ( matches[ 3 ] || "px" ) :
		value;
}

function augmentWidthOrHeight( elem, name, extra, isBorderBox, styles ) {
	var i = extra === ( isBorderBox ? "border" : "content" ) ?

		// If we already have the right measurement, avoid augmentation
		4 :

		// Otherwise initialize for horizontal or vertical properties
		name === "width" ? 1 : 0,

		val = 0;

	for ( ; i < 4; i += 2 ) {

		// Both box models exclude margin, so add it if we want it
		if ( extra === "margin" ) {
			val += jQuery.css( elem, extra + cssExpand[ i ], true, styles );
		}

		if ( isBorderBox ) {

			// border-box includes padding, so remove it if we want content
			if ( extra === "content" ) {
				val -= jQuery.css( elem, "padding" + cssExpand[ i ], true, styles );
			}

			// At this point, extra isn't border nor margin, so remove border
			if ( extra !== "margin" ) {
				val -= jQuery.css( elem, "border" + cssExpand[ i ] + "Width", true, styles );
			}
		} else {

			// At this point, extra isn't content, so add padding
			val += jQuery.css( elem, "padding" + cssExpand[ i ], true, styles );

			// At this point, extra isn't content nor padding, so add border
			if ( extra !== "padding" ) {
				val += jQuery.css( elem, "border" + cssExpand[ i ] + "Width", true, styles );
			}
		}
	}

	return val;
}

function getWidthOrHeight( elem, name, extra ) {

	// Start with offset property, which is equivalent to the border-box value
	var valueIsBorderBox = true,
		val = name === "width" ? elem.offsetWidth : elem.offsetHeight,
		styles = getStyles( elem ),
		isBorderBox = jQuery.css( elem, "boxSizing", false, styles ) === "border-box";

	// Some non-html elements return undefined for offsetWidth, so check for null/undefined
	// svg - https://bugzilla.mozilla.org/show_bug.cgi?id=649285
	// MathML - https://bugzilla.mozilla.org/show_bug.cgi?id=491668
	if ( val <= 0 || val == null ) {

		// Fall back to computed then uncomputed css if necessary
		val = curCSS( elem, name, styles );
		if ( val < 0 || val == null ) {
			val = elem.style[ name ];
		}

		// Computed unit is not pixels. Stop here and return.
		if ( rnumnonpx.test( val ) ) {
			return val;
		}

		// Check for style in case a browser which returns unreliable values
		// for getComputedStyle silently falls back to the reliable elem.style
		valueIsBorderBox = isBorderBox &&
			( support.boxSizingReliable() || val === elem.style[ name ] );

		// Normalize "", auto, and prepare for extra
		val = parseFloat( val ) || 0;
	}

	// Use the active box-sizing model to add/subtract irrelevant styles
	return ( val +
		augmentWidthOrHeight(
			elem,
			name,
			extra || ( isBorderBox ? "border" : "content" ),
			valueIsBorderBox,
			styles
		)
	) + "px";
}

function showHide( elements, show ) {
	var display, elem, hidden,
		values = [],
		index = 0,
		length = elements.length;

	for ( ; index < length; index++ ) {
		elem = elements[ index ];
		if ( !elem.style ) {
			continue;
		}

		values[ index ] = dataPriv.get( elem, "olddisplay" );
		display = elem.style.display;
		if ( show ) {

			// Reset the inline display of this element to learn if it is
			// being hidden by cascaded rules or not
			if ( !values[ index ] && display === "none" ) {
				elem.style.display = "";
			}

			// Set elements which have been overridden with display: none
			// in a stylesheet to whatever the default browser style is
			// for such an element
			if ( elem.style.display === "" && isHidden( elem ) ) {
				values[ index ] = dataPriv.access(
					elem,
					"olddisplay",
					defaultDisplay( elem.nodeName )
				);
			}
		} else {
			hidden = isHidden( elem );

			if ( display !== "none" || !hidden ) {
				dataPriv.set(
					elem,
					"olddisplay",
					hidden ? display : jQuery.css( elem, "display" )
				);
			}
		}
	}

	// Set the display of most of the elements in a second loop
	// to avoid the constant reflow
	for ( index = 0; index < length; index++ ) {
		elem = elements[ index ];
		if ( !elem.style ) {
			continue;
		}
		if ( !show || elem.style.display === "none" || elem.style.display === "" ) {
			elem.style.display = show ? values[ index ] || "" : "none";
		}
	}

	return elements;
}

jQuery.extend( {

	// Add in style property hooks for overriding the default
	// behavior of getting and setting a style property
	cssHooks: {
		opacity: {
			get: function( elem, computed ) {
				if ( computed ) {

					// We should always get a number back from opacity
					var ret = curCSS( elem, "opacity" );
					return ret === "" ? "1" : ret;
				}
			}
		}
	},

	// Don't automatically add "px" to these possibly-unitless properties
	cssNumber: {
		"animationIterationCount": true,
		"columnCount": true,
		"fillOpacity": true,
		"flexGrow": true,
		"flexShrink": true,
		"fontWeight": true,
		"lineHeight": true,
		"opacity": true,
		"order": true,
		"orphans": true,
		"widows": true,
		"zIndex": true,
		"zoom": true
	},

	// Add in properties whose names you wish to fix before
	// setting or getting the value
	cssProps: {
		"float": "cssFloat"
	},

	// Get and set the style property on a DOM Node
	style: function( elem, name, value, extra ) {

		// Don't set styles on text and comment nodes
		if ( !elem || elem.nodeType === 3 || elem.nodeType === 8 || !elem.style ) {
			return;
		}

		// Make sure that we're working with the right name
		var ret, type, hooks,
			origName = jQuery.camelCase( name ),
			style = elem.style;

		name = jQuery.cssProps[ origName ] ||
			( jQuery.cssProps[ origName ] = vendorPropName( origName ) || origName );

		// Gets hook for the prefixed version, then unprefixed version
		hooks = jQuery.cssHooks[ name ] || jQuery.cssHooks[ origName ];

		// Check if we're setting a value
		if ( value !== undefined ) {
			type = typeof value;

			// Convert "+=" or "-=" to relative numbers (#7345)
			if ( type === "string" && ( ret = rcssNum.exec( value ) ) && ret[ 1 ] ) {
				value = adjustCSS( elem, name, ret );

				// Fixes bug #9237
				type = "number";
			}

			// Make sure that null and NaN values aren't set (#7116)
			if ( value == null || value !== value ) {
				return;
			}

			// If a number was passed in, add the unit (except for certain CSS properties)
			if ( type === "number" ) {
				value += ret && ret[ 3 ] || ( jQuery.cssNumber[ origName ] ? "" : "px" );
			}

			// Support: IE9-11+
			// background-* props affect original clone's values
			if ( !support.clearCloneStyle && value === "" && name.indexOf( "background" ) === 0 ) {
				style[ name ] = "inherit";
			}

			// If a hook was provided, use that value, otherwise just set the specified value
			if ( !hooks || !( "set" in hooks ) ||
				( value = hooks.set( elem, value, extra ) ) !== undefined ) {

				style[ name ] = value;
			}

		} else {

			// If a hook was provided get the non-computed value from there
			if ( hooks && "get" in hooks &&
				( ret = hooks.get( elem, false, extra ) ) !== undefined ) {

				return ret;
			}

			// Otherwise just get the value from the style object
			return style[ name ];
		}
	},

	css: function( elem, name, extra, styles ) {
		var val, num, hooks,
			origName = jQuery.camelCase( name );

		// Make sure that we're working with the right name
		name = jQuery.cssProps[ origName ] ||
			( jQuery.cssProps[ origName ] = vendorPropName( origName ) || origName );

		// Try prefixed name followed by the unprefixed name
		hooks = jQuery.cssHooks[ name ] || jQuery.cssHooks[ origName ];

		// If a hook was provided get the computed value from there
		if ( hooks && "get" in hooks ) {
			val = hooks.get( elem, true, extra );
		}

		// Otherwise, if a way to get the computed value exists, use that
		if ( val === undefined ) {
			val = curCSS( elem, name, styles );
		}

		// Convert "normal" to computed value
		if ( val === "normal" && name in cssNormalTransform ) {
			val = cssNormalTransform[ name ];
		}

		// Make numeric if forced or a qualifier was provided and val looks numeric
		if ( extra === "" || extra ) {
			num = parseFloat( val );
			return extra === true || isFinite( num ) ? num || 0 : val;
		}
		return val;
	}
} );

jQuery.each( [ "height", "width" ], function( i, name ) {
	jQuery.cssHooks[ name ] = {
		get: function( elem, computed, extra ) {
			if ( computed ) {

				// Certain elements can have dimension info if we invisibly show them
				// but it must have a current display style that would benefit
				return rdisplayswap.test( jQuery.css( elem, "display" ) ) &&
					elem.offsetWidth === 0 ?
						swap( elem, cssShow, function() {
							return getWidthOrHeight( elem, name, extra );
						} ) :
						getWidthOrHeight( elem, name, extra );
			}
		},

		set: function( elem, value, extra ) {
			var matches,
				styles = extra && getStyles( elem ),
				subtract = extra && augmentWidthOrHeight(
					elem,
					name,
					extra,
					jQuery.css( elem, "boxSizing", false, styles ) === "border-box",
					styles
				);

			// Convert to pixels if value adjustment is needed
			if ( subtract && ( matches = rcssNum.exec( value ) ) &&
				( matches[ 3 ] || "px" ) !== "px" ) {

				elem.style[ name ] = value;
				value = jQuery.css( elem, name );
			}

			return setPositiveNumber( elem, value, subtract );
		}
	};
} );

jQuery.cssHooks.marginLeft = addGetHookIf( support.reliableMarginLeft,
	function( elem, computed ) {
		if ( computed ) {
			return ( parseFloat( curCSS( elem, "marginLeft" ) ) ||
				elem.getBoundingClientRect().left -
					swap( elem, { marginLeft: 0 }, function() {
						return elem.getBoundingClientRect().left;
					} )
				) + "px";
		}
	}
);

// Support: Android 2.3
jQuery.cssHooks.marginRight = addGetHookIf( support.reliableMarginRight,
	function( elem, computed ) {
		if ( computed ) {
			return swap( elem, { "display": "inline-block" },
				curCSS, [ elem, "marginRight" ] );
		}
	}
);

// These hooks are used by animate to expand properties
jQuery.each( {
	margin: "",
	padding: "",
	border: "Width"
}, function( prefix, suffix ) {
	jQuery.cssHooks[ prefix + suffix ] = {
		expand: function( value ) {
			var i = 0,
				expanded = {},

				// Assumes a single number if not a string
				parts = typeof value === "string" ? value.split( " " ) : [ value ];

			for ( ; i < 4; i++ ) {
				expanded[ prefix + cssExpand[ i ] + suffix ] =
					parts[ i ] || parts[ i - 2 ] || parts[ 0 ];
			}

			return expanded;
		}
	};

	if ( !rmargin.test( prefix ) ) {
		jQuery.cssHooks[ prefix + suffix ].set = setPositiveNumber;
	}
} );

jQuery.fn.extend( {
	css: function( name, value ) {
		return access( this, function( elem, name, value ) {
			var styles, len,
				map = {},
				i = 0;

			if ( jQuery.isArray( name ) ) {
				styles = getStyles( elem );
				len = name.length;

				for ( ; i < len; i++ ) {
					map[ name[ i ] ] = jQuery.css( elem, name[ i ], false, styles );
				}

				return map;
			}

			return value !== undefined ?
				jQuery.style( elem, name, value ) :
				jQuery.css( elem, name );
		}, name, value, arguments.length > 1 );
	},
	show: function() {
		return showHide( this, true );
	},
	hide: function() {
		return showHide( this );
	},
	toggle: function( state ) {
		if ( typeof state === "boolean" ) {
			return state ? this.show() : this.hide();
		}

		return this.each( function() {
			if ( isHidden( this ) ) {
				jQuery( this ).show();
			} else {
				jQuery( this ).hide();
			}
		} );
	}
} );


function Tween( elem, options, prop, end, easing ) {
	return new Tween.prototype.init( elem, options, prop, end, easing );
}
jQuery.Tween = Tween;

Tween.prototype = {
	constructor: Tween,
	init: function( elem, options, prop, end, easing, unit ) {
		this.elem = elem;
		this.prop = prop;
		this.easing = easing || jQuery.easing._default;
		this.options = options;
		this.start = this.now = this.cur();
		this.end = end;
		this.unit = unit || ( jQuery.cssNumber[ prop ] ? "" : "px" );
	},
	cur: function() {
		var hooks = Tween.propHooks[ this.prop ];

		return hooks && hooks.get ?
			hooks.get( this ) :
			Tween.propHooks._default.get( this );
	},
	run: function( percent ) {
		var eased,
			hooks = Tween.propHooks[ this.prop ];

		if ( this.options.duration ) {
			this.pos = eased = jQuery.easing[ this.easing ](
				percent, this.options.duration * percent, 0, 1, this.options.duration
			);
		} else {
			this.pos = eased = percent;
		}
		this.now = ( this.end - this.start ) * eased + this.start;

		if ( this.options.step ) {
			this.options.step.call( this.elem, this.now, this );
		}

		if ( hooks && hooks.set ) {
			hooks.set( this );
		} else {
			Tween.propHooks._default.set( this );
		}
		return this;
	}
};

Tween.prototype.init.prototype = Tween.prototype;

Tween.propHooks = {
	_default: {
		get: function( tween ) {
			var result;

			// Use a property on the element directly when it is not a DOM element,
			// or when there is no matching style property that exists.
			if ( tween.elem.nodeType !== 1 ||
				tween.elem[ tween.prop ] != null && tween.elem.style[ tween.prop ] == null ) {
				return tween.elem[ tween.prop ];
			}

			// Passing an empty string as a 3rd parameter to .css will automatically
			// attempt a parseFloat and fallback to a string if the parse fails.
			// Simple values such as "10px" are parsed to Float;
			// complex values such as "rotate(1rad)" are returned as-is.
			result = jQuery.css( tween.elem, tween.prop, "" );

			// Empty strings, null, undefined and "auto" are converted to 0.
			return !result || result === "auto" ? 0 : result;
		},
		set: function( tween ) {

			// Use step hook for back compat.
			// Use cssHook if its there.
			// Use .style if available and use plain properties where available.
			if ( jQuery.fx.step[ tween.prop ] ) {
				jQuery.fx.step[ tween.prop ]( tween );
			} else if ( tween.elem.nodeType === 1 &&
				( tween.elem.style[ jQuery.cssProps[ tween.prop ] ] != null ||
					jQuery.cssHooks[ tween.prop ] ) ) {
				jQuery.style( tween.elem, tween.prop, tween.now + tween.unit );
			} else {
				tween.elem[ tween.prop ] = tween.now;
			}
		}
	}
};

// Support: IE9
// Panic based approach to setting things on disconnected nodes
Tween.propHooks.scrollTop = Tween.propHooks.scrollLeft = {
	set: function( tween ) {
		if ( tween.elem.nodeType && tween.elem.parentNode ) {
			tween.elem[ tween.prop ] = tween.now;
		}
	}
};

jQuery.easing = {
	linear: function( p ) {
		return p;
	},
	swing: function( p ) {
		return 0.5 - Math.cos( p * Math.PI ) / 2;
	},
	_default: "swing"
};

jQuery.fx = Tween.prototype.init;

// Back Compat <1.8 extension point
jQuery.fx.step = {};




var
	fxNow, timerId,
	rfxtypes = /^(?:toggle|show|hide)$/,
	rrun = /queueHooks$/;

// Animations created synchronously will run synchronously
function createFxNow() {
	window.setTimeout( function() {
		fxNow = undefined;
	} );
	return ( fxNow = jQuery.now() );
}

// Generate parameters to create a standard animation
function genFx( type, includeWidth ) {
	var which,
		i = 0,
		attrs = { height: type };

	// If we include width, step value is 1 to do all cssExpand values,
	// otherwise step value is 2 to skip over Left and Right
	includeWidth = includeWidth ? 1 : 0;
	for ( ; i < 4 ; i += 2 - includeWidth ) {
		which = cssExpand[ i ];
		attrs[ "margin" + which ] = attrs[ "padding" + which ] = type;
	}

	if ( includeWidth ) {
		attrs.opacity = attrs.width = type;
	}

	return attrs;
}

function createTween( value, prop, animation ) {
	var tween,
		collection = ( Animation.tweeners[ prop ] || [] ).concat( Animation.tweeners[ "*" ] ),
		index = 0,
		length = collection.length;
	for ( ; index < length; index++ ) {
		if ( ( tween = collection[ index ].call( animation, prop, value ) ) ) {

			// We're done with this property
			return tween;
		}
	}
}

function defaultPrefilter( elem, props, opts ) {
	/* jshint validthis: true */
	var prop, value, toggle, tween, hooks, oldfire, display, checkDisplay,
		anim = this,
		orig = {},
		style = elem.style,
		hidden = elem.nodeType && isHidden( elem ),
		dataShow = dataPriv.get( elem, "fxshow" );

	// Handle queue: false promises
	if ( !opts.queue ) {
		hooks = jQuery._queueHooks( elem, "fx" );
		if ( hooks.unqueued == null ) {
			hooks.unqueued = 0;
			oldfire = hooks.empty.fire;
			hooks.empty.fire = function() {
				if ( !hooks.unqueued ) {
					oldfire();
				}
			};
		}
		hooks.unqueued++;

		anim.always( function() {

			// Ensure the complete handler is called before this completes
			anim.always( function() {
				hooks.unqueued--;
				if ( !jQuery.queue( elem, "fx" ).length ) {
					hooks.empty.fire();
				}
			} );
		} );
	}

	// Height/width overflow pass
	if ( elem.nodeType === 1 && ( "height" in props || "width" in props ) ) {

		// Make sure that nothing sneaks out
		// Record all 3 overflow attributes because IE9-10 do not
		// change the overflow attribute when overflowX and
		// overflowY are set to the same value
		opts.overflow = [ style.overflow, style.overflowX, style.overflowY ];

		// Set display property to inline-block for height/width
		// animations on inline elements that are having width/height animated
		display = jQuery.css( elem, "display" );

		// Test default display if display is currently "none"
		checkDisplay = display === "none" ?
			dataPriv.get( elem, "olddisplay" ) || defaultDisplay( elem.nodeName ) : display;

		if ( checkDisplay === "inline" && jQuery.css( elem, "float" ) === "none" ) {
			style.display = "inline-block";
		}
	}

	if ( opts.overflow ) {
		style.overflow = "hidden";
		anim.always( function() {
			style.overflow = opts.overflow[ 0 ];
			style.overflowX = opts.overflow[ 1 ];
			style.overflowY = opts.overflow[ 2 ];
		} );
	}

	// show/hide pass
	for ( prop in props ) {
		value = props[ prop ];
		if ( rfxtypes.exec( value ) ) {
			delete props[ prop ];
			toggle = toggle || value === "toggle";
			if ( value === ( hidden ? "hide" : "show" ) ) {

				// If there is dataShow left over from a stopped hide or show
				// and we are going to proceed with show, we should pretend to be hidden
				if ( value === "show" && dataShow && dataShow[ prop ] !== undefined ) {
					hidden = true;
				} else {
					continue;
				}
			}
			orig[ prop ] = dataShow && dataShow[ prop ] || jQuery.style( elem, prop );

		// Any non-fx value stops us from restoring the original display value
		} else {
			display = undefined;
		}
	}

	if ( !jQuery.isEmptyObject( orig ) ) {
		if ( dataShow ) {
			if ( "hidden" in dataShow ) {
				hidden = dataShow.hidden;
			}
		} else {
			dataShow = dataPriv.access( elem, "fxshow", {} );
		}

		// Store state if its toggle - enables .stop().toggle() to "reverse"
		if ( toggle ) {
			dataShow.hidden = !hidden;
		}
		if ( hidden ) {
			jQuery( elem ).show();
		} else {
			anim.done( function() {
				jQuery( elem ).hide();
			} );
		}
		anim.done( function() {
			var prop;

			dataPriv.remove( elem, "fxshow" );
			for ( prop in orig ) {
				jQuery.style( elem, prop, orig[ prop ] );
			}
		} );
		for ( prop in orig ) {
			tween = createTween( hidden ? dataShow[ prop ] : 0, prop, anim );

			if ( !( prop in dataShow ) ) {
				dataShow[ prop ] = tween.start;
				if ( hidden ) {
					tween.end = tween.start;
					tween.start = prop === "width" || prop === "height" ? 1 : 0;
				}
			}
		}

	// If this is a noop like .hide().hide(), restore an overwritten display value
	} else if ( ( display === "none" ? defaultDisplay( elem.nodeName ) : display ) === "inline" ) {
		style.display = display;
	}
}

function propFilter( props, specialEasing ) {
	var index, name, easing, value, hooks;

	// camelCase, specialEasing and expand cssHook pass
	for ( index in props ) {
		name = jQuery.camelCase( index );
		easing = specialEasing[ name ];
		value = props[ index ];
		if ( jQuery.isArray( value ) ) {
			easing = value[ 1 ];
			value = props[ index ] = value[ 0 ];
		}

		if ( index !== name ) {
			props[ name ] = value;
			delete props[ index ];
		}

		hooks = jQuery.cssHooks[ name ];
		if ( hooks && "expand" in hooks ) {
			value = hooks.expand( value );
			delete props[ name ];

			// Not quite $.extend, this won't overwrite existing keys.
			// Reusing 'index' because we have the correct "name"
			for ( index in value ) {
				if ( !( index in props ) ) {
					props[ index ] = value[ index ];
					specialEasing[ index ] = easing;
				}
			}
		} else {
			specialEasing[ name ] = easing;
		}
	}
}

function Animation( elem, properties, options ) {
	var result,
		stopped,
		index = 0,
		length = Animation.prefilters.length,
		deferred = jQuery.Deferred().always( function() {

			// Don't match elem in the :animated selector
			delete tick.elem;
		} ),
		tick = function() {
			if ( stopped ) {
				return false;
			}
			var currentTime = fxNow || createFxNow(),
				remaining = Math.max( 0, animation.startTime + animation.duration - currentTime ),

				// Support: Android 2.3
				// Archaic crash bug won't allow us to use `1 - ( 0.5 || 0 )` (#12497)
				temp = remaining / animation.duration || 0,
				percent = 1 - temp,
				index = 0,
				length = animation.tweens.length;

			for ( ; index < length ; index++ ) {
				animation.tweens[ index ].run( percent );
			}

			deferred.notifyWith( elem, [ animation, percent, remaining ] );

			if ( percent < 1 && length ) {
				return remaining;
			} else {
				deferred.resolveWith( elem, [ animation ] );
				return false;
			}
		},
		animation = deferred.promise( {
			elem: elem,
			props: jQuery.extend( {}, properties ),
			opts: jQuery.extend( true, {
				specialEasing: {},
				easing: jQuery.easing._default
			}, options ),
			originalProperties: properties,
			originalOptions: options,
			startTime: fxNow || createFxNow(),
			duration: options.duration,
			tweens: [],
			createTween: function( prop, end ) {
				var tween = jQuery.Tween( elem, animation.opts, prop, end,
						animation.opts.specialEasing[ prop ] || animation.opts.easing );
				animation.tweens.push( tween );
				return tween;
			},
			stop: function( gotoEnd ) {
				var index = 0,

					// If we are going to the end, we want to run all the tweens
					// otherwise we skip this part
					length = gotoEnd ? animation.tweens.length : 0;
				if ( stopped ) {
					return this;
				}
				stopped = true;
				for ( ; index < length ; index++ ) {
					animation.tweens[ index ].run( 1 );
				}

				// Resolve when we played the last frame; otherwise, reject
				if ( gotoEnd ) {
					deferred.notifyWith( elem, [ animation, 1, 0 ] );
					deferred.resolveWith( elem, [ animation, gotoEnd ] );
				} else {
					deferred.rejectWith( elem, [ animation, gotoEnd ] );
				}
				return this;
			}
		} ),
		props = animation.props;

	propFilter( props, animation.opts.specialEasing );

	for ( ; index < length ; index++ ) {
		result = Animation.prefilters[ index ].call( animation, elem, props, animation.opts );
		if ( result ) {
			if ( jQuery.isFunction( result.stop ) ) {
				jQuery._queueHooks( animation.elem, animation.opts.queue ).stop =
					jQuery.proxy( result.stop, result );
			}
			return result;
		}
	}

	jQuery.map( props, createTween, animation );

	if ( jQuery.isFunction( animation.opts.start ) ) {
		animation.opts.start.call( elem, animation );
	}

	jQuery.fx.timer(
		jQuery.extend( tick, {
			elem: elem,
			anim: animation,
			queue: animation.opts.queue
		} )
	);

	// attach callbacks from options
	return animation.progress( animation.opts.progress )
		.done( animation.opts.done, animation.opts.complete )
		.fail( animation.opts.fail )
		.always( animation.opts.always );
}

jQuery.Animation = jQuery.extend( Animation, {
	tweeners: {
		"*": [ function( prop, value ) {
			var tween = this.createTween( prop, value );
			adjustCSS( tween.elem, prop, rcssNum.exec( value ), tween );
			return tween;
		} ]
	},

	tweener: function( props, callback ) {
		if ( jQuery.isFunction( props ) ) {
			callback = props;
			props = [ "*" ];
		} else {
			props = props.match( rnotwhite );
		}

		var prop,
			index = 0,
			length = props.length;

		for ( ; index < length ; index++ ) {
			prop = props[ index ];
			Animation.tweeners[ prop ] = Animation.tweeners[ prop ] || [];
			Animation.tweeners[ prop ].unshift( callback );
		}
	},

	prefilters: [ defaultPrefilter ],

	prefilter: function( callback, prepend ) {
		if ( prepend ) {
			Animation.prefilters.unshift( callback );
		} else {
			Animation.prefilters.push( callback );
		}
	}
} );

jQuery.speed = function( speed, easing, fn ) {
	var opt = speed && typeof speed === "object" ? jQuery.extend( {}, speed ) : {
		complete: fn || !fn && easing ||
			jQuery.isFunction( speed ) && speed,
		duration: speed,
		easing: fn && easing || easing && !jQuery.isFunction( easing ) && easing
	};

	opt.duration = jQuery.fx.off ? 0 : typeof opt.duration === "number" ?
		opt.duration : opt.duration in jQuery.fx.speeds ?
			jQuery.fx.speeds[ opt.duration ] : jQuery.fx.speeds._default;

	// Normalize opt.queue - true/undefined/null -> "fx"
	if ( opt.queue == null || opt.queue === true ) {
		opt.queue = "fx";
	}

	// Queueing
	opt.old = opt.complete;

	opt.complete = function() {
		if ( jQuery.isFunction( opt.old ) ) {
			opt.old.call( this );
		}

		if ( opt.queue ) {
			jQuery.dequeue( this, opt.queue );
		}
	};

	return opt;
};

jQuery.fn.extend( {
	fadeTo: function( speed, to, easing, callback ) {

		// Show any hidden elements after setting opacity to 0
		return this.filter( isHidden ).css( "opacity", 0 ).show()

			// Animate to the value specified
			.end().animate( { opacity: to }, speed, easing, callback );
	},
	animate: function( prop, speed, easing, callback ) {
		var empty = jQuery.isEmptyObject( prop ),
			optall = jQuery.speed( speed, easing, callback ),
			doAnimation = function() {

				// Operate on a copy of prop so per-property easing won't be lost
				var anim = Animation( this, jQuery.extend( {}, prop ), optall );

				// Empty animations, or finishing resolves immediately
				if ( empty || dataPriv.get( this, "finish" ) ) {
					anim.stop( true );
				}
			};
			doAnimation.finish = doAnimation;

		return empty || optall.queue === false ?
			this.each( doAnimation ) :
			this.queue( optall.queue, doAnimation );
	},
	stop: function( type, clearQueue, gotoEnd ) {
		var stopQueue = function( hooks ) {
			var stop = hooks.stop;
			delete hooks.stop;
			stop( gotoEnd );
		};

		if ( typeof type !== "string" ) {
			gotoEnd = clearQueue;
			clearQueue = type;
			type = undefined;
		}
		if ( clearQueue && type !== false ) {
			this.queue( type || "fx", [] );
		}

		return this.each( function() {
			var dequeue = true,
				index = type != null && type + "queueHooks",
				timers = jQuery.timers,
				data = dataPriv.get( this );

			if ( index ) {
				if ( data[ index ] && data[ index ].stop ) {
					stopQueue( data[ index ] );
				}
			} else {
				for ( index in data ) {
					if ( data[ index ] && data[ index ].stop && rrun.test( index ) ) {
						stopQueue( data[ index ] );
					}
				}
			}

			for ( index = timers.length; index--; ) {
				if ( timers[ index ].elem === this &&
					( type == null || timers[ index ].queue === type ) ) {

					timers[ index ].anim.stop( gotoEnd );
					dequeue = false;
					timers.splice( index, 1 );
				}
			}

			// Start the next in the queue if the last step wasn't forced.
			// Timers currently will call their complete callbacks, which
			// will dequeue but only if they were gotoEnd.
			if ( dequeue || !gotoEnd ) {
				jQuery.dequeue( this, type );
			}
		} );
	},
	finish: function( type ) {
		if ( type !== false ) {
			type = type || "fx";
		}
		return this.each( function() {
			var index,
				data = dataPriv.get( this ),
				queue = data[ type + "queue" ],
				hooks = data[ type + "queueHooks" ],
				timers = jQuery.timers,
				length = queue ? queue.length : 0;

			// Enable finishing flag on private data
			data.finish = true;

			// Empty the queue first
			jQuery.queue( this, type, [] );

			if ( hooks && hooks.stop ) {
				hooks.stop.call( this, true );
			}

			// Look for any active animations, and finish them
			for ( index = timers.length; index--; ) {
				if ( timers[ index ].elem === this && timers[ index ].queue === type ) {
					timers[ index ].anim.stop( true );
					timers.splice( index, 1 );
				}
			}

			// Look for any animations in the old queue and finish them
			for ( index = 0; index < length; index++ ) {
				if ( queue[ index ] && queue[ index ].finish ) {
					queue[ index ].finish.call( this );
				}
			}

			// Turn off finishing flag
			delete data.finish;
		} );
	}
} );

jQuery.each( [ "toggle", "show", "hide" ], function( i, name ) {
	var cssFn = jQuery.fn[ name ];
	jQuery.fn[ name ] = function( speed, easing, callback ) {
		return speed == null || typeof speed === "boolean" ?
			cssFn.apply( this, arguments ) :
			this.animate( genFx( name, true ), speed, easing, callback );
	};
} );

// Generate shortcuts for custom animations
jQuery.each( {
	slideDown: genFx( "show" ),
	slideUp: genFx( "hide" ),
	slideToggle: genFx( "toggle" ),
	fadeIn: { opacity: "show" },
	fadeOut: { opacity: "hide" },
	fadeToggle: { opacity: "toggle" }
}, function( name, props ) {
	jQuery.fn[ name ] = function( speed, easing, callback ) {
		return this.animate( props, speed, easing, callback );
	};
} );

jQuery.timers = [];
jQuery.fx.tick = function() {
	var timer,
		i = 0,
		timers = jQuery.timers;

	fxNow = jQuery.now();

	for ( ; i < timers.length; i++ ) {
		timer = timers[ i ];

		// Checks the timer has not already been removed
		if ( !timer() && timers[ i ] === timer ) {
			timers.splice( i--, 1 );
		}
	}

	if ( !timers.length ) {
		jQuery.fx.stop();
	}
	fxNow = undefined;
};

jQuery.fx.timer = function( timer ) {
	jQuery.timers.push( timer );
	if ( timer() ) {
		jQuery.fx.start();
	} else {
		jQuery.timers.pop();
	}
};

jQuery.fx.interval = 13;
jQuery.fx.start = function() {
	if ( !timerId ) {
		timerId = window.setInterval( jQuery.fx.tick, jQuery.fx.interval );
	}
};

jQuery.fx.stop = function() {
	window.clearInterval( timerId );

	timerId = null;
};

jQuery.fx.speeds = {
	slow: 600,
	fast: 200,

	// Default speed
	_default: 400
};


// Based off of the plugin by Clint Helfers, with permission.
// http://web.archive.org/web/20100324014747/http://blindsignals.com/index.php/2009/07/jquery-delay/
jQuery.fn.delay = function( time, type ) {
	time = jQuery.fx ? jQuery.fx.speeds[ time ] || time : time;
	type = type || "fx";

	return this.queue( type, function( next, hooks ) {
		var timeout = window.setTimeout( next, time );
		hooks.stop = function() {
			window.clearTimeout( timeout );
		};
	} );
};


( function() {
	var input = document.createElement( "input" ),
		select = document.createElement( "select" ),
		opt = select.appendChild( document.createElement( "option" ) );

	input.type = "checkbox";

	// Support: iOS<=5.1, Android<=4.2+
	// Default value for a checkbox should be "on"
	support.checkOn = input.value !== "";

	// Support: IE<=11+
	// Must access selectedIndex to make default options select
	support.optSelected = opt.selected;

	// Support: Android<=2.3
	// Options inside disabled selects are incorrectly marked as disabled
	select.disabled = true;
	support.optDisabled = !opt.disabled;

	// Support: IE<=11+
	// An input loses its value after becoming a radio
	input = document.createElement( "input" );
	input.value = "t";
	input.type = "radio";
	support.radioValue = input.value === "t";
} )();


var boolHook,
	attrHandle = jQuery.expr.attrHandle;

jQuery.fn.extend( {
	attr: function( name, value ) {
		return access( this, jQuery.attr, name, value, arguments.length > 1 );
	},

	removeAttr: function( name ) {
		return this.each( function() {
			jQuery.removeAttr( this, name );
		} );
	}
} );

jQuery.extend( {
	attr: function( elem, name, value ) {
		var ret, hooks,
			nType = elem.nodeType;

		// Don't get/set attributes on text, comment and attribute nodes
		if ( nType === 3 || nType === 8 || nType === 2 ) {
			return;
		}

		// Fallback to prop when attributes are not supported
		if ( typeof elem.getAttribute === "undefined" ) {
			return jQuery.prop( elem, name, value );
		}

		// All attributes are lowercase
		// Grab necessary hook if one is defined
		if ( nType !== 1 || !jQuery.isXMLDoc( elem ) ) {
			name = name.toLowerCase();
			hooks = jQuery.attrHooks[ name ] ||
				( jQuery.expr.match.bool.test( name ) ? boolHook : undefined );
		}

		if ( value !== undefined ) {
			if ( value === null ) {
				jQuery.removeAttr( elem, name );
				return;
			}

			if ( hooks && "set" in hooks &&
				( ret = hooks.set( elem, value, name ) ) !== undefined ) {
				return ret;
			}

			elem.setAttribute( name, value + "" );
			return value;
		}

		if ( hooks && "get" in hooks && ( ret = hooks.get( elem, name ) ) !== null ) {
			return ret;
		}

		ret = jQuery.find.attr( elem, name );

		// Non-existent attributes return null, we normalize to undefined
		return ret == null ? undefined : ret;
	},

	attrHooks: {
		type: {
			set: function( elem, value ) {
				if ( !support.radioValue && value === "radio" &&
					jQuery.nodeName( elem, "input" ) ) {
					var val = elem.value;
					elem.setAttribute( "type", value );
					if ( val ) {
						elem.value = val;
					}
					return value;
				}
			}
		}
	},

	removeAttr: function( elem, value ) {
		var name, propName,
			i = 0,
			attrNames = value && value.match( rnotwhite );

		if ( attrNames && elem.nodeType === 1 ) {
			while ( ( name = attrNames[ i++ ] ) ) {
				propName = jQuery.propFix[ name ] || name;

				// Boolean attributes get special treatment (#10870)
				if ( jQuery.expr.match.bool.test( name ) ) {

					// Set corresponding property to false
					elem[ propName ] = false;
				}

				elem.removeAttribute( name );
			}
		}
	}
} );

// Hooks for boolean attributes
boolHook = {
	set: function( elem, value, name ) {
		if ( value === false ) {

			// Remove boolean attributes when set to false
			jQuery.removeAttr( elem, name );
		} else {
			elem.setAttribute( name, name );
		}
		return name;
	}
};
jQuery.each( jQuery.expr.match.bool.source.match( /\w+/g ), function( i, name ) {
	var getter = attrHandle[ name ] || jQuery.find.attr;

	attrHandle[ name ] = function( elem, name, isXML ) {
		var ret, handle;
		if ( !isXML ) {

			// Avoid an infinite loop by temporarily removing this function from the getter
			handle = attrHandle[ name ];
			attrHandle[ name ] = ret;
			ret = getter( elem, name, isXML ) != null ?
				name.toLowerCase() :
				null;
			attrHandle[ name ] = handle;
		}
		return ret;
	};
} );




var rfocusable = /^(?:input|select|textarea|button)$/i,
	rclickable = /^(?:a|area)$/i;

jQuery.fn.extend( {
	prop: function( name, value ) {
		return access( this, jQuery.prop, name, value, arguments.length > 1 );
	},

	removeProp: function( name ) {
		return this.each( function() {
			delete this[ jQuery.propFix[ name ] || name ];
		} );
	}
} );

jQuery.extend( {
	prop: function( elem, name, value ) {
		var ret, hooks,
			nType = elem.nodeType;

		// Don't get/set properties on text, comment and attribute nodes
		if ( nType === 3 || nType === 8 || nType === 2 ) {
			return;
		}

		if ( nType !== 1 || !jQuery.isXMLDoc( elem ) ) {

			// Fix name and attach hooks
			name = jQuery.propFix[ name ] || name;
			hooks = jQuery.propHooks[ name ];
		}

		if ( value !== undefined ) {
			if ( hooks && "set" in hooks &&
				( ret = hooks.set( elem, value, name ) ) !== undefined ) {
				return ret;
			}

			return ( elem[ name ] = value );
		}

		if ( hooks && "get" in hooks && ( ret = hooks.get( elem, name ) ) !== null ) {
			return ret;
		}

		return elem[ name ];
	},

	propHooks: {
		tabIndex: {
			get: function( elem ) {

				// elem.tabIndex doesn't always return the
				// correct value when it hasn't been explicitly set
				// http://fluidproject.org/blog/2008/01/09/getting-setting-and-removing-tabindex-values-with-javascript/
				// Use proper attribute retrieval(#12072)
				var tabindex = jQuery.find.attr( elem, "tabindex" );

				return tabindex ?
					parseInt( tabindex, 10 ) :
					rfocusable.test( elem.nodeName ) ||
						rclickable.test( elem.nodeName ) && elem.href ?
							0 :
							-1;
			}
		}
	},

	propFix: {
		"for": "htmlFor",
		"class": "className"
	}
} );

// Support: IE <=11 only
// Accessing the selectedIndex property
// forces the browser to respect setting selected
// on the option
// The getter ensures a default option is selected
// when in an optgroup
if ( !support.optSelected ) {
	jQuery.propHooks.selected = {
		get: function( elem ) {
			var parent = elem.parentNode;
			if ( parent && parent.parentNode ) {
				parent.parentNode.selectedIndex;
			}
			return null;
		},
		set: function( elem ) {
			var parent = elem.parentNode;
			if ( parent ) {
				parent.selectedIndex;

				if ( parent.parentNode ) {
					parent.parentNode.selectedIndex;
				}
			}
		}
	};
}

jQuery.each( [
	"tabIndex",
	"readOnly",
	"maxLength",
	"cellSpacing",
	"cellPadding",
	"rowSpan",
	"colSpan",
	"useMap",
	"frameBorder",
	"contentEditable"
], function() {
	jQuery.propFix[ this.toLowerCase() ] = this;
} );




var rclass = /[\t\r\n\f]/g;

function getClass( elem ) {
	return elem.getAttribute && elem.getAttribute( "class" ) || "";
}

jQuery.fn.extend( {
	addClass: function( value ) {
		var classes, elem, cur, curValue, clazz, j, finalValue,
			i = 0;

		if ( jQuery.isFunction( value ) ) {
			return this.each( function( j ) {
				jQuery( this ).addClass( value.call( this, j, getClass( this ) ) );
			} );
		}

		if ( typeof value === "string" && value ) {
			classes = value.match( rnotwhite ) || [];

			while ( ( elem = this[ i++ ] ) ) {
				curValue = getClass( elem );
				cur = elem.nodeType === 1 &&
					( " " + curValue + " " ).replace( rclass, " " );

				if ( cur ) {
					j = 0;
					while ( ( clazz = classes[ j++ ] ) ) {
						if ( cur.indexOf( " " + clazz + " " ) < 0 ) {
							cur += clazz + " ";
						}
					}

					// Only assign if different to avoid unneeded rendering.
					finalValue = jQuery.trim( cur );
					if ( curValue !== finalValue ) {
						elem.setAttribute( "class", finalValue );
					}
				}
			}
		}

		return this;
	},

	removeClass: function( value ) {
		var classes, elem, cur, curValue, clazz, j, finalValue,
			i = 0;

		if ( jQuery.isFunction( value ) ) {
			return this.each( function( j ) {
				jQuery( this ).removeClass( value.call( this, j, getClass( this ) ) );
			} );
		}

		if ( !arguments.length ) {
			return this.attr( "class", "" );
		}

		if ( typeof value === "string" && value ) {
			classes = value.match( rnotwhite ) || [];

			while ( ( elem = this[ i++ ] ) ) {
				curValue = getClass( elem );

				// This expression is here for better compressibility (see addClass)
				cur = elem.nodeType === 1 &&
					( " " + curValue + " " ).replace( rclass, " " );

				if ( cur ) {
					j = 0;
					while ( ( clazz = classes[ j++ ] ) ) {

						// Remove *all* instances
						while ( cur.indexOf( " " + clazz + " " ) > -1 ) {
							cur = cur.replace( " " + clazz + " ", " " );
						}
					}

					// Only assign if different to avoid unneeded rendering.
					finalValue = jQuery.trim( cur );
					if ( curValue !== finalValue ) {
						elem.setAttribute( "class", finalValue );
					}
				}
			}
		}

		return this;
	},

	toggleClass: function( value, stateVal ) {
		var type = typeof value;

		if ( typeof stateVal === "boolean" && type === "string" ) {
			return stateVal ? this.addClass( value ) : this.removeClass( value );
		}

		if ( jQuery.isFunction( value ) ) {
			return this.each( function( i ) {
				jQuery( this ).toggleClass(
					value.call( this, i, getClass( this ), stateVal ),
					stateVal
				);
			} );
		}

		return this.each( function() {
			var className, i, self, classNames;

			if ( type === "string" ) {

				// Toggle individual class names
				i = 0;
				self = jQuery( this );
				classNames = value.match( rnotwhite ) || [];

				while ( ( className = classNames[ i++ ] ) ) {

					// Check each className given, space separated list
					if ( self.hasClass( className ) ) {
						self.removeClass( className );
					} else {
						self.addClass( className );
					}
				}

			// Toggle whole class name
			} else if ( value === undefined || type === "boolean" ) {
				className = getClass( this );
				if ( className ) {

					// Store className if set
					dataPriv.set( this, "__className__", className );
				}

				// If the element has a class name or if we're passed `false`,
				// then remove the whole classname (if there was one, the above saved it).
				// Otherwise bring back whatever was previously saved (if anything),
				// falling back to the empty string if nothing was stored.
				if ( this.setAttribute ) {
					this.setAttribute( "class",
						className || value === false ?
						"" :
						dataPriv.get( this, "__className__" ) || ""
					);
				}
			}
		} );
	},

	hasClass: function( selector ) {
		var className, elem,
			i = 0;

		className = " " + selector + " ";
		while ( ( elem = this[ i++ ] ) ) {
			if ( elem.nodeType === 1 &&
				( " " + getClass( elem ) + " " ).replace( rclass, " " )
					.indexOf( className ) > -1
			) {
				return true;
			}
		}

		return false;
	}
} );




var rreturn = /\r/g,
	rspaces = /[\x20\t\r\n\f]+/g;

jQuery.fn.extend( {
	val: function( value ) {
		var hooks, ret, isFunction,
			elem = this[ 0 ];

		if ( !arguments.length ) {
			if ( elem ) {
				hooks = jQuery.valHooks[ elem.type ] ||
					jQuery.valHooks[ elem.nodeName.toLowerCase() ];

				if ( hooks &&
					"get" in hooks &&
					( ret = hooks.get( elem, "value" ) ) !== undefined
				) {
					return ret;
				}

				ret = elem.value;

				return typeof ret === "string" ?

					// Handle most common string cases
					ret.replace( rreturn, "" ) :

					// Handle cases where value is null/undef or number
					ret == null ? "" : ret;
			}

			return;
		}

		isFunction = jQuery.isFunction( value );

		return this.each( function( i ) {
			var val;

			if ( this.nodeType !== 1 ) {
				return;
			}

			if ( isFunction ) {
				val = value.call( this, i, jQuery( this ).val() );
			} else {
				val = value;
			}

			// Treat null/undefined as ""; convert numbers to string
			if ( val == null ) {
				val = "";

			} else if ( typeof val === "number" ) {
				val += "";

			} else if ( jQuery.isArray( val ) ) {
				val = jQuery.map( val, function( value ) {
					return value == null ? "" : value + "";
				} );
			}

			hooks = jQuery.valHooks[ this.type ] || jQuery.valHooks[ this.nodeName.toLowerCase() ];

			// If set returns undefined, fall back to normal setting
			if ( !hooks || !( "set" in hooks ) || hooks.set( this, val, "value" ) === undefined ) {
				this.value = val;
			}
		} );
	}
} );

jQuery.extend( {
	valHooks: {
		option: {
			get: function( elem ) {

				var val = jQuery.find.attr( elem, "value" );
				return val != null ?
					val :

					// Support: IE10-11+
					// option.text throws exceptions (#14686, #14858)
					// Strip and collapse whitespace
					// https://html.spec.whatwg.org/#strip-and-collapse-whitespace
					jQuery.trim( jQuery.text( elem ) ).replace( rspaces, " " );
			}
		},
		select: {
			get: function( elem ) {
				var value, option,
					options = elem.options,
					index = elem.selectedIndex,
					one = elem.type === "select-one" || index < 0,
					values = one ? null : [],
					max = one ? index + 1 : options.length,
					i = index < 0 ?
						max :
						one ? index : 0;

				// Loop through all the selected options
				for ( ; i < max; i++ ) {
					option = options[ i ];

					// IE8-9 doesn't update selected after form reset (#2551)
					if ( ( option.selected || i === index ) &&

							// Don't return options that are disabled or in a disabled optgroup
							( support.optDisabled ?
								!option.disabled : option.getAttribute( "disabled" ) === null ) &&
							( !option.parentNode.disabled ||
								!jQuery.nodeName( option.parentNode, "optgroup" ) ) ) {

						// Get the specific value for the option
						value = jQuery( option ).val();

						// We don't need an array for one selects
						if ( one ) {
							return value;
						}

						// Multi-Selects return an array
						values.push( value );
					}
				}

				return values;
			},

			set: function( elem, value ) {
				var optionSet, option,
					options = elem.options,
					values = jQuery.makeArray( value ),
					i = options.length;

				while ( i-- ) {
					option = options[ i ];
					if ( option.selected =
						jQuery.inArray( jQuery.valHooks.option.get( option ), values ) > -1
					) {
						optionSet = true;
					}
				}

				// Force browsers to behave consistently when non-matching value is set
				if ( !optionSet ) {
					elem.selectedIndex = -1;
				}
				return values;
			}
		}
	}
} );

// Radios and checkboxes getter/setter
jQuery.each( [ "radio", "checkbox" ], function() {
	jQuery.valHooks[ this ] = {
		set: function( elem, value ) {
			if ( jQuery.isArray( value ) ) {
				return ( elem.checked = jQuery.inArray( jQuery( elem ).val(), value ) > -1 );
			}
		}
	};
	if ( !support.checkOn ) {
		jQuery.valHooks[ this ].get = function( elem ) {
			return elem.getAttribute( "value" ) === null ? "on" : elem.value;
		};
	}
} );




// Return jQuery for attributes-only inclusion


var rfocusMorph = /^(?:focusinfocus|focusoutblur)$/;

jQuery.extend( jQuery.event, {

	trigger: function( event, data, elem, onlyHandlers ) {

		var i, cur, tmp, bubbleType, ontype, handle, special,
			eventPath = [ elem || document ],
			type = hasOwn.call( event, "type" ) ? event.type : event,
			namespaces = hasOwn.call( event, "namespace" ) ? event.namespace.split( "." ) : [];

		cur = tmp = elem = elem || document;

		// Don't do events on text and comment nodes
		if ( elem.nodeType === 3 || elem.nodeType === 8 ) {
			return;
		}

		// focus/blur morphs to focusin/out; ensure we're not firing them right now
		if ( rfocusMorph.test( type + jQuery.event.triggered ) ) {
			return;
		}

		if ( type.indexOf( "." ) > -1 ) {

			// Namespaced trigger; create a regexp to match event type in handle()
			namespaces = type.split( "." );
			type = namespaces.shift();
			namespaces.sort();
		}
		ontype = type.indexOf( ":" ) < 0 && "on" + type;

		// Caller can pass in a jQuery.Event object, Object, or just an event type string
		event = event[ jQuery.expando ] ?
			event :
			new jQuery.Event( type, typeof event === "object" && event );

		// Trigger bitmask: & 1 for native handlers; & 2 for jQuery (always true)
		event.isTrigger = onlyHandlers ? 2 : 3;
		event.namespace = namespaces.join( "." );
		event.rnamespace = event.namespace ?
			new RegExp( "(^|\\.)" + namespaces.join( "\\.(?:.*\\.|)" ) + "(\\.|$)" ) :
			null;

		// Clean up the event in case it is being reused
		event.result = undefined;
		if ( !event.target ) {
			event.target = elem;
		}

		// Clone any incoming data and prepend the event, creating the handler arg list
		data = data == null ?
			[ event ] :
			jQuery.makeArray( data, [ event ] );

		// Allow special events to draw outside the lines
		special = jQuery.event.special[ type ] || {};
		if ( !onlyHandlers && special.trigger && special.trigger.apply( elem, data ) === false ) {
			return;
		}

		// Determine event propagation path in advance, per W3C events spec (#9951)
		// Bubble up to document, then to window; watch for a global ownerDocument var (#9724)
		if ( !onlyHandlers && !special.noBubble && !jQuery.isWindow( elem ) ) {

			bubbleType = special.delegateType || type;
			if ( !rfocusMorph.test( bubbleType + type ) ) {
				cur = cur.parentNode;
			}
			for ( ; cur; cur = cur.parentNode ) {
				eventPath.push( cur );
				tmp = cur;
			}

			// Only add window if we got to document (e.g., not plain obj or detached DOM)
			if ( tmp === ( elem.ownerDocument || document ) ) {
				eventPath.push( tmp.defaultView || tmp.parentWindow || window );
			}
		}

		// Fire handlers on the event path
		i = 0;
		while ( ( cur = eventPath[ i++ ] ) && !event.isPropagationStopped() ) {

			event.type = i > 1 ?
				bubbleType :
				special.bindType || type;

			// jQuery handler
			handle = ( dataPriv.get( cur, "events" ) || {} )[ event.type ] &&
				dataPriv.get( cur, "handle" );
			if ( handle ) {
				handle.apply( cur, data );
			}

			// Native handler
			handle = ontype && cur[ ontype ];
			if ( handle && handle.apply && acceptData( cur ) ) {
				event.result = handle.apply( cur, data );
				if ( event.result === false ) {
					event.preventDefault();
				}
			}
		}
		event.type = type;

		// If nobody prevented the default action, do it now
		if ( !onlyHandlers && !event.isDefaultPrevented() ) {

			if ( ( !special._default ||
				special._default.apply( eventPath.pop(), data ) === false ) &&
				acceptData( elem ) ) {

				// Call a native DOM method on the target with the same name name as the event.
				// Don't do default actions on window, that's where global variables be (#6170)
				if ( ontype && jQuery.isFunction( elem[ type ] ) && !jQuery.isWindow( elem ) ) {

					// Don't re-trigger an onFOO event when we call its FOO() method
					tmp = elem[ ontype ];

					if ( tmp ) {
						elem[ ontype ] = null;
					}

					// Prevent re-triggering of the same event, since we already bubbled it above
					jQuery.event.triggered = type;
					elem[ type ]();
					jQuery.event.triggered = undefined;

					if ( tmp ) {
						elem[ ontype ] = tmp;
					}
				}
			}
		}

		return event.result;
	},

	// Piggyback on a donor event to simulate a different one
	// Used only for `focus(in | out)` events
	simulate: function( type, elem, event ) {
		var e = jQuery.extend(
			new jQuery.Event(),
			event,
			{
				type: type,
				isSimulated: true
			}
		);

		jQuery.event.trigger( e, null, elem );
	}

} );

jQuery.fn.extend( {

	trigger: function( type, data ) {
		return this.each( function() {
			jQuery.event.trigger( type, data, this );
		} );
	},
	triggerHandler: function( type, data ) {
		var elem = this[ 0 ];
		if ( elem ) {
			return jQuery.event.trigger( type, data, elem, true );
		}
	}
} );


jQuery.each( ( "blur focus focusin focusout load resize scroll unload click dblclick " +
	"mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave " +
	"change select submit keydown keypress keyup error contextmenu" ).split( " " ),
	function( i, name ) {

	// Handle event binding
	jQuery.fn[ name ] = function( data, fn ) {
		return arguments.length > 0 ?
			this.on( name, null, data, fn ) :
			this.trigger( name );
	};
} );

jQuery.fn.extend( {
	hover: function( fnOver, fnOut ) {
		return this.mouseenter( fnOver ).mouseleave( fnOut || fnOver );
	}
} );




support.focusin = "onfocusin" in window;


// Support: Firefox
// Firefox doesn't have focus(in | out) events
// Related ticket - https://bugzilla.mozilla.org/show_bug.cgi?id=687787
//
// Support: Chrome, Safari
// focus(in | out) events fire after focus & blur events,
// which is spec violation - http://www.w3.org/TR/DOM-Level-3-Events/#events-focusevent-event-order
// Related ticket - https://code.google.com/p/chromium/issues/detail?id=449857
if ( !support.focusin ) {
	jQuery.each( { focus: "focusin", blur: "focusout" }, function( orig, fix ) {

		// Attach a single capturing handler on the document while someone wants focusin/focusout
		var handler = function( event ) {
			jQuery.event.simulate( fix, event.target, jQuery.event.fix( event ) );
		};

		jQuery.event.special[ fix ] = {
			setup: function() {
				var doc = this.ownerDocument || this,
					attaches = dataPriv.access( doc, fix );

				if ( !attaches ) {
					doc.addEventListener( orig, handler, true );
				}
				dataPriv.access( doc, fix, ( attaches || 0 ) + 1 );
			},
			teardown: function() {
				var doc = this.ownerDocument || this,
					attaches = dataPriv.access( doc, fix ) - 1;

				if ( !attaches ) {
					doc.removeEventListener( orig, handler, true );
					dataPriv.remove( doc, fix );

				} else {
					dataPriv.access( doc, fix, attaches );
				}
			}
		};
	} );
}
var location = window.location;

var nonce = jQuery.now();

var rquery = ( /\?/ );



// Support: Android 2.3
// Workaround failure to string-cast null input
jQuery.parseJSON = function( data ) {
	return JSON.parse( data + "" );
};


// Cross-browser xml parsing
jQuery.parseXML = function( data ) {
	var xml;
	if ( !data || typeof data !== "string" ) {
		return null;
	}

	// Support: IE9
	try {
		xml = ( new window.DOMParser() ).parseFromString( data, "text/xml" );
	} catch ( e ) {
		xml = undefined;
	}

	if ( !xml || xml.getElementsByTagName( "parsererror" ).length ) {
		jQuery.error( "Invalid XML: " + data );
	}
	return xml;
};


var
	rhash = /#.*$/,
	rts = /([?&])_=[^&]*/,
	rheaders = /^(.*?):[ \t]*([^\r\n]*)$/mg,

	// #7653, #8125, #8152: local protocol detection
	rlocalProtocol = /^(?:about|app|app-storage|.+-extension|file|res|widget):$/,
	rnoContent = /^(?:GET|HEAD)$/,
	rprotocol = /^\/\//,

	/* Prefilters
	 * 1) They are useful to introduce custom dataTypes (see ajax/jsonp.js for an example)
	 * 2) These are called:
	 *    - BEFORE asking for a transport
	 *    - AFTER param serialization (s.data is a string if s.processData is true)
	 * 3) key is the dataType
	 * 4) the catchall symbol "*" can be used
	 * 5) execution will start with transport dataType and THEN continue down to "*" if needed
	 */
	prefilters = {},

	/* Transports bindings
	 * 1) key is the dataType
	 * 2) the catchall symbol "*" can be used
	 * 3) selection will start with transport dataType and THEN go to "*" if needed
	 */
	transports = {},

	// Avoid comment-prolog char sequence (#10098); must appease lint and evade compression
	allTypes = "*/".concat( "*" ),

	// Anchor tag for parsing the document origin
	originAnchor = document.createElement( "a" );
	originAnchor.href = location.href;

// Base "constructor" for jQuery.ajaxPrefilter and jQuery.ajaxTransport
function addToPrefiltersOrTransports( structure ) {

	// dataTypeExpression is optional and defaults to "*"
	return function( dataTypeExpression, func ) {

		if ( typeof dataTypeExpression !== "string" ) {
			func = dataTypeExpression;
			dataTypeExpression = "*";
		}

		var dataType,
			i = 0,
			dataTypes = dataTypeExpression.toLowerCase().match( rnotwhite ) || [];

		if ( jQuery.isFunction( func ) ) {

			// For each dataType in the dataTypeExpression
			while ( ( dataType = dataTypes[ i++ ] ) ) {

				// Prepend if requested
				if ( dataType[ 0 ] === "+" ) {
					dataType = dataType.slice( 1 ) || "*";
					( structure[ dataType ] = structure[ dataType ] || [] ).unshift( func );

				// Otherwise append
				} else {
					( structure[ dataType ] = structure[ dataType ] || [] ).push( func );
				}
			}
		}
	};
}

// Base inspection function for prefilters and transports
function inspectPrefiltersOrTransports( structure, options, originalOptions, jqXHR ) {

	var inspected = {},
		seekingTransport = ( structure === transports );

	function inspect( dataType ) {
		var selected;
		inspected[ dataType ] = true;
		jQuery.each( structure[ dataType ] || [], function( _, prefilterOrFactory ) {
			var dataTypeOrTransport = prefilterOrFactory( options, originalOptions, jqXHR );
			if ( typeof dataTypeOrTransport === "string" &&
				!seekingTransport && !inspected[ dataTypeOrTransport ] ) {

				options.dataTypes.unshift( dataTypeOrTransport );
				inspect( dataTypeOrTransport );
				return false;
			} else if ( seekingTransport ) {
				return !( selected = dataTypeOrTransport );
			}
		} );
		return selected;
	}

	return inspect( options.dataTypes[ 0 ] ) || !inspected[ "*" ] && inspect( "*" );
}

// A special extend for ajax options
// that takes "flat" options (not to be deep extended)
// Fixes #9887
function ajaxExtend( target, src ) {
	var key, deep,
		flatOptions = jQuery.ajaxSettings.flatOptions || {};

	for ( key in src ) {
		if ( src[ key ] !== undefined ) {
			( flatOptions[ key ] ? target : ( deep || ( deep = {} ) ) )[ key ] = src[ key ];
		}
	}
	if ( deep ) {
		jQuery.extend( true, target, deep );
	}

	return target;
}

/* Handles responses to an ajax request:
 * - finds the right dataType (mediates between content-type and expected dataType)
 * - returns the corresponding response
 */
function ajaxHandleResponses( s, jqXHR, responses ) {

	var ct, type, finalDataType, firstDataType,
		contents = s.contents,
		dataTypes = s.dataTypes;

	// Remove auto dataType and get content-type in the process
	while ( dataTypes[ 0 ] === "*" ) {
		dataTypes.shift();
		if ( ct === undefined ) {
			ct = s.mimeType || jqXHR.getResponseHeader( "Content-Type" );
		}
	}

	// Check if we're dealing with a known content-type
	if ( ct ) {
		for ( type in contents ) {
			if ( contents[ type ] && contents[ type ].test( ct ) ) {
				dataTypes.unshift( type );
				break;
			}
		}
	}

	// Check to see if we have a response for the expected dataType
	if ( dataTypes[ 0 ] in responses ) {
		finalDataType = dataTypes[ 0 ];
	} else {

		// Try convertible dataTypes
		for ( type in responses ) {
			if ( !dataTypes[ 0 ] || s.converters[ type + " " + dataTypes[ 0 ] ] ) {
				finalDataType = type;
				break;
			}
			if ( !firstDataType ) {
				firstDataType = type;
			}
		}

		// Or just use first one
		finalDataType = finalDataType || firstDataType;
	}

	// If we found a dataType
	// We add the dataType to the list if needed
	// and return the corresponding response
	if ( finalDataType ) {
		if ( finalDataType !== dataTypes[ 0 ] ) {
			dataTypes.unshift( finalDataType );
		}
		return responses[ finalDataType ];
	}
}

/* Chain conversions given the request and the original response
 * Also sets the responseXXX fields on the jqXHR instance
 */
function ajaxConvert( s, response, jqXHR, isSuccess ) {
	var conv2, current, conv, tmp, prev,
		converters = {},

		// Work with a copy of dataTypes in case we need to modify it for conversion
		dataTypes = s.dataTypes.slice();

	// Create converters map with lowercased keys
	if ( dataTypes[ 1 ] ) {
		for ( conv in s.converters ) {
			converters[ conv.toLowerCase() ] = s.converters[ conv ];
		}
	}

	current = dataTypes.shift();

	// Convert to each sequential dataType
	while ( current ) {

		if ( s.responseFields[ current ] ) {
			jqXHR[ s.responseFields[ current ] ] = response;
		}

		// Apply the dataFilter if provided
		if ( !prev && isSuccess && s.dataFilter ) {
			response = s.dataFilter( response, s.dataType );
		}

		prev = current;
		current = dataTypes.shift();

		if ( current ) {

		// There's only work to do if current dataType is non-auto
			if ( current === "*" ) {

				current = prev;

			// Convert response if prev dataType is non-auto and differs from current
			} else if ( prev !== "*" && prev !== current ) {

				// Seek a direct converter
				conv = converters[ prev + " " + current ] || converters[ "* " + current ];

				// If none found, seek a pair
				if ( !conv ) {
					for ( conv2 in converters ) {

						// If conv2 outputs current
						tmp = conv2.split( " " );
						if ( tmp[ 1 ] === current ) {

							// If prev can be converted to accepted input
							conv = converters[ prev + " " + tmp[ 0 ] ] ||
								converters[ "* " + tmp[ 0 ] ];
							if ( conv ) {

								// Condense equivalence converters
								if ( conv === true ) {
									conv = converters[ conv2 ];

								// Otherwise, insert the intermediate dataType
								} else if ( converters[ conv2 ] !== true ) {
									current = tmp[ 0 ];
									dataTypes.unshift( tmp[ 1 ] );
								}
								break;
							}
						}
					}
				}

				// Apply converter (if not an equivalence)
				if ( conv !== true ) {

					// Unless errors are allowed to bubble, catch and return them
					if ( conv && s.throws ) {
						response = conv( response );
					} else {
						try {
							response = conv( response );
						} catch ( e ) {
							return {
								state: "parsererror",
								error: conv ? e : "No conversion from " + prev + " to " + current
							};
						}
					}
				}
			}
		}
	}

	return { state: "success", data: response };
}

jQuery.extend( {

	// Counter for holding the number of active queries
	active: 0,

	// Last-Modified header cache for next request
	lastModified: {},
	etag: {},

	ajaxSettings: {
		url: location.href,
		type: "GET",
		isLocal: rlocalProtocol.test( location.protocol ),
		global: true,
		processData: true,
		async: true,
		contentType: "application/x-www-form-urlencoded; charset=UTF-8",
		/*
		timeout: 0,
		data: null,
		dataType: null,
		username: null,
		password: null,
		cache: null,
		throws: false,
		traditional: false,
		headers: {},
		*/

		accepts: {
			"*": allTypes,
			text: "text/plain",
			html: "text/html",
			xml: "application/xml, text/xml",
			json: "application/json, text/javascript"
		},

		contents: {
			xml: /\bxml\b/,
			html: /\bhtml/,
			json: /\bjson\b/
		},

		responseFields: {
			xml: "responseXML",
			text: "responseText",
			json: "responseJSON"
		},

		// Data converters
		// Keys separate source (or catchall "*") and destination types with a single space
		converters: {

			// Convert anything to text
			"* text": String,

			// Text to html (true = no transformation)
			"text html": true,

			// Evaluate text as a json expression
			"text json": jQuery.parseJSON,

			// Parse text as xml
			"text xml": jQuery.parseXML
		},

		// For options that shouldn't be deep extended:
		// you can add your own custom options here if
		// and when you create one that shouldn't be
		// deep extended (see ajaxExtend)
		flatOptions: {
			url: true,
			context: true
		}
	},

	// Creates a full fledged settings object into target
	// with both ajaxSettings and settings fields.
	// If target is omitted, writes into ajaxSettings.
	ajaxSetup: function( target, settings ) {
		return settings ?

			// Building a settings object
			ajaxExtend( ajaxExtend( target, jQuery.ajaxSettings ), settings ) :

			// Extending ajaxSettings
			ajaxExtend( jQuery.ajaxSettings, target );
	},

	ajaxPrefilter: addToPrefiltersOrTransports( prefilters ),
	ajaxTransport: addToPrefiltersOrTransports( transports ),

	// Main method
	ajax: function( url, options ) {

		// If url is an object, simulate pre-1.5 signature
		if ( typeof url === "object" ) {
			options = url;
			url = undefined;
		}

		// Force options to be an object
		options = options || {};

		var transport,

			// URL without anti-cache param
			cacheURL,

			// Response headers
			responseHeadersString,
			responseHeaders,

			// timeout handle
			timeoutTimer,

			// Url cleanup var
			urlAnchor,

			// To know if global events are to be dispatched
			fireGlobals,

			// Loop variable
			i,

			// Create the final options object
			s = jQuery.ajaxSetup( {}, options ),

			// Callbacks context
			callbackContext = s.context || s,

			// Context for global events is callbackContext if it is a DOM node or jQuery collection
			globalEventContext = s.context &&
				( callbackContext.nodeType || callbackContext.jquery ) ?
					jQuery( callbackContext ) :
					jQuery.event,

			// Deferreds
			deferred = jQuery.Deferred(),
			completeDeferred = jQuery.Callbacks( "once memory" ),

			// Status-dependent callbacks
			statusCode = s.statusCode || {},

			// Headers (they are sent all at once)
			requestHeaders = {},
			requestHeadersNames = {},

			// The jqXHR state
			state = 0,

			// Default abort message
			strAbort = "canceled",

			// Fake xhr
			jqXHR = {
				readyState: 0,

				// Builds headers hashtable if needed
				getResponseHeader: function( key ) {
					var match;
					if ( state === 2 ) {
						if ( !responseHeaders ) {
							responseHeaders = {};
							while ( ( match = rheaders.exec( responseHeadersString ) ) ) {
								responseHeaders[ match[ 1 ].toLowerCase() ] = match[ 2 ];
							}
						}
						match = responseHeaders[ key.toLowerCase() ];
					}
					return match == null ? null : match;
				},

				// Raw string
				getAllResponseHeaders: function() {
					return state === 2 ? responseHeadersString : null;
				},

				// Caches the header
				setRequestHeader: function( name, value ) {
					var lname = name.toLowerCase();
					if ( !state ) {
						name = requestHeadersNames[ lname ] = requestHeadersNames[ lname ] || name;
						requestHeaders[ name ] = value;
					}
					return this;
				},

				// Overrides response content-type header
				overrideMimeType: function( type ) {
					if ( !state ) {
						s.mimeType = type;
					}
					return this;
				},

				// Status-dependent callbacks
				statusCode: function( map ) {
					var code;
					if ( map ) {
						if ( state < 2 ) {
							for ( code in map ) {

								// Lazy-add the new callback in a way that preserves old ones
								statusCode[ code ] = [ statusCode[ code ], map[ code ] ];
							}
						} else {

							// Execute the appropriate callbacks
							jqXHR.always( map[ jqXHR.status ] );
						}
					}
					return this;
				},

				// Cancel the request
				abort: function( statusText ) {
					var finalText = statusText || strAbort;
					if ( transport ) {
						transport.abort( finalText );
					}
					done( 0, finalText );
					return this;
				}
			};

		// Attach deferreds
		deferred.promise( jqXHR ).complete = completeDeferred.add;
		jqXHR.success = jqXHR.done;
		jqXHR.error = jqXHR.fail;

		// Remove hash character (#7531: and string promotion)
		// Add protocol if not provided (prefilters might expect it)
		// Handle falsy url in the settings object (#10093: consistency with old signature)
		// We also use the url parameter if available
		s.url = ( ( url || s.url || location.href ) + "" ).replace( rhash, "" )
			.replace( rprotocol, location.protocol + "//" );

		// Alias method option to type as per ticket #12004
		s.type = options.method || options.type || s.method || s.type;

		// Extract dataTypes list
		s.dataTypes = jQuery.trim( s.dataType || "*" ).toLowerCase().match( rnotwhite ) || [ "" ];

		// A cross-domain request is in order when the origin doesn't match the current origin.
		if ( s.crossDomain == null ) {
			urlAnchor = document.createElement( "a" );

			// Support: IE8-11+
			// IE throws exception if url is malformed, e.g. http://example.com:80x/
			try {
				urlAnchor.href = s.url;

				// Support: IE8-11+
				// Anchor's host property isn't correctly set when s.url is relative
				urlAnchor.href = urlAnchor.href;
				s.crossDomain = originAnchor.protocol + "//" + originAnchor.host !==
					urlAnchor.protocol + "//" + urlAnchor.host;
			} catch ( e ) {

				// If there is an error parsing the URL, assume it is crossDomain,
				// it can be rejected by the transport if it is invalid
				s.crossDomain = true;
			}
		}

		// Convert data if not already a string
		if ( s.data && s.processData && typeof s.data !== "string" ) {
			s.data = jQuery.param( s.data, s.traditional );
		}

		// Apply prefilters
		inspectPrefiltersOrTransports( prefilters, s, options, jqXHR );

		// If request was aborted inside a prefilter, stop there
		if ( state === 2 ) {
			return jqXHR;
		}

		// We can fire global events as of now if asked to
		// Don't fire events if jQuery.event is undefined in an AMD-usage scenario (#15118)
		fireGlobals = jQuery.event && s.global;

		// Watch for a new set of requests
		if ( fireGlobals && jQuery.active++ === 0 ) {
			jQuery.event.trigger( "ajaxStart" );
		}

		// Uppercase the type
		s.type = s.type.toUpperCase();

		// Determine if request has content
		s.hasContent = !rnoContent.test( s.type );

		// Save the URL in case we're toying with the If-Modified-Since
		// and/or If-None-Match header later on
		cacheURL = s.url;

		// More options handling for requests with no content
		if ( !s.hasContent ) {

			// If data is available, append data to url
			if ( s.data ) {
				cacheURL = ( s.url += ( rquery.test( cacheURL ) ? "&" : "?" ) + s.data );

				// #9682: remove data so that it's not used in an eventual retry
				delete s.data;
			}

			// Add anti-cache in url if needed
			if ( s.cache === false ) {
				s.url = rts.test( cacheURL ) ?

					// If there is already a '_' parameter, set its value
					cacheURL.replace( rts, "$1_=" + nonce++ ) :

					// Otherwise add one to the end
					cacheURL + ( rquery.test( cacheURL ) ? "&" : "?" ) + "_=" + nonce++;
			}
		}

		// Set the If-Modified-Since and/or If-None-Match header, if in ifModified mode.
		if ( s.ifModified ) {
			if ( jQuery.lastModified[ cacheURL ] ) {
				jqXHR.setRequestHeader( "If-Modified-Since", jQuery.lastModified[ cacheURL ] );
			}
			if ( jQuery.etag[ cacheURL ] ) {
				jqXHR.setRequestHeader( "If-None-Match", jQuery.etag[ cacheURL ] );
			}
		}

		// Set the correct header, if data is being sent
		if ( s.data && s.hasContent && s.contentType !== false || options.contentType ) {
			jqXHR.setRequestHeader( "Content-Type", s.contentType );
		}

		// Set the Accepts header for the server, depending on the dataType
		jqXHR.setRequestHeader(
			"Accept",
			s.dataTypes[ 0 ] && s.accepts[ s.dataTypes[ 0 ] ] ?
				s.accepts[ s.dataTypes[ 0 ] ] +
					( s.dataTypes[ 0 ] !== "*" ? ", " + allTypes + "; q=0.01" : "" ) :
				s.accepts[ "*" ]
		);

		// Check for headers option
		for ( i in s.headers ) {
			jqXHR.setRequestHeader( i, s.headers[ i ] );
		}

		// Allow custom headers/mimetypes and early abort
		if ( s.beforeSend &&
			( s.beforeSend.call( callbackContext, jqXHR, s ) === false || state === 2 ) ) {

			// Abort if not done already and return
			return jqXHR.abort();
		}

		// Aborting is no longer a cancellation
		strAbort = "abort";

		// Install callbacks on deferreds
		for ( i in { success: 1, error: 1, complete: 1 } ) {
			jqXHR[ i ]( s[ i ] );
		}

		// Get transport
		transport = inspectPrefiltersOrTransports( transports, s, options, jqXHR );

		// If no transport, we auto-abort
		if ( !transport ) {
			done( -1, "No Transport" );
		} else {
			jqXHR.readyState = 1;

			// Send global event
			if ( fireGlobals ) {
				globalEventContext.trigger( "ajaxSend", [ jqXHR, s ] );
			}

			// If request was aborted inside ajaxSend, stop there
			if ( state === 2 ) {
				return jqXHR;
			}

			// Timeout
			if ( s.async && s.timeout > 0 ) {
				timeoutTimer = window.setTimeout( function() {
					jqXHR.abort( "timeout" );
				}, s.timeout );
			}

			try {
				state = 1;
				transport.send( requestHeaders, done );
			} catch ( e ) {

				// Propagate exception as error if not done
				if ( state < 2 ) {
					done( -1, e );

				// Simply rethrow otherwise
				} else {
					throw e;
				}
			}
		}

		// Callback for when everything is done
		function done( status, nativeStatusText, responses, headers ) {
			var isSuccess, success, error, response, modified,
				statusText = nativeStatusText;

			// Called once
			if ( state === 2 ) {
				return;
			}

			// State is "done" now
			state = 2;

			// Clear timeout if it exists
			if ( timeoutTimer ) {
				window.clearTimeout( timeoutTimer );
			}

			// Dereference transport for early garbage collection
			// (no matter how long the jqXHR object will be used)
			transport = undefined;

			// Cache response headers
			responseHeadersString = headers || "";

			// Set readyState
			jqXHR.readyState = status > 0 ? 4 : 0;

			// Determine if successful
			isSuccess = status >= 200 && status < 300 || status === 304;

			// Get response data
			if ( responses ) {
				response = ajaxHandleResponses( s, jqXHR, responses );
			}

			// Convert no matter what (that way responseXXX fields are always set)
			response = ajaxConvert( s, response, jqXHR, isSuccess );

			// If successful, handle type chaining
			if ( isSuccess ) {

				// Set the If-Modified-Since and/or If-None-Match header, if in ifModified mode.
				if ( s.ifModified ) {
					modified = jqXHR.getResponseHeader( "Last-Modified" );
					if ( modified ) {
						jQuery.lastModified[ cacheURL ] = modified;
					}
					modified = jqXHR.getResponseHeader( "etag" );
					if ( modified ) {
						jQuery.etag[ cacheURL ] = modified;
					}
				}

				// if no content
				if ( status === 204 || s.type === "HEAD" ) {
					statusText = "nocontent";

				// if not modified
				} else if ( status === 304 ) {
					statusText = "notmodified";

				// If we have data, let's convert it
				} else {
					statusText = response.state;
					success = response.data;
					error = response.error;
					isSuccess = !error;
				}
			} else {

				// Extract error from statusText and normalize for non-aborts
				error = statusText;
				if ( status || !statusText ) {
					statusText = "error";
					if ( status < 0 ) {
						status = 0;
					}
				}
			}

			// Set data for the fake xhr object
			jqXHR.status = status;
			jqXHR.statusText = ( nativeStatusText || statusText ) + "";

			// Success/Error
			if ( isSuccess ) {
				deferred.resolveWith( callbackContext, [ success, statusText, jqXHR ] );
			} else {
				deferred.rejectWith( callbackContext, [ jqXHR, statusText, error ] );
			}

			// Status-dependent callbacks
			jqXHR.statusCode( statusCode );
			statusCode = undefined;

			if ( fireGlobals ) {
				globalEventContext.trigger( isSuccess ? "ajaxSuccess" : "ajaxError",
					[ jqXHR, s, isSuccess ? success : error ] );
			}

			// Complete
			completeDeferred.fireWith( callbackContext, [ jqXHR, statusText ] );

			if ( fireGlobals ) {
				globalEventContext.trigger( "ajaxComplete", [ jqXHR, s ] );

				// Handle the global AJAX counter
				if ( !( --jQuery.active ) ) {
					jQuery.event.trigger( "ajaxStop" );
				}
			}
		}

		return jqXHR;
	},

	getJSON: function( url, data, callback ) {
		return jQuery.get( url, data, callback, "json" );
	},

	getScript: function( url, callback ) {
		return jQuery.get( url, undefined, callback, "script" );
	}
} );

jQuery.each( [ "get", "post" ], function( i, method ) {
	jQuery[ method ] = function( url, data, callback, type ) {

		// Shift arguments if data argument was omitted
		if ( jQuery.isFunction( data ) ) {
			type = type || callback;
			callback = data;
			data = undefined;
		}

		// The url can be an options object (which then must have .url)
		return jQuery.ajax( jQuery.extend( {
			url: url,
			type: method,
			dataType: type,
			data: data,
			success: callback
		}, jQuery.isPlainObject( url ) && url ) );
	};
} );


jQuery._evalUrl = function( url ) {
	return jQuery.ajax( {
		url: url,

		// Make this explicit, since user can override this through ajaxSetup (#11264)
		type: "GET",
		dataType: "script",
		async: false,
		global: false,
		"throws": true
	} );
};


jQuery.fn.extend( {
	wrapAll: function( html ) {
		var wrap;

		if ( jQuery.isFunction( html ) ) {
			return this.each( function( i ) {
				jQuery( this ).wrapAll( html.call( this, i ) );
			} );
		}

		if ( this[ 0 ] ) {

			// The elements to wrap the target around
			wrap = jQuery( html, this[ 0 ].ownerDocument ).eq( 0 ).clone( true );

			if ( this[ 0 ].parentNode ) {
				wrap.insertBefore( this[ 0 ] );
			}

			wrap.map( function() {
				var elem = this;

				while ( elem.firstElementChild ) {
					elem = elem.firstElementChild;
				}

				return elem;
			} ).append( this );
		}

		return this;
	},

	wrapInner: function( html ) {
		if ( jQuery.isFunction( html ) ) {
			return this.each( function( i ) {
				jQuery( this ).wrapInner( html.call( this, i ) );
			} );
		}

		return this.each( function() {
			var self = jQuery( this ),
				contents = self.contents();

			if ( contents.length ) {
				contents.wrapAll( html );

			} else {
				self.append( html );
			}
		} );
	},

	wrap: function( html ) {
		var isFunction = jQuery.isFunction( html );

		return this.each( function( i ) {
			jQuery( this ).wrapAll( isFunction ? html.call( this, i ) : html );
		} );
	},

	unwrap: function() {
		return this.parent().each( function() {
			if ( !jQuery.nodeName( this, "body" ) ) {
				jQuery( this ).replaceWith( this.childNodes );
			}
		} ).end();
	}
} );


jQuery.expr.filters.hidden = function( elem ) {
	return !jQuery.expr.filters.visible( elem );
};
jQuery.expr.filters.visible = function( elem ) {

	// Support: Opera <= 12.12
	// Opera reports offsetWidths and offsetHeights less than zero on some elements
	// Use OR instead of AND as the element is not visible if either is true
	// See tickets #10406 and #13132
	return elem.offsetWidth > 0 || elem.offsetHeight > 0 || elem.getClientRects().length > 0;
};




var r20 = /%20/g,
	rbracket = /\[\]$/,
	rCRLF = /\r?\n/g,
	rsubmitterTypes = /^(?:submit|button|image|reset|file)$/i,
	rsubmittable = /^(?:input|select|textarea|keygen)/i;

function buildParams( prefix, obj, traditional, add ) {
	var name;

	if ( jQuery.isArray( obj ) ) {

		// Serialize array item.
		jQuery.each( obj, function( i, v ) {
			if ( traditional || rbracket.test( prefix ) ) {

				// Treat each array item as a scalar.
				add( prefix, v );

			} else {

				// Item is non-scalar (array or object), encode its numeric index.
				buildParams(
					prefix + "[" + ( typeof v === "object" && v != null ? i : "" ) + "]",
					v,
					traditional,
					add
				);
			}
		} );

	} else if ( !traditional && jQuery.type( obj ) === "object" ) {

		// Serialize object item.
		for ( name in obj ) {
			buildParams( prefix + "[" + name + "]", obj[ name ], traditional, add );
		}

	} else {

		// Serialize scalar item.
		add( prefix, obj );
	}
}

// Serialize an array of form elements or a set of
// key/values into a query string
jQuery.param = function( a, traditional ) {
	var prefix,
		s = [],
		add = function( key, value ) {

			// If value is a function, invoke it and return its value
			value = jQuery.isFunction( value ) ? value() : ( value == null ? "" : value );
			s[ s.length ] = encodeURIComponent( key ) + "=" + encodeURIComponent( value );
		};

	// Set traditional to true for jQuery <= 1.3.2 behavior.
	if ( traditional === undefined ) {
		traditional = jQuery.ajaxSettings && jQuery.ajaxSettings.traditional;
	}

	// If an array was passed in, assume that it is an array of form elements.
	if ( jQuery.isArray( a ) || ( a.jquery && !jQuery.isPlainObject( a ) ) ) {

		// Serialize the form elements
		jQuery.each( a, function() {
			add( this.name, this.value );
		} );

	} else {

		// If traditional, encode the "old" way (the way 1.3.2 or older
		// did it), otherwise encode params recursively.
		for ( prefix in a ) {
			buildParams( prefix, a[ prefix ], traditional, add );
		}
	}

	// Return the resulting serialization
	return s.join( "&" ).replace( r20, "+" );
};

jQuery.fn.extend( {
	serialize: function() {
		return jQuery.param( this.serializeArray() );
	},
	serializeArray: function() {
		return this.map( function() {

			// Can add propHook for "elements" to filter or add form elements
			var elements = jQuery.prop( this, "elements" );
			return elements ? jQuery.makeArray( elements ) : this;
		} )
		.filter( function() {
			var type = this.type;

			// Use .is( ":disabled" ) so that fieldset[disabled] works
			return this.name && !jQuery( this ).is( ":disabled" ) &&
				rsubmittable.test( this.nodeName ) && !rsubmitterTypes.test( type ) &&
				( this.checked || !rcheckableType.test( type ) );
		} )
		.map( function( i, elem ) {
			var val = jQuery( this ).val();

			return val == null ?
				null :
				jQuery.isArray( val ) ?
					jQuery.map( val, function( val ) {
						return { name: elem.name, value: val.replace( rCRLF, "\r\n" ) };
					} ) :
					{ name: elem.name, value: val.replace( rCRLF, "\r\n" ) };
		} ).get();
	}
} );


jQuery.ajaxSettings.xhr = function() {
	try {
		return new window.XMLHttpRequest();
	} catch ( e ) {}
};

var xhrSuccessStatus = {

		// File protocol always yields status code 0, assume 200
		0: 200,

		// Support: IE9
		// #1450: sometimes IE returns 1223 when it should be 204
		1223: 204
	},
	xhrSupported = jQuery.ajaxSettings.xhr();

support.cors = !!xhrSupported && ( "withCredentials" in xhrSupported );
support.ajax = xhrSupported = !!xhrSupported;

jQuery.ajaxTransport( function( options ) {
	var callback, errorCallback;

	// Cross domain only allowed if supported through XMLHttpRequest
	if ( support.cors || xhrSupported && !options.crossDomain ) {
		return {
			send: function( headers, complete ) {
				var i,
					xhr = options.xhr();

				xhr.open(
					options.type,
					options.url,
					options.async,
					options.username,
					options.password
				);

				// Apply custom fields if provided
				if ( options.xhrFields ) {
					for ( i in options.xhrFields ) {
						xhr[ i ] = options.xhrFields[ i ];
					}
				}

				// Override mime type if needed
				if ( options.mimeType && xhr.overrideMimeType ) {
					xhr.overrideMimeType( options.mimeType );
				}

				// X-Requested-With header
				// For cross-domain requests, seeing as conditions for a preflight are
				// akin to a jigsaw puzzle, we simply never set it to be sure.
				// (it can always be set on a per-request basis or even using ajaxSetup)
				// For same-domain requests, won't change header if already provided.
				if ( !options.crossDomain && !headers[ "X-Requested-With" ] ) {
					headers[ "X-Requested-With" ] = "XMLHttpRequest";
				}

				// Set headers
				for ( i in headers ) {
					xhr.setRequestHeader( i, headers[ i ] );
				}

				// Callback
				callback = function( type ) {
					return function() {
						if ( callback ) {
							callback = errorCallback = xhr.onload =
								xhr.onerror = xhr.onabort = xhr.onreadystatechange = null;

							if ( type === "abort" ) {
								xhr.abort();
							} else if ( type === "error" ) {

								// Support: IE9
								// On a manual native abort, IE9 throws
								// errors on any property access that is not readyState
								if ( typeof xhr.status !== "number" ) {
									complete( 0, "error" );
								} else {
									complete(

										// File: protocol always yields status 0; see #8605, #14207
										xhr.status,
										xhr.statusText
									);
								}
							} else {
								complete(
									xhrSuccessStatus[ xhr.status ] || xhr.status,
									xhr.statusText,

									// Support: IE9 only
									// IE9 has no XHR2 but throws on binary (trac-11426)
									// For XHR2 non-text, let the caller handle it (gh-2498)
									( xhr.responseType || "text" ) !== "text"  ||
									typeof xhr.responseText !== "string" ?
										{ binary: xhr.response } :
										{ text: xhr.responseText },
									xhr.getAllResponseHeaders()
								);
							}
						}
					};
				};

				// Listen to events
				xhr.onload = callback();
				errorCallback = xhr.onerror = callback( "error" );

				// Support: IE9
				// Use onreadystatechange to replace onabort
				// to handle uncaught aborts
				if ( xhr.onabort !== undefined ) {
					xhr.onabort = errorCallback;
				} else {
					xhr.onreadystatechange = function() {

						// Check readyState before timeout as it changes
						if ( xhr.readyState === 4 ) {

							// Allow onerror to be called first,
							// but that will not handle a native abort
							// Also, save errorCallback to a variable
							// as xhr.onerror cannot be accessed
							window.setTimeout( function() {
								if ( callback ) {
									errorCallback();
								}
							} );
						}
					};
				}

				// Create the abort callback
				callback = callback( "abort" );

				try {

					// Do send the request (this may raise an exception)
					xhr.send( options.hasContent && options.data || null );
				} catch ( e ) {

					// #14683: Only rethrow if this hasn't been notified as an error yet
					if ( callback ) {
						throw e;
					}
				}
			},

			abort: function() {
				if ( callback ) {
					callback();
				}
			}
		};
	}
} );




// Install script dataType
jQuery.ajaxSetup( {
	accepts: {
		script: "text/javascript, application/javascript, " +
			"application/ecmascript, application/x-ecmascript"
	},
	contents: {
		script: /\b(?:java|ecma)script\b/
	},
	converters: {
		"text script": function( text ) {
			jQuery.globalEval( text );
			return text;
		}
	}
} );

// Handle cache's special case and crossDomain
jQuery.ajaxPrefilter( "script", function( s ) {
	if ( s.cache === undefined ) {
		s.cache = false;
	}
	if ( s.crossDomain ) {
		s.type = "GET";
	}
} );

// Bind script tag hack transport
jQuery.ajaxTransport( "script", function( s ) {

	// This transport only deals with cross domain requests
	if ( s.crossDomain ) {
		var script, callback;
		return {
			send: function( _, complete ) {
				script = jQuery( "<script>" ).prop( {
					charset: s.scriptCharset,
					src: s.url
				} ).on(
					"load error",
					callback = function( evt ) {
						script.remove();
						callback = null;
						if ( evt ) {
							complete( evt.type === "error" ? 404 : 200, evt.type );
						}
					}
				);

				// Use native DOM manipulation to avoid our domManip AJAX trickery
				document.head.appendChild( script[ 0 ] );
			},
			abort: function() {
				if ( callback ) {
					callback();
				}
			}
		};
	}
} );




var oldCallbacks = [],
	rjsonp = /(=)\?(?=&|$)|\?\?/;

// Default jsonp settings
jQuery.ajaxSetup( {
	jsonp: "callback",
	jsonpCallback: function() {
		var callback = oldCallbacks.pop() || ( jQuery.expando + "_" + ( nonce++ ) );
		this[ callback ] = true;
		return callback;
	}
} );

// Detect, normalize options and install callbacks for jsonp requests
jQuery.ajaxPrefilter( "json jsonp", function( s, originalSettings, jqXHR ) {

	var callbackName, overwritten, responseContainer,
		jsonProp = s.jsonp !== false && ( rjsonp.test( s.url ) ?
			"url" :
			typeof s.data === "string" &&
				( s.contentType || "" )
					.indexOf( "application/x-www-form-urlencoded" ) === 0 &&
				rjsonp.test( s.data ) && "data"
		);

	// Handle iff the expected data type is "jsonp" or we have a parameter to set
	if ( jsonProp || s.dataTypes[ 0 ] === "jsonp" ) {

		// Get callback name, remembering preexisting value associated with it
		callbackName = s.jsonpCallback = jQuery.isFunction( s.jsonpCallback ) ?
			s.jsonpCallback() :
			s.jsonpCallback;

		// Insert callback into url or form data
		if ( jsonProp ) {
			s[ jsonProp ] = s[ jsonProp ].replace( rjsonp, "$1" + callbackName );
		} else if ( s.jsonp !== false ) {
			s.url += ( rquery.test( s.url ) ? "&" : "?" ) + s.jsonp + "=" + callbackName;
		}

		// Use data converter to retrieve json after script execution
		s.converters[ "script json" ] = function() {
			if ( !responseContainer ) {
				jQuery.error( callbackName + " was not called" );
			}
			return responseContainer[ 0 ];
		};

		// Force json dataType
		s.dataTypes[ 0 ] = "json";

		// Install callback
		overwritten = window[ callbackName ];
		window[ callbackName ] = function() {
			responseContainer = arguments;
		};

		// Clean-up function (fires after converters)
		jqXHR.always( function() {

			// If previous value didn't exist - remove it
			if ( overwritten === undefined ) {
				jQuery( window ).removeProp( callbackName );

			// Otherwise restore preexisting value
			} else {
				window[ callbackName ] = overwritten;
			}

			// Save back as free
			if ( s[ callbackName ] ) {

				// Make sure that re-using the options doesn't screw things around
				s.jsonpCallback = originalSettings.jsonpCallback;

				// Save the callback name for future use
				oldCallbacks.push( callbackName );
			}

			// Call if it was a function and we have a response
			if ( responseContainer && jQuery.isFunction( overwritten ) ) {
				overwritten( responseContainer[ 0 ] );
			}

			responseContainer = overwritten = undefined;
		} );

		// Delegate to script
		return "script";
	}
} );




// Argument "data" should be string of html
// context (optional): If specified, the fragment will be created in this context,
// defaults to document
// keepScripts (optional): If true, will include scripts passed in the html string
jQuery.parseHTML = function( data, context, keepScripts ) {
	if ( !data || typeof data !== "string" ) {
		return null;
	}
	if ( typeof context === "boolean" ) {
		keepScripts = context;
		context = false;
	}
	context = context || document;

	var parsed = rsingleTag.exec( data ),
		scripts = !keepScripts && [];

	// Single tag
	if ( parsed ) {
		return [ context.createElement( parsed[ 1 ] ) ];
	}

	parsed = buildFragment( [ data ], context, scripts );

	if ( scripts && scripts.length ) {
		jQuery( scripts ).remove();
	}

	return jQuery.merge( [], parsed.childNodes );
};


// Keep a copy of the old load method
var _load = jQuery.fn.load;

/**
 * Load a url into a page
 */
jQuery.fn.load = function( url, params, callback ) {
	if ( typeof url !== "string" && _load ) {
		return _load.apply( this, arguments );
	}

	var selector, type, response,
		self = this,
		off = url.indexOf( " " );

	if ( off > -1 ) {
		selector = jQuery.trim( url.slice( off ) );
		url = url.slice( 0, off );
	}

	// If it's a function
	if ( jQuery.isFunction( params ) ) {

		// We assume that it's the callback
		callback = params;
		params = undefined;

	// Otherwise, build a param string
	} else if ( params && typeof params === "object" ) {
		type = "POST";
	}

	// If we have elements to modify, make the request
	if ( self.length > 0 ) {
		jQuery.ajax( {
			url: url,

			// If "type" variable is undefined, then "GET" method will be used.
			// Make value of this field explicit since
			// user can override it through ajaxSetup method
			type: type || "GET",
			dataType: "html",
			data: params
		} ).done( function( responseText ) {

			// Save response for use in complete callback
			response = arguments;

			self.html( selector ?

				// If a selector was specified, locate the right elements in a dummy div
				// Exclude scripts to avoid IE 'Permission Denied' errors
				jQuery( "<div>" ).append( jQuery.parseHTML( responseText ) ).find( selector ) :

				// Otherwise use the full result
				responseText );

		// If the request succeeds, this function gets "data", "status", "jqXHR"
		// but they are ignored because response was set above.
		// If it fails, this function gets "jqXHR", "status", "error"
		} ).always( callback && function( jqXHR, status ) {
			self.each( function() {
				callback.apply( this, response || [ jqXHR.responseText, status, jqXHR ] );
			} );
		} );
	}

	return this;
};




// Attach a bunch of functions for handling common AJAX events
jQuery.each( [
	"ajaxStart",
	"ajaxStop",
	"ajaxComplete",
	"ajaxError",
	"ajaxSuccess",
	"ajaxSend"
], function( i, type ) {
	jQuery.fn[ type ] = function( fn ) {
		return this.on( type, fn );
	};
} );




jQuery.expr.filters.animated = function( elem ) {
	return jQuery.grep( jQuery.timers, function( fn ) {
		return elem === fn.elem;
	} ).length;
};




/**
 * Gets a window from an element
 */
function getWindow( elem ) {
	return jQuery.isWindow( elem ) ? elem : elem.nodeType === 9 && elem.defaultView;
}

jQuery.offset = {
	setOffset: function( elem, options, i ) {
		var curPosition, curLeft, curCSSTop, curTop, curOffset, curCSSLeft, calculatePosition,
			position = jQuery.css( elem, "position" ),
			curElem = jQuery( elem ),
			props = {};

		// Set position first, in-case top/left are set even on static elem
		if ( position === "static" ) {
			elem.style.position = "relative";
		}

		curOffset = curElem.offset();
		curCSSTop = jQuery.css( elem, "top" );
		curCSSLeft = jQuery.css( elem, "left" );
		calculatePosition = ( position === "absolute" || position === "fixed" ) &&
			( curCSSTop + curCSSLeft ).indexOf( "auto" ) > -1;

		// Need to be able to calculate position if either
		// top or left is auto and position is either absolute or fixed
		if ( calculatePosition ) {
			curPosition = curElem.position();
			curTop = curPosition.top;
			curLeft = curPosition.left;

		} else {
			curTop = parseFloat( curCSSTop ) || 0;
			curLeft = parseFloat( curCSSLeft ) || 0;
		}

		if ( jQuery.isFunction( options ) ) {

			// Use jQuery.extend here to allow modification of coordinates argument (gh-1848)
			options = options.call( elem, i, jQuery.extend( {}, curOffset ) );
		}

		if ( options.top != null ) {
			props.top = ( options.top - curOffset.top ) + curTop;
		}
		if ( options.left != null ) {
			props.left = ( options.left - curOffset.left ) + curLeft;
		}

		if ( "using" in options ) {
			options.using.call( elem, props );

		} else {
			curElem.css( props );
		}
	}
};

jQuery.fn.extend( {
	offset: function( options ) {
		if ( arguments.length ) {
			return options === undefined ?
				this :
				this.each( function( i ) {
					jQuery.offset.setOffset( this, options, i );
				} );
		}

		var docElem, win,
			elem = this[ 0 ],
			box = { top: 0, left: 0 },
			doc = elem && elem.ownerDocument;

		if ( !doc ) {
			return;
		}

		docElem = doc.documentElement;

		// Make sure it's not a disconnected DOM node
		if ( !jQuery.contains( docElem, elem ) ) {
			return box;
		}

		box = elem.getBoundingClientRect();
		win = getWindow( doc );
		return {
			top: box.top + win.pageYOffset - docElem.clientTop,
			left: box.left + win.pageXOffset - docElem.clientLeft
		};
	},

	position: function() {
		if ( !this[ 0 ] ) {
			return;
		}

		var offsetParent, offset,
			elem = this[ 0 ],
			parentOffset = { top: 0, left: 0 };

		// Fixed elements are offset from window (parentOffset = {top:0, left: 0},
		// because it is its only offset parent
		if ( jQuery.css( elem, "position" ) === "fixed" ) {

			// Assume getBoundingClientRect is there when computed position is fixed
			offset = elem.getBoundingClientRect();

		} else {

			// Get *real* offsetParent
			offsetParent = this.offsetParent();

			// Get correct offsets
			offset = this.offset();
			if ( !jQuery.nodeName( offsetParent[ 0 ], "html" ) ) {
				parentOffset = offsetParent.offset();
			}

			// Add offsetParent borders
			parentOffset.top += jQuery.css( offsetParent[ 0 ], "borderTopWidth", true );
			parentOffset.left += jQuery.css( offsetParent[ 0 ], "borderLeftWidth", true );
		}

		// Subtract parent offsets and element margins
		return {
			top: offset.top - parentOffset.top - jQuery.css( elem, "marginTop", true ),
			left: offset.left - parentOffset.left - jQuery.css( elem, "marginLeft", true )
		};
	},

	// This method will return documentElement in the following cases:
	// 1) For the element inside the iframe without offsetParent, this method will return
	//    documentElement of the parent window
	// 2) For the hidden or detached element
	// 3) For body or html element, i.e. in case of the html node - it will return itself
	//
	// but those exceptions were never presented as a real life use-cases
	// and might be considered as more preferable results.
	//
	// This logic, however, is not guaranteed and can change at any point in the future
	offsetParent: function() {
		return this.map( function() {
			var offsetParent = this.offsetParent;

			while ( offsetParent && jQuery.css( offsetParent, "position" ) === "static" ) {
				offsetParent = offsetParent.offsetParent;
			}

			return offsetParent || documentElement;
		} );
	}
} );

// Create scrollLeft and scrollTop methods
jQuery.each( { scrollLeft: "pageXOffset", scrollTop: "pageYOffset" }, function( method, prop ) {
	var top = "pageYOffset" === prop;

	jQuery.fn[ method ] = function( val ) {
		return access( this, function( elem, method, val ) {
			var win = getWindow( elem );

			if ( val === undefined ) {
				return win ? win[ prop ] : elem[ method ];
			}

			if ( win ) {
				win.scrollTo(
					!top ? val : win.pageXOffset,
					top ? val : win.pageYOffset
				);

			} else {
				elem[ method ] = val;
			}
		}, method, val, arguments.length );
	};
} );

// Support: Safari<7-8+, Chrome<37-44+
// Add the top/left cssHooks using jQuery.fn.position
// Webkit bug: https://bugs.webkit.org/show_bug.cgi?id=29084
// Blink bug: https://code.google.com/p/chromium/issues/detail?id=229280
// getComputedStyle returns percent when specified for top/left/bottom/right;
// rather than make the css module depend on the offset module, just check for it here
jQuery.each( [ "top", "left" ], function( i, prop ) {
	jQuery.cssHooks[ prop ] = addGetHookIf( support.pixelPosition,
		function( elem, computed ) {
			if ( computed ) {
				computed = curCSS( elem, prop );

				// If curCSS returns percentage, fallback to offset
				return rnumnonpx.test( computed ) ?
					jQuery( elem ).position()[ prop ] + "px" :
					computed;
			}
		}
	);
} );


// Create innerHeight, innerWidth, height, width, outerHeight and outerWidth methods
jQuery.each( { Height: "height", Width: "width" }, function( name, type ) {
	jQuery.each( { padding: "inner" + name, content: type, "": "outer" + name },
		function( defaultExtra, funcName ) {

		// Margin is only for outerHeight, outerWidth
		jQuery.fn[ funcName ] = function( margin, value ) {
			var chainable = arguments.length && ( defaultExtra || typeof margin !== "boolean" ),
				extra = defaultExtra || ( margin === true || value === true ? "margin" : "border" );

			return access( this, function( elem, type, value ) {
				var doc;

				if ( jQuery.isWindow( elem ) ) {

					// As of 5/8/2012 this will yield incorrect results for Mobile Safari, but there
					// isn't a whole lot we can do. See pull request at this URL for discussion:
					// https://github.com/jquery/jquery/pull/764
					return elem.document.documentElement[ "client" + name ];
				}

				// Get document width or height
				if ( elem.nodeType === 9 ) {
					doc = elem.documentElement;

					// Either scroll[Width/Height] or offset[Width/Height] or client[Width/Height],
					// whichever is greatest
					return Math.max(
						elem.body[ "scroll" + name ], doc[ "scroll" + name ],
						elem.body[ "offset" + name ], doc[ "offset" + name ],
						doc[ "client" + name ]
					);
				}

				return value === undefined ?

					// Get width or height on the element, requesting but not forcing parseFloat
					jQuery.css( elem, type, extra ) :

					// Set width or height on the element
					jQuery.style( elem, type, value, extra );
			}, type, chainable ? margin : undefined, chainable, null );
		};
	} );
} );


jQuery.fn.extend( {

	bind: function( types, data, fn ) {
		return this.on( types, null, data, fn );
	},
	unbind: function( types, fn ) {
		return this.off( types, null, fn );
	},

	delegate: function( selector, types, data, fn ) {
		return this.on( types, selector, data, fn );
	},
	undelegate: function( selector, types, fn ) {

		// ( namespace ) or ( selector, types [, fn] )
		return arguments.length === 1 ?
			this.off( selector, "**" ) :
			this.off( types, selector || "**", fn );
	},
	size: function() {
		return this.length;
	}
} );

jQuery.fn.andSelf = jQuery.fn.addBack;




// Register as a named AMD module, since jQuery can be concatenated with other
// files that may use define, but not via a proper concatenation script that
// understands anonymous AMD modules. A named AMD is safest and most robust
// way to register. Lowercase jquery is used because AMD module names are
// derived from file names, and jQuery is normally delivered in a lowercase
// file name. Do this after creating the global so that if an AMD module wants
// to call noConflict to hide this version of jQuery, it will work.

// Note that for maximum portability, libraries that are not jQuery should
// declare themselves as anonymous modules, and avoid setting a global if an
// AMD loader is present. jQuery is a special case. For more information, see
// https://github.com/jrburke/requirejs/wiki/Updating-existing-libraries#wiki-anon

if ( typeof define === "function" && define.amd ) {
	define( "jquery", [], function() {
		return jQuery;
	} );
}



var

	// Map over jQuery in case of overwrite
	_jQuery = window.jQuery,

	// Map over the $ in case of overwrite
	_$ = window.$;

jQuery.noConflict = function( deep ) {
	if ( window.$ === jQuery ) {
		window.$ = _$;
	}

	if ( deep && window.jQuery === jQuery ) {
		window.jQuery = _jQuery;
	}

	return jQuery;
};

// Expose jQuery and $ identifiers, even in AMD
// (#7102#comment:10, https://github.com/jquery/jquery/pull/557)
// and CommonJS for browser emulators (#13566)
if ( !noGlobal ) {
	window.jQuery = window.$ = jQuery;
}

return jQuery;
}));

//     Underscore.js 1.8.3
//     http://underscorejs.org
//     (c) 2009-2015 Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
//     Underscore may be freely distributed under the MIT license.

(function() {

  // Baseline setup
  // --------------

  // Establish the root object, `window` in the browser, or `exports` on the server.
  var root = this;

  // Save the previous value of the `_` variable.
  var previousUnderscore = root._;

  // Save bytes in the minified (but not gzipped) version:
  var ArrayProto = Array.prototype, ObjProto = Object.prototype, FuncProto = Function.prototype;

  // Create quick reference variables for speed access to core prototypes.
  var
    push             = ArrayProto.push,
    slice            = ArrayProto.slice,
    toString         = ObjProto.toString,
    hasOwnProperty   = ObjProto.hasOwnProperty;

  // All **ECMAScript 5** native function implementations that we hope to use
  // are declared here.
  var
    nativeIsArray      = Array.isArray,
    nativeKeys         = Object.keys,
    nativeBind         = FuncProto.bind,
    nativeCreate       = Object.create;

  // Naked function reference for surrogate-prototype-swapping.
  var Ctor = function(){};

  // Create a safe reference to the Underscore object for use below.
  var _ = function(obj) {
    if (obj instanceof _) return obj;
    if (!(this instanceof _)) return new _(obj);
    this._wrapped = obj;
  };

  // Export the Underscore object for **Node.js**, with
  // backwards-compatibility for the old `require()` API. If we're in
  // the browser, add `_` as a global object.
  if (typeof exports !== 'undefined') {
    if (typeof module !== 'undefined' && module.exports) {
      exports = module.exports = _;
    }
    exports._ = _;
  } else {
    root._ = _;
  }

  // Current version.
  _.VERSION = '1.8.3';

  // Internal function that returns an efficient (for current engines) version
  // of the passed-in callback, to be repeatedly applied in other Underscore
  // functions.
  var optimizeCb = function(func, context, argCount) {
    if (context === void 0) return func;
    switch (argCount == null ? 3 : argCount) {
      case 1: return function(value) {
        return func.call(context, value);
      };
      case 2: return function(value, other) {
        return func.call(context, value, other);
      };
      case 3: return function(value, index, collection) {
        return func.call(context, value, index, collection);
      };
      case 4: return function(accumulator, value, index, collection) {
        return func.call(context, accumulator, value, index, collection);
      };
    }
    return function() {
      return func.apply(context, arguments);
    };
  };

  // A mostly-internal function to generate callbacks that can be applied
  // to each element in a collection, returning the desired result — either
  // identity, an arbitrary callback, a property matcher, or a property accessor.
  var cb = function(value, context, argCount) {
    if (value == null) return _.identity;
    if (_.isFunction(value)) return optimizeCb(value, context, argCount);
    if (_.isObject(value)) return _.matcher(value);
    return _.property(value);
  };
  _.iteratee = function(value, context) {
    return cb(value, context, Infinity);
  };

  // An internal function for creating assigner functions.
  var createAssigner = function(keysFunc, undefinedOnly) {
    return function(obj) {
      var length = arguments.length;
      if (length < 2 || obj == null) return obj;
      for (var index = 1; index < length; index++) {
        var source = arguments[index],
            keys = keysFunc(source),
            l = keys.length;
        for (var i = 0; i < l; i++) {
          var key = keys[i];
          if (!undefinedOnly || obj[key] === void 0) obj[key] = source[key];
        }
      }
      return obj;
    };
  };

  // An internal function for creating a new object that inherits from another.
  var baseCreate = function(prototype) {
    if (!_.isObject(prototype)) return {};
    if (nativeCreate) return nativeCreate(prototype);
    Ctor.prototype = prototype;
    var result = new Ctor;
    Ctor.prototype = null;
    return result;
  };

  var property = function(key) {
    return function(obj) {
      return obj == null ? void 0 : obj[key];
    };
  };

  // Helper for collection methods to determine whether a collection
  // should be iterated as an array or as an object
  // Related: http://people.mozilla.org/~jorendorff/es6-draft.html#sec-tolength
  // Avoids a very nasty iOS 8 JIT bug on ARM-64. #2094
  var MAX_ARRAY_INDEX = Math.pow(2, 53) - 1;
  var getLength = property('length');
  var isArrayLike = function(collection) {
    var length = getLength(collection);
    return typeof length == 'number' && length >= 0 && length <= MAX_ARRAY_INDEX;
  };

  // Collection Functions
  // --------------------

  // The cornerstone, an `each` implementation, aka `forEach`.
  // Handles raw objects in addition to array-likes. Treats all
  // sparse array-likes as if they were dense.
  _.each = _.forEach = function(obj, iteratee, context) {
    iteratee = optimizeCb(iteratee, context);
    var i, length;
    if (isArrayLike(obj)) {
      for (i = 0, length = obj.length; i < length; i++) {
        iteratee(obj[i], i, obj);
      }
    } else {
      var keys = _.keys(obj);
      for (i = 0, length = keys.length; i < length; i++) {
        iteratee(obj[keys[i]], keys[i], obj);
      }
    }
    return obj;
  };

  // Return the results of applying the iteratee to each element.
  _.map = _.collect = function(obj, iteratee, context) {
    iteratee = cb(iteratee, context);
    var keys = !isArrayLike(obj) && _.keys(obj),
        length = (keys || obj).length,
        results = Array(length);
    for (var index = 0; index < length; index++) {
      var currentKey = keys ? keys[index] : index;
      results[index] = iteratee(obj[currentKey], currentKey, obj);
    }
    return results;
  };

  // Create a reducing function iterating left or right.
  function createReduce(dir) {
    // Optimized iterator function as using arguments.length
    // in the main function will deoptimize the, see #1991.
    function iterator(obj, iteratee, memo, keys, index, length) {
      for (; index >= 0 && index < length; index += dir) {
        var currentKey = keys ? keys[index] : index;
        memo = iteratee(memo, obj[currentKey], currentKey, obj);
      }
      return memo;
    }

    return function(obj, iteratee, memo, context) {
      iteratee = optimizeCb(iteratee, context, 4);
      var keys = !isArrayLike(obj) && _.keys(obj),
          length = (keys || obj).length,
          index = dir > 0 ? 0 : length - 1;
      // Determine the initial value if none is provided.
      if (arguments.length < 3) {
        memo = obj[keys ? keys[index] : index];
        index += dir;
      }
      return iterator(obj, iteratee, memo, keys, index, length);
    };
  }

  // **Reduce** builds up a single result from a list of values, aka `inject`,
  // or `foldl`.
  _.reduce = _.foldl = _.inject = createReduce(1);

  // The right-associative version of reduce, also known as `foldr`.
  _.reduceRight = _.foldr = createReduce(-1);

  // Return the first value which passes a truth test. Aliased as `detect`.
  _.find = _.detect = function(obj, predicate, context) {
    var key;
    if (isArrayLike(obj)) {
      key = _.findIndex(obj, predicate, context);
    } else {
      key = _.findKey(obj, predicate, context);
    }
    if (key !== void 0 && key !== -1) return obj[key];
  };

  // Return all the elements that pass a truth test.
  // Aliased as `select`.
  _.filter = _.select = function(obj, predicate, context) {
    var results = [];
    predicate = cb(predicate, context);
    _.each(obj, function(value, index, list) {
      if (predicate(value, index, list)) results.push(value);
    });
    return results;
  };

  // Return all the elements for which a truth test fails.
  _.reject = function(obj, predicate, context) {
    return _.filter(obj, _.negate(cb(predicate)), context);
  };

  // Determine whether all of the elements match a truth test.
  // Aliased as `all`.
  _.every = _.all = function(obj, predicate, context) {
    predicate = cb(predicate, context);
    var keys = !isArrayLike(obj) && _.keys(obj),
        length = (keys || obj).length;
    for (var index = 0; index < length; index++) {
      var currentKey = keys ? keys[index] : index;
      if (!predicate(obj[currentKey], currentKey, obj)) return false;
    }
    return true;
  };

  // Determine if at least one element in the object matches a truth test.
  // Aliased as `any`.
  _.some = _.any = function(obj, predicate, context) {
    predicate = cb(predicate, context);
    var keys = !isArrayLike(obj) && _.keys(obj),
        length = (keys || obj).length;
    for (var index = 0; index < length; index++) {
      var currentKey = keys ? keys[index] : index;
      if (predicate(obj[currentKey], currentKey, obj)) return true;
    }
    return false;
  };

  // Determine if the array or object contains a given item (using `===`).
  // Aliased as `includes` and `include`.
  _.contains = _.includes = _.include = function(obj, item, fromIndex, guard) {
    if (!isArrayLike(obj)) obj = _.values(obj);
    if (typeof fromIndex != 'number' || guard) fromIndex = 0;
    return _.indexOf(obj, item, fromIndex) >= 0;
  };

  // Invoke a method (with arguments) on every item in a collection.
  _.invoke = function(obj, method) {
    var args = slice.call(arguments, 2);
    var isFunc = _.isFunction(method);
    return _.map(obj, function(value) {
      var func = isFunc ? method : value[method];
      return func == null ? func : func.apply(value, args);
    });
  };

  // Convenience version of a common use case of `map`: fetching a property.
  _.pluck = function(obj, key) {
    return _.map(obj, _.property(key));
  };

  // Convenience version of a common use case of `filter`: selecting only objects
  // containing specific `key:value` pairs.
  _.where = function(obj, attrs) {
    return _.filter(obj, _.matcher(attrs));
  };

  // Convenience version of a common use case of `find`: getting the first object
  // containing specific `key:value` pairs.
  _.findWhere = function(obj, attrs) {
    return _.find(obj, _.matcher(attrs));
  };

  // Return the maximum element (or element-based computation).
  _.max = function(obj, iteratee, context) {
    var result = -Infinity, lastComputed = -Infinity,
        value, computed;
    if (iteratee == null && obj != null) {
      obj = isArrayLike(obj) ? obj : _.values(obj);
      for (var i = 0, length = obj.length; i < length; i++) {
        value = obj[i];
        if (value > result) {
          result = value;
        }
      }
    } else {
      iteratee = cb(iteratee, context);
      _.each(obj, function(value, index, list) {
        computed = iteratee(value, index, list);
        if (computed > lastComputed || computed === -Infinity && result === -Infinity) {
          result = value;
          lastComputed = computed;
        }
      });
    }
    return result;
  };

  // Return the minimum element (or element-based computation).
  _.min = function(obj, iteratee, context) {
    var result = Infinity, lastComputed = Infinity,
        value, computed;
    if (iteratee == null && obj != null) {
      obj = isArrayLike(obj) ? obj : _.values(obj);
      for (var i = 0, length = obj.length; i < length; i++) {
        value = obj[i];
        if (value < result) {
          result = value;
        }
      }
    } else {
      iteratee = cb(iteratee, context);
      _.each(obj, function(value, index, list) {
        computed = iteratee(value, index, list);
        if (computed < lastComputed || computed === Infinity && result === Infinity) {
          result = value;
          lastComputed = computed;
        }
      });
    }
    return result;
  };

  // Shuffle a collection, using the modern version of the
  // [Fisher-Yates shuffle](http://en.wikipedia.org/wiki/Fisher–Yates_shuffle).
  _.shuffle = function(obj) {
    var set = isArrayLike(obj) ? obj : _.values(obj);
    var length = set.length;
    var shuffled = Array(length);
    for (var index = 0, rand; index < length; index++) {
      rand = _.random(0, index);
      if (rand !== index) shuffled[index] = shuffled[rand];
      shuffled[rand] = set[index];
    }
    return shuffled;
  };

  // Sample **n** random values from a collection.
  // If **n** is not specified, returns a single random element.
  // The internal `guard` argument allows it to work with `map`.
  _.sample = function(obj, n, guard) {
    if (n == null || guard) {
      if (!isArrayLike(obj)) obj = _.values(obj);
      return obj[_.random(obj.length - 1)];
    }
    return _.shuffle(obj).slice(0, Math.max(0, n));
  };

  // Sort the object's values by a criterion produced by an iteratee.
  _.sortBy = function(obj, iteratee, context) {
    iteratee = cb(iteratee, context);
    return _.pluck(_.map(obj, function(value, index, list) {
      return {
        value: value,
        index: index,
        criteria: iteratee(value, index, list)
      };
    }).sort(function(left, right) {
      var a = left.criteria;
      var b = right.criteria;
      if (a !== b) {
        if (a > b || a === void 0) return 1;
        if (a < b || b === void 0) return -1;
      }
      return left.index - right.index;
    }), 'value');
  };

  // An internal function used for aggregate "group by" operations.
  var group = function(behavior) {
    return function(obj, iteratee, context) {
      var result = {};
      iteratee = cb(iteratee, context);
      _.each(obj, function(value, index) {
        var key = iteratee(value, index, obj);
        behavior(result, value, key);
      });
      return result;
    };
  };

  // Groups the object's values by a criterion. Pass either a string attribute
  // to group by, or a function that returns the criterion.
  _.groupBy = group(function(result, value, key) {
    if (_.has(result, key)) result[key].push(value); else result[key] = [value];
  });

  // Indexes the object's values by a criterion, similar to `groupBy`, but for
  // when you know that your index values will be unique.
  _.indexBy = group(function(result, value, key) {
    result[key] = value;
  });

  // Counts instances of an object that group by a certain criterion. Pass
  // either a string attribute to count by, or a function that returns the
  // criterion.
  _.countBy = group(function(result, value, key) {
    if (_.has(result, key)) result[key]++; else result[key] = 1;
  });

  // Safely create a real, live array from anything iterable.
  _.toArray = function(obj) {
    if (!obj) return [];
    if (_.isArray(obj)) return slice.call(obj);
    if (isArrayLike(obj)) return _.map(obj, _.identity);
    return _.values(obj);
  };

  // Return the number of elements in an object.
  _.size = function(obj) {
    if (obj == null) return 0;
    return isArrayLike(obj) ? obj.length : _.keys(obj).length;
  };

  // Split a collection into two arrays: one whose elements all satisfy the given
  // predicate, and one whose elements all do not satisfy the predicate.
  _.partition = function(obj, predicate, context) {
    predicate = cb(predicate, context);
    var pass = [], fail = [];
    _.each(obj, function(value, key, obj) {
      (predicate(value, key, obj) ? pass : fail).push(value);
    });
    return [pass, fail];
  };

  // Array Functions
  // ---------------

  // Get the first element of an array. Passing **n** will return the first N
  // values in the array. Aliased as `head` and `take`. The **guard** check
  // allows it to work with `_.map`.
  _.first = _.head = _.take = function(array, n, guard) {
    if (array == null) return void 0;
    if (n == null || guard) return array[0];
    return _.initial(array, array.length - n);
  };

  // Returns everything but the last entry of the array. Especially useful on
  // the arguments object. Passing **n** will return all the values in
  // the array, excluding the last N.
  _.initial = function(array, n, guard) {
    return slice.call(array, 0, Math.max(0, array.length - (n == null || guard ? 1 : n)));
  };

  // Get the last element of an array. Passing **n** will return the last N
  // values in the array.
  _.last = function(array, n, guard) {
    if (array == null) return void 0;
    if (n == null || guard) return array[array.length - 1];
    return _.rest(array, Math.max(0, array.length - n));
  };

  // Returns everything but the first entry of the array. Aliased as `tail` and `drop`.
  // Especially useful on the arguments object. Passing an **n** will return
  // the rest N values in the array.
  _.rest = _.tail = _.drop = function(array, n, guard) {
    return slice.call(array, n == null || guard ? 1 : n);
  };

  // Trim out all falsy values from an array.
  _.compact = function(array) {
    return _.filter(array, _.identity);
  };

  // Internal implementation of a recursive `flatten` function.
  var flatten = function(input, shallow, strict, startIndex) {
    var output = [], idx = 0;
    for (var i = startIndex || 0, length = getLength(input); i < length; i++) {
      var value = input[i];
      if (isArrayLike(value) && (_.isArray(value) || _.isArguments(value))) {
        //flatten current level of array or arguments object
        if (!shallow) value = flatten(value, shallow, strict);
        var j = 0, len = value.length;
        output.length += len;
        while (j < len) {
          output[idx++] = value[j++];
        }
      } else if (!strict) {
        output[idx++] = value;
      }
    }
    return output;
  };

  // Flatten out an array, either recursively (by default), or just one level.
  _.flatten = function(array, shallow) {
    return flatten(array, shallow, false);
  };

  // Return a version of the array that does not contain the specified value(s).
  _.without = function(array) {
    return _.difference(array, slice.call(arguments, 1));
  };

  // Produce a duplicate-free version of the array. If the array has already
  // been sorted, you have the option of using a faster algorithm.
  // Aliased as `unique`.
  _.uniq = _.unique = function(array, isSorted, iteratee, context) {
    if (!_.isBoolean(isSorted)) {
      context = iteratee;
      iteratee = isSorted;
      isSorted = false;
    }
    if (iteratee != null) iteratee = cb(iteratee, context);
    var result = [];
    var seen = [];
    for (var i = 0, length = getLength(array); i < length; i++) {
      var value = array[i],
          computed = iteratee ? iteratee(value, i, array) : value;
      if (isSorted) {
        if (!i || seen !== computed) result.push(value);
        seen = computed;
      } else if (iteratee) {
        if (!_.contains(seen, computed)) {
          seen.push(computed);
          result.push(value);
        }
      } else if (!_.contains(result, value)) {
        result.push(value);
      }
    }
    return result;
  };

  // Produce an array that contains the union: each distinct element from all of
  // the passed-in arrays.
  _.union = function() {
    return _.uniq(flatten(arguments, true, true));
  };

  // Produce an array that contains every item shared between all the
  // passed-in arrays.
  _.intersection = function(array) {
    var result = [];
    var argsLength = arguments.length;
    for (var i = 0, length = getLength(array); i < length; i++) {
      var item = array[i];
      if (_.contains(result, item)) continue;
      for (var j = 1; j < argsLength; j++) {
        if (!_.contains(arguments[j], item)) break;
      }
      if (j === argsLength) result.push(item);
    }
    return result;
  };

  // Take the difference between one array and a number of other arrays.
  // Only the elements present in just the first array will remain.
  _.difference = function(array) {
    var rest = flatten(arguments, true, true, 1);
    return _.filter(array, function(value){
      return !_.contains(rest, value);
    });
  };

  // Zip together multiple lists into a single array -- elements that share
  // an index go together.
  _.zip = function() {
    return _.unzip(arguments);
  };

  // Complement of _.zip. Unzip accepts an array of arrays and groups
  // each array's elements on shared indices
  _.unzip = function(array) {
    var length = array && _.max(array, getLength).length || 0;
    var result = Array(length);

    for (var index = 0; index < length; index++) {
      result[index] = _.pluck(array, index);
    }
    return result;
  };

  // Converts lists into objects. Pass either a single array of `[key, value]`
  // pairs, or two parallel arrays of the same length -- one of keys, and one of
  // the corresponding values.
  _.object = function(list, values) {
    var result = {};
    for (var i = 0, length = getLength(list); i < length; i++) {
      if (values) {
        result[list[i]] = values[i];
      } else {
        result[list[i][0]] = list[i][1];
      }
    }
    return result;
  };

  // Generator function to create the findIndex and findLastIndex functions
  function createPredicateIndexFinder(dir) {
    return function(array, predicate, context) {
      predicate = cb(predicate, context);
      var length = getLength(array);
      var index = dir > 0 ? 0 : length - 1;
      for (; index >= 0 && index < length; index += dir) {
        if (predicate(array[index], index, array)) return index;
      }
      return -1;
    };
  }

  // Returns the first index on an array-like that passes a predicate test
  _.findIndex = createPredicateIndexFinder(1);
  _.findLastIndex = createPredicateIndexFinder(-1);

  // Use a comparator function to figure out the smallest index at which
  // an object should be inserted so as to maintain order. Uses binary search.
  _.sortedIndex = function(array, obj, iteratee, context) {
    iteratee = cb(iteratee, context, 1);
    var value = iteratee(obj);
    var low = 0, high = getLength(array);
    while (low < high) {
      var mid = Math.floor((low + high) / 2);
      if (iteratee(array[mid]) < value) low = mid + 1; else high = mid;
    }
    return low;
  };

  // Generator function to create the indexOf and lastIndexOf functions
  function createIndexFinder(dir, predicateFind, sortedIndex) {
    return function(array, item, idx) {
      var i = 0, length = getLength(array);
      if (typeof idx == 'number') {
        if (dir > 0) {
            i = idx >= 0 ? idx : Math.max(idx + length, i);
        } else {
            length = idx >= 0 ? Math.min(idx + 1, length) : idx + length + 1;
        }
      } else if (sortedIndex && idx && length) {
        idx = sortedIndex(array, item);
        return array[idx] === item ? idx : -1;
      }
      if (item !== item) {
        idx = predicateFind(slice.call(array, i, length), _.isNaN);
        return idx >= 0 ? idx + i : -1;
      }
      for (idx = dir > 0 ? i : length - 1; idx >= 0 && idx < length; idx += dir) {
        if (array[idx] === item) return idx;
      }
      return -1;
    };
  }

  // Return the position of the first occurrence of an item in an array,
  // or -1 if the item is not included in the array.
  // If the array is large and already in sort order, pass `true`
  // for **isSorted** to use binary search.
  _.indexOf = createIndexFinder(1, _.findIndex, _.sortedIndex);
  _.lastIndexOf = createIndexFinder(-1, _.findLastIndex);

  // Generate an integer Array containing an arithmetic progression. A port of
  // the native Python `range()` function. See
  // [the Python documentation](http://docs.python.org/library/functions.html#range).
  _.range = function(start, stop, step) {
    if (stop == null) {
      stop = start || 0;
      start = 0;
    }
    step = step || 1;

    var length = Math.max(Math.ceil((stop - start) / step), 0);
    var range = Array(length);

    for (var idx = 0; idx < length; idx++, start += step) {
      range[idx] = start;
    }

    return range;
  };

  // Function (ahem) Functions
  // ------------------

  // Determines whether to execute a function as a constructor
  // or a normal function with the provided arguments
  var executeBound = function(sourceFunc, boundFunc, context, callingContext, args) {
    if (!(callingContext instanceof boundFunc)) return sourceFunc.apply(context, args);
    var self = baseCreate(sourceFunc.prototype);
    var result = sourceFunc.apply(self, args);
    if (_.isObject(result)) return result;
    return self;
  };

  // Create a function bound to a given object (assigning `this`, and arguments,
  // optionally). Delegates to **ECMAScript 5**'s native `Function.bind` if
  // available.
  _.bind = function(func, context) {
    if (nativeBind && func.bind === nativeBind) return nativeBind.apply(func, slice.call(arguments, 1));
    if (!_.isFunction(func)) throw new TypeError('Bind must be called on a function');
    var args = slice.call(arguments, 2);
    var bound = function() {
      return executeBound(func, bound, context, this, args.concat(slice.call(arguments)));
    };
    return bound;
  };

  // Partially apply a function by creating a version that has had some of its
  // arguments pre-filled, without changing its dynamic `this` context. _ acts
  // as a placeholder, allowing any combination of arguments to be pre-filled.
  _.partial = function(func) {
    var boundArgs = slice.call(arguments, 1);
    var bound = function() {
      var position = 0, length = boundArgs.length;
      var args = Array(length);
      for (var i = 0; i < length; i++) {
        args[i] = boundArgs[i] === _ ? arguments[position++] : boundArgs[i];
      }
      while (position < arguments.length) args.push(arguments[position++]);
      return executeBound(func, bound, this, this, args);
    };
    return bound;
  };

  // Bind a number of an object's methods to that object. Remaining arguments
  // are the method names to be bound. Useful for ensuring that all callbacks
  // defined on an object belong to it.
  _.bindAll = function(obj) {
    var i, length = arguments.length, key;
    if (length <= 1) throw new Error('bindAll must be passed function names');
    for (i = 1; i < length; i++) {
      key = arguments[i];
      obj[key] = _.bind(obj[key], obj);
    }
    return obj;
  };

  // Memoize an expensive function by storing its results.
  _.memoize = function(func, hasher) {
    var memoize = function(key) {
      var cache = memoize.cache;
      var address = '' + (hasher ? hasher.apply(this, arguments) : key);
      if (!_.has(cache, address)) cache[address] = func.apply(this, arguments);
      return cache[address];
    };
    memoize.cache = {};
    return memoize;
  };

  // Delays a function for the given number of milliseconds, and then calls
  // it with the arguments supplied.
  _.delay = function(func, wait) {
    var args = slice.call(arguments, 2);
    return setTimeout(function(){
      return func.apply(null, args);
    }, wait);
  };

  // Defers a function, scheduling it to run after the current call stack has
  // cleared.
  _.defer = _.partial(_.delay, _, 1);

  // Returns a function, that, when invoked, will only be triggered at most once
  // during a given window of time. Normally, the throttled function will run
  // as much as it can, without ever going more than once per `wait` duration;
  // but if you'd like to disable the execution on the leading edge, pass
  // `{leading: false}`. To disable execution on the trailing edge, ditto.
  _.throttle = function(func, wait, options) {
    var context, args, result;
    var timeout = null;
    var previous = 0;
    if (!options) options = {};
    var later = function() {
      previous = options.leading === false ? 0 : _.now();
      timeout = null;
      result = func.apply(context, args);
      if (!timeout) context = args = null;
    };
    return function() {
      var now = _.now();
      if (!previous && options.leading === false) previous = now;
      var remaining = wait - (now - previous);
      context = this;
      args = arguments;
      if (remaining <= 0 || remaining > wait) {
        if (timeout) {
          clearTimeout(timeout);
          timeout = null;
        }
        previous = now;
        result = func.apply(context, args);
        if (!timeout) context = args = null;
      } else if (!timeout && options.trailing !== false) {
        timeout = setTimeout(later, remaining);
      }
      return result;
    };
  };

  // Returns a function, that, as long as it continues to be invoked, will not
  // be triggered. The function will be called after it stops being called for
  // N milliseconds. If `immediate` is passed, trigger the function on the
  // leading edge, instead of the trailing.
  _.debounce = function(func, wait, immediate) {
    var timeout, args, context, timestamp, result;

    var later = function() {
      var last = _.now() - timestamp;

      if (last < wait && last >= 0) {
        timeout = setTimeout(later, wait - last);
      } else {
        timeout = null;
        if (!immediate) {
          result = func.apply(context, args);
          if (!timeout) context = args = null;
        }
      }
    };

    return function() {
      context = this;
      args = arguments;
      timestamp = _.now();
      var callNow = immediate && !timeout;
      if (!timeout) timeout = setTimeout(later, wait);
      if (callNow) {
        result = func.apply(context, args);
        context = args = null;
      }

      return result;
    };
  };

  // Returns the first function passed as an argument to the second,
  // allowing you to adjust arguments, run code before and after, and
  // conditionally execute the original function.
  _.wrap = function(func, wrapper) {
    return _.partial(wrapper, func);
  };

  // Returns a negated version of the passed-in predicate.
  _.negate = function(predicate) {
    return function() {
      return !predicate.apply(this, arguments);
    };
  };

  // Returns a function that is the composition of a list of functions, each
  // consuming the return value of the function that follows.
  _.compose = function() {
    var args = arguments;
    var start = args.length - 1;
    return function() {
      var i = start;
      var result = args[start].apply(this, arguments);
      while (i--) result = args[i].call(this, result);
      return result;
    };
  };

  // Returns a function that will only be executed on and after the Nth call.
  _.after = function(times, func) {
    return function() {
      if (--times < 1) {
        return func.apply(this, arguments);
      }
    };
  };

  // Returns a function that will only be executed up to (but not including) the Nth call.
  _.before = function(times, func) {
    var memo;
    return function() {
      if (--times > 0) {
        memo = func.apply(this, arguments);
      }
      if (times <= 1) func = null;
      return memo;
    };
  };

  // Returns a function that will be executed at most one time, no matter how
  // often you call it. Useful for lazy initialization.
  _.once = _.partial(_.before, 2);

  // Object Functions
  // ----------------

  // Keys in IE < 9 that won't be iterated by `for key in ...` and thus missed.
  var hasEnumBug = !{toString: null}.propertyIsEnumerable('toString');
  var nonEnumerableProps = ['valueOf', 'isPrototypeOf', 'toString',
                      'propertyIsEnumerable', 'hasOwnProperty', 'toLocaleString'];

  function collectNonEnumProps(obj, keys) {
    var nonEnumIdx = nonEnumerableProps.length;
    var constructor = obj.constructor;
    var proto = (_.isFunction(constructor) && constructor.prototype) || ObjProto;

    // Constructor is a special case.
    var prop = 'constructor';
    if (_.has(obj, prop) && !_.contains(keys, prop)) keys.push(prop);

    while (nonEnumIdx--) {
      prop = nonEnumerableProps[nonEnumIdx];
      if (prop in obj && obj[prop] !== proto[prop] && !_.contains(keys, prop)) {
        keys.push(prop);
      }
    }
  }

  // Retrieve the names of an object's own properties.
  // Delegates to **ECMAScript 5**'s native `Object.keys`
  _.keys = function(obj) {
    if (!_.isObject(obj)) return [];
    if (nativeKeys) return nativeKeys(obj);
    var keys = [];
    for (var key in obj) if (_.has(obj, key)) keys.push(key);
    // Ahem, IE < 9.
    if (hasEnumBug) collectNonEnumProps(obj, keys);
    return keys;
  };

  // Retrieve all the property names of an object.
  _.allKeys = function(obj) {
    if (!_.isObject(obj)) return [];
    var keys = [];
    for (var key in obj) keys.push(key);
    // Ahem, IE < 9.
    if (hasEnumBug) collectNonEnumProps(obj, keys);
    return keys;
  };

  // Retrieve the values of an object's properties.
  _.values = function(obj) {
    var keys = _.keys(obj);
    var length = keys.length;
    var values = Array(length);
    for (var i = 0; i < length; i++) {
      values[i] = obj[keys[i]];
    }
    return values;
  };

  // Returns the results of applying the iteratee to each element of the object
  // In contrast to _.map it returns an object
  _.mapObject = function(obj, iteratee, context) {
    iteratee = cb(iteratee, context);
    var keys =  _.keys(obj),
          length = keys.length,
          results = {},
          currentKey;
      for (var index = 0; index < length; index++) {
        currentKey = keys[index];
        results[currentKey] = iteratee(obj[currentKey], currentKey, obj);
      }
      return results;
  };

  // Convert an object into a list of `[key, value]` pairs.
  _.pairs = function(obj) {
    var keys = _.keys(obj);
    var length = keys.length;
    var pairs = Array(length);
    for (var i = 0; i < length; i++) {
      pairs[i] = [keys[i], obj[keys[i]]];
    }
    return pairs;
  };

  // Invert the keys and values of an object. The values must be serializable.
  _.invert = function(obj) {
    var result = {};
    var keys = _.keys(obj);
    for (var i = 0, length = keys.length; i < length; i++) {
      result[obj[keys[i]]] = keys[i];
    }
    return result;
  };

  // Return a sorted list of the function names available on the object.
  // Aliased as `methods`
  _.functions = _.methods = function(obj) {
    var names = [];
    for (var key in obj) {
      if (_.isFunction(obj[key])) names.push(key);
    }
    return names.sort();
  };

  // Extend a given object with all the properties in passed-in object(s).
  _.extend = createAssigner(_.allKeys);

  // Assigns a given object with all the own properties in the passed-in object(s)
  // (https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object/assign)
  _.extendOwn = _.assign = createAssigner(_.keys);

  // Returns the first key on an object that passes a predicate test
  _.findKey = function(obj, predicate, context) {
    predicate = cb(predicate, context);
    var keys = _.keys(obj), key;
    for (var i = 0, length = keys.length; i < length; i++) {
      key = keys[i];
      if (predicate(obj[key], key, obj)) return key;
    }
  };

  // Return a copy of the object only containing the whitelisted properties.
  _.pick = function(object, oiteratee, context) {
    var result = {}, obj = object, iteratee, keys;
    if (obj == null) return result;
    if (_.isFunction(oiteratee)) {
      keys = _.allKeys(obj);
      iteratee = optimizeCb(oiteratee, context);
    } else {
      keys = flatten(arguments, false, false, 1);
      iteratee = function(value, key, obj) { return key in obj; };
      obj = Object(obj);
    }
    for (var i = 0, length = keys.length; i < length; i++) {
      var key = keys[i];
      var value = obj[key];
      if (iteratee(value, key, obj)) result[key] = value;
    }
    return result;
  };

   // Return a copy of the object without the blacklisted properties.
  _.omit = function(obj, iteratee, context) {
    if (_.isFunction(iteratee)) {
      iteratee = _.negate(iteratee);
    } else {
      var keys = _.map(flatten(arguments, false, false, 1), String);
      iteratee = function(value, key) {
        return !_.contains(keys, key);
      };
    }
    return _.pick(obj, iteratee, context);
  };

  // Fill in a given object with default properties.
  _.defaults = createAssigner(_.allKeys, true);

  // Creates an object that inherits from the given prototype object.
  // If additional properties are provided then they will be added to the
  // created object.
  _.create = function(prototype, props) {
    var result = baseCreate(prototype);
    if (props) _.extendOwn(result, props);
    return result;
  };

  // Create a (shallow-cloned) duplicate of an object.
  _.clone = function(obj) {
    if (!_.isObject(obj)) return obj;
    return _.isArray(obj) ? obj.slice() : _.extend({}, obj);
  };

  // Invokes interceptor with the obj, and then returns obj.
  // The primary purpose of this method is to "tap into" a method chain, in
  // order to perform operations on intermediate results within the chain.
  _.tap = function(obj, interceptor) {
    interceptor(obj);
    return obj;
  };

  // Returns whether an object has a given set of `key:value` pairs.
  _.isMatch = function(object, attrs) {
    var keys = _.keys(attrs), length = keys.length;
    if (object == null) return !length;
    var obj = Object(object);
    for (var i = 0; i < length; i++) {
      var key = keys[i];
      if (attrs[key] !== obj[key] || !(key in obj)) return false;
    }
    return true;
  };


  // Internal recursive comparison function for `isEqual`.
  var eq = function(a, b, aStack, bStack) {
    // Identical objects are equal. `0 === -0`, but they aren't identical.
    // See the [Harmony `egal` proposal](http://wiki.ecmascript.org/doku.php?id=harmony:egal).
    if (a === b) return a !== 0 || 1 / a === 1 / b;
    // A strict comparison is necessary because `null == undefined`.
    if (a == null || b == null) return a === b;
    // Unwrap any wrapped objects.
    if (a instanceof _) a = a._wrapped;
    if (b instanceof _) b = b._wrapped;
    // Compare `[[Class]]` names.
    var className = toString.call(a);
    if (className !== toString.call(b)) return false;
    switch (className) {
      // Strings, numbers, regular expressions, dates, and booleans are compared by value.
      case '[object RegExp]':
      // RegExps are coerced to strings for comparison (Note: '' + /a/i === '/a/i')
      case '[object String]':
        // Primitives and their corresponding object wrappers are equivalent; thus, `"5"` is
        // equivalent to `new String("5")`.
        return '' + a === '' + b;
      case '[object Number]':
        // `NaN`s are equivalent, but non-reflexive.
        // Object(NaN) is equivalent to NaN
        if (+a !== +a) return +b !== +b;
        // An `egal` comparison is performed for other numeric values.
        return +a === 0 ? 1 / +a === 1 / b : +a === +b;
      case '[object Date]':
      case '[object Boolean]':
        // Coerce dates and booleans to numeric primitive values. Dates are compared by their
        // millisecond representations. Note that invalid dates with millisecond representations
        // of `NaN` are not equivalent.
        return +a === +b;
    }

    var areArrays = className === '[object Array]';
    if (!areArrays) {
      if (typeof a != 'object' || typeof b != 'object') return false;

      // Objects with different constructors are not equivalent, but `Object`s or `Array`s
      // from different frames are.
      var aCtor = a.constructor, bCtor = b.constructor;
      if (aCtor !== bCtor && !(_.isFunction(aCtor) && aCtor instanceof aCtor &&
                               _.isFunction(bCtor) && bCtor instanceof bCtor)
                          && ('constructor' in a && 'constructor' in b)) {
        return false;
      }
    }
    // Assume equality for cyclic structures. The algorithm for detecting cyclic
    // structures is adapted from ES 5.1 section 15.12.3, abstract operation `JO`.

    // Initializing stack of traversed objects.
    // It's done here since we only need them for objects and arrays comparison.
    aStack = aStack || [];
    bStack = bStack || [];
    var length = aStack.length;
    while (length--) {
      // Linear search. Performance is inversely proportional to the number of
      // unique nested structures.
      if (aStack[length] === a) return bStack[length] === b;
    }

    // Add the first object to the stack of traversed objects.
    aStack.push(a);
    bStack.push(b);

    // Recursively compare objects and arrays.
    if (areArrays) {
      // Compare array lengths to determine if a deep comparison is necessary.
      length = a.length;
      if (length !== b.length) return false;
      // Deep compare the contents, ignoring non-numeric properties.
      while (length--) {
        if (!eq(a[length], b[length], aStack, bStack)) return false;
      }
    } else {
      // Deep compare objects.
      var keys = _.keys(a), key;
      length = keys.length;
      // Ensure that both objects contain the same number of properties before comparing deep equality.
      if (_.keys(b).length !== length) return false;
      while (length--) {
        // Deep compare each member
        key = keys[length];
        if (!(_.has(b, key) && eq(a[key], b[key], aStack, bStack))) return false;
      }
    }
    // Remove the first object from the stack of traversed objects.
    aStack.pop();
    bStack.pop();
    return true;
  };

  // Perform a deep comparison to check if two objects are equal.
  _.isEqual = function(a, b) {
    return eq(a, b);
  };

  // Is a given array, string, or object empty?
  // An "empty" object has no enumerable own-properties.
  _.isEmpty = function(obj) {
    if (obj == null) return true;
    if (isArrayLike(obj) && (_.isArray(obj) || _.isString(obj) || _.isArguments(obj))) return obj.length === 0;
    return _.keys(obj).length === 0;
  };

  // Is a given value a DOM element?
  _.isElement = function(obj) {
    return !!(obj && obj.nodeType === 1);
  };

  // Is a given value an array?
  // Delegates to ECMA5's native Array.isArray
  _.isArray = nativeIsArray || function(obj) {
    return toString.call(obj) === '[object Array]';
  };

  // Is a given variable an object?
  _.isObject = function(obj) {
    var type = typeof obj;
    return type === 'function' || type === 'object' && !!obj;
  };

  // Add some isType methods: isArguments, isFunction, isString, isNumber, isDate, isRegExp, isError.
  _.each(['Arguments', 'Function', 'String', 'Number', 'Date', 'RegExp', 'Error'], function(name) {
    _['is' + name] = function(obj) {
      return toString.call(obj) === '[object ' + name + ']';
    };
  });

  // Define a fallback version of the method in browsers (ahem, IE < 9), where
  // there isn't any inspectable "Arguments" type.
  if (!_.isArguments(arguments)) {
    _.isArguments = function(obj) {
      return _.has(obj, 'callee');
    };
  }

  // Optimize `isFunction` if appropriate. Work around some typeof bugs in old v8,
  // IE 11 (#1621), and in Safari 8 (#1929).
  if (typeof /./ != 'function' && typeof Int8Array != 'object') {
    _.isFunction = function(obj) {
      return typeof obj == 'function' || false;
    };
  }

  // Is a given object a finite number?
  _.isFinite = function(obj) {
    return isFinite(obj) && !isNaN(parseFloat(obj));
  };

  // Is the given value `NaN`? (NaN is the only number which does not equal itself).
  _.isNaN = function(obj) {
    return _.isNumber(obj) && obj !== +obj;
  };

  // Is a given value a boolean?
  _.isBoolean = function(obj) {
    return obj === true || obj === false || toString.call(obj) === '[object Boolean]';
  };

  // Is a given value equal to null?
  _.isNull = function(obj) {
    return obj === null;
  };

  // Is a given variable undefined?
  _.isUndefined = function(obj) {
    return obj === void 0;
  };

  // Shortcut function for checking if an object has a given property directly
  // on itself (in other words, not on a prototype).
  _.has = function(obj, key) {
    return obj != null && hasOwnProperty.call(obj, key);
  };

  // Utility Functions
  // -----------------

  // Run Underscore.js in *noConflict* mode, returning the `_` variable to its
  // previous owner. Returns a reference to the Underscore object.
  _.noConflict = function() {
    root._ = previousUnderscore;
    return this;
  };

  // Keep the identity function around for default iteratees.
  _.identity = function(value) {
    return value;
  };

  // Predicate-generating functions. Often useful outside of Underscore.
  _.constant = function(value) {
    return function() {
      return value;
    };
  };

  _.noop = function(){};

  _.property = property;

  // Generates a function for a given object that returns a given property.
  _.propertyOf = function(obj) {
    return obj == null ? function(){} : function(key) {
      return obj[key];
    };
  };

  // Returns a predicate for checking whether an object has a given set of
  // `key:value` pairs.
  _.matcher = _.matches = function(attrs) {
    attrs = _.extendOwn({}, attrs);
    return function(obj) {
      return _.isMatch(obj, attrs);
    };
  };

  // Run a function **n** times.
  _.times = function(n, iteratee, context) {
    var accum = Array(Math.max(0, n));
    iteratee = optimizeCb(iteratee, context, 1);
    for (var i = 0; i < n; i++) accum[i] = iteratee(i);
    return accum;
  };

  // Return a random integer between min and max (inclusive).
  _.random = function(min, max) {
    if (max == null) {
      max = min;
      min = 0;
    }
    return min + Math.floor(Math.random() * (max - min + 1));
  };

  // A (possibly faster) way to get the current timestamp as an integer.
  _.now = Date.now || function() {
    return new Date().getTime();
  };

   // List of HTML entities for escaping.
  var escapeMap = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#x27;',
    '`': '&#x60;'
  };
  var unescapeMap = _.invert(escapeMap);

  // Functions for escaping and unescaping strings to/from HTML interpolation.
  var createEscaper = function(map) {
    var escaper = function(match) {
      return map[match];
    };
    // Regexes for identifying a key that needs to be escaped
    var source = '(?:' + _.keys(map).join('|') + ')';
    var testRegexp = RegExp(source);
    var replaceRegexp = RegExp(source, 'g');
    return function(string) {
      string = string == null ? '' : '' + string;
      return testRegexp.test(string) ? string.replace(replaceRegexp, escaper) : string;
    };
  };
  _.escape = createEscaper(escapeMap);
  _.unescape = createEscaper(unescapeMap);

  // If the value of the named `property` is a function then invoke it with the
  // `object` as context; otherwise, return it.
  _.result = function(object, property, fallback) {
    var value = object == null ? void 0 : object[property];
    if (value === void 0) {
      value = fallback;
    }
    return _.isFunction(value) ? value.call(object) : value;
  };

  // Generate a unique integer id (unique within the entire client session).
  // Useful for temporary DOM ids.
  var idCounter = 0;
  _.uniqueId = function(prefix) {
    var id = ++idCounter + '';
    return prefix ? prefix + id : id;
  };

  // By default, Underscore uses ERB-style template delimiters, change the
  // following template settings to use alternative delimiters.
  _.templateSettings = {
    evaluate    : /<%([\s\S]+?)%>/g,
    interpolate : /<%=([\s\S]+?)%>/g,
    escape      : /<%-([\s\S]+?)%>/g
  };

  // When customizing `templateSettings`, if you don't want to define an
  // interpolation, evaluation or escaping regex, we need one that is
  // guaranteed not to match.
  var noMatch = /(.)^/;

  // Certain characters need to be escaped so that they can be put into a
  // string literal.
  var escapes = {
    "'":      "'",
    '\\':     '\\',
    '\r':     'r',
    '\n':     'n',
    '\u2028': 'u2028',
    '\u2029': 'u2029'
  };

  var escaper = /\\|'|\r|\n|\u2028|\u2029/g;

  var escapeChar = function(match) {
    return '\\' + escapes[match];
  };

  // JavaScript micro-templating, similar to John Resig's implementation.
  // Underscore templating handles arbitrary delimiters, preserves whitespace,
  // and correctly escapes quotes within interpolated code.
  // NB: `oldSettings` only exists for backwards compatibility.
  _.template = function(text, settings, oldSettings) {
    if (!settings && oldSettings) settings = oldSettings;
    settings = _.defaults({}, settings, _.templateSettings);

    // Combine delimiters into one regular expression via alternation.
    var matcher = RegExp([
      (settings.escape || noMatch).source,
      (settings.interpolate || noMatch).source,
      (settings.evaluate || noMatch).source
    ].join('|') + '|$', 'g');

    // Compile the template source, escaping string literals appropriately.
    var index = 0;
    var source = "__p+='";
    text.replace(matcher, function(match, escape, interpolate, evaluate, offset) {
      source += text.slice(index, offset).replace(escaper, escapeChar);
      index = offset + match.length;

      if (escape) {
        source += "'+\n((__t=(" + escape + "))==null?'':_.escape(__t))+\n'";
      } else if (interpolate) {
        source += "'+\n((__t=(" + interpolate + "))==null?'':__t)+\n'";
      } else if (evaluate) {
        source += "';\n" + evaluate + "\n__p+='";
      }

      // Adobe VMs need the match returned to produce the correct offest.
      return match;
    });
    source += "';\n";

    // If a variable is not specified, place data values in local scope.
    if (!settings.variable) source = 'with(obj||{}){\n' + source + '}\n';

    source = "var __t,__p='',__j=Array.prototype.join," +
      "print=function(){__p+=__j.call(arguments,'');};\n" +
      source + 'return __p;\n';

    try {
      var render = new Function(settings.variable || 'obj', '_', source);
    } catch (e) {
      e.source = source;
      throw e;
    }

    var template = function(data) {
      return render.call(this, data, _);
    };

    // Provide the compiled source as a convenience for precompilation.
    var argument = settings.variable || 'obj';
    template.source = 'function(' + argument + '){\n' + source + '}';

    return template;
  };

  // Add a "chain" function. Start chaining a wrapped Underscore object.
  _.chain = function(obj) {
    var instance = _(obj);
    instance._chain = true;
    return instance;
  };

  // OOP
  // ---------------
  // If Underscore is called as a function, it returns a wrapped object that
  // can be used OO-style. This wrapper holds altered versions of all the
  // underscore functions. Wrapped objects may be chained.

  // Helper function to continue chaining intermediate results.
  var result = function(instance, obj) {
    return instance._chain ? _(obj).chain() : obj;
  };

  // Add your own custom functions to the Underscore object.
  _.mixin = function(obj) {
    _.each(_.functions(obj), function(name) {
      var func = _[name] = obj[name];
      _.prototype[name] = function() {
        var args = [this._wrapped];
        push.apply(args, arguments);
        return result(this, func.apply(_, args));
      };
    });
  };

  // Add all of the Underscore functions to the wrapper object.
  _.mixin(_);

  // Add all mutator Array functions to the wrapper.
  _.each(['pop', 'push', 'reverse', 'shift', 'sort', 'splice', 'unshift'], function(name) {
    var method = ArrayProto[name];
    _.prototype[name] = function() {
      var obj = this._wrapped;
      method.apply(obj, arguments);
      if ((name === 'shift' || name === 'splice') && obj.length === 0) delete obj[0];
      return result(this, obj);
    };
  });

  // Add all accessor Array functions to the wrapper.
  _.each(['concat', 'join', 'slice'], function(name) {
    var method = ArrayProto[name];
    _.prototype[name] = function() {
      return result(this, method.apply(this._wrapped, arguments));
    };
  });

  // Extracts the result from a wrapped and chained object.
  _.prototype.value = function() {
    return this._wrapped;
  };

  // Provide unwrapping proxy for some methods used in engine operations
  // such as arithmetic and JSON stringification.
  _.prototype.valueOf = _.prototype.toJSON = _.prototype.value;

  _.prototype.toString = function() {
    return '' + this._wrapped;
  };

  // AMD registration happens at the end for compatibility with AMD loaders
  // that may not enforce next-turn semantics on modules. Even though general
  // practice for AMD registration is to be anonymous, underscore registers
  // as a named module because, like jQuery, it is a base library that is
  // popular enough to be bundled in a third party lib, but not be part of
  // an AMD load request. Those cases could generate an error when an
  // anonymous define() is called outside of a loader request.
  if (typeof define === 'function' && define.amd) {
    define('underscore', [], function() {
      return _;
    });
  }
}.call(this));

define('home/utils/layoutUtils',[
    'jquery',
    'underscore',
], function (
    $,
    _
) {
    'use strict';

    var getNavHeight = _.memoize(function () {
        return $('[data-role=nav-view]').outerHeight();
    });

    var exports = {};

    /**
     * Determines if a element is even partially visible in the viewport, excluding the nav bar.
     *
     * @param {jQuery} $el The jQuery-wrapped element to check for viewport visibility
     * @returns {boolean} `true` if any part of $el is visible in the viewport, `false` otherwise.
     */
    exports.isElementInViewport = function ($el) {
        var navHeight = getNavHeight();
        var rect = $el[0].getBoundingClientRect();

        // This coercion to 0 is because matchMedia().matches
        // always returns false for negative values
        var top = rect.top > 0 ? rect.top : 0;
        var left = rect.left > 0 ? rect.left : 0;

        return (
            rect.bottom >= navHeight &&
            rect.right >= 0 &&
            window.matchMedia('(min-height: ' + top + 'px) and (min-width: ' + left + 'px)').matches
        );
    };

    exports.isNarrowLayout = function () {
        return !window.matchMedia('(min-width: 480px)').matches;
    };

    return exports;
});

/* Modernizr (Custom Build) | MIT & BSD
 * Build: http://modernizr.com/download/#-cssclasses-shiv-load-flexbox-touch-contenteditable-history-localstorage
 */
;



window.Modernizr = (function( window, document, undefined ) {

    var version = '2.8.3',

    Modernizr = {},

    enableClasses = true,

    docElement = document.documentElement,

    mod = 'modernizr',
    modElem = document.createElement(mod),
    mStyle = modElem.style,

    inputElem  ,


    toString = {}.toString,

    prefixes = ' -webkit- -moz- -o- -ms- '.split(' '),



    omPrefixes = 'Webkit Moz O ms',

    cssomPrefixes = omPrefixes.split(' '),

    domPrefixes = omPrefixes.toLowerCase().split(' '),


    tests = {},
    inputs = {},
    attrs = {},

    classes = [],

    slice = classes.slice,

    featureName,


    injectElementWithStyles = function( rule, callback, nodes, testnames ) {

      var style, ret, node, docOverflow,
          div = document.createElement('div'),
                body = document.body,
                fakeBody = body || document.createElement('body');

      if ( parseInt(nodes, 10) ) {
                      while ( nodes-- ) {
              node = document.createElement('div');
              node.id = testnames ? testnames[nodes] : mod + (nodes + 1);
              div.appendChild(node);
          }
      }

                style = ['&#173;','<style id="s', mod, '">', rule, '</style>'].join('');
      div.id = mod;
          (body ? div : fakeBody).innerHTML += style;
      fakeBody.appendChild(div);
      if ( !body ) {
                fakeBody.style.background = '';
                fakeBody.style.overflow = 'hidden';
          docOverflow = docElement.style.overflow;
          docElement.style.overflow = 'hidden';
          docElement.appendChild(fakeBody);
      }

      ret = callback(div, rule);
        if ( !body ) {
          fakeBody.parentNode.removeChild(fakeBody);
          docElement.style.overflow = docOverflow;
      } else {
          div.parentNode.removeChild(div);
      }

      return !!ret;

    },
    _hasOwnProperty = ({}).hasOwnProperty, hasOwnProp;

    if ( !is(_hasOwnProperty, 'undefined') && !is(_hasOwnProperty.call, 'undefined') ) {
      hasOwnProp = function (object, property) {
        return _hasOwnProperty.call(object, property);
      };
    }
    else {
      hasOwnProp = function (object, property) {
        return ((property in object) && is(object.constructor.prototype[property], 'undefined'));
      };
    }


    if (!Function.prototype.bind) {
      Function.prototype.bind = function bind(that) {

        var target = this;

        if (typeof target != "function") {
            throw new TypeError();
        }

        var args = slice.call(arguments, 1),
            bound = function () {

            if (this instanceof bound) {

              var F = function(){};
              F.prototype = target.prototype;
              var self = new F();

              var result = target.apply(
                  self,
                  args.concat(slice.call(arguments))
              );
              if (Object(result) === result) {
                  return result;
              }
              return self;

            } else {

              return target.apply(
                  that,
                  args.concat(slice.call(arguments))
              );

            }

        };

        return bound;
      };
    }

    function setCss( str ) {
        mStyle.cssText = str;
    }

    function setCssAll( str1, str2 ) {
        return setCss(prefixes.join(str1 + ';') + ( str2 || '' ));
    }

    function is( obj, type ) {
        return typeof obj === type;
    }

    function contains( str, substr ) {
        return !!~('' + str).indexOf(substr);
    }

    function testProps( props, prefixed ) {
        for ( var i in props ) {
            var prop = props[i];
            if ( !contains(prop, "-") && mStyle[prop] !== undefined ) {
                return prefixed == 'pfx' ? prop : true;
            }
        }
        return false;
    }

    function testDOMProps( props, obj, elem ) {
        for ( var i in props ) {
            var item = obj[props[i]];
            if ( item !== undefined) {

                            if (elem === false) return props[i];

                            if (is(item, 'function')){
                                return item.bind(elem || obj);
                }

                            return item;
            }
        }
        return false;
    }

    function testPropsAll( prop, prefixed, elem ) {

        var ucProp  = prop.charAt(0).toUpperCase() + prop.slice(1),
            props   = (prop + ' ' + cssomPrefixes.join(ucProp + ' ') + ucProp).split(' ');

            if(is(prefixed, "string") || is(prefixed, "undefined")) {
          return testProps(props, prefixed);

            } else {
          props = (prop + ' ' + (domPrefixes).join(ucProp + ' ') + ucProp).split(' ');
          return testDOMProps(props, prefixed, elem);
        }
    }

    tests['flexbox'] = function() {
        return testPropsAll('flexWrap');
    };

    tests['touch'] = function() {
        var bool;

        if(('ontouchstart' in window) || window.DocumentTouch && document instanceof DocumentTouch) {
          bool = true;
        } else {
          injectElementWithStyles(['@media (',prefixes.join('touch-enabled),('),mod,')','{#modernizr{top:9px;position:absolute}}'].join(''), function( node ) {
            bool = node.offsetTop === 9;
          });
        }

        return bool;
    };
    tests['history'] = function() {
      return !!(window.history && history.pushState);
    };



    tests['localstorage'] = function() {
        try {
            localStorage.setItem(mod, mod);
            localStorage.removeItem(mod);
            return true;
        } catch(e) {
            return false;
        }
    };


    for ( var feature in tests ) {
        if ( hasOwnProp(tests, feature) ) {
                                    featureName  = feature.toLowerCase();
            Modernizr[featureName] = tests[feature]();

            classes.push((Modernizr[featureName] ? '' : 'no-') + featureName);
        }
    }



     Modernizr.addTest = function ( feature, test ) {
       if ( typeof feature == 'object' ) {
         for ( var key in feature ) {
           if ( hasOwnProp( feature, key ) ) {
             Modernizr.addTest( key, feature[ key ] );
           }
         }
       } else {

         feature = feature.toLowerCase();

         if ( Modernizr[feature] !== undefined ) {
                                              return Modernizr;
         }

         test = typeof test == 'function' ? test() : test;

         if (typeof enableClasses !== "undefined" && enableClasses) {
           docElement.className += ' ' + (test ? '' : 'no-') + feature;
         }
         Modernizr[feature] = test;

       }

       return Modernizr;
     };


    setCss('');
    modElem = inputElem = null;

    ;(function(window, document) {
                var version = '3.7.0';

            var options = window.html5 || {};

            var reSkip = /^<|^(?:button|map|select|textarea|object|iframe|option|optgroup)$/i;

            var saveClones = /^(?:a|b|code|div|fieldset|h1|h2|h3|h4|h5|h6|i|label|li|ol|p|q|span|strong|style|table|tbody|td|th|tr|ul)$/i;

            var supportsHtml5Styles;

            var expando = '_html5shiv';

            var expanID = 0;

            var expandoData = {};

            var supportsUnknownElements;

        (function() {
          try {
            var a = document.createElement('a');
            a.innerHTML = '<xyz></xyz>';
                    supportsHtml5Styles = ('hidden' in a);

            supportsUnknownElements = a.childNodes.length == 1 || (function() {
                        (document.createElement)('a');
              var frag = document.createDocumentFragment();
              return (
                typeof frag.cloneNode == 'undefined' ||
                typeof frag.createDocumentFragment == 'undefined' ||
                typeof frag.createElement == 'undefined'
              );
            }());
          } catch(e) {
                    supportsHtml5Styles = true;
            supportsUnknownElements = true;
          }

        }());

            function addStyleSheet(ownerDocument, cssText) {
          var p = ownerDocument.createElement('p'),
          parent = ownerDocument.getElementsByTagName('head')[0] || ownerDocument.documentElement;

          p.innerHTML = 'x<style>' + cssText + '</style>';
          return parent.insertBefore(p.lastChild, parent.firstChild);
        }

            function getElements() {
          var elements = html5.elements;
          return typeof elements == 'string' ? elements.split(' ') : elements;
        }

            function getExpandoData(ownerDocument) {
          var data = expandoData[ownerDocument[expando]];
          if (!data) {
            data = {};
            expanID++;
            ownerDocument[expando] = expanID;
            expandoData[expanID] = data;
          }
          return data;
        }

            function createElement(nodeName, ownerDocument, data){
          if (!ownerDocument) {
            ownerDocument = document;
          }
          if(supportsUnknownElements){
            return ownerDocument.createElement(nodeName);
          }
          if (!data) {
            data = getExpandoData(ownerDocument);
          }
          var node;

          if (data.cache[nodeName]) {
            node = data.cache[nodeName].cloneNode();
          } else if (saveClones.test(nodeName)) {
            node = (data.cache[nodeName] = data.createElem(nodeName)).cloneNode();
          } else {
            node = data.createElem(nodeName);
          }

                                                    return node.canHaveChildren && !reSkip.test(nodeName) && !node.tagUrn ? data.frag.appendChild(node) : node;
        }

            function createDocumentFragment(ownerDocument, data){
          if (!ownerDocument) {
            ownerDocument = document;
          }
          if(supportsUnknownElements){
            return ownerDocument.createDocumentFragment();
          }
          data = data || getExpandoData(ownerDocument);
          var clone = data.frag.cloneNode(),
          i = 0,
          elems = getElements(),
          l = elems.length;
          for(;i<l;i++){
            clone.createElement(elems[i]);
          }
          return clone;
        }

            function shivMethods(ownerDocument, data) {
          if (!data.cache) {
            data.cache = {};
            data.createElem = ownerDocument.createElement;
            data.createFrag = ownerDocument.createDocumentFragment;
            data.frag = data.createFrag();
          }


          ownerDocument.createElement = function(nodeName) {
                    if (!html5.shivMethods) {
              return data.createElem(nodeName);
            }
            return createElement(nodeName, ownerDocument, data);
          };

          ownerDocument.createDocumentFragment = Function('h,f', 'return function(){' +
                                                          'var n=f.cloneNode(),c=n.createElement;' +
                                                          'h.shivMethods&&(' +
                                                                                                                getElements().join().replace(/[\w\-]+/g, function(nodeName) {
            data.createElem(nodeName);
            data.frag.createElement(nodeName);
            return 'c("' + nodeName + '")';
          }) +
            ');return n}'
                                                         )(html5, data.frag);
        }

            function shivDocument(ownerDocument) {
          if (!ownerDocument) {
            ownerDocument = document;
          }
          var data = getExpandoData(ownerDocument);

          if (html5.shivCSS && !supportsHtml5Styles && !data.hasCSS) {
            data.hasCSS = !!addStyleSheet(ownerDocument,
                                                                                'article,aside,dialog,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}' +
                                                                                    'mark{background:#FF0;color:#000}' +
                                                                                    'template{display:none}'
                                         );
          }
          if (!supportsUnknownElements) {
            shivMethods(ownerDocument, data);
          }
          return ownerDocument;
        }

            var html5 = {

                'elements': options.elements || 'abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video',

                'version': version,

                'shivCSS': (options.shivCSS !== false),

                'supportsUnknownElements': supportsUnknownElements,

                'shivMethods': (options.shivMethods !== false),

                'type': 'default',

                'shivDocument': shivDocument,

                createElement: createElement,

                createDocumentFragment: createDocumentFragment
        };

            window.html5 = html5;

            shivDocument(document);

    }(this, document));

    Modernizr._version      = version;

    Modernizr._prefixes     = prefixes;
    Modernizr._domPrefixes  = domPrefixes;
    Modernizr._cssomPrefixes  = cssomPrefixes;



    Modernizr.testProp      = function(prop){
        return testProps([prop]);
    };

    Modernizr.testAllProps  = testPropsAll;


    Modernizr.testStyles    = injectElementWithStyles;    docElement.className = docElement.className.replace(/(^|\s)no-js(\s|$)/, '$1$2') +

                                                    (enableClasses ? ' js ' + classes.join(' ') : '');

    return Modernizr;

})(this, this.document);

(function(a,b,c){function d(a){return"[object Function]"==o.call(a)}function e(a){return"string"==typeof a}function f(){}function g(a){return!a||"loaded"==a||"complete"==a||"uninitialized"==a}function h(){var a=p.shift();q=1,a?a.t?m(function(){("c"==a.t?B.injectCss:B.injectJs)(a.s,0,a.a,a.x,a.e,1)},0):(a(),h()):q=0}function i(a,c,d,e,f,i,j){function k(b){if(!o&&g(l.readyState)&&(u.r=o=1,!q&&h(),l.onload=l.onreadystatechange=null,b)){"img"!=a&&m(function(){t.removeChild(l)},50);for(var d in y[c])y[c].hasOwnProperty(d)&&y[c][d].onload()}}var j=j||B.errorTimeout,l=b.createElement(a),o=0,r=0,u={t:d,s:c,e:f,a:i,x:j};1===y[c]&&(r=1,y[c]=[]),"object"==a?l.data=c:(l.src=c,l.type=a),l.width=l.height="0",l.onerror=l.onload=l.onreadystatechange=function(){k.call(this,r)},p.splice(e,0,u),"img"!=a&&(r||2===y[c]?(t.insertBefore(l,s?null:n),m(k,j)):y[c].push(l))}function j(a,b,c,d,f){return q=0,b=b||"j",e(a)?i("c"==b?v:u,a,b,this.i++,c,d,f):(p.splice(this.i++,0,a),1==p.length&&h()),this}function k(){var a=B;return a.loader={load:j,i:0},a}var l=b.documentElement,m=a.setTimeout,n=b.getElementsByTagName("script")[0],o={}.toString,p=[],q=0,r="MozAppearance"in l.style,s=r&&!!b.createRange().compareNode,t=s?l:n.parentNode,l=a.opera&&"[object Opera]"==o.call(a.opera),l=!!b.attachEvent&&!l,u=r?"object":l?"script":"img",v=l?"script":u,w=Array.isArray||function(a){return"[object Array]"==o.call(a)},x=[],y={},z={timeout:function(a,b){return b.length&&(a.timeout=b[0]),a}},A,B;B=function(a){function b(a){var a=a.split("!"),b=x.length,c=a.pop(),d=a.length,c={url:c,origUrl:c,prefixes:a},e,f,g;for(f=0;f<d;f++)g=a[f].split("="),(e=z[g.shift()])&&(c=e(c,g));for(f=0;f<b;f++)c=x[f](c);return c}function g(a,e,f,g,h){var i=b(a),j=i.autoCallback;i.url.split(".").pop().split("?").shift(),i.bypass||(e&&(e=d(e)?e:e[a]||e[g]||e[a.split("/").pop().split("?")[0]]),i.instead?i.instead(a,e,f,g,h):(y[i.url]?i.noexec=!0:y[i.url]=1,f.load(i.url,i.forceCSS||!i.forceJS&&"css"==i.url.split(".").pop().split("?").shift()?"c":c,i.noexec,i.attrs,i.timeout),(d(e)||d(j))&&f.load(function(){k(),e&&e(i.origUrl,h,g),j&&j(i.origUrl,h,g),y[i.url]=2})))}function h(a,b){function c(a,c){if(a){if(e(a))c||(j=function(){var a=[].slice.call(arguments);k.apply(this,a),l()}),g(a,j,b,0,h);else if(Object(a)===a)for(n in m=function(){var b=0,c;for(c in a)a.hasOwnProperty(c)&&b++;return b}(),a)a.hasOwnProperty(n)&&(!c&&!--m&&(d(j)?j=function(){var a=[].slice.call(arguments);k.apply(this,a),l()}:j[n]=function(a){return function(){var b=[].slice.call(arguments);a&&a.apply(this,b),l()}}(k[n])),g(a[n],j,b,n,h))}else!c&&l()}var h=!!a.test,i=a.load||a.both,j=a.callback||f,k=j,l=a.complete||f,m,n;c(h?a.yep:a.nope,!!i),i&&c(i)}var i,j,l=this.yepnope.loader;if(e(a))g(a,0,l,0);else if(w(a))for(i=0;i<a.length;i++)j=a[i],e(j)?g(j,0,l,0):w(j)?B(j):Object(j)===j&&h(j,l);else Object(a)===a&&h(a,l)},B.addPrefix=function(a,b){z[a]=b},B.addFilter=function(a){x.push(a)},B.errorTimeout=1e4,null==b.readyState&&b.addEventListener&&(b.readyState="loading",b.addEventListener("DOMContentLoaded",A=function(){b.removeEventListener("DOMContentLoaded",A,0),b.readyState="complete"},0)),a.yepnope=k(),a.yepnope.executeStack=h,a.yepnope.injectJs=function(a,c,d,e,i,j){var k=b.createElement("script"),l,o,e=e||B.errorTimeout;k.src=a;for(o in d)k.setAttribute(o,d[o]);c=j?h:c||f,k.onreadystatechange=k.onload=function(){!l&&g(k.readyState)&&(l=1,c(),k.onload=k.onreadystatechange=null)},m(function(){l||(l=1,c(1))},e),i?k.onload():n.parentNode.insertBefore(k,n)},a.yepnope.injectCss=function(a,c,d,e,g,i){var e=b.createElement("link"),j,c=i?h:c||f;e.href=a,e.rel="stylesheet",e.type="text/css";for(j in d)e.setAttribute(j,d[j]);g||(n.parentNode.insertBefore(e,n),m(c,0))}})(this,document);
Modernizr.load=function(){yepnope.apply(window,[].slice.call(arguments,0));};


Modernizr.addTest('contenteditable',
        'contentEditable' in document.documentElement);
;

define("modernizr", (function (global) {
    return function () {
        var ret, fn;
        return ret || global.Modernizr;
    };
}(this)));

//     Backbone.js 1.1.2

//     (c) 2010-2014 Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
//     Backbone may be freely distributed under the MIT license.
//     For all details and documentation:
//     http://backbonejs.org

(function(root, factory) {

  // Set up Backbone appropriately for the environment. Start with AMD.
  if (typeof define === 'function' && define.amd) {
    define('backbone',['underscore', 'jquery', 'exports'], function(_, $, exports) {
      // Export global even in AMD case in case this script is loaded with
      // others that may still expect a global Backbone.
      root.Backbone = factory(root, exports, _, $);
    });

  // Next for Node.js or CommonJS. jQuery may not be needed as a module.
  } else if (typeof exports !== 'undefined') {
    var _ = require('underscore');
    factory(root, exports, _);

  // Finally, as a browser global.
  } else {
    root.Backbone = factory(root, {}, root._, (root.jQuery || root.Zepto || root.ender || root.$));
  }

}(this, function(root, Backbone, _, $) {

  // Initial Setup
  // -------------

  // Save the previous value of the `Backbone` variable, so that it can be
  // restored later on, if `noConflict` is used.
  var previousBackbone = root.Backbone;

  // Create local references to array methods we'll want to use later.
  var array = [];
  var push = array.push;
  var slice = array.slice;
  var splice = array.splice;

  // Current version of the library. Keep in sync with `package.json`.
  Backbone.VERSION = '1.1.2';

  // For Backbone's purposes, jQuery, Zepto, Ender, or My Library (kidding) owns
  // the `$` variable.
  Backbone.$ = $;

  // Runs Backbone.js in *noConflict* mode, returning the `Backbone` variable
  // to its previous owner. Returns a reference to this Backbone object.
  Backbone.noConflict = function() {
    root.Backbone = previousBackbone;
    return this;
  };

  // Turn on `emulateHTTP` to support legacy HTTP servers. Setting this option
  // will fake `"PATCH"`, `"PUT"` and `"DELETE"` requests via the `_method` parameter and
  // set a `X-Http-Method-Override` header.
  Backbone.emulateHTTP = false;

  // Turn on `emulateJSON` to support legacy servers that can't deal with direct
  // `application/json` requests ... will encode the body as
  // `application/x-www-form-urlencoded` instead and will send the model in a
  // form param named `model`.
  Backbone.emulateJSON = false;

  // Backbone.Events
  // ---------------

  // A module that can be mixed in to *any object* in order to provide it with
  // custom events. You may bind with `on` or remove with `off` callback
  // functions to an event; `trigger`-ing an event fires all callbacks in
  // succession.
  //
  //     var object = {};
  //     _.extend(object, Backbone.Events);
  //     object.on('expand', function(){ alert('expanded'); });
  //     object.trigger('expand');
  //
  var Events = Backbone.Events = {

    // Bind an event to a `callback` function. Passing `"all"` will bind
    // the callback to all events fired.
    on: function(name, callback, context) {
      if (!eventsApi(this, 'on', name, [callback, context]) || !callback) return this;
      this._events || (this._events = {});
      var events = this._events[name] || (this._events[name] = []);
      events.push({callback: callback, context: context, ctx: context || this});
      return this;
    },

    // Bind an event to only be triggered a single time. After the first time
    // the callback is invoked, it will be removed.
    once: function(name, callback, context) {
      if (!eventsApi(this, 'once', name, [callback, context]) || !callback) return this;
      var self = this;
      var once = _.once(function() {
        self.off(name, once);
        callback.apply(this, arguments);
      });
      once._callback = callback;
      return this.on(name, once, context);
    },

    // Remove one or many callbacks. If `context` is null, removes all
    // callbacks with that function. If `callback` is null, removes all
    // callbacks for the event. If `name` is null, removes all bound
    // callbacks for all events.
    off: function(name, callback, context) {
      var retain, ev, events, names, i, l, j, k;
      if (!this._events || !eventsApi(this, 'off', name, [callback, context])) return this;
      if (!name && !callback && !context) {
        this._events = void 0;
        return this;
      }
      names = name ? [name] : _.keys(this._events);
      for (i = 0, l = names.length; i < l; i++) {
        name = names[i];
        if (events = this._events[name]) {
          this._events[name] = retain = [];
          if (callback || context) {
            for (j = 0, k = events.length; j < k; j++) {
              ev = events[j];
              if ((callback && callback !== ev.callback && callback !== ev.callback._callback) ||
                  (context && context !== ev.context)) {
                retain.push(ev);
              }
            }
          }
          if (!retain.length) delete this._events[name];
        }
      }

      return this;
    },

    // Trigger one or many events, firing all bound callbacks. Callbacks are
    // passed the same arguments as `trigger` is, apart from the event name
    // (unless you're listening on `"all"`, which will cause your callback to
    // receive the true name of the event as the first argument).
    trigger: function(name) {
      if (!this._events) return this;
      var args = slice.call(arguments, 1);
      if (!eventsApi(this, 'trigger', name, args)) return this;
      var events = this._events[name];
      var allEvents = this._events.all;
      if (events) triggerEvents(events, args);
      if (allEvents) triggerEvents(allEvents, arguments);
      return this;
    },

    // Tell this object to stop listening to either specific events ... or
    // to every object it's currently listening to.
    stopListening: function(obj, name, callback) {
      var listeningTo = this._listeningTo;
      if (!listeningTo) return this;
      var remove = !name && !callback;
      if (!callback && typeof name === 'object') callback = this;
      if (obj) (listeningTo = {})[obj._listenId] = obj;
      for (var id in listeningTo) {
        obj = listeningTo[id];
        obj.off(name, callback, this);
        if (remove || _.isEmpty(obj._events)) delete this._listeningTo[id];
      }
      return this;
    }

  };

  // Regular expression used to split event strings.
  var eventSplitter = /\s+/;

  // Implement fancy features of the Events API such as multiple event
  // names `"change blur"` and jQuery-style event maps `{change: action}`
  // in terms of the existing API.
  var eventsApi = function(obj, action, name, rest) {
    if (!name) return true;

    // Handle event maps.
    if (typeof name === 'object') {
      for (var key in name) {
        obj[action].apply(obj, [key, name[key]].concat(rest));
      }
      return false;
    }

    // Handle space separated event names.
    if (eventSplitter.test(name)) {
      var names = name.split(eventSplitter);
      for (var i = 0, l = names.length; i < l; i++) {
        obj[action].apply(obj, [names[i]].concat(rest));
      }
      return false;
    }

    return true;
  };

  // A difficult-to-believe, but optimized internal dispatch function for
  // triggering events. Tries to keep the usual cases speedy (most internal
  // Backbone events have 3 arguments).
  var triggerEvents = function(events, args) {
    var ev, i = -1, l = events.length, a1 = args[0], a2 = args[1], a3 = args[2];
    switch (args.length) {
      case 0: while (++i < l) (ev = events[i]).callback.call(ev.ctx); return;
      case 1: while (++i < l) (ev = events[i]).callback.call(ev.ctx, a1); return;
      case 2: while (++i < l) (ev = events[i]).callback.call(ev.ctx, a1, a2); return;
      case 3: while (++i < l) (ev = events[i]).callback.call(ev.ctx, a1, a2, a3); return;
      default: while (++i < l) (ev = events[i]).callback.apply(ev.ctx, args); return;
    }
  };

  var listenMethods = {listenTo: 'on', listenToOnce: 'once'};

  // Inversion-of-control versions of `on` and `once`. Tell *this* object to
  // listen to an event in another object ... keeping track of what it's
  // listening to.
  _.each(listenMethods, function(implementation, method) {
    Events[method] = function(obj, name, callback) {
      var listeningTo = this._listeningTo || (this._listeningTo = {});
      var id = obj._listenId || (obj._listenId = _.uniqueId('l'));
      listeningTo[id] = obj;
      if (!callback && typeof name === 'object') callback = this;
      obj[implementation](name, callback, this);
      return this;
    };
  });

  // Aliases for backwards compatibility.
  Events.bind   = Events.on;
  Events.unbind = Events.off;

  // Allow the `Backbone` object to serve as a global event bus, for folks who
  // want global "pubsub" in a convenient place.
  _.extend(Backbone, Events);

  // Backbone.Model
  // --------------

  // Backbone **Models** are the basic data object in the framework --
  // frequently representing a row in a table in a database on your server.
  // A discrete chunk of data and a bunch of useful, related methods for
  // performing computations and transformations on that data.

  // Create a new model with the specified attributes. A client id (`cid`)
  // is automatically generated and assigned for you.
  var Model = Backbone.Model = function(attributes, options) {
    var attrs = attributes || {};
    options || (options = {});
    this.cid = _.uniqueId('c');
    this.attributes = {};
    if (options.collection) this.collection = options.collection;
    if (options.parse) attrs = this.parse(attrs, options) || {};
    attrs = _.defaults({}, attrs, _.result(this, 'defaults'));
    this.set(attrs, options);
    this.changed = {};
    this.initialize.apply(this, arguments);
  };

  // Attach all inheritable methods to the Model prototype.
  _.extend(Model.prototype, Events, {

    // A hash of attributes whose current and previous value differ.
    changed: null,

    // The value returned during the last failed validation.
    validationError: null,

    // The default name for the JSON `id` attribute is `"id"`. MongoDB and
    // CouchDB users may want to set this to `"_id"`.
    idAttribute: 'id',

    // Initialize is an empty function by default. Override it with your own
    // initialization logic.
    initialize: function(){},

    // Return a copy of the model's `attributes` object.
    toJSON: function(options) {
      return _.clone(this.attributes);
    },

    // Proxy `Backbone.sync` by default -- but override this if you need
    // custom syncing semantics for *this* particular model.
    sync: function() {
      return Backbone.sync.apply(this, arguments);
    },

    // Get the value of an attribute.
    get: function(attr) {
      return this.attributes[attr];
    },

    // Get the HTML-escaped value of an attribute.
    escape: function(attr) {
      return _.escape(this.get(attr));
    },

    // Returns `true` if the attribute contains a value that is not null
    // or undefined.
    has: function(attr) {
      return this.get(attr) != null;
    },

    // Set a hash of model attributes on the object, firing `"change"`. This is
    // the core primitive operation of a model, updating the data and notifying
    // anyone who needs to know about the change in state. The heart of the beast.
    set: function(key, val, options) {
      var attr, attrs, unset, changes, silent, changing, prev, current;
      if (key == null) return this;

      // Handle both `"key", value` and `{key: value}` -style arguments.
      if (typeof key === 'object') {
        attrs = key;
        options = val;
      } else {
        (attrs = {})[key] = val;
      }

      options || (options = {});

      // Run validation.
      if (!this._validate(attrs, options)) return false;

      // Extract attributes and options.
      unset           = options.unset;
      silent          = options.silent;
      changes         = [];
      changing        = this._changing;
      this._changing  = true;

      if (!changing) {
        this._previousAttributes = _.clone(this.attributes);
        this.changed = {};
      }
      current = this.attributes, prev = this._previousAttributes;

      // Check for changes of `id`.
      if (this.idAttribute in attrs) this.id = attrs[this.idAttribute];

      // For each `set` attribute, update or delete the current value.
      for (attr in attrs) {
        val = attrs[attr];
        if (!_.isEqual(current[attr], val)) changes.push(attr);
        if (!_.isEqual(prev[attr], val)) {
          this.changed[attr] = val;
        } else {
          delete this.changed[attr];
        }
        unset ? delete current[attr] : current[attr] = val;
      }

      // Trigger all relevant attribute changes.
      if (!silent) {
        if (changes.length) this._pending = options;
        for (var i = 0, l = changes.length; i < l; i++) {
          this.trigger('change:' + changes[i], this, current[changes[i]], options);
        }
      }

      // You might be wondering why there's a `while` loop here. Changes can
      // be recursively nested within `"change"` events.
      if (changing) return this;
      if (!silent) {
        while (this._pending) {
          options = this._pending;
          this._pending = false;
          this.trigger('change', this, options);
        }
      }
      this._pending = false;
      this._changing = false;
      return this;
    },

    // Remove an attribute from the model, firing `"change"`. `unset` is a noop
    // if the attribute doesn't exist.
    unset: function(attr, options) {
      return this.set(attr, void 0, _.extend({}, options, {unset: true}));
    },

    // Clear all attributes on the model, firing `"change"`.
    clear: function(options) {
      var attrs = {};
      for (var key in this.attributes) attrs[key] = void 0;
      return this.set(attrs, _.extend({}, options, {unset: true}));
    },

    // Determine if the model has changed since the last `"change"` event.
    // If you specify an attribute name, determine if that attribute has changed.
    hasChanged: function(attr) {
      if (attr == null) return !_.isEmpty(this.changed);
      return _.has(this.changed, attr);
    },

    // Return an object containing all the attributes that have changed, or
    // false if there are no changed attributes. Useful for determining what
    // parts of a view need to be updated and/or what attributes need to be
    // persisted to the server. Unset attributes will be set to undefined.
    // You can also pass an attributes object to diff against the model,
    // determining if there *would be* a change.
    changedAttributes: function(diff) {
      if (!diff) return this.hasChanged() ? _.clone(this.changed) : false;
      var val, changed = false;
      var old = this._changing ? this._previousAttributes : this.attributes;
      for (var attr in diff) {
        if (_.isEqual(old[attr], (val = diff[attr]))) continue;
        (changed || (changed = {}))[attr] = val;
      }
      return changed;
    },

    // Get the previous value of an attribute, recorded at the time the last
    // `"change"` event was fired.
    previous: function(attr) {
      if (attr == null || !this._previousAttributes) return null;
      return this._previousAttributes[attr];
    },

    // Get all of the attributes of the model at the time of the previous
    // `"change"` event.
    previousAttributes: function() {
      return _.clone(this._previousAttributes);
    },

    // Fetch the model from the server. If the server's representation of the
    // model differs from its current attributes, they will be overridden,
    // triggering a `"change"` event.
    fetch: function(options) {
      options = options ? _.clone(options) : {};
      if (options.parse === void 0) options.parse = true;
      var model = this;
      var success = options.success;
      options.success = function(resp) {
        if (!model.set(model.parse(resp, options), options)) return false;
        if (success) success(model, resp, options);
        model.trigger('sync', model, resp, options);
      };
      wrapError(this, options);
      return this.sync('read', this, options);
    },

    // Set a hash of model attributes, and sync the model to the server.
    // If the server returns an attributes hash that differs, the model's
    // state will be `set` again.
    save: function(key, val, options) {
      var attrs, method, xhr, attributes = this.attributes;

      // Handle both `"key", value` and `{key: value}` -style arguments.
      if (key == null || typeof key === 'object') {
        attrs = key;
        options = val;
      } else {
        (attrs = {})[key] = val;
      }

      options = _.extend({validate: true}, options);

      // If we're not waiting and attributes exist, save acts as
      // `set(attr).save(null, opts)` with validation. Otherwise, check if
      // the model will be valid when the attributes, if any, are set.
      if (attrs && !options.wait) {
        if (!this.set(attrs, options)) return false;
      } else {
        if (!this._validate(attrs, options)) return false;
      }

      // Set temporary attributes if `{wait: true}`.
      if (attrs && options.wait) {
        this.attributes = _.extend({}, attributes, attrs);
      }

      // After a successful server-side save, the client is (optionally)
      // updated with the server-side state.
      if (options.parse === void 0) options.parse = true;
      var model = this;
      var success = options.success;
      options.success = function(resp) {
        // Ensure attributes are restored during synchronous saves.
        model.attributes = attributes;
        var serverAttrs = model.parse(resp, options);
        if (options.wait) serverAttrs = _.extend(attrs || {}, serverAttrs);
        if (_.isObject(serverAttrs) && !model.set(serverAttrs, options)) {
          return false;
        }
        if (success) success(model, resp, options);
        model.trigger('sync', model, resp, options);
      };
      wrapError(this, options);

      method = this.isNew() ? 'create' : (options.patch ? 'patch' : 'update');
      if (method === 'patch') options.attrs = attrs;
      xhr = this.sync(method, this, options);

      // Restore attributes.
      if (attrs && options.wait) this.attributes = attributes;

      return xhr;
    },

    // Destroy this model on the server if it was already persisted.
    // Optimistically removes the model from its collection, if it has one.
    // If `wait: true` is passed, waits for the server to respond before removal.
    destroy: function(options) {
      options = options ? _.clone(options) : {};
      var model = this;
      var success = options.success;

      var destroy = function() {
        model.trigger('destroy', model, model.collection, options);
      };

      options.success = function(resp) {
        if (options.wait || model.isNew()) destroy();
        if (success) success(model, resp, options);
        if (!model.isNew()) model.trigger('sync', model, resp, options);
      };

      if (this.isNew()) {
        options.success();
        return false;
      }
      wrapError(this, options);

      var xhr = this.sync('delete', this, options);
      if (!options.wait) destroy();
      return xhr;
    },

    // Default URL for the model's representation on the server -- if you're
    // using Backbone's restful methods, override this to change the endpoint
    // that will be called.
    url: function() {
      var base =
        _.result(this, 'urlRoot') ||
        _.result(this.collection, 'url') ||
        urlError();
      if (this.isNew()) return base;
      return base.replace(/([^\/])$/, '$1/') + encodeURIComponent(this.id);
    },

    // **parse** converts a response into the hash of attributes to be `set` on
    // the model. The default implementation is just to pass the response along.
    parse: function(resp, options) {
      return resp;
    },

    // Create a new model with identical attributes to this one.
    clone: function() {
      return new this.constructor(this.attributes);
    },

    // A model is new if it has never been saved to the server, and lacks an id.
    isNew: function() {
      return !this.has(this.idAttribute);
    },

    // Check if the model is currently in a valid state.
    isValid: function(options) {
      return this._validate({}, _.extend(options || {}, { validate: true }));
    },

    // Run validation against the next complete set of model attributes,
    // returning `true` if all is well. Otherwise, fire an `"invalid"` event.
    _validate: function(attrs, options) {
      if (!options.validate || !this.validate) return true;
      attrs = _.extend({}, this.attributes, attrs);
      var error = this.validationError = this.validate(attrs, options) || null;
      if (!error) return true;
      this.trigger('invalid', this, error, _.extend(options, {validationError: error}));
      return false;
    }

  });

  // Underscore methods that we want to implement on the Model.
  var modelMethods = ['keys', 'values', 'pairs', 'invert', 'pick', 'omit'];

  // Mix in each Underscore method as a proxy to `Model#attributes`.
  _.each(modelMethods, function(method) {
    Model.prototype[method] = function() {
      var args = slice.call(arguments);
      args.unshift(this.attributes);
      return _[method].apply(_, args);
    };
  });

  // Backbone.Collection
  // -------------------

  // If models tend to represent a single row of data, a Backbone Collection is
  // more analagous to a table full of data ... or a small slice or page of that
  // table, or a collection of rows that belong together for a particular reason
  // -- all of the messages in this particular folder, all of the documents
  // belonging to this particular author, and so on. Collections maintain
  // indexes of their models, both in order, and for lookup by `id`.

  // Create a new **Collection**, perhaps to contain a specific type of `model`.
  // If a `comparator` is specified, the Collection will maintain
  // its models in sort order, as they're added and removed.
  var Collection = Backbone.Collection = function(models, options) {
    options || (options = {});
    if (options.model) this.model = options.model;
    if (options.comparator !== void 0) this.comparator = options.comparator;
    this._reset();
    this.initialize.apply(this, arguments);
    if (models) this.reset(models, _.extend({silent: true}, options));
  };

  // Default options for `Collection#set`.
  var setOptions = {add: true, remove: true, merge: true};
  var addOptions = {add: true, remove: false};

  // Define the Collection's inheritable methods.
  _.extend(Collection.prototype, Events, {

    // The default model for a collection is just a **Backbone.Model**.
    // This should be overridden in most cases.
    model: Model,

    // Initialize is an empty function by default. Override it with your own
    // initialization logic.
    initialize: function(){},

    // The JSON representation of a Collection is an array of the
    // models' attributes.
    toJSON: function(options) {
      return this.map(function(model){ return model.toJSON(options); });
    },

    // Proxy `Backbone.sync` by default.
    sync: function() {
      return Backbone.sync.apply(this, arguments);
    },

    // Add a model, or list of models to the set.
    add: function(models, options) {
      return this.set(models, _.extend({merge: false}, options, addOptions));
    },

    // Remove a model, or a list of models from the set.
    remove: function(models, options) {
      var singular = !_.isArray(models);
      models = singular ? [models] : _.clone(models);
      options || (options = {});
      var i, l, index, model;
      for (i = 0, l = models.length; i < l; i++) {
        model = models[i] = this.get(models[i]);
        if (!model) continue;
        delete this._byId[model.id];
        delete this._byId[model.cid];
        index = this.indexOf(model);
        this.models.splice(index, 1);
        this.length--;
        if (!options.silent) {
          options.index = index;
          model.trigger('remove', model, this, options);
        }
        this._removeReference(model, options);
      }
      return singular ? models[0] : models;
    },

    // Update a collection by `set`-ing a new list of models, adding new ones,
    // removing models that are no longer present, and merging models that
    // already exist in the collection, as necessary. Similar to **Model#set**,
    // the core operation for updating the data contained by the collection.
    set: function(models, options) {
      options = _.defaults({}, options, setOptions);
      if (options.parse) models = this.parse(models, options);
      var singular = !_.isArray(models);
      models = singular ? (models ? [models] : []) : _.clone(models);
      var i, l, id, model, attrs, existing, sort;
      var at = options.at;
      var targetModel = this.model;
      var sortable = this.comparator && (at == null) && options.sort !== false;
      var sortAttr = _.isString(this.comparator) ? this.comparator : null;
      var toAdd = [], toRemove = [], modelMap = {};
      var add = options.add, merge = options.merge, remove = options.remove;
      var order = !sortable && add && remove ? [] : false;

      // Turn bare objects into model references, and prevent invalid models
      // from being added.
      for (i = 0, l = models.length; i < l; i++) {
        attrs = models[i] || {};
        if (attrs instanceof Model) {
          id = model = attrs;
        } else {
          id = attrs[targetModel.prototype.idAttribute || 'id'];
        }

        // If a duplicate is found, prevent it from being added and
        // optionally merge it into the existing model.
        if (existing = this.get(id)) {
          if (remove) modelMap[existing.cid] = true;
          if (merge) {
            attrs = attrs === model ? model.attributes : attrs;
            if (options.parse) attrs = existing.parse(attrs, options);
            existing.set(attrs, options);
            if (sortable && !sort && existing.hasChanged(sortAttr)) sort = true;
          }
          models[i] = existing;

        // If this is a new, valid model, push it to the `toAdd` list.
        } else if (add) {
          model = models[i] = this._prepareModel(attrs, options);
          if (!model) continue;
          toAdd.push(model);
          this._addReference(model, options);
        }

        // Do not add multiple models with the same `id`.
        model = existing || model;
        if (order && (model.isNew() || !modelMap[model.id])) order.push(model);
        modelMap[model.id] = true;
      }

      // Remove nonexistent models if appropriate.
      if (remove) {
        for (i = 0, l = this.length; i < l; ++i) {
          if (!modelMap[(model = this.models[i]).cid]) toRemove.push(model);
        }
        if (toRemove.length) this.remove(toRemove, options);
      }

      // See if sorting is needed, update `length` and splice in new models.
      if (toAdd.length || (order && order.length)) {
        if (sortable) sort = true;
        this.length += toAdd.length;
        if (at != null) {
          for (i = 0, l = toAdd.length; i < l; i++) {
            this.models.splice(at + i, 0, toAdd[i]);
          }
        } else {
          if (order) this.models.length = 0;
          var orderedModels = order || toAdd;
          for (i = 0, l = orderedModels.length; i < l; i++) {
            this.models.push(orderedModels[i]);
          }
        }
      }

      // Silently sort the collection if appropriate.
      if (sort) this.sort({silent: true});

      // Unless silenced, it's time to fire all appropriate add/sort events.
      if (!options.silent) {
        for (i = 0, l = toAdd.length; i < l; i++) {
          (model = toAdd[i]).trigger('add', model, this, options);
        }
        if (sort || (order && order.length)) this.trigger('sort', this, options);
      }

      // Return the added (or merged) model (or models).
      return singular ? models[0] : models;
    },

    // When you have more items than you want to add or remove individually,
    // you can reset the entire set with a new list of models, without firing
    // any granular `add` or `remove` events. Fires `reset` when finished.
    // Useful for bulk operations and optimizations.
    reset: function(models, options) {
      options || (options = {});
      for (var i = 0, l = this.models.length; i < l; i++) {
        this._removeReference(this.models[i], options);
      }
      options.previousModels = this.models;
      this._reset();
      models = this.add(models, _.extend({silent: true}, options));
      if (!options.silent) this.trigger('reset', this, options);
      return models;
    },

    // Add a model to the end of the collection.
    push: function(model, options) {
      return this.add(model, _.extend({at: this.length}, options));
    },

    // Remove a model from the end of the collection.
    pop: function(options) {
      var model = this.at(this.length - 1);
      this.remove(model, options);
      return model;
    },

    // Add a model to the beginning of the collection.
    unshift: function(model, options) {
      return this.add(model, _.extend({at: 0}, options));
    },

    // Remove a model from the beginning of the collection.
    shift: function(options) {
      var model = this.at(0);
      this.remove(model, options);
      return model;
    },

    // Slice out a sub-array of models from the collection.
    slice: function() {
      return slice.apply(this.models, arguments);
    },

    // Get a model from the set by id.
    get: function(obj) {
      if (obj == null) return void 0;
      return this._byId[obj] || this._byId[obj.id] || this._byId[obj.cid];
    },

    // Get the model at the given index.
    at: function(index) {
      return this.models[index];
    },

    // Return models with matching attributes. Useful for simple cases of
    // `filter`.
    where: function(attrs, first) {
      if (_.isEmpty(attrs)) return first ? void 0 : [];
      return this[first ? 'find' : 'filter'](function(model) {
        for (var key in attrs) {
          if (attrs[key] !== model.get(key)) return false;
        }
        return true;
      });
    },

    // Return the first model with matching attributes. Useful for simple cases
    // of `find`.
    findWhere: function(attrs) {
      return this.where(attrs, true);
    },

    // Force the collection to re-sort itself. You don't need to call this under
    // normal circumstances, as the set will maintain sort order as each item
    // is added.
    sort: function(options) {
      if (!this.comparator) throw new Error('Cannot sort a set without a comparator');
      options || (options = {});

      // Run sort based on type of `comparator`.
      if (_.isString(this.comparator) || this.comparator.length === 1) {
        this.models = this.sortBy(this.comparator, this);
      } else {
        this.models.sort(_.bind(this.comparator, this));
      }

      if (!options.silent) this.trigger('sort', this, options);
      return this;
    },

    // Pluck an attribute from each model in the collection.
    pluck: function(attr) {
      return _.invoke(this.models, 'get', attr);
    },

    // Fetch the default set of models for this collection, resetting the
    // collection when they arrive. If `reset: true` is passed, the response
    // data will be passed through the `reset` method instead of `set`.
    fetch: function(options) {
      options = options ? _.clone(options) : {};
      if (options.parse === void 0) options.parse = true;
      var success = options.success;
      var collection = this;
      options.success = function(resp) {
        var method = options.reset ? 'reset' : 'set';
        collection[method](resp, options);
        if (success) success(collection, resp, options);
        collection.trigger('sync', collection, resp, options);
      };
      wrapError(this, options);
      return this.sync('read', this, options);
    },

    // Create a new instance of a model in this collection. Add the model to the
    // collection immediately, unless `wait: true` is passed, in which case we
    // wait for the server to agree.
    create: function(model, options) {
      options = options ? _.clone(options) : {};
      if (!(model = this._prepareModel(model, options))) return false;
      if (!options.wait) this.add(model, options);
      var collection = this;
      var success = options.success;
      options.success = function(model, resp) {
        if (options.wait) collection.add(model, options);
        if (success) success(model, resp, options);
      };
      model.save(null, options);
      return model;
    },

    // **parse** converts a response into a list of models to be added to the
    // collection. The default implementation is just to pass it through.
    parse: function(resp, options) {
      return resp;
    },

    // Create a new collection with an identical list of models as this one.
    clone: function() {
      return new this.constructor(this.models);
    },

    // Private method to reset all internal state. Called when the collection
    // is first initialized or reset.
    _reset: function() {
      this.length = 0;
      this.models = [];
      this._byId  = {};
    },

    // Prepare a hash of attributes (or other model) to be added to this
    // collection.
    _prepareModel: function(attrs, options) {
      if (attrs instanceof Model) return attrs;
      options = options ? _.clone(options) : {};
      options.collection = this;
      var model = new this.model(attrs, options);
      if (!model.validationError) return model;
      this.trigger('invalid', this, model.validationError, options);
      return false;
    },

    // Internal method to create a model's ties to a collection.
    _addReference: function(model, options) {
      this._byId[model.cid] = model;
      if (model.id != null) this._byId[model.id] = model;
      if (!model.collection) model.collection = this;
      model.on('all', this._onModelEvent, this);
    },

    // Internal method to sever a model's ties to a collection.
    _removeReference: function(model, options) {
      if (this === model.collection) delete model.collection;
      model.off('all', this._onModelEvent, this);
    },

    // Internal method called every time a model in the set fires an event.
    // Sets need to update their indexes when models change ids. All other
    // events simply proxy through. "add" and "remove" events that originate
    // in other collections are ignored.
    _onModelEvent: function(event, model, collection, options) {
      if ((event === 'add' || event === 'remove') && collection !== this) return;
      if (event === 'destroy') this.remove(model, options);
      if (model && event === 'change:' + model.idAttribute) {
        delete this._byId[model.previous(model.idAttribute)];
        if (model.id != null) this._byId[model.id] = model;
      }
      this.trigger.apply(this, arguments);
    }

  });

  // Underscore methods that we want to implement on the Collection.
  // 90% of the core usefulness of Backbone Collections is actually implemented
  // right here:
  var methods = ['forEach', 'each', 'map', 'collect', 'reduce', 'foldl',
    'inject', 'reduceRight', 'foldr', 'find', 'detect', 'filter', 'select',
    'reject', 'every', 'all', 'some', 'any', 'include', 'contains', 'invoke',
    'max', 'min', 'toArray', 'size', 'first', 'head', 'take', 'initial', 'rest',
    'tail', 'drop', 'last', 'without', 'difference', 'indexOf', 'shuffle',
    'lastIndexOf', 'isEmpty', 'chain', 'sample'];

  // Mix in each Underscore method as a proxy to `Collection#models`.
  _.each(methods, function(method) {
    Collection.prototype[method] = function() {
      var args = slice.call(arguments);
      args.unshift(this.models);
      return _[method].apply(_, args);
    };
  });

  // Underscore methods that take a property name as an argument.
  var attributeMethods = ['groupBy', 'countBy', 'sortBy', 'indexBy'];

  // Use attributes instead of properties.
  _.each(attributeMethods, function(method) {
    Collection.prototype[method] = function(value, context) {
      var iterator = _.isFunction(value) ? value : function(model) {
        return model.get(value);
      };
      return _[method](this.models, iterator, context);
    };
  });

  // Backbone.View
  // -------------

  // Backbone Views are almost more convention than they are actual code. A View
  // is simply a JavaScript object that represents a logical chunk of UI in the
  // DOM. This might be a single item, an entire list, a sidebar or panel, or
  // even the surrounding frame which wraps your whole app. Defining a chunk of
  // UI as a **View** allows you to define your DOM events declaratively, without
  // having to worry about render order ... and makes it easy for the view to
  // react to specific changes in the state of your models.

  // Creating a Backbone.View creates its initial element outside of the DOM,
  // if an existing element is not provided...
  var View = Backbone.View = function(options) {
    this.cid = _.uniqueId('view');
    options || (options = {});
    _.extend(this, _.pick(options, viewOptions));
    this._ensureElement();
    this.initialize.apply(this, arguments);
    this.delegateEvents();
  };

  // Cached regex to split keys for `delegate`.
  var delegateEventSplitter = /^(\S+)\s*(.*)$/;

  // List of view options to be merged as properties.
  var viewOptions = ['model', 'collection', 'el', 'id', 'attributes', 'className', 'tagName', 'events'];

  // Set up all inheritable **Backbone.View** properties and methods.
  _.extend(View.prototype, Events, {

    // The default `tagName` of a View's element is `"div"`.
    tagName: 'div',

    // jQuery delegate for element lookup, scoped to DOM elements within the
    // current view. This should be preferred to global lookups where possible.
    $: function(selector) {
      return this.$el.find(selector);
    },

    // Initialize is an empty function by default. Override it with your own
    // initialization logic.
    initialize: function(){},

    // **render** is the core function that your view should override, in order
    // to populate its element (`this.el`), with the appropriate HTML. The
    // convention is for **render** to always return `this`.
    render: function() {
      return this;
    },

    // Remove this view by taking the element out of the DOM, and removing any
    // applicable Backbone.Events listeners.
    remove: function() {
      this.$el.remove();
      this.stopListening();
      return this;
    },

    // Change the view's element (`this.el` property), including event
    // re-delegation.
    setElement: function(element, delegate) {
      if (this.$el) this.undelegateEvents();
      this.$el = element instanceof Backbone.$ ? element : Backbone.$(element);
      this.el = this.$el[0];
      if (delegate !== false) this.delegateEvents();
      return this;
    },

    // Set callbacks, where `this.events` is a hash of
    //
    // *{"event selector": "callback"}*
    //
    //     {
    //       'mousedown .title':  'edit',
    //       'click .button':     'save',
    //       'click .open':       function(e) { ... }
    //     }
    //
    // pairs. Callbacks will be bound to the view, with `this` set properly.
    // Uses event delegation for efficiency.
    // Omitting the selector binds the event to `this.el`.
    // This only works for delegate-able events: not `focus`, `blur`, and
    // not `change`, `submit`, and `reset` in Internet Explorer.
    delegateEvents: function(events) {
      if (!(events || (events = _.result(this, 'events')))) return this;
      this.undelegateEvents();
      for (var key in events) {
        var method = events[key];
        if (!_.isFunction(method)) method = this[events[key]];
        if (!method) continue;

        var match = key.match(delegateEventSplitter);
        var eventName = match[1], selector = match[2];
        method = _.bind(method, this);
        eventName += '.delegateEvents' + this.cid;
        if (selector === '') {
          this.$el.on(eventName, method);
        } else {
          this.$el.on(eventName, selector, method);
        }
      }
      return this;
    },

    // Clears all callbacks previously bound to the view with `delegateEvents`.
    // You usually don't need to use this, but may wish to if you have multiple
    // Backbone views attached to the same DOM element.
    undelegateEvents: function() {
      this.$el.off('.delegateEvents' + this.cid);
      return this;
    },

    // Ensure that the View has a DOM element to render into.
    // If `this.el` is a string, pass it through `$()`, take the first
    // matching element, and re-assign it to `el`. Otherwise, create
    // an element from the `id`, `className` and `tagName` properties.
    _ensureElement: function() {
      if (!this.el) {
        var attrs = _.extend({}, _.result(this, 'attributes'));
        if (this.id) attrs.id = _.result(this, 'id');
        if (this.className) attrs['class'] = _.result(this, 'className');
        var $el = Backbone.$('<' + _.result(this, 'tagName') + '>').attr(attrs);
        this.setElement($el, false);
      } else {
        this.setElement(_.result(this, 'el'), false);
      }
    }

  });

  // Backbone.sync
  // -------------

  // Override this function to change the manner in which Backbone persists
  // models to the server. You will be passed the type of request, and the
  // model in question. By default, makes a RESTful Ajax request
  // to the model's `url()`. Some possible customizations could be:
  //
  // * Use `setTimeout` to batch rapid-fire updates into a single request.
  // * Send up the models as XML instead of JSON.
  // * Persist models via WebSockets instead of Ajax.
  //
  // Turn on `Backbone.emulateHTTP` in order to send `PUT` and `DELETE` requests
  // as `POST`, with a `_method` parameter containing the true HTTP method,
  // as well as all requests with the body as `application/x-www-form-urlencoded`
  // instead of `application/json` with the model in a param named `model`.
  // Useful when interfacing with server-side languages like **PHP** that make
  // it difficult to read the body of `PUT` requests.
  Backbone.sync = function(method, model, options) {
    var type = methodMap[method];

    // Default options, unless specified.
    _.defaults(options || (options = {}), {
      emulateHTTP: Backbone.emulateHTTP,
      emulateJSON: Backbone.emulateJSON
    });

    // Default JSON-request options.
    var params = {type: type, dataType: 'json'};

    // Ensure that we have a URL.
    if (!options.url) {
      params.url = _.result(model, 'url') || urlError();
    }

    // Ensure that we have the appropriate request data.
    if (options.data == null && model && (method === 'create' || method === 'update' || method === 'patch')) {
      params.contentType = 'application/json';
      params.data = JSON.stringify(options.attrs || model.toJSON(options));
    }

    // For older servers, emulate JSON by encoding the request into an HTML-form.
    if (options.emulateJSON) {
      params.contentType = 'application/x-www-form-urlencoded';
      params.data = params.data ? {model: params.data} : {};
    }

    // For older servers, emulate HTTP by mimicking the HTTP method with `_method`
    // And an `X-HTTP-Method-Override` header.
    if (options.emulateHTTP && (type === 'PUT' || type === 'DELETE' || type === 'PATCH')) {
      params.type = 'POST';
      if (options.emulateJSON) params.data._method = type;
      var beforeSend = options.beforeSend;
      options.beforeSend = function(xhr) {
        xhr.setRequestHeader('X-HTTP-Method-Override', type);
        if (beforeSend) return beforeSend.apply(this, arguments);
      };
    }

    // Don't process data on a non-GET request.
    if (params.type !== 'GET' && !options.emulateJSON) {
      params.processData = false;
    }

    // If we're sending a `PATCH` request, and we're in an old Internet Explorer
    // that still has ActiveX enabled by default, override jQuery to use that
    // for XHR instead. Remove this line when jQuery supports `PATCH` on IE8.
    if (params.type === 'PATCH' && noXhrPatch) {
      params.xhr = function() {
        return new ActiveXObject("Microsoft.XMLHTTP");
      };
    }

    // Make the request, allowing the user to override any Ajax options.
    var xhr = options.xhr = Backbone.ajax(_.extend(params, options));
    model.trigger('request', model, xhr, options);
    return xhr;
  };

  var noXhrPatch =
    typeof window !== 'undefined' && !!window.ActiveXObject &&
      !(window.XMLHttpRequest && (new XMLHttpRequest).dispatchEvent);

  // Map from CRUD to HTTP for our default `Backbone.sync` implementation.
  var methodMap = {
    'create': 'POST',
    'update': 'PUT',
    'patch':  'PATCH',
    'delete': 'DELETE',
    'read':   'GET'
  };

  // Set the default implementation of `Backbone.ajax` to proxy through to `$`.
  // Override this if you'd like to use a different library.
  Backbone.ajax = function() {
    return Backbone.$.ajax.apply(Backbone.$, arguments);
  };

  // Backbone.Router
  // ---------------

  // Routers map faux-URLs to actions, and fire events when routes are
  // matched. Creating a new one sets its `routes` hash, if not set statically.
  var Router = Backbone.Router = function(options) {
    options || (options = {});
    if (options.routes) this.routes = options.routes;
    this._bindRoutes();
    this.initialize.apply(this, arguments);
  };

  // Cached regular expressions for matching named param parts and splatted
  // parts of route strings.
  var optionalParam = /\((.*?)\)/g;
  var namedParam    = /(\(\?)?:\w+/g;
  var splatParam    = /\*\w+/g;
  var escapeRegExp  = /[\-{}\[\]+?.,\\\^$|#\s]/g;

  // Set up all inheritable **Backbone.Router** properties and methods.
  _.extend(Router.prototype, Events, {

    // Initialize is an empty function by default. Override it with your own
    // initialization logic.
    initialize: function(){},

    // Manually bind a single named route to a callback. For example:
    //
    //     this.route('search/:query/p:num', 'search', function(query, num) {
    //       ...
    //     });
    //
    route: function(route, name, callback) {
      if (!_.isRegExp(route)) route = this._routeToRegExp(route);
      if (_.isFunction(name)) {
        callback = name;
        name = '';
      }
      if (!callback) callback = this[name];
      var router = this;
      Backbone.history.route(route, function(fragment) {
        var args = router._extractParameters(route, fragment);
        router.execute(callback, args);
        router.trigger.apply(router, ['route:' + name].concat(args));
        router.trigger('route', name, args);
        Backbone.history.trigger('route', router, name, args);
      });
      return this;
    },

    // Execute a route handler with the provided parameters.  This is an
    // excellent place to do pre-route setup or post-route cleanup.
    execute: function(callback, args) {
      if (callback) callback.apply(this, args);
    },

    // Simple proxy to `Backbone.history` to save a fragment into the history.
    navigate: function(fragment, options) {
      Backbone.history.navigate(fragment, options);
      return this;
    },

    // Bind all defined routes to `Backbone.history`. We have to reverse the
    // order of the routes here to support behavior where the most general
    // routes can be defined at the bottom of the route map.
    _bindRoutes: function() {
      if (!this.routes) return;
      this.routes = _.result(this, 'routes');
      var route, routes = _.keys(this.routes);
      while ((route = routes.pop()) != null) {
        this.route(route, this.routes[route]);
      }
    },

    // Convert a route string into a regular expression, suitable for matching
    // against the current location hash.
    _routeToRegExp: function(route) {
      route = route.replace(escapeRegExp, '\\$&')
                   .replace(optionalParam, '(?:$1)?')
                   .replace(namedParam, function(match, optional) {
                     return optional ? match : '([^/?]+)';
                   })
                   .replace(splatParam, '([^?]*?)');
      return new RegExp('^' + route + '(?:\\?([\\s\\S]*))?$');
    },

    // Given a route, and a URL fragment that it matches, return the array of
    // extracted decoded parameters. Empty or unmatched parameters will be
    // treated as `null` to normalize cross-browser behavior.
    _extractParameters: function(route, fragment) {
      var params = route.exec(fragment).slice(1);
      return _.map(params, function(param, i) {
        // Don't decode the search params.
        if (i === params.length - 1) return param || null;
        return param ? decodeURIComponent(param) : null;
      });
    }

  });

  // Backbone.History
  // ----------------

  // Handles cross-browser history management, based on either
  // [pushState](http://diveintohtml5.info/history.html) and real URLs, or
  // [onhashchange](https://developer.mozilla.org/en-US/docs/DOM/window.onhashchange)
  // and URL fragments. If the browser supports neither (old IE, natch),
  // falls back to polling.
  var History = Backbone.History = function() {
    this.handlers = [];
    _.bindAll(this, 'checkUrl');

    // Ensure that `History` can be used outside of the browser.
    if (typeof window !== 'undefined') {
      this.location = window.location;
      this.history = window.history;
    }
  };

  // Cached regex for stripping a leading hash/slash and trailing space.
  var routeStripper = /^[#\/]|\s+$/g;

  // Cached regex for stripping leading and trailing slashes.
  var rootStripper = /^\/+|\/+$/g;

  // Cached regex for detecting MSIE.
  var isExplorer = /msie [\w.]+/;

  // Cached regex for removing a trailing slash.
  var trailingSlash = /\/$/;

  // Cached regex for stripping urls of hash.
  var pathStripper = /#.*$/;

  // Has the history handling already been started?
  History.started = false;

  // Set up all inheritable **Backbone.History** properties and methods.
  _.extend(History.prototype, Events, {

    // The default interval to poll for hash changes, if necessary, is
    // twenty times a second.
    interval: 50,

    // Are we at the app root?
    atRoot: function() {
      return this.location.pathname.replace(/[^\/]$/, '$&/') === this.root;
    },

    // Gets the true hash value. Cannot use location.hash directly due to bug
    // in Firefox where location.hash will always be decoded.
    getHash: function(window) {
      var match = (window || this).location.href.match(/#(.*)$/);
      return match ? match[1] : '';
    },

    // Get the cross-browser normalized URL fragment, either from the URL,
    // the hash, or the override.
    getFragment: function(fragment, forcePushState) {
      if (fragment == null) {
        if (this._hasPushState || !this._wantsHashChange || forcePushState) {
          fragment = decodeURI(this.location.pathname + this.location.search);
          var root = this.root.replace(trailingSlash, '');
          if (!fragment.indexOf(root)) fragment = fragment.slice(root.length);
        } else {
          fragment = this.getHash();
        }
      }
      return fragment.replace(routeStripper, '');
    },

    // Start the hash change handling, returning `true` if the current URL matches
    // an existing route, and `false` otherwise.
    start: function(options) {
      if (History.started) throw new Error("Backbone.history has already been started");
      History.started = true;

      // Figure out the initial configuration. Do we need an iframe?
      // Is pushState desired ... is it available?
      this.options          = _.extend({root: '/'}, this.options, options);
      this.root             = this.options.root;
      this._wantsHashChange = this.options.hashChange !== false;
      this._wantsPushState  = !!this.options.pushState;
      this._hasPushState    = !!(this.options.pushState && this.history && this.history.pushState);
      var fragment          = this.getFragment();
      var docMode           = document.documentMode;
      var oldIE             = (isExplorer.exec(navigator.userAgent.toLowerCase()) && (!docMode || docMode <= 7));

      // Normalize root to always include a leading and trailing slash.
      this.root = ('/' + this.root + '/').replace(rootStripper, '/');

      if (oldIE && this._wantsHashChange) {
        var frame = Backbone.$('<iframe src="javascript:0" tabindex="-1">');
        this.iframe = frame.hide().appendTo('body')[0].contentWindow;
        this.navigate(fragment);
      }

      // Depending on whether we're using pushState or hashes, and whether
      // 'onhashchange' is supported, determine how we check the URL state.
      if (this._hasPushState) {
        Backbone.$(window).on('popstate', this.checkUrl);
      } else if (this._wantsHashChange && ('onhashchange' in window) && !oldIE) {
        Backbone.$(window).on('hashchange', this.checkUrl);
      } else if (this._wantsHashChange) {
        this._checkUrlInterval = setInterval(this.checkUrl, this.interval);
      }

      // Determine if we need to change the base url, for a pushState link
      // opened by a non-pushState browser.
      this.fragment = fragment;
      var loc = this.location;

      // Transition from hashChange to pushState or vice versa if both are
      // requested.
      if (this._wantsHashChange && this._wantsPushState) {

        // If we've started off with a route from a `pushState`-enabled
        // browser, but we're currently in a browser that doesn't support it...
        if (!this._hasPushState && !this.atRoot()) {
          this.fragment = this.getFragment(null, true);
          this.location.replace(this.root + '#' + this.fragment);
          // Return immediately as browser will do redirect to new url
          return true;

        // Or if we've started out with a hash-based route, but we're currently
        // in a browser where it could be `pushState`-based instead...
        } else if (this._hasPushState && this.atRoot() && loc.hash) {
          this.fragment = this.getHash().replace(routeStripper, '');
          this.history.replaceState({}, document.title, this.root + this.fragment);
        }

      }

      if (!this.options.silent) return this.loadUrl();
    },

    // Disable Backbone.history, perhaps temporarily. Not useful in a real app,
    // but possibly useful for unit testing Routers.
    stop: function() {
      Backbone.$(window).off('popstate', this.checkUrl).off('hashchange', this.checkUrl);
      if (this._checkUrlInterval) clearInterval(this._checkUrlInterval);
      History.started = false;
    },

    // Add a route to be tested when the fragment changes. Routes added later
    // may override previous routes.
    route: function(route, callback) {
      this.handlers.unshift({route: route, callback: callback});
    },

    // Checks the current URL to see if it has changed, and if it has,
    // calls `loadUrl`, normalizing across the hidden iframe.
    checkUrl: function(e) {
      var current = this.getFragment();
      if (current === this.fragment && this.iframe) {
        current = this.getFragment(this.getHash(this.iframe));
      }
      if (current === this.fragment) return false;
      if (this.iframe) this.navigate(current);
      this.loadUrl();
    },

    // Attempt to load the current URL fragment. If a route succeeds with a
    // match, returns `true`. If no defined routes matches the fragment,
    // returns `false`.
    loadUrl: function(fragment) {
      fragment = this.fragment = this.getFragment(fragment);
      return _.any(this.handlers, function(handler) {
        if (handler.route.test(fragment)) {
          handler.callback(fragment);
          return true;
        }
      });
    },

    // Save a fragment into the hash history, or replace the URL state if the
    // 'replace' option is passed. You are responsible for properly URL-encoding
    // the fragment in advance.
    //
    // The options object can contain `trigger: true` if you wish to have the
    // route callback be fired (not usually desirable), or `replace: true`, if
    // you wish to modify the current URL without adding an entry to the history.
    navigate: function(fragment, options) {
      if (!History.started) return false;
      if (!options || options === true) options = {trigger: !!options};

      var url = this.root + (fragment = this.getFragment(fragment || ''));

      // Strip the hash for matching.
      fragment = fragment.replace(pathStripper, '');

      if (this.fragment === fragment) return;
      this.fragment = fragment;

      // Don't include a trailing slash on the root.
      if (fragment === '' && url !== '/') url = url.slice(0, -1);

      // If pushState is available, we use it to set the fragment as a real URL.
      if (this._hasPushState) {
        this.history[options.replace ? 'replaceState' : 'pushState']({}, document.title, url);

      // If hash changes haven't been explicitly disabled, update the hash
      // fragment to store history.
      } else if (this._wantsHashChange) {
        this._updateHash(this.location, fragment, options.replace);
        if (this.iframe && (fragment !== this.getFragment(this.getHash(this.iframe)))) {
          // Opening and closing the iframe tricks IE7 and earlier to push a
          // history entry on hash-tag change.  When replace is true, we don't
          // want this.
          if(!options.replace) this.iframe.document.open().close();
          this._updateHash(this.iframe.location, fragment, options.replace);
        }

      // If you've told us that you explicitly don't want fallback hashchange-
      // based history, then `navigate` becomes a page refresh.
      } else {
        return this.location.assign(url);
      }
      if (options.trigger) return this.loadUrl(fragment);
    },

    // Update the hash location, either replacing the current entry, or adding
    // a new one to the browser history.
    _updateHash: function(location, fragment, replace) {
      if (replace) {
        var href = location.href.replace(/(javascript:|#).*$/, '');
        location.replace(href + '#' + fragment);
      } else {
        // Some browsers require that `hash` contains a leading #.
        location.hash = '#' + fragment;
      }
    }

  });

  // Create the default Backbone.history.
  Backbone.history = new History;

  // Helpers
  // -------

  // Helper function to correctly set up the prototype chain, for subclasses.
  // Similar to `goog.inherits`, but uses a hash of prototype properties and
  // class properties to be extended.
  var extend = function(protoProps, staticProps) {
    var parent = this;
    var child;

    // The constructor function for the new subclass is either defined by you
    // (the "constructor" property in your `extend` definition), or defaulted
    // by us to simply call the parent's constructor.
    if (protoProps && _.has(protoProps, 'constructor')) {
      child = protoProps.constructor;
    } else {
      child = function(){ return parent.apply(this, arguments); };
    }

    // Add static properties to the constructor function, if supplied.
    _.extend(child, parent, staticProps);

    // Set the prototype chain to inherit from `parent`, without calling
    // `parent`'s constructor function.
    var Surrogate = function(){ this.constructor = child; };
    Surrogate.prototype = parent.prototype;
    child.prototype = new Surrogate;

    // Add prototype properties (instance properties) to the subclass,
    // if supplied.
    if (protoProps) _.extend(child.prototype, protoProps);

    // Set a convenience property in case the parent's prototype is needed
    // later.
    child.__super__ = parent.prototype;

    return child;
  };

  // Set up inheritance for the model, collection, router, view and history.
  Model.extend = Collection.extend = Router.extend = View.extend = History.extend = extend;

  // Throw an error when a URL is needed, and none is supplied.
  var urlError = function() {
    throw new Error('A "url" property or function must be specified');
  };

  // Wrap an optional error callback with a fallback error event.
  var wrapError = function(model, options) {
    var error = options.error;
    options.error = function(resp) {
      if (error) error(model, resp, options);
      model.trigger('error', model, resp, options);
    };
  };

  return Backbone;

}));

// Backbone.Wreqr (Backbone.Marionette)
// ----------------------------------
// v1.4.0
//
// Copyright (c)2016 Derick Bailey, Muted Solutions, LLC.
// Distributed under MIT license
//
// http://github.com/marionettejs/backbone.wreqr


(function(root, factory) {

  if (typeof define === 'function' && define.amd) {
    define('backbone.wreqr',['backbone', 'underscore'], function(Backbone, _) {
      return factory(Backbone, _);
    });
  } else if (typeof exports !== 'undefined') {
    var Backbone = require('backbone');
    var _ = require('underscore');
    module.exports = factory(Backbone, _);
  } else {
    factory(root.Backbone, root._);
  }

}(this, function(Backbone, _) {
  "use strict";

  var previousWreqr = Backbone.Wreqr;

  var Wreqr = Backbone.Wreqr = {};

  Backbone.Wreqr.VERSION = '1.4.0';

  Backbone.Wreqr.noConflict = function () {
    Backbone.Wreqr = previousWreqr;
    return this;
  };

  // Handlers
  // --------
  // A registry of functions to call, given a name
  
  Wreqr.Handlers = (function(Backbone, _){
    "use strict";
    
    // Constructor
    // -----------
  
    var Handlers = function(options){
      this.options = options;
      this._wreqrHandlers = {};
      
      if (_.isFunction(this.initialize)){
        this.initialize(options);
      }
    };
  
    Handlers.extend = Backbone.Model.extend;
  
    // Instance Members
    // ----------------
  
    _.extend(Handlers.prototype, Backbone.Events, {
  
      // Add multiple handlers using an object literal configuration
      setHandlers: function(handlers){
        _.each(handlers, _.bind(function(handler, name){
          var context = null;
  
          if (_.isObject(handler) && !_.isFunction(handler)){
            context = handler.context;
            handler = handler.callback;
          }
  
          this.setHandler(name, handler, context);
        }, this));
      },
  
      // Add a handler for the given name, with an
      // optional context to run the handler within
      setHandler: function(name, handler, context){
        var config = {
          callback: handler,
          context: context
        };
  
        this._wreqrHandlers[name] = config;
  
        this.trigger("handler:add", name, handler, context);
      },
  
      // Determine whether or not a handler is registered
      hasHandler: function(name){
        return !! this._wreqrHandlers[name];
      },
  
      // Get the currently registered handler for
      // the specified name. Throws an exception if
      // no handler is found.
      getHandler: function(name){
        var config = this._wreqrHandlers[name];
  
        if (!config){
          return;
        }
  
        return function(){
          return config.callback.apply(config.context, arguments);
        };
      },
  
      // Remove a handler for the specified name
      removeHandler: function(name){
        delete this._wreqrHandlers[name];
      },
  
      // Remove all handlers from this registry
      removeAllHandlers: function(){
        this._wreqrHandlers = {};
      }
    });
  
    return Handlers;
  })(Backbone, _);
  
  // Wreqr.CommandStorage
  // --------------------
  //
  // Store and retrieve commands for execution.
  Wreqr.CommandStorage = (function(){
    "use strict";
  
    // Constructor function
    var CommandStorage = function(options){
      this.options = options;
      this._commands = {};
  
      if (_.isFunction(this.initialize)){
        this.initialize(options);
      }
    };
  
    // Instance methods
    _.extend(CommandStorage.prototype, Backbone.Events, {
  
      // Get an object literal by command name, that contains
      // the `commandName` and the `instances` of all commands
      // represented as an array of arguments to process
      getCommands: function(commandName){
        var commands = this._commands[commandName];
  
        // we don't have it, so add it
        if (!commands){
  
          // build the configuration
          commands = {
            command: commandName, 
            instances: []
          };
  
          // store it
          this._commands[commandName] = commands;
        }
  
        return commands;
      },
  
      // Add a command by name, to the storage and store the
      // args for the command
      addCommand: function(commandName, args){
        var command = this.getCommands(commandName);
        command.instances.push(args);
      },
  
      // Clear all commands for the given `commandName`
      clearCommands: function(commandName){
        var command = this.getCommands(commandName);
        command.instances = [];
      }
    });
  
    return CommandStorage;
  })();
  
  // Wreqr.Commands
  // --------------
  //
  // A simple command pattern implementation. Register a command
  // handler and execute it.
  Wreqr.Commands = (function(Wreqr, _){
    "use strict";
  
    return Wreqr.Handlers.extend({
      // default storage type
      storageType: Wreqr.CommandStorage,
  
      constructor: function(options){
        this.options = options || {};
  
        this._initializeStorage(this.options);
        this.on("handler:add", this._executeCommands, this);
  
        Wreqr.Handlers.prototype.constructor.apply(this, arguments);
      },
  
      // Execute a named command with the supplied args
      execute: function(name){
        name = arguments[0];
        var args = _.rest(arguments);
  
        if (this.hasHandler(name)){
          this.getHandler(name).apply(this, args);
        } else {
          this.storage.addCommand(name, args);
        }
  
      },
  
      // Internal method to handle bulk execution of stored commands
      _executeCommands: function(name, handler, context){
        var command = this.storage.getCommands(name);
  
        // loop through and execute all the stored command instances
        _.each(command.instances, function(args){
          handler.apply(context, args);
        });
  
        this.storage.clearCommands(name);
      },
  
      // Internal method to initialize storage either from the type's
      // `storageType` or the instance `options.storageType`.
      _initializeStorage: function(options){
        var storage;
  
        var StorageType = options.storageType || this.storageType;
        if (_.isFunction(StorageType)){
          storage = new StorageType();
        } else {
          storage = StorageType;
        }
  
        this.storage = storage;
      }
    });
  
  })(Wreqr, _);
  
  // Wreqr.RequestResponse
  // ---------------------
  //
  // A simple request/response implementation. Register a
  // request handler, and return a response from it
  Wreqr.RequestResponse = (function(Wreqr, _){
    "use strict";
  
    return Wreqr.Handlers.extend({
      request: function(name){
        if (this.hasHandler(name)) {
          return this.getHandler(name).apply(this, _.rest(arguments));
        }
      }
    });
  
  })(Wreqr, _);
  
  // Event Aggregator
  // ----------------
  // A pub-sub object that can be used to decouple various parts
  // of an application through event-driven architecture.
  
  Wreqr.EventAggregator = (function(Backbone, _){
    "use strict";
    var EA = function(){};
  
    // Copy the `extend` function used by Backbone's classes
    EA.extend = Backbone.Model.extend;
  
    // Copy the basic Backbone.Events on to the event aggregator
    _.extend(EA.prototype, Backbone.Events);
  
    return EA;
  })(Backbone, _);
  
  // Wreqr.Channel
  // --------------
  //
  // An object that wraps the three messaging systems:
  // EventAggregator, RequestResponse, Commands
  Wreqr.Channel = (function(Wreqr){
    "use strict";
  
    var Channel = function(channelName) {
      this.vent        = new Backbone.Wreqr.EventAggregator();
      this.reqres      = new Backbone.Wreqr.RequestResponse();
      this.commands    = new Backbone.Wreqr.Commands();
      this.channelName = channelName;
    };
  
    _.extend(Channel.prototype, {
  
      // Remove all handlers from the messaging systems of this channel
      reset: function() {
        this.vent.off();
        this.vent.stopListening();
        this.reqres.removeAllHandlers();
        this.commands.removeAllHandlers();
        return this;
      },
  
      // Connect a hash of events; one for each messaging system
      connectEvents: function(hash, context) {
        this._connect('vent', hash, context);
        return this;
      },
  
      connectCommands: function(hash, context) {
        this._connect('commands', hash, context);
        return this;
      },
  
      connectRequests: function(hash, context) {
        this._connect('reqres', hash, context);
        return this;
      },
  
      // Attach the handlers to a given message system `type`
      _connect: function(type, hash, context) {
        if (!hash) {
          return;
        }
  
        context = context || this;
        var method = (type === 'vent') ? 'on' : 'setHandler';
  
        _.each(hash, _.bind(function(fn, eventName) {
          this[type][method](eventName, _.bind(fn, context));
        }, this));
      }
    });
  
  
    return Channel;
  })(Wreqr);
  
  // Wreqr.Radio
  // --------------
  //
  // An object that lets you communicate with many channels.
  Wreqr.radio = (function(Wreqr, _){
    "use strict";
  
    var Radio = function() {
      this._channels = {};
      this.vent = {};
      this.commands = {};
      this.reqres = {};
      this._proxyMethods();
    };
  
    _.extend(Radio.prototype, {
  
      channel: function(channelName) {
        if (!channelName) {
          throw new Error('Channel must receive a name');
        }
  
        return this._getChannel( channelName );
      },
  
      _getChannel: function(channelName) {
        var channel = this._channels[channelName];
  
        if(!channel) {
          channel = new Wreqr.Channel(channelName);
          this._channels[channelName] = channel;
        }
  
        return channel;
      },
  
      _proxyMethods: function() {
        _.each(['vent', 'commands', 'reqres'], _.bind(function(system) {
          _.each( messageSystems[system], _.bind(function(method) {
            this[system][method] = proxyMethod(this, system, method);
          }, this));
        }, this));
      }
    });
  
  
    var messageSystems = {
      vent: [
        'on',
        'off',
        'trigger',
        'once',
        'stopListening',
        'listenTo',
        'listenToOnce'
      ],
  
      commands: [
        'execute',
        'setHandler',
        'setHandlers',
        'removeHandler',
        'removeAllHandlers'
      ],
  
      reqres: [
        'request',
        'setHandler',
        'setHandlers',
        'removeHandler',
        'removeAllHandlers'
      ]
    };
  
    var proxyMethod = function(radio, system, method) {
      return function(channelName) {
        var messageSystem = radio._getChannel(channelName)[system];
  
        return messageSystem[method].apply(messageSystem, _.rest(arguments));
      };
    };
  
    return new Radio();
  
  })(Wreqr, _);
  

  return Backbone.Wreqr;

}));

// Backbone.BabySitter
// -------------------
// v0.1.11
//
// Copyright (c)2016 Derick Bailey, Muted Solutions, LLC.
// Distributed under MIT license
//
// http://github.com/marionettejs/backbone.babysitter

(function(root, factory) {

  if (typeof define === 'function' && define.amd) {
    define('backbone.babysitter',['backbone', 'underscore'], function(Backbone, _) {
      return factory(Backbone, _);
    });
  } else if (typeof exports !== 'undefined') {
    var Backbone = require('backbone');
    var _ = require('underscore');
    module.exports = factory(Backbone, _);
  } else {
    factory(root.Backbone, root._);
  }

}(this, function(Backbone, _) {
  'use strict';

  var previousChildViewContainer = Backbone.ChildViewContainer;

  // BabySitter.ChildViewContainer
  // -----------------------------
  //
  // Provide a container to store, retrieve and
  // shut down child views.
  
  Backbone.ChildViewContainer = (function (Backbone, _) {
  
    // Container Constructor
    // ---------------------
  
    var Container = function(views){
      this._views = {};
      this._indexByModel = {};
      this._indexByCustom = {};
      this._updateLength();
  
      _.each(views, this.add, this);
    };
  
    // Container Methods
    // -----------------
  
    _.extend(Container.prototype, {
  
      // Add a view to this container. Stores the view
      // by `cid` and makes it searchable by the model
      // cid (and model itself). Optionally specify
      // a custom key to store an retrieve the view.
      add: function(view, customIndex){
        var viewCid = view.cid;
  
        // store the view
        this._views[viewCid] = view;
  
        // index it by model
        if (view.model){
          this._indexByModel[view.model.cid] = viewCid;
        }
  
        // index by custom
        if (customIndex){
          this._indexByCustom[customIndex] = viewCid;
        }
  
        this._updateLength();
        return this;
      },
  
      // Find a view by the model that was attached to
      // it. Uses the model's `cid` to find it.
      findByModel: function(model){
        return this.findByModelCid(model.cid);
      },
  
      // Find a view by the `cid` of the model that was attached to
      // it. Uses the model's `cid` to find the view `cid` and
      // retrieve the view using it.
      findByModelCid: function(modelCid){
        var viewCid = this._indexByModel[modelCid];
        return this.findByCid(viewCid);
      },
  
      // Find a view by a custom indexer.
      findByCustom: function(index){
        var viewCid = this._indexByCustom[index];
        return this.findByCid(viewCid);
      },
  
      // Find by index. This is not guaranteed to be a
      // stable index.
      findByIndex: function(index){
        return _.values(this._views)[index];
      },
  
      // retrieve a view by its `cid` directly
      findByCid: function(cid){
        return this._views[cid];
      },
  
      // Remove a view
      remove: function(view){
        var viewCid = view.cid;
  
        // delete model index
        if (view.model){
          delete this._indexByModel[view.model.cid];
        }
  
        // delete custom index
        _.any(this._indexByCustom, function(cid, key) {
          if (cid === viewCid) {
            delete this._indexByCustom[key];
            return true;
          }
        }, this);
  
        // remove the view from the container
        delete this._views[viewCid];
  
        // update the length
        this._updateLength();
        return this;
      },
  
      // Call a method on every view in the container,
      // passing parameters to the call method one at a
      // time, like `function.call`.
      call: function(method){
        this.apply(method, _.tail(arguments));
      },
  
      // Apply a method on every view in the container,
      // passing parameters to the call method one at a
      // time, like `function.apply`.
      apply: function(method, args){
        _.each(this._views, function(view){
          if (_.isFunction(view[method])){
            view[method].apply(view, args || []);
          }
        });
      },
  
      // Update the `.length` attribute on this container
      _updateLength: function(){
        this.length = _.size(this._views);
      }
    });
  
    // Borrowing this code from Backbone.Collection:
    // http://backbonejs.org/docs/backbone.html#section-106
    //
    // Mix in methods from Underscore, for iteration, and other
    // collection related features.
    var methods = ['forEach', 'each', 'map', 'find', 'detect', 'filter',
      'select', 'reject', 'every', 'all', 'some', 'any', 'include',
      'contains', 'invoke', 'toArray', 'first', 'initial', 'rest',
      'last', 'without', 'isEmpty', 'pluck', 'reduce'];
  
    _.each(methods, function(method) {
      Container.prototype[method] = function() {
        var views = _.values(this._views);
        var args = [views].concat(_.toArray(arguments));
        return _[method].apply(_, args);
      };
    });
  
    // return the public API
    return Container;
  })(Backbone, _);
  

  Backbone.ChildViewContainer.VERSION = '0.1.11';

  Backbone.ChildViewContainer.noConflict = function () {
    Backbone.ChildViewContainer = previousChildViewContainer;
    return this;
  };

  return Backbone.ChildViewContainer;

}));

// MarionetteJS (Backbone.Marionette)
// ----------------------------------
// v1.7.4
//
// Copyright (c)2014 Derick Bailey, Muted Solutions, LLC.
// Distributed under MIT license
//
// http://marionettejs.com



/*!
 * Includes BabySitter
 * https://github.com/marionettejs/backbone.babysitter/
 *
 * Includes Wreqr
 * https://github.com/marionettejs/backbone.wreqr/
 */

(function (root, factory) {
  if (typeof exports === 'object') {

    var underscore = require('underscore');
    var backbone = require('backbone');
    var wreqr = require('backbone.wreqr');
    var babysitter = require('backbone.babysitter');

    module.exports = factory(underscore, backbone, wreqr, babysitter);

  } else if (typeof define === 'function' && define.amd) {

    define('backbone-marionette',['underscore', 'backbone', 'backbone.wreqr', 'backbone.babysitter'], factory);

  }
}(this, function (_, Backbone) {

  var Marionette = (function(global, Backbone, _){
  "use strict";

  // Define and export the Marionette namespace
  var Marionette = {};
  Backbone.Marionette = Marionette;

  // Get the DOM manipulator for later use
  Marionette.$ = Backbone.$;

// Helpers
// -------

// For slicing `arguments` in functions
var slice = Array.prototype.slice;

function throwError(message, name) {
  var error = new Error(message);
  error.name = name || 'Error';
  throw error;
}

// Marionette.extend
// -----------------

// Borrow the Backbone `extend` method so we can use it as needed
Marionette.extend = Backbone.Model.extend;

// Marionette.getOption
// --------------------

// Retrieve an object, function or other value from a target
// object or its `options`, with `options` taking precedence.
Marionette.getOption = function(target, optionName){
  if (!target || !optionName){ return; }
  var value;

  if (target.options && (optionName in target.options) && (target.options[optionName] !== undefined)){
    value = target.options[optionName];
  } else {
    value = target[optionName];
  }

  return value;
};

// Marionette.normalizeMethods
// ----------------------

// Pass in a mapping of events => functions or function names
// and return a mapping of events => functions
Marionette.normalizeMethods = function(hash) {
  var normalizedHash = {}, method;
  _.each(hash, function(fn, name) {
    method = fn;
    if (!_.isFunction(method)) {
      method = this[method];
    }
    if (!method) {
      return;
    }
    normalizedHash[name] = method;
  }, this);
  return normalizedHash;
};


// allows for the use of the @ui. syntax within
// a given key for triggers and events
// swaps the @ui with the associated selector
Marionette.normalizeUIKeys = function(hash, ui) {
  if (typeof(hash) === "undefined") {
    return;
  }

  _.each(_.keys(hash), function(v) {
    var pattern = /@ui.[a-zA-Z_$0-9]*/g;
    if (v.match(pattern)) {
      hash[v.replace(pattern, function(r) {
        return ui[r.slice(4)];
      })] = hash[v];
      delete hash[v];
    }
  });

  return hash;
};

// Trigger an event and/or a corresponding method name. Examples:
//
// `this.triggerMethod("foo")` will trigger the "foo" event and
// call the "onFoo" method.
//
// `this.triggerMethod("foo:bar")` will trigger the "foo:bar" event and
// call the "onFooBar" method.
Marionette.triggerMethod = (function(){

  // split the event name on the ":"
  var splitter = /(^|:)(\w)/gi;

  // take the event section ("section1:section2:section3")
  // and turn it in to uppercase name
  function getEventName(match, prefix, eventName) {
    return eventName.toUpperCase();
  }

  // actual triggerMethod implementation
  var triggerMethod = function(event) {
    // get the method name from the event name
    var methodName = 'on' + event.replace(splitter, getEventName);
    var method = this[methodName];

    // trigger the event, if a trigger method exists
    if(_.isFunction(this.trigger)) {
      this.trigger.apply(this, arguments);
    }

    // call the onMethodName if it exists
    if (_.isFunction(method)) {
      // pass all arguments, except the event name
      return method.apply(this, _.tail(arguments));
    }
  };

  return triggerMethod;
})();

// DOMRefresh
// ----------
//
// Monitor a view's state, and after it has been rendered and shown
// in the DOM, trigger a "dom:refresh" event every time it is
// re-rendered.

Marionette.MonitorDOMRefresh = (function(documentElement){
  // track when the view has been shown in the DOM,
  // using a Marionette.Region (or by other means of triggering "show")
  function handleShow(view){
    view._isShown = true;
    triggerDOMRefresh(view);
  }

  // track when the view has been rendered
  function handleRender(view){
    view._isRendered = true;
    triggerDOMRefresh(view);
  }

  // Trigger the "dom:refresh" event and corresponding "onDomRefresh" method
  function triggerDOMRefresh(view){
    if (view._isShown && view._isRendered && isInDOM(view)){
      if (_.isFunction(view.triggerMethod)){
        view.triggerMethod("dom:refresh");
      }
    }
  }

  function isInDOM(view) {
    return documentElement.contains(view.el);
  }

  // Export public API
  return function(view){
    view.listenTo(view, "show", function(){
      handleShow(view);
    });

    view.listenTo(view, "render", function(){
      handleRender(view);
    });
  };
})(document.documentElement);


// Marionette.bindEntityEvents & unbindEntityEvents
// ---------------------------
//
// These methods are used to bind/unbind a backbone "entity" (collection/model)
// to methods on a target object.
//
// The first parameter, `target`, must have a `listenTo` method from the
// EventBinder object.
//
// The second parameter is the entity (Backbone.Model or Backbone.Collection)
// to bind the events from.
//
// The third parameter is a hash of { "event:name": "eventHandler" }
// configuration. Multiple handlers can be separated by a space. A
// function can be supplied instead of a string handler name.

(function(Marionette){
  "use strict";

  // Bind the event to handlers specified as a string of
  // handler names on the target object
  function bindFromStrings(target, entity, evt, methods){
    var methodNames = methods.split(/\s+/);

    _.each(methodNames,function(methodName) {

      var method = target[methodName];
      if(!method) {
        throwError("Method '"+ methodName +"' was configured as an event handler, but does not exist.");
      }

      target.listenTo(entity, evt, method);
    });
  }

  // Bind the event to a supplied callback function
  function bindToFunction(target, entity, evt, method){
      target.listenTo(entity, evt, method);
  }

  // Bind the event to handlers specified as a string of
  // handler names on the target object
  function unbindFromStrings(target, entity, evt, methods){
    var methodNames = methods.split(/\s+/);

    _.each(methodNames,function(methodName) {
      var method = target[methodName];
      target.stopListening(entity, evt, method);
    });
  }

  // Bind the event to a supplied callback function
  function unbindToFunction(target, entity, evt, method){
      target.stopListening(entity, evt, method);
  }


  // generic looping function
  function iterateEvents(target, entity, bindings, functionCallback, stringCallback){
    if (!entity || !bindings) { return; }

    // allow the bindings to be a function
    if (_.isFunction(bindings)){
      bindings = bindings.call(target);
    }

    // iterate the bindings and bind them
    _.each(bindings, function(methods, evt){

      // allow for a function as the handler,
      // or a list of event names as a string
      if (_.isFunction(methods)){
        functionCallback(target, entity, evt, methods);
      } else {
        stringCallback(target, entity, evt, methods);
      }

    });
  }

  // Export Public API
  Marionette.bindEntityEvents = function(target, entity, bindings){
    iterateEvents(target, entity, bindings, bindToFunction, bindFromStrings);
  };

  Marionette.unbindEntityEvents = function(target, entity, bindings){
    iterateEvents(target, entity, bindings, unbindToFunction, unbindFromStrings);
  };

})(Marionette);


// Callbacks
// ---------

// A simple way of managing a collection of callbacks
// and executing them at a later point in time, using jQuery's
// `Deferred` object.
Marionette.Callbacks = function(){
  this._deferred = Marionette.$.Deferred();
  this._callbacks = [];
};

_.extend(Marionette.Callbacks.prototype, {

  // Add a callback to be executed. Callbacks added here are
  // guaranteed to execute, even if they are added after the
  // `run` method is called.
  add: function(callback, contextOverride){
    this._callbacks.push({cb: callback, ctx: contextOverride});

    this._deferred.done(function(context, options){
      if (contextOverride){ context = contextOverride; }
      callback.call(context, options);
    });
  },

  // Run all registered callbacks with the context specified.
  // Additional callbacks can be added after this has been run
  // and they will still be executed.
  run: function(options, context){
    this._deferred.resolve(context, options);
  },

  // Resets the list of callbacks to be run, allowing the same list
  // to be run multiple times - whenever the `run` method is called.
  reset: function(){
    var callbacks = this._callbacks;
    this._deferred = Marionette.$.Deferred();
    this._callbacks = [];

    _.each(callbacks, function(cb){
      this.add(cb.cb, cb.ctx);
    }, this);
  }
});


// Marionette Controller
// ---------------------
//
// A multi-purpose object to use as a controller for
// modules and routers, and as a mediator for workflow
// and coordination of other objects, views, and more.
Marionette.Controller = function(options){
  this.triggerMethod = Marionette.triggerMethod;
  this.options = options || {};

  if (_.isFunction(this.initialize)){
    this.initialize(this.options);
  }
};

Marionette.Controller.extend = Marionette.extend;

// Controller Methods
// --------------

// Ensure it can trigger events with Backbone.Events
_.extend(Marionette.Controller.prototype, Backbone.Events, {
  close: function(){
    this.stopListening();
    var args = Array.prototype.slice.call(arguments);
    this.triggerMethod.apply(this, ["close"].concat(args));
    this.unbind();
  }
});

// Region
// ------
//
// Manage the visual regions of your composite application. See
// http://lostechies.com/derickbailey/2011/12/12/composite-js-apps-regions-and-region-managers/

Marionette.Region = function(options){
  this.options = options || {};
  this.el = Marionette.getOption(this, "el");

  if (!this.el){
    throwError("An 'el' must be specified for a region.", "NoElError");
  }

  if (this.initialize){
    var args = Array.prototype.slice.apply(arguments);
    this.initialize.apply(this, args);
  }
};


// Region Type methods
// -------------------

_.extend(Marionette.Region, {

  // Build an instance of a region by passing in a configuration object
  // and a default region type to use if none is specified in the config.
  //
  // The config object should either be a string as a jQuery DOM selector,
  // a Region type directly, or an object literal that specifies both
  // a selector and regionType:
  //
  // ```js
  // {
  //   selector: "#foo",
  //   regionType: MyCustomRegion
  // }
  // ```
  //
  buildRegion: function(regionConfig, defaultRegionType){
    var regionIsString = _.isString(regionConfig);
    var regionSelectorIsString = _.isString(regionConfig.selector);
    var regionTypeIsUndefined = _.isUndefined(regionConfig.regionType);
    var regionIsType = _.isFunction(regionConfig);

    if (!regionIsType && !regionIsString && !regionSelectorIsString) {
      throwError("Region must be specified as a Region type, a selector string or an object with selector property");
    }

    var selector, RegionType;

    // get the selector for the region

    if (regionIsString) {
      selector = regionConfig;
    }

    if (regionConfig.selector) {
      selector = regionConfig.selector;
      delete regionConfig.selector;
    }

    // get the type for the region

    if (regionIsType){
      RegionType = regionConfig;
    }

    if (!regionIsType && regionTypeIsUndefined) {
      RegionType = defaultRegionType;
    }

    if (regionConfig.regionType) {
      RegionType = regionConfig.regionType;
      delete regionConfig.regionType;
    }

    if (regionIsString || regionIsType) {
      regionConfig = {};
    }

    regionConfig.el = selector;

    // build the region instance
    var region = new RegionType(regionConfig);

    // override the `getEl` function if we have a parentEl
    // this must be overridden to ensure the selector is found
    // on the first use of the region. if we try to assign the
    // region's `el` to `parentEl.find(selector)` in the object
    // literal to build the region, the element will not be
    // guaranteed to be in the DOM already, and will cause problems
    if (regionConfig.parentEl){
      region.getEl = function(selector) {
        var parentEl = regionConfig.parentEl;
        if (_.isFunction(parentEl)){
          parentEl = parentEl();
        }
        return parentEl.find(selector);
      };
    }

    return region;
  }

});

// Region Instance Methods
// -----------------------

_.extend(Marionette.Region.prototype, Backbone.Events, {

  // Displays a backbone view instance inside of the region.
  // Handles calling the `render` method for you. Reads content
  // directly from the `el` attribute. Also calls an optional
  // `onShow` and `close` method on your view, just after showing
  // or just before closing the view, respectively.
  show: function(view){
    this.ensureEl();

    var isViewClosed = view.isClosed || _.isUndefined(view.$el);
    var isDifferentView = view !== this.currentView;

    if (isDifferentView) {
      this.close();
    }

    view.render();
    Marionette.triggerMethod.call(this, "before:show", view);
    Marionette.triggerMethod.call(view, "before:show");

    if (isDifferentView || isViewClosed) {
      this.open(view);
    }

    this.currentView = view;

    Marionette.triggerMethod.call(this, "show", view);
    Marionette.triggerMethod.call(view, "show");
  },

  ensureEl: function(){
    if (!this.$el || this.$el.length === 0){
      this.$el = this.getEl(this.el);
    }
  },

  // Override this method to change how the region finds the
  // DOM element that it manages. Return a jQuery selector object.
  getEl: function(selector){
    return Marionette.$(selector);
  },

  // Override this method to change how the new view is
  // appended to the `$el` that the region is managing
  open: function(view){
    this.$el.empty().append(view.el);
  },

  // Close the current view, if there is one. If there is no
  // current view, it does nothing and returns immediately.
  close: function(){
    var view = this.currentView;
    if (!view || view.isClosed){ return; }

    // call 'close' or 'remove', depending on which is found
    if (view.close) { view.close(); }
    else if (view.remove) { view.remove(); }

    Marionette.triggerMethod.call(this, "close", view);

    delete this.currentView;
  },

  // Attach an existing view to the region. This
  // will not call `render` or `onShow` for the new view,
  // and will not replace the current HTML for the `el`
  // of the region.
  attachView: function(view){
    this.currentView = view;
  },

  // Reset the region by closing any existing view and
  // clearing out the cached `$el`. The next time a view
  // is shown via this region, the region will re-query the
  // DOM for the region's `el`.
  reset: function(){
    this.close();
    delete this.$el;
  }
});

// Copy the `extend` function used by Backbone's classes
Marionette.Region.extend = Marionette.extend;

// Marionette.RegionManager
// ------------------------
//
// Manage one or more related `Marionette.Region` objects.
Marionette.RegionManager = (function(Marionette){

  var RegionManager = Marionette.Controller.extend({
    constructor: function(options){
      this._regions = {};
      Marionette.Controller.prototype.constructor.call(this, options);
    },

    // Add multiple regions using an object literal, where
    // each key becomes the region name, and each value is
    // the region definition.
    addRegions: function(regionDefinitions, defaults){
      var regions = {};

      _.each(regionDefinitions, function(definition, name){
        if (_.isString(definition)){
          definition = { selector: definition };
        }

        if (definition.selector){
          definition = _.defaults({}, definition, defaults);
        }

        var region = this.addRegion(name, definition);
        regions[name] = region;
      }, this);

      return regions;
    },

    // Add an individual region to the region manager,
    // and return the region instance
    addRegion: function(name, definition){
      var region;

      var isObject = _.isObject(definition);
      var isString = _.isString(definition);
      var hasSelector = !!definition.selector;

      if (isString || (isObject && hasSelector)){
        region = Marionette.Region.buildRegion(definition, Marionette.Region);
      } else if (_.isFunction(definition)){
        region = Marionette.Region.buildRegion(definition, Marionette.Region);
      } else {
        region = definition;
      }

      this._store(name, region);
      this.triggerMethod("region:add", name, region);
      return region;
    },

    // Get a region by name
    get: function(name){
      return this._regions[name];
    },

    // Remove a region by name
    removeRegion: function(name){
      var region = this._regions[name];
      this._remove(name, region);
    },

    // Close all regions in the region manager, and
    // remove them
    removeRegions: function(){
      _.each(this._regions, function(region, name){
        this._remove(name, region);
      }, this);
    },

    // Close all regions in the region manager, but
    // leave them attached
    closeRegions: function(){
      _.each(this._regions, function(region, name){
        region.close();
      }, this);
    },

    // Close all regions and shut down the region
    // manager entirely
    close: function(){
      this.removeRegions();
      Marionette.Controller.prototype.close.apply(this, arguments);
    },

    // internal method to store regions
    _store: function(name, region){
      this._regions[name] = region;
      this._setLength();
    },

    // internal method to remove a region
    _remove: function(name, region){
      region.close();
      delete this._regions[name];
      this._setLength();
      this.triggerMethod("region:remove", name, region);
    },

    // set the number of regions current held
    _setLength: function(){
      this.length = _.size(this._regions);
    }

  });

  // Borrowing this code from Backbone.Collection:
  // http://backbonejs.org/docs/backbone.html#section-106
  //
  // Mix in methods from Underscore, for iteration, and other
  // collection related features.
  var methods = ['forEach', 'each', 'map', 'find', 'detect', 'filter',
    'select', 'reject', 'every', 'all', 'some', 'any', 'include',
    'contains', 'invoke', 'toArray', 'first', 'initial', 'rest',
    'last', 'without', 'isEmpty', 'pluck'];

  _.each(methods, function(method) {
    RegionManager.prototype[method] = function() {
      var regions = _.values(this._regions);
      var args = [regions].concat(_.toArray(arguments));
      return _[method].apply(_, args);
    };
  });

  return RegionManager;
})(Marionette);


// Template Cache
// --------------

// Manage templates stored in `<script>` blocks,
// caching them for faster access.
Marionette.TemplateCache = function(templateId){
  this.templateId = templateId;
};

// TemplateCache object-level methods. Manage the template
// caches from these method calls instead of creating
// your own TemplateCache instances
_.extend(Marionette.TemplateCache, {
  templateCaches: {},

  // Get the specified template by id. Either
  // retrieves the cached version, or loads it
  // from the DOM.
  get: function(templateId){
    var cachedTemplate = this.templateCaches[templateId];

    if (!cachedTemplate){
      cachedTemplate = new Marionette.TemplateCache(templateId);
      this.templateCaches[templateId] = cachedTemplate;
    }

    return cachedTemplate.load();
  },

  // Clear templates from the cache. If no arguments
  // are specified, clears all templates:
  // `clear()`
  //
  // If arguments are specified, clears each of the
  // specified templates from the cache:
  // `clear("#t1", "#t2", "...")`
  clear: function(){
    var i;
    var args = slice.call(arguments);
    var length = args.length;

    if (length > 0){
      for(i=0; i<length; i++){
        delete this.templateCaches[args[i]];
      }
    } else {
      this.templateCaches = {};
    }
  }
});

// TemplateCache instance methods, allowing each
// template cache object to manage its own state
// and know whether or not it has been loaded
_.extend(Marionette.TemplateCache.prototype, {

  // Internal method to load the template
  load: function(){
    // Guard clause to prevent loading this template more than once
    if (this.compiledTemplate){
      return this.compiledTemplate;
    }

    // Load the template and compile it
    var template = this.loadTemplate(this.templateId);
    this.compiledTemplate = this.compileTemplate(template);

    return this.compiledTemplate;
  },

  // Load a template from the DOM, by default. Override
  // this method to provide your own template retrieval
  // For asynchronous loading with AMD/RequireJS, consider
  // using a template-loader plugin as described here:
  // https://github.com/marionettejs/backbone.marionette/wiki/Using-marionette-with-requirejs
  loadTemplate: function(templateId){
    var template = Marionette.$(templateId).html();

    if (!template || template.length === 0){
      throwError("Could not find template: '" + templateId + "'", "NoTemplateError");
    }

    return template;
  },

  // Pre-compile the template before caching it. Override
  // this method if you do not need to pre-compile a template
  // (JST / RequireJS for example) or if you want to change
  // the template engine used (Handebars, etc).
  compileTemplate: function(rawTemplate){
    return _.template(rawTemplate);
  }
});


// Renderer
// --------

// Render a template with data by passing in the template
// selector and the data to render.
Marionette.Renderer = {

  // Render a template with data. The `template` parameter is
  // passed to the `TemplateCache` object to retrieve the
  // template function. Override this method to provide your own
  // custom rendering and template handling for all of Marionette.
  render: function(template, data){

    if (!template) {
      throwError("Cannot render the template since it's false, null or undefined.", "TemplateNotFoundError");
    }

    var templateFunc;
    if (typeof template === "function"){
      templateFunc = template;
    } else {
      templateFunc = Marionette.TemplateCache.get(template);
    }

    return templateFunc(data);
  }
};



// Marionette.View
// ---------------

// The core view type that other Marionette views extend from.
Marionette.View = Backbone.View.extend({

  constructor: function(options){
    _.bindAll(this, "render");

    if (_.isObject(this.behaviors)) {
      new Marionette.Behaviors(this);
    }

    // this exposes view options to the view initializer
    // this is a backfill since backbone removed the assignment
    // of this.options
    // at some point however this may be removed
    this.options = _.extend({}, _.result(this, 'options'), _.isFunction(options) ? options.call(this) : options);

    // parses out the @ui DSL for events
    this.events = this.normalizeUIKeys(_.result(this, 'events'));
    Backbone.View.prototype.constructor.apply(this, arguments);

    Marionette.MonitorDOMRefresh(this);
    this.listenTo(this, "show", this.onShowCalled);
  },

  // import the "triggerMethod" to trigger events with corresponding
  // methods if the method exists
  triggerMethod: Marionette.triggerMethod,

  // Imports the "normalizeMethods" to transform hashes of
  // events=>function references/names to a hash of events=>function references
  normalizeMethods: Marionette.normalizeMethods,

  // Get the template for this view
  // instance. You can set a `template` attribute in the view
  // definition or pass a `template: "whatever"` parameter in
  // to the constructor options.
  getTemplate: function(){
    return Marionette.getOption(this, "template");
  },

  // Mix in template helper methods. Looks for a
  // `templateHelpers` attribute, which can either be an
  // object literal, or a function that returns an object
  // literal. All methods and attributes from this object
  // are copies to the object passed in.
  mixinTemplateHelpers: function(target){
    target = target || {};
    var templateHelpers = Marionette.getOption(this, "templateHelpers");
    if (_.isFunction(templateHelpers)){
      templateHelpers = templateHelpers.call(this);
    }
    return _.extend(target, templateHelpers);
  },


  normalizeUIKeys: function(hash) {
    var ui = _.result(this, 'ui');
    return Marionette.normalizeUIKeys(hash, ui);
  },

  // Configure `triggers` to forward DOM events to view
  // events. `triggers: {"click .foo": "do:foo"}`
  configureTriggers: function(){
    if (!this.triggers) { return; }

    var triggerEvents = {};

    // Allow `triggers` to be configured as a function
    var triggers = this.normalizeUIKeys(_.result(this, "triggers"));

    // Configure the triggers, prevent default
    // action and stop propagation of DOM events
    _.each(triggers, function(value, key){

      var hasOptions = _.isObject(value);
      var eventName = hasOptions ? value.event : value;

      // build the event handler function for the DOM event
      triggerEvents[key] = function(e){

        // stop the event in its tracks
        if (e) {
          var prevent = e.preventDefault;
          var stop = e.stopPropagation;

          var shouldPrevent = hasOptions ? value.preventDefault : prevent;
          var shouldStop = hasOptions ? value.stopPropagation : stop;

          if (shouldPrevent && prevent) { prevent.apply(e); }
          if (shouldStop && stop) { stop.apply(e); }
        }

        // build the args for the event
        var args = {
          view: this,
          model: this.model,
          collection: this.collection
        };

        // trigger the event
        this.triggerMethod(eventName, args);
      };

    }, this);

    return triggerEvents;
  },

  // Overriding Backbone.View's delegateEvents to handle
  // the `triggers`, `modelEvents`, and `collectionEvents` configuration
  delegateEvents: function(events){
    this._delegateDOMEvents(events);
    Marionette.bindEntityEvents(this, this.model, Marionette.getOption(this, "modelEvents"));
    Marionette.bindEntityEvents(this, this.collection, Marionette.getOption(this, "collectionEvents"));
  },

  // internal method to delegate DOM events and triggers
  _delegateDOMEvents: function(events){
    events = events || this.events;
    if (_.isFunction(events)){ events = events.call(this); }

    var combinedEvents = {};

    // look up if this view has behavior events
    var behaviorEvents = _.result(this, 'behaviorEvents') || {};
    var triggers = this.configureTriggers();

    // behavior events will be overriden by view events and or triggers
    _.extend(combinedEvents, behaviorEvents, events, triggers);

    Backbone.View.prototype.delegateEvents.call(this, combinedEvents);
  },

  // Overriding Backbone.View's undelegateEvents to handle unbinding
  // the `triggers`, `modelEvents`, and `collectionEvents` config
  undelegateEvents: function(){
    var args = Array.prototype.slice.call(arguments);
    Backbone.View.prototype.undelegateEvents.apply(this, args);

    Marionette.unbindEntityEvents(this, this.model, Marionette.getOption(this, "modelEvents"));
    Marionette.unbindEntityEvents(this, this.collection, Marionette.getOption(this, "collectionEvents"));
  },

  // Internal method, handles the `show` event.
  onShowCalled: function(){},

  // Default `close` implementation, for removing a view from the
  // DOM and unbinding it. Regions will call this method
  // for you. You can specify an `onClose` method in your view to
  // add custom code that is called after the view is closed.
  close: function(){
    if (this.isClosed) { return; }

    var args = Array.prototype.slice.call(arguments);

    // allow the close to be stopped by returning `false`
    // from the `onBeforeClose` method
    var shouldClose = this.triggerMethod.apply(this, ["before:close"].concat(args));
    if (shouldClose === false){
      return;
    }

    // mark as closed before doing the actual close, to
    // prevent infinite loops within "close" event handlers
    // that are trying to close other views
    this.isClosed = true;
    this.triggerMethod.apply(this, ["close"].concat(args));

    // unbind UI elements
    this.unbindUIElements();

    // remove the view from the DOM
    this.remove();
  },

  // This method binds the elements specified in the "ui" hash inside the view's code with
  // the associated jQuery selectors.
  bindUIElements: function(){
    if (!this.ui) { return; }

    // store the ui hash in _uiBindings so they can be reset later
    // and so re-rendering the view will be able to find the bindings
    if (!this._uiBindings){
      this._uiBindings = this.ui;
    }

    // get the bindings result, as a function or otherwise
    var bindings = _.result(this, "_uiBindings");

    // empty the ui so we don't have anything to start with
    this.ui = {};

    // bind each of the selectors
    _.each(_.keys(bindings), function(key) {
      var selector = bindings[key];
      this.ui[key] = this.$(selector);
    }, this);
  },

  // This method unbinds the elements specified in the "ui" hash
  unbindUIElements: function(){
    if (!this.ui || !this._uiBindings){ return; }

    // delete all of the existing ui bindings
    _.each(this.ui, function($el, name){
      delete this.ui[name];
    }, this);

    // reset the ui element to the original bindings configuration
    this.ui = this._uiBindings;
    delete this._uiBindings;
  }
});

// Item View
// ---------

// A single item view implementation that contains code for rendering
// with underscore.js templates, serializing the view's model or collection,
// and calling several methods on extended views, such as `onRender`.
Marionette.ItemView = Marionette.View.extend({

  // Setting up the inheritance chain which allows changes to
  // Marionette.View.prototype.constructor which allows overriding
  constructor: function(){
    Marionette.View.prototype.constructor.apply(this, arguments);
  },

  // Serialize the model or collection for the view. If a model is
  // found, `.toJSON()` is called. If a collection is found, `.toJSON()`
  // is also called, but is used to populate an `items` array in the
  // resulting data. If both are found, defaults to the model.
  // You can override the `serializeData` method in your own view
  // definition, to provide custom serialization for your view's data.
  serializeData: function(){
    var data = {};

    if (this.model) {
      data = this.model.toJSON();
    }
    else if (this.collection) {
      data = { items: this.collection.toJSON() };
    }

    return data;
  },

  // Render the view, defaulting to underscore.js templates.
  // You can override this in your view definition to provide
  // a very specific rendering for your view. In general, though,
  // you should override the `Marionette.Renderer` object to
  // change how Marionette renders views.
  render: function(){
    this.isClosed = false;

    this.triggerMethod("before:render", this);
    this.triggerMethod("item:before:render", this);

    var data = this.serializeData();
    data = this.mixinTemplateHelpers(data);

    var template = this.getTemplate();
    var html = Marionette.Renderer.render(template, data);

    this.$el.html(html);
    this.bindUIElements();

    this.triggerMethod("render", this);
    this.triggerMethod("item:rendered", this);

    return this;
  },

  // Override the default close event to add a few
  // more events that are triggered.
  close: function(){
    if (this.isClosed){ return; }

    this.triggerMethod('item:before:close');

    Marionette.View.prototype.close.apply(this, arguments);

    this.triggerMethod('item:closed');
  }
});

// Collection View
// ---------------

// A view that iterates over a Backbone.Collection
// and renders an individual ItemView for each model.
Marionette.CollectionView = Marionette.View.extend({
  // used as the prefix for item view events
  // that are forwarded through the collectionview
  itemViewEventPrefix: "itemview",

  // constructor
  constructor: function(options){
    this._initChildViewStorage();

    Marionette.View.prototype.constructor.apply(this, arguments);

    this._initialEvents();
    this.initRenderBuffer();
  },

  // Instead of inserting elements one by one into the page,
  // it's much more performant to insert elements into a document
  // fragment and then insert that document fragment into the page
  initRenderBuffer: function() {
    this.elBuffer = document.createDocumentFragment();
    this._bufferedChildren = [];
  },

  startBuffering: function() {
    this.initRenderBuffer();
    this.isBuffering = true;
  },

  endBuffering: function() {
    this.isBuffering = false;
    this.appendBuffer(this, this.elBuffer);
    this._triggerShowBufferedChildren();
    this.initRenderBuffer();
  },

  _triggerShowBufferedChildren: function () {
    if (this._isShown) {
      _.each(this._bufferedChildren, function (child) {
        Marionette.triggerMethod.call(child, "show");
      });
      this._bufferedChildren = [];
    }
  },

  // Configured the initial events that the collection view
  // binds to.
  _initialEvents: function(){
    if (this.collection){
      this.listenTo(this.collection, "add", this.addChildView);
      this.listenTo(this.collection, "remove", this.removeItemView);
      this.listenTo(this.collection, "reset", this.render);
    }
  },

  // Handle a child item added to the collection
  addChildView: function(item, collection, options){
    this.closeEmptyView();
    var ItemView = this.getItemView(item);
    var index = this.collection.indexOf(item);
    this.addItemView(item, ItemView, index);
  },

  // Override from `Marionette.View` to guarantee the `onShow` method
  // of child views is called.
  onShowCalled: function(){
    this.children.each(function(child){
      Marionette.triggerMethod.call(child, "show");
    });
  },

  // Internal method to trigger the before render callbacks
  // and events
  triggerBeforeRender: function(){
    this.triggerMethod("before:render", this);
    this.triggerMethod("collection:before:render", this);
  },

  // Internal method to trigger the rendered callbacks and
  // events
  triggerRendered: function(){
    this.triggerMethod("render", this);
    this.triggerMethod("collection:rendered", this);
  },

  // Render the collection of items. Override this method to
  // provide your own implementation of a render function for
  // the collection view.
  render: function(){
    this.isClosed = false;
    this.triggerBeforeRender();
    this._renderChildren();
    this.triggerRendered();
    return this;
  },

  // Internal method. Separated so that CompositeView can have
  // more control over events being triggered, around the rendering
  // process
  _renderChildren: function(){
    this.startBuffering();

    this.closeEmptyView();
    this.closeChildren();

    if (!this.isEmpty(this.collection)) {
      this.showCollection();
    } else {
      this.showEmptyView();
    }

    this.endBuffering();
  },

  // Internal method to loop through each item in the
  // collection view and show it
  showCollection: function(){
    var ItemView;
    this.collection.each(function(item, index){
      ItemView = this.getItemView(item);
      this.addItemView(item, ItemView, index);
    }, this);
  },

  // Internal method to show an empty view in place of
  // a collection of item views, when the collection is
  // empty
  showEmptyView: function(){
    var EmptyView = this.getEmptyView();

    if (EmptyView && !this._showingEmptyView){
      this._showingEmptyView = true;
      var model = new Backbone.Model();
      this.addItemView(model, EmptyView, 0);
    }
  },

  // Internal method to close an existing emptyView instance
  // if one exists. Called when a collection view has been
  // rendered empty, and then an item is added to the collection.
  closeEmptyView: function(){
    if (this._showingEmptyView){
      this.closeChildren();
      delete this._showingEmptyView;
    }
  },

  // Retrieve the empty view type
  getEmptyView: function(){
    return Marionette.getOption(this, "emptyView");
  },

  // Retrieve the itemView type, either from `this.options.itemView`
  // or from the `itemView` in the object definition. The "options"
  // takes precedence.
  getItemView: function(item){
    var itemView = Marionette.getOption(this, "itemView");

    if (!itemView){
      throwError("An `itemView` must be specified", "NoItemViewError");
    }

    return itemView;
  },

  // Render the child item's view and add it to the
  // HTML for the collection view.
  addItemView: function(item, ItemView, index){
    // get the itemViewOptions if any were specified
    var itemViewOptions = Marionette.getOption(this, "itemViewOptions");
    if (_.isFunction(itemViewOptions)){
      itemViewOptions = itemViewOptions.call(this, item, index);
    }

    // build the view
    var view = this.buildItemView(item, ItemView, itemViewOptions);

    // set up the child view event forwarding
    this.addChildViewEventForwarding(view);

    // this view is about to be added
    this.triggerMethod("before:item:added", view);

    // Store the child view itself so we can properly
    // remove and/or close it later
    this.children.add(view);

    // Render it and show it
    this.renderItemView(view, index);

    // call the "show" method if the collection view
    // has already been shown
    if (this._isShown && !this.isBuffering){
      Marionette.triggerMethod.call(view, "show");
    }

    // this view was added
    this.triggerMethod("after:item:added", view);

    return view;
  },

  // Set up the child view event forwarding. Uses an "itemview:"
  // prefix in front of all forwarded events.
  addChildViewEventForwarding: function(view){
    var prefix = Marionette.getOption(this, "itemViewEventPrefix");

    // Forward all child item view events through the parent,
    // prepending "itemview:" to the event name
    this.listenTo(view, "all", function(){
      var args = slice.call(arguments);
      var rootEvent = args[0];
      var itemEvents = this.normalizeMethods(this.getItemEvents());

      args[0] = prefix + ":" + rootEvent;
      args.splice(1, 0, view);

      // call collectionView itemEvent if defined
      if (typeof itemEvents !== "undefined" && _.isFunction(itemEvents[rootEvent])) {
        itemEvents[rootEvent].apply(this, args);
      }

      Marionette.triggerMethod.apply(this, args);
    }, this);
  },

  // returns the value of itemEvents depending on if a function
  getItemEvents: function() {
    if (_.isFunction(this.itemEvents)) {
      return this.itemEvents.call(this);
    }

    return this.itemEvents;
  },

  // render the item view
  renderItemView: function(view, index) {
    view.render();
    this.appendHtml(this, view, index);
  },

  // Build an `itemView` for every model in the collection.
  buildItemView: function(item, ItemViewType, itemViewOptions){
    var options = _.extend({model: item}, itemViewOptions);
    return new ItemViewType(options);
  },

  // get the child view by item it holds, and remove it
  removeItemView: function(item){
    var view = this.children.findByModel(item);
    this.removeChildView(view);
    this.checkEmpty();
  },

  // Remove the child view and close it
  removeChildView: function(view){

    // shut down the child view properly,
    // including events that the collection has from it
    if (view){
      this.stopListening(view);

      // call 'close' or 'remove', depending on which is found
      if (view.close) { view.close(); }
      else if (view.remove) { view.remove(); }

      this.children.remove(view);
    }

    this.triggerMethod("item:removed", view);
  },

  // helper to check if the collection is empty
  isEmpty: function(collection){
    // check if we're empty now
    return !this.collection || this.collection.length === 0;
  },

  // If empty, show the empty view
  checkEmpty: function (){
    if (this.isEmpty(this.collection)){
      this.showEmptyView();
    }
  },

  // You might need to override this if you've overridden appendHtml
  appendBuffer: function(collectionView, buffer) {
    collectionView.$el.append(buffer);
  },

  // Append the HTML to the collection's `el`.
  // Override this method to do something other
  // than `.append`.
  appendHtml: function(collectionView, itemView, index){
    if (collectionView.isBuffering) {
      // buffering happens on reset events and initial renders
      // in order to reduce the number of inserts into the
      // document, which are expensive.
      collectionView.elBuffer.appendChild(itemView.el);
      collectionView._bufferedChildren.push(itemView);
    }
    else {
      // If we've already rendered the main collection, just
      // append the new items directly into the element.
      collectionView.$el.append(itemView.el);
    }
  },

  // Internal method to set up the `children` object for
  // storing all of the child views
  _initChildViewStorage: function(){
    this.children = new Backbone.ChildViewContainer();
  },

  // Handle cleanup and other closing needs for
  // the collection of views.
  close: function(){
    if (this.isClosed){ return; }

    this.triggerMethod("collection:before:close");
    this.closeChildren();
    this.triggerMethod("collection:closed");

    Marionette.View.prototype.close.apply(this, arguments);
  },

  // Close the child views that this collection view
  // is holding on to, if any
  closeChildren: function(){
    this.children.each(function(child){
      this.removeChildView(child);
    }, this);
    this.checkEmpty();
  }
});


// Composite View
// --------------

// Used for rendering a branch-leaf, hierarchical structure.
// Extends directly from CollectionView and also renders an
// an item view as `modelView`, for the top leaf
Marionette.CompositeView = Marionette.CollectionView.extend({

  // Setting up the inheritance chain which allows changes to
  // Marionette.CollectionView.prototype.constructor which allows overriding
  constructor: function(){
    Marionette.CollectionView.prototype.constructor.apply(this, arguments);
  },

  // Configured the initial events that the composite view
  // binds to. Override this method to prevent the initial
  // events, or to add your own initial events.
  _initialEvents: function(){

    // Bind only after composite view is rendered to avoid adding child views
    // to nonexistent itemViewContainer
    this.once('render', function () {
      if (this.collection){
        this.listenTo(this.collection, "add", this.addChildView);
        this.listenTo(this.collection, "remove", this.removeItemView);
        this.listenTo(this.collection, "reset", this._renderChildren);
      }
    });

  },

  // Retrieve the `itemView` to be used when rendering each of
  // the items in the collection. The default is to return
  // `this.itemView` or Marionette.CompositeView if no `itemView`
  // has been defined
  getItemView: function(item){
    var itemView = Marionette.getOption(this, "itemView") || this.constructor;

    if (!itemView){
      throwError("An `itemView` must be specified", "NoItemViewError");
    }

    return itemView;
  },

  // Serialize the collection for the view.
  // You can override the `serializeData` method in your own view
  // definition, to provide custom serialization for your view's data.
  serializeData: function(){
    var data = {};

    if (this.model){
      data = this.model.toJSON();
    }

    return data;
  },

  // Renders the model once, and the collection once. Calling
  // this again will tell the model's view to re-render itself
  // but the collection will not re-render.
  render: function(){
    this.isRendered = true;
    this.isClosed = false;
    this.resetItemViewContainer();

    this.triggerBeforeRender();
    var html = this.renderModel();
    this.$el.html(html);
    // the ui bindings is done here and not at the end of render since they
    // will not be available until after the model is rendered, but should be
    // available before the collection is rendered.
    this.bindUIElements();
    this.triggerMethod("composite:model:rendered");

    this._renderChildren();

    this.triggerMethod("composite:rendered");
    this.triggerRendered();
    return this;
  },

  _renderChildren: function(){
    if (this.isRendered){
      this.triggerMethod("composite:collection:before:render");
      Marionette.CollectionView.prototype._renderChildren.call(this);
      this.triggerMethod("composite:collection:rendered");
    }
  },

  // Render an individual model, if we have one, as
  // part of a composite view (branch / leaf). For example:
  // a treeview.
  renderModel: function(){
    var data = {};
    data = this.serializeData();
    data = this.mixinTemplateHelpers(data);

    var template = this.getTemplate();
    return Marionette.Renderer.render(template, data);
  },


  // You might need to override this if you've overridden appendHtml
  appendBuffer: function(compositeView, buffer) {
    var $container = this.getItemViewContainer(compositeView);
    $container.append(buffer);
  },

  // Appends the `el` of itemView instances to the specified
  // `itemViewContainer` (a jQuery selector). Override this method to
  // provide custom logic of how the child item view instances have their
  // HTML appended to the composite view instance.
  appendHtml: function(compositeView, itemView, index){
    if (compositeView.isBuffering) {
      compositeView.elBuffer.appendChild(itemView.el);
      compositeView._bufferedChildren.push(itemView);
    }
    else {
      // If we've already rendered the main collection, just
      // append the new items directly into the element.
      var $container = this.getItemViewContainer(compositeView);
      $container.append(itemView.el);
    }
  },


  // Internal method to ensure an `$itemViewContainer` exists, for the
  // `appendHtml` method to use.
  getItemViewContainer: function(containerView){
    if ("$itemViewContainer" in containerView){
      return containerView.$itemViewContainer;
    }

    var container;
    var itemViewContainer = Marionette.getOption(containerView, "itemViewContainer");
    if (itemViewContainer){

      var selector = _.isFunction(itemViewContainer) ? itemViewContainer.call(this) : itemViewContainer;
      container = containerView.$(selector);
      if (container.length <= 0) {
        throwError("The specified `itemViewContainer` was not found: " + containerView.itemViewContainer, "ItemViewContainerMissingError");
      }

    } else {
      container = containerView.$el;
    }

    containerView.$itemViewContainer = container;
    return container;
  },

  // Internal method to reset the `$itemViewContainer` on render
  resetItemViewContainer: function(){
    if (this.$itemViewContainer){
      delete this.$itemViewContainer;
    }
  }
});


// Layout
// ------

// Used for managing application layouts, nested layouts and
// multiple regions within an application or sub-application.
//
// A specialized view type that renders an area of HTML and then
// attaches `Region` instances to the specified `regions`.
// Used for composite view management and sub-application areas.
Marionette.Layout = Marionette.ItemView.extend({
  regionType: Marionette.Region,

  // Ensure the regions are available when the `initialize` method
  // is called.
  constructor: function (options) {
    options = options || {};

    this._firstRender = true;
    this._initializeRegions(options);

    Marionette.ItemView.prototype.constructor.call(this, options);
  },

  // Layout's render will use the existing region objects the
  // first time it is called. Subsequent calls will close the
  // views that the regions are showing and then reset the `el`
  // for the regions to the newly rendered DOM elements.
  render: function(){

    if (this.isClosed){
      // a previously closed layout means we need to
      // completely re-initialize the regions
      this._initializeRegions();
    }
    if (this._firstRender) {
      // if this is the first render, don't do anything to
      // reset the regions
      this._firstRender = false;
    } else if (!this.isClosed){
      // If this is not the first render call, then we need to
      // re-initializing the `el` for each region
      this._reInitializeRegions();
    }

    return Marionette.ItemView.prototype.render.apply(this, arguments);
  },

  // Handle closing regions, and then close the view itself.
  close: function () {
    if (this.isClosed){ return; }
    this.regionManager.close();
    Marionette.ItemView.prototype.close.apply(this, arguments);
  },

  // Add a single region, by name, to the layout
  addRegion: function(name, definition){
    var regions = {};
    regions[name] = definition;
    return this._buildRegions(regions)[name];
  },

  // Add multiple regions as a {name: definition, name2: def2} object literal
  addRegions: function(regions){
    this.regions = _.extend({}, this.regions, regions);
    return this._buildRegions(regions);
  },

  // Remove a single region from the Layout, by name
  removeRegion: function(name){
    delete this.regions[name];
    return this.regionManager.removeRegion(name);
  },

  // internal method to build regions
  _buildRegions: function(regions){
    var that = this;

    var defaults = {
      regionType: Marionette.getOption(this, "regionType"),
      parentEl: function(){ return that.$el; }
    };

    return this.regionManager.addRegions(regions, defaults);
  },

  // Internal method to initialize the regions that have been defined in a
  // `regions` attribute on this layout.
  _initializeRegions: function (options) {
    var regions;
    this._initRegionManager();

    if (_.isFunction(this.regions)) {
      regions = this.regions(options);
    } else {
      regions = this.regions || {};
    }

    this.addRegions(regions);
  },

  // Internal method to re-initialize all of the regions by updating the `el` that
  // they point to
  _reInitializeRegions: function(){
    this.regionManager.closeRegions();
    this.regionManager.each(function(region){
      region.reset();
    });
  },

  // Internal method to initialize the region manager
  // and all regions in it
  _initRegionManager: function(){
    this.regionManager = new Marionette.RegionManager();

    this.listenTo(this.regionManager, "region:add", function(name, region){
      this[name] = region;
      this.trigger("region:add", name, region);
    });

    this.listenTo(this.regionManager, "region:remove", function(name, region){
      delete this[name];
      this.trigger("region:remove", name, region);
    });
  }
});


Marionette.Behavior = (function(_, Backbone){
  function Behavior(options, view){
    this.view = view;
    this.defaults = _.result(this, "defaults") || {};
    this.options  = _.extend({}, this.defaults, options);

    // proxy behavior $ method to the view
    this.$ = function() {
      return this.view.$.apply(this.view, arguments);
    };

    this.initialize.apply(this, arguments);
  }

  _.extend(Behavior.prototype, {
    initialize: function(){},

    triggerMethod: Marionette.triggerMethod
  });

  // Borrow Backbones extend implementation
  _.extend(Behavior, {
    extend: Backbone.View.extend
  });

  return Behavior;
})(_, Backbone);

Marionette.Behaviors = (function(Marionette, _) {

  function Behaviors(view) {
    this.behaviors = Behaviors.parseBehaviors(view, view.behaviors);

    Behaviors.wrap(view, this.behaviors, [
      'bindUIElements', 'unbindUIElements',
      'delegateEvents', 'undelegateEvents',
      'onShow', 'onClose',
      'behaviorEvents', 'triggerMethod',
      'setElement'
    ]);
  }

  var methods = {
    setElement: function(setElement, behaviors) {
      setElement.apply(this, _.tail(arguments, 2));

      // proxy behavior $el to the view's $el
      _.each(behaviors, function(b) {
        b.$el = this.$el;
      }, this);
    },

    onShow: function(onShow, behaviors) {
      var args = _.tail(arguments, 2);

      _.each(behaviors, function(b) {
        Marionette.triggerMethod.apply(b, ["show"].concat(args));
      });

      if (_.isFunction(onShow)) {
        onShow.apply(this, args);
      }
    },

    onClose: function(onClose, behaviors){
      var args = _.tail(arguments, 2);

      _.each(behaviors, function(b) {
        Marionette.triggerMethod.apply(b, ["close"].concat(args));
      });

      if (_.isFunction(onClose)) {
        onClose.apply(this, args);
      }
    },

    bindUIElements: function(bindUIElements, behaviors) {
      bindUIElements.apply(this);
      _.invoke(behaviors, bindUIElements);
    },

    unbindUIElements: function(unbindUIElements, behaviors) {
      unbindUIElements.apply(this);
      _.invoke(behaviors, unbindUIElements);
    },

    triggerMethod: function(triggerMethod, behaviors) {
      var args = _.tail(arguments, 2);
      triggerMethod.apply(this, args);

      _.each(behaviors, function(b) {
        triggerMethod.apply(b, args);
      });
    },

    delegateEvents: function(delegateEvents, behaviors) {
      var args = _.tail(arguments, 2);
      delegateEvents.apply(this, args);

      _.each(behaviors, function(b){
        Marionette.bindEntityEvents(this, this.model, Marionette.getOption(b, "modelEvents"));
        Marionette.bindEntityEvents(this, this.collection, Marionette.getOption(b, "collectionEvents"));
      }, this);
    },

    undelegateEvents: function(undelegateEvents, behaviors) {
      var args = _.tail(arguments, 2);
      undelegateEvents.apply(this, args);

      _.each(behaviors, function(b) {
        Marionette.unbindEntityEvents(this, this.model, Marionette.getOption(b, "modelEvents"));
        Marionette.unbindEntityEvents(this, this.collection, Marionette.getOption(b, "collectionEvents"));
      }, this);
    },

    behaviorEvents: function(behaviorEvents, behaviors) {
      var _behaviorsEvents = {};
      var viewUI = _.result(this, 'ui');

      _.each(behaviors, function(b, i) {
        var _events = {};
        var behaviorEvents = _.result(b, 'events') || {};
        var behaviorUI = _.result(b, 'ui');
        var ui = _.extend({}, viewUI, behaviorUI);

        behaviorEvents = Marionette.normalizeUIKeys(behaviorEvents, ui);

        _.each(_.keys(behaviorEvents), function(key) {
          // append white-space at the end of each key to prevent behavior key collisions
          // this is relying on the fact backbone events considers "click .foo" the same  "click .foo "
          // starts with an array of two so the first behavior has one space
          var whitespace = (new Array(i+2)).join(" ");
          var eventKey   = key + whitespace;
          var handler    = _.isFunction(behaviorEvents[key]) ? behaviorEvents[key] : b[behaviorEvents[key]];

          _events[eventKey] = _.bind(handler, b);
        });

        _behaviorsEvents = _.extend(_behaviorsEvents, _events);
      });

      return _behaviorsEvents;
    }
 };

  _.extend(Behaviors, {

    // placeholder method to be extended by the user
    // should define the object that stores the behaviors
    // i.e.
    //
    // Marionette.Behaviors.behaviorsLookup: function() {
    //   return App.Behaviors
    // }
    behaviorsLookup: function() {
      throw new Error("You must define where your behaviors are stored. See https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.behaviors.md#behaviorslookup");
    },

    getBehaviorClass: function(options, key) {
      if (options.behaviorClass) {
        return options.behaviorClass;
      }

      // Get behavior class can be either a flat object or a method
      return _.isFunction(Behaviors.behaviorsLookup) ? Behaviors.behaviorsLookup.apply(this, arguments)[key] : Behaviors.behaviorsLookup[key];
    },

    parseBehaviors: function(view, behaviors){
      return _.map(behaviors, function(options, key){
        var BehaviorClass = Behaviors.getBehaviorClass(options, key);
        return new BehaviorClass(options, view);
      });
    },

    // wrap view internal methods so that they delegate to behaviors.
    // For example, onClose should trigger close on all of the behaviors and then close itself.
    // i.e.
    //
    // view.delegateEvents = _.partial(methods.delegateEvents, view.delegateEvents, behaviors);
    wrap: function(view, behaviors, methodNames) {
      _.each(methodNames, function(methodName) {
        view[methodName] = _.partial(methods[methodName], view[methodName], behaviors);
      });
    }
  });

  return Behaviors;

})(Marionette, _);


// AppRouter
// ---------

// Reduce the boilerplate code of handling route events
// and then calling a single method on another object.
// Have your routers configured to call the method on
// your object, directly.
//
// Configure an AppRouter with `appRoutes`.
//
// App routers can only take one `controller` object.
// It is recommended that you divide your controller
// objects in to smaller pieces of related functionality
// and have multiple routers / controllers, instead of
// just one giant router and controller.
//
// You can also add standard routes to an AppRouter.

Marionette.AppRouter = Backbone.Router.extend({

  constructor: function(options){
    Backbone.Router.prototype.constructor.apply(this, arguments);
	
    this.options = options || {};

    var appRoutes = Marionette.getOption(this, "appRoutes");
    var controller = this._getController();
    this.processAppRoutes(controller, appRoutes);
  },

  // Similar to route method on a Backbone Router but
  // method is called on the controller
  appRoute: function(route, methodName) {
    var controller = this._getController();
    this._addAppRoute(controller, route, methodName);
  },

  // Internal method to process the `appRoutes` for the
  // router, and turn them in to routes that trigger the
  // specified method on the specified `controller`.
  processAppRoutes: function(controller, appRoutes) {
    if (!appRoutes){ return; }

    var routeNames = _.keys(appRoutes).reverse(); // Backbone requires reverted order of routes

    _.each(routeNames, function(route) {
      this._addAppRoute(controller, route, appRoutes[route]);
    }, this);
  },

  _getController: function(){
    return Marionette.getOption(this, "controller");
  },

  _addAppRoute: function(controller, route, methodName){
    var method = controller[methodName];

    if (!method) {
      throwError("Method '" + methodName + "' was not found on the controller");
    }

    this.route(route, methodName, _.bind(method, controller));
  }
});


// Application
// -----------

// Contain and manage the composite application as a whole.
// Stores and starts up `Region` objects, includes an
// event aggregator as `app.vent`
Marionette.Application = function(options){
  this._initRegionManager();
  this._initCallbacks = new Marionette.Callbacks();
  this.vent = new Backbone.Wreqr.EventAggregator();
  this.commands = new Backbone.Wreqr.Commands();
  this.reqres = new Backbone.Wreqr.RequestResponse();
  this.submodules = {};

  _.extend(this, options);

  this.triggerMethod = Marionette.triggerMethod;
};

_.extend(Marionette.Application.prototype, Backbone.Events, {
  // Command execution, facilitated by Backbone.Wreqr.Commands
  execute: function(){
    this.commands.execute.apply(this.commands, arguments);
  },

  // Request/response, facilitated by Backbone.Wreqr.RequestResponse
  request: function(){
    return this.reqres.request.apply(this.reqres, arguments);
  },

  // Add an initializer that is either run at when the `start`
  // method is called, or run immediately if added after `start`
  // has already been called.
  addInitializer: function(initializer){
    this._initCallbacks.add(initializer);
  },

  // kick off all of the application's processes.
  // initializes all of the regions that have been added
  // to the app, and runs all of the initializer functions
  start: function(options){
    this.triggerMethod("initialize:before", options);
    this._initCallbacks.run(options, this);
    this.triggerMethod("initialize:after", options);

    this.triggerMethod("start", options);
  },

  // Add regions to your app.
  // Accepts a hash of named strings or Region objects
  // addRegions({something: "#someRegion"})
  // addRegions({something: Region.extend({el: "#someRegion"}) });
  addRegions: function(regions){
    return this._regionManager.addRegions(regions);
  },

  // Close all regions in the app, without removing them
  closeRegions: function(){
    this._regionManager.closeRegions();
  },

  // Removes a region from your app, by name
  // Accepts the regions name
  // removeRegion('myRegion')
  removeRegion: function(region) {
    this._regionManager.removeRegion(region);
  },

  // Provides alternative access to regions
  // Accepts the region name
  // getRegion('main')
  getRegion: function(region) {
    return this._regionManager.get(region);
  },

  // Create a module, attached to the application
  module: function(moduleNames, moduleDefinition){

    // Overwrite the module class if the user specifies one
    var ModuleClass = Marionette.Module.getClass(moduleDefinition);

    // slice the args, and add this application object as the
    // first argument of the array
    var args = slice.call(arguments);
    args.unshift(this);

    // see the Marionette.Module object for more information
    return ModuleClass.create.apply(ModuleClass, args);
  },

  // Internal method to set up the region manager
  _initRegionManager: function(){
    this._regionManager = new Marionette.RegionManager();

    this.listenTo(this._regionManager, "region:add", function(name, region){
      this[name] = region;
    });

    this.listenTo(this._regionManager, "region:remove", function(name, region){
      delete this[name];
    });
  }
});

// Copy the `extend` function used by Backbone's classes
Marionette.Application.extend = Marionette.extend;

// Module
// ------

// A simple module system, used to create privacy and encapsulation in
// Marionette applications
Marionette.Module = function(moduleName, app, options){
  this.moduleName = moduleName;
  this.options = _.extend({}, this.options, options);
  this.initialize = options.initialize || this.initialize;

  // store sub-modules
  this.submodules = {};

  this._setupInitializersAndFinalizers();

  // store the configuration for this module
  this.app = app;
  this.startWithParent = true;

  this.triggerMethod = Marionette.triggerMethod;

  if (_.isFunction(this.initialize)){
    this.initialize(this.options, moduleName, app);
  }
};

Marionette.Module.extend = Marionette.extend;

// Extend the Module prototype with events / listenTo, so that the module
// can be used as an event aggregator or pub/sub.
_.extend(Marionette.Module.prototype, Backbone.Events, {

  // Initialize is an empty function by default. Override it with your own
  // initialization logic when extending Marionette.Module.
  initialize: function(){},

  // Initializer for a specific module. Initializers are run when the
  // module's `start` method is called.
  addInitializer: function(callback){
    this._initializerCallbacks.add(callback);
  },

  // Finalizers are run when a module is stopped. They are used to teardown
  // and finalize any variables, references, events and other code that the
  // module had set up.
  addFinalizer: function(callback){
    this._finalizerCallbacks.add(callback);
  },

  // Start the module, and run all of its initializers
  start: function(options){
    // Prevent re-starting a module that is already started
    if (this._isInitialized){ return; }

    // start the sub-modules (depth-first hierarchy)
    _.each(this.submodules, function(mod){
      // check to see if we should start the sub-module with this parent
      if (mod.startWithParent){
        mod.start(options);
      }
    });

    // run the callbacks to "start" the current module
    this.triggerMethod("before:start", options);

    this._initializerCallbacks.run(options, this);
    this._isInitialized = true;

    this.triggerMethod("start", options);
  },

  // Stop this module by running its finalizers and then stop all of
  // the sub-modules for this module
  stop: function(){
    // if we are not initialized, don't bother finalizing
    if (!this._isInitialized){ return; }
    this._isInitialized = false;

    Marionette.triggerMethod.call(this, "before:stop");

    // stop the sub-modules; depth-first, to make sure the
    // sub-modules are stopped / finalized before parents
    _.each(this.submodules, function(mod){ mod.stop(); });

    // run the finalizers
    this._finalizerCallbacks.run(undefined,this);

    // reset the initializers and finalizers
    this._initializerCallbacks.reset();
    this._finalizerCallbacks.reset();

    Marionette.triggerMethod.call(this, "stop");
  },

  // Configure the module with a definition function and any custom args
  // that are to be passed in to the definition function
  addDefinition: function(moduleDefinition, customArgs){
    this._runModuleDefinition(moduleDefinition, customArgs);
  },

  // Internal method: run the module definition function with the correct
  // arguments
  _runModuleDefinition: function(definition, customArgs){
    if (!definition){ return; }

    // build the correct list of arguments for the module definition
    var args = _.flatten([
      this,
      this.app,
      Backbone,
      Marionette,
      Marionette.$, _,
      customArgs
    ]);

    definition.apply(this, args);
  },

  // Internal method: set up new copies of initializers and finalizers.
  // Calling this method will wipe out all existing initializers and
  // finalizers.
  _setupInitializersAndFinalizers: function(){
    this._initializerCallbacks = new Marionette.Callbacks();
    this._finalizerCallbacks = new Marionette.Callbacks();
  }
});

// Type methods to create modules
_.extend(Marionette.Module, {

  // Create a module, hanging off the app parameter as the parent object.
  create: function(app, moduleNames, moduleDefinition){
    var module = app;

    // get the custom args passed in after the module definition and
    // get rid of the module name and definition function
    var customArgs = slice.call(arguments);
    customArgs.splice(0, 3);

    // split the module names and get the length
    moduleNames = moduleNames.split(".");
    var length = moduleNames.length;

    // store the module definition for the last module in the chain
    var moduleDefinitions = [];
    moduleDefinitions[length-1] = moduleDefinition;

    // Loop through all the parts of the module definition
    _.each(moduleNames, function(moduleName, i){
      var parentModule = module;
      module = this._getModule(parentModule, moduleName, app, moduleDefinition);
      this._addModuleDefinition(parentModule, module, moduleDefinitions[i], customArgs);
    }, this);

    // Return the last module in the definition chain
    return module;
  },

  _getModule: function(parentModule, moduleName, app, def, args){
    var options = _.extend({}, def);
    var ModuleClass = this.getClass(def);

    // Get an existing module of this name if we have one
    var module = parentModule[moduleName];

    if (!module){
      // Create a new module if we don't have one
      module = new ModuleClass(moduleName, app, options);
      parentModule[moduleName] = module;
      // store the module on the parent
      parentModule.submodules[moduleName] = module;
    }

    return module;
  },

  getClass: function(moduleDefinition) {
    var ModuleClass = Marionette.Module;

    if (!moduleDefinition) {
      return ModuleClass;
    }

    if (moduleDefinition.prototype instanceof ModuleClass) {
      return moduleDefinition;
    }

    return moduleDefinition.moduleClass || ModuleClass;
  },

  // Add the module definition and add a startWithParent initializer function.
  // This is complicated because module definitions are heavily overloaded
  // and support an anonymous function, module class, or options object
  _addModuleDefinition: function(parentModule, module, def, args){
    var fn = this._getDefine(def);
    var startWithParent = this._getStartWithParent(def, module);

    if (fn){
      module.addDefinition(fn, args);
    }

    this._addStartWithParent(parentModule, module, startWithParent);
  },

  _getStartWithParent: function(def, module) {
    var swp;

    if (_.isFunction(def) && (def.prototype instanceof Marionette.Module)) {
      swp = module.constructor.prototype.startWithParent;
      return _.isUndefined(swp) ? true : swp;
    }

    if (_.isObject(def)){
      swp = def.startWithParent;
      return _.isUndefined(swp) ? true : swp;
    }

    return true;
  },

  _getDefine: function(def) {
    if (_.isFunction(def) && !(def.prototype instanceof Marionette.Module)) {
      return def;
    }

    if (_.isObject(def)){
      return def.define;
    }

    return null;
  },

  _addStartWithParent: function(parentModule, module, startWithParent) {
    module.startWithParent = module.startWithParent && startWithParent;

    if (!module.startWithParent || !!module.startWithParentIsConfigured){
      return;
    }

    module.startWithParentIsConfigured = true;

    parentModule.addInitializer(function(options){
      if (module.startWithParent){
        module.start(options);
      }
    });
  }
});



  return Marionette;
})(this, Backbone, _);

  return Backbone.Marionette;

}));

/**!

 @license
 handlebars v4.7.6

Copyright (C) 2011-2019 by Yehuda Katz

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.

*/
(function webpackUniversalModuleDefinition(root, factory) {
	if(typeof exports === 'object' && typeof module === 'object')
		module.exports = factory();
	else if(typeof define === 'function' && define.amd)
		define('handlebars',[], factory);
	else if(typeof exports === 'object')
		exports["Handlebars"] = factory();
	else
		root["Handlebars"] = factory();
})(this, function() {
return /******/ (function(modules) { // webpackBootstrap
/******/ 	// The module cache
/******/ 	var installedModules = {};

/******/ 	// The require function
/******/ 	function __webpack_require__(moduleId) {

/******/ 		// Check if module is in cache
/******/ 		if(installedModules[moduleId])
/******/ 			return installedModules[moduleId].exports;

/******/ 		// Create a new module (and put it into the cache)
/******/ 		var module = installedModules[moduleId] = {
/******/ 			exports: {},
/******/ 			id: moduleId,
/******/ 			loaded: false
/******/ 		};

/******/ 		// Execute the module function
/******/ 		modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);

/******/ 		// Flag the module as loaded
/******/ 		module.loaded = true;

/******/ 		// Return the exports of the module
/******/ 		return module.exports;
/******/ 	}


/******/ 	// expose the modules object (__webpack_modules__)
/******/ 	__webpack_require__.m = modules;

/******/ 	// expose the module cache
/******/ 	__webpack_require__.c = installedModules;

/******/ 	// __webpack_public_path__
/******/ 	__webpack_require__.p = "";

/******/ 	// Load entry module and return exports
/******/ 	return __webpack_require__(0);
/******/ })
/************************************************************************/
/******/ ([
/* 0 */
/***/ (function(module, exports, __webpack_require__) {

	'use strict';

	var _interopRequireWildcard = __webpack_require__(1)['default'];

	var _interopRequireDefault = __webpack_require__(2)['default'];

	exports.__esModule = true;

	var _handlebarsBase = __webpack_require__(3);

	var base = _interopRequireWildcard(_handlebarsBase);

	// Each of these augment the Handlebars object. No need to setup here.
	// (This is done to easily share code between commonjs and browse envs)

	var _handlebarsSafeString = __webpack_require__(36);

	var _handlebarsSafeString2 = _interopRequireDefault(_handlebarsSafeString);

	var _handlebarsException = __webpack_require__(5);

	var _handlebarsException2 = _interopRequireDefault(_handlebarsException);

	var _handlebarsUtils = __webpack_require__(4);

	var Utils = _interopRequireWildcard(_handlebarsUtils);

	var _handlebarsRuntime = __webpack_require__(37);

	var runtime = _interopRequireWildcard(_handlebarsRuntime);

	var _handlebarsNoConflict = __webpack_require__(43);

	var _handlebarsNoConflict2 = _interopRequireDefault(_handlebarsNoConflict);

	// For compatibility and usage outside of module systems, make the Handlebars object a namespace
	function create() {
	  var hb = new base.HandlebarsEnvironment();

	  Utils.extend(hb, base);
	  hb.SafeString = _handlebarsSafeString2['default'];
	  hb.Exception = _handlebarsException2['default'];
	  hb.Utils = Utils;
	  hb.escapeExpression = Utils.escapeExpression;

	  hb.VM = runtime;
	  hb.template = function (spec) {
	    return runtime.template(spec, hb);
	  };

	  return hb;
	}

	var inst = create();
	inst.create = create;

	_handlebarsNoConflict2['default'](inst);

	inst['default'] = inst;

	exports['default'] = inst;
	module.exports = exports['default'];

/***/ }),
/* 1 */
/***/ (function(module, exports) {

	"use strict";

	exports["default"] = function (obj) {
	  if (obj && obj.__esModule) {
	    return obj;
	  } else {
	    var newObj = {};

	    if (obj != null) {
	      for (var key in obj) {
	        if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key];
	      }
	    }

	    newObj["default"] = obj;
	    return newObj;
	  }
	};

	exports.__esModule = true;

/***/ }),
/* 2 */
/***/ (function(module, exports) {

	"use strict";

	exports["default"] = function (obj) {
	  return obj && obj.__esModule ? obj : {
	    "default": obj
	  };
	};

	exports.__esModule = true;

/***/ }),
/* 3 */
/***/ (function(module, exports, __webpack_require__) {

	'use strict';

	var _interopRequireDefault = __webpack_require__(2)['default'];

	exports.__esModule = true;
	exports.HandlebarsEnvironment = HandlebarsEnvironment;

	var _utils = __webpack_require__(4);

	var _exception = __webpack_require__(5);

	var _exception2 = _interopRequireDefault(_exception);

	var _helpers = __webpack_require__(9);

	var _decorators = __webpack_require__(29);

	var _logger = __webpack_require__(31);

	var _logger2 = _interopRequireDefault(_logger);

	var _internalProtoAccess = __webpack_require__(32);

	var VERSION = '4.7.6';
	exports.VERSION = VERSION;
	var COMPILER_REVISION = 8;
	exports.COMPILER_REVISION = COMPILER_REVISION;
	var LAST_COMPATIBLE_COMPILER_REVISION = 7;

	exports.LAST_COMPATIBLE_COMPILER_REVISION = LAST_COMPATIBLE_COMPILER_REVISION;
	var REVISION_CHANGES = {
	  1: '<= 1.0.rc.2', // 1.0.rc.2 is actually rev2 but doesn't report it
	  2: '== 1.0.0-rc.3',
	  3: '== 1.0.0-rc.4',
	  4: '== 1.x.x',
	  5: '== 2.0.0-alpha.x',
	  6: '>= 2.0.0-beta.1',
	  7: '>= 4.0.0 <4.3.0',
	  8: '>= 4.3.0'
	};

	exports.REVISION_CHANGES = REVISION_CHANGES;
	var objectType = '[object Object]';

	function HandlebarsEnvironment(helpers, partials, decorators) {
	  this.helpers = helpers || {};
	  this.partials = partials || {};
	  this.decorators = decorators || {};

	  _helpers.registerDefaultHelpers(this);
	  _decorators.registerDefaultDecorators(this);
	}

	HandlebarsEnvironment.prototype = {
	  constructor: HandlebarsEnvironment,

	  logger: _logger2['default'],
	  log: _logger2['default'].log,

	  registerHelper: function registerHelper(name, fn) {
	    if (_utils.toString.call(name) === objectType) {
	      if (fn) {
	        throw new _exception2['default']('Arg not supported with multiple helpers');
	      }
	      _utils.extend(this.helpers, name);
	    } else {
	      this.helpers[name] = fn;
	    }
	  },
	  unregisterHelper: function unregisterHelper(name) {
	    delete this.helpers[name];
	  },

	  registerPartial: function registerPartial(name, partial) {
	    if (_utils.toString.call(name) === objectType) {
	      _utils.extend(this.partials, name);
	    } else {
	      if (typeof partial === 'undefined') {
	        throw new _exception2['default']('Attempting to register a partial called "' + name + '" as undefined');
	      }
	      this.partials[name] = partial;
	    }
	  },
	  unregisterPartial: function unregisterPartial(name) {
	    delete this.partials[name];
	  },

	  registerDecorator: function registerDecorator(name, fn) {
	    if (_utils.toString.call(name) === objectType) {
	      if (fn) {
	        throw new _exception2['default']('Arg not supported with multiple decorators');
	      }
	      _utils.extend(this.decorators, name);
	    } else {
	      this.decorators[name] = fn;
	    }
	  },
	  unregisterDecorator: function unregisterDecorator(name) {
	    delete this.decorators[name];
	  },
	  /**
	   * Reset the memory of illegal property accesses that have already been logged.
	   * @deprecated should only be used in handlebars test-cases
	   */
	  resetLoggedPropertyAccesses: function resetLoggedPropertyAccesses() {
	    _internalProtoAccess.resetLoggedProperties();
	  }
	};

	var log = _logger2['default'].log;

	exports.log = log;
	exports.createFrame = _utils.createFrame;
	exports.logger = _logger2['default'];

/***/ }),
/* 4 */
/***/ (function(module, exports) {

	'use strict';

	exports.__esModule = true;
	exports.extend = extend;
	exports.indexOf = indexOf;
	exports.escapeExpression = escapeExpression;
	exports.isEmpty = isEmpty;
	exports.createFrame = createFrame;
	exports.blockParams = blockParams;
	exports.appendContextPath = appendContextPath;
	var escape = {
	  '&': '&amp;',
	  '<': '&lt;',
	  '>': '&gt;',
	  '"': '&quot;',
	  "'": '&#x27;',
	  '`': '&#x60;',
	  '=': '&#x3D;'
	};

	var badChars = /[&<>"'`=]/g,
	    possible = /[&<>"'`=]/;

	function escapeChar(chr) {
	  return escape[chr];
	}

	function extend(obj /* , ...source */) {
	  for (var i = 1; i < arguments.length; i++) {
	    for (var key in arguments[i]) {
	      if (Object.prototype.hasOwnProperty.call(arguments[i], key)) {
	        obj[key] = arguments[i][key];
	      }
	    }
	  }

	  return obj;
	}

	var toString = Object.prototype.toString;

	exports.toString = toString;
	// Sourced from lodash
	// https://github.com/bestiejs/lodash/blob/master/LICENSE.txt
	/* eslint-disable func-style */
	var isFunction = function isFunction(value) {
	  return typeof value === 'function';
	};
	// fallback for older versions of Chrome and Safari
	/* istanbul ignore next */
	if (isFunction(/x/)) {
	  exports.isFunction = isFunction = function (value) {
	    return typeof value === 'function' && toString.call(value) === '[object Function]';
	  };
	}
	exports.isFunction = isFunction;

	/* eslint-enable func-style */

	/* istanbul ignore next */
	var isArray = Array.isArray || function (value) {
	  return value && typeof value === 'object' ? toString.call(value) === '[object Array]' : false;
	};

	exports.isArray = isArray;
	// Older IE versions do not directly support indexOf so we must implement our own, sadly.

	function indexOf(array, value) {
	  for (var i = 0, len = array.length; i < len; i++) {
	    if (array[i] === value) {
	      return i;
	    }
	  }
	  return -1;
	}

	function escapeExpression(string) {
	  if (typeof string !== 'string') {
	    // don't escape SafeStrings, since they're already safe
	    if (string && string.toHTML) {
	      return string.toHTML();
	    } else if (string == null) {
	      return '';
	    } else if (!string) {
	      return string + '';
	    }

	    // Force a string conversion as this will be done by the append regardless and
	    // the regex test will do this transparently behind the scenes, causing issues if
	    // an object's to string has escaped characters in it.
	    string = '' + string;
	  }

	  if (!possible.test(string)) {
	    return string;
	  }
	  return string.replace(badChars, escapeChar);
	}

	function isEmpty(value) {
	  if (!value && value !== 0) {
	    return true;
	  } else if (isArray(value) && value.length === 0) {
	    return true;
	  } else {
	    return false;
	  }
	}

	function createFrame(object) {
	  var frame = extend({}, object);
	  frame._parent = object;
	  return frame;
	}

	function blockParams(params, ids) {
	  params.path = ids;
	  return params;
	}

	function appendContextPath(contextPath, id) {
	  return (contextPath ? contextPath + '.' : '') + id;
	}

/***/ }),
/* 5 */
/***/ (function(module, exports, __webpack_require__) {

	'use strict';

	var _Object$defineProperty = __webpack_require__(6)['default'];

	exports.__esModule = true;
	var errorProps = ['description', 'fileName', 'lineNumber', 'endLineNumber', 'message', 'name', 'number', 'stack'];

	function Exception(message, node) {
	  var loc = node && node.loc,
	      line = undefined,
	      endLineNumber = undefined,
	      column = undefined,
	      endColumn = undefined;

	  if (loc) {
	    line = loc.start.line;
	    endLineNumber = loc.end.line;
	    column = loc.start.column;
	    endColumn = loc.end.column;

	    message += ' - ' + line + ':' + column;
	  }

	  var tmp = Error.prototype.constructor.call(this, message);

	  // Unfortunately errors are not enumerable in Chrome (at least), so `for prop in tmp` doesn't work.
	  for (var idx = 0; idx < errorProps.length; idx++) {
	    this[errorProps[idx]] = tmp[errorProps[idx]];
	  }

	  /* istanbul ignore else */
	  if (Error.captureStackTrace) {
	    Error.captureStackTrace(this, Exception);
	  }

	  try {
	    if (loc) {
	      this.lineNumber = line;
	      this.endLineNumber = endLineNumber;

	      // Work around issue under safari where we can't directly set the column value
	      /* istanbul ignore next */
	      if (_Object$defineProperty) {
	        Object.defineProperty(this, 'column', {
	          value: column,
	          enumerable: true
	        });
	        Object.defineProperty(this, 'endColumn', {
	          value: endColumn,
	          enumerable: true
	        });
	      } else {
	        this.column = column;
	        this.endColumn = endColumn;
	      }
	    }
	  } catch (nop) {
	    /* Ignore if the browser is very particular */
	  }
	}

	Exception.prototype = new Error();

	exports['default'] = Exception;
	module.exports = exports['default'];

/***/ }),
/* 6 */
/***/ (function(module, exports, __webpack_require__) {

	module.exports = { "default": __webpack_require__(7), __esModule: true };

/***/ }),
/* 7 */
/***/ (function(module, exports, __webpack_require__) {

	var $ = __webpack_require__(8);
	module.exports = function defineProperty(it, key, desc){
	  return $.setDesc(it, key, desc);
	};

/***/ }),
/* 8 */
/***/ (function(module, exports) {

	var $Object = Object;
	module.exports = {
	  create:     $Object.create,
	  getProto:   $Object.getPrototypeOf,
	  isEnum:     {}.propertyIsEnumerable,
	  getDesc:    $Object.getOwnPropertyDescriptor,
	  setDesc:    $Object.defineProperty,
	  setDescs:   $Object.defineProperties,
	  getKeys:    $Object.keys,
	  getNames:   $Object.getOwnPropertyNames,
	  getSymbols: $Object.getOwnPropertySymbols,
	  each:       [].forEach
	};

/***/ }),
/* 9 */
/***/ (function(module, exports, __webpack_require__) {

	'use strict';

	var _interopRequireDefault = __webpack_require__(2)['default'];

	exports.__esModule = true;
	exports.registerDefaultHelpers = registerDefaultHelpers;
	exports.moveHelperToHooks = moveHelperToHooks;

	var _helpersBlockHelperMissing = __webpack_require__(10);

	var _helpersBlockHelperMissing2 = _interopRequireDefault(_helpersBlockHelperMissing);

	var _helpersEach = __webpack_require__(11);

	var _helpersEach2 = _interopRequireDefault(_helpersEach);

	var _helpersHelperMissing = __webpack_require__(24);

	var _helpersHelperMissing2 = _interopRequireDefault(_helpersHelperMissing);

	var _helpersIf = __webpack_require__(25);

	var _helpersIf2 = _interopRequireDefault(_helpersIf);

	var _helpersLog = __webpack_require__(26);

	var _helpersLog2 = _interopRequireDefault(_helpersLog);

	var _helpersLookup = __webpack_require__(27);

	var _helpersLookup2 = _interopRequireDefault(_helpersLookup);

	var _helpersWith = __webpack_require__(28);

	var _helpersWith2 = _interopRequireDefault(_helpersWith);

	function registerDefaultHelpers(instance) {
	  _helpersBlockHelperMissing2['default'](instance);
	  _helpersEach2['default'](instance);
	  _helpersHelperMissing2['default'](instance);
	  _helpersIf2['default'](instance);
	  _helpersLog2['default'](instance);
	  _helpersLookup2['default'](instance);
	  _helpersWith2['default'](instance);
	}

	function moveHelperToHooks(instance, helperName, keepHelper) {
	  if (instance.helpers[helperName]) {
	    instance.hooks[helperName] = instance.helpers[helperName];
	    if (!keepHelper) {
	      delete instance.helpers[helperName];
	    }
	  }
	}

/***/ }),
/* 10 */
/***/ (function(module, exports, __webpack_require__) {

	'use strict';

	exports.__esModule = true;

	var _utils = __webpack_require__(4);

	exports['default'] = function (instance) {
	  instance.registerHelper('blockHelperMissing', function (context, options) {
	    var inverse = options.inverse,
	        fn = options.fn;

	    if (context === true) {
	      return fn(this);
	    } else if (context === false || context == null) {
	      return inverse(this);
	    } else if (_utils.isArray(context)) {
	      if (context.length > 0) {
	        if (options.ids) {
	          options.ids = [options.name];
	        }

	        return instance.helpers.each(context, options);
	      } else {
	        return inverse(this);
	      }
	    } else {
	      if (options.data && options.ids) {
	        var data = _utils.createFrame(options.data);
	        data.contextPath = _utils.appendContextPath(options.data.contextPath, options.name);
	        options = { data: data };
	      }

	      return fn(context, options);
	    }
	  });
	};

	module.exports = exports['default'];

/***/ }),
/* 11 */
/***/ (function(module, exports, __webpack_require__) {

	/* WEBPACK VAR INJECTION */(function(global) {'use strict';

	var _Object$keys = __webpack_require__(12)['default'];

	var _interopRequireDefault = __webpack_require__(2)['default'];

	exports.__esModule = true;

	var _utils = __webpack_require__(4);

	var _exception = __webpack_require__(5);

	var _exception2 = _interopRequireDefault(_exception);

	exports['default'] = function (instance) {
	  instance.registerHelper('each', function (context, options) {
	    if (!options) {
	      throw new _exception2['default']('Must pass iterator to #each');
	    }

	    var fn = options.fn,
	        inverse = options.inverse,
	        i = 0,
	        ret = '',
	        data = undefined,
	        contextPath = undefined;

	    if (options.data && options.ids) {
	      contextPath = _utils.appendContextPath(options.data.contextPath, options.ids[0]) + '.';
	    }

	    if (_utils.isFunction(context)) {
	      context = context.call(this);
	    }

	    if (options.data) {
	      data = _utils.createFrame(options.data);
	    }

	    function execIteration(field, index, last) {
	      if (data) {
	        data.key = field;
	        data.index = index;
	        data.first = index === 0;
	        data.last = !!last;

	        if (contextPath) {
	          data.contextPath = contextPath + field;
	        }
	      }

	      ret = ret + fn(context[field], {
	        data: data,
	        blockParams: _utils.blockParams([context[field], field], [contextPath + field, null])
	      });
	    }

	    if (context && typeof context === 'object') {
	      if (_utils.isArray(context)) {
	        for (var j = context.length; i < j; i++) {
	          if (i in context) {
	            execIteration(i, i, i === context.length - 1);
	          }
	        }
	      } else if (global.Symbol && context[global.Symbol.iterator]) {
	        var newContext = [];
	        var iterator = context[global.Symbol.iterator]();
	        for (var it = iterator.next(); !it.done; it = iterator.next()) {
	          newContext.push(it.value);
	        }
	        context = newContext;
	        for (var j = context.length; i < j; i++) {
	          execIteration(i, i, i === context.length - 1);
	        }
	      } else {
	        (function () {
	          var priorKey = undefined;

	          _Object$keys(context).forEach(function (key) {
	            // We're running the iterations one step out of sync so we can detect
	            // the last iteration without have to scan the object twice and create
	            // an itermediate keys array.
	            if (priorKey !== undefined) {
	              execIteration(priorKey, i - 1);
	            }
	            priorKey = key;
	            i++;
	          });
	          if (priorKey !== undefined) {
	            execIteration(priorKey, i - 1, true);
	          }
	        })();
	      }
	    }

	    if (i === 0) {
	      ret = inverse(this);
	    }

	    return ret;
	  });
	};

	module.exports = exports['default'];
	/* WEBPACK VAR INJECTION */}.call(exports, (function() { return this; }())))

/***/ }),
/* 12 */
/***/ (function(module, exports, __webpack_require__) {

	module.exports = { "default": __webpack_require__(13), __esModule: true };

/***/ }),
/* 13 */
/***/ (function(module, exports, __webpack_require__) {

	__webpack_require__(14);
	module.exports = __webpack_require__(20).Object.keys;

/***/ }),
/* 14 */
/***/ (function(module, exports, __webpack_require__) {

	// 19.1.2.14 Object.keys(O)
	var toObject = __webpack_require__(15);

	__webpack_require__(17)('keys', function($keys){
	  return function keys(it){
	    return $keys(toObject(it));
	  };
	});

/***/ }),
/* 15 */
/***/ (function(module, exports, __webpack_require__) {

	// 7.1.13 ToObject(argument)
	var defined = __webpack_require__(16);
	module.exports = function(it){
	  return Object(defined(it));
	};

/***/ }),
/* 16 */
/***/ (function(module, exports) {

	// 7.2.1 RequireObjectCoercible(argument)
	module.exports = function(it){
	  if(it == undefined)throw TypeError("Can't call method on  " + it);
	  return it;
	};

/***/ }),
/* 17 */
/***/ (function(module, exports, __webpack_require__) {

	// most Object methods by ES6 should accept primitives
	var $export = __webpack_require__(18)
	  , core    = __webpack_require__(20)
	  , fails   = __webpack_require__(23);
	module.exports = function(KEY, exec){
	  var fn  = (core.Object || {})[KEY] || Object[KEY]
	    , exp = {};
	  exp[KEY] = exec(fn);
	  $export($export.S + $export.F * fails(function(){ fn(1); }), 'Object', exp);
	};

/***/ }),
/* 18 */
/***/ (function(module, exports, __webpack_require__) {

	var global    = __webpack_require__(19)
	  , core      = __webpack_require__(20)
	  , ctx       = __webpack_require__(21)
	  , PROTOTYPE = 'prototype';

	var $export = function(type, name, source){
	  var IS_FORCED = type & $export.F
	    , IS_GLOBAL = type & $export.G
	    , IS_STATIC = type & $export.S
	    , IS_PROTO  = type & $export.P
	    , IS_BIND   = type & $export.B
	    , IS_WRAP   = type & $export.W
	    , exports   = IS_GLOBAL ? core : core[name] || (core[name] = {})
	    , target    = IS_GLOBAL ? global : IS_STATIC ? global[name] : (global[name] || {})[PROTOTYPE]
	    , key, own, out;
	  if(IS_GLOBAL)source = name;
	  for(key in source){
	    // contains in native
	    own = !IS_FORCED && target && key in target;
	    if(own && key in exports)continue;
	    // export native or passed
	    out = own ? target[key] : source[key];
	    // prevent global pollution for namespaces
	    exports[key] = IS_GLOBAL && typeof target[key] != 'function' ? source[key]
	    // bind timers to global for call from export context
	    : IS_BIND && own ? ctx(out, global)
	    // wrap global constructors for prevent change them in library
	    : IS_WRAP && target[key] == out ? (function(C){
	      var F = function(param){
	        return this instanceof C ? new C(param) : C(param);
	      };
	      F[PROTOTYPE] = C[PROTOTYPE];
	      return F;
	    // make static versions for prototype methods
	    })(out) : IS_PROTO && typeof out == 'function' ? ctx(Function.call, out) : out;
	    if(IS_PROTO)(exports[PROTOTYPE] || (exports[PROTOTYPE] = {}))[key] = out;
	  }
	};
	// type bitmap
	$export.F = 1;  // forced
	$export.G = 2;  // global
	$export.S = 4;  // static
	$export.P = 8;  // proto
	$export.B = 16; // bind
	$export.W = 32; // wrap
	module.exports = $export;

/***/ }),
/* 19 */
/***/ (function(module, exports) {

	// https://github.com/zloirock/core-js/issues/86#issuecomment-115759028
	var global = module.exports = typeof window != 'undefined' && window.Math == Math
	  ? window : typeof self != 'undefined' && self.Math == Math ? self : Function('return this')();
	if(typeof __g == 'number')__g = global; // eslint-disable-line no-undef

/***/ }),
/* 20 */
/***/ (function(module, exports) {

	var core = module.exports = {version: '1.2.6'};
	if(typeof __e == 'number')__e = core; // eslint-disable-line no-undef

/***/ }),
/* 21 */
/***/ (function(module, exports, __webpack_require__) {

	// optional / simple context binding
	var aFunction = __webpack_require__(22);
	module.exports = function(fn, that, length){
	  aFunction(fn);
	  if(that === undefined)return fn;
	  switch(length){
	    case 1: return function(a){
	      return fn.call(that, a);
	    };
	    case 2: return function(a, b){
	      return fn.call(that, a, b);
	    };
	    case 3: return function(a, b, c){
	      return fn.call(that, a, b, c);
	    };
	  }
	  return function(/* ...args */){
	    return fn.apply(that, arguments);
	  };
	};

/***/ }),
/* 22 */
/***/ (function(module, exports) {

	module.exports = function(it){
	  if(typeof it != 'function')throw TypeError(it + ' is not a function!');
	  return it;
	};

/***/ }),
/* 23 */
/***/ (function(module, exports) {

	module.exports = function(exec){
	  try {
	    return !!exec();
	  } catch(e){
	    return true;
	  }
	};

/***/ }),
/* 24 */
/***/ (function(module, exports, __webpack_require__) {

	'use strict';

	var _interopRequireDefault = __webpack_require__(2)['default'];

	exports.__esModule = true;

	var _exception = __webpack_require__(5);

	var _exception2 = _interopRequireDefault(_exception);

	exports['default'] = function (instance) {
	  instance.registerHelper('helperMissing', function () /* [args, ]options */{
	    if (arguments.length === 1) {
	      // A missing field in a {{foo}} construct.
	      return undefined;
	    } else {
	      // Someone is actually trying to call something, blow up.
	      throw new _exception2['default']('Missing helper: "' + arguments[arguments.length - 1].name + '"');
	    }
	  });
	};

	module.exports = exports['default'];

/***/ }),
/* 25 */
/***/ (function(module, exports, __webpack_require__) {

	'use strict';

	var _interopRequireDefault = __webpack_require__(2)['default'];

	exports.__esModule = true;

	var _utils = __webpack_require__(4);

	var _exception = __webpack_require__(5);

	var _exception2 = _interopRequireDefault(_exception);

	exports['default'] = function (instance) {
	  instance.registerHelper('if', function (conditional, options) {
	    if (arguments.length != 2) {
	      throw new _exception2['default']('#if requires exactly one argument');
	    }
	    if (_utils.isFunction(conditional)) {
	      conditional = conditional.call(this);
	    }

	    // Default behavior is to render the positive path if the value is truthy and not empty.
	    // The `includeZero` option may be set to treat the condtional as purely not empty based on the
	    // behavior of isEmpty. Effectively this determines if 0 is handled by the positive path or negative.
	    if (!options.hash.includeZero && !conditional || _utils.isEmpty(conditional)) {
	      return options.inverse(this);
	    } else {
	      return options.fn(this);
	    }
	  });

	  instance.registerHelper('unless', function (conditional, options) {
	    if (arguments.length != 2) {
	      throw new _exception2['default']('#unless requires exactly one argument');
	    }
	    return instance.helpers['if'].call(this, conditional, {
	      fn: options.inverse,
	      inverse: options.fn,
	      hash: options.hash
	    });
	  });
	};

	module.exports = exports['default'];

/***/ }),
/* 26 */
/***/ (function(module, exports) {

	'use strict';

	exports.__esModule = true;

	exports['default'] = function (instance) {
	  instance.registerHelper('log', function () /* message, options */{
	    var args = [undefined],
	        options = arguments[arguments.length - 1];
	    for (var i = 0; i < arguments.length - 1; i++) {
	      args.push(arguments[i]);
	    }

	    var level = 1;
	    if (options.hash.level != null) {
	      level = options.hash.level;
	    } else if (options.data && options.data.level != null) {
	      level = options.data.level;
	    }
	    args[0] = level;

	    instance.log.apply(instance, args);
	  });
	};

	module.exports = exports['default'];

/***/ }),
/* 27 */
/***/ (function(module, exports) {

	'use strict';

	exports.__esModule = true;

	exports['default'] = function (instance) {
	  instance.registerHelper('lookup', function (obj, field, options) {
	    if (!obj) {
	      // Note for 5.0: Change to "obj == null" in 5.0
	      return obj;
	    }
	    return options.lookupProperty(obj, field);
	  });
	};

	module.exports = exports['default'];

/***/ }),
/* 28 */
/***/ (function(module, exports, __webpack_require__) {

	'use strict';

	var _interopRequireDefault = __webpack_require__(2)['default'];

	exports.__esModule = true;

	var _utils = __webpack_require__(4);

	var _exception = __webpack_require__(5);

	var _exception2 = _interopRequireDefault(_exception);

	exports['default'] = function (instance) {
	  instance.registerHelper('with', function (context, options) {
	    if (arguments.length != 2) {
	      throw new _exception2['default']('#with requires exactly one argument');
	    }
	    if (_utils.isFunction(context)) {
	      context = context.call(this);
	    }

	    var fn = options.fn;

	    if (!_utils.isEmpty(context)) {
	      var data = options.data;
	      if (options.data && options.ids) {
	        data = _utils.createFrame(options.data);
	        data.contextPath = _utils.appendContextPath(options.data.contextPath, options.ids[0]);
	      }

	      return fn(context, {
	        data: data,
	        blockParams: _utils.blockParams([context], [data && data.contextPath])
	      });
	    } else {
	      return options.inverse(this);
	    }
	  });
	};

	module.exports = exports['default'];

/***/ }),
/* 29 */
/***/ (function(module, exports, __webpack_require__) {

	'use strict';

	var _interopRequireDefault = __webpack_require__(2)['default'];

	exports.__esModule = true;
	exports.registerDefaultDecorators = registerDefaultDecorators;

	var _decoratorsInline = __webpack_require__(30);

	var _decoratorsInline2 = _interopRequireDefault(_decoratorsInline);

	function registerDefaultDecorators(instance) {
	  _decoratorsInline2['default'](instance);
	}

/***/ }),
/* 30 */
/***/ (function(module, exports, __webpack_require__) {

	'use strict';

	exports.__esModule = true;

	var _utils = __webpack_require__(4);

	exports['default'] = function (instance) {
	  instance.registerDecorator('inline', function (fn, props, container, options) {
	    var ret = fn;
	    if (!props.partials) {
	      props.partials = {};
	      ret = function (context, options) {
	        // Create a new partials stack frame prior to exec.
	        var original = container.partials;
	        container.partials = _utils.extend({}, original, props.partials);
	        var ret = fn(context, options);
	        container.partials = original;
	        return ret;
	      };
	    }

	    props.partials[options.args[0]] = options.fn;

	    return ret;
	  });
	};

	module.exports = exports['default'];

/***/ }),
/* 31 */
/***/ (function(module, exports, __webpack_require__) {

	'use strict';

	exports.__esModule = true;

	var _utils = __webpack_require__(4);

	var logger = {
	  methodMap: ['debug', 'info', 'warn', 'error'],
	  level: 'info',

	  // Maps a given level value to the `methodMap` indexes above.
	  lookupLevel: function lookupLevel(level) {
	    if (typeof level === 'string') {
	      var levelMap = _utils.indexOf(logger.methodMap, level.toLowerCase());
	      if (levelMap >= 0) {
	        level = levelMap;
	      } else {
	        level = parseInt(level, 10);
	      }
	    }

	    return level;
	  },

	  // Can be overridden in the host environment
	  log: function log(level) {
	    level = logger.lookupLevel(level);

	    if (typeof console !== 'undefined' && logger.lookupLevel(logger.level) <= level) {
	      var method = logger.methodMap[level];
	      // eslint-disable-next-line no-console
	      if (!console[method]) {
	        method = 'log';
	      }

	      for (var _len = arguments.length, message = Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
	        message[_key - 1] = arguments[_key];
	      }

	      console[method].apply(console, message); // eslint-disable-line no-console
	    }
	  }
	};

	exports['default'] = logger;
	module.exports = exports['default'];

/***/ }),
/* 32 */
/***/ (function(module, exports, __webpack_require__) {

	'use strict';

	var _Object$create = __webpack_require__(33)['default'];

	var _Object$keys = __webpack_require__(12)['default'];

	var _interopRequireWildcard = __webpack_require__(1)['default'];

	exports.__esModule = true;
	exports.createProtoAccessControl = createProtoAccessControl;
	exports.resultIsAllowed = resultIsAllowed;
	exports.resetLoggedProperties = resetLoggedProperties;

	var _createNewLookupObject = __webpack_require__(35);

	var _logger = __webpack_require__(31);

	var logger = _interopRequireWildcard(_logger);

	var loggedProperties = _Object$create(null);

	function createProtoAccessControl(runtimeOptions) {
	  var defaultMethodWhiteList = _Object$create(null);
	  defaultMethodWhiteList['constructor'] = false;
	  defaultMethodWhiteList['__defineGetter__'] = false;
	  defaultMethodWhiteList['__defineSetter__'] = false;
	  defaultMethodWhiteList['__lookupGetter__'] = false;

	  var defaultPropertyWhiteList = _Object$create(null);
	  // eslint-disable-next-line no-proto
	  defaultPropertyWhiteList['__proto__'] = false;

	  return {
	    properties: {
	      whitelist: _createNewLookupObject.createNewLookupObject(defaultPropertyWhiteList, runtimeOptions.allowedProtoProperties),
	      defaultValue: runtimeOptions.allowProtoPropertiesByDefault
	    },
	    methods: {
	      whitelist: _createNewLookupObject.createNewLookupObject(defaultMethodWhiteList, runtimeOptions.allowedProtoMethods),
	      defaultValue: runtimeOptions.allowProtoMethodsByDefault
	    }
	  };
	}

	function resultIsAllowed(result, protoAccessControl, propertyName) {
	  if (typeof result === 'function') {
	    return checkWhiteList(protoAccessControl.methods, propertyName);
	  } else {
	    return checkWhiteList(protoAccessControl.properties, propertyName);
	  }
	}

	function checkWhiteList(protoAccessControlForType, propertyName) {
	  if (protoAccessControlForType.whitelist[propertyName] !== undefined) {
	    return protoAccessControlForType.whitelist[propertyName] === true;
	  }
	  if (protoAccessControlForType.defaultValue !== undefined) {
	    return protoAccessControlForType.defaultValue;
	  }
	  logUnexpecedPropertyAccessOnce(propertyName);
	  return false;
	}

	function logUnexpecedPropertyAccessOnce(propertyName) {
	  if (loggedProperties[propertyName] !== true) {
	    loggedProperties[propertyName] = true;
	    logger.log('error', 'Handlebars: Access has been denied to resolve the property "' + propertyName + '" because it is not an "own property" of its parent.\n' + 'You can add a runtime option to disable the check or this warning:\n' + 'See https://handlebarsjs.com/api-reference/runtime-options.html#options-to-control-prototype-access for details');
	  }
	}

	function resetLoggedProperties() {
	  _Object$keys(loggedProperties).forEach(function (propertyName) {
	    delete loggedProperties[propertyName];
	  });
	}

/***/ }),
/* 33 */
/***/ (function(module, exports, __webpack_require__) {

	module.exports = { "default": __webpack_require__(34), __esModule: true };

/***/ }),
/* 34 */
/***/ (function(module, exports, __webpack_require__) {

	var $ = __webpack_require__(8);
	module.exports = function create(P, D){
	  return $.create(P, D);
	};

/***/ }),
/* 35 */
/***/ (function(module, exports, __webpack_require__) {

	'use strict';

	var _Object$create = __webpack_require__(33)['default'];

	exports.__esModule = true;
	exports.createNewLookupObject = createNewLookupObject;

	var _utils = __webpack_require__(4);

	/**
	 * Create a new object with "null"-prototype to avoid truthy results on prototype properties.
	 * The resulting object can be used with "object[property]" to check if a property exists
	 * @param {...object} sources a varargs parameter of source objects that will be merged
	 * @returns {object}
	 */

	function createNewLookupObject() {
	  for (var _len = arguments.length, sources = Array(_len), _key = 0; _key < _len; _key++) {
	    sources[_key] = arguments[_key];
	  }

	  return _utils.extend.apply(undefined, [_Object$create(null)].concat(sources));
	}

/***/ }),
/* 36 */
/***/ (function(module, exports) {

	// Build out our basic SafeString type
	'use strict';

	exports.__esModule = true;
	function SafeString(string) {
	  this.string = string;
	}

	SafeString.prototype.toString = SafeString.prototype.toHTML = function () {
	  return '' + this.string;
	};

	exports['default'] = SafeString;
	module.exports = exports['default'];

/***/ }),
/* 37 */
/***/ (function(module, exports, __webpack_require__) {

	'use strict';

	var _Object$seal = __webpack_require__(38)['default'];

	var _Object$keys = __webpack_require__(12)['default'];

	var _interopRequireWildcard = __webpack_require__(1)['default'];

	var _interopRequireDefault = __webpack_require__(2)['default'];

	exports.__esModule = true;
	exports.checkRevision = checkRevision;
	exports.template = template;
	exports.wrapProgram = wrapProgram;
	exports.resolvePartial = resolvePartial;
	exports.invokePartial = invokePartial;
	exports.noop = noop;

	var _utils = __webpack_require__(4);

	var Utils = _interopRequireWildcard(_utils);

	var _exception = __webpack_require__(5);

	var _exception2 = _interopRequireDefault(_exception);

	var _base = __webpack_require__(3);

	var _helpers = __webpack_require__(9);

	var _internalWrapHelper = __webpack_require__(42);

	var _internalProtoAccess = __webpack_require__(32);

	function checkRevision(compilerInfo) {
	  var compilerRevision = compilerInfo && compilerInfo[0] || 1,
	      currentRevision = _base.COMPILER_REVISION;

	  if (compilerRevision >= _base.LAST_COMPATIBLE_COMPILER_REVISION && compilerRevision <= _base.COMPILER_REVISION) {
	    return;
	  }

	  if (compilerRevision < _base.LAST_COMPATIBLE_COMPILER_REVISION) {
	    var runtimeVersions = _base.REVISION_CHANGES[currentRevision],
	        compilerVersions = _base.REVISION_CHANGES[compilerRevision];
	    throw new _exception2['default']('Template was precompiled with an older version of Handlebars than the current runtime. ' + 'Please update your precompiler to a newer version (' + runtimeVersions + ') or downgrade your runtime to an older version (' + compilerVersions + ').');
	  } else {
	    // Use the embedded version info since the runtime doesn't know about this revision yet
	    throw new _exception2['default']('Template was precompiled with a newer version of Handlebars than the current runtime. ' + 'Please update your runtime to a newer version (' + compilerInfo[1] + ').');
	  }
	}

	function template(templateSpec, env) {
	  /* istanbul ignore next */
	  if (!env) {
	    throw new _exception2['default']('No environment passed to template');
	  }
	  if (!templateSpec || !templateSpec.main) {
	    throw new _exception2['default']('Unknown template object: ' + typeof templateSpec);
	  }

	  templateSpec.main.decorator = templateSpec.main_d;

	  // Note: Using env.VM references rather than local var references throughout this section to allow
	  // for external users to override these as pseudo-supported APIs.
	  env.VM.checkRevision(templateSpec.compiler);

	  // backwards compatibility for precompiled templates with compiler-version 7 (<4.3.0)
	  var templateWasPrecompiledWithCompilerV7 = templateSpec.compiler && templateSpec.compiler[0] === 7;

	  function invokePartialWrapper(partial, context, options) {
	    if (options.hash) {
	      context = Utils.extend({}, context, options.hash);
	      if (options.ids) {
	        options.ids[0] = true;
	      }
	    }
	    partial = env.VM.resolvePartial.call(this, partial, context, options);

	    var extendedOptions = Utils.extend({}, options, {
	      hooks: this.hooks,
	      protoAccessControl: this.protoAccessControl
	    });

	    var result = env.VM.invokePartial.call(this, partial, context, extendedOptions);

	    if (result == null && env.compile) {
	      options.partials[options.name] = env.compile(partial, templateSpec.compilerOptions, env);
	      result = options.partials[options.name](context, extendedOptions);
	    }
	    if (result != null) {
	      if (options.indent) {
	        var lines = result.split('\n');
	        for (var i = 0, l = lines.length; i < l; i++) {
	          if (!lines[i] && i + 1 === l) {
	            break;
	          }

	          lines[i] = options.indent + lines[i];
	        }
	        result = lines.join('\n');
	      }
	      return result;
	    } else {
	      throw new _exception2['default']('The partial ' + options.name + ' could not be compiled when running in runtime-only mode');
	    }
	  }

	  // Just add water
	  var container = {
	    strict: function strict(obj, name, loc) {
	      if (!obj || !(name in obj)) {
	        throw new _exception2['default']('"' + name + '" not defined in ' + obj, {
	          loc: loc
	        });
	      }
	      return obj[name];
	    },
	    lookupProperty: function lookupProperty(parent, propertyName) {
	      var result = parent[propertyName];
	      if (result == null) {
	        return result;
	      }
	      if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
	        return result;
	      }

	      if (_internalProtoAccess.resultIsAllowed(result, container.protoAccessControl, propertyName)) {
	        return result;
	      }
	      return undefined;
	    },
	    lookup: function lookup(depths, name) {
	      var len = depths.length;
	      for (var i = 0; i < len; i++) {
	        var result = depths[i] && container.lookupProperty(depths[i], name);
	        if (result != null) {
	          return depths[i][name];
	        }
	      }
	    },
	    lambda: function lambda(current, context) {
	      return typeof current === 'function' ? current.call(context) : current;
	    },

	    escapeExpression: Utils.escapeExpression,
	    invokePartial: invokePartialWrapper,

	    fn: function fn(i) {
	      var ret = templateSpec[i];
	      ret.decorator = templateSpec[i + '_d'];
	      return ret;
	    },

	    programs: [],
	    program: function program(i, data, declaredBlockParams, blockParams, depths) {
	      var programWrapper = this.programs[i],
	          fn = this.fn(i);
	      if (data || depths || blockParams || declaredBlockParams) {
	        programWrapper = wrapProgram(this, i, fn, data, declaredBlockParams, blockParams, depths);
	      } else if (!programWrapper) {
	        programWrapper = this.programs[i] = wrapProgram(this, i, fn);
	      }
	      return programWrapper;
	    },

	    data: function data(value, depth) {
	      while (value && depth--) {
	        value = value._parent;
	      }
	      return value;
	    },
	    mergeIfNeeded: function mergeIfNeeded(param, common) {
	      var obj = param || common;

	      if (param && common && param !== common) {
	        obj = Utils.extend({}, common, param);
	      }

	      return obj;
	    },
	    // An empty object to use as replacement for null-contexts
	    nullContext: _Object$seal({}),

	    noop: env.VM.noop,
	    compilerInfo: templateSpec.compiler
	  };

	  function ret(context) {
	    var options = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

	    var data = options.data;

	    ret._setup(options);
	    if (!options.partial && templateSpec.useData) {
	      data = initData(context, data);
	    }
	    var depths = undefined,
	        blockParams = templateSpec.useBlockParams ? [] : undefined;
	    if (templateSpec.useDepths) {
	      if (options.depths) {
	        depths = context != options.depths[0] ? [context].concat(options.depths) : options.depths;
	      } else {
	        depths = [context];
	      }
	    }

	    function main(context /*, options*/) {
	      return '' + templateSpec.main(container, context, container.helpers, container.partials, data, blockParams, depths);
	    }

	    main = executeDecorators(templateSpec.main, main, container, options.depths || [], data, blockParams);
	    return main(context, options);
	  }

	  ret.isTop = true;

	  ret._setup = function (options) {
	    if (!options.partial) {
	      var mergedHelpers = Utils.extend({}, env.helpers, options.helpers);
	      wrapHelpersToPassLookupProperty(mergedHelpers, container);
	      container.helpers = mergedHelpers;

	      if (templateSpec.usePartial) {
	        // Use mergeIfNeeded here to prevent compiling global partials multiple times
	        container.partials = container.mergeIfNeeded(options.partials, env.partials);
	      }
	      if (templateSpec.usePartial || templateSpec.useDecorators) {
	        container.decorators = Utils.extend({}, env.decorators, options.decorators);
	      }

	      container.hooks = {};
	      container.protoAccessControl = _internalProtoAccess.createProtoAccessControl(options);

	      var keepHelperInHelpers = options.allowCallsToHelperMissing || templateWasPrecompiledWithCompilerV7;
	      _helpers.moveHelperToHooks(container, 'helperMissing', keepHelperInHelpers);
	      _helpers.moveHelperToHooks(container, 'blockHelperMissing', keepHelperInHelpers);
	    } else {
	      container.protoAccessControl = options.protoAccessControl; // internal option
	      container.helpers = options.helpers;
	      container.partials = options.partials;
	      container.decorators = options.decorators;
	      container.hooks = options.hooks;
	    }
	  };

	  ret._child = function (i, data, blockParams, depths) {
	    if (templateSpec.useBlockParams && !blockParams) {
	      throw new _exception2['default']('must pass block params');
	    }
	    if (templateSpec.useDepths && !depths) {
	      throw new _exception2['default']('must pass parent depths');
	    }

	    return wrapProgram(container, i, templateSpec[i], data, 0, blockParams, depths);
	  };
	  return ret;
	}

	function wrapProgram(container, i, fn, data, declaredBlockParams, blockParams, depths) {
	  function prog(context) {
	    var options = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

	    var currentDepths = depths;
	    if (depths && context != depths[0] && !(context === container.nullContext && depths[0] === null)) {
	      currentDepths = [context].concat(depths);
	    }

	    return fn(container, context, container.helpers, container.partials, options.data || data, blockParams && [options.blockParams].concat(blockParams), currentDepths);
	  }

	  prog = executeDecorators(fn, prog, container, depths, data, blockParams);

	  prog.program = i;
	  prog.depth = depths ? depths.length : 0;
	  prog.blockParams = declaredBlockParams || 0;
	  return prog;
	}

	/**
	 * This is currently part of the official API, therefore implementation details should not be changed.
	 */

	function resolvePartial(partial, context, options) {
	  if (!partial) {
	    if (options.name === '@partial-block') {
	      partial = options.data['partial-block'];
	    } else {
	      partial = options.partials[options.name];
	    }
	  } else if (!partial.call && !options.name) {
	    // This is a dynamic partial that returned a string
	    options.name = partial;
	    partial = options.partials[partial];
	  }
	  return partial;
	}

	function invokePartial(partial, context, options) {
	  // Use the current closure context to save the partial-block if this partial
	  var currentPartialBlock = options.data && options.data['partial-block'];
	  options.partial = true;
	  if (options.ids) {
	    options.data.contextPath = options.ids[0] || options.data.contextPath;
	  }

	  var partialBlock = undefined;
	  if (options.fn && options.fn !== noop) {
	    (function () {
	      options.data = _base.createFrame(options.data);
	      // Wrapper function to get access to currentPartialBlock from the closure
	      var fn = options.fn;
	      partialBlock = options.data['partial-block'] = function partialBlockWrapper(context) {
	        var options = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

	        // Restore the partial-block from the closure for the execution of the block
	        // i.e. the part inside the block of the partial call.
	        options.data = _base.createFrame(options.data);
	        options.data['partial-block'] = currentPartialBlock;
	        return fn(context, options);
	      };
	      if (fn.partials) {
	        options.partials = Utils.extend({}, options.partials, fn.partials);
	      }
	    })();
	  }

	  if (partial === undefined && partialBlock) {
	    partial = partialBlock;
	  }

	  if (partial === undefined) {
	    throw new _exception2['default']('The partial ' + options.name + ' could not be found');
	  } else if (partial instanceof Function) {
	    return partial(context, options);
	  }
	}

	function noop() {
	  return '';
	}

	function initData(context, data) {
	  if (!data || !('root' in data)) {
	    data = data ? _base.createFrame(data) : {};
	    data.root = context;
	  }
	  return data;
	}

	function executeDecorators(fn, prog, container, depths, data, blockParams) {
	  if (fn.decorator) {
	    var props = {};
	    prog = fn.decorator(prog, props, container, depths && depths[0], data, blockParams, depths);
	    Utils.extend(prog, props);
	  }
	  return prog;
	}

	function wrapHelpersToPassLookupProperty(mergedHelpers, container) {
	  _Object$keys(mergedHelpers).forEach(function (helperName) {
	    var helper = mergedHelpers[helperName];
	    mergedHelpers[helperName] = passLookupPropertyOption(helper, container);
	  });
	}

	function passLookupPropertyOption(helper, container) {
	  var lookupProperty = container.lookupProperty;
	  return _internalWrapHelper.wrapHelper(helper, function (options) {
	    return Utils.extend({ lookupProperty: lookupProperty }, options);
	  });
	}

/***/ }),
/* 38 */
/***/ (function(module, exports, __webpack_require__) {

	module.exports = { "default": __webpack_require__(39), __esModule: true };

/***/ }),
/* 39 */
/***/ (function(module, exports, __webpack_require__) {

	__webpack_require__(40);
	module.exports = __webpack_require__(20).Object.seal;

/***/ }),
/* 40 */
/***/ (function(module, exports, __webpack_require__) {

	// 19.1.2.17 Object.seal(O)
	var isObject = __webpack_require__(41);

	__webpack_require__(17)('seal', function($seal){
	  return function seal(it){
	    return $seal && isObject(it) ? $seal(it) : it;
	  };
	});

/***/ }),
/* 41 */
/***/ (function(module, exports) {

	module.exports = function(it){
	  return typeof it === 'object' ? it !== null : typeof it === 'function';
	};

/***/ }),
/* 42 */
/***/ (function(module, exports) {

	'use strict';

	exports.__esModule = true;
	exports.wrapHelper = wrapHelper;

	function wrapHelper(helper, transformOptionsFn) {
	  if (typeof helper !== 'function') {
	    // This should not happen, but apparently it does in https://github.com/wycats/handlebars.js/issues/1639
	    // We try to make the wrapper least-invasive by not wrapping it, if the helper is not a function.
	    return helper;
	  }
	  var wrapper = function wrapper() /* dynamic arguments */{
	    var options = arguments[arguments.length - 1];
	    arguments[arguments.length - 1] = transformOptionsFn(options);
	    return helper.apply(this, arguments);
	  };
	  return wrapper;
	}

/***/ }),
/* 43 */
/***/ (function(module, exports) {

	/* WEBPACK VAR INJECTION */(function(global) {'use strict';

	exports.__esModule = true;

	exports['default'] = function (Handlebars) {
	  /* istanbul ignore next */
	  var root = typeof global !== 'undefined' ? global : window,
	      $Handlebars = root.Handlebars;
	  /* istanbul ignore next */
	  Handlebars.noConflict = function () {
	    if (root.Handlebars === Handlebars) {
	      root.Handlebars = $Handlebars;
	    }
	    return Handlebars;
	  };
	};

	module.exports = exports['default'];
	/* WEBPACK VAR INJECTION */}.call(exports, (function() { return this; }())))

/***/ })
/******/ ])
});
;
define('handlebars.partials',['handlebars'], function(Handlebars) {

Handlebars.registerPartial("activityFooterDefaultActions", Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    return "<span class=\"icon-lock icon-tiny spacing-right-small\"></span>\n";
},"3":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"1 Comment",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":11,"column":0},"end":{"line":11,"column":23}}}))
    + "\n";
},"5":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"%(countOf)s Comments",{"name":"gettext","hash":{"countOf":((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"posts") : stack1)},"data":data,"loc":{"start":{"line":13,"column":0},"end":{"line":13,"column":55}}}))
    + "\n";
},"7":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<li class=\"action\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"favorited") : depth0),{"name":"if","hash":{},"fn":container.program(8, data, 0),"inverse":container.program(10, data, 0),"data":data,"loc":{"start":{"line":20,"column":0},"end":{"line":24,"column":7}}})) != null ? stack1 : "")
    + "</li>\n";
},"8":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a class=\"action-favorite active\" href=\"#\" data-action=\"favorite\">"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Recommended",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":21,"column":66},"end":{"line":21,"column":91}}}))
    + " <span class=\"icon icon-heart\"></span></a>\n";
},"10":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a class=\"action-favorite\" href=\"#\" data-action=\"favorite\">"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Recommend",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":23,"column":59},"end":{"line":23,"column":82}}}))
    + " <span class=\"icon icon-heart\"></span></a>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, alias3=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<li class=\"action\">\n<a class=\"action-comments\"\nhref=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"discussionRoute") : depth0), depth0))
    + "\"\ndata-link-name=\"comment_count\"\ndata-thread-id=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + "\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias3,((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"isClosed") : stack1),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":6,"column":0},"end":{"line":8,"column":7}}})) != null ? stack1 : "")
    + "\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias3,lookupProperty(helpers,"eq").call(alias3,((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"posts") : stack1),1,{"name":"eq","hash":{},"data":data,"loc":{"start":{"line":10,"column":6},"end":{"line":10,"column":25}}}),{"name":"if","hash":{},"fn":container.program(3, data, 0),"inverse":container.program(5, data, 0),"data":data,"loc":{"start":{"line":10,"column":0},"end":{"line":14,"column":7}}})) != null ? stack1 : "")
    + "<span class=\"icon icon-comment\"></span>\n</a>\n</li>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias3,(depth0 != null ? lookupProperty(depth0,"authenticated") : depth0),{"name":"if","hash":{},"fn":container.program(7, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":18,"column":0},"end":{"line":26,"column":7}}})) != null ? stack1 : "");
},"useData":true}));

Handlebars.registerPartial("badges", Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<span class=\"badge -warning -inline\">\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Marked as Spam",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":4,"column":0},"end":{"line":4,"column":28}}}))
    + "\n</span>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<span data-role=\"badges\">\n"
    + ((stack1 = lookupProperty(helpers,"if_all").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"isSpam") : depth0),(depth0 != null ? lookupProperty(depth0,"isAuthor") : depth0),{"name":"if_all","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":2,"column":0},"end":{"line":6,"column":11}}})) != null ? stack1 : "")
    + "</span>\n";
},"useData":true}));

Handlebars.registerPartial("boostTimeRemaining", Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(alias1,"Boost ends in %(relativeTime)s",{"name":"gettext","hash":{"relativeTime":lookupProperty(helpers,"getPartial").call(alias1,"timeSelector",{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":3,"column":58},"end":{"line":3,"column":85}}})},"data":data,"loc":{"start":{"line":3,"column":0},"end":{"line":3,"column":87}}}))
    + "\n";
},"3":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<span data-action=\"choose-boost-time\" class=\"link\">\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Boost ends %(relativeTime)s",{"name":"gettext","hash":{"relativeTime":(depth0 != null ? lookupProperty(depth0,"boostTimeRemaining") : depth0)},"data":data,"loc":{"start":{"line":6,"column":0},"end":{"line":6,"column":75}}}))
    + "\n</span>\n";
},"5":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<span title=\"Remove Boost\" class=\"link pull-right\" data-action=\"unboost\">\n<span class=\"icon icon-arrow\"></span>\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Remove Boost",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":12,"column":0},"end":{"line":12,"column":26}}}))
    + "\n</span>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<span class=\"icon icon-megaphone\"></span>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"showBoostTimeSelector") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"data":data,"loc":{"start":{"line":2,"column":0},"end":{"line":8,"column":7}}})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"showUnboost") : depth0),{"name":"if","hash":{},"fn":container.program(5, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":9,"column":0},"end":{"line":14,"column":7}}})) != null ? stack1 : "");
},"useData":true}));

Handlebars.registerPartial("cardContentImage", Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"link") : stack1), depth0))
    + "\"\nclass=\"card-content__media\"\ndata-link-name=\"image\"\ndata-link-out=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"signedLink") : stack1), depth0))
    + "\"\ndata-thread-id=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + "\">\n<div style=\"background-image: url("
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"image") : depth0)) != null ? lookupProperty(stack1,"src") : stack1), depth0))
    + ")\" class=\"img-cards\"></div>\n</a>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"image") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":1,"column":0},"end":{"line":9,"column":7}}})) != null ? stack1 : "");
},"useData":true}));

Handlebars.registerPartial("cardReasonDisqusPicks", Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card__reason link-inner-gray-dark\">\n<span class=\"icon-heart icon__position -inline text-smaller text-gray-light\"></span>\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"%(disqusTeamLink)s recommended",{"name":"gettext","hash":{"disqusTeamLink":lookupProperty(helpers,"tag").call(alias1,"a",{"name":"tag","hash":{"text":lookupProperty(helpers,"gettext").call(alias1,"%(disqus)s Team",{"name":"gettext","hash":{"disqus":"Disqus"},"data":data,"loc":{"start":{"line":10,"column":5},"end":{"line":10,"column":50}}}),"class":"text-semibold","data-channel-slug":"disquspicks","data-link-name":"forum_name","href":"/home/channel/disquspicks/"},"data":data,"loc":{"start":{"line":5,"column":17},"end":{"line":10,"column":51}}})},"data":data,"loc":{"start":{"line":4,"column":0},"end":{"line":10,"column":53}}}))
    + "\n\n<time class=\"bullet text-gray\">"
    + alias2(container.lambda((depth0 != null ? lookupProperty(depth0,"relativeTime") : depth0), depth0))
    + "</time>\n</div>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"isBestOfDisqus") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":1,"column":0},"end":{"line":14,"column":7}}})) != null ? stack1 : "");
},"useData":true}));

Handlebars.registerPartial("cardReasonForum", Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a class=\"spacing-right align__item\"\nhref=\"/home/channel/"
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"channel") : depth0)) != null ? lookupProperty(stack1,"slug") : stack1), depth0))
    + "/\"\ndata-link-name=\"forum_avatar\"\ndata-forum-pk=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"pk") : depth0), depth0))
    + "\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"channelAvatar") : depth0),{"name":"if","hash":{},"fn":container.program(2, data, 0),"inverse":container.program(4, data, 0),"data":data,"loc":{"start":{"line":7,"column":0},"end":{"line":13,"column":7}}})) != null ? stack1 : "")
    + "</a>\n";
},"2":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<img class=\"img-round-sm block__item\" src=\""
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"channelAvatar") : depth0), depth0))
    + "\" alt=\""
    + ((stack1 = container.invokePartial(lookupProperty(partials,"forumName"),depth0,{"name":"forumName","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "\">\n";
},"4":function(container,depth0,helpers,partials,data) {
    var alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"channel-avatar "
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"bannerColorClass") : depth0), depth0))
    + "\">\n<p class=\"channel-avatar__name\">"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"channelInitial") : depth0), depth0))
    + "</p>\n</div>\n";
},"6":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"with").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1),{"name":"with","hash":{},"fn":container.program(7, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":16,"column":0},"end":{"line":23,"column":9}}})) != null ? stack1 : "");
},"7":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a class=\"spacing-right align__item\"\nhref=\"/home/forum/"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"id") : depth0), depth0))
    + "/\"\ndata-link-name=\"forum_avatar\"\ndata-forum-pk=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"pk") : depth0), depth0))
    + "\">\n<img src=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"faviconImage") : depth0), depth0))
    + "\" alt=\""
    + ((stack1 = container.invokePartial(lookupProperty(partials,"forumName"),depth0,{"name":"forumName","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "\" class=\"img-round-sm block__item\" />\n</a>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card__reason align align--middle\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"channel") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(6, data, 0),"data":data,"loc":{"start":{"line":2,"column":0},"end":{"line":24,"column":7}}})) != null ? stack1 : "")
    + "<div class=\"align__item\">\n<strong>"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"forumLink"),((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1),{"name":"forumLink","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</strong>\n</div>\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"badges"),depth0,{"name":"badges","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n";
},"usePartial":true,"useData":true}));

Handlebars.registerPartial("cards", Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    return "cards here\n";
},"useData":true}));

Handlebars.registerPartial("cardTitle", Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card-title\">\n<h2 class=\"discussion-title\">\n<a href=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"link") : stack1), depth0))
    + "\"\nclass=\"link-gray-darker\"\ndata-role=\"thread-link\"\ndata-link-out=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"signedLink") : stack1), depth0))
    + "\"\ndata-link-name=\"title\"\ndata-thread-id=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + "\">\n\n"
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"clean_title") : stack1), depth0))
    + "\n</a>\n</h2>\non\n<a href=\"/home/"
    + alias2(alias1(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1)) != null ? lookupProperty(stack1,"forumRoute") : stack1), depth0))
    + "\"\nclass=\"link-gray-darker discussion-community\"\ndata-link-name=\"forum_name\"\ndata-forum-pk=\""
    + alias2(alias1(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1)) != null ? lookupProperty(stack1,"pk") : stack1), depth0))
    + "\">\n\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"forumName"),((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1),{"name":"forumName","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</a>\n</div>\n";
},"usePartial":true,"useData":true}));

Handlebars.registerPartial("cardTitleInlineName", Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<span class=\"card-title-inline-name\">\n<a href=\"/home/"
    + alias2(alias1(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1)) != null ? lookupProperty(stack1,"forumRoute") : stack1), depth0))
    + "\"\nclass=\"discussion-community\"\ndata-link-name=\"forum_name\"\ndata-forum-pk=\""
    + alias2(alias1(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1)) != null ? lookupProperty(stack1,"pk") : stack1), depth0))
    + "\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"forumName"),((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1),{"name":"forumName","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</a>\n</span>\n";
},"usePartial":true,"useData":true}));

Handlebars.registerPartial("channelAvatar", Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<img class=\"favicon\" src=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"options") : depth0)) != null ? lookupProperty(stack1,"favicon") : stack1), depth0))
    + "\" alt=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"name") : depth0), depth0))
    + "\"/>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a class=\"discussion-origin-name\" href=\"/home/channel/"
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"slug") : depth0), depth0))
    + "/\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = (depth0 != null ? lookupProperty(depth0,"options") : depth0)) != null ? lookupProperty(stack1,"favicon") : stack1),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":2,"column":0},"end":{"line":4,"column":7}}})) != null ? stack1 : "")
    + "</a>\n";
},"useData":true}));

Handlebars.registerPartial("channelAvatarWithDefault", Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<img class=\"forum-favicon\" src=\""
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"channelAvatar") : depth0), depth0))
    + "\" alt=\""
    + ((stack1 = container.invokePartial(lookupProperty(partials,"forumName"),depth0,{"name":"forumName","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "\">\n";
},"3":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = container.invokePartial(lookupProperty(partials,"defaultChannelAvatar"),depth0,{"name":"defaultChannelAvatar","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "");
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"channelAvatar") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"data":data,"loc":{"start":{"line":1,"column":0},"end":{"line":5,"column":7}}})) != null ? stack1 : "");
},"usePartial":true,"useData":true}));

Handlebars.registerPartial("channelAwareForumLink", Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = container.invokePartial(lookupProperty(partials,"channelLink"),(depth0 != null ? lookupProperty(depth0,"channelInfo") : depth0),{"name":"channelLink","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "");
},"3":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = container.invokePartial(lookupProperty(partials,"forumLink"),depth0,{"name":"forumLink","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "");
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"channelInfo") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"data":data,"loc":{"start":{"line":1,"column":0},"end":{"line":5,"column":7}}})) != null ? stack1 : "");
},"usePartial":true,"useData":true}));

Handlebars.registerPartial("channelAwareForumName", Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(container.lambda(((stack1 = (depth0 != null ? lookupProperty(depth0,"channelInfo") : depth0)) != null ? lookupProperty(stack1,"name") : stack1), depth0))
    + "\n";
},"3":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = container.invokePartial(lookupProperty(partials,"forumName"),depth0,{"name":"forumName","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "");
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"channelInfo") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"data":data,"loc":{"start":{"line":1,"column":0},"end":{"line":5,"column":7}}})) != null ? stack1 : "");
},"usePartial":true,"useData":true}));

Handlebars.registerPartial("channelCardContent", Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    return " has-image";
},"3":function(container,depth0,helpers,partials,data) {
    return " hidden-md";
},"5":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"forumFriendlyUrl") : depth0),{"name":"if","hash":{},"fn":container.program(6, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":14,"column":0},"end":{"line":26,"column":7}}})) != null ? stack1 : "");
},"6":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<p class=\"spacing-narrow text-smaller\">\n<a href=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"link") : stack1), depth0))
    + "\"\ndata-link-out=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"signedLink") : stack1), depth0))
    + "\"\nclass=\"link-gray\"\ndata-link-name=\"external_thread\"\ndata-thread-id=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + "\">\n\n<span class=\"icon icon-communities icon__position -inline icon-tiny\"></span>\n"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"forumFriendlyUrl") : depth0), depth0))
    + "\n</a>\n</p>\n";
},"8":function(container,depth0,helpers,partials,data) {
    return "<div class=\"card__additional\">\n<div class=\"card-comment-band\" data-role=\"posts\"></div>\n</div>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card__content -default"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"image") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":1,"column":34},"end":{"line":1,"column":64}}})) != null ? stack1 : "")
    + "\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"cardContentImage"),depth0,{"name":"cardContentImage","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "<div class=\"card-content__body\">\n<div class=\"card-content__topics\">\n<div data-role=\"topics\"></div>\n</div>\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"threadTitle"),depth0,{"name":"threadTitle","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "<div class=\"card-content__summary"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"recentPostCount") : depth0),{"name":"if","hash":{},"fn":container.program(3, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":8,"column":33},"end":{"line":8,"column":73}}})) != null ? stack1 : "")
    + "\">\n<div class=\"truncate\" data-truncate-lines=\"3\" dir=\"auto\">\n"
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"threadDescription") : depth0), depth0))
    + "\n</div>\n</div>\n"
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"channel") : depth0),{"name":"unless","hash":{},"fn":container.program(5, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":13,"column":0},"end":{"line":27,"column":11}}})) != null ? stack1 : "")
    + "</div>\n</div>\n<div class=\"card__footer text-small\" data-role=\"footer\"></div>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"recentPostCount") : depth0),{"name":"if","hash":{},"fn":container.program(8, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":31,"column":0},"end":{"line":35,"column":7}}})) != null ? stack1 : "");
},"usePartial":true,"useData":true}));

Handlebars.registerPartial("channelCardMenu", Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    return " open";
},"3":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<li>\n<a href=\"#\" class=\"dropdown--follow-lnk"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"userSubscription") : stack1),{"name":"if","hash":{},"fn":container.program(4, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":13,"column":39},"end":{"line":13,"column":84}}})) != null ? stack1 : "")
    + "\"\ndata-action=\"menuitem-click\" data-menu-item=\"toggle-subscription\">\n<span class=\"text-default\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Subscribe to discussion",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":15,"column":27},"end":{"line":15,"column":64}}}))
    + "</span>\n<span class=\"text-following\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Unsubscribe from discussion",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":16,"column":29},"end":{"line":16,"column":70}}}))
    + "</span>\n</a>\n</li>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"isBestOfDisqus") : depth0),{"name":"if","hash":{},"fn":container.program(6, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":19,"column":0},"end":{"line":26,"column":7}}})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"canModerate") : depth0),{"name":"if","hash":{},"fn":container.program(8, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":27,"column":0},"end":{"line":38,"column":7}}})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"canEdit") : depth0),{"name":"if","hash":{},"fn":container.program(13, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":39,"column":0},"end":{"line":45,"column":7}}})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"canDelete") : depth0),{"name":"if","hash":{},"fn":container.program(15, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":46,"column":0},"end":{"line":53,"column":7}}})) != null ? stack1 : "");
},"4":function(container,depth0,helpers,partials,data) {
    return " active";
},"6":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<li>\n<a href=\"#\" class=\"dropdown--follow-lnk\" data-action=\"menuitem-click\"\ndata-menu-item=\"toggle-follow-targetchannel\">\n<span class=\"text-default\">"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Unfollow %(disqus)s Team Picks",{"name":"gettext","hash":{"disqus":"Disqus"},"data":data,"loc":{"start":{"line":23,"column":27},"end":{"line":23,"column":89}}}))
    + "</span>\n</a>\n</li>\n";
},"8":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<li>\n<a href=\"#\" class=\"dropdown--follow-lnk\"\ndata-action=\"menuitem-click\" data-menu-item=\"mark-spam\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"isSpam") : depth0),{"name":"if","hash":{},"fn":container.program(9, data, 0),"inverse":container.program(11, data, 0),"data":data,"loc":{"start":{"line":31,"column":0},"end":{"line":35,"column":7}}})) != null ? stack1 : "")
    + "</a>\n</li>\n";
},"9":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Discussion isn't spam",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":32,"column":0},"end":{"line":32,"column":35}}}))
    + "\n";
},"11":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Mark discussion as spam",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":34,"column":0},"end":{"line":34,"column":37}}}))
    + "\n";
},"13":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<li>\n<a href=\"/home/edit/"
    + alias2(alias1(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + "/"
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"slug") : stack1), depth0))
    + "/\" class=\"dropdown--follow-lnk\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Edit discussion",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":42,"column":0},"end":{"line":42,"column":29}}}))
    + "\n</a>\n</li>\n";
},"15":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<li>\n<a href=\"#\" class=\"dropdown--follow-lnk text-error\" data-action=\"menuitem-click\"\ndata-menu-item=\"delete-thread\">\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Delete discussion",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":50,"column":0},"end":{"line":50,"column":31}}}))
    + "\n</a>\n</li>\n";
},"17":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<li>\n<a href=\"#\" class=\"dropdown--follow-lnk\" data-action=\"menuitem-click\"\ndata-menu-item=\"restore-thread\">\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Undo delete",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":58,"column":0},"end":{"line":58,"column":25}}}))
    + "\n</a>\n</li>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card__subnav pull-right dropdown"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"menuOpen") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":6,"column":44},"end":{"line":6,"column":72}}})) != null ? stack1 : "")
    + "\" data-role=\"menu\">\n<a href=\"#\" class=\"dropdown-toggle link-gray-light\" data-toggle=\"dropdown\">\n<span class=\"icon icon-show-more text-small\"></span>\n</a>\n<ul class=\"dropdown-menu dropdown--card-actions\" role=\"menu\" aria-labeledby=\"drop-discover\">\n"
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"isDeleted") : stack1),{"name":"unless","hash":{},"fn":container.program(3, data, 0),"inverse":container.program(17, data, 0),"data":data,"loc":{"start":{"line":11,"column":0},"end":{"line":61,"column":11}}})) != null ? stack1 : "")
    + "</ul>\n</div>\n";
},"useData":true}));

Handlebars.registerPartial("channelCoverLogo", Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"channel-cover__logo\">\n<img src=\""
    + container.escapeExpression(container.lambda(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"options") : depth0)) != null ? lookupProperty(stack1,"titleLogo") : stack1)) != null ? lookupProperty(stack1,"cache") : stack1), depth0))
    + "\" class=\"img-responsive block__item\" />\n</div>\n";
},"3":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<h1 class=\"channel-cover__heading\">"
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"name") : depth0), depth0))
    + "</h1>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = (depth0 != null ? lookupProperty(depth0,"options") : depth0)) != null ? lookupProperty(stack1,"titleLogo") : stack1),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"data":data,"loc":{"start":{"line":1,"column":0},"end":{"line":7,"column":7}}})) != null ? stack1 : "");
},"useData":true}));

Handlebars.registerPartial("channelLink", Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\"/home/channel/"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"slug") : depth0), depth0))
    + "/\"\nclass=\"link-community\"\ndata-link-name=\"channel_name\"\ndata-channel-slug=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"slug") : depth0), depth0))
    + "\">\n\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"forumName"),depth0,{"name":"forumName","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</a>\n";
},"usePartial":true,"useData":true}));

Handlebars.registerPartial("channelMetadataStats", Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"channel-stat__item -following\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"genericFollowButton"),depth0,{"name":"genericFollowButton","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, alias3=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"channel-stat__item\">\n<span class=\"text-semibold\" data-role=\"discussion-count\">"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"numThreads") : depth0), depth0))
    + "</span>\n<small class=\"channel-stat__subtext\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias3,"Discussions",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":4,"column":0},"end":{"line":4,"column":25}}}))
    + "\n</small>\n</div>\n<div class=\"channel-stat__item\">\n<span class=\"text-semibold\" data-role=\"followers-count\">"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"numFollowers") : depth0), depth0))
    + "</span>\n<small class=\"channel-stat__subtext\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias3,"Followers",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":10,"column":0},"end":{"line":10,"column":23}}}))
    + "\n</small>\n</div>\n"
    + ((stack1 = lookupProperty(helpers,"unless").call(alias3,((stack1 = (depth0 != null ? lookupProperty(depth0,"channel") : depth0)) != null ? lookupProperty(stack1,"isAggregation") : stack1),{"name":"unless","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":13,"column":0},"end":{"line":17,"column":11}}})) != null ? stack1 : "");
},"usePartial":true,"useData":true}));

Handlebars.registerPartial("channelRules", Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<strong>tl;dr</strong>\n<ol class=\"list-num spacing-bottom\">\n<li>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Follow the %(basicRules)s",{"name":"gettext","hash":{"basicRules":lookupProperty(helpers,"tag").call(alias1,"a",{"name":"tag","hash":{"text":"Basic Rules","href":"https://help.disqus.com/customer/en/portal/articles/1753105"},"data":data,"loc":{"start":{"line":4,"column":13},"end":{"line":4,"column":108}}})},"data":data,"loc":{"start":{"line":3,"column":4},"end":{"line":4,"column":110}}}))
    + "</li>\n<li>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Make It Specific",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":5,"column":4},"end":{"line":5,"column":34}}}))
    + "</li>\n<li>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"No Spam",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":6,"column":4},"end":{"line":6,"column":25}}}))
    + "</li>\n<li>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"No Hateful Topics",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":7,"column":4},"end":{"line":7,"column":35}}}))
    + "</li>\n<li>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Keep It Clean (And Legal)",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":8,"column":4},"end":{"line":8,"column":43}}}))
    + "</li>\n</ol>\n\n<p><strong>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Follow the Basic Rules",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":11,"column":11},"end":{"line":11,"column":47}}}))
    + "</strong></p>\n<p>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"As a channel moderator, you are expected to enforce the %(basicRules)s in your community. If not followed, this can result in your channel being banned.",{"name":"gettext","hash":{"basicRules":lookupProperty(helpers,"tag").call(alias1,"a",{"name":"tag","hash":{"text":"Basic Rules","href":"https://help.disqus.com/customer/en/portal/articles/1753105"},"data":data,"loc":{"start":{"line":13,"column":13},"end":{"line":13,"column":108}}})},"data":data,"loc":{"start":{"line":12,"column":3},"end":{"line":13,"column":110}}}))
    + "</p>\n\n<p><strong>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Make It Specific",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":15,"column":11},"end":{"line":15,"column":41}}}))
    + "</strong></p>\n<p>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Choosing a specific topic will make it easier for others to join, and for you to keep people on topic once they start creating their own discussions on your channel.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":16,"column":3},"end":{"line":16,"column":182}}}))
    + "</p>\n\n<p><strong>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"No Spam",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":18,"column":11},"end":{"line":18,"column":32}}}))
    + "</strong></p>\n<p>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Channels are a place for discussion, not for selling or promoting websites, products, events or petitions.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":19,"column":3},"end":{"line":19,"column":123}}}))
    + "</p>\n\n<p><strong>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"No Hateful Topics",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":21,"column":11},"end":{"line":21,"column":42}}}))
    + "</strong></p>\n<p>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Channels created with the sole purpose of promoting sexist, racist, misogynist, homophobic, or generally offensive content are simply not allowed.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":22,"column":3},"end":{"line":22,"column":163}}}))
    + "</p>\n\n<p><strong>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Keep It Clean (And Legal)",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":24,"column":11},"end":{"line":24,"column":50}}}))
    + "</strong></p>\n<p>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Explicit material and illegal content are not permitted. Channels supporting this type of content will be banned.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":25,"column":3},"end":{"line":25,"column":130}}}))
    + "</p>";
},"useData":true}));

Handlebars.registerPartial("channelsModuleHeader", Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"moduleTitle") : depth0), depth0))
    + "\n";
},"3":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Channels on %(disqus)s",{"name":"gettext","hash":{"disqus":"Disqus"},"data":data,"loc":{"start":{"line":10,"column":0},"end":{"line":10,"column":54}}}))
    + "\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\"/home/explore/\" class=\"link-gray-darker\">\n<div class=\"module-header__icon icon-colorful\">\n<svg class=\"icon-discover\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" version=\"1.1\" x=\"0px\" y=\"0px\" viewBox=\"0 0 18 18\" enable-background=\"new 0 0 18 18\" xml:space=\"preserve\" width=\"26\" height=\"26\"><rect x=\"14\" width=\"4\" height=\"4\" class=\"dot\"/><rect x=\"14\" y=\"7\" width=\"4\" height=\"4\" class=\"dot\"/><rect x=\"14\" y=\"14\" width=\"4\" height=\"4\" class=\"dot\"/><rect x=\"7\" width=\"4\" height=\"4\" class=\"dot\"/><rect x=\"7\" y=\"7\" width=\"4\" height=\"4\" class=\"dot\"/><rect x=\"7\" y=\"14\" width=\"4\" height=\"4\" class=\"dot\"/><rect width=\"4\" height=\"4\" class=\"dot\"/><rect y=\"7\" width=\"4\" height=\"4\" class=\"dot\"/><rect y=\"14\" width=\"4\" height=\"4\" class=\"dot\"/></g></svg>\n</div>\n<div class=\"module-header__title\">\n<h2 class=\"module-header__heading\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"moduleTitle") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"data":data,"loc":{"start":{"line":7,"column":0},"end":{"line":11,"column":7}}})) != null ? stack1 : "")
    + "</h2>\n</div>\n</a>\n";
},"useData":true}));

Handlebars.registerPartial("channelsModuleMoreFooter", Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<footer class=\"module-footer\">\n<a href=\"/home/explore/\" class=\"nav-lnk -color-muted -flushed\">\n<div class=\"nav-lnk__blk\">"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Explore More Channels",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":3,"column":26},"end":{"line":3,"column":61}}}))
    + "</div>\n<div class=\"nav-lnk__pointer\">\n<span class=\"icon icon-right-bracket\"></span>\n</div>\n</a>\n</footer>\n";
},"useData":true}));

Handlebars.registerPartial("defaultChannelAvatar", Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"channel-avatar "
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"bannerColorClass") : depth0), depth0))
    + "\">\n<p class=\"channel-avatar__name\">"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"channelInitial") : depth0), depth0))
    + "</p>\n</div>\n";
},"useData":true}));

Handlebars.registerPartial("defaultForumAvatar", Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\"/home/forum/"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"id") : depth0), depth0))
    + "/\"\nclass=\"avatar\"\ndata-link-name=\"forum_avatar\"\ndata-forum-pk=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"pk") : depth0), depth0))
    + "\">\n\n<svg class=\"art-forum-blank\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" version=\"1.1\" x=\"0px\" y=\"0px\" viewBox=\"0 0 50 50\" enable-background=\"new 0 0 50 50\" xml:space=\"preserve\"><path d=\"M22.9 38c5.9 0 10.6-4.9 10.6-11s-4.8-11-10.6-11 s-10.6 4.9-10.6 11c0 1.6 0.3 3.2 1 4.6L11.5 36l4.5-0.6C17.9 37 20.3 38 22.9 38z\" class=\"style0\"/><path d=\"M31.2 29c-4.8 0-8.7-4-8.7-9s3.9-9 8.7-9s8.7 4 8.7 9 c0 1.3-0.3 2.6-0.8 3.7l1.4 3.7l-3.7-0.5C35.3 28.2 33.3 29 31.2 29z\" class=\"style1\"/></svg>\n</a>\n";
},"useData":true}));

Handlebars.registerPartial("discussionModerationActions", Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, alias3=container.lambda, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"align module__wrapper--moderation\">\n<div class=\"link--moderation dropdown\" data-role=\"menu\">\n<button class=\"link-gray-dark text-medium\" data-toggle=\"dropdown\">\n<span class=\"block__item icon-cog\"></span>\n<strong>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Moderate",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":6,"column":8},"end":{"line":6,"column":30}}}))
    + "</strong>\n</button>\n<ul class=\"dropdown-menu dropdown--cards dropdown--moderation-action\" role=\"menu\" aria-labeledby=\"drop-blacklist\">\n<li>\n<a href=\"#\" class=\"link text-semibold\" data-action=\"blacklist-forum\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Ban %(author)s on %(forum)s",{"name":"gettext","hash":{"forum":((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1)) != null ? lookupProperty(stack1,"name") : stack1),"author":((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"author") : stack1)) != null ? lookupProperty(stack1,"name") : stack1)},"data":data,"loc":{"start":{"line":11,"column":0},"end":{"line":11,"column":95}}}))
    + "\n</a>\n</li>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"isGlobalAdmin") : depth0),{"name":"if","hash":{},"fn":container.program(2, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":14,"column":0},"end":{"line":24,"column":7}}})) != null ? stack1 : "")
    + "<li>\n<a href=\"#\" class=\"link text-semibold "
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"isSpam") : depth0),{"name":"if","hash":{},"fn":container.program(7, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":26,"column":38},"end":{"line":26,"column":66}}})) != null ? stack1 : "")
    + "\" data-action=\"mark-spam\" data-role=\"spam-alert\">\n<span class=\"spam-hidden\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Discussion isn't spam",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":27,"column":26},"end":{"line":27,"column":61}}}))
    + "</span>\n<span class=\"spam-visible\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Mark discussion as spam",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":28,"column":27},"end":{"line":28,"column":64}}}))
    + "</span>\n</a>\n</li>\n<li>\n<a href=\"https://"
    + alias2(alias3(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"channel") : depth0)) != null ? lookupProperty(stack1,"primaryForum") : stack1)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + ".disqus.com/admin/moderate/approved/search/thread:"
    + alias2(alias3(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + "\" data-action=\"moderate-thread\" class=\"link text-semibold\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Moderate comments",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":32,"column":166},"end":{"line":32,"column":197}}}))
    + "</a>\n</li>\n</ul>\n</div>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"isClosed") : stack1),{"name":"if","hash":{},"fn":container.program(9, data, 0),"inverse":container.program(11, data, 0),"data":data,"loc":{"start":{"line":36,"column":0},"end":{"line":46,"column":7}}})) != null ? stack1 : "")
    + "<a href=\"#\" data-action=\"delete-thread\" class=\"link--moderation link-gray-dark text-medium\">\n<span class=\"icon icon-trash\"></span>\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Delete",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":49,"column":0},"end":{"line":49,"column":20}}}))
    + "\n</a>\n</div>\n";
},"2":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<li>\n<a href=\"#\" class=\"link text-semibold\" data-action=\"blacklist-global\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"author") : stack1)) != null ? lookupProperty(stack1,"isOnGlobalBlacklist") : stack1),{"name":"if","hash":{},"fn":container.program(3, data, 0),"inverse":container.program(5, data, 0),"data":data,"loc":{"start":{"line":17,"column":0},"end":{"line":21,"column":7}}})) != null ? stack1 : "")
    + "</a>\n</li>\n";
},"3":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Remove ban on %(author)s across %(Disqus)s",{"name":"gettext","hash":{"Disqus":"Disqus","author":((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"author") : stack1)) != null ? lookupProperty(stack1,"name") : stack1)},"data":data,"loc":{"start":{"line":18,"column":0},"end":{"line":18,"column":102}}}))
    + "\n";
},"5":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Ban %(author)s across %(Disqus)s",{"name":"gettext","hash":{"Disqus":"Disqus","author":((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"author") : stack1)) != null ? lookupProperty(stack1,"name") : stack1)},"data":data,"loc":{"start":{"line":20,"column":0},"end":{"line":20,"column":92}}}))
    + "\n";
},"7":function(container,depth0,helpers,partials,data) {
    return "is-spam";
},"9":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\"#\" data-action=\"open-thread\" class=\"link--moderation link-gray-dark text-medium\">\n<span class=\"icon icon-open\"></span>\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Open Thread",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":39,"column":0},"end":{"line":39,"column":25}}}))
    + "\n</a>\n";
},"11":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\"#\" data-action=\"close-thread\" class=\"link--moderation link-gray-dark text-medium\">\n<span class=\"icon icon-close\"></span>\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Close Thread",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":44,"column":0},"end":{"line":44,"column":26}}}))
    + "\n</a>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"canModerate") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":1,"column":0},"end":{"line":52,"column":7}}})) != null ? stack1 : "");
},"useData":true}));

Handlebars.registerPartial("forumAvatar", Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<img class=\"forum-favicon\" src=\""
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"faviconImage") : depth0), depth0))
    + "\" alt=\""
    + ((stack1 = container.invokePartial(lookupProperty(partials,"forumName"),depth0,{"name":"forumName","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "\">\n";
},"usePartial":true,"useData":true}));

Handlebars.registerPartial("forumAvatarLink", Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\"/home/forum/"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"id") : depth0), depth0))
    + "/\"\nclass=\"avatar\"\ndata-link-name=\"forum_avatar\"\ndata-forum-pk=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"pk") : depth0), depth0))
    + "\">\n\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"forumAvatar"),depth0,{"name":"forumAvatar","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</a>\n";
},"usePartial":true,"useData":true}));

Handlebars.registerPartial("forumLink", Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\"/home/forum/"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"id") : depth0), depth0))
    + "/\"\nclass=\"link-community\"\ndata-link-name=\"forum_name\"\ndata-forum-pk=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"pk") : depth0), depth0))
    + "\">\n\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"forumName"),depth0,{"name":"forumName","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</a>\n";
},"usePartial":true,"useData":true}));

Handlebars.registerPartial("forumName", Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"name") : depth0), depth0));
},"3":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"id") : depth0), depth0));
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"name") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"data":data,"loc":{"start":{"line":1,"column":0},"end":{"line":1,"column":42}}})) != null ? stack1 : "");
},"useData":true}));

Handlebars.registerPartial("homeFooter", Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<strong>The web’s community of communities</strong>\n<span class=\"bullet\">Disqus &copy; "
    + alias2(lookupProperty(helpers,"now").call(alias1,"YYYY",{"name":"now","hash":{},"data":data,"loc":{"start":{"line":2,"column":35},"end":{"line":2,"column":49}}}))
    + "</span>\n<br />\n<a href=\"/company/\" class=\"link-gray\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Company",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":4,"column":38},"end":{"line":4,"column":59}}}))
    + "</a>\n<span class=\"bullet\"></span>\n<a href=\"/jobs/\" class=\"link-gray\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Jobs",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":6,"column":35},"end":{"line":6,"column":53}}}))
    + "</a>\n<span class=\"bullet\"></span>\n<a href=\"//help.disqus.com/\" class=\"link-gray\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Help",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":8,"column":47},"end":{"line":8,"column":65}}}))
    + "</a>\n<span class=\"bullet\"></span>\n<a href=\"//help.disqus.com/customer/portal/articles/466260-terms-of-service\" class=\"link-gray\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Terms",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":10,"column":95},"end":{"line":10,"column":114}}}))
    + "</a>\n<span class=\"bullet\"></span>\n<a href=\"//help.disqus.com/customer/portal/articles/466259-privacy-policy\" class=\"link-gray\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Privacy",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":12,"column":93},"end":{"line":12,"column":114}}}))
    + "</a>\n<br />\n<a href=\"https://disqus.com/admin/create\" class=\"link-gray\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Add Disqus to your site",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":14,"column":60},"end":{"line":14,"column":97}}}))
    + "</a>\n";
},"useData":true}));

Handlebars.registerPartial("homeRules", Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<p class=\"spacing-bottom\">The following are not allowed on Disqus:</p>\n\n<ol class=\"list-num spacing-bottom\">\n<li>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Targeted harassment or encouraging others to do so",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":4,"column":4},"end":{"line":4,"column":68}}}))
    + "</li>\n<li>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Spam",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":5,"column":4},"end":{"line":5,"column":22}}}))
    + "</li>\n<li>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Impersonation",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":6,"column":4},"end":{"line":6,"column":31}}}))
    + "</li>\n<li>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Direct threat of harm",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":7,"column":4},"end":{"line":7,"column":39}}}))
    + "</li>\n<li>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Posting personally identifiable information",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":8,"column":4},"end":{"line":8,"column":61}}}))
    + "</li>\n<li>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Inappropriate profile content",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":9,"column":4},"end":{"line":9,"column":47}}}))
    + "</li>\n</ol>\n\n<p><strong>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Targeted harassment or encouraging others to do so",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":12,"column":11},"end":{"line":12,"column":75}}}))
    + "</strong></p>\n<p class=\"spacing-bottom\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"The targeted and systematic harassment of people has no place on Disqus, nor do we tolerate communities dedicated to fostering harassing behavior.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":13,"column":26},"end":{"line":13,"column":186}}}))
    + "</p>\n\n<p><strong>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Spam",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":15,"column":11},"end":{"line":15,"column":29}}}))
    + "</strong></p>\n<p class=\"spacing-bottom\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Examples include 1) comments posted in large quantities to promote a product or service, 2) the exact same comment posted repeatedly to disrupt a thread. 3) following users multiple times",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":16,"column":26},"end":{"line":16,"column":227}}}))
    + "</p>\n\n<p><strong>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Impersonation",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":18,"column":11},"end":{"line":18,"column":38}}}))
    + "</strong></p>\n<p class=\"spacing-bottom\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"You may not impersonate others in a manner that does or is intended to mislead, confuse, or deceive others.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":19,"column":26},"end":{"line":19,"column":147}}}))
    + "</p>\n\n<p><strong>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Direct threat of harm",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":21,"column":11},"end":{"line":21,"column":46}}}))
    + "</strong></p>\n<p class=\"spacing-bottom\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"This covers active threats of harm directed towards a specific person or defined group of individuals. Contact local authorities if you feel a crime has been committed or is imminent.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":22,"column":26},"end":{"line":22,"column":223}}}))
    + "</p>\n\n<p><strong>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Posting personally identifiable information",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":24,"column":11},"end":{"line":24,"column":68}}}))
    + "</strong></p>\n<p class=\"spacing-bottom\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Examples of protected information: credit card number, home/work address, phone number, email address, social security number. Real name isn't currently covered.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":25,"column":26},"end":{"line":25,"column":201}}}))
    + "</p>\n\n<p><strong>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Inappropriate profile content",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":27,"column":11},"end":{"line":27,"column":54}}}))
    + "</strong></p>\n<p class=\"spacing-bottom\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Graphic media containing violence and pornographic content are not allowed. Profile content allowed by Disqus may not be allowed on all communitie, so report such profiles to the site moderator.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":28,"column":26},"end":{"line":28,"column":234}}}))
    + "</p>\n\n<p class=\"spacing-bottom\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Read the %(basicRules)s.",{"name":"gettext","hash":{"basicRules":lookupProperty(helpers,"tag").call(alias1,"a",{"name":"tag","hash":{"text":"Basic Rules","href":"https://help.disqus.com/customer/en/portal/articles/1753105"},"data":data,"loc":{"start":{"line":31,"column":13},"end":{"line":31,"column":108}}})},"data":data,"loc":{"start":{"line":30,"column":26},"end":{"line":31,"column":110}}}))
    + "</p>\n";
},"useData":true}));

Handlebars.registerPartial("navLogo", Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var alias1=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<img class=\"site-nav__logo\"\nsrc=\""
    + alias1(lookupProperty(helpers,"urlfor").call(depth0 != null ? depth0 : (container.nullContext || {}),"cdn",{"name":"urlfor","hash":{},"data":data,"loc":{"start":{"line":4,"column":5},"end":{"line":4,"column":21}}}))
    + "/img/disqus-logo-dev.svg\"\nalt=\"Disqus\" />\n<div class=\"site-nav__logo__debug\">"
    + alias1(container.lambda((depth0 != null ? lookupProperty(depth0,"customBase") : depth0), depth0))
    + "</div>\n";
},"3":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<img class=\"site-nav__logo\"\nsrc=\""
    + container.escapeExpression(lookupProperty(helpers,"urlfor").call(depth0 != null ? depth0 : (container.nullContext || {}),"cdn",{"name":"urlfor","hash":{},"data":data,"loc":{"start":{"line":9,"column":5},"end":{"line":9,"column":21}}}))
    + "/img/disqus-logo-blue-white.svg\"\nalt=\"Disqus\" />\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\"/\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"customBase") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"data":data,"loc":{"start":{"line":2,"column":0},"end":{"line":11,"column":7}}})) != null ? stack1 : "")
    + "</a>\n";
},"useData":true}));

Handlebars.registerPartial("navUserIcon", Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\"/by/"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"username") : depth0), depth0))
    + "/\" class=\"nav__lnk\" data-page-icon=\"/by/"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"username") : depth0), depth0))
    + "/\">\n<img src=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"avatar") : depth0)) != null ? lookupProperty(stack1,"cache") : stack1), depth0))
    + "\" alt=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"username") : depth0), depth0))
    + "\" class=\"site-nav__avatar\">\n</a>\n";
},"useData":true}));

Handlebars.registerPartial("onboardingBanner", Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Email verified!",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":5,"column":0},"end":{"line":5,"column":29}}}))
    + "\n";
},"3":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"onboard-banner__text-follow\">\n<div class=\"text-larger text-bold\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"onboardingBannerInstructions"),depth0,{"name":"onboardingBannerInstructions","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n<div class=\"spacing-top-narrow\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"canSkip") : depth0),{"name":"if","hash":{},"fn":container.program(4, data, 0),"inverse":container.program(6, data, 0),"data":data,"loc":{"start":{"line":15,"column":0},"end":{"line":19,"column":7}}})) != null ? stack1 : "")
    + "</div>\n</div>\n";
},"4":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(alias1,"There's a channel for anything you're into. Or you can %(skip)s.",{"name":"gettext","hash":{"skip":lookupProperty(helpers,"tag").call(alias1,"a",{"name":"tag","hash":{"text":lookupProperty(helpers,"gettext").call(alias1,"skip",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":16,"column":178},"end":{"line":16,"column":194}}}),"class":"link-inverted text-semibold","data-action":"skip-onboarding","href":"/home/"},"data":data,"loc":{"start":{"line":16,"column":84},"end":{"line":16,"column":195}}})},"data":data,"loc":{"start":{"line":16,"column":0},"end":{"line":16,"column":197}}}))
    + "\n";
},"6":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"There's a channel for anything you're into.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":18,"column":0},"end":{"line":18,"column":57}}}))
    + "\n";
},"8":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"text-larger text-bold\">\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"You're set!",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":24,"column":0},"end":{"line":24,"column":25}}}))
    + "\n</div>\n";
},"10":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"hidden-md\">\n<div class=\"onboard-banner__bubble text-large text-semibold\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,lookupProperty(helpers,"eq").call(alias1,(depth0 != null ? lookupProperty(depth0,"numTotalSteps") : depth0),1,{"name":"eq","hash":{},"data":data,"loc":{"start":{"line":32,"column":6},"end":{"line":32,"column":26}}}),{"name":"if","hash":{},"fn":container.program(11, data, 0),"inverse":container.program(13, data, 0),"data":data,"loc":{"start":{"line":32,"column":0},"end":{"line":36,"column":7}}})) != null ? stack1 : "")
    + "</div>\n<img class=\"onboard-banner__pam\" src=\""
    + container.escapeExpression(lookupProperty(helpers,"urlfor").call(alias1,"cdn",{"name":"urlfor","hash":{},"data":data,"loc":{"start":{"line":38,"column":38},"end":{"line":38,"column":54}}}))
    + "/img/pam.png\" />\n</div>\n";
},"11":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"1 more!",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":33,"column":0},"end":{"line":33,"column":21}}}))
    + "\n";
},"13":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"%(numRemaining)s more!",{"name":"gettext","hash":{"numRemaining":(depth0 != null ? lookupProperty(depth0,"numRemainingSteps") : depth0)},"data":data,"loc":{"start":{"line":35,"column":0},"end":{"line":35,"column":69}}}))
    + "\n";
},"15":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<button data-action=\"finish\" class=\"button button-outline button-large button-padding-wider -border-light\">\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Continue",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":42,"column":0},"end":{"line":42,"column":22}}}))
    + " &raquo;\n</button>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"section-contained-narrow align align--between align--stretch\">\n<div class=\"onboard-banner__body align align--column align--center\">\n<div class=\"onboard-banner__text-welcome text-larger text-bold\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"emailVerified") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":4,"column":0},"end":{"line":6,"column":7}}})) != null ? stack1 : "")
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(alias1,"Welcome to %(Disqus)s, %(name)s!",{"name":"gettext","hash":{"name":((stack1 = (depth0 != null ? lookupProperty(depth0,"sessionUser") : depth0)) != null ? lookupProperty(stack1,"name") : stack1),"Disqus":"Disqus"},"data":data,"loc":{"start":{"line":7,"column":0},"end":{"line":7,"column":88}}}))
    + "\n</div>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"numRemainingSteps") : depth0),{"name":"if","hash":{},"fn":container.program(3, data, 0),"inverse":container.program(8, data, 0),"data":data,"loc":{"start":{"line":9,"column":0},"end":{"line":26,"column":7}}})) != null ? stack1 : "")
    + "</div>\n<div class=\"onboard-banner__media align align--column align--center relative__wrapper\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"numRemainingSteps") : depth0),{"name":"if","hash":{},"fn":container.program(10, data, 0),"inverse":container.program(15, data, 0),"data":data,"loc":{"start":{"line":29,"column":0},"end":{"line":44,"column":7}}})) != null ? stack1 : "")
    + "</div>\n</div>\n";
},"usePartial":true,"useData":true}));

Handlebars.registerPartial("onboardingBannerInstructions", Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Follow 1 channel to get started",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":2,"column":0},"end":{"line":2,"column":45}}}))
    + "\n";
},"3":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Follow %(numTotal)s channels to get started",{"name":"gettext","hash":{"numTotal":(depth0 != null ? lookupProperty(depth0,"numTotalSteps") : depth0)},"data":data,"loc":{"start":{"line":4,"column":0},"end":{"line":4,"column":82}}}))
    + "\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(alias1,lookupProperty(helpers,"eq").call(alias1,(depth0 != null ? lookupProperty(depth0,"numTotalSteps") : depth0),1,{"name":"eq","hash":{},"data":data,"loc":{"start":{"line":1,"column":6},"end":{"line":1,"column":26}}}),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"data":data,"loc":{"start":{"line":1,"column":0},"end":{"line":5,"column":7}}})) != null ? stack1 : "");
},"useData":true}));

Handlebars.registerPartial("profileCardReason", Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(alias1,"Discussion on %(forum)s",{"name":"gettext","hash":{"forum":lookupProperty(helpers,"getPartial").call(alias1,"channelLink",((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1)) != null ? lookupProperty(stack1,"channelInfo") : stack1),{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":3,"column":44},"end":{"line":3,"column":95}}})},"data":data,"loc":{"start":{"line":3,"column":0},"end":{"line":3,"column":97}}}))
    + "\n";
},"3":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(alias1,"Discussion on %(forum)s",{"name":"gettext","hash":{"forum":lookupProperty(helpers,"getPartial").call(alias1,"forumLink",((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1),{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":5,"column":44},"end":{"line":5,"column":81}}})},"data":data,"loc":{"start":{"line":5,"column":0},"end":{"line":5,"column":83}}}))
    + "\n";
},"5":function(container,depth0,helpers,partials,data) {
    return "<span class=\"icon-lock icon-tiny spacing-right-small text-gray\"></span>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.lambda, alias3=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card-reason\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1)) != null ? lookupProperty(stack1,"channelInfo") : stack1),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"data":data,"loc":{"start":{"line":2,"column":0},"end":{"line":6,"column":7}}})) != null ? stack1 : "")
    + "<a href=\""
    + alias3(alias2((depth0 != null ? lookupProperty(depth0,"discussionRoute") : depth0), depth0))
    + "\"\nclass=\"bullet link-discussion\"\ndata-link-name=\"comment_count\"\ndata-thread-id=\""
    + alias3(alias2(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + "\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"isClosed") : stack1),{"name":"if","hash":{},"fn":container.program(5, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":11,"column":0},"end":{"line":13,"column":7}}})) != null ? stack1 : "")
    + "\n"
    + ((stack1 = alias2(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"posts") : stack1), depth0)) != null ? stack1 : "")
    + " comments\n</a>\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"badges"),depth0,{"name":"badges","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n";
},"usePartial":true,"useData":true}));

Handlebars.registerPartial("profileCoverAttributes", Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\"#\" class=\"profile-cover-allstar\" data-action=\"show-allstar-modal\">\n<span class=\"allstar__label\">\n<span class=\"icon-star allstar__icon -inverted icon__position -inline icon-small\"></span>"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"All-Star",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":7,"column":89},"end":{"line":7,"column":111}}}))
    + "\n</span>\n</a>\n";
},"3":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"profile-user-info\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"about") : depth0),{"name":"if","hash":{},"fn":container.program(4, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":13,"column":0},"end":{"line":19,"column":7}}})) != null ? stack1 : "")
    + "<ul class=\"profile-cover-list\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"numLikesReceived") : depth0),{"name":"if","hash":{},"fn":container.program(6, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":21,"column":0},"end":{"line":26,"column":7}}})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"location") : depth0),{"name":"if","hash":{},"fn":container.program(8, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":27,"column":0},"end":{"line":32,"column":7}}})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"url") : depth0),{"name":"if","hash":{},"fn":container.program(10, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":33,"column":0},"end":{"line":38,"column":7}}})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"joinDate") : depth0),{"name":"if","hash":{},"fn":container.program(12, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":39,"column":0},"end":{"line":44,"column":7}}})) != null ? stack1 : "")
    + "</ul>\n</div>\n";
},"4":function(container,depth0,helpers,partials,data) {
    var alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"text-medium profile-cover-about\">\n<div class=\"truncate\" data-truncate-lines=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"numLines") : depth0), depth0))
    + "\">\n"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"about") : depth0), depth0))
    + "\n</div>\n</div>\n";
},"6":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<li class=\"truncate-line text-small\">\n<span class=\"icon-arrow-up text-smaller icon__position -inline\"></span>\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(alias1,"%(upvoteCount)s Upvotes",{"name":"gettext","hash":{"upvoteCount":lookupProperty(helpers,"tag").call(alias1,"strong",{"name":"tag","hash":{"text":(depth0 != null ? lookupProperty(depth0,"numLikesReceived") : depth0)},"data":data,"loc":{"start":{"line":24,"column":50},"end":{"line":24,"column":86}}})},"data":data,"loc":{"start":{"line":24,"column":0},"end":{"line":24,"column":88}}}))
    + "\n</li>\n";
},"8":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<li class=\"truncate-line text-small hidden-cover\">\n<span class=\"icon-location text-smaller icon__position -inline\"></span>\n"
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"location") : depth0), depth0))
    + "\n</li>\n";
},"10":function(container,depth0,helpers,partials,data) {
    var alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<li class=\"truncate-line text-small\">\n<span class=\"icon-link text-smaller icon__position -inline\"></span>\n<a href=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"url") : depth0), depth0))
    + "\" data-link-out=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"signedUrl") : depth0), depth0))
    + "\" target=\"_blank\" rel=\"noreferrer nofollow noopener\">"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"url") : depth0), depth0))
    + "</a>\n</li>\n";
},"12":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<li class=\"truncate-line text-small\">\n<span class=\"icon-clock text-smaller icon__position -inline\"></span>\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Joined %(joinedAt)s",{"name":"gettext","hash":{"joinedAt":(depth0 != null ? lookupProperty(depth0,"joinDate") : depth0)},"data":data,"loc":{"start":{"line":42,"column":0},"end":{"line":42,"column":53}}}))
    + "\n</li>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<p class=\"text-large text-gray profile-cover-username\">\n@"
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"username") : depth0), depth0))
    + "\n</p>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"isPowerContributor") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":4,"column":0},"end":{"line":10,"column":7}}})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"isBlocked") : depth0),{"name":"unless","hash":{},"fn":container.program(3, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":11,"column":0},"end":{"line":47,"column":11}}})) != null ? stack1 : "");
},"useData":true}));

Handlebars.registerPartial("profileCoverDropdown", Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<li>\n<a href=\"#\" class=\"dropdown__link\" disabled>\n<div class=\"dropdown-cover-profile__title\">\n<span class=\"text-medium icon-flag media-middle\"></span>\n<strong>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Report User",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":22,"column":8},"end":{"line":22,"column":33}}}))
    + "</strong>\n</div>\n<p class=\"spacing-narrow\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"You have reported this person to Disqus. We will take action against their account if they have violated our policies. Furthermore, you can block this person to stop seeing their comments.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":25,"column":0},"end":{"line":25,"column":202}}}))
    + "\n</p>\n</a>\n</li>\n";
},"3":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<li>\n<a href=\"#\" data-action=\"prompt-report-user\" class=\"dropdown__link\">\n<div class=\"dropdown-cover-profile__title\">\n<span class=\"text-medium icon-flag media-middle\"></span>\n<strong>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Report User",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":34,"column":8},"end":{"line":34,"column":33}}}))
    + "</strong>\n</div>\n<p class=\"spacing-narrow\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Report this user to Disqus for review. If they've been found to violate our policies their account will be removed.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":37,"column":0},"end":{"line":37,"column":129}}}))
    + "\n</p>\n</a>\n</li>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<span class=\"dropdown\">\n<button class=\"button dropdown-toggle text-medium icon__rotate--right\" data-toggle=\"dropdown\">\n<span class=\"icon icon-show-more\"></span>\n</button>\n<ul class=\"dropdown-menu dropdown-cover-profile\">\n<li>\n<a href=\"#\" data-action=\"block-user\" class=\"dropdown__link border-bottom\">\n<div class=\"dropdown-cover-profile__title\">\n<span class=\"icon-small icon-cancel media-middle spacing-right-small\"></span>\n<strong>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Block User",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":10,"column":8},"end":{"line":10,"column":32}}}))
    + "</strong>\n</div>\n<p class=\"spacing-narrow\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Never see this user again. None of their activity and comments will appear in any of your Disqus content, feeds, or notifications.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":13,"column":0},"end":{"line":13,"column":144}}}))
    + "\n</p>\n</a>\n</li>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"isFlagged") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"data":data,"loc":{"start":{"line":17,"column":0},"end":{"line":41,"column":7}}})) != null ? stack1 : "")
    + "</ul>\n</span>\n";
},"useData":true}));

Handlebars.registerPartial("replyOrEditLink", Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"isWithinEditPeriod") : depth0),{"name":"if","hash":{},"fn":container.program(2, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":2,"column":0},"end":{"line":11,"column":7}}})) != null ? stack1 : "");
},"2":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"discussionRoute") : depth0), depth0))
    + "#edit-"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"id") : depth0), depth0))
    + "\"\nclass=\"edit link-gray\"\ndata-link-name=\"edit\"\ndata-thread-id=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + "\"\ndata-action=\"edit\">\n\n"
    + alias2(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Edit",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":9,"column":0},"end":{"line":9,"column":18}}}))
    + "\n</a>\n";
},"4":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"isLoggedIn") : depth0),{"name":"if","hash":{},"fn":container.program(5, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":13,"column":0},"end":{"line":29,"column":7}}})) != null ? stack1 : "");
},"5":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"isClosed") : stack1),{"name":"if","hash":{},"fn":container.program(6, data, 0),"inverse":container.program(8, data, 0),"data":data,"loc":{"start":{"line":14,"column":0},"end":{"line":28,"column":7}}})) != null ? stack1 : "");
},"6":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a class=\"reply-disabled link-gray\">\n<span class=\"icon icon-lock icon-tiny spacing-right-small text-gray\"></span>\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Reply",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":17,"column":0},"end":{"line":17,"column":19}}}))
    + "\n</a>\n";
},"8":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"discussionRoute") : depth0), depth0))
    + "#reply-"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"id") : depth0), depth0))
    + "\"\ndata-action=\"reply\"\nclass=\"reply link-gray\"\ndata-link-name=\"reply\"\ndata-thread-id=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + "\">\n\n"
    + alias2(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Reply",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":26,"column":0},"end":{"line":26,"column":19}}}))
    + "\n</a>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"wasAuthoredBySessionUser") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(4, data, 0),"data":data,"loc":{"start":{"line":1,"column":0},"end":{"line":30,"column":7}}})) != null ? stack1 : "");
},"useData":true}));

Handlebars.registerPartial("settingsAccountSocialLink", Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(alias1,"Connected as %(displayName)s",{"name":"gettext","hash":{"displayName":lookupProperty(helpers,"tag").call(alias1,"a",{"name":"tag","hash":{"text":(depth0 != null ? lookupProperty(depth0,"display_name") : depth0),"target":"_blank","href":(depth0 != null ? lookupProperty(depth0,"url") : depth0)},"data":data,"loc":{"start":{"line":3,"column":14},"end":{"line":3,"column":71}}})},"data":data,"loc":{"start":{"line":2,"column":0},"end":{"line":4,"column":2}}}))
    + "\n";
},"3":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Connected as %(displayName)s",{"name":"gettext","hash":{"displayName":(depth0 != null ? lookupProperty(depth0,"display_name") : depth0)},"data":data,"loc":{"start":{"line":6,"column":0},"end":{"line":8,"column":2}}}))
    + "\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"url") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"data":data,"loc":{"start":{"line":1,"column":0},"end":{"line":9,"column":7}}})) != null ? stack1 : "");
},"useData":true}));

Handlebars.registerPartial("spamActions", Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"authorPendingSpamReview") : depth0),{"name":"if","hash":{},"fn":container.program(2, data, 0),"inverse":container.program(4, data, 0),"data":data,"loc":{"start":{"line":3,"column":0},"end":{"line":9,"column":7}}})) != null ? stack1 : "");
},"2":function(container,depth0,helpers,partials,data) {
    return "<span class=\"text-small text-semibold\">Thanks, we'll work on getting this corrected.</span>\n";
},"4":function(container,depth0,helpers,partials,data) {
    return "<a href=\"#\" class=\"text-small text-semibold spacing-left-small\" data-action=\"request-spam-review\">This isn't spam &raquo;</a>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<spam data-role=\"spam-actions\">\n"
    + ((stack1 = lookupProperty(helpers,"if_all").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"isAuthor") : depth0),(depth0 != null ? lookupProperty(depth0,"isSpam") : depth0),{"name":"if_all","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":2,"column":0},"end":{"line":10,"column":11}}})) != null ? stack1 : "")
    + "</spam>\n";
},"useData":true}));

Handlebars.registerPartial("strongTag", Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    return "<strong>"
    + container.escapeExpression(container.lambda(depth0, depth0))
    + "</strong>";
},"useData":true}));

Handlebars.registerPartial("threadImage", Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"link") : stack1), depth0))
    + "\"\nclass=\"discussion-image\"\ndata-link-name=\"image\"\ndata-link-out=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"signedLink") : stack1), depth0))
    + "\"\ndata-thread-id=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + "\">\n\n<img src=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"image") : depth0)) != null ? lookupProperty(stack1,"src") : stack1), depth0))
    + "\" alt=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"image") : depth0)) != null ? lookupProperty(stack1,"title") : stack1), depth0))
    + "\">\n</a>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"image") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":1,"column":0},"end":{"line":10,"column":7}}})) != null ? stack1 : "");
},"useData":true}));

Handlebars.registerPartial("threadLink", Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"signedLink") : stack1), depth0))
    + "\"\nclass=\"name-thread\"\ndata-role=\"article-link\"\ndata-link-out=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"signedLink") : stack1), depth0))
    + "\"\ndata-link-name=\"title\"\ndata-thread-id=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + "\">\n\n"
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"clean_title") : stack1), depth0))
    + "\n</a>\n";
},"useData":true}));

Handlebars.registerPartial("threadPostActivity", Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, alias3=container.lambda, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"discussion-activity align align--between\">\n<div data-role=\"thread-actions\"></div>\n<div class=\"discussion-activity__nav\">\n<a href=\"#\" class=\"dropdown-toggle visible-md text-medium text-semibold link-gray\" data-toggle=\"dropdown\">\n<span data-action=\"switch-tab\" data-tab=\"best\" role=\"menuitem\" class=\"dropdown-toggle__selection\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Sort by Best",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":6,"column":0},"end":{"line":6,"column":26}}}))
    + "\n</span>\n<span data-action=\"switch-tab\" data-tab=\"newest\" role=\"menuitem\" class=\"dropdown-toggle__selection\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Sort by Newest",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":9,"column":0},"end":{"line":9,"column":28}}}))
    + "\n</span>\n<span data-action=\"switch-tab\" data-tab=\"oldest\" role=\"menuitem\" class=\"dropdown-toggle__selection\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Sort by Oldest",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":12,"column":0},"end":{"line":12,"column":28}}}))
    + "\n</span>\n<span class=\"icon-arrow icon__position -caret\"></span>\n</a>\n<ul class=\"nav--discussion\">\n<li data-action=\"switch-tab\" data-tab=\"best\" class=\"nav__item\" role=\"menuitem\">\n<a href=\""
    + alias2(alias3((depth0 != null ? lookupProperty(depth0,"discussionRoute") : depth0), depth0))
    + "best/\" class=\"nav-lnk -color-muted\">\n<div class=\"nav-lnk__blk\">\n<span class=\"button__text\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Best",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":20,"column":27},"end":{"line":20,"column":45}}}))
    + "</span>\n</div>\n<div class=\"nav-lnk__checkmark\">\n<span class=\"icon icon-checkmark icon__position text-smaller\"></span>\n</div>\n</a>\n</li>\n<li data-action=\"switch-tab\" data-tab=\"newest\" class=\"nav__item\" role=\"menuitem\">\n<a href=\""
    + alias2(alias3((depth0 != null ? lookupProperty(depth0,"discussionRoute") : depth0), depth0))
    + "newest/\" class=\"nav-lnk -color-muted\">\n<div class=\"nav-lnk__blk\">\n<span class=\"button__text\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Newest",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":30,"column":27},"end":{"line":30,"column":47}}}))
    + "</span>\n</div>\n<div class=\"nav-lnk__checkmark\">\n<span class=\"icon icon-checkmark icon__position text-smaller\"></span>\n</div>\n</a>\n</li>\n<li data-action=\"switch-tab\" data-tab=\"oldest\" class=\"nav__item\" role=\"menuitem\">\n<a href=\""
    + alias2(alias3((depth0 != null ? lookupProperty(depth0,"discussionRoute") : depth0), depth0))
    + "oldest/\" class=\"nav-lnk -color-muted\">\n<div class=\"nav-lnk__blk\">\n<span class=\"button__text\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Oldest",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":40,"column":27},"end":{"line":40,"column":47}}}))
    + "</span>\n</div>\n<div class=\"nav-lnk__checkmark\">\n<span class=\"icon icon-checkmark icon__position text-smaller\"></span>\n</div>\n</a>\n</li>\n</ul>\n</div>\n</div>\n";
},"useData":true}));

Handlebars.registerPartial("threadTitle", Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(container.lambda(((stack1 = (depth0 != null ? lookupProperty(depth0,"threadOverrides") : depth0)) != null ? lookupProperty(stack1,"title") : stack1), depth0))
    + "\n";
},"3":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(container.lambda(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"clean_title") : stack1), depth0))
    + "\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<h2 class=\"discussion-title\" dir=\"auto\">\n<a href=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"link") : stack1), depth0))
    + "\"\nclass=\"link-gray-darker truncate\"\ndata-truncate-lines=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"numTitleLines") : depth0), depth0))
    + "\"\ndata-role=\"thread-link\"\ndata-link-out=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"signedLink") : stack1), depth0))
    + "\"\ndata-link-name=\"title\"\ndata-thread-id=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + "\">\n\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = (depth0 != null ? lookupProperty(depth0,"threadOverrides") : depth0)) != null ? lookupProperty(stack1,"title") : stack1),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"data":data,"loc":{"start":{"line":10,"column":0},"end":{"line":15,"column":7}}})) != null ? stack1 : "")
    + "</a>\n</h2>\n";
},"useData":true}));

Handlebars.registerPartial("timeSelector", Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<select name=\"time\">\n<option></option>\n<option value=\"3600\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"1 hour",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":3,"column":21},"end":{"line":3,"column":41}}}))
    + "</option>\n<option value=\"10800\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"3 hours",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":4,"column":22},"end":{"line":4,"column":43}}}))
    + "</option>\n<option value=\"21600\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"6 hours",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":5,"column":22},"end":{"line":5,"column":43}}}))
    + "</option>\n<option value=\"43200\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"12 hours",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":6,"column":22},"end":{"line":6,"column":44}}}))
    + "</option>\n<option value=\"86400\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"1 day",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":7,"column":22},"end":{"line":7,"column":41}}}))
    + "</option>\n<option value=\"259200\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"3 days",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":8,"column":23},"end":{"line":8,"column":43}}}))
    + "</option>\n<option value=\"432000\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"5 days",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":9,"column":23},"end":{"line":9,"column":43}}}))
    + "</option>\n<option value=\"604800\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"1 week",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":10,"column":23},"end":{"line":10,"column":43}}}))
    + "</option>\n<option value=\"1209600\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"2 weeks",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":11,"column":24},"end":{"line":11,"column":45}}}))
    + "</option>\n</select>\n";
},"useData":true}));

Handlebars.registerPartial("topicTag", Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"topicRoute") : depth0), depth0));
},"3":function(container,depth0,helpers,partials,data) {
    return "#";
},"5":function(container,depth0,helpers,partials,data) {
    return "data-action=\"remove-tag\"";
},"7":function(container,depth0,helpers,partials,data) {
    return "<span class=\"icon icon-cancel\"></span>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\""
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"topicRoute") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"data":data,"loc":{"start":{"line":1,"column":9},"end":{"line":1,"column":57}}})) != null ? stack1 : "")
    + "\" "
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"topicRoute") : depth0),{"name":"unless","hash":{},"fn":container.program(5, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":1,"column":59},"end":{"line":1,"column":116}}})) != null ? stack1 : "")
    + "\nclass=\"button--tag\">\n"
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"displayName") : depth0), depth0))
    + "\n"
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"topicRoute") : depth0),{"name":"unless","hash":{},"fn":container.program(7, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":4,"column":0},"end":{"line":6,"column":11}}})) != null ? stack1 : "")
    + "</a>\n";
},"useData":true}));

Handlebars.registerPartial("userAvatar", Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\"/by/"
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"username") : depth0), depth0))
    + "/\" class=\"avatar\" data-link-name=\"user_avatar\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"userAvatarNoLink"),depth0,{"name":"userAvatarNoLink","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</a>\n";
},"3":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<span class=\"avatar\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"userAvatarNoLink"),depth0,{"name":"userAvatarNoLink","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</span>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"username") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"data":data,"loc":{"start":{"line":1,"column":0},"end":{"line":9,"column":7}}})) != null ? stack1 : "");
},"usePartial":true,"useData":true}));

Handlebars.registerPartial("userAvatarNoLink", Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<img src=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"avatar") : depth0)) != null ? lookupProperty(stack1,"cache") : stack1), depth0))
    + "\" alt=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"displayName") : depth0), depth0))
    + "\">\n";
},"useData":true}));

Handlebars.registerPartial("userCardBody", Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<p class=\"description truncate-line text-medium\">"
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"about") : depth0), depth0))
    + "</p>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = container.invokePartial(lookupProperty(partials,"userAvatar"),depth0,{"name":"userAvatar","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "<div class=\"user-info\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"userName"),depth0,{"name":"userName","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"about") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":4,"column":0},"end":{"line":6,"column":7}}})) != null ? stack1 : "")
    + "</div>\n";
},"usePartial":true,"useData":true}));

Handlebars.registerPartial("userFollowButton", Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"isPrivate") : depth0),{"name":"if","hash":{},"fn":container.program(2, data, 0),"inverse":container.program(4, data, 0),"data":data,"loc":{"start":{"line":3,"column":0},"end":{"line":11,"column":7}}})) != null ? stack1 : "");
},"2":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<button class=\"button button-disabled button-small\" disabled>\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Private",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":5,"column":0},"end":{"line":5,"column":21}}}))
    + "<span class=\"icon-lock icon-small spacing-left-small\"></span>\n</button>\n";
},"4":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<span class=\"btn-follow--mobile\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"genericFollowButton"),depth0,{"name":"genericFollowButton","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</span>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"unless").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"isSessionUser") : depth0),{"name":"unless","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":1,"column":0},"end":{"line":12,"column":11}}})) != null ? stack1 : "");
},"usePartial":true,"useData":true}));

Handlebars.registerPartial("userGroup", Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<span class=\"actor\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"userPreview"),depth0,{"name":"userPreview","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</span>\n";
},"3":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\"#\" class=\"actor name link-gray-darker\" data-role=\"actors\">\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"%(numUsers)s others",{"name":"gettext","hash":{"numUsers":(depth0 != null ? lookupProperty(depth0,"numRemainingActors") : depth0)},"data":data,"loc":{"start":{"line":14,"column":0},"end":{"line":14,"column":63}}}))
    + "\n</a>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<span class=\"actors\">\n"
    + ((stack1 = lookupProperty(helpers,"each").call(alias1,(depth0 != null ? lookupProperty(depth0,"shownActors") : depth0),{"name":"each","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":2,"column":0},"end":{"line":6,"column":9}}})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"numRemainingActors") : depth0),{"name":"if","hash":{},"fn":container.program(3, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":7,"column":0},"end":{"line":16,"column":7}}})) != null ? stack1 : "")
    + "</span>\n";
},"usePartial":true,"useData":true}));

Handlebars.registerPartial("userGroupNames", Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<span class=\"actor-group\" data-role=\"actors\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,lookupProperty(helpers,"gt").call(alias1,(depth0 != null ? lookupProperty(depth0,"numRemainingActors") : depth0),1,{"name":"gt","hash":{},"data":data,"loc":{"start":{"line":7,"column":6},"end":{"line":7,"column":31}}}),{"name":"if","hash":{},"fn":container.program(2, data, 0),"inverse":container.program(4, data, 0),"data":data,"loc":{"start":{"line":7,"column":0},"end":{"line":11,"column":7}}})) != null ? stack1 : "")
    + "</span>\n";
},"2":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"%(numUsers)s others",{"name":"gettext","hash":{"numUsers":(depth0 != null ? lookupProperty(depth0,"numRemainingActors") : depth0)},"data":data,"loc":{"start":{"line":8,"column":0},"end":{"line":8,"column":63}}}))
    + "\n";
},"4":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"1 other",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":10,"column":0},"end":{"line":10,"column":21}}}))
    + "\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<span class=\"actors\">\n<span class=\"actor\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"userName"),(depth0 != null ? lookupProperty(depth0,"firstActor") : depth0),{"name":"userName","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</span>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,lookupProperty(helpers,"gt").call(alias1,(depth0 != null ? lookupProperty(depth0,"numRemainingActors") : depth0),0,{"name":"gt","hash":{},"data":data,"loc":{"start":{"line":5,"column":6},"end":{"line":5,"column":31}}}),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":5,"column":0},"end":{"line":13,"column":7}}})) != null ? stack1 : "")
    + "</span>\n";
},"usePartial":true,"useData":true}));

Handlebars.registerPartial("userName", Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\"#\"\nclass=\"tooltipped icon__position -inline -allstar\"\ndata-action=\"show-allstar-modal\"\ndata-toggle=\"tooltip\"\ndata-placement=\"top\"\ntitle=\""
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"All-Star",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":8,"column":7},"end":{"line":8,"column":29}}}))
    + "\"><span class=\"icon-allstar allstar__icon\"></span></a>";
},"3":function(container,depth0,helpers,partials,data) {
    var alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\"/by/"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"username") : depth0), depth0))
    + "/\" class=\"name\" data-link-name=\"user_name\">"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"name") : depth0), depth0))
    + "</a>\n";
},"5":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"name") : depth0),{"name":"if","hash":{},"fn":container.program(6, data, 0),"inverse":container.program(8, data, 0),"data":data,"loc":{"start":{"line":13,"column":0},"end":{"line":17,"column":7}}})) != null ? stack1 : "");
},"6":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"name") : depth0), depth0))
    + "\n";
},"8":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Guest",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":16,"column":0},"end":{"line":16,"column":19}}}))
    + "\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"isPowerContributor") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":2,"column":0},"end":{"line":9,"column":9}}})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"username") : depth0),{"name":"if","hash":{},"fn":container.program(3, data, 0),"inverse":container.program(5, data, 0),"data":data,"loc":{"start":{"line":10,"column":0},"end":{"line":18,"column":7}}})) != null ? stack1 : "");
},"useData":true}));

Handlebars.registerPartial("userNameNoLink", Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"name") : depth0), depth0))
    + "\n";
},"3":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"username") : depth0),{"name":"if","hash":{},"fn":container.program(4, data, 0),"inverse":container.program(6, data, 0),"data":data,"loc":{"start":{"line":4,"column":0},"end":{"line":8,"column":7}}})) != null ? stack1 : "");
},"4":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"username") : depth0), depth0))
    + "\n";
},"6":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Guest",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":7,"column":0},"end":{"line":7,"column":19}}}))
    + "\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"name") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"data":data,"loc":{"start":{"line":1,"column":0},"end":{"line":9,"column":7}}})) != null ? stack1 : "");
},"useData":true}));

Handlebars.registerPartial("userPreview", Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = container.invokePartial(lookupProperty(partials,"userAvatar"),depth0,{"name":"userAvatar","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + ((stack1 = container.invokePartial(lookupProperty(partials,"userName"),depth0,{"name":"userName","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "\n";
},"usePartial":true,"useData":true}));

Handlebars.registerPartial("userSpan", Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<span data-username=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"username") : depth0), depth0))
    + "\" data-role=\"username\">"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"name") : depth0), depth0))
    + "</span>\n";
},"useData":true}));

Handlebars.registerPartial("welcomeOverlay", Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"onboard-overlay__inner text-center\">\n<span class=\"onboard-overlay__forum\">"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"forumAvatar"),(depth0 != null ? lookupProperty(depth0,"forum") : depth0),{"name":"forumAvatar","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</span>\n<div class=\"text-larger text-semibold spacing-top\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Welcome to %(Disqus)s from %(Forum)s",{"name":"gettext","hash":{"Forum":lookupProperty(helpers,"getPartial").call(alias1,"forumName",(depth0 != null ? lookupProperty(depth0,"forum") : depth0),{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":4,"column":75},"end":{"line":4,"column":105}}}),"Disqus":"Disqus"},"data":data,"loc":{"start":{"line":4,"column":0},"end":{"line":4,"column":107}}}))
    + "\n</div>\n<div class=\"onboard-overlay__description text-gray-dark spacing-top-narrow spacing-bottom-large\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"%(Disqus)s is more than comments. We're also about great conversations right here on %(disqusDotCom)s",{"name":"gettext","hash":{"disqusDotCom":"disqus.com","Disqus":"Disqus"},"data":data,"loc":{"start":{"line":7,"column":0},"end":{"line":7,"column":161}}}))
    + "\n</div>\n<button class=\"button button-fill--brand button-large\" data-action=\"hide-welcome\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Got it! Let's join the fun",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":10,"column":0},"end":{"line":10,"column":40}}}))
    + "\n</button>\n</div>\n";
},"usePartial":true,"useData":true}));

Handlebars.registerPartial("cardGuestUser", Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.lambda, alias3=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<li class=\"user "
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"highlight") : depth0),{"name":"if","hash":{},"fn":container.program(2, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":2,"column":16},"end":{"line":2,"column":49}}})) != null ? stack1 : "")
    + "\" data-role=\"guest\">\n<span class=\"avatar\" title=\""
    + alias3(alias2((depth0 != null ? lookupProperty(depth0,"guestText") : depth0), depth0))
    + "\">\n<img src=\""
    + alias3(alias2((depth0 != null ? lookupProperty(depth0,"guestAvatarUrl") : depth0), depth0))
    + "\" alt=\""
    + alias3(lookupProperty(helpers,"gettext").call(alias1,"Avatar",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":4,"column":35},"end":{"line":4,"column":55}}}))
    + "\" />\n</span>\n<span class=\"username\" title=\""
    + alias3(alias2((depth0 != null ? lookupProperty(depth0,"guestText") : depth0), depth0))
    + "\">\n"
    + alias3(alias2((depth0 != null ? lookupProperty(depth0,"guestText") : depth0), depth0))
    + "\n</span>\n</li>\n";
},"2":function(container,depth0,helpers,partials,data) {
    return "highlight";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"guestCount") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":1,"column":0},"end":{"line":10,"column":7}}})) != null ? stack1 : "");
},"useData":true}));

Handlebars.registerPartial("cardGuestVoterText", Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return " "
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"%(guestCount)s Guest Votes",{"name":"gettext","hash":{"guestCount":(depth0 != null ? lookupProperty(depth0,"guestCount") : depth0)},"data":data,"loc":{"start":{"line":1,"column":26},"end":{"line":1,"column":90}}}))
    + " ";
},"3":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return " "
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"1 Guest Vote",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":1,"column":100},"end":{"line":1,"column":126}}}))
    + " ";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(alias1,lookupProperty(helpers,"gt").call(alias1,(depth0 != null ? lookupProperty(depth0,"guestCount") : depth0),1,{"name":"gt","hash":{},"data":data,"loc":{"start":{"line":1,"column":6},"end":{"line":1,"column":23}}}),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"data":data,"loc":{"start":{"line":1,"column":0},"end":{"line":1,"column":134}}})) != null ? stack1 : "")
    + "\n";
},"useData":true}));

Handlebars.registerPartial("cardOtherUserText", Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return " "
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"%(guestCount)s Others",{"name":"gettext","hash":{"guestCount":(depth0 != null ? lookupProperty(depth0,"guestCount") : depth0)},"data":data,"loc":{"start":{"line":1,"column":26},"end":{"line":1,"column":85}}}))
    + " ";
},"3":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return " "
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"1 Other",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":1,"column":95},"end":{"line":1,"column":116}}}))
    + " ";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(alias1,lookupProperty(helpers,"gt").call(alias1,(depth0 != null ? lookupProperty(depth0,"guestCount") : depth0),1,{"name":"gt","hash":{},"data":data,"loc":{"start":{"line":1,"column":6},"end":{"line":1,"column":23}}}),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"data":data,"loc":{"start":{"line":1,"column":0},"end":{"line":1,"column":124}}})) != null ? stack1 : "")
    + "\n";
},"useData":true}));

Handlebars.registerPartial("cardUser", Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    return "highlight";
},"3":function(container,depth0,helpers,partials,data) {
    return "data-action=\"profile\"";
},"5":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<span class=\"avatar\">\n<img src=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"avatar") : depth0)) != null ? lookupProperty(stack1,"cache") : stack1), depth0))
    + "\" alt=\""
    + alias2(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Avatar",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":5,"column":33},"end":{"line":5,"column":53}}}))
    + "\" />\n</span>\n<span class=\"username\">\n"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"name") : depth0), depth0))
    + "\n</span>\n";
},"7":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a class=\"avatar\" href=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"profileUrl") : depth0), depth0))
    + "\" title=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"name") : depth0), depth0))
    + "\" target=\"_blank\" rel=\"noopener noreferrer\">\n<img src=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"avatar") : depth0)) != null ? lookupProperty(stack1,"cache") : stack1), depth0))
    + "\" alt=\""
    + alias2(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Avatar",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":12,"column":33},"end":{"line":12,"column":53}}}))
    + "\" />\n</a>\n<a class=\"username\" href=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"profileUrl") : depth0), depth0))
    + "\" title=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"name") : depth0), depth0))
    + "\" target=\"_blank\" rel=\"noopener noreferrer\">\n"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"name") : depth0), depth0))
    + "\n</a>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<li class=\"user "
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"highlight") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":1,"column":16},"end":{"line":1,"column":49}}})) != null ? stack1 : "")
    + "\" "
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,lookupProperty(helpers,"switch").call(alias1,"sso_less_branding",{"name":"switch","hash":{"forum":(depth0 != null ? lookupProperty(depth0,"forumId") : depth0)},"data":data,"loc":{"start":{"line":1,"column":61},"end":{"line":1,"column":103}}}),{"name":"unless","hash":{},"fn":container.program(3, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":1,"column":51},"end":{"line":1,"column":137}}})) != null ? stack1 : "")
    + " data-username=\""
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"username") : depth0), depth0))
    + "\">\n"
    + ((stack1 = lookupProperty(helpers,"if_all").call(alias1,lookupProperty(helpers,"switch").call(alias1,"sso_less_branding",{"name":"switch","hash":{"forum":(depth0 != null ? lookupProperty(depth0,"forumId") : depth0)},"data":data,"loc":{"start":{"line":3,"column":10},"end":{"line":3,"column":52}}}),lookupProperty(helpers,"ne").call(alias1,(depth0 != null ? lookupProperty(depth0,"isSSOProfileUrl") : depth0),true,{"name":"ne","hash":{},"data":data,"loc":{"start":{"line":3,"column":53},"end":{"line":3,"column":78}}}),{"name":"if_all","hash":{},"fn":container.program(5, data, 0),"inverse":container.program(7, data, 0),"data":data,"loc":{"start":{"line":3,"column":0},"end":{"line":17,"column":11}}})) != null ? stack1 : "")
    + "</li>\n";
},"useData":true}));

Handlebars.registerPartial("carouselArrowLeft", Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    return "<button class=\"carousel-control carousel-control__previous\"><span class=\"icon icon-right-bracket icon-flipped\"></span></button>\n";
},"useData":true}));

Handlebars.registerPartial("carouselArrowRight", Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    return "<button class=\"carousel-control carousel-control__next\"><span class=\"icon icon-right-bracket\"></span></button>\n";
},"useData":true}));

Handlebars.registerPartial("channelsHeader", Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"align-inline spacing-top\">\n<div class=\"module-header__icon icon-colorful spacing-right\">\n<svg class=\"icon-discover\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" version=\"1.1\" x=\"0px\" y=\"0px\" viewBox=\"0 0 18 18\" enable-background=\"new 0 0 18 18\" xml:space=\"preserve\" width=\"26\" height=\"26\"><rect x=\"14\" width=\"4\" height=\"4\" class=\"dot\"/><rect x=\"14\" y=\"7\" width=\"4\" height=\"4\" class=\"dot\"/><rect x=\"14\" y=\"14\" width=\"4\" height=\"4\" class=\"dot\"/><rect x=\"7\" width=\"4\" height=\"4\" class=\"dot\"/><rect x=\"7\" y=\"7\" width=\"4\" height=\"4\" class=\"dot\"/><rect x=\"7\" y=\"14\" width=\"4\" height=\"4\" class=\"dot\"/><rect width=\"4\" height=\"4\" class=\"dot\"/><rect y=\"7\" width=\"4\" height=\"4\" class=\"dot\"/><rect y=\"14\" width=\"4\" height=\"4\" class=\"dot\"/></g></svg>\n</div>\n<div class=\"module-header__title\">\n<h1 class=\"text-larger text-darker\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Channels",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":6,"column":36},"end":{"line":6,"column":58}}}))
    + "</h1>\n</div>\n</div>\n<p class=\"text-medium text-gray spacing-bottom-narrow\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Places to start your own discussions.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":9,"column":55},"end":{"line":9,"column":106}}}))
    + "</p>\n";
},"useData":true}));

Handlebars.registerPartial("genericFollowButton", Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    return " active";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<button class=\"btn-follow"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"isFollowing") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":1,"column":25},"end":{"line":1,"column":58}}})) != null ? stack1 : "")
    + "\" data-action=\"toggle-follow\">\n<span class=\"symbol-default\"><span class=\"icon-plus\"></span></span><span class=\"text-default\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Follow",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":3,"column":94},"end":{"line":3,"column":114}}}))
    + "</span><span class=\"symbol-following\"><span class=\"icon-checkmark\"></span></span><span class=\"text-following\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Following",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":3,"column":224},"end":{"line":3,"column":247}}}))
    + "</span>\n</button>\n";
},"useData":true}));

});
define('core/extensions/helpers/eq',[],function () {
    'use strict';

    return function (a, b) {
        return a === b;
    };
});

define('core/extensions/helpers/ne',[],function () {
    'use strict';

    return function (a, b) {
        return a !== b;
    };
});

define('core/extensions/helpers/gt',[],function () {
    'use strict';

    return function (a, b) {
        return a > b;
    };
});

define('core/extensions/helpers/lt',[],function () {
    'use strict';

    return function (a, b) {
        return a < b;
    };
});

define('core/extensions/helpers/ge',[],function () {
    'use strict';

    return function (a, b) {
        return a >= b;
    };
});

define('core/extensions/helpers/le',[],function () {
    'use strict';

    return function (a, b) {
        return a <= b;
    };
});

define('core/extensions/helpers/typeof',[],function () {
    'use strict';

    return function (a, b) {
        return typeof a === b;
    };
});

define('core/extensions/helpers/notNull',[],function () {
    'use strict';

    // A helper is needed to compare against null as null is not a handlebars keyword
    return function (a) {
        return a !== null;
    };
});

define('core/extensions/helpers/any',[],function () {
    'use strict';

    // emulate {= a || b}
    // TODO: is it better to return undefined or '' (empty string)?
    return function () {
        var len = arguments.length;
        for (var i = 0; i < len - 1; i++) {
            if (arguments[i])
                return arguments[i];
        }
    };
});

define('core/extensions/helpers/if_any',[],function () {
    'use strict';

    // if_any block helper
    // Usage: {{#if_any firstPost featuredPost}}...
    return function () {
        var len = arguments.length;
        var options = arguments[len - 1];
        for (var i = 0; i < len - 1; i++) {
            if (arguments[i])
                return options.fn(this);
        }
        return options.inverse(this);
    };
});

define('core/extensions/helpers/if_all',[],function () {
    'use strict';

    // if_all block helper
    // Usage: {{#if_all firstPost featuredPost}}...
    return function () {
        var len = arguments.length;
        var options = arguments[len - 1];
        for (var i = 0; i < len - 1; i++) {
            if (!arguments[i])
                return options.inverse(this);
        }
        return options.fn(this);
    };
});

define('core/utils/cookies',[
], function (
) {
    'use strict';

    var exports = {
        _doc: window.document,

        create: function (name, value, options) {
            if (!options)
                options = {};

            var cookie = name + '=' + value + '; path=' + (options.path || '/');
            var domain = options.domain;
            var expiresIn = options.expiresIn;

            if (domain)
                cookie += '; domain=.' + domain;

            if (Object.prototype.toString.call(expiresIn) === '[object Number]') {
                // expiresIn is in ms
                var date = new Date(new Date().getTime() + expiresIn);
                cookie += '; expires=' + date.toGMTString();
            }

            if (exports._doc.location.protocol === 'https:')
                cookie += '; secure';

            // For Chrome starting with version 80, we must add this flag to our
            // cookies so that they work undisrupted in a third-party cookie
            // context, otherwise cookies that don't specify a flag will
            // be treated as `SameSite=Lax` which prevents our cookies from
            // being set in a cross-site (third-party) context.
            //
            // See https://blog.chromium.org/2019/10/developers-get-ready-for-new.html
            cookie += '; SameSite=None';

            exports._doc.cookie = cookie;
        },

        read: function (name) {
            var nameEQ = name + '=';
            var cookies = exports._doc.cookie.split(';');
            var cookie;

            for (var i = 0; i < cookies.length; i++) {
                cookie = cookies[i].replace(/^\s+/, '');

                if (cookie.indexOf(nameEQ) === 0)
                    return cookie.substring(nameEQ.length);
            }

            return null;
        },

        erase: function (name, options) {
            var cookie = {};
            for (var key in options) {
                if (options.hasOwnProperty(key))
                    cookie[key] = options[key];
            }

            cookie.expiresIn = -1;
            return exports.create(name, '', cookie);
        },


        supported: function () {
            exports.create('cookie_support', '1');
            if (exports.read('cookie_support') === '1') {
                exports.erase('cookie_support');
                return true;
            }
            return false;
        },
    };

    return exports;
});

/* eslint-disable no-magic-numbers */
define('core/utils/fingerprint',[], function () {
    'use strict';

    // A fairly week fingerprinting function for a given browser.
    //
    // @param {Object} deps Dependency injection. Optional. Needed for
    //                      when this code is executed on the host page,
    //                      where the built-in native objects may have
    //                      been altered.
    function getFingerprint(deps) {
        deps = deps || {};
        var Math = deps.Math || window.Math;
        var Date = deps.Date || window.Date;

        // wrap in try/catch just to make sure it won't break anything in some exotic browser
        try {
            // The time-zone offset is the difference, in minutes, between UTC and local time
            var offset = new Date().getTimezoneOffset();
            var screenRes = 1;
            var screen = window.screen;

            if (screen && screen.availWidth)
                screenRes = screen.availWidth * screen.availHeight + screen.colorDepth;
            else if (screen && screen.width)  // screen.availWidth is not supported on mobile
                screenRes = screen.width * screen.height;

            var doc = window.document.documentElement;
            var browser = doc.clientWidth * doc.clientHeight;

            // multiply values by random prime numbers just to decrease likelihood of
            // making the same sum by different summands. Subtract `browser` in order
            // to decrease output value
            return Math.abs(offset * 17 + screenRes * 25 - browser);
        } catch (err) {
            return 1;
        }
    }

    return { get: getFingerprint };
});

/* eslint-disable no-magic-numbers */
define('core/utils/guid',['core/utils/fingerprint'], function (fp) {
    'use strict';

    // necessary to increase entropy for the same client (and other clients in case when
    // window.crytpo is supported)
    //
    // @param {Object} deps Dependency injection. Optional. Needed for
    //                      when this code is executed on the host page,
    //                      where the built-in native objects may have
    //                      been altered.
    function random(deps) {
        deps = deps || {};
        var Uint32Array = deps.Uint32Array || window.Uint32Array;
        var crypto = deps.crypto || window.crypto;
        var Math = deps.Math || window.Math;
        try {
            // get cryptographically strong entropy when available (CryptoAPI)
            // NOTE: Cannot rely on return value of `crypto.getRandomValues`,
            // some implementations may not return anything
            // (including our test environment, PhantomJS)
            var ab = new Uint32Array(1);
            crypto.getRandomValues(ab);
            return ab[0];
        } catch (err) { // could throw QuotaExceededError if too much entropy is drained
            // fallback to old way
            return Math.floor(Math.random() * 1e9);
        }
    }

    function getNavigationTime() {
        var performance = window.performance;
        var timing = performance && performance.timing;

        // this method is expected to return a big number, so do this in any case
        if (!timing)
            return 1e5;

        var dns = timing.domainLookupEnd - timing.domainLookupStart;
        var connection = timing.connectEnd - timing.connectStart;
        var navigation = timing.responseStart - timing.navigationStart;

        // multiply values by random prime numbers just to decrease likelihood of
        // making the same sum by different summands
        return dns * 11 + connection * 13 + navigation * 17;
    }

    // NOTE: This GUID function does *NOT* generate RFC4122 v4 compatible GUIDs
    //       that has the format `xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx`
    //
    // @param {Object} deps Dependency injection. Optional. Needed for
    //                      when this code is executed on the host page,
    //                      where the built-in native objects may have
    //                      been altered.
    function generateGUID(deps) {
        deps = deps || {};
        var Math = deps.Math || window.Math;

        // With all the fanciness above, we're going to generate a 'unique'
        // ID as an impression.

        // remove 3 most significant digits as they don't change often
        var time = Number(new Date().getTime().toString().substring(3));

        // Doing only arithmetic operations here as bitwise/shifts only operate on int32.
        // impId consists into two parts which should be independently random. Each part is
        // converted to number with base 32 in order to minimize overall length of the impId,
        // but still keep it very random (14^32 different strings)
        var guid = Math.abs(time + getNavigationTime() - fp.get()).toString(32);
        guid += random(deps).toString(32);
        return guid;
    }

    return { generate: generateGUID };
});

/* eslint-disable no-bitwise */

define('core/utils/hash',[], function () {
    'use strict';

    /**
     * The string hash function from Java.
     *
     * Borrowed from http://stackoverflow.com/questions/7616461/generate-a-hash-from-string-in-javascript-jquery
     * @param  {string} str
     * @returns {number}
     */
    var calculate = function (str) {
        var hash = 0;
        var i, len, character;

        if (str.length === 0)
            return hash;
        for (i = 0, len = str.length; i < len; i++) {
            character = str.charCodeAt(i);

            hash = ((hash << 5) - hash) + character;
            // Convert to 32bit integer
            hash |= 0;
        }
        return hash;
    };
    return { calculate: calculate };
});

define('core/analytics/identity',[
    'exports',

    'core/utils/cookies',
    'core/utils/guid',
    'core/utils/hash',
    'core/utils/fingerprint',
], function (
    exports,

    cookies,
    guid,
    hash,
    fingerprint
) {
    'use strict';

    var initialized = false;

    var ImpressionManager = exports.ImpressionManager = function () {
        // Will be updated by calls made from individual app initializations. Defaults to true to be safe
        this.isPrivate = true;

        this.impId = guid.generate();
    };
    ImpressionManager.prototype.COOKIE_NAME = '__jid';  // jid is 'jester impression id'
    ImpressionManager.prototype.TTL = 30 * 60 * 1000;  // TTL for the impression cookie is 30 minutes
    ImpressionManager.prototype.init = function (options) {
        // This function should be called upon app initialization, before this manager's values
        // or functions are utilized

        this.isPrivate = options && options.isPrivate;

        if (!this.isPrivate)
            this.prevImp = cookies.read(this.COOKIE_NAME);

        this.persist();
    };
    ImpressionManager.prototype.setImpressionId = function (impId) {
        this.impId = impId;
        this.persist();
    };
    ImpressionManager.prototype.persist = function () {
        // TODO: This is getting wiped if we find out `isPrivate` is actually
        // false later since it is initialized before the session is fetched
        // which can influence `isPrivate`.
        if (this.isPrivate) {
            cookies.erase(this.COOKIE_NAME);
            return;
        }

        // Set cookie so the current impression id
        // can be grabbed as the previous impression id in the next invocation.
        // (Expires after 30 minutes of inactivity.)
        cookies.create(this.COOKIE_NAME, this.impId, { expiresIn: this.TTL });
    };


    var UniqueManager = exports.UniqueManager = function () {
        // Will be updated by calls made from individual app initializations. Defaults to true to be safe
        this.isPrivate = true;
    };
    UniqueManager.prototype.COOKIE_NAME = 'disqus_unique';
    UniqueManager.prototype.TTL = 365 * 24 * 60 * 60 * 1000;  /* one year in ms */
    UniqueManager.prototype.init = function (options) {
        // This function should be called upon app initialization, before this manager's values
        // or functions are utilized
        this.isPrivate = options && options.isPrivate;

        if (this.isPrivate) {
            cookies.erase(this.COOKIE_NAME, {
                domain: window.location.host.split(':')[0],
            });
            return;
        }

        // TODO: We are currently generating a new GUID each time we ever
        // initialize with `isPrivate` which is the default behavior.  We
        // could persist the GUID in localStorage so we can use it whenever
        // we have consent and still keep deleting our cookie, or we can
        // decide we don't need to delete our cookie anymore, but we will
        // need to get legal's approval on which approach we are comfortable
        // with.  A version of the latter (storing in localStorage) can be
        // found in an early version of D28850.
        this.value = cookies.read(this.COOKIE_NAME) || guid.generate();

        // This needs to be called each time because if we ever
        // change the options, existing cookies will not get updated.
        cookies.create(this.COOKIE_NAME, this.value, {
            domain: window.location.host.split(':')[0],
            expiresIn: this.TTL,
        });
    };
    UniqueManager.prototype.isPersistent = function () {
        // If we were not able to set and read a cookie
        // then the browser does not support cookies.
        return !this.isPrivate && cookies.read(this.COOKIE_NAME) === this.value;
    };

    exports.init = function (options, force) {
        if (initialized && !force)
            return;

        exports.impression.init(options);
        exports.unique.init(options);
        initialized = true;
    };

    exports.reset = function () {
        initialized = false;

        exports.impression = new ImpressionManager();
        exports.unique = new UniqueManager();
    };

    exports.reset();

    /**
     * Returns a consistent ID for this client.
     *
     * Uses either the disqus_unique cookie value or the
     * browser's fingerprint value if cookies are not supported.
     * @returns {string} client id
     */
    exports.clientId = function () {
        var manager = exports.unique;
        var value;

        if (manager.isPersistent())
            value = manager.value;

        return value || fingerprint.get().toString();
    };

    /**
     * Returns a number between 0..99 for a given string identifier.
     *
     * This method of determining a percent using a specific string identifier
     * (such as a forum shortname, username, disqus_unique id, etc.)
     *
     * https://blog.disqus.com/the-paper-plane-proof-our-uplifting-story-of-client-side-javascript-bucketing
     *
     * @param {string} str - String to get calculated into a percent bucket
     * @param {number} precision - Determines the percentage precision
     * @returns {number} Number that is calculated from the hashed input
     */
    exports.getPercentBucketForString = function (str, precision) {
        var max = 100;
        var stringHash = Math.abs(hash.calculate(str));
        if (precision) {
            var divisor = Math.pow(10, precision);
            return (stringHash % (max * divisor)) / divisor;
        }
        return stringHash % max;
    };

    /**
     * Calculates the percentile for the client ID.
     *
     * @returns {number} percentile - Number that is calculated from the hashed input
     */

    exports.clientPercent = function () {
        return exports.getPercentBucketForString(exports.clientId());
    };
});

define('core/utils/storage',[], function () {
    'use strict';

    // `isLocalStorageSupported` is a boolean that tells us if
    // `window.localStorage` is available and functioning.
    var isLocalStorageSupported = (function (win) {
        var mod = '_dsqstorage_';
        try {
            win.localStorage.setItem(mod, mod);
            // .getItem check is necessary to protect against certain errors
            // such as `quota exceeded` or `permission denied`
            win.localStorage.getItem(mod);
            win.localStorage.removeItem(mod);
            return true;
        } catch (err) {
            return false;
        }
    })(window);

    /**
     * `hashStorage` mimics localStorage API but only runs in memory.
     *
     * This is basically our worst storage option and exists only as
     * fallback.
     */
    var hashStorage = (function () {
        var data = {};
        return {
            getItem: function (key) {
                return data.hasOwnProperty(key) ? data[key] : null;
            },

            setItem: function (key, val) {
                // DOM storage converts values to strings
                data[key] = String(val);
            },

            removeItem: function (key) {
                delete data[key];
            },

            clear: function () {
                data = {};
            },
        };
    })();

    return {
        get: function (name) {
            var val = null;
            try {
                // NOTE: Must put `getItem` call in a try-catch block too
                //       since if a user changes their cookie security settings
                //       while the app is running, this starts to throw an
                //       exception thus break things relying on this.
                // TODO: Consider falling back to hashStorage when the this happens
                val = this.backend.getItem(name);
                return JSON.parse(val);
            } catch (err) {
                return val;
            }
        },

        set: function (name, value) {
            try {
                this.backend.setItem(name, JSON.stringify(value));
            } catch (err) {
                // Pass
            }
        },

        remove: function (name) {
            try {
                this.backend.removeItem(name);
            } catch (err) {
                // Pass
            }
        },

        clear: function () {
            try {
                this.backend.clear();
            } catch (err) {
                // Pass
            }
        },

        backend: isLocalStorageSupported ? window.localStorage : hashStorage,

        // Is the backing implementation persistent between client reloads?
        isPersistent: isLocalStorageSupported,
    };
});

define('core/utils/auth',[
    'core/utils/cookies',
], function (
    cookies
) {
    'use strict';

    // NOTE: getFromCookie is exported here to be used in both react and backbone applications.
    // For use in embed/home/next-core, it should be accessed via Session, not through auth.

    var exports = {};
    var DISQUS_AUTH_COOKIE = 'disqusauth';

    /**
     * Get user attributes from `disqusauth` cookie.
     * @returns {Object} Dictionary of user attributes.
     */
    exports.getFromCookie = function () {
        var auth = (cookies.read(DISQUS_AUTH_COOKIE) || '').replace(/"/g, '').split('|');

        // If we do have an auth cookie but not a username and id
        // then the auth cookie is corrupted in some way and we should
        // erase it.
        if (auth && !(auth[1] && auth[6])) {
            auth = [];
            cookies.erase(DISQUS_AUTH_COOKIE, {});
        }

        var id = parseInt(auth[6] || '0', 10);

        return {
            avatarUrl: auth[7] ? decodeURIComponent(auth[7]) : undefined,
            datetimeFormatting: parseInt(auth[4], 10) ? 'absolute' : 'relative',
            id: id,
            isModerator: parseInt(auth[8], 10) > 0,
            staff: Boolean(parseInt(auth[2], 10)),
            tzOffset: auth[5],
            username: auth[1],
            isAuthenticated: Boolean(id && id !== '0'),
        };
    };

    return exports;
});

define('core/switches',[
    'underscore',
    'remote/config',
    'core/analytics/identity',
    'core/utils/storage',
    'core/utils/auth',
], function (
    _,
    config,
    identity,
    storage,
    auth
) {
    'use strict';

    /**
     * A pretty simple module that buckets users into features switches based
     * on their client percentage.
    */

    var SWITCH_NAMESPACE = 'switch:';

    var overrides = {};

    var exports = {};


    exports._getKey = function (switchName) {
        return SWITCH_NAMESPACE + switchName;
    };

    /**
     * Disable a feature for this client.
     *
     * @param {string} switchName - Name of the switch to be disabled
     */
    exports.disableFeature = function (switchName) {
        overrides[switchName] = false;
    };

    /**
     * Unset the feature preference for this client.
     * Feature will default to global setting.
     *
     * @param {string} switchName - Name of the switch to be unset
     */
    exports.resetFeature = function (switchName) {
        overrides[switchName] = null;
    };

    /**
     * Enable a feature for this client.
     *
     * @param {string} switchName - Name of the switch to be enabled
     */
    exports.forceFeature = function (switchName) {
        overrides[switchName] = true;
    };

    exports.getSwitchContext = function (switchName) {
        var localOverride = storage.get(this._getKey(switchName));

        // localSettings may be False, which should be preferred over remote config
        if (localOverride !== null)
            return localOverride;

        var customOverride = overrides[switchName];

        // customOverride may be False, which should be preferred over remote config
        if (customOverride != null)  // eslint-disable-line no-eq-null
            return customOverride;

        return (config.lounge && config.lounge.switches || {})[switchName];
    };

    /**
     * Checks if a given switch is active for this client.
     *
     * What will isFeatureActive('myFeature') return?
     *
     * Follow list below in order, stop at first matching line.
     *
     * standard values, in local settings: ex: boolean, percent, user_id, username, is_staff
     *
     * forced features
     *
     * Features forced "on" via `forceFeature` method, only for this
     * specific instance of this client. This is used for cases like
     * where an experiments needs to be activated, eg in the embed.
     * Note: experiments set through tempest use snake case
     *
     * my_experiment not in Jones
     * > isFeatureActive('experiment:my_experiment:active') -> false
     * > forceFeature('experiment:my_experiment:active')
     * > isFeatureActive('experiment:my_experiment:active') -> true
     *
     * standard values, in Jones: ex: boolean, percent, user_id, username, is_staff
     *
     *     myFeature not in jones false
     *     myFeature: true/false
     *     myFeature: { percent: 10 }
     *             and user's percent < 10 true
     *     myFeature: { percent: 0 } false
     *     myFeature: { percent: 100 } true
     *     myFeature: { user_id: 123 } or myFeature: { user_id: [..., 123, ...] }
     *             and user's id is 123 true
     *     myFeature: { username: 'nicoleallard' }
     *             or myFeature: { username: [..., 'nicoleallard', ...] }
     *             and user's username is nicoleallard true
     *     myFeature: { is_staff: true }
     *             and user is staff true
     *     myFeature: { is_staff: false }
     *             and user is not staff true
     *
     * examples of custom Jones values: forum, privateChannel, etc
     *
     *     myFeature: { forum: 'talkshop' }
     *             and isFeatureActive('myFeature', { forum: 'talkshop' }) true
     *     myFeature: { privateChannel: ['disqusfun', 'gabalafou-test'] }
     *             and isFeatureActive('myFeature', { privateChannel: 'disqusfun' }) true
     *     myFeature: { forum_percent: 82 }
     *             and isFeatureActive('myFeature', { forum_percent: 'talkshop' }) true
     *             above is true, only if the string `talkshop` falls in to the 82nd percentile
     *     otherwise false
     *
     * @param {string} switchName - Name of switch to be checked
     * @param {Object} extraContext - Values that switch is checked against
     * @returns {boolean}
     */
    exports.isFeatureActive = function (switchName, extraContext) {
        var switchConfig = exports.getSwitchContext(switchName);

        if (_.isBoolean(switchConfig))
            return switchConfig;

        if (!switchConfig)
            return false;

        var disqusauth = auth.getFromCookie();
        var userContext = {
            percent: identity.clientPercent(),
            user_id: disqusauth.id,
            username: disqusauth.username,
            is_staff: disqusauth.staff,
            is_moderator: disqusauth.isModerator,
        };

        var context = _.defaults(
            extraContext || {},
            userContext
        );

        return _.any(switchConfig, function (val, key) {
            var contextVal = context[key];

            if (/percent$/.test(key) && _.isNumber(val)) {  // percentage
                if (_.isNumber(contextVal))
                    return val > contextVal;

                if (_.isString(contextVal)) {
                    var precision = 0;
                    if (val !== Math.round(val))
                        precision = val.toString().split('.').pop().length;

                    return val > identity.getPercentBucketForString(contextVal, precision);
                }
                return false;
            }

            if (_.isArray(val))  // list of items / enum
                return _.contains(val, contextVal);

            // Fall back to exact matching if none of the above
            return val === contextVal;
        });
    };

    return exports;
});

define('core/utils/object/has',[],function () {
    'use strict';

    return function has(obj, key) {
        // The object.hasOwnProperty method fails when the
        // property under consideration is named 'hasOwnProperty'.
        return Object.prototype.hasOwnProperty.call(obj, key);
    };
});

define('core/utils/collection/each',[
    'core/utils/object/has',
], function (
    has
) {
    'use strict';

    /*
     * Iterates over an object or a collection and calls a callback
     * function with each item as a parameter.
     */
    return function each(collection, callback) {
        var length = collection.length;
        var forEach = Array.prototype.forEach;

        if (isNaN(length)) {
            // Treat collection as an object
            for (var key in collection) {
                if (has(collection, key))
                    callback(collection[key], key, collection);
            }
        } else if (forEach) {
            // Treat collection as an array
            forEach.call(collection, callback);
        } else {
            for (var i = 0; i < length; i++)
                callback(collection[i], i, collection);
        }
    };
});

define('core/utils/object/extend',[
    'core/utils/collection/each',
    'core/utils/object/has',
], function (
    each,
    has
) {
    'use strict';

    // Borrowed from underscore
    return function extend(obj) {
        each(Array.prototype.slice.call(arguments, 1), function (source) {
            for (var prop in source) {
                if (has(source, prop))
                    obj[prop] = source[prop];
            }
        });
        return obj;
    };
});

define('core/extensions/helpers/switch',[
    'core/switches',
    'core/utils/object/extend',
], function (
    switches,
    extend
) {
    'use strict';

    /*
     * @switch helper check if switch is active
     * Examples:
     *   - simply specify the switch you'd like to check
     *
     *     {{#if (switch "newHomepageReleased")}}something{{/if}}
     *
     */
    return function (value, options) {
        return switches.isFeatureActive(value, extend({}, options.hash));
    };
});

define('core/extensions/helpers/partial',[
    'handlebars',
], function (
    Handlebars
) {
    'use strict';

    /*
     * Register partial via helper. It allows to have several partials at the same file.
     */
    return function (name, options) {
        Handlebars.registerPartial(name, options.fn);
    };
});

define('core/extensions/helpers/getPartial',[
    'handlebars',
], function (
    Handlebars
) {
    'use strict';

    // getPartial block helper
    // Invoke a partial by name with a context
    // For use in subexpressions where '>' is not a valid helper
    // If context is omitted the current context will be used instead
    // Usage: (getPartial 'partialName' context)
    return function (name, context, options) {
        if (typeof options === 'undefined') {
            options = context;
            context = this;  // eslint-disable-line consistent-this

            // Extend the context with any key=value options
            // passed in `getPartial`. This allows for partials
            // like <a href={{href}}></a> to be called like this:
            // (getPartial 'link' href='#'). Idea pulled from
            // `invokePartial` and `invokePartialWrapper` in the
            // Handlebars runtime.js.
            Handlebars.Utils.extend(context, options.hash);
        }
        return new Handlebars.SafeString(Handlebars.partials[name](context, options));
    };
});

/*! loglevel - v1.4.0 - https://github.com/pimterry/loglevel - (c) 2015 Tim Perry - licensed MIT */
(function (root, definition) {
    "use strict";
    if (typeof module === 'object' && module.exports && typeof require === 'function') {
        module.exports = definition();
    } else if (typeof define === 'function' && typeof define.amd === 'object') {
        define('loglevel',definition);
    } else {
        root.log = definition();
    }
}(this, function () {
    "use strict";
    var noop = function() {};
    var undefinedType = "undefined";

    function realMethod(methodName) {
        if (typeof console === undefinedType) {
            return false; // We can't build a real method without a console to log to
        } else if (console[methodName] !== undefined) {
            return bindMethod(console, methodName);
        } else if (console.log !== undefined) {
            return bindMethod(console, 'log');
        } else {
            return noop;
        }
    }

    function bindMethod(obj, methodName) {
        var method = obj[methodName];
        if (typeof method.bind === 'function') {
            return method.bind(obj);
        } else {
            try {
                return Function.prototype.bind.call(method, obj);
            } catch (e) {
                // Missing bind shim or IE8 + Modernizr, fallback to wrapping
                return function() {
                    return Function.prototype.apply.apply(method, [obj, arguments]);
                };
            }
        }
    }

    // these private functions always need `this` to be set properly

    function enableLoggingWhenConsoleArrives(methodName, level, loggerName) {
        return function () {
            if (typeof console !== undefinedType) {
                replaceLoggingMethods.call(this, level, loggerName);
                this[methodName].apply(this, arguments);
            }
        };
    }

    function replaceLoggingMethods(level, loggerName) {
        /*jshint validthis:true */
        for (var i = 0; i < logMethods.length; i++) {
            var methodName = logMethods[i];
            this[methodName] = (i < level) ?
                noop :
                this.methodFactory(methodName, level, loggerName);
        }
    }

    function defaultMethodFactory(methodName, level, loggerName) {
        /*jshint validthis:true */
        return realMethod(methodName) ||
               enableLoggingWhenConsoleArrives.apply(this, arguments);
    }

    var logMethods = [
        "trace",
        "debug",
        "info",
        "warn",
        "error"
    ];

    function Logger(name, defaultLevel, factory) {
      var self = this;
      var currentLevel;
      var storageKey = "loglevel";
      if (name) {
        storageKey += ":" + name;
      }

      function persistLevelIfPossible(levelNum) {
          var levelName = (logMethods[levelNum] || 'silent').toUpperCase();

          // Use localStorage if available
          try {
              window.localStorage[storageKey] = levelName;
              return;
          } catch (ignore) {}

          // Use session cookie as fallback
          try {
              window.document.cookie =
                encodeURIComponent(storageKey) + "=" + levelName + ";";
          } catch (ignore) {}
      }

      function getPersistedLevel() {
          var storedLevel;

          try {
              storedLevel = window.localStorage[storageKey];
          } catch (ignore) {}

          if (typeof storedLevel === undefinedType) {
              try {
                  var cookie = window.document.cookie;
                  var location = cookie.indexOf(
                      encodeURIComponent(storageKey) + "=");
                  if (location) {
                      storedLevel = /^([^;]+)/.exec(cookie.slice(location))[1];
                  }
              } catch (ignore) {}
          }

          // If the stored level is not valid, treat it as if nothing was stored.
          if (self.levels[storedLevel] === undefined) {
              storedLevel = undefined;
          }

          return storedLevel;
      }

      /*
       *
       * Public API
       *
       */

      self.levels = { "TRACE": 0, "DEBUG": 1, "INFO": 2, "WARN": 3,
          "ERROR": 4, "SILENT": 5};

      self.methodFactory = factory || defaultMethodFactory;

      self.getLevel = function () {
          return currentLevel;
      };

      self.setLevel = function (level, persist) {
          if (typeof level === "string" && self.levels[level.toUpperCase()] !== undefined) {
              level = self.levels[level.toUpperCase()];
          }
          if (typeof level === "number" && level >= 0 && level <= self.levels.SILENT) {
              currentLevel = level;
              if (persist !== false) {  // defaults to true
                  persistLevelIfPossible(level);
              }
              replaceLoggingMethods.call(self, level, name);
              if (typeof console === undefinedType && level < self.levels.SILENT) {
                  return "No console available for logging";
              }
          } else {
              throw "log.setLevel() called with invalid level: " + level;
          }
      };

      self.setDefaultLevel = function (level) {
          if (!getPersistedLevel()) {
              self.setLevel(level, false);
          }
      };

      self.enableAll = function(persist) {
          self.setLevel(self.levels.TRACE, persist);
      };

      self.disableAll = function(persist) {
          self.setLevel(self.levels.SILENT, persist);
      };

      // Initialize with the right level
      var initialLevel = getPersistedLevel();
      if (initialLevel == null) {
          initialLevel = defaultLevel == null ? "WARN" : defaultLevel;
      }
      self.setLevel(initialLevel, false);
    }

    /*
     *
     * Package-level API
     *
     */

    var defaultLogger = new Logger();

    var _loggersByName = {};
    defaultLogger.getLogger = function getLogger(name) {
        if (typeof name !== "string" || name === "") {
          throw new TypeError("You must supply a name when creating a logger.");
        }

        var logger = _loggersByName[name];
        if (!logger) {
          logger = _loggersByName[name] = new Logger(
            name, defaultLogger.getLevel(), defaultLogger.methodFactory);
        }
        return logger;
    };

    // Grab the current global log variable in case of overwrite
    var _log = (typeof window !== undefinedType) ? window.log : undefined;
    defaultLogger.noConflict = function() {
        if (typeof window !== undefinedType &&
               window.log === defaultLogger) {
            window.log = _log;
        }

        return defaultLogger;
    };

    return defaultLogger;
}));

define('core/strings',[
    'loglevel',

    'translations',
], function (
    logger,

    translations
) {
    'use strict';

    var exports = {
        translations: translations,
    };

    /**
     * Gets a string's translation, if available.
     * `gettext` is preferred within jsx.
     *
     * This function can't handle variables on its own. It needs to be used with
     * `interpolate` to get the variables' values.
     * Ex. interpolate(get(string), context)
     *
     *
     * This function has to be renamed and called as `gettext` because we use jsxgettext
     * to parse for strings that need translations.
     * Ex. var gettext = strings.get
     * See how jsxgettext works: https://www.npmjs.com/package/jsxgettext
     *
     * Any strings in `gettext` calls will be sent to Transifex for translation.
     * This function should only be used after code review is complete to avoid
     * unnecessary translations.
     *
     * To see what strings will be translated run `grunt xgettext app=embed`.
     * It generates a file with all strings that would be translated from
     * your last embed build.
     *
     *
     * Only passing a string as the argument will return the translated string.
     * When testing there will be no translations, so it will simply return the
     * string that was passed.
     * Ex. get=('hello') -> 'hello'
     *
     * Variables go inside %()s. However, this function doesn't handle replacing the variable
     * Ex. get('hey %(you)s') -> 'hey %(you)s'
     *
     * @param  {string} text - String to be translated
     * @returns {string} - The translated string, if available, else the original string
     */
    exports.get = function get(text) {
        var trans = exports.translations[text];
        return trans === undefined ? text : trans;
    };

    /**
     * Replaces the variable in a string with its value in the given context.
     * This variable will not be translated.
     *
     * Should be used with a `get` call.
     * Ex. interpolate(get(string), ctx)
     *
     *
     * Variables must be within %()s inside of the passed string.
     * Ex. interpolate(get('hey %(you)s'), { you : 'Jack' }) -> 'hey Jack'
     *
     * It can also take multiple variables.
     * Ex. interpolate(get('%(hey)s %(you)s'), { hey: 'hi', you: 'Jack' }) -> 'hi Jack'
     *
     * @param  {string} string - String with variables to replace
     * @param  {Object} ctx - Context for the variables
     * @returns {string} - String with variables replaced by their values
     */
    exports.interpolate = function interpolate(string, ctx) {
        function fromContext(key) {
            var result = '';
            if (key in ctx)
                result = ctx[key] !== undefined && ctx[key] !== null ? ctx[key].toString() : '';
            else
                logger.error('Key `' + key + '` not found in context for: ', string);

            return result;
        }

        return string.replace(/%\(\w+\)s/g, function (match) {
            return fromContext(match.slice(2, -2));
        });
    };

    /**
     * Gets a string's translation, if available.
     * This is the preferred function within jsx. It's easier to use than get
     * and interpolate, but returns an array so it's clunky to use outside jsx.
     *
     *
     * This function has to be called as `gettext` because we use jsxgettext
     * to parse for strings that need translations.
     * See how jsxgettext works: https://www.npmjs.com/package/jsxgettext
     *
     * Any strings in `gettext` calls will be sent to Transifex for translation.
     * This function should only be used after code review is complete to avoid
     * unnecessary translations.
     *
     * To see what strings will be translated run `grunt xgettext app=embed`.
     * It generates a file with all strings that would be translated from
     * your last embed build.
     *
     *
     * Only passing a string as the argument will return the translated string.
     * When testing there will be no translations, so it will simply return the
     * string that was passed.
     * Ex. gettext('hello') -> ['hello']
     *
     * You can use variables in strings by using %()s and passing its value in
     * the context object. The variable is not translated.
     * Ex. gettext('hey %(you)s', { you : 'Jack' }) -> ['hey ', 'Jack']
     *
     * You can use multiple variables.
     * Ex. gettext('%(hey)s %(you)s', { hey: 'hi', you: 'Jack' }) -> ['hi', ' ',  'Jack']
     *
     * This also means that you can't use %()s without a variable.
     * Ex. gettext('hey %(you)s') -> error
     *
     * @param  {string} string - String to be translated
     * @param  {Object} [ctx] - Context for variables within the string
     * @returns {Array} - Array containing the translated string and the variables' values
     */
    exports.gettext = function gettext(string, ctx) {
        string = exports.get(string);
        ctx = ctx || {};
        return string.split(/(%\(\w+\)s)/g).map(function (part) {
            var match = part.match(/%\((\w+)\)s/);
            if (match) {
                if (match[1] in ctx)
                    part = ctx[match[1]];
                else
                    logger.error('Key `' + match[1] + '` not found in context for: ' + string);
            }
            if (part === '')
                return null;
            return part;
        });
    };

    return exports;
});

define('core/extensions/helpers/gettext',[
    'handlebars',

    'core/strings',
], function (
    Handlebars,

    strings
) {
    'use strict';

    /*
     * @gettext helper process translatable strings.
     * Examples:
     *   - simply replace string with its translation:
     *
     *     {{gettext "translate me please"}}
     *
     *   - replace string with its translation, in addition replace @name placeholder
     *     with html generated by partial template with @partialName. Partial executed
     *     with @context:
     *
     *     {{gettext "%(name)s translate me please" name = partialName(context)}}
     *
     *   - replace string with its translation, in addition replace @number placeholder with value of @count
     *
     *     {{gettext "%(number)s comments" number = count}}
     *
     */
    return function () {
        var len = arguments.length;
        var options = arguments[len - 1];
        var hash = options.hash;
        var value = arguments[0];
        var partials = Handlebars.partials;
        var html, regex, key, isPartial;

        value = Handlebars.Utils.escapeExpression(strings.get(value));
        for (key in hash) {
            if (hash.hasOwnProperty(key)) {
                regex = new RegExp('%\\((' + key + ')\\)s', 'gm');
                html = hash[key];
                isPartial = html && html.executePartial;

                if (isPartial)
                    html = partials[html.partial].call(this, html.context, options);

                // replace undefined, null and NaN with empty string
                if (html === undefined || html === null || (typeof html === 'number' && isNaN(html)))
                    html = '';
                else if (!isPartial)
                    html = Handlebars.Utils.escapeExpression(html);

                value = value.replace(regex, html.toString());
            }
        }
        return new Handlebars.SafeString(value);
    };
});

define('core/config/urls',[], function () {
    'use strict';
    return {
        jester: 'https://referrer.' + window.document.location.host + '/juggler',
        cdn: undefined,
    };
});

define('core/utils/object/get',[],function () {
    'use strict';


    /**
     * Safely accesses a deeply-nested property of objects.
     *
     * @param {Object} obj The object to start with
     * @param {Array<string>} path An array of keys to the nested property
     * @param {*} [defaultValue] The value to return if the deeply nested
     *                           property is undefined or does not exist
     * @returns {*} The accessed property, or defaultValue.
     */
    return function get(obj, path, defaultValue) {
        var i = 0;
        var len = path.length;

        while (obj && i < len) {
            obj = obj[path[i]];
            i += 1;
        }

        if (i < len || obj === undefined)
            return defaultValue;

        return obj;
    };
});

define('core/extensions/helpers/urlfor',[
    'core/config/urls',
    'core/utils/object/get',
], function (
    urls,
    get
) {
    'use strict';

    return function (propName) {
        return get(urls, propName.split('.'));
    };
});

define('core/extensions/helpers/html',[
    'handlebars',
], function (
    Handlebars
) {
    'use strict';

    /*
     * Output html without characters escaping.
     * You can do the same by using triple brackets {{{"some html string here"}}}, but
     * "html" keyword is more obvious and easy to understand and cannot by just a typo.
     * Also it treat null and undefined as empty string, so won't cause errors in
     * SafeString.toString() method.
     */
    return function (value) {
        return new Handlebars.SafeString(value || '');
    };
});

define('core/extensions/helpers/with',[],function () {
    'use strict';

    /*
     * @with helper allows to change context of some part of template.
     * - in addition it may specify name of new context, i.e. wrap context
     *   into new object with some named property:
     *
     *      {{#with name=context}}
     *
     * - also if constant string '_window_' is passed, then context
     *   became global window object
     */
    return function () {
        var len = arguments.length;
        var options = arguments[len - 1];
        var context = arguments[0];

        if (len === 3) {
            context = {};
            context[arguments[0]] = arguments[1];
        } else if (context === '_window_') {
            context = window;
        }

        return options.fn(context);
    };
});

define('core/extensions/helpers/each',[
    'handlebars',
], function (
    Handlebars
) {
    'use strict';

    return function (context, options) {
        var fn = options.fn;
        var inverse = options.inverse;

        var i = 0;
        var ret = '';
        var data, key, j;

        if (options.data)
            data = Handlebars.createFrame(options.data);

        if (context && typeof context === 'object') {
            if (Object.prototype.toString.call(context) === '[object Array]') {
                for (j = context.length; i < j; i++) {
                    if (data) {
                        data.index = i;
                        data.length = context.length; // added this line to original handlebars helper
                    }
                    ret += fn(context[i], { data: data });
                }
            } else {
                for (key in context) {
                    if (context.hasOwnProperty(key)) {
                        if (data)
                            data.key = key;

                        ret += fn(context[key], { data: data });
                        i += 1;
                    }
                }
            }
        }

        if (i === 0)
            ret = inverse(this);

        return ret;
    };
});

define('core/extensions/helpers/log',[],function () {
    'use strict';

    /* eslint-disable no-console */
    // Log helper for development only
    return function (name) {
        console.log(name, this);
    };
});

define('core/extensions/helpers/debug',[],function () {
    'use strict';

    // Debug helper for development only
    return function () {
        debugger;  // eslint-disable-line no-debugger
    };
});

define('core/extensions/helpers/geturl',[],function () {
    'use strict';

    // WARNING: Only for development, geturl calls get replaced by grunt-smartrev
    return window.geturl || function (url) {
        return url;
    };
});

define('core/extensions/helpers/tag',[
    'handlebars',
], function (
    Handlebars
) {
    'use strict';

    // This is a simple tag helper concept for making links inside translations simpler.
    return function (tagname, options) {
        var el = ['<' + tagname ];
        // Can't use any HTML in `text`
        var text = options.hash.text;
        delete options.hash.text;
        for (var key in options.hash) {
            if (options.hash.hasOwnProperty(key))
                el.push(' ' + key + '="' + Handlebars.escapeExpression(options.hash[key]) + '"');
        }
        el.push('>' + Handlebars.escapeExpression(text) + '</' + tagname + '>');
        return new Handlebars.SafeString(el.join(''));
    };
});

//! moment.js
//! version : 2.11.2
//! authors : Tim Wood, Iskren Chernev, Moment.js contributors
//! license : MIT
//! momentjs.com

;(function (global, factory) {
    typeof exports === 'object' && typeof module !== 'undefined' ? module.exports = factory() :
    typeof define === 'function' && define.amd ? define('moment',factory) :
    global.moment = factory()
}(this, function () { 'use strict';

    var hookCallback;

    function utils_hooks__hooks () {
        return hookCallback.apply(null, arguments);
    }

    // This is done to register the method called with moment()
    // without creating circular dependencies.
    function setHookCallback (callback) {
        hookCallback = callback;
    }

    function isArray(input) {
        return Object.prototype.toString.call(input) === '[object Array]';
    }

    function isDate(input) {
        return input instanceof Date || Object.prototype.toString.call(input) === '[object Date]';
    }

    function map(arr, fn) {
        var res = [], i;
        for (i = 0; i < arr.length; ++i) {
            res.push(fn(arr[i], i));
        }
        return res;
    }

    function hasOwnProp(a, b) {
        return Object.prototype.hasOwnProperty.call(a, b);
    }

    function extend(a, b) {
        for (var i in b) {
            if (hasOwnProp(b, i)) {
                a[i] = b[i];
            }
        }

        if (hasOwnProp(b, 'toString')) {
            a.toString = b.toString;
        }

        if (hasOwnProp(b, 'valueOf')) {
            a.valueOf = b.valueOf;
        }

        return a;
    }

    function create_utc__createUTC (input, format, locale, strict) {
        return createLocalOrUTC(input, format, locale, strict, true).utc();
    }

    function defaultParsingFlags() {
        // We need to deep clone this object.
        return {
            empty           : false,
            unusedTokens    : [],
            unusedInput     : [],
            overflow        : -2,
            charsLeftOver   : 0,
            nullInput       : false,
            invalidMonth    : null,
            invalidFormat   : false,
            userInvalidated : false,
            iso             : false
        };
    }

    function getParsingFlags(m) {
        if (m._pf == null) {
            m._pf = defaultParsingFlags();
        }
        return m._pf;
    }

    function valid__isValid(m) {
        if (m._isValid == null) {
            var flags = getParsingFlags(m);
            m._isValid = !isNaN(m._d.getTime()) &&
                flags.overflow < 0 &&
                !flags.empty &&
                !flags.invalidMonth &&
                !flags.invalidWeekday &&
                !flags.nullInput &&
                !flags.invalidFormat &&
                !flags.userInvalidated;

            if (m._strict) {
                m._isValid = m._isValid &&
                    flags.charsLeftOver === 0 &&
                    flags.unusedTokens.length === 0 &&
                    flags.bigHour === undefined;
            }
        }
        return m._isValid;
    }

    function valid__createInvalid (flags) {
        var m = create_utc__createUTC(NaN);
        if (flags != null) {
            extend(getParsingFlags(m), flags);
        }
        else {
            getParsingFlags(m).userInvalidated = true;
        }

        return m;
    }

    function isUndefined(input) {
        return input === void 0;
    }

    // Plugins that add properties should also add the key here (null value),
    // so we can properly clone ourselves.
    var momentProperties = utils_hooks__hooks.momentProperties = [];

    function copyConfig(to, from) {
        var i, prop, val;

        if (!isUndefined(from._isAMomentObject)) {
            to._isAMomentObject = from._isAMomentObject;
        }
        if (!isUndefined(from._i)) {
            to._i = from._i;
        }
        if (!isUndefined(from._f)) {
            to._f = from._f;
        }
        if (!isUndefined(from._l)) {
            to._l = from._l;
        }
        if (!isUndefined(from._strict)) {
            to._strict = from._strict;
        }
        if (!isUndefined(from._tzm)) {
            to._tzm = from._tzm;
        }
        if (!isUndefined(from._isUTC)) {
            to._isUTC = from._isUTC;
        }
        if (!isUndefined(from._offset)) {
            to._offset = from._offset;
        }
        if (!isUndefined(from._pf)) {
            to._pf = getParsingFlags(from);
        }
        if (!isUndefined(from._locale)) {
            to._locale = from._locale;
        }

        if (momentProperties.length > 0) {
            for (i in momentProperties) {
                prop = momentProperties[i];
                val = from[prop];
                if (!isUndefined(val)) {
                    to[prop] = val;
                }
            }
        }

        return to;
    }

    var updateInProgress = false;

    // Moment prototype object
    function Moment(config) {
        copyConfig(this, config);
        this._d = new Date(config._d != null ? config._d.getTime() : NaN);
        // Prevent infinite loop in case updateOffset creates new moment
        // objects.
        if (updateInProgress === false) {
            updateInProgress = true;
            utils_hooks__hooks.updateOffset(this);
            updateInProgress = false;
        }
    }

    function isMoment (obj) {
        return obj instanceof Moment || (obj != null && obj._isAMomentObject != null);
    }

    function absFloor (number) {
        if (number < 0) {
            return Math.ceil(number);
        } else {
            return Math.floor(number);
        }
    }

    function toInt(argumentForCoercion) {
        var coercedNumber = +argumentForCoercion,
            value = 0;

        if (coercedNumber !== 0 && isFinite(coercedNumber)) {
            value = absFloor(coercedNumber);
        }

        return value;
    }

    // compare two arrays, return the number of differences
    function compareArrays(array1, array2, dontConvert) {
        var len = Math.min(array1.length, array2.length),
            lengthDiff = Math.abs(array1.length - array2.length),
            diffs = 0,
            i;
        for (i = 0; i < len; i++) {
            if ((dontConvert && array1[i] !== array2[i]) ||
                (!dontConvert && toInt(array1[i]) !== toInt(array2[i]))) {
                diffs++;
            }
        }
        return diffs + lengthDiff;
    }

    function Locale() {
    }

    // internal storage for locale config files
    var locales = {};
    var globalLocale;

    function normalizeLocale(key) {
        return key ? key.toLowerCase().replace('_', '-') : key;
    }

    // pick the locale from the array
    // try ['en-au', 'en-gb'] as 'en-au', 'en-gb', 'en', as in move through the list trying each
    // substring from most specific to least, but move to the next array item if it's a more specific variant than the current root
    function chooseLocale(names) {
        var i = 0, j, next, locale, split;

        while (i < names.length) {
            split = normalizeLocale(names[i]).split('-');
            j = split.length;
            next = normalizeLocale(names[i + 1]);
            next = next ? next.split('-') : null;
            while (j > 0) {
                locale = loadLocale(split.slice(0, j).join('-'));
                if (locale) {
                    return locale;
                }
                if (next && next.length >= j && compareArrays(split, next, true) >= j - 1) {
                    //the next array item is better than a shallower substring of this one
                    break;
                }
                j--;
            }
            i++;
        }
        return null;
    }

    function loadLocale(name) {
        var oldLocale = null;
        // TODO: Find a better way to register and load all the locales in Node
        if (!locales[name] && (typeof module !== 'undefined') &&
                module && module.exports) {
            try {
                oldLocale = globalLocale._abbr;
                require('./locale/' + name);
                // because defineLocale currently also sets the global locale, we
                // want to undo that for lazy loaded locales
                locale_locales__getSetGlobalLocale(oldLocale);
            } catch (e) { }
        }
        return locales[name];
    }

    // This function will load locale and then set the global locale.  If
    // no arguments are passed in, it will simply return the current global
    // locale key.
    function locale_locales__getSetGlobalLocale (key, values) {
        var data;
        if (key) {
            if (isUndefined(values)) {
                data = locale_locales__getLocale(key);
            }
            else {
                data = defineLocale(key, values);
            }

            if (data) {
                // moment.duration._locale = moment._locale = data;
                globalLocale = data;
            }
        }

        return globalLocale._abbr;
    }

    function defineLocale (name, values) {
        if (values !== null) {
            values.abbr = name;
            locales[name] = locales[name] || new Locale();
            locales[name].set(values);

            // backwards compat for now: also set the locale
            locale_locales__getSetGlobalLocale(name);

            return locales[name];
        } else {
            // useful for testing
            delete locales[name];
            return null;
        }
    }

    // returns locale data
    function locale_locales__getLocale (key) {
        var locale;

        if (key && key._locale && key._locale._abbr) {
            key = key._locale._abbr;
        }

        if (!key) {
            return globalLocale;
        }

        if (!isArray(key)) {
            //short-circuit everything else
            locale = loadLocale(key);
            if (locale) {
                return locale;
            }
            key = [key];
        }

        return chooseLocale(key);
    }

    var aliases = {};

    function addUnitAlias (unit, shorthand) {
        var lowerCase = unit.toLowerCase();
        aliases[lowerCase] = aliases[lowerCase + 's'] = aliases[shorthand] = unit;
    }

    function normalizeUnits(units) {
        return typeof units === 'string' ? aliases[units] || aliases[units.toLowerCase()] : undefined;
    }

    function normalizeObjectUnits(inputObject) {
        var normalizedInput = {},
            normalizedProp,
            prop;

        for (prop in inputObject) {
            if (hasOwnProp(inputObject, prop)) {
                normalizedProp = normalizeUnits(prop);
                if (normalizedProp) {
                    normalizedInput[normalizedProp] = inputObject[prop];
                }
            }
        }

        return normalizedInput;
    }

    function isFunction(input) {
        return input instanceof Function || Object.prototype.toString.call(input) === '[object Function]';
    }

    function makeGetSet (unit, keepTime) {
        return function (value) {
            if (value != null) {
                get_set__set(this, unit, value);
                utils_hooks__hooks.updateOffset(this, keepTime);
                return this;
            } else {
                return get_set__get(this, unit);
            }
        };
    }

    function get_set__get (mom, unit) {
        return mom.isValid() ?
            mom._d['get' + (mom._isUTC ? 'UTC' : '') + unit]() : NaN;
    }

    function get_set__set (mom, unit, value) {
        if (mom.isValid()) {
            mom._d['set' + (mom._isUTC ? 'UTC' : '') + unit](value);
        }
    }

    // MOMENTS

    function getSet (units, value) {
        var unit;
        if (typeof units === 'object') {
            for (unit in units) {
                this.set(unit, units[unit]);
            }
        } else {
            units = normalizeUnits(units);
            if (isFunction(this[units])) {
                return this[units](value);
            }
        }
        return this;
    }

    function zeroFill(number, targetLength, forceSign) {
        var absNumber = '' + Math.abs(number),
            zerosToFill = targetLength - absNumber.length,
            sign = number >= 0;
        return (sign ? (forceSign ? '+' : '') : '-') +
            Math.pow(10, Math.max(0, zerosToFill)).toString().substr(1) + absNumber;
    }

    var formattingTokens = /(\[[^\[]*\])|(\\)?([Hh]mm(ss)?|Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|Qo?|YYYYYY|YYYYY|YYYY|YY|gg(ggg?)?|GG(GGG?)?|e|E|a|A|hh?|HH?|mm?|ss?|S{1,9}|x|X|zz?|ZZ?|.)/g;

    var localFormattingTokens = /(\[[^\[]*\])|(\\)?(LTS|LT|LL?L?L?|l{1,4})/g;

    var formatFunctions = {};

    var formatTokenFunctions = {};

    // token:    'M'
    // padded:   ['MM', 2]
    // ordinal:  'Mo'
    // callback: function () { this.month() + 1 }
    function addFormatToken (token, padded, ordinal, callback) {
        var func = callback;
        if (typeof callback === 'string') {
            func = function () {
                return this[callback]();
            };
        }
        if (token) {
            formatTokenFunctions[token] = func;
        }
        if (padded) {
            formatTokenFunctions[padded[0]] = function () {
                return zeroFill(func.apply(this, arguments), padded[1], padded[2]);
            };
        }
        if (ordinal) {
            formatTokenFunctions[ordinal] = function () {
                return this.localeData().ordinal(func.apply(this, arguments), token);
            };
        }
    }

    function removeFormattingTokens(input) {
        if (input.match(/\[[\s\S]/)) {
            return input.replace(/^\[|\]$/g, '');
        }
        return input.replace(/\\/g, '');
    }

    function makeFormatFunction(format) {
        var array = format.match(formattingTokens), i, length;

        for (i = 0, length = array.length; i < length; i++) {
            if (formatTokenFunctions[array[i]]) {
                array[i] = formatTokenFunctions[array[i]];
            } else {
                array[i] = removeFormattingTokens(array[i]);
            }
        }

        return function (mom) {
            var output = '';
            for (i = 0; i < length; i++) {
                output += array[i] instanceof Function ? array[i].call(mom, format) : array[i];
            }
            return output;
        };
    }

    // format date using native date object
    function formatMoment(m, format) {
        if (!m.isValid()) {
            return m.localeData().invalidDate();
        }

        format = expandFormat(format, m.localeData());
        formatFunctions[format] = formatFunctions[format] || makeFormatFunction(format);

        return formatFunctions[format](m);
    }

    function expandFormat(format, locale) {
        var i = 5;

        function replaceLongDateFormatTokens(input) {
            return locale.longDateFormat(input) || input;
        }

        localFormattingTokens.lastIndex = 0;
        while (i >= 0 && localFormattingTokens.test(format)) {
            format = format.replace(localFormattingTokens, replaceLongDateFormatTokens);
            localFormattingTokens.lastIndex = 0;
            i -= 1;
        }

        return format;
    }

    var match1         = /\d/;            //       0 - 9
    var match2         = /\d\d/;          //      00 - 99
    var match3         = /\d{3}/;         //     000 - 999
    var match4         = /\d{4}/;         //    0000 - 9999
    var match6         = /[+-]?\d{6}/;    // -999999 - 999999
    var match1to2      = /\d\d?/;         //       0 - 99
    var match3to4      = /\d\d\d\d?/;     //     999 - 9999
    var match5to6      = /\d\d\d\d\d\d?/; //   99999 - 999999
    var match1to3      = /\d{1,3}/;       //       0 - 999
    var match1to4      = /\d{1,4}/;       //       0 - 9999
    var match1to6      = /[+-]?\d{1,6}/;  // -999999 - 999999

    var matchUnsigned  = /\d+/;           //       0 - inf
    var matchSigned    = /[+-]?\d+/;      //    -inf - inf

    var matchOffset    = /Z|[+-]\d\d:?\d\d/gi; // +00:00 -00:00 +0000 -0000 or Z
    var matchShortOffset = /Z|[+-]\d\d(?::?\d\d)?/gi; // +00 -00 +00:00 -00:00 +0000 -0000 or Z

    var matchTimestamp = /[+-]?\d+(\.\d{1,3})?/; // 123456789 123456789.123

    // any word (or two) characters or numbers including two/three word month in arabic.
    // includes scottish gaelic two word and hyphenated months
    var matchWord = /[0-9]*['a-z\u00A0-\u05FF\u0700-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+|[\u0600-\u06FF\/]+(\s*?[\u0600-\u06FF]+){1,2}/i;


    var regexes = {};

    function addRegexToken (token, regex, strictRegex) {
        regexes[token] = isFunction(regex) ? regex : function (isStrict, localeData) {
            return (isStrict && strictRegex) ? strictRegex : regex;
        };
    }

    function getParseRegexForToken (token, config) {
        if (!hasOwnProp(regexes, token)) {
            return new RegExp(unescapeFormat(token));
        }

        return regexes[token](config._strict, config._locale);
    }

    // Code from http://stackoverflow.com/questions/3561493/is-there-a-regexp-escape-function-in-javascript
    function unescapeFormat(s) {
        return regexEscape(s.replace('\\', '').replace(/\\(\[)|\\(\])|\[([^\]\[]*)\]|\\(.)/g, function (matched, p1, p2, p3, p4) {
            return p1 || p2 || p3 || p4;
        }));
    }

    function regexEscape(s) {
        return s.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
    }

    var tokens = {};

    function addParseToken (token, callback) {
        var i, func = callback;
        if (typeof token === 'string') {
            token = [token];
        }
        if (typeof callback === 'number') {
            func = function (input, array) {
                array[callback] = toInt(input);
            };
        }
        for (i = 0; i < token.length; i++) {
            tokens[token[i]] = func;
        }
    }

    function addWeekParseToken (token, callback) {
        addParseToken(token, function (input, array, config, token) {
            config._w = config._w || {};
            callback(input, config._w, config, token);
        });
    }

    function addTimeToArrayFromToken(token, input, config) {
        if (input != null && hasOwnProp(tokens, token)) {
            tokens[token](input, config._a, config, token);
        }
    }

    var YEAR = 0;
    var MONTH = 1;
    var DATE = 2;
    var HOUR = 3;
    var MINUTE = 4;
    var SECOND = 5;
    var MILLISECOND = 6;
    var WEEK = 7;
    var WEEKDAY = 8;

    function daysInMonth(year, month) {
        return new Date(Date.UTC(year, month + 1, 0)).getUTCDate();
    }

    // FORMATTING

    addFormatToken('M', ['MM', 2], 'Mo', function () {
        return this.month() + 1;
    });

    addFormatToken('MMM', 0, 0, function (format) {
        return this.localeData().monthsShort(this, format);
    });

    addFormatToken('MMMM', 0, 0, function (format) {
        return this.localeData().months(this, format);
    });

    // ALIASES

    addUnitAlias('month', 'M');

    // PARSING

    addRegexToken('M',    match1to2);
    addRegexToken('MM',   match1to2, match2);
    addRegexToken('MMM',  function (isStrict, locale) {
        return locale.monthsShortRegex(isStrict);
    });
    addRegexToken('MMMM', function (isStrict, locale) {
        return locale.monthsRegex(isStrict);
    });

    addParseToken(['M', 'MM'], function (input, array) {
        array[MONTH] = toInt(input) - 1;
    });

    addParseToken(['MMM', 'MMMM'], function (input, array, config, token) {
        var month = config._locale.monthsParse(input, token, config._strict);
        // if we didn't find a month name, mark the date as invalid.
        if (month != null) {
            array[MONTH] = month;
        } else {
            getParsingFlags(config).invalidMonth = input;
        }
    });

    // LOCALES

    var MONTHS_IN_FORMAT = /D[oD]?(\[[^\[\]]*\]|\s+)+MMMM?/;
    var defaultLocaleMonths = 'January_February_March_April_May_June_July_August_September_October_November_December'.split('_');
    function localeMonths (m, format) {
        return isArray(this._months) ? this._months[m.month()] :
            this._months[MONTHS_IN_FORMAT.test(format) ? 'format' : 'standalone'][m.month()];
    }

    var defaultLocaleMonthsShort = 'Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec'.split('_');
    function localeMonthsShort (m, format) {
        return isArray(this._monthsShort) ? this._monthsShort[m.month()] :
            this._monthsShort[MONTHS_IN_FORMAT.test(format) ? 'format' : 'standalone'][m.month()];
    }

    function localeMonthsParse (monthName, format, strict) {
        var i, mom, regex;

        if (!this._monthsParse) {
            this._monthsParse = [];
            this._longMonthsParse = [];
            this._shortMonthsParse = [];
        }

        for (i = 0; i < 12; i++) {
            // make the regex if we don't have it already
            mom = create_utc__createUTC([2000, i]);
            if (strict && !this._longMonthsParse[i]) {
                this._longMonthsParse[i] = new RegExp('^' + this.months(mom, '').replace('.', '') + '$', 'i');
                this._shortMonthsParse[i] = new RegExp('^' + this.monthsShort(mom, '').replace('.', '') + '$', 'i');
            }
            if (!strict && !this._monthsParse[i]) {
                regex = '^' + this.months(mom, '') + '|^' + this.monthsShort(mom, '');
                this._monthsParse[i] = new RegExp(regex.replace('.', ''), 'i');
            }
            // test the regex
            if (strict && format === 'MMMM' && this._longMonthsParse[i].test(monthName)) {
                return i;
            } else if (strict && format === 'MMM' && this._shortMonthsParse[i].test(monthName)) {
                return i;
            } else if (!strict && this._monthsParse[i].test(monthName)) {
                return i;
            }
        }
    }

    // MOMENTS

    function setMonth (mom, value) {
        var dayOfMonth;

        if (!mom.isValid()) {
            // No op
            return mom;
        }

        // TODO: Move this out of here!
        if (typeof value === 'string') {
            value = mom.localeData().monthsParse(value);
            // TODO: Another silent failure?
            if (typeof value !== 'number') {
                return mom;
            }
        }

        dayOfMonth = Math.min(mom.date(), daysInMonth(mom.year(), value));
        mom._d['set' + (mom._isUTC ? 'UTC' : '') + 'Month'](value, dayOfMonth);
        return mom;
    }

    function getSetMonth (value) {
        if (value != null) {
            setMonth(this, value);
            utils_hooks__hooks.updateOffset(this, true);
            return this;
        } else {
            return get_set__get(this, 'Month');
        }
    }

    function getDaysInMonth () {
        return daysInMonth(this.year(), this.month());
    }

    var defaultMonthsShortRegex = matchWord;
    function monthsShortRegex (isStrict) {
        if (this._monthsParseExact) {
            if (!hasOwnProp(this, '_monthsRegex')) {
                computeMonthsParse.call(this);
            }
            if (isStrict) {
                return this._monthsShortStrictRegex;
            } else {
                return this._monthsShortRegex;
            }
        } else {
            return this._monthsShortStrictRegex && isStrict ?
                this._monthsShortStrictRegex : this._monthsShortRegex;
        }
    }

    var defaultMonthsRegex = matchWord;
    function monthsRegex (isStrict) {
        if (this._monthsParseExact) {
            if (!hasOwnProp(this, '_monthsRegex')) {
                computeMonthsParse.call(this);
            }
            if (isStrict) {
                return this._monthsStrictRegex;
            } else {
                return this._monthsRegex;
            }
        } else {
            return this._monthsStrictRegex && isStrict ?
                this._monthsStrictRegex : this._monthsRegex;
        }
    }

    function computeMonthsParse () {
        function cmpLenRev(a, b) {
            return b.length - a.length;
        }

        var shortPieces = [], longPieces = [], mixedPieces = [],
            i, mom;
        for (i = 0; i < 12; i++) {
            // make the regex if we don't have it already
            mom = create_utc__createUTC([2000, i]);
            shortPieces.push(this.monthsShort(mom, ''));
            longPieces.push(this.months(mom, ''));
            mixedPieces.push(this.months(mom, ''));
            mixedPieces.push(this.monthsShort(mom, ''));
        }
        // Sorting makes sure if one month (or abbr) is a prefix of another it
        // will match the longer piece.
        shortPieces.sort(cmpLenRev);
        longPieces.sort(cmpLenRev);
        mixedPieces.sort(cmpLenRev);
        for (i = 0; i < 12; i++) {
            shortPieces[i] = regexEscape(shortPieces[i]);
            longPieces[i] = regexEscape(longPieces[i]);
            mixedPieces[i] = regexEscape(mixedPieces[i]);
        }

        this._monthsRegex = new RegExp('^(' + mixedPieces.join('|') + ')', 'i');
        this._monthsShortRegex = this._monthsRegex;
        this._monthsStrictRegex = new RegExp('^(' + longPieces.join('|') + ')$', 'i');
        this._monthsShortStrictRegex = new RegExp('^(' + shortPieces.join('|') + ')$', 'i');
    }

    function checkOverflow (m) {
        var overflow;
        var a = m._a;

        if (a && getParsingFlags(m).overflow === -2) {
            overflow =
                a[MONTH]       < 0 || a[MONTH]       > 11  ? MONTH :
                a[DATE]        < 1 || a[DATE]        > daysInMonth(a[YEAR], a[MONTH]) ? DATE :
                a[HOUR]        < 0 || a[HOUR]        > 24 || (a[HOUR] === 24 && (a[MINUTE] !== 0 || a[SECOND] !== 0 || a[MILLISECOND] !== 0)) ? HOUR :
                a[MINUTE]      < 0 || a[MINUTE]      > 59  ? MINUTE :
                a[SECOND]      < 0 || a[SECOND]      > 59  ? SECOND :
                a[MILLISECOND] < 0 || a[MILLISECOND] > 999 ? MILLISECOND :
                -1;

            if (getParsingFlags(m)._overflowDayOfYear && (overflow < YEAR || overflow > DATE)) {
                overflow = DATE;
            }
            if (getParsingFlags(m)._overflowWeeks && overflow === -1) {
                overflow = WEEK;
            }
            if (getParsingFlags(m)._overflowWeekday && overflow === -1) {
                overflow = WEEKDAY;
            }

            getParsingFlags(m).overflow = overflow;
        }

        return m;
    }

    function warn(msg) {
        if (utils_hooks__hooks.suppressDeprecationWarnings === false &&
                (typeof console !==  'undefined') && console.warn) {
            console.warn('Deprecation warning: ' + msg);
        }
    }

    function deprecate(msg, fn) {
        var firstTime = true;

        return extend(function () {
            if (firstTime) {
                warn(msg + '\nArguments: ' + Array.prototype.slice.call(arguments).join(', ') + '\n' + (new Error()).stack);
                firstTime = false;
            }
            return fn.apply(this, arguments);
        }, fn);
    }

    var deprecations = {};

    function deprecateSimple(name, msg) {
        if (!deprecations[name]) {
            warn(msg);
            deprecations[name] = true;
        }
    }

    utils_hooks__hooks.suppressDeprecationWarnings = false;

    // iso 8601 regex
    // 0000-00-00 0000-W00 or 0000-W00-0 + T + 00 or 00:00 or 00:00:00 or 00:00:00.000 + +00:00 or +0000 or +00)
    var extendedIsoRegex = /^\s*((?:[+-]\d{6}|\d{4})-(?:\d\d-\d\d|W\d\d-\d|W\d\d|\d\d\d|\d\d))(?:(T| )(\d\d(?::\d\d(?::\d\d(?:[.,]\d+)?)?)?)([\+\-]\d\d(?::?\d\d)?|\s*Z)?)?/;
    var basicIsoRegex = /^\s*((?:[+-]\d{6}|\d{4})(?:\d\d\d\d|W\d\d\d|W\d\d|\d\d\d|\d\d))(?:(T| )(\d\d(?:\d\d(?:\d\d(?:[.,]\d+)?)?)?)([\+\-]\d\d(?::?\d\d)?|\s*Z)?)?/;

    var tzRegex = /Z|[+-]\d\d(?::?\d\d)?/;

    var isoDates = [
        ['YYYYYY-MM-DD', /[+-]\d{6}-\d\d-\d\d/],
        ['YYYY-MM-DD', /\d{4}-\d\d-\d\d/],
        ['GGGG-[W]WW-E', /\d{4}-W\d\d-\d/],
        ['GGGG-[W]WW', /\d{4}-W\d\d/, false],
        ['YYYY-DDD', /\d{4}-\d{3}/],
        ['YYYY-MM', /\d{4}-\d\d/, false],
        ['YYYYYYMMDD', /[+-]\d{10}/],
        ['YYYYMMDD', /\d{8}/],
        // YYYYMM is NOT allowed by the standard
        ['GGGG[W]WWE', /\d{4}W\d{3}/],
        ['GGGG[W]WW', /\d{4}W\d{2}/, false],
        ['YYYYDDD', /\d{7}/]
    ];

    // iso time formats and regexes
    var isoTimes = [
        ['HH:mm:ss.SSSS', /\d\d:\d\d:\d\d\.\d+/],
        ['HH:mm:ss,SSSS', /\d\d:\d\d:\d\d,\d+/],
        ['HH:mm:ss', /\d\d:\d\d:\d\d/],
        ['HH:mm', /\d\d:\d\d/],
        ['HHmmss.SSSS', /\d\d\d\d\d\d\.\d+/],
        ['HHmmss,SSSS', /\d\d\d\d\d\d,\d+/],
        ['HHmmss', /\d\d\d\d\d\d/],
        ['HHmm', /\d\d\d\d/],
        ['HH', /\d\d/]
    ];

    var aspNetJsonRegex = /^\/?Date\((\-?\d+)/i;

    // date from iso format
    function configFromISO(config) {
        var i, l,
            string = config._i,
            match = extendedIsoRegex.exec(string) || basicIsoRegex.exec(string),
            allowTime, dateFormat, timeFormat, tzFormat;

        if (match) {
            getParsingFlags(config).iso = true;

            for (i = 0, l = isoDates.length; i < l; i++) {
                if (isoDates[i][1].exec(match[1])) {
                    dateFormat = isoDates[i][0];
                    allowTime = isoDates[i][2] !== false;
                    break;
                }
            }
            if (dateFormat == null) {
                config._isValid = false;
                return;
            }
            if (match[3]) {
                for (i = 0, l = isoTimes.length; i < l; i++) {
                    if (isoTimes[i][1].exec(match[3])) {
                        // match[2] should be 'T' or space
                        timeFormat = (match[2] || ' ') + isoTimes[i][0];
                        break;
                    }
                }
                if (timeFormat == null) {
                    config._isValid = false;
                    return;
                }
            }
            if (!allowTime && timeFormat != null) {
                config._isValid = false;
                return;
            }
            if (match[4]) {
                if (tzRegex.exec(match[4])) {
                    tzFormat = 'Z';
                } else {
                    config._isValid = false;
                    return;
                }
            }
            config._f = dateFormat + (timeFormat || '') + (tzFormat || '');
            configFromStringAndFormat(config);
        } else {
            config._isValid = false;
        }
    }

    // date from iso format or fallback
    function configFromString(config) {
        var matched = aspNetJsonRegex.exec(config._i);

        if (matched !== null) {
            config._d = new Date(+matched[1]);
            return;
        }

        configFromISO(config);
        if (config._isValid === false) {
            delete config._isValid;
            utils_hooks__hooks.createFromInputFallback(config);
        }
    }

    utils_hooks__hooks.createFromInputFallback = deprecate(
        'moment construction falls back to js Date. This is ' +
        'discouraged and will be removed in upcoming major ' +
        'release. Please refer to ' +
        'https://github.com/moment/moment/issues/1407 for more info.',
        function (config) {
            config._d = new Date(config._i + (config._useUTC ? ' UTC' : ''));
        }
    );

    function createDate (y, m, d, h, M, s, ms) {
        //can't just apply() to create a date:
        //http://stackoverflow.com/questions/181348/instantiating-a-javascript-object-by-calling-prototype-constructor-apply
        var date = new Date(y, m, d, h, M, s, ms);

        //the date constructor remaps years 0-99 to 1900-1999
        if (y < 100 && y >= 0 && isFinite(date.getFullYear())) {
            date.setFullYear(y);
        }
        return date;
    }

    function createUTCDate (y) {
        var date = new Date(Date.UTC.apply(null, arguments));

        //the Date.UTC function remaps years 0-99 to 1900-1999
        if (y < 100 && y >= 0 && isFinite(date.getUTCFullYear())) {
            date.setUTCFullYear(y);
        }
        return date;
    }

    // FORMATTING

    addFormatToken('Y', 0, 0, function () {
        var y = this.year();
        return y <= 9999 ? '' + y : '+' + y;
    });

    addFormatToken(0, ['YY', 2], 0, function () {
        return this.year() % 100;
    });

    addFormatToken(0, ['YYYY',   4],       0, 'year');
    addFormatToken(0, ['YYYYY',  5],       0, 'year');
    addFormatToken(0, ['YYYYYY', 6, true], 0, 'year');

    // ALIASES

    addUnitAlias('year', 'y');

    // PARSING

    addRegexToken('Y',      matchSigned);
    addRegexToken('YY',     match1to2, match2);
    addRegexToken('YYYY',   match1to4, match4);
    addRegexToken('YYYYY',  match1to6, match6);
    addRegexToken('YYYYYY', match1to6, match6);

    addParseToken(['YYYYY', 'YYYYYY'], YEAR);
    addParseToken('YYYY', function (input, array) {
        array[YEAR] = input.length === 2 ? utils_hooks__hooks.parseTwoDigitYear(input) : toInt(input);
    });
    addParseToken('YY', function (input, array) {
        array[YEAR] = utils_hooks__hooks.parseTwoDigitYear(input);
    });
    addParseToken('Y', function (input, array) {
        array[YEAR] = parseInt(input, 10);
    });

    // HELPERS

    function daysInYear(year) {
        return isLeapYear(year) ? 366 : 365;
    }

    function isLeapYear(year) {
        return (year % 4 === 0 && year % 100 !== 0) || year % 400 === 0;
    }

    // HOOKS

    utils_hooks__hooks.parseTwoDigitYear = function (input) {
        return toInt(input) + (toInt(input) > 68 ? 1900 : 2000);
    };

    // MOMENTS

    var getSetYear = makeGetSet('FullYear', false);

    function getIsLeapYear () {
        return isLeapYear(this.year());
    }

    // start-of-first-week - start-of-year
    function firstWeekOffset(year, dow, doy) {
        var // first-week day -- which january is always in the first week (4 for iso, 1 for other)
            fwd = 7 + dow - doy,
            // first-week day local weekday -- which local weekday is fwd
            fwdlw = (7 + createUTCDate(year, 0, fwd).getUTCDay() - dow) % 7;

        return -fwdlw + fwd - 1;
    }

    //http://en.wikipedia.org/wiki/ISO_week_date#Calculating_a_date_given_the_year.2C_week_number_and_weekday
    function dayOfYearFromWeeks(year, week, weekday, dow, doy) {
        var localWeekday = (7 + weekday - dow) % 7,
            weekOffset = firstWeekOffset(year, dow, doy),
            dayOfYear = 1 + 7 * (week - 1) + localWeekday + weekOffset,
            resYear, resDayOfYear;

        if (dayOfYear <= 0) {
            resYear = year - 1;
            resDayOfYear = daysInYear(resYear) + dayOfYear;
        } else if (dayOfYear > daysInYear(year)) {
            resYear = year + 1;
            resDayOfYear = dayOfYear - daysInYear(year);
        } else {
            resYear = year;
            resDayOfYear = dayOfYear;
        }

        return {
            year: resYear,
            dayOfYear: resDayOfYear
        };
    }

    function weekOfYear(mom, dow, doy) {
        var weekOffset = firstWeekOffset(mom.year(), dow, doy),
            week = Math.floor((mom.dayOfYear() - weekOffset - 1) / 7) + 1,
            resWeek, resYear;

        if (week < 1) {
            resYear = mom.year() - 1;
            resWeek = week + weeksInYear(resYear, dow, doy);
        } else if (week > weeksInYear(mom.year(), dow, doy)) {
            resWeek = week - weeksInYear(mom.year(), dow, doy);
            resYear = mom.year() + 1;
        } else {
            resYear = mom.year();
            resWeek = week;
        }

        return {
            week: resWeek,
            year: resYear
        };
    }

    function weeksInYear(year, dow, doy) {
        var weekOffset = firstWeekOffset(year, dow, doy),
            weekOffsetNext = firstWeekOffset(year + 1, dow, doy);
        return (daysInYear(year) - weekOffset + weekOffsetNext) / 7;
    }

    // Pick the first defined of two or three arguments.
    function defaults(a, b, c) {
        if (a != null) {
            return a;
        }
        if (b != null) {
            return b;
        }
        return c;
    }

    function currentDateArray(config) {
        // hooks is actually the exported moment object
        var nowValue = new Date(utils_hooks__hooks.now());
        if (config._useUTC) {
            return [nowValue.getUTCFullYear(), nowValue.getUTCMonth(), nowValue.getUTCDate()];
        }
        return [nowValue.getFullYear(), nowValue.getMonth(), nowValue.getDate()];
    }

    // convert an array to a date.
    // the array should mirror the parameters below
    // note: all values past the year are optional and will default to the lowest possible value.
    // [year, month, day , hour, minute, second, millisecond]
    function configFromArray (config) {
        var i, date, input = [], currentDate, yearToUse;

        if (config._d) {
            return;
        }

        currentDate = currentDateArray(config);

        //compute day of the year from weeks and weekdays
        if (config._w && config._a[DATE] == null && config._a[MONTH] == null) {
            dayOfYearFromWeekInfo(config);
        }

        //if the day of the year is set, figure out what it is
        if (config._dayOfYear) {
            yearToUse = defaults(config._a[YEAR], currentDate[YEAR]);

            if (config._dayOfYear > daysInYear(yearToUse)) {
                getParsingFlags(config)._overflowDayOfYear = true;
            }

            date = createUTCDate(yearToUse, 0, config._dayOfYear);
            config._a[MONTH] = date.getUTCMonth();
            config._a[DATE] = date.getUTCDate();
        }

        // Default to current date.
        // * if no year, month, day of month are given, default to today
        // * if day of month is given, default month and year
        // * if month is given, default only year
        // * if year is given, don't default anything
        for (i = 0; i < 3 && config._a[i] == null; ++i) {
            config._a[i] = input[i] = currentDate[i];
        }

        // Zero out whatever was not defaulted, including time
        for (; i < 7; i++) {
            config._a[i] = input[i] = (config._a[i] == null) ? (i === 2 ? 1 : 0) : config._a[i];
        }

        // Check for 24:00:00.000
        if (config._a[HOUR] === 24 &&
                config._a[MINUTE] === 0 &&
                config._a[SECOND] === 0 &&
                config._a[MILLISECOND] === 0) {
            config._nextDay = true;
            config._a[HOUR] = 0;
        }

        config._d = (config._useUTC ? createUTCDate : createDate).apply(null, input);
        // Apply timezone offset from input. The actual utcOffset can be changed
        // with parseZone.
        if (config._tzm != null) {
            config._d.setUTCMinutes(config._d.getUTCMinutes() - config._tzm);
        }

        if (config._nextDay) {
            config._a[HOUR] = 24;
        }
    }

    function dayOfYearFromWeekInfo(config) {
        var w, weekYear, week, weekday, dow, doy, temp, weekdayOverflow;

        w = config._w;
        if (w.GG != null || w.W != null || w.E != null) {
            dow = 1;
            doy = 4;

            // TODO: We need to take the current isoWeekYear, but that depends on
            // how we interpret now (local, utc, fixed offset). So create
            // a now version of current config (take local/utc/offset flags, and
            // create now).
            weekYear = defaults(w.GG, config._a[YEAR], weekOfYear(local__createLocal(), 1, 4).year);
            week = defaults(w.W, 1);
            weekday = defaults(w.E, 1);
            if (weekday < 1 || weekday > 7) {
                weekdayOverflow = true;
            }
        } else {
            dow = config._locale._week.dow;
            doy = config._locale._week.doy;

            weekYear = defaults(w.gg, config._a[YEAR], weekOfYear(local__createLocal(), dow, doy).year);
            week = defaults(w.w, 1);

            if (w.d != null) {
                // weekday -- low day numbers are considered next week
                weekday = w.d;
                if (weekday < 0 || weekday > 6) {
                    weekdayOverflow = true;
                }
            } else if (w.e != null) {
                // local weekday -- counting starts from begining of week
                weekday = w.e + dow;
                if (w.e < 0 || w.e > 6) {
                    weekdayOverflow = true;
                }
            } else {
                // default to begining of week
                weekday = dow;
            }
        }
        if (week < 1 || week > weeksInYear(weekYear, dow, doy)) {
            getParsingFlags(config)._overflowWeeks = true;
        } else if (weekdayOverflow != null) {
            getParsingFlags(config)._overflowWeekday = true;
        } else {
            temp = dayOfYearFromWeeks(weekYear, week, weekday, dow, doy);
            config._a[YEAR] = temp.year;
            config._dayOfYear = temp.dayOfYear;
        }
    }

    // constant that refers to the ISO standard
    utils_hooks__hooks.ISO_8601 = function () {};

    // date from string and format string
    function configFromStringAndFormat(config) {
        // TODO: Move this to another part of the creation flow to prevent circular deps
        if (config._f === utils_hooks__hooks.ISO_8601) {
            configFromISO(config);
            return;
        }

        config._a = [];
        getParsingFlags(config).empty = true;

        // This array is used to make a Date, either with `new Date` or `Date.UTC`
        var string = '' + config._i,
            i, parsedInput, tokens, token, skipped,
            stringLength = string.length,
            totalParsedInputLength = 0;

        tokens = expandFormat(config._f, config._locale).match(formattingTokens) || [];

        for (i = 0; i < tokens.length; i++) {
            token = tokens[i];
            parsedInput = (string.match(getParseRegexForToken(token, config)) || [])[0];
            // console.log('token', token, 'parsedInput', parsedInput,
            //         'regex', getParseRegexForToken(token, config));
            if (parsedInput) {
                skipped = string.substr(0, string.indexOf(parsedInput));
                if (skipped.length > 0) {
                    getParsingFlags(config).unusedInput.push(skipped);
                }
                string = string.slice(string.indexOf(parsedInput) + parsedInput.length);
                totalParsedInputLength += parsedInput.length;
            }
            // don't parse if it's not a known token
            if (formatTokenFunctions[token]) {
                if (parsedInput) {
                    getParsingFlags(config).empty = false;
                }
                else {
                    getParsingFlags(config).unusedTokens.push(token);
                }
                addTimeToArrayFromToken(token, parsedInput, config);
            }
            else if (config._strict && !parsedInput) {
                getParsingFlags(config).unusedTokens.push(token);
            }
        }

        // add remaining unparsed input length to the string
        getParsingFlags(config).charsLeftOver = stringLength - totalParsedInputLength;
        if (string.length > 0) {
            getParsingFlags(config).unusedInput.push(string);
        }

        // clear _12h flag if hour is <= 12
        if (getParsingFlags(config).bigHour === true &&
                config._a[HOUR] <= 12 &&
                config._a[HOUR] > 0) {
            getParsingFlags(config).bigHour = undefined;
        }
        // handle meridiem
        config._a[HOUR] = meridiemFixWrap(config._locale, config._a[HOUR], config._meridiem);

        configFromArray(config);
        checkOverflow(config);
    }


    function meridiemFixWrap (locale, hour, meridiem) {
        var isPm;

        if (meridiem == null) {
            // nothing to do
            return hour;
        }
        if (locale.meridiemHour != null) {
            return locale.meridiemHour(hour, meridiem);
        } else if (locale.isPM != null) {
            // Fallback
            isPm = locale.isPM(meridiem);
            if (isPm && hour < 12) {
                hour += 12;
            }
            if (!isPm && hour === 12) {
                hour = 0;
            }
            return hour;
        } else {
            // this is not supposed to happen
            return hour;
        }
    }

    // date from string and array of format strings
    function configFromStringAndArray(config) {
        var tempConfig,
            bestMoment,

            scoreToBeat,
            i,
            currentScore;

        if (config._f.length === 0) {
            getParsingFlags(config).invalidFormat = true;
            config._d = new Date(NaN);
            return;
        }

        for (i = 0; i < config._f.length; i++) {
            currentScore = 0;
            tempConfig = copyConfig({}, config);
            if (config._useUTC != null) {
                tempConfig._useUTC = config._useUTC;
            }
            tempConfig._f = config._f[i];
            configFromStringAndFormat(tempConfig);

            if (!valid__isValid(tempConfig)) {
                continue;
            }

            // if there is any input that was not parsed add a penalty for that format
            currentScore += getParsingFlags(tempConfig).charsLeftOver;

            //or tokens
            currentScore += getParsingFlags(tempConfig).unusedTokens.length * 10;

            getParsingFlags(tempConfig).score = currentScore;

            if (scoreToBeat == null || currentScore < scoreToBeat) {
                scoreToBeat = currentScore;
                bestMoment = tempConfig;
            }
        }

        extend(config, bestMoment || tempConfig);
    }

    function configFromObject(config) {
        if (config._d) {
            return;
        }

        var i = normalizeObjectUnits(config._i);
        config._a = map([i.year, i.month, i.day || i.date, i.hour, i.minute, i.second, i.millisecond], function (obj) {
            return obj && parseInt(obj, 10);
        });

        configFromArray(config);
    }

    function createFromConfig (config) {
        var res = new Moment(checkOverflow(prepareConfig(config)));
        if (res._nextDay) {
            // Adding is smart enough around DST
            res.add(1, 'd');
            res._nextDay = undefined;
        }

        return res;
    }

    function prepareConfig (config) {
        var input = config._i,
            format = config._f;

        config._locale = config._locale || locale_locales__getLocale(config._l);

        if (input === null || (format === undefined && input === '')) {
            return valid__createInvalid({nullInput: true});
        }

        if (typeof input === 'string') {
            config._i = input = config._locale.preparse(input);
        }

        if (isMoment(input)) {
            return new Moment(checkOverflow(input));
        } else if (isArray(format)) {
            configFromStringAndArray(config);
        } else if (format) {
            configFromStringAndFormat(config);
        } else if (isDate(input)) {
            config._d = input;
        } else {
            configFromInput(config);
        }

        if (!valid__isValid(config)) {
            config._d = null;
        }

        return config;
    }

    function configFromInput(config) {
        var input = config._i;
        if (input === undefined) {
            config._d = new Date(utils_hooks__hooks.now());
        } else if (isDate(input)) {
            config._d = new Date(+input);
        } else if (typeof input === 'string') {
            configFromString(config);
        } else if (isArray(input)) {
            config._a = map(input.slice(0), function (obj) {
                return parseInt(obj, 10);
            });
            configFromArray(config);
        } else if (typeof(input) === 'object') {
            configFromObject(config);
        } else if (typeof(input) === 'number') {
            // from milliseconds
            config._d = new Date(input);
        } else {
            utils_hooks__hooks.createFromInputFallback(config);
        }
    }

    function createLocalOrUTC (input, format, locale, strict, isUTC) {
        var c = {};

        if (typeof(locale) === 'boolean') {
            strict = locale;
            locale = undefined;
        }
        // object construction must be done this way.
        // https://github.com/moment/moment/issues/1423
        c._isAMomentObject = true;
        c._useUTC = c._isUTC = isUTC;
        c._l = locale;
        c._i = input;
        c._f = format;
        c._strict = strict;

        return createFromConfig(c);
    }

    function local__createLocal (input, format, locale, strict) {
        return createLocalOrUTC(input, format, locale, strict, false);
    }

    var prototypeMin = deprecate(
         'moment().min is deprecated, use moment.min instead. https://github.com/moment/moment/issues/1548',
         function () {
             var other = local__createLocal.apply(null, arguments);
             if (this.isValid() && other.isValid()) {
                 return other < this ? this : other;
             } else {
                 return valid__createInvalid();
             }
         }
     );

    var prototypeMax = deprecate(
        'moment().max is deprecated, use moment.max instead. https://github.com/moment/moment/issues/1548',
        function () {
            var other = local__createLocal.apply(null, arguments);
            if (this.isValid() && other.isValid()) {
                return other > this ? this : other;
            } else {
                return valid__createInvalid();
            }
        }
    );

    // Pick a moment m from moments so that m[fn](other) is true for all
    // other. This relies on the function fn to be transitive.
    //
    // moments should either be an array of moment objects or an array, whose
    // first element is an array of moment objects.
    function pickBy(fn, moments) {
        var res, i;
        if (moments.length === 1 && isArray(moments[0])) {
            moments = moments[0];
        }
        if (!moments.length) {
            return local__createLocal();
        }
        res = moments[0];
        for (i = 1; i < moments.length; ++i) {
            if (!moments[i].isValid() || moments[i][fn](res)) {
                res = moments[i];
            }
        }
        return res;
    }

    // TODO: Use [].sort instead?
    function min () {
        var args = [].slice.call(arguments, 0);

        return pickBy('isBefore', args);
    }

    function max () {
        var args = [].slice.call(arguments, 0);

        return pickBy('isAfter', args);
    }

    var now = function () {
        return Date.now ? Date.now() : +(new Date());
    };

    function Duration (duration) {
        var normalizedInput = normalizeObjectUnits(duration),
            years = normalizedInput.year || 0,
            quarters = normalizedInput.quarter || 0,
            months = normalizedInput.month || 0,
            weeks = normalizedInput.week || 0,
            days = normalizedInput.day || 0,
            hours = normalizedInput.hour || 0,
            minutes = normalizedInput.minute || 0,
            seconds = normalizedInput.second || 0,
            milliseconds = normalizedInput.millisecond || 0;

        // representation for dateAddRemove
        this._milliseconds = +milliseconds +
            seconds * 1e3 + // 1000
            minutes * 6e4 + // 1000 * 60
            hours * 36e5; // 1000 * 60 * 60
        // Because of dateAddRemove treats 24 hours as different from a
        // day when working around DST, we need to store them separately
        this._days = +days +
            weeks * 7;
        // It is impossible translate months into days without knowing
        // which months you are are talking about, so we have to store
        // it separately.
        this._months = +months +
            quarters * 3 +
            years * 12;

        this._data = {};

        this._locale = locale_locales__getLocale();

        this._bubble();
    }

    function isDuration (obj) {
        return obj instanceof Duration;
    }

    // FORMATTING

    function offset (token, separator) {
        addFormatToken(token, 0, 0, function () {
            var offset = this.utcOffset();
            var sign = '+';
            if (offset < 0) {
                offset = -offset;
                sign = '-';
            }
            return sign + zeroFill(~~(offset / 60), 2) + separator + zeroFill(~~(offset) % 60, 2);
        });
    }

    offset('Z', ':');
    offset('ZZ', '');

    // PARSING

    addRegexToken('Z',  matchShortOffset);
    addRegexToken('ZZ', matchShortOffset);
    addParseToken(['Z', 'ZZ'], function (input, array, config) {
        config._useUTC = true;
        config._tzm = offsetFromString(matchShortOffset, input);
    });

    // HELPERS

    // timezone chunker
    // '+10:00' > ['10',  '00']
    // '-1530'  > ['-15', '30']
    var chunkOffset = /([\+\-]|\d\d)/gi;

    function offsetFromString(matcher, string) {
        var matches = ((string || '').match(matcher) || []);
        var chunk   = matches[matches.length - 1] || [];
        var parts   = (chunk + '').match(chunkOffset) || ['-', 0, 0];
        var minutes = +(parts[1] * 60) + toInt(parts[2]);

        return parts[0] === '+' ? minutes : -minutes;
    }

    // Return a moment from input, that is local/utc/zone equivalent to model.
    function cloneWithOffset(input, model) {
        var res, diff;
        if (model._isUTC) {
            res = model.clone();
            diff = (isMoment(input) || isDate(input) ? +input : +local__createLocal(input)) - (+res);
            // Use low-level api, because this fn is low-level api.
            res._d.setTime(+res._d + diff);
            utils_hooks__hooks.updateOffset(res, false);
            return res;
        } else {
            return local__createLocal(input).local();
        }
    }

    function getDateOffset (m) {
        // On Firefox.24 Date#getTimezoneOffset returns a floating point.
        // https://github.com/moment/moment/pull/1871
        return -Math.round(m._d.getTimezoneOffset() / 15) * 15;
    }

    // HOOKS

    // This function will be called whenever a moment is mutated.
    // It is intended to keep the offset in sync with the timezone.
    utils_hooks__hooks.updateOffset = function () {};

    // MOMENTS

    // keepLocalTime = true means only change the timezone, without
    // affecting the local hour. So 5:31:26 +0300 --[utcOffset(2, true)]-->
    // 5:31:26 +0200 It is possible that 5:31:26 doesn't exist with offset
    // +0200, so we adjust the time as needed, to be valid.
    //
    // Keeping the time actually adds/subtracts (one hour)
    // from the actual represented time. That is why we call updateOffset
    // a second time. In case it wants us to change the offset again
    // _changeInProgress == true case, then we have to adjust, because
    // there is no such time in the given timezone.
    function getSetOffset (input, keepLocalTime) {
        var offset = this._offset || 0,
            localAdjust;
        if (!this.isValid()) {
            return input != null ? this : NaN;
        }
        if (input != null) {
            if (typeof input === 'string') {
                input = offsetFromString(matchShortOffset, input);
            } else if (Math.abs(input) < 16) {
                input = input * 60;
            }
            if (!this._isUTC && keepLocalTime) {
                localAdjust = getDateOffset(this);
            }
            this._offset = input;
            this._isUTC = true;
            if (localAdjust != null) {
                this.add(localAdjust, 'm');
            }
            if (offset !== input) {
                if (!keepLocalTime || this._changeInProgress) {
                    add_subtract__addSubtract(this, create__createDuration(input - offset, 'm'), 1, false);
                } else if (!this._changeInProgress) {
                    this._changeInProgress = true;
                    utils_hooks__hooks.updateOffset(this, true);
                    this._changeInProgress = null;
                }
            }
            return this;
        } else {
            return this._isUTC ? offset : getDateOffset(this);
        }
    }

    function getSetZone (input, keepLocalTime) {
        if (input != null) {
            if (typeof input !== 'string') {
                input = -input;
            }

            this.utcOffset(input, keepLocalTime);

            return this;
        } else {
            return -this.utcOffset();
        }
    }

    function setOffsetToUTC (keepLocalTime) {
        return this.utcOffset(0, keepLocalTime);
    }

    function setOffsetToLocal (keepLocalTime) {
        if (this._isUTC) {
            this.utcOffset(0, keepLocalTime);
            this._isUTC = false;

            if (keepLocalTime) {
                this.subtract(getDateOffset(this), 'm');
            }
        }
        return this;
    }

    function setOffsetToParsedOffset () {
        if (this._tzm) {
            this.utcOffset(this._tzm);
        } else if (typeof this._i === 'string') {
            this.utcOffset(offsetFromString(matchOffset, this._i));
        }
        return this;
    }

    function hasAlignedHourOffset (input) {
        if (!this.isValid()) {
            return false;
        }
        input = input ? local__createLocal(input).utcOffset() : 0;

        return (this.utcOffset() - input) % 60 === 0;
    }

    function isDaylightSavingTime () {
        return (
            this.utcOffset() > this.clone().month(0).utcOffset() ||
            this.utcOffset() > this.clone().month(5).utcOffset()
        );
    }

    function isDaylightSavingTimeShifted () {
        if (!isUndefined(this._isDSTShifted)) {
            return this._isDSTShifted;
        }

        var c = {};

        copyConfig(c, this);
        c = prepareConfig(c);

        if (c._a) {
            var other = c._isUTC ? create_utc__createUTC(c._a) : local__createLocal(c._a);
            this._isDSTShifted = this.isValid() &&
                compareArrays(c._a, other.toArray()) > 0;
        } else {
            this._isDSTShifted = false;
        }

        return this._isDSTShifted;
    }

    function isLocal () {
        return this.isValid() ? !this._isUTC : false;
    }

    function isUtcOffset () {
        return this.isValid() ? this._isUTC : false;
    }

    function isUtc () {
        return this.isValid() ? this._isUTC && this._offset === 0 : false;
    }

    // ASP.NET json date format regex
    var aspNetRegex = /^(\-)?(?:(\d*)[. ])?(\d+)\:(\d+)(?:\:(\d+)\.?(\d{3})?\d*)?$/;

    // from http://docs.closure-library.googlecode.com/git/closure_goog_date_date.js.source.html
    // somewhat more in line with 4.4.3.2 2004 spec, but allows decimal anywhere
    var isoRegex = /^(-)?P(?:(?:([0-9,.]*)Y)?(?:([0-9,.]*)M)?(?:([0-9,.]*)D)?(?:T(?:([0-9,.]*)H)?(?:([0-9,.]*)M)?(?:([0-9,.]*)S)?)?|([0-9,.]*)W)$/;

    function create__createDuration (input, key) {
        var duration = input,
            // matching against regexp is expensive, do it on demand
            match = null,
            sign,
            ret,
            diffRes;

        if (isDuration(input)) {
            duration = {
                ms : input._milliseconds,
                d  : input._days,
                M  : input._months
            };
        } else if (typeof input === 'number') {
            duration = {};
            if (key) {
                duration[key] = input;
            } else {
                duration.milliseconds = input;
            }
        } else if (!!(match = aspNetRegex.exec(input))) {
            sign = (match[1] === '-') ? -1 : 1;
            duration = {
                y  : 0,
                d  : toInt(match[DATE])        * sign,
                h  : toInt(match[HOUR])        * sign,
                m  : toInt(match[MINUTE])      * sign,
                s  : toInt(match[SECOND])      * sign,
                ms : toInt(match[MILLISECOND]) * sign
            };
        } else if (!!(match = isoRegex.exec(input))) {
            sign = (match[1] === '-') ? -1 : 1;
            duration = {
                y : parseIso(match[2], sign),
                M : parseIso(match[3], sign),
                d : parseIso(match[4], sign),
                h : parseIso(match[5], sign),
                m : parseIso(match[6], sign),
                s : parseIso(match[7], sign),
                w : parseIso(match[8], sign)
            };
        } else if (duration == null) {// checks for null or undefined
            duration = {};
        } else if (typeof duration === 'object' && ('from' in duration || 'to' in duration)) {
            diffRes = momentsDifference(local__createLocal(duration.from), local__createLocal(duration.to));

            duration = {};
            duration.ms = diffRes.milliseconds;
            duration.M = diffRes.months;
        }

        ret = new Duration(duration);

        if (isDuration(input) && hasOwnProp(input, '_locale')) {
            ret._locale = input._locale;
        }

        return ret;
    }

    create__createDuration.fn = Duration.prototype;

    function parseIso (inp, sign) {
        // We'd normally use ~~inp for this, but unfortunately it also
        // converts floats to ints.
        // inp may be undefined, so careful calling replace on it.
        var res = inp && parseFloat(inp.replace(',', '.'));
        // apply sign while we're at it
        return (isNaN(res) ? 0 : res) * sign;
    }

    function positiveMomentsDifference(base, other) {
        var res = {milliseconds: 0, months: 0};

        res.months = other.month() - base.month() +
            (other.year() - base.year()) * 12;
        if (base.clone().add(res.months, 'M').isAfter(other)) {
            --res.months;
        }

        res.milliseconds = +other - +(base.clone().add(res.months, 'M'));

        return res;
    }

    function momentsDifference(base, other) {
        var res;
        if (!(base.isValid() && other.isValid())) {
            return {milliseconds: 0, months: 0};
        }

        other = cloneWithOffset(other, base);
        if (base.isBefore(other)) {
            res = positiveMomentsDifference(base, other);
        } else {
            res = positiveMomentsDifference(other, base);
            res.milliseconds = -res.milliseconds;
            res.months = -res.months;
        }

        return res;
    }

    // TODO: remove 'name' arg after deprecation is removed
    function createAdder(direction, name) {
        return function (val, period) {
            var dur, tmp;
            //invert the arguments, but complain about it
            if (period !== null && !isNaN(+period)) {
                deprecateSimple(name, 'moment().' + name  + '(period, number) is deprecated. Please use moment().' + name + '(number, period).');
                tmp = val; val = period; period = tmp;
            }

            val = typeof val === 'string' ? +val : val;
            dur = create__createDuration(val, period);
            add_subtract__addSubtract(this, dur, direction);
            return this;
        };
    }

    function add_subtract__addSubtract (mom, duration, isAdding, updateOffset) {
        var milliseconds = duration._milliseconds,
            days = duration._days,
            months = duration._months;

        if (!mom.isValid()) {
            // No op
            return;
        }

        updateOffset = updateOffset == null ? true : updateOffset;

        if (milliseconds) {
            mom._d.setTime(+mom._d + milliseconds * isAdding);
        }
        if (days) {
            get_set__set(mom, 'Date', get_set__get(mom, 'Date') + days * isAdding);
        }
        if (months) {
            setMonth(mom, get_set__get(mom, 'Month') + months * isAdding);
        }
        if (updateOffset) {
            utils_hooks__hooks.updateOffset(mom, days || months);
        }
    }

    var add_subtract__add      = createAdder(1, 'add');
    var add_subtract__subtract = createAdder(-1, 'subtract');

    function moment_calendar__calendar (time, formats) {
        // We want to compare the start of today, vs this.
        // Getting start-of-today depends on whether we're local/utc/offset or not.
        var now = time || local__createLocal(),
            sod = cloneWithOffset(now, this).startOf('day'),
            diff = this.diff(sod, 'days', true),
            format = diff < -6 ? 'sameElse' :
                diff < -1 ? 'lastWeek' :
                diff < 0 ? 'lastDay' :
                diff < 1 ? 'sameDay' :
                diff < 2 ? 'nextDay' :
                diff < 7 ? 'nextWeek' : 'sameElse';

        var output = formats && (isFunction(formats[format]) ? formats[format]() : formats[format]);

        return this.format(output || this.localeData().calendar(format, this, local__createLocal(now)));
    }

    function clone () {
        return new Moment(this);
    }

    function isAfter (input, units) {
        var localInput = isMoment(input) ? input : local__createLocal(input);
        if (!(this.isValid() && localInput.isValid())) {
            return false;
        }
        units = normalizeUnits(!isUndefined(units) ? units : 'millisecond');
        if (units === 'millisecond') {
            return +this > +localInput;
        } else {
            return +localInput < +this.clone().startOf(units);
        }
    }

    function isBefore (input, units) {
        var localInput = isMoment(input) ? input : local__createLocal(input);
        if (!(this.isValid() && localInput.isValid())) {
            return false;
        }
        units = normalizeUnits(!isUndefined(units) ? units : 'millisecond');
        if (units === 'millisecond') {
            return +this < +localInput;
        } else {
            return +this.clone().endOf(units) < +localInput;
        }
    }

    function isBetween (from, to, units) {
        return this.isAfter(from, units) && this.isBefore(to, units);
    }

    function isSame (input, units) {
        var localInput = isMoment(input) ? input : local__createLocal(input),
            inputMs;
        if (!(this.isValid() && localInput.isValid())) {
            return false;
        }
        units = normalizeUnits(units || 'millisecond');
        if (units === 'millisecond') {
            return +this === +localInput;
        } else {
            inputMs = +localInput;
            return +(this.clone().startOf(units)) <= inputMs && inputMs <= +(this.clone().endOf(units));
        }
    }

    function isSameOrAfter (input, units) {
        return this.isSame(input, units) || this.isAfter(input,units);
    }

    function isSameOrBefore (input, units) {
        return this.isSame(input, units) || this.isBefore(input,units);
    }

    function diff (input, units, asFloat) {
        var that,
            zoneDelta,
            delta, output;

        if (!this.isValid()) {
            return NaN;
        }

        that = cloneWithOffset(input, this);

        if (!that.isValid()) {
            return NaN;
        }

        zoneDelta = (that.utcOffset() - this.utcOffset()) * 6e4;

        units = normalizeUnits(units);

        if (units === 'year' || units === 'month' || units === 'quarter') {
            output = monthDiff(this, that);
            if (units === 'quarter') {
                output = output / 3;
            } else if (units === 'year') {
                output = output / 12;
            }
        } else {
            delta = this - that;
            output = units === 'second' ? delta / 1e3 : // 1000
                units === 'minute' ? delta / 6e4 : // 1000 * 60
                units === 'hour' ? delta / 36e5 : // 1000 * 60 * 60
                units === 'day' ? (delta - zoneDelta) / 864e5 : // 1000 * 60 * 60 * 24, negate dst
                units === 'week' ? (delta - zoneDelta) / 6048e5 : // 1000 * 60 * 60 * 24 * 7, negate dst
                delta;
        }
        return asFloat ? output : absFloor(output);
    }

    function monthDiff (a, b) {
        // difference in months
        var wholeMonthDiff = ((b.year() - a.year()) * 12) + (b.month() - a.month()),
            // b is in (anchor - 1 month, anchor + 1 month)
            anchor = a.clone().add(wholeMonthDiff, 'months'),
            anchor2, adjust;

        if (b - anchor < 0) {
            anchor2 = a.clone().add(wholeMonthDiff - 1, 'months');
            // linear across the month
            adjust = (b - anchor) / (anchor - anchor2);
        } else {
            anchor2 = a.clone().add(wholeMonthDiff + 1, 'months');
            // linear across the month
            adjust = (b - anchor) / (anchor2 - anchor);
        }

        return -(wholeMonthDiff + adjust);
    }

    utils_hooks__hooks.defaultFormat = 'YYYY-MM-DDTHH:mm:ssZ';

    function toString () {
        return this.clone().locale('en').format('ddd MMM DD YYYY HH:mm:ss [GMT]ZZ');
    }

    function moment_format__toISOString () {
        var m = this.clone().utc();
        if (0 < m.year() && m.year() <= 9999) {
            if (isFunction(Date.prototype.toISOString)) {
                // native implementation is ~50x faster, use it when we can
                return this.toDate().toISOString();
            } else {
                return formatMoment(m, 'YYYY-MM-DD[T]HH:mm:ss.SSS[Z]');
            }
        } else {
            return formatMoment(m, 'YYYYYY-MM-DD[T]HH:mm:ss.SSS[Z]');
        }
    }

    function format (inputString) {
        var output = formatMoment(this, inputString || utils_hooks__hooks.defaultFormat);
        return this.localeData().postformat(output);
    }

    function from (time, withoutSuffix) {
        if (this.isValid() &&
                ((isMoment(time) && time.isValid()) ||
                 local__createLocal(time).isValid())) {
            return create__createDuration({to: this, from: time}).locale(this.locale()).humanize(!withoutSuffix);
        } else {
            return this.localeData().invalidDate();
        }
    }

    function fromNow (withoutSuffix) {
        return this.from(local__createLocal(), withoutSuffix);
    }

    function to (time, withoutSuffix) {
        if (this.isValid() &&
                ((isMoment(time) && time.isValid()) ||
                 local__createLocal(time).isValid())) {
            return create__createDuration({from: this, to: time}).locale(this.locale()).humanize(!withoutSuffix);
        } else {
            return this.localeData().invalidDate();
        }
    }

    function toNow (withoutSuffix) {
        return this.to(local__createLocal(), withoutSuffix);
    }

    // If passed a locale key, it will set the locale for this
    // instance.  Otherwise, it will return the locale configuration
    // variables for this instance.
    function locale (key) {
        var newLocaleData;

        if (key === undefined) {
            return this._locale._abbr;
        } else {
            newLocaleData = locale_locales__getLocale(key);
            if (newLocaleData != null) {
                this._locale = newLocaleData;
            }
            return this;
        }
    }

    var lang = deprecate(
        'moment().lang() is deprecated. Instead, use moment().localeData() to get the language configuration. Use moment().locale() to change languages.',
        function (key) {
            if (key === undefined) {
                return this.localeData();
            } else {
                return this.locale(key);
            }
        }
    );

    function localeData () {
        return this._locale;
    }

    function startOf (units) {
        units = normalizeUnits(units);
        // the following switch intentionally omits break keywords
        // to utilize falling through the cases.
        switch (units) {
        case 'year':
            this.month(0);
            /* falls through */
        case 'quarter':
        case 'month':
            this.date(1);
            /* falls through */
        case 'week':
        case 'isoWeek':
        case 'day':
            this.hours(0);
            /* falls through */
        case 'hour':
            this.minutes(0);
            /* falls through */
        case 'minute':
            this.seconds(0);
            /* falls through */
        case 'second':
            this.milliseconds(0);
        }

        // weeks are a special case
        if (units === 'week') {
            this.weekday(0);
        }
        if (units === 'isoWeek') {
            this.isoWeekday(1);
        }

        // quarters are also special
        if (units === 'quarter') {
            this.month(Math.floor(this.month() / 3) * 3);
        }

        return this;
    }

    function endOf (units) {
        units = normalizeUnits(units);
        if (units === undefined || units === 'millisecond') {
            return this;
        }
        return this.startOf(units).add(1, (units === 'isoWeek' ? 'week' : units)).subtract(1, 'ms');
    }

    function to_type__valueOf () {
        return +this._d - ((this._offset || 0) * 60000);
    }

    function unix () {
        return Math.floor(+this / 1000);
    }

    function toDate () {
        return this._offset ? new Date(+this) : this._d;
    }

    function toArray () {
        var m = this;
        return [m.year(), m.month(), m.date(), m.hour(), m.minute(), m.second(), m.millisecond()];
    }

    function toObject () {
        var m = this;
        return {
            years: m.year(),
            months: m.month(),
            date: m.date(),
            hours: m.hours(),
            minutes: m.minutes(),
            seconds: m.seconds(),
            milliseconds: m.milliseconds()
        };
    }

    function toJSON () {
        // JSON.stringify(new Date(NaN)) === 'null'
        return this.isValid() ? this.toISOString() : 'null';
    }

    function moment_valid__isValid () {
        return valid__isValid(this);
    }

    function parsingFlags () {
        return extend({}, getParsingFlags(this));
    }

    function invalidAt () {
        return getParsingFlags(this).overflow;
    }

    function creationData() {
        return {
            input: this._i,
            format: this._f,
            locale: this._locale,
            isUTC: this._isUTC,
            strict: this._strict
        };
    }

    // FORMATTING

    addFormatToken(0, ['gg', 2], 0, function () {
        return this.weekYear() % 100;
    });

    addFormatToken(0, ['GG', 2], 0, function () {
        return this.isoWeekYear() % 100;
    });

    function addWeekYearFormatToken (token, getter) {
        addFormatToken(0, [token, token.length], 0, getter);
    }

    addWeekYearFormatToken('gggg',     'weekYear');
    addWeekYearFormatToken('ggggg',    'weekYear');
    addWeekYearFormatToken('GGGG',  'isoWeekYear');
    addWeekYearFormatToken('GGGGG', 'isoWeekYear');

    // ALIASES

    addUnitAlias('weekYear', 'gg');
    addUnitAlias('isoWeekYear', 'GG');

    // PARSING

    addRegexToken('G',      matchSigned);
    addRegexToken('g',      matchSigned);
    addRegexToken('GG',     match1to2, match2);
    addRegexToken('gg',     match1to2, match2);
    addRegexToken('GGGG',   match1to4, match4);
    addRegexToken('gggg',   match1to4, match4);
    addRegexToken('GGGGG',  match1to6, match6);
    addRegexToken('ggggg',  match1to6, match6);

    addWeekParseToken(['gggg', 'ggggg', 'GGGG', 'GGGGG'], function (input, week, config, token) {
        week[token.substr(0, 2)] = toInt(input);
    });

    addWeekParseToken(['gg', 'GG'], function (input, week, config, token) {
        week[token] = utils_hooks__hooks.parseTwoDigitYear(input);
    });

    // MOMENTS

    function getSetWeekYear (input) {
        return getSetWeekYearHelper.call(this,
                input,
                this.week(),
                this.weekday(),
                this.localeData()._week.dow,
                this.localeData()._week.doy);
    }

    function getSetISOWeekYear (input) {
        return getSetWeekYearHelper.call(this,
                input, this.isoWeek(), this.isoWeekday(), 1, 4);
    }

    function getISOWeeksInYear () {
        return weeksInYear(this.year(), 1, 4);
    }

    function getWeeksInYear () {
        var weekInfo = this.localeData()._week;
        return weeksInYear(this.year(), weekInfo.dow, weekInfo.doy);
    }

    function getSetWeekYearHelper(input, week, weekday, dow, doy) {
        var weeksTarget;
        if (input == null) {
            return weekOfYear(this, dow, doy).year;
        } else {
            weeksTarget = weeksInYear(input, dow, doy);
            if (week > weeksTarget) {
                week = weeksTarget;
            }
            return setWeekAll.call(this, input, week, weekday, dow, doy);
        }
    }

    function setWeekAll(weekYear, week, weekday, dow, doy) {
        var dayOfYearData = dayOfYearFromWeeks(weekYear, week, weekday, dow, doy),
            date = createUTCDate(dayOfYearData.year, 0, dayOfYearData.dayOfYear);

        // console.log("got", weekYear, week, weekday, "set", date.toISOString());
        this.year(date.getUTCFullYear());
        this.month(date.getUTCMonth());
        this.date(date.getUTCDate());
        return this;
    }

    // FORMATTING

    addFormatToken('Q', 0, 'Qo', 'quarter');

    // ALIASES

    addUnitAlias('quarter', 'Q');

    // PARSING

    addRegexToken('Q', match1);
    addParseToken('Q', function (input, array) {
        array[MONTH] = (toInt(input) - 1) * 3;
    });

    // MOMENTS

    function getSetQuarter (input) {
        return input == null ? Math.ceil((this.month() + 1) / 3) : this.month((input - 1) * 3 + this.month() % 3);
    }

    // FORMATTING

    addFormatToken('w', ['ww', 2], 'wo', 'week');
    addFormatToken('W', ['WW', 2], 'Wo', 'isoWeek');

    // ALIASES

    addUnitAlias('week', 'w');
    addUnitAlias('isoWeek', 'W');

    // PARSING

    addRegexToken('w',  match1to2);
    addRegexToken('ww', match1to2, match2);
    addRegexToken('W',  match1to2);
    addRegexToken('WW', match1to2, match2);

    addWeekParseToken(['w', 'ww', 'W', 'WW'], function (input, week, config, token) {
        week[token.substr(0, 1)] = toInt(input);
    });

    // HELPERS

    // LOCALES

    function localeWeek (mom) {
        return weekOfYear(mom, this._week.dow, this._week.doy).week;
    }

    var defaultLocaleWeek = {
        dow : 0, // Sunday is the first day of the week.
        doy : 6  // The week that contains Jan 1st is the first week of the year.
    };

    function localeFirstDayOfWeek () {
        return this._week.dow;
    }

    function localeFirstDayOfYear () {
        return this._week.doy;
    }

    // MOMENTS

    function getSetWeek (input) {
        var week = this.localeData().week(this);
        return input == null ? week : this.add((input - week) * 7, 'd');
    }

    function getSetISOWeek (input) {
        var week = weekOfYear(this, 1, 4).week;
        return input == null ? week : this.add((input - week) * 7, 'd');
    }

    // FORMATTING

    addFormatToken('D', ['DD', 2], 'Do', 'date');

    // ALIASES

    addUnitAlias('date', 'D');

    // PARSING

    addRegexToken('D',  match1to2);
    addRegexToken('DD', match1to2, match2);
    addRegexToken('Do', function (isStrict, locale) {
        return isStrict ? locale._ordinalParse : locale._ordinalParseLenient;
    });

    addParseToken(['D', 'DD'], DATE);
    addParseToken('Do', function (input, array) {
        array[DATE] = toInt(input.match(match1to2)[0], 10);
    });

    // MOMENTS

    var getSetDayOfMonth = makeGetSet('Date', true);

    // FORMATTING

    addFormatToken('d', 0, 'do', 'day');

    addFormatToken('dd', 0, 0, function (format) {
        return this.localeData().weekdaysMin(this, format);
    });

    addFormatToken('ddd', 0, 0, function (format) {
        return this.localeData().weekdaysShort(this, format);
    });

    addFormatToken('dddd', 0, 0, function (format) {
        return this.localeData().weekdays(this, format);
    });

    addFormatToken('e', 0, 0, 'weekday');
    addFormatToken('E', 0, 0, 'isoWeekday');

    // ALIASES

    addUnitAlias('day', 'd');
    addUnitAlias('weekday', 'e');
    addUnitAlias('isoWeekday', 'E');

    // PARSING

    addRegexToken('d',    match1to2);
    addRegexToken('e',    match1to2);
    addRegexToken('E',    match1to2);
    addRegexToken('dd',   matchWord);
    addRegexToken('ddd',  matchWord);
    addRegexToken('dddd', matchWord);

    addWeekParseToken(['dd', 'ddd', 'dddd'], function (input, week, config, token) {
        var weekday = config._locale.weekdaysParse(input, token, config._strict);
        // if we didn't get a weekday name, mark the date as invalid
        if (weekday != null) {
            week.d = weekday;
        } else {
            getParsingFlags(config).invalidWeekday = input;
        }
    });

    addWeekParseToken(['d', 'e', 'E'], function (input, week, config, token) {
        week[token] = toInt(input);
    });

    // HELPERS

    function parseWeekday(input, locale) {
        if (typeof input !== 'string') {
            return input;
        }

        if (!isNaN(input)) {
            return parseInt(input, 10);
        }

        input = locale.weekdaysParse(input);
        if (typeof input === 'number') {
            return input;
        }

        return null;
    }

    // LOCALES

    var defaultLocaleWeekdays = 'Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday'.split('_');
    function localeWeekdays (m, format) {
        return isArray(this._weekdays) ? this._weekdays[m.day()] :
            this._weekdays[this._weekdays.isFormat.test(format) ? 'format' : 'standalone'][m.day()];
    }

    var defaultLocaleWeekdaysShort = 'Sun_Mon_Tue_Wed_Thu_Fri_Sat'.split('_');
    function localeWeekdaysShort (m) {
        return this._weekdaysShort[m.day()];
    }

    var defaultLocaleWeekdaysMin = 'Su_Mo_Tu_We_Th_Fr_Sa'.split('_');
    function localeWeekdaysMin (m) {
        return this._weekdaysMin[m.day()];
    }

    function localeWeekdaysParse (weekdayName, format, strict) {
        var i, mom, regex;

        if (!this._weekdaysParse) {
            this._weekdaysParse = [];
            this._minWeekdaysParse = [];
            this._shortWeekdaysParse = [];
            this._fullWeekdaysParse = [];
        }

        for (i = 0; i < 7; i++) {
            // make the regex if we don't have it already

            mom = local__createLocal([2000, 1]).day(i);
            if (strict && !this._fullWeekdaysParse[i]) {
                this._fullWeekdaysParse[i] = new RegExp('^' + this.weekdays(mom, '').replace('.', '\.?') + '$', 'i');
                this._shortWeekdaysParse[i] = new RegExp('^' + this.weekdaysShort(mom, '').replace('.', '\.?') + '$', 'i');
                this._minWeekdaysParse[i] = new RegExp('^' + this.weekdaysMin(mom, '').replace('.', '\.?') + '$', 'i');
            }
            if (!this._weekdaysParse[i]) {
                regex = '^' + this.weekdays(mom, '') + '|^' + this.weekdaysShort(mom, '') + '|^' + this.weekdaysMin(mom, '');
                this._weekdaysParse[i] = new RegExp(regex.replace('.', ''), 'i');
            }
            // test the regex
            if (strict && format === 'dddd' && this._fullWeekdaysParse[i].test(weekdayName)) {
                return i;
            } else if (strict && format === 'ddd' && this._shortWeekdaysParse[i].test(weekdayName)) {
                return i;
            } else if (strict && format === 'dd' && this._minWeekdaysParse[i].test(weekdayName)) {
                return i;
            } else if (!strict && this._weekdaysParse[i].test(weekdayName)) {
                return i;
            }
        }
    }

    // MOMENTS

    function getSetDayOfWeek (input) {
        if (!this.isValid()) {
            return input != null ? this : NaN;
        }
        var day = this._isUTC ? this._d.getUTCDay() : this._d.getDay();
        if (input != null) {
            input = parseWeekday(input, this.localeData());
            return this.add(input - day, 'd');
        } else {
            return day;
        }
    }

    function getSetLocaleDayOfWeek (input) {
        if (!this.isValid()) {
            return input != null ? this : NaN;
        }
        var weekday = (this.day() + 7 - this.localeData()._week.dow) % 7;
        return input == null ? weekday : this.add(input - weekday, 'd');
    }

    function getSetISODayOfWeek (input) {
        if (!this.isValid()) {
            return input != null ? this : NaN;
        }
        // behaves the same as moment#day except
        // as a getter, returns 7 instead of 0 (1-7 range instead of 0-6)
        // as a setter, sunday should belong to the previous week.
        return input == null ? this.day() || 7 : this.day(this.day() % 7 ? input : input - 7);
    }

    // FORMATTING

    addFormatToken('DDD', ['DDDD', 3], 'DDDo', 'dayOfYear');

    // ALIASES

    addUnitAlias('dayOfYear', 'DDD');

    // PARSING

    addRegexToken('DDD',  match1to3);
    addRegexToken('DDDD', match3);
    addParseToken(['DDD', 'DDDD'], function (input, array, config) {
        config._dayOfYear = toInt(input);
    });

    // HELPERS

    // MOMENTS

    function getSetDayOfYear (input) {
        var dayOfYear = Math.round((this.clone().startOf('day') - this.clone().startOf('year')) / 864e5) + 1;
        return input == null ? dayOfYear : this.add((input - dayOfYear), 'd');
    }

    // FORMATTING

    function hFormat() {
        return this.hours() % 12 || 12;
    }

    addFormatToken('H', ['HH', 2], 0, 'hour');
    addFormatToken('h', ['hh', 2], 0, hFormat);

    addFormatToken('hmm', 0, 0, function () {
        return '' + hFormat.apply(this) + zeroFill(this.minutes(), 2);
    });

    addFormatToken('hmmss', 0, 0, function () {
        return '' + hFormat.apply(this) + zeroFill(this.minutes(), 2) +
            zeroFill(this.seconds(), 2);
    });

    addFormatToken('Hmm', 0, 0, function () {
        return '' + this.hours() + zeroFill(this.minutes(), 2);
    });

    addFormatToken('Hmmss', 0, 0, function () {
        return '' + this.hours() + zeroFill(this.minutes(), 2) +
            zeroFill(this.seconds(), 2);
    });

    function meridiem (token, lowercase) {
        addFormatToken(token, 0, 0, function () {
            return this.localeData().meridiem(this.hours(), this.minutes(), lowercase);
        });
    }

    meridiem('a', true);
    meridiem('A', false);

    // ALIASES

    addUnitAlias('hour', 'h');

    // PARSING

    function matchMeridiem (isStrict, locale) {
        return locale._meridiemParse;
    }

    addRegexToken('a',  matchMeridiem);
    addRegexToken('A',  matchMeridiem);
    addRegexToken('H',  match1to2);
    addRegexToken('h',  match1to2);
    addRegexToken('HH', match1to2, match2);
    addRegexToken('hh', match1to2, match2);

    addRegexToken('hmm', match3to4);
    addRegexToken('hmmss', match5to6);
    addRegexToken('Hmm', match3to4);
    addRegexToken('Hmmss', match5to6);

    addParseToken(['H', 'HH'], HOUR);
    addParseToken(['a', 'A'], function (input, array, config) {
        config._isPm = config._locale.isPM(input);
        config._meridiem = input;
    });
    addParseToken(['h', 'hh'], function (input, array, config) {
        array[HOUR] = toInt(input);
        getParsingFlags(config).bigHour = true;
    });
    addParseToken('hmm', function (input, array, config) {
        var pos = input.length - 2;
        array[HOUR] = toInt(input.substr(0, pos));
        array[MINUTE] = toInt(input.substr(pos));
        getParsingFlags(config).bigHour = true;
    });
    addParseToken('hmmss', function (input, array, config) {
        var pos1 = input.length - 4;
        var pos2 = input.length - 2;
        array[HOUR] = toInt(input.substr(0, pos1));
        array[MINUTE] = toInt(input.substr(pos1, 2));
        array[SECOND] = toInt(input.substr(pos2));
        getParsingFlags(config).bigHour = true;
    });
    addParseToken('Hmm', function (input, array, config) {
        var pos = input.length - 2;
        array[HOUR] = toInt(input.substr(0, pos));
        array[MINUTE] = toInt(input.substr(pos));
    });
    addParseToken('Hmmss', function (input, array, config) {
        var pos1 = input.length - 4;
        var pos2 = input.length - 2;
        array[HOUR] = toInt(input.substr(0, pos1));
        array[MINUTE] = toInt(input.substr(pos1, 2));
        array[SECOND] = toInt(input.substr(pos2));
    });

    // LOCALES

    function localeIsPM (input) {
        // IE8 Quirks Mode & IE7 Standards Mode do not allow accessing strings like arrays
        // Using charAt should be more compatible.
        return ((input + '').toLowerCase().charAt(0) === 'p');
    }

    var defaultLocaleMeridiemParse = /[ap]\.?m?\.?/i;
    function localeMeridiem (hours, minutes, isLower) {
        if (hours > 11) {
            return isLower ? 'pm' : 'PM';
        } else {
            return isLower ? 'am' : 'AM';
        }
    }


    // MOMENTS

    // Setting the hour should keep the time, because the user explicitly
    // specified which hour he wants. So trying to maintain the same hour (in
    // a new timezone) makes sense. Adding/subtracting hours does not follow
    // this rule.
    var getSetHour = makeGetSet('Hours', true);

    // FORMATTING

    addFormatToken('m', ['mm', 2], 0, 'minute');

    // ALIASES

    addUnitAlias('minute', 'm');

    // PARSING

    addRegexToken('m',  match1to2);
    addRegexToken('mm', match1to2, match2);
    addParseToken(['m', 'mm'], MINUTE);

    // MOMENTS

    var getSetMinute = makeGetSet('Minutes', false);

    // FORMATTING

    addFormatToken('s', ['ss', 2], 0, 'second');

    // ALIASES

    addUnitAlias('second', 's');

    // PARSING

    addRegexToken('s',  match1to2);
    addRegexToken('ss', match1to2, match2);
    addParseToken(['s', 'ss'], SECOND);

    // MOMENTS

    var getSetSecond = makeGetSet('Seconds', false);

    // FORMATTING

    addFormatToken('S', 0, 0, function () {
        return ~~(this.millisecond() / 100);
    });

    addFormatToken(0, ['SS', 2], 0, function () {
        return ~~(this.millisecond() / 10);
    });

    addFormatToken(0, ['SSS', 3], 0, 'millisecond');
    addFormatToken(0, ['SSSS', 4], 0, function () {
        return this.millisecond() * 10;
    });
    addFormatToken(0, ['SSSSS', 5], 0, function () {
        return this.millisecond() * 100;
    });
    addFormatToken(0, ['SSSSSS', 6], 0, function () {
        return this.millisecond() * 1000;
    });
    addFormatToken(0, ['SSSSSSS', 7], 0, function () {
        return this.millisecond() * 10000;
    });
    addFormatToken(0, ['SSSSSSSS', 8], 0, function () {
        return this.millisecond() * 100000;
    });
    addFormatToken(0, ['SSSSSSSSS', 9], 0, function () {
        return this.millisecond() * 1000000;
    });


    // ALIASES

    addUnitAlias('millisecond', 'ms');

    // PARSING

    addRegexToken('S',    match1to3, match1);
    addRegexToken('SS',   match1to3, match2);
    addRegexToken('SSS',  match1to3, match3);

    var token;
    for (token = 'SSSS'; token.length <= 9; token += 'S') {
        addRegexToken(token, matchUnsigned);
    }

    function parseMs(input, array) {
        array[MILLISECOND] = toInt(('0.' + input) * 1000);
    }

    for (token = 'S'; token.length <= 9; token += 'S') {
        addParseToken(token, parseMs);
    }
    // MOMENTS

    var getSetMillisecond = makeGetSet('Milliseconds', false);

    // FORMATTING

    addFormatToken('z',  0, 0, 'zoneAbbr');
    addFormatToken('zz', 0, 0, 'zoneName');

    // MOMENTS

    function getZoneAbbr () {
        return this._isUTC ? 'UTC' : '';
    }

    function getZoneName () {
        return this._isUTC ? 'Coordinated Universal Time' : '';
    }

    var momentPrototype__proto = Moment.prototype;

    momentPrototype__proto.add               = add_subtract__add;
    momentPrototype__proto.calendar          = moment_calendar__calendar;
    momentPrototype__proto.clone             = clone;
    momentPrototype__proto.diff              = diff;
    momentPrototype__proto.endOf             = endOf;
    momentPrototype__proto.format            = format;
    momentPrototype__proto.from              = from;
    momentPrototype__proto.fromNow           = fromNow;
    momentPrototype__proto.to                = to;
    momentPrototype__proto.toNow             = toNow;
    momentPrototype__proto.get               = getSet;
    momentPrototype__proto.invalidAt         = invalidAt;
    momentPrototype__proto.isAfter           = isAfter;
    momentPrototype__proto.isBefore          = isBefore;
    momentPrototype__proto.isBetween         = isBetween;
    momentPrototype__proto.isSame            = isSame;
    momentPrototype__proto.isSameOrAfter     = isSameOrAfter;
    momentPrototype__proto.isSameOrBefore    = isSameOrBefore;
    momentPrototype__proto.isValid           = moment_valid__isValid;
    momentPrototype__proto.lang              = lang;
    momentPrototype__proto.locale            = locale;
    momentPrototype__proto.localeData        = localeData;
    momentPrototype__proto.max               = prototypeMax;
    momentPrototype__proto.min               = prototypeMin;
    momentPrototype__proto.parsingFlags      = parsingFlags;
    momentPrototype__proto.set               = getSet;
    momentPrototype__proto.startOf           = startOf;
    momentPrototype__proto.subtract          = add_subtract__subtract;
    momentPrototype__proto.toArray           = toArray;
    momentPrototype__proto.toObject          = toObject;
    momentPrototype__proto.toDate            = toDate;
    momentPrototype__proto.toISOString       = moment_format__toISOString;
    momentPrototype__proto.toJSON            = toJSON;
    momentPrototype__proto.toString          = toString;
    momentPrototype__proto.unix              = unix;
    momentPrototype__proto.valueOf           = to_type__valueOf;
    momentPrototype__proto.creationData      = creationData;

    // Year
    momentPrototype__proto.year       = getSetYear;
    momentPrototype__proto.isLeapYear = getIsLeapYear;

    // Week Year
    momentPrototype__proto.weekYear    = getSetWeekYear;
    momentPrototype__proto.isoWeekYear = getSetISOWeekYear;

    // Quarter
    momentPrototype__proto.quarter = momentPrototype__proto.quarters = getSetQuarter;

    // Month
    momentPrototype__proto.month       = getSetMonth;
    momentPrototype__proto.daysInMonth = getDaysInMonth;

    // Week
    momentPrototype__proto.week           = momentPrototype__proto.weeks        = getSetWeek;
    momentPrototype__proto.isoWeek        = momentPrototype__proto.isoWeeks     = getSetISOWeek;
    momentPrototype__proto.weeksInYear    = getWeeksInYear;
    momentPrototype__proto.isoWeeksInYear = getISOWeeksInYear;

    // Day
    momentPrototype__proto.date       = getSetDayOfMonth;
    momentPrototype__proto.day        = momentPrototype__proto.days             = getSetDayOfWeek;
    momentPrototype__proto.weekday    = getSetLocaleDayOfWeek;
    momentPrototype__proto.isoWeekday = getSetISODayOfWeek;
    momentPrototype__proto.dayOfYear  = getSetDayOfYear;

    // Hour
    momentPrototype__proto.hour = momentPrototype__proto.hours = getSetHour;

    // Minute
    momentPrototype__proto.minute = momentPrototype__proto.minutes = getSetMinute;

    // Second
    momentPrototype__proto.second = momentPrototype__proto.seconds = getSetSecond;

    // Millisecond
    momentPrototype__proto.millisecond = momentPrototype__proto.milliseconds = getSetMillisecond;

    // Offset
    momentPrototype__proto.utcOffset            = getSetOffset;
    momentPrototype__proto.utc                  = setOffsetToUTC;
    momentPrototype__proto.local                = setOffsetToLocal;
    momentPrototype__proto.parseZone            = setOffsetToParsedOffset;
    momentPrototype__proto.hasAlignedHourOffset = hasAlignedHourOffset;
    momentPrototype__proto.isDST                = isDaylightSavingTime;
    momentPrototype__proto.isDSTShifted         = isDaylightSavingTimeShifted;
    momentPrototype__proto.isLocal              = isLocal;
    momentPrototype__proto.isUtcOffset          = isUtcOffset;
    momentPrototype__proto.isUtc                = isUtc;
    momentPrototype__proto.isUTC                = isUtc;

    // Timezone
    momentPrototype__proto.zoneAbbr = getZoneAbbr;
    momentPrototype__proto.zoneName = getZoneName;

    // Deprecations
    momentPrototype__proto.dates  = deprecate('dates accessor is deprecated. Use date instead.', getSetDayOfMonth);
    momentPrototype__proto.months = deprecate('months accessor is deprecated. Use month instead', getSetMonth);
    momentPrototype__proto.years  = deprecate('years accessor is deprecated. Use year instead', getSetYear);
    momentPrototype__proto.zone   = deprecate('moment().zone is deprecated, use moment().utcOffset instead. https://github.com/moment/moment/issues/1779', getSetZone);

    var momentPrototype = momentPrototype__proto;

    function moment__createUnix (input) {
        return local__createLocal(input * 1000);
    }

    function moment__createInZone () {
        return local__createLocal.apply(null, arguments).parseZone();
    }

    var defaultCalendar = {
        sameDay : '[Today at] LT',
        nextDay : '[Tomorrow at] LT',
        nextWeek : 'dddd [at] LT',
        lastDay : '[Yesterday at] LT',
        lastWeek : '[Last] dddd [at] LT',
        sameElse : 'L'
    };

    function locale_calendar__calendar (key, mom, now) {
        var output = this._calendar[key];
        return isFunction(output) ? output.call(mom, now) : output;
    }

    var defaultLongDateFormat = {
        LTS  : 'h:mm:ss A',
        LT   : 'h:mm A',
        L    : 'MM/DD/YYYY',
        LL   : 'MMMM D, YYYY',
        LLL  : 'MMMM D, YYYY h:mm A',
        LLLL : 'dddd, MMMM D, YYYY h:mm A'
    };

    function longDateFormat (key) {
        var format = this._longDateFormat[key],
            formatUpper = this._longDateFormat[key.toUpperCase()];

        if (format || !formatUpper) {
            return format;
        }

        this._longDateFormat[key] = formatUpper.replace(/MMMM|MM|DD|dddd/g, function (val) {
            return val.slice(1);
        });

        return this._longDateFormat[key];
    }

    var defaultInvalidDate = 'Invalid date';

    function invalidDate () {
        return this._invalidDate;
    }

    var defaultOrdinal = '%d';
    var defaultOrdinalParse = /\d{1,2}/;

    function ordinal (number) {
        return this._ordinal.replace('%d', number);
    }

    function preParsePostFormat (string) {
        return string;
    }

    var defaultRelativeTime = {
        future : 'in %s',
        past   : '%s ago',
        s  : 'a few seconds',
        m  : 'a minute',
        mm : '%d minutes',
        h  : 'an hour',
        hh : '%d hours',
        d  : 'a day',
        dd : '%d days',
        M  : 'a month',
        MM : '%d months',
        y  : 'a year',
        yy : '%d years'
    };

    function relative__relativeTime (number, withoutSuffix, string, isFuture) {
        var output = this._relativeTime[string];
        return (isFunction(output)) ?
            output(number, withoutSuffix, string, isFuture) :
            output.replace(/%d/i, number);
    }

    function pastFuture (diff, output) {
        var format = this._relativeTime[diff > 0 ? 'future' : 'past'];
        return isFunction(format) ? format(output) : format.replace(/%s/i, output);
    }

    function locale_set__set (config) {
        var prop, i;
        for (i in config) {
            prop = config[i];
            if (isFunction(prop)) {
                this[i] = prop;
            } else {
                this['_' + i] = prop;
            }
        }
        // Lenient ordinal parsing accepts just a number in addition to
        // number + (possibly) stuff coming from _ordinalParseLenient.
        this._ordinalParseLenient = new RegExp(this._ordinalParse.source + '|' + (/\d{1,2}/).source);
    }

    var prototype__proto = Locale.prototype;

    prototype__proto._calendar       = defaultCalendar;
    prototype__proto.calendar        = locale_calendar__calendar;
    prototype__proto._longDateFormat = defaultLongDateFormat;
    prototype__proto.longDateFormat  = longDateFormat;
    prototype__proto._invalidDate    = defaultInvalidDate;
    prototype__proto.invalidDate     = invalidDate;
    prototype__proto._ordinal        = defaultOrdinal;
    prototype__proto.ordinal         = ordinal;
    prototype__proto._ordinalParse   = defaultOrdinalParse;
    prototype__proto.preparse        = preParsePostFormat;
    prototype__proto.postformat      = preParsePostFormat;
    prototype__proto._relativeTime   = defaultRelativeTime;
    prototype__proto.relativeTime    = relative__relativeTime;
    prototype__proto.pastFuture      = pastFuture;
    prototype__proto.set             = locale_set__set;

    // Month
    prototype__proto.months            =        localeMonths;
    prototype__proto._months           = defaultLocaleMonths;
    prototype__proto.monthsShort       =        localeMonthsShort;
    prototype__proto._monthsShort      = defaultLocaleMonthsShort;
    prototype__proto.monthsParse       =        localeMonthsParse;
    prototype__proto._monthsRegex      = defaultMonthsRegex;
    prototype__proto.monthsRegex       = monthsRegex;
    prototype__proto._monthsShortRegex = defaultMonthsShortRegex;
    prototype__proto.monthsShortRegex  = monthsShortRegex;

    // Week
    prototype__proto.week = localeWeek;
    prototype__proto._week = defaultLocaleWeek;
    prototype__proto.firstDayOfYear = localeFirstDayOfYear;
    prototype__proto.firstDayOfWeek = localeFirstDayOfWeek;

    // Day of Week
    prototype__proto.weekdays       =        localeWeekdays;
    prototype__proto._weekdays      = defaultLocaleWeekdays;
    prototype__proto.weekdaysMin    =        localeWeekdaysMin;
    prototype__proto._weekdaysMin   = defaultLocaleWeekdaysMin;
    prototype__proto.weekdaysShort  =        localeWeekdaysShort;
    prototype__proto._weekdaysShort = defaultLocaleWeekdaysShort;
    prototype__proto.weekdaysParse  =        localeWeekdaysParse;

    // Hours
    prototype__proto.isPM = localeIsPM;
    prototype__proto._meridiemParse = defaultLocaleMeridiemParse;
    prototype__proto.meridiem = localeMeridiem;

    function lists__get (format, index, field, setter) {
        var locale = locale_locales__getLocale();
        var utc = create_utc__createUTC().set(setter, index);
        return locale[field](utc, format);
    }

    function list (format, index, field, count, setter) {
        if (typeof format === 'number') {
            index = format;
            format = undefined;
        }

        format = format || '';

        if (index != null) {
            return lists__get(format, index, field, setter);
        }

        var i;
        var out = [];
        for (i = 0; i < count; i++) {
            out[i] = lists__get(format, i, field, setter);
        }
        return out;
    }

    function lists__listMonths (format, index) {
        return list(format, index, 'months', 12, 'month');
    }

    function lists__listMonthsShort (format, index) {
        return list(format, index, 'monthsShort', 12, 'month');
    }

    function lists__listWeekdays (format, index) {
        return list(format, index, 'weekdays', 7, 'day');
    }

    function lists__listWeekdaysShort (format, index) {
        return list(format, index, 'weekdaysShort', 7, 'day');
    }

    function lists__listWeekdaysMin (format, index) {
        return list(format, index, 'weekdaysMin', 7, 'day');
    }

    locale_locales__getSetGlobalLocale('en', {
        ordinalParse: /\d{1,2}(th|st|nd|rd)/,
        ordinal : function (number) {
            var b = number % 10,
                output = (toInt(number % 100 / 10) === 1) ? 'th' :
                (b === 1) ? 'st' :
                (b === 2) ? 'nd' :
                (b === 3) ? 'rd' : 'th';
            return number + output;
        }
    });

    // Side effect imports
    utils_hooks__hooks.lang = deprecate('moment.lang is deprecated. Use moment.locale instead.', locale_locales__getSetGlobalLocale);
    utils_hooks__hooks.langData = deprecate('moment.langData is deprecated. Use moment.localeData instead.', locale_locales__getLocale);

    var mathAbs = Math.abs;

    function duration_abs__abs () {
        var data           = this._data;

        this._milliseconds = mathAbs(this._milliseconds);
        this._days         = mathAbs(this._days);
        this._months       = mathAbs(this._months);

        data.milliseconds  = mathAbs(data.milliseconds);
        data.seconds       = mathAbs(data.seconds);
        data.minutes       = mathAbs(data.minutes);
        data.hours         = mathAbs(data.hours);
        data.months        = mathAbs(data.months);
        data.years         = mathAbs(data.years);

        return this;
    }

    function duration_add_subtract__addSubtract (duration, input, value, direction) {
        var other = create__createDuration(input, value);

        duration._milliseconds += direction * other._milliseconds;
        duration._days         += direction * other._days;
        duration._months       += direction * other._months;

        return duration._bubble();
    }

    // supports only 2.0-style add(1, 's') or add(duration)
    function duration_add_subtract__add (input, value) {
        return duration_add_subtract__addSubtract(this, input, value, 1);
    }

    // supports only 2.0-style subtract(1, 's') or subtract(duration)
    function duration_add_subtract__subtract (input, value) {
        return duration_add_subtract__addSubtract(this, input, value, -1);
    }

    function absCeil (number) {
        if (number < 0) {
            return Math.floor(number);
        } else {
            return Math.ceil(number);
        }
    }

    function bubble () {
        var milliseconds = this._milliseconds;
        var days         = this._days;
        var months       = this._months;
        var data         = this._data;
        var seconds, minutes, hours, years, monthsFromDays;

        // if we have a mix of positive and negative values, bubble down first
        // check: https://github.com/moment/moment/issues/2166
        if (!((milliseconds >= 0 && days >= 0 && months >= 0) ||
                (milliseconds <= 0 && days <= 0 && months <= 0))) {
            milliseconds += absCeil(monthsToDays(months) + days) * 864e5;
            days = 0;
            months = 0;
        }

        // The following code bubbles up values, see the tests for
        // examples of what that means.
        data.milliseconds = milliseconds % 1000;

        seconds           = absFloor(milliseconds / 1000);
        data.seconds      = seconds % 60;

        minutes           = absFloor(seconds / 60);
        data.minutes      = minutes % 60;

        hours             = absFloor(minutes / 60);
        data.hours        = hours % 24;

        days += absFloor(hours / 24);

        // convert days to months
        monthsFromDays = absFloor(daysToMonths(days));
        months += monthsFromDays;
        days -= absCeil(monthsToDays(monthsFromDays));

        // 12 months -> 1 year
        years = absFloor(months / 12);
        months %= 12;

        data.days   = days;
        data.months = months;
        data.years  = years;

        return this;
    }

    function daysToMonths (days) {
        // 400 years have 146097 days (taking into account leap year rules)
        // 400 years have 12 months === 4800
        return days * 4800 / 146097;
    }

    function monthsToDays (months) {
        // the reverse of daysToMonths
        return months * 146097 / 4800;
    }

    function as (units) {
        var days;
        var months;
        var milliseconds = this._milliseconds;

        units = normalizeUnits(units);

        if (units === 'month' || units === 'year') {
            days   = this._days   + milliseconds / 864e5;
            months = this._months + daysToMonths(days);
            return units === 'month' ? months : months / 12;
        } else {
            // handle milliseconds separately because of floating point math errors (issue #1867)
            days = this._days + Math.round(monthsToDays(this._months));
            switch (units) {
                case 'week'   : return days / 7     + milliseconds / 6048e5;
                case 'day'    : return days         + milliseconds / 864e5;
                case 'hour'   : return days * 24    + milliseconds / 36e5;
                case 'minute' : return days * 1440  + milliseconds / 6e4;
                case 'second' : return days * 86400 + milliseconds / 1000;
                // Math.floor prevents floating point math errors here
                case 'millisecond': return Math.floor(days * 864e5) + milliseconds;
                default: throw new Error('Unknown unit ' + units);
            }
        }
    }

    // TODO: Use this.as('ms')?
    function duration_as__valueOf () {
        return (
            this._milliseconds +
            this._days * 864e5 +
            (this._months % 12) * 2592e6 +
            toInt(this._months / 12) * 31536e6
        );
    }

    function makeAs (alias) {
        return function () {
            return this.as(alias);
        };
    }

    var asMilliseconds = makeAs('ms');
    var asSeconds      = makeAs('s');
    var asMinutes      = makeAs('m');
    var asHours        = makeAs('h');
    var asDays         = makeAs('d');
    var asWeeks        = makeAs('w');
    var asMonths       = makeAs('M');
    var asYears        = makeAs('y');

    function duration_get__get (units) {
        units = normalizeUnits(units);
        return this[units + 's']();
    }

    function makeGetter(name) {
        return function () {
            return this._data[name];
        };
    }

    var milliseconds = makeGetter('milliseconds');
    var seconds      = makeGetter('seconds');
    var minutes      = makeGetter('minutes');
    var hours        = makeGetter('hours');
    var days         = makeGetter('days');
    var months       = makeGetter('months');
    var years        = makeGetter('years');

    function weeks () {
        return absFloor(this.days() / 7);
    }

    var round = Math.round;
    var thresholds = {
        s: 45,  // seconds to minute
        m: 45,  // minutes to hour
        h: 22,  // hours to day
        d: 26,  // days to month
        M: 11   // months to year
    };

    // helper function for moment.fn.from, moment.fn.fromNow, and moment.duration.fn.humanize
    function substituteTimeAgo(string, number, withoutSuffix, isFuture, locale) {
        return locale.relativeTime(number || 1, !!withoutSuffix, string, isFuture);
    }

    function duration_humanize__relativeTime (posNegDuration, withoutSuffix, locale) {
        var duration = create__createDuration(posNegDuration).abs();
        var seconds  = round(duration.as('s'));
        var minutes  = round(duration.as('m'));
        var hours    = round(duration.as('h'));
        var days     = round(duration.as('d'));
        var months   = round(duration.as('M'));
        var years    = round(duration.as('y'));

        var a = seconds < thresholds.s && ['s', seconds]  ||
                minutes <= 1           && ['m']           ||
                minutes < thresholds.m && ['mm', minutes] ||
                hours   <= 1           && ['h']           ||
                hours   < thresholds.h && ['hh', hours]   ||
                days    <= 1           && ['d']           ||
                days    < thresholds.d && ['dd', days]    ||
                months  <= 1           && ['M']           ||
                months  < thresholds.M && ['MM', months]  ||
                years   <= 1           && ['y']           || ['yy', years];

        a[2] = withoutSuffix;
        a[3] = +posNegDuration > 0;
        a[4] = locale;
        return substituteTimeAgo.apply(null, a);
    }

    // This function allows you to set a threshold for relative time strings
    function duration_humanize__getSetRelativeTimeThreshold (threshold, limit) {
        if (thresholds[threshold] === undefined) {
            return false;
        }
        if (limit === undefined) {
            return thresholds[threshold];
        }
        thresholds[threshold] = limit;
        return true;
    }

    function humanize (withSuffix) {
        var locale = this.localeData();
        var output = duration_humanize__relativeTime(this, !withSuffix, locale);

        if (withSuffix) {
            output = locale.pastFuture(+this, output);
        }

        return locale.postformat(output);
    }

    var iso_string__abs = Math.abs;

    function iso_string__toISOString() {
        // for ISO strings we do not use the normal bubbling rules:
        //  * milliseconds bubble up until they become hours
        //  * days do not bubble at all
        //  * months bubble up until they become years
        // This is because there is no context-free conversion between hours and days
        // (think of clock changes)
        // and also not between days and months (28-31 days per month)
        var seconds = iso_string__abs(this._milliseconds) / 1000;
        var days         = iso_string__abs(this._days);
        var months       = iso_string__abs(this._months);
        var minutes, hours, years;

        // 3600 seconds -> 60 minutes -> 1 hour
        minutes           = absFloor(seconds / 60);
        hours             = absFloor(minutes / 60);
        seconds %= 60;
        minutes %= 60;

        // 12 months -> 1 year
        years  = absFloor(months / 12);
        months %= 12;


        // inspired by https://github.com/dordille/moment-isoduration/blob/master/moment.isoduration.js
        var Y = years;
        var M = months;
        var D = days;
        var h = hours;
        var m = minutes;
        var s = seconds;
        var total = this.asSeconds();

        if (!total) {
            // this is the same as C#'s (Noda) and python (isodate)...
            // but not other JS (goog.date)
            return 'P0D';
        }

        return (total < 0 ? '-' : '') +
            'P' +
            (Y ? Y + 'Y' : '') +
            (M ? M + 'M' : '') +
            (D ? D + 'D' : '') +
            ((h || m || s) ? 'T' : '') +
            (h ? h + 'H' : '') +
            (m ? m + 'M' : '') +
            (s ? s + 'S' : '');
    }

    var duration_prototype__proto = Duration.prototype;

    duration_prototype__proto.abs            = duration_abs__abs;
    duration_prototype__proto.add            = duration_add_subtract__add;
    duration_prototype__proto.subtract       = duration_add_subtract__subtract;
    duration_prototype__proto.as             = as;
    duration_prototype__proto.asMilliseconds = asMilliseconds;
    duration_prototype__proto.asSeconds      = asSeconds;
    duration_prototype__proto.asMinutes      = asMinutes;
    duration_prototype__proto.asHours        = asHours;
    duration_prototype__proto.asDays         = asDays;
    duration_prototype__proto.asWeeks        = asWeeks;
    duration_prototype__proto.asMonths       = asMonths;
    duration_prototype__proto.asYears        = asYears;
    duration_prototype__proto.valueOf        = duration_as__valueOf;
    duration_prototype__proto._bubble        = bubble;
    duration_prototype__proto.get            = duration_get__get;
    duration_prototype__proto.milliseconds   = milliseconds;
    duration_prototype__proto.seconds        = seconds;
    duration_prototype__proto.minutes        = minutes;
    duration_prototype__proto.hours          = hours;
    duration_prototype__proto.days           = days;
    duration_prototype__proto.weeks          = weeks;
    duration_prototype__proto.months         = months;
    duration_prototype__proto.years          = years;
    duration_prototype__proto.humanize       = humanize;
    duration_prototype__proto.toISOString    = iso_string__toISOString;
    duration_prototype__proto.toString       = iso_string__toISOString;
    duration_prototype__proto.toJSON         = iso_string__toISOString;
    duration_prototype__proto.locale         = locale;
    duration_prototype__proto.localeData     = localeData;

    // Deprecations
    duration_prototype__proto.toIsoString = deprecate('toIsoString() is deprecated. Please use toISOString() instead (notice the capitals)', iso_string__toISOString);
    duration_prototype__proto.lang = lang;

    // Side effect imports

    // FORMATTING

    addFormatToken('X', 0, 0, 'unix');
    addFormatToken('x', 0, 0, 'valueOf');

    // PARSING

    addRegexToken('x', matchSigned);
    addRegexToken('X', matchTimestamp);
    addParseToken('X', function (input, array, config) {
        config._d = new Date(parseFloat(input, 10) * 1000);
    });
    addParseToken('x', function (input, array, config) {
        config._d = new Date(toInt(input));
    });

    // Side effect imports


    utils_hooks__hooks.version = '2.11.2';

    setHookCallback(local__createLocal);

    utils_hooks__hooks.fn                    = momentPrototype;
    utils_hooks__hooks.min                   = min;
    utils_hooks__hooks.max                   = max;
    utils_hooks__hooks.now                   = now;
    utils_hooks__hooks.utc                   = create_utc__createUTC;
    utils_hooks__hooks.unix                  = moment__createUnix;
    utils_hooks__hooks.months                = lists__listMonths;
    utils_hooks__hooks.isDate                = isDate;
    utils_hooks__hooks.locale                = locale_locales__getSetGlobalLocale;
    utils_hooks__hooks.invalid               = valid__createInvalid;
    utils_hooks__hooks.duration              = create__createDuration;
    utils_hooks__hooks.isMoment              = isMoment;
    utils_hooks__hooks.weekdays              = lists__listWeekdays;
    utils_hooks__hooks.parseZone             = moment__createInZone;
    utils_hooks__hooks.localeData            = locale_locales__getLocale;
    utils_hooks__hooks.isDuration            = isDuration;
    utils_hooks__hooks.monthsShort           = lists__listMonthsShort;
    utils_hooks__hooks.weekdaysMin           = lists__listWeekdaysMin;
    utils_hooks__hooks.defineLocale          = defineLocale;
    utils_hooks__hooks.weekdaysShort         = lists__listWeekdaysShort;
    utils_hooks__hooks.normalizeUnits        = normalizeUnits;
    utils_hooks__hooks.relativeTimeThreshold = duration_humanize__getSetRelativeTimeThreshold;
    utils_hooks__hooks.prototype             = momentPrototype;

    var _moment = utils_hooks__hooks;

    return _moment;

}));
define('core/extensions/helpers/now',[
    'moment',
], function (
    moment
) {
    'use strict';

    // Get time now
    return function (format) {
        return moment().format(format);
    };
});

// TODO: Require helpers directly rather than use this file

define('core/extensions/handlebars.helpers',['require','handlebars','./helpers/eq','./helpers/ne','./helpers/gt','./helpers/lt','./helpers/ge','./helpers/le','./helpers/typeof','./helpers/notNull','./helpers/any','./helpers/if_any','./helpers/if_all','./helpers/switch','./helpers/partial','./helpers/getPartial','./helpers/gettext','./helpers/urlfor','./helpers/html','./helpers/with','./helpers/each','./helpers/log','./helpers/debug','./helpers/geturl','./helpers/tag','./helpers/now'],function (require) {  // eslint-disable-line requirejs/no-commonjs-wrapper
    'use strict';

    var Handlebars = require('handlebars');

    // Comparison helpers, for use in subexpressions
    Handlebars.registerHelper('eq', require('./helpers/eq'));
    Handlebars.registerHelper('ne', require('./helpers/ne'));
    Handlebars.registerHelper('gt', require('./helpers/gt'));
    Handlebars.registerHelper('lt', require('./helpers/lt'));
    Handlebars.registerHelper('ge', require('./helpers/ge'));
    Handlebars.registerHelper('le', require('./helpers/le'));
    Handlebars.registerHelper('typeof', require('./helpers/typeof'));
    Handlebars.registerHelper('notNull', require('./helpers/notNull'));

    Handlebars.registerHelper('any', require('./helpers/any'));
    Handlebars.registerHelper('if_any', require('./helpers/if_any'));
    Handlebars.registerHelper('if_all', require('./helpers/if_all'));

    Handlebars.registerHelper('switch', require('./helpers/switch'));

    Handlebars.registerHelper('partial', require('./helpers/partial'));
    Handlebars.registerHelper('getPartial', require('./helpers/getPartial'));
    Handlebars.registerHelper('gettext', require('./helpers/gettext'));
    Handlebars.registerHelper('urlfor', require('./helpers/urlfor'));
    Handlebars.registerHelper('html', require('./helpers/html'));
    Handlebars.registerHelper('with', require('./helpers/with'));
    Handlebars.registerHelper('each', require('./helpers/each'));

    // development-only helpers
    Handlebars.registerHelper('log', require('./helpers/log'));
    Handlebars.registerHelper('debug', require('./helpers/debug'));
    Handlebars.registerHelper('geturl', require('./helpers/geturl'));

    Handlebars.registerHelper('tag', require('./helpers/tag'));
    Handlebars.registerHelper('now', require('./helpers/now'));

    return Handlebars;
});

define('home/templates/preload',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    return "<p></p>\n";
},"useData":true})

});
define('core/utils/urls',[], function () {
    'use strict';
    var exports = {};

    /**
     * Get the origin of the URL.
     *
     * Given a fully-formed or protocol relative URL, extracts an origin value for use with window.postMessage.
     * For example:
     *     `getOrigin('https://example.com:555/index/') -> 'https://example.com:555'`
     *
     * See https://developer.mozilla.org/en-US/docs/Web/API/URLUtils/origin
     * @returns {string}
     */
    var _anchor = window.document.createElement('a');
    exports.getOrigin = function (url) {
        // Use the anchor tag to guarantee a fully formed URL.
        _anchor.href = url;
        var parts = _anchor.href.split('/');
        return parts[0] + '//' + parts[2];
    };

    exports.getHostName = function (url) {
        _anchor.href = url;
        return _anchor.hostname;
    };

    exports.getDomainPart = function (url, level) {
        // Return the domain identifier at `level` for `url`.
        // This method will return the top-level domain by default.
        // Usually we'll be using this with level == 2 to return a
        // forum subdomain if present.

        if (typeof level === 'undefined')
            level = 0;

        var host = exports.getHostName(url);
        var parts = host.split('.').reverse();
        return parts[level];
    };

    exports.getQuery = function (url) {
        _anchor.href = url;
        return _anchor.search;
    };

    exports.getPathname = function (url) {
        _anchor.href = url;
        return _anchor.pathname;
    };

    return exports;
});

define('core/frameBus',[
    'jquery',
    'underscore',
    'backbone',

    'core/utils/urls',
], function (
    $,
    _,
    Backbone,

    urls
) {
    'use strict';

    // If this is a popup window, the parent window is window.opener
    // If this is an iframe, the parent window is window.parent
    var channel = window.opener || window.parent;
    // The opener/parent uses window.name/iframe name property  to pass the id
    // of the app into this window.
    // It cannot be changed by the parent after the page has loaded if they are
    // on different domains. It should not be changed in this window but can be
    // changed right after this point since it will be cached in `senderId`.
    var senderId = window.name;
    var referrer = window.document.referrer;

    // TODO: Cannot rely on referrer
    var origins = {};
    origins.client = urls.getOrigin(window.document.location.href);
    origins.secureClient = origins.client.replace(/^\w+:\/\//, 'https://');
    origins.host = referrer ? urls.getOrigin(referrer) : origins.client;

    var FrameBus = {
        origins: origins,

        messageHandler: function (event) {
            // jQuery wraps the originalEvent and puts it in, yes, originalEvent
            event = event.originalEvent;

            var message;
            try {
                message = JSON.parse(event.data);
            } catch (err) {
                // Message was not parsable - bail out
                // NOTE: We discovered that some sites were sending random,
                // unparsable messages to our iframe that were causing
                // exceptions here.
                return;
            }

            // A "!" in the beginning of an event name means it is a "Disqus-only"
            // event, such as "!audiencesync:grant" or "!auth:success". We reject
            // any event in this category that comes from a different origin. The
            // only exception is the `https` version of the client's origin such as
            // `https://disqus.com` sending a message to `http://disqus.com`.
            if (message.name && message.name[0] === '!' &&
                event.origin !== origins.client &&
                event.origin !== origins.secureClient
            )
                return;

            // Only listens to client-scoped messages
            if (message.scope !== 'client')
                return;

            FrameBus.trigger(message.name, message.data);
        },

        postMessage: function (message) {
            // NOTE: Target origin is wildcard (*), which means any JavaScript code
            //       (i.e. publishers) with a reference to the target window can listen
            //       and receive these messages. Assume that any messages sent this way
            //       can and will be readable by third-parties, and do not send any
            //       private session-identifying data.
            message = JSON.stringify(message);
            channel.postMessage(message, '*');
        },

        // Sends a message strictly to this frame's host object
        sendHostMessage: function (name, params) {
            params = params || [];

            FrameBus.postMessage({
                scope: 'host',
                sender: senderId,
                name: name,
                data: params,
            });
        },
    };
    _.extend(FrameBus, Backbone.Events);

    $(window).on('message', FrameBus.messageHandler);
    $(window).on('unload', function () { FrameBus.sendHostMessage('die'); });

    // Expose Bus on DISQUS global since some pages rely on it
    // (ex. login-success)
    window.DISQUS = window.DISQUS || {};
    window.DISQUS.Bus = FrameBus;

    return FrameBus;
});

define('core/bus',[
    'backbone',
    'underscore',

    'core/frameBus',
], function (
    Backbone,
    _,

    frameBus
) {
    'use strict';

    var bus = _.extend({}, Backbone.Events);
    bus.frame = frameBus;

    return bus;
});

define('core/utils/html',[],function () {
    'use strict';

    var ELLIPSIS_TEXT = '...';
    var ELLIPSIS_TEXT_LENGTH = ELLIPSIS_TEXT.length;

    var parseHTML = function (html) {
        var parsed;

        try {
            parsed = new window.DOMParser().parseFromString('<!doctype html><meta charset=utf-8><title> </title>', 'text/html');
        } catch (err) {
            // Pass
        }

        // Fallback to alternative, insecure implementation
        // This is only to support PhantomJS and very old mobile browsers
        if (!parsed)
            parsed = window.document.implementation.createHTMLDocument('');

        parsed.body.innerHTML = html;

        return parsed;
    };

    return {
        /**
         * Remove HTML tags from a string. Similar to $.text()
         *
         * It also makes the browser parse HTML entities as a side effect so
         * this is not "just strip tags", BEWARE!
         *
         * @param {string} html A string possibly containing html tags like <p></p>
         * @returns {string} plain text (all html tags removed)
         */
        stripTags: function (html) {
            var doc = parseHTML(html).body;
            return (doc.textContent || doc.innerText).replace(/\r?\n/g, ' ');
        },

        /**
         * Replace anchor tags in given HTML with result from `replaceFn`.
         * Any of the anchor's inner html is preserved except for the
         * anchor's href, if present.
         *
         * `replaceFn` is called with the link object it is replacing.
         *
         * @param {string} inputHTML A raw HTML string containing <a> tags
         * @param {function(number)} replaceFn The function that returns the replacement of the anchor tag
         * @returns {string} An HTML string with replaced anchor tags
         */
        replaceAnchors: function (inputHTML, replaceFn) {
            var parsed = parseHTML(inputHTML);

            [].forEach.call(parsed.querySelectorAll('a'), function (anchor) {
                var href = anchor.getAttribute('href') || '';
                var html = anchor.innerHTML;

                var replaceValue = replaceFn(anchor);

                // Check if innerHTML is just the truncated version of HREF
                // value. `.slice()` is to remove the `...` truncation at the end.
                if (href.indexOf(html.slice(0, -ELLIPSIS_TEXT_LENGTH)) === 0)
                    html = replaceValue;

                // Else, if the innerHTML just _contains_ the HREF, then we
                // replace the whole HREF there.
                else if (href.length && html.indexOf(href) !== -1)
                    html = html.replace(href, replaceValue);
                // Otherwise, we append the `replaceValue`
                else
                    html += ' ' + replaceValue;

                // Finally, replace the entire anchor tag with the reformatted
                // inner html.
                anchor.insertAdjacentHTML('afterend', html);
                anchor.parentNode.removeChild(anchor);
            });

            return parsed.body.innerHTML.trim();
        },
    };
});

define('core/utils/metatags',[
    'jquery',
    'underscore',
    'backbone',
    'core/utils/html',
    'core/strings',
], function (
    $,
    _,
    Backbone,
    html,
    strings
) {
    'use strict';

    var gettext = strings.get;


    // Mapping of attribute name we support to the selector
    // attributes used to lookup the meta tags.
    //
    // For instance, `metatags.set({url: 'Hello'})` will
    // find or create the meta tags [name=twitter:url] and
    // [property=og:url] and set their `content` attributes
    // to 'Hello'.
    var META_TAGS = {
        type: [
            'property="og:type"',
        ],
        title: [
            'property="og:title"',
            'name="twitter:title"',
        ],
        description: [
            'name="twitter:description"',
            'property="og:description"',

            // The page's normal description tag
            'name="description"',

        ],
        image: [
            'property="og:image"',
            'name="twitter:image"',
        ],
        url: [
            'property="og:url"',
            'name="twitter:url"',
        ],
        _card: [
            'name="twitter:card"',
        ],
    };

    var withScheme = function (url) {
        if (url.indexOf('//') === 0)
            url = 'https:' + url;
        return url;
    };

    var DEFAULTS = {
        type: 1,
        title: 'Disqus',
        description: gettext('The web\'s community of communities now has one central hub.'),

        // FB and Twitter don't assume schemes when scraping our content.
        // TODO: this image url could change and should be set by config.
        image: withScheme('//c.disquscdn.com/home/current/img/brand/favicon-192x192.png'),
        url: 'https://disqus.com/',
        _card: 'summary',
    };

    var metatagUtils = _.extend({
        DEFAULTS: DEFAULTS,
        META_TAGS: META_TAGS,

        /**
         * Set the document title and social meta tag attributes
         * with the passed parameters. This supports setting:
         *     `type`
         *     `title`
         *     `description`
         *     `image`
         *     `url`
         *
         * One parameter - `twitter:card` - is only supported as 'summary' at this point,
         * so it's prefixed with an underscore.
         *
         * If any required parameter is not passed, defaults to `this.DEFAULTS`.
         *
         */
        set: function (options) {
            options = options || {};

            // If `set` is passed a string, we assume it's a title
            // and the rest of the tags will be defaults.
            if (_.isString(options))
                options = { title: options };

            // First clean our title (we could end up with an empty string, so important to do here).
            if (options.title)
                options.title = html.stripTags(options.title);

            // If we have a title, then we prepend 'Disqus' to it.
            if (options.title)
                options.title += ' · Disqus';

            if (!options.url)
                options.url = String(window.document.location).split('?')[0];

            options.url = withScheme(options.url);

            if (options.image)
                options.image = withScheme(options.image);

            if (options.description)
                options.description = html.stripTags(options.description);

            var $head = $('head');
            _.each(META_TAGS, function (attributes, key) {
                _.each(attributes, function (attribute) {
                    var tag = $head.find('[' + attribute + ']');
                    if (!tag.length) {
                        tag = $('<meta ' + attribute + '>');
                        $head.append(tag);
                    }
                    tag.attr('content', options[key] || DEFAULTS[key]);
                });
            });

            window.document.title = options.title || DEFAULTS.title;

            metatagUtils.trigger('change:metatags');
        },
    }, Backbone.Events);

    return metatagUtils;
});

define('core/utils/url/serializeArgs',['require','exports','module','core/utils/collection/each'],function (require, exports, module) {
    'use strict';

    var each = require('core/utils/collection/each');

    /**
     * Serializes object containing name:value pairs into a query string.
     *
     * @param {Object} params - The parameters to serialize.
     * @returns {string} - The query string.
     */
    module.exports = function serializeArgs(params) {
        var pcs = [];
        each(params, function (val, key) {
            if (val !== undefined)
                pcs.push(encodeURIComponent(key) + (val === null ? '' : '=' + encodeURIComponent(val)));
        });
        return pcs.join('&');
    };
});

define('core/utils/url/serialize',['require','exports','module','core/utils/url/serializeArgs'],function (require, exports, module) {
    'use strict';

    var serializeArgs = require('core/utils/url/serializeArgs');

    /**
     * Adds name:value pairs from object to the url's query string.
     *
     * @param {string} url - The base url. May already contain a query string.
     * @param {Object} [params] - The parameters to add.
     * @param {boolean} [nocache] - If true, a time-based parameter will be added to bust the cache.
     * @returns {string} - The url with parameters added.
     */
    module.exports = function serialize(url, params, nocache) {
        if (params) {
            if (url.indexOf('?') === -1)
                url += '?';
            else if (url.charAt(url.length - 1) !== '&')
                url += '&';

            url += serializeArgs(params);
        }

        if (nocache) {
            var ncp = {};
            ncp[(new Date()).getTime()] = null;
            return serialize(url, ncp);
        }

        var len = url.length;
        return url.charAt(len - 1) === '&' ? url.slice(0, len - 1) : url;
    };
});

define('core/shared/urls',['require','core/utils/object/extend','core/utils/url/serialize','core/utils/url/serializeArgs'],function (require) {
    'use strict';

    var extend = require('core/utils/object/extend');
    var serialize = require('core/utils/url/serialize');
    var serializeArgs = require('core/utils/url/serializeArgs');


    var base = '{{ BASE }}';

    // expects protocol-relative URLs, any http-protocol will be stripped
    // if it exists in the URL - this is to ensure HTTPS compatibility
    // `bootloader` expects a file ending with `.load.<MD5_Hash>.js`
    var apps = {
        lounge: '{{ LOUNGE_URL }}',

        // remove home/ from url since home also lives in disqus.com/by/<username>
        // TODO: change SECURE_HOME_URL to point to https://disqus.com/
        home: '{{ SECURE_HOME_URL }}'.replace('home/', ''),

        recommendations: '{{ RECOMMENDATIONS_URL }}',
    };

    var ensureHTTPSProtocol = function (url) {
        // Use string concatenation to ensure correct protocol is used
        // (even if regular expression does not match)
        return 'https://' + url.replace(/^\s*(\w+:)?\/\//, '');
    };

    /**
     * Returns a "host app url" that has the same protocol with the current URL
     * Uses the `apps` dictionary above for base URLs, takes in additional
     * parameters to be passed in the query string + the app configuration to be
     * put in the location hash, if desired.
     *
     * @param {string} name Name of the app. Should be in the `apps` dict above.
     * @param {Object} [params] A dictionary of extra QSA params.
     * @param {Object} [hashParams] The configuration of the app, to be passed in the URL hash..
     * @returns {string} The URL for the app, with proper parameters
     */
    var get = function (name, params, hashParams) {
        var appUrl = apps[name];

        if (!appUrl)
            throw new Error('Unknown app: ' + name);

        var baseUrl = ensureHTTPSProtocol(appUrl);

        var urlParams = extend({
            base: base,
        }, params || {});

        var hashString = hashParams ? '#' + serializeArgs(hashParams) : '';

        return serialize(baseUrl, urlParams) + hashString;
    };

    return {
        BASE: base,
        apps: apps,
        get: get,
        ensureHTTPSProtocol: ensureHTTPSProtocol,
    };
});

define('core/utils/uniqueId',[],function () {
    'use strict';

    var MAX_RANGE = 10000;
    var uid = Math.floor((Math.random() * MAX_RANGE) + 1);

    // NOTE: Ported from underscore 1.8.3
    return function uniqueId(prefix) {
        uid += 1;
        var id = String(uid);
        return prefix ? prefix + id : id;
    };
});

define('core/Events',['require','core/utils/collection/each','core/utils/object/has','core/utils/uniqueId'],function (require) {
    'use strict';

    var each = require('core/utils/collection/each');
    var has = require('core/utils/object/has');
    var uniqueId = require('core/utils/uniqueId');

    // Returns a function that will be executed at most one time, no matter how
    // often you call it. Useful for lazy initialization.
    var once = function (func) {
        var ran = false;
        var memo;

        return function () {
            if (ran) return memo;
            ran = true;
            memo = func.apply(this, arguments);
            func = null;
            return memo;
        };
    };
    var keys = Object.keys || function (obj) {
        if (obj !== Object(obj)) throw new TypeError('Invalid object');
        var keys = [];
        for (var key in obj) if (has(obj, key)) keys[keys.length] = key;
        return keys;
    };
    var slice = [].slice;

    // Backbone.Events
    // ---------------

    // A module that can be mixed in to *any object* in order to provide it with
    // custom events. You may bind with `on` or remove with `off` callback
    // functions to an event; `trigger`-ing an event fires all callbacks in
    // succession.
    //
    // var object = {};
    // _.extend(object, Backbone.Events);
    // object.on('expand', function(){ alert('expanded'); });
    // object.trigger('expand');
    //
    var Events = {

        // Bind an event to a `callback` function. Passing `"all"` will bind
        // the callback to all events fired.
        on: function (name, callback, context) {
            if (!eventsApi(this, 'on', name, [callback, context]) || !callback) return this;
            this._events = this._events || {};
            var events = this._events[name] || (this._events[name] = []);
            events.push({ callback: callback, context: context, ctx: context || this });
            return this;
        },

        // Bind an event to only be triggered a single time. After the first time
        // the callback is invoked, it will be removed.
        once: function (name, callback, context) {
            if (!eventsApi(this, 'once', name, [callback, context]) || !callback) return this;
            var self = this;
            var onced = once(function () {
                self.off(name, onced);
                callback.apply(this, arguments);
            });
            onced._callback = callback;
            return this.on(name, onced, context);
        },

        // Remove one or many callbacks. If `context` is null, removes all
        // callbacks with that function. If `callback` is null, removes all
        // callbacks for the event. If `name` is null, removes all bound
        // callbacks for all events.
        off: function (name, callback, context) {
            var retain, ev, events, names, i, nameLen, j, evtLen;
            if (!this._events || !eventsApi(this, 'off', name, [callback, context])) return this;
            if (!name && !callback && !context) {
                this._events = {};
                return this;
            }

            names = name ? [name] : keys(this._events);
            for (i = 0, nameLen = names.length; i < nameLen; i++) {
                name = names[i];
                if (events = this._events[name]) {  // eslint-disable-line no-cond-assign
                    this._events[name] = retain = [];
                    if (callback || context) {
                        for (j = 0, evtLen = events.length; j < evtLen; j++) {
                            ev = events[j];
                            if (
                                context && context !== ev.context ||
                                callback && callback !== ev.callback && callback !== ev.callback._callback
                            )
                                retain.push(ev);
                        }
                    }
                    if (!retain.length) delete this._events[name];
                }
            }

            return this;
        },

        // Trigger one or many events, firing all bound callbacks. Callbacks are
        // passed the same arguments as `trigger` is, apart from the event name
        // (unless you're listening on `"all"`, which will cause your callback to
        // receive the true name of the event as the first argument).
        trigger: function (name) {
            if (!this._events) return this;
            var args = slice.call(arguments, 1);
            if (!eventsApi(this, 'trigger', name, args)) return this;
            var events = this._events[name];
            var allEvents = this._events.all;
            if (events) triggerEvents(events, args);
            if (allEvents) triggerEvents(allEvents, arguments);
            return this;
        },

        // Tell this object to stop listening to either specific events ... or
        // to every object it's currently listening to.
        stopListening: function (obj, name, callback) {
            var listeners = this._listeners;
            if (!listeners) return this;
            var deleteListener = !name && !callback;
            if (typeof name === 'object') callback = this;
            if (obj) (listeners = {})[obj._listenerId] = obj;
            for (var id in listeners) {
                listeners[id].off(name, callback, this);
                if (deleteListener) delete this._listeners[id];
            }
            return this;
        },

    };

    // Regular expression used to split event strings.
    var eventSplitter = /\s+/;

    // Implement fancy features of the Events API such as multiple event
    // names `"change blur"` and jQuery-style event maps `{change: action}`
    // in terms of the existing API.
    var eventsApi = function (obj, action, name, rest) {
        if (!name) return true;

        // Handle event maps.
        if (typeof name === 'object') {
            for (var key in name)
                obj[action].apply(obj, [key, name[key]].concat(rest));

            return false;
        }

        // Handle space separated event names.
        if (eventSplitter.test(name)) {
            var names = name.split(eventSplitter);
            for (var i = 0, len = names.length; i < len; i++)
                obj[action].apply(obj, [names[i]].concat(rest));

            return false;
        }

        return true;
    };

    // A difficult-to-believe, but optimized internal dispatch function for
    // triggering events. Tries to keep the usual cases speedy (most internal
    // Backbone events have 3 arguments).
    var triggerEvents = function (events, args) {
        var ev, i;
        var len = events.length;
        var a1 = args[0];
        var a2 = args[1];
        var a3 = args[2];

        switch (args.length) {
        case 0:
            for (i = 0; i < len; i++)
                (ev = events[i]).callback.call(ev.ctx);
            return;
        case 1:
            for (i = 0; i < len; i++)
                (ev = events[i]).callback.call(ev.ctx, a1);
            return;
        case 2:
            for (i = 0; i < len; i++)
                (ev = events[i]).callback.call(ev.ctx, a1, a2);
            return;
        case 3:
            for (i = 0; i < len; i++)
                (ev = events[i]).callback.call(ev.ctx, a1, a2, a3);
            return;
        default:
            for (i = 0; i < len; i++)
                (ev = events[i]).callback.apply(ev.ctx, args);
        }
    };

    var listenMethods = { listenTo: 'on', listenToOnce: 'once' };

    // Inversion-of-control versions of `on` and `once`. Tell *this* object to
    // listen to an event in another object ... keeping track of what it's
    // listening to.
    each(listenMethods, function (implementation, method) {
        Events[method] = function (obj, name, callback) {
            var listeners = this._listeners || (this._listeners = {});
            var id = obj._listenerId || (obj._listenerId = uniqueId('l'));
            listeners[id] = obj;
            if (typeof name === 'object') callback = this;
            obj[implementation](name, callback, this);
            return this;
        };
    });

    // Aliases for backwards compatibility.
    Events.bind = Events.on;
    Events.unbind = Events.off;

    return Events;
});

define('core/apps/BaseApp',['require','core/Events','core/utils/object/extend','core/utils/object/has','core/utils/uniqueId'],function (require) {
    'use strict';

    var Events = require('core/Events');
    var extend = require('core/utils/object/extend');
    var has = require('core/utils/object/has');
    var uniqueId = require('core/utils/uniqueId');

    // The base application class for Disqus apps. It is a very "barebones"
    // class having an `extend` method on it for easy inheritance analogous to
    // Backbone classes' extend method. The class covers the following:
    //    * Assigns a uid and and the passed settings to the instances
    //    * Registers and unregisters the instance if the derived class has
    //      `register` and `unregister` *classmethods*
    //    * Supports the standard event interface from Backbone events:
    //      on, once, off, listenTo, stopListening, trigger
    //    * Assigns `event name: handler` mappings under `events` property using
    //      this.on. It traverses up to the root class and binds all events
    //      defined in all parent classes, in order. Thus an event handler on
    //      the parent class will always be executed before a handler defined
    //      for the same event on the child class. THIS IS SUPER IMPORTANT!
    //    * Does all the "magic" explained above for one-time events listed
    //      under `onceEvents` property using `this.once`.
    //    * Detaches all event listeners and stops listening to anything when
    //      destructor is called (destroy).
    var BaseApp = function (settings) {
        this.uid = uniqueId('dsq-app');

        this.settings = settings || {};

        var parents = [];
        var parent = this.constructor.prototype;

        do {
            parents.unshift(parent);
            parent = parent.constructor.__super__;
        } while (parent);

        // The event attaching order here is VERY important. It starts attaching
        // events from the top most parent and comes down to self which allows
        // proper inheritance: the handler on the base class is executed first
        for (var i = 0, length = parents.length; i < length; i++) {
            parent = parents[i];
            if (has(parent, 'events'))
                this.on(parent.events, this);
            if (has(parent, 'onceEvents'))
                this.once(parent.onceEvents, this);
        }
    };

    extend(BaseApp.prototype, Events);

    BaseApp.prototype.destroy = function () {
        this.off();
        this.stopListening();
    };

    // taken from Backbone extend helper
    BaseApp.extend = function (protoProps, staticProps) {
        var parent = this; // eslint-disable-line consistent-this
        var child;

        // The constructor function for the new subclass is either defined by you
        // (the "constructor" property in your `extend` definition), or defaulted
        // by us to simply call the parent's constructor.
        if (protoProps && has(protoProps, 'constructor'))
            child = protoProps.constructor;
        else
            child = function () { return parent.apply(this, arguments); };

        // Add static properties to the constructor function, if supplied.
        extend(child, parent, staticProps);

        // Set the prototype chain to inherit from `parent`, without calling
        // `parent`'s constructor function.
        var Surrogate = function () { this.constructor = child; };
        Surrogate.prototype = parent.prototype;
        child.prototype = new Surrogate();

        // Add prototype properties (instance properties) to the subclass,
        // if supplied.
        if (protoProps) extend(child.prototype, protoProps);

        // Set a convenience property in case the parent's prototype is needed
        // later.
        child.__super__ = parent.prototype;

        return child;
    };

    return BaseApp;
});

define('core/utils/lang/isString',[],function () {
    'use strict';

    return function isString(str) {
        return Object.prototype.toString.call(str) === '[object String]';
    };
});

define('core/utils/html/setInlineStyle',['require','core/utils/collection/each','core/utils/lang/isString','core/utils/object/extend'],function (require) {
    'use strict';

    var each = require('core/utils/collection/each');
    var isString = require('core/utils/lang/isString');
    var extend = require('core/utils/object/extend');

    // WARNING: collapsing white space on an input is an XSS hazard.
    //
    // If you try to pass this function's return value or use this function
    // outside of this module, you MUST make it safer.
    //
    // For more info, see discussion at:
    // http://phabricator.local.disqus.net/D22393#inline-161397
    function normalizeCssPropertyName(propName) {
        return propName.replace(/\s+/g, '').toLowerCase();
    }

    // WARNING:
    // DOM-modifying function
    // Does NOT escape inputs
    // XSS hazard
    //
    // This function does not escape inputs; therefore if you pass outside
    // inputs into this function, you open up the code to an XSS attack
    // via CSS.
    //
    // Do NOT pass unknown values into this function!
    return function setInlineStyle(elem, prop, value) {
        var _styles = {};
        if (isString(prop))
            _styles[prop] = value;
        else
            _styles = prop;

        // Avoid modifying the original object passed into this function
        var styles = extend({}, _styles);

        // - normalize all keys
        //
        // - convert any null values to empty strings
        //   because CSS DOM API in some browsers (probably just IE9)
        //   does not understand null, only empty strings
        //
        // - ignore keys with undefined values
        each(styles, function (val, key) {
            var normalizedKey = normalizeCssPropertyName(key);
            if (normalizedKey !== key) {
                delete styles[key];
                styles[normalizedKey] = val;
            }

            if (val === null)
                styles[normalizedKey] = '';

            if (val === void 0)
                delete styles[normalizedKey];
        });

        var style = elem.style;

        each(styles, function (val, key) {
            // Casting `value` to a string explicitly here since IE9 throws
            // an exception if you pass something else, like a Number
            style.setProperty(key, String(val), 'important');
        });
    };
});

define('core/common/kernel/utils',['require'],function (require) {
    'use strict';

    var document = window.document;
    var anchor = document.createElement('a');

    function getContainer(container) {
        // This function assumes that document.body is defined. So if this
        // function is called in the <head> section and before <body> gets
        // defined, it will return documentElement which is weird but okay.
        return document.getElementById(container) ||
               document.body || document.documentElement;
    }

    function getHost(url) {
        anchor.href = url;

        return anchor.hostname;
    }

    function getOffset(elem, container) {
        container = container || document.documentElement;

        var node = elem;
        var left = 0;
        var top = 0;

        // Stop if we reach the container (or body)
        while (node && node !== container) {
            left += node.offsetLeft;
            top += node.offsetTop;
            node = node.offsetParent;
        }

        return {
            top: top,
            left: left,
            height: elem.offsetHeight,
            width: elem.offsetWidth,
        };
    }

    return {
        getContainer: getContainer,
        getHost: getHost,
        getOffset: getOffset,
    };
});

define('core/host/globalFromSandbox',['require'],function (require) {
    'use strict';

    var document = window.document;
    var frame = document.createElement('iframe');

    frame.style.display = 'none';

    /**
     * Utility to get unaltered version of global built-ins
     * like JSON, Math, etc.
     *
     * This is needed because host pages can modify the properties
     * of built-in objects.
     *
     * It works by opening a srcless iframe and returning
     * iframe's (unaltered) instance of the built-in object.
     *
     * Falls back to fallbackWin's instance of the built-in
     * if it cannot get a non-null instance from the iframe.
     *
     * usage:
     *     var JSON = globalFromSandbox('JSON', window);
     *
     * @param   {string} name The name of the built-in
     * @param   {Window} fallbackWin A fallback `window` object to use if sandbox fails
     * @returns {Object}      Instance of the built-in
     */
    return function globalFromSandbox(name, fallbackWin) {
        var fallback = fallbackWin && fallbackWin[name] || null;

        try {
            // Make sure we're attached to the "current" body since
            // sometimes the iframe gets removed by publishers changing
            // innerHTML etc. We also need to make sure that `frame.parentNode`
            // is equal to `document.body` since things like Turbolinks completely
            // rewrite the whole document innerHTML causing document.body to be
            // replaced and `frame.parentNode` pointing to the "old" instance of
            // the body element. In this case `frame.contentWindow` still is `null`
            // since the frame is not placed on the actual DOM.
            if (frame.parentNode !== document.body)
                document.body.appendChild(frame);

            return frame.contentWindow[name] || fallback;
        } catch (err) {
            return fallback;
        }
    };
});

define('core/host/json',['require','core/host/globalFromSandbox'],function (require) {
    'use strict';

    var win = window;

    var globalFromSandbox = require('core/host/globalFromSandbox');

    var _JSON;

    // Does the global window.JSON object seem to be native and pure?
    // NOTE: This trick (Object.prototype.toString) was taken from underscore
    if (win.Object.prototype.toString.call(win.JSON) === '[object JSON]')
        _JSON = win.JSON;
    else
        _JSON = globalFromSandbox('JSON', win);

    if (!_JSON)  // if still no JSON, you're screwed
        return {};

    return _JSON;
});

define('core/common/kernel/WindowBase',['require','core/Events','core/utils/object/extend','core/utils/uniqueId','core/common/kernel/utils','core/host/json'],function (require) {
    'use strict';

    var Events = require('core/Events');
    var extend = require('core/utils/object/extend');
    var uniqueId = require('core/utils/uniqueId');

    var utils = require('core/common/kernel/utils');

    var JSON = require('core/host/json'); // eslint-disable-line no-shadow

    //
    // WindowBase
    //
    // Base window class. Inherited by Popup and Iframe.
    //

    var WindowBase = function (opts) {
        opts = opts || {};

        this.state = WindowBase.INIT;
        this.uid = opts.uid || uniqueId('dsq-frame');  // each window gets a unique ID
        this.origin = opts.origin;
        if (opts.useSourcelessFrame) {
            this.host = utils.getHost(window.location.href);
        } else {
            this.host = utils.getHost(this.origin);
        }
        this.target = opts.target;  // target url
        this.sandbox = opts.sandbox;
        this.window = null;

        WindowBase.windows[this.uid] = this;  // register the window instance

        this.on('ready', function () {
            this.state = WindowBase.READY;
        }, this);

        this.on('die', function () {
            this.state = WindowBase.KILLED;
        }, this);
    };

    extend(WindowBase, {
        INIT: 0,
        READY: 1,
        KILLED: 2,

        windows: {},

        // Make postMessage called this way so that we can stub it in IE.
        postMessage: function (win, message, origin) {
            return win.postMessage(message, origin);
        },

    });

    extend(WindowBase.prototype, Events);

    /**
     * Wraps a function so that its execution will be delayed until
     * the window is ready. Also executes the function in the same
     * context as requiresWindow.
     *
     * Note that, since execution may be asynchronous, the return
     * value of the wrapped function is discarded.
     *
     * @param {function} fn - The function to wrap
     * @returns {function} - The wrapped function
     */
    WindowBase.prototype.requiresWindow = function (fn) {
        var self = this;

        return function () {
            var args = Array.prototype.slice.call(arguments);

            var pollForWindow = function () {
                var win = self.window;
                if (win) {
                    fn.apply(self, args);
                } else {
                    setTimeout(pollForWindow, 500); // eslint-disable-line no-magic-numbers
                }
            };

            if (self.isReady()) {
                pollForWindow();
            } else { // queue until the ready event occurs.
                self.on('ready', pollForWindow);
            }
        };
    };

    WindowBase.prototype.sendMessage = function (name, data) {
        var message = JSON.stringify({
            scope: 'client',
            name: name,
            data: data,
        });

        this.requiresWindow(function (msg) {
            WindowBase.postMessage(this.window, msg, this.origin);
        })(message);
    };

    // Overload these where applicable
    WindowBase.prototype.hide = function () {};

    WindowBase.prototype.show = function () {};

    WindowBase.prototype.url = function () {
        return this.target;
    };

    WindowBase.prototype.destroy = function () {
        this.state = WindowBase.KILLED;

        this.off(); // Unbind any events
    };

    WindowBase.prototype.isReady = function () {
        return this.state === WindowBase.READY;
    };

    // Returns true if this window has become destroyed - either
    // by us, or by the user (i.e. user manually closes a window).
    WindowBase.prototype.isKilled = function () {
        return this.state === WindowBase.KILLED;
    };

    return WindowBase;
});

define('core/common/kernel/Iframe',['require','core/utils/html/setInlineStyle','core/utils/object/extend','core/common/kernel/WindowBase','core/common/kernel/utils'],function (require) {
    'use strict';

    var setInlineStyle = require('core/utils/html/setInlineStyle');
    var extend = require('core/utils/object/extend');

    var WindowBase = require('core/common/kernel/WindowBase');
    var utils = require('core/common/kernel/utils');

    var document = window.document;

    //
    // Iframe
    //
    // Base iframe wrapper class. Inherited by Channel and Sandbox.
    //

    var Iframe = function (opts) {
        WindowBase.call(this, opts);

        this.styles = opts.styles || {};
        this.tabIndex = opts.tabIndex || 0;
        this.title = opts.title || 'Disqus';
        this.sandbox = opts.sandbox;

        // The element that contains this iframe
        this.container = opts.container;
        this.elem = null;  // The iframe element
    };

    extend(Iframe.prototype, WindowBase.prototype);

    Iframe.prototype.load = function () {
        var elem = this.elem = document.createElement('iframe');

        elem.setAttribute('id', this.uid);
        elem.setAttribute('name', this.uid);
        elem.setAttribute('allowTransparency', 'true'); // < IE8 iframe transparency
        elem.setAttribute('frameBorder', '0');
        elem.setAttribute('scrolling', 'no');

        // This part is for accessibility
        if (this.role)
            elem.setAttribute('role', this.role);
        elem.setAttribute('tabindex', this.tabIndex);
        elem.setAttribute('title', this.title);

        // An empty string is valid for the `sandbox` attribute
        if (typeof this.sandbox === 'string')
            elem.setAttribute('sandbox', this.sandbox);

        this.setInlineStyle(this.styles);
    };

    Iframe.prototype.getOffset = function (container) {
        return utils.getOffset(this.elem, container);
    };

    // Utility method for setting an inline style on the frame.
    // Automatically gives all styles '!important' precedence,
    // in order to reduce CSS conflicts with the parent page.
    //
    // Translation: if you don't use this function to set inline
    // styles, you WILL get hosed by publisher styles. Use it!
    //
    // Usage:
    //    frame.setInlineStyle('height', '500px');
    //    frame.setInlineStyle({ height: '500px', display: 'block' });
    //
    // WARNING:
    // DOM-modifying function
    // Does NOT escape inputs
    // XSS hazard
    //
    // This function does not escape inputs; therefore if you pass outside
    // inputs into this function, you open up the code to an XSS attack
    // via CSS.
    //
    // Do NOT pass unknown values into this function!
    Iframe.prototype.setInlineStyle = function (prop, value) {
        return setInlineStyle(this.elem, prop, value);
    };

    Iframe.prototype.removeInlineStyle = function (prop) {
        var style = this.elem.style;
        if ('removeProperty' in style)
            return void style.removeProperty(prop);

        style[prop] = '';
    };

    Iframe.prototype.hide = function () {
        this.setInlineStyle('display', 'none');
    };

    Iframe.prototype.show = function () {
        this.removeInlineStyle('display');
    };

    Iframe.prototype.destroy = function () {
        if (this.elem && this.elem.parentNode) {
            this.elem.parentNode.removeChild(this.elem);
            this.elem = null;
        }

        return WindowBase.prototype.destroy.call(this);
    };

    return Iframe;
});

define('core/utils/function/throttle',[],function () {
    'use strict';

    // Modified Underscore.js throttle implementation
    // Trailing calls can be delayed more than the throttle delay
    return function throttle(func, delay, additionalTrailingDelay) {
        if (!additionalTrailingDelay)
            additionalTrailingDelay = 0;

        var context, args, timeout, result;
        var previous = 0;
        var later = function () {
            previous = new Date();
            timeout = null;
            result = func.apply(context, args);
        };
        return function () {
            var now = new Date();
            var remaining = delay - (now - previous);
            context = this;  // eslint-disable-line consistent-this
            args = arguments;
            if (remaining <= 0) {
                clearTimeout(timeout);
                timeout = null;
                previous = now;
                result = func.apply(context, args);
            } else if (!timeout) {
                timeout = setTimeout(later, remaining + additionalTrailingDelay);
            }
            return result;
        };
    };
});

/*
 * Disqus Kernel
 *
 * The kernel is the main component of most embeddable Disqus products;
 * it is a bridge between applications and the actual publisher's DOM.
 * In addition to that, the kernel also manages all communications
 * between applications.
 *
 */

// For local development only, will get removed on production builds automatically by dead code elimination
if (!'{{ BUILD_OPTIMIZED }}' && !window.geturl) { // eslint-disable-line
    /* eslint-disable strict */
    window.geturl = function (url) {
        // eslint-disable-next-line no-constant-condition
        var appDir = '{{ APP_NAME }}' ? '{{ APP_NAME }}/' : '';
        return '{{ NEXT_BASE }}/' + appDir + url;
    };
    /* eslint-enable strict */
}

define('core/host/kernel',['require','exports','module','core/Events','core/utils/lang/isString','core/utils/object/has','core/utils/object/extend','core/common/kernel/Iframe','core/common/kernel/utils','core/common/kernel/WindowBase','core/host/json','core/utils/function/throttle'],function (require, exports) {
    'use strict';

    var Events = require('core/Events');
    var isString = require('core/utils/lang/isString');
    var has = require('core/utils/object/has');
    var extend = require('core/utils/object/extend');
    var Iframe = require('core/common/kernel/Iframe');
    var utils = require('core/common/kernel/utils');
    var WindowBase = require('core/common/kernel/WindowBase');

    var JSON = require('core/host/json'); // eslint-disable-line no-shadow

    var document = window.document;

    exports.throttle = require('core/utils/function/throttle');

    // window.postMessage receiver
    //
    // NOTE: Instead of having a separate receiver for each channel,
    //       we have a single eventListener that delegates to the
    //       appropriate channel.
    window.addEventListener('message', function (event) {
        var message;
        try {
            message = JSON.parse(event.data);
        } catch (err) {
            return;  // quit
        }

        // Does the message has a valid sender UID
        var senderId = message.sender;
        var sender = has(WindowBase.windows, senderId) && WindowBase.windows[senderId];

        // Message is not valid, ignore
        if (!(sender && utils.getHost(event.origin) === sender.host)) {
            return;
        }

        // If the message is valid, but the origins don't match, that means that
        // the iframe was redirected http->https. We need to update our corresponding
        // origin value in order to send a return message later.
        //
        // NOTE: This relies on us receiving a message from the iframe with the new origin
        //       *before* we attempt to send a message back.
        if (event.origin !== sender.origin) {
            sender.origin = event.origin;
        }

        if (message.scope === 'host') {  // ignore any other scopes for now
            sender.trigger(message.name, message.data);
        }

        if (message.name === 'error') {
            exports.trigger('error', message.data);
        }
    });

    // TODO: pass all these events into the frame in a transparent
    // way on a `require('host/window')` module or something like
    // that. Then in the frame, we could
    //      `$(require('host/window')).on('hashchange', ...)`
    window.addEventListener('hashchange', function () {
        exports.trigger('window.hashchange', {
            hash: window.location.hash,
        });
    });

    /* eslint-disable no-magic-numbers */
    window.addEventListener('resize', exports.throttle(function () {
        exports.trigger('window.resize');
    }, 250, 50));

    document.addEventListener('mousemove', exports.throttle(function () {
        exports.trigger('window.mousemove');
    }, 250, 50));

    var triggerScroll = function () {
        exports.trigger('window.scroll');
    };

    window.addEventListener('scroll', exports.throttle(triggerScroll, 250, 50), false);
    /* eslint-enable no-magic-numbers */
    document.addEventListener('click', function () {
        // NOTE: It appears that the browser doesn't fire the click event on the
        // parent window if a click occurs inside the iframe. So we don't need
        // to verify the event target (checked in Chrome, Firefox)
        exports.trigger('window.click');
    });

    //
    // Popup
    //
    // Wraps a popup window.
    //
    var Popup = exports.Popup = function (opts) {
        opts.uid = opts.windowName;

        WindowBase.call(this, opts);
    };

    extend(Popup.prototype, WindowBase.prototype);

    Popup.prototype.load = function () {
        var win = this.window = window.open('', this.uid || '_blank');

        win.location = this.url();
    };

    Popup.prototype.isKilled = function () {
        // NOTE: In iOS Safari, popup windows don't invoke onbeforeunload,
        //       and cannot inform the parent document that they have become
        //       closed. So, we additionally check for the window.closed property,
        //       which reports accurately in that browser. (All other Disqus-
        //       supported browsers correctly update the _isKilled property.)
        return WindowBase.prototype.isKilled() || this.window.closed;
    };

    // Channel is an external iframe that communicates back to the
    // parent page (this context).

    var Channel = exports.Channel = function (opts) {
        var self = this;

        self.window = null;

        Iframe.call(self, opts);

        // Optional: an additional element to position around
        // Only one of the two options should be specified
        this.insertBeforeEl = opts.insertBeforeEl;
        this.insertAfterEl = opts.insertAfterEl;

        self.useSourcelessFrame = opts.useSourcelessFrame;

        // min-width 100% with a width constant is to allow iframe to be responsive on iOS devices, which
        // have a buggy width:100% implementation on iframes
        // fix from: http://stackoverflow.com/q/20123960/90297
        self.styles = extend({
            'width': '1px',
            'min-width': '100%',
            'border': 'none',
            'overflow': 'hidden',
            'height': '0',
        }, opts.styles || {});
    };

    extend(Channel.prototype, Iframe.prototype);

    Channel.prototype.load = function (onload) {
        var self = this;

        Iframe.prototype.load.call(self);

        var elem = self.elem;
        elem.setAttribute('width', '100%');

        if (self.useSourcelessFrame) {
            var request = new window.XMLHttpRequest();
            request.open('GET', self.url());
            request.onreadystatechange = function () {
                if (elem.contentWindow && request.readyState === elem.contentWindow.XMLHttpRequest.DONE) {
                    if (request.status === 200) { // eslint-disable-line no-magic-numbers
                        elem.contentWindow.document.write(request.responseText);
                    }
                }
            };
            request.send();
        } else {
            elem.setAttribute('src', self.url());
        }

        elem.addEventListener('load', function () {
            self.window = elem.contentWindow;

            if (onload) {
                onload();
            }

        });

        var container = isString(self.container) ?
            utils.getContainer(self.container) : self.container;

        // WARNING: Make sure you use `null` here instead of `undefined` since
        //          this value is directly used in the `insertBefore` call as
        //          the second argument and IE10 blows when it is `undefined`.
        //          See: https://github.com/lhorie/mithril.js/issues/353
        //          See: http://stackoverflow.com/q/15342341/90297
        var beforeElement = (self.insertAfterEl ? self.insertAfterEl.nextSibling : self.insertBeforeEl) || null;
        container.insertBefore(elem, beforeElement);
    };

    Channel.prototype.destroy = function () {
        this.window = null;

        return Iframe.prototype.destroy.call(this);
    };

    // Expose events interface
    exports.on = Events.on;
    exports.off = Events.off;
    exports.trigger = Events.trigger;
});

define('core/apps/WindowedApp',['require','core/utils/object/extend','core/shared/urls','core/apps/BaseApp','core/host/kernel'],function (require) {
    'use strict';

    var extend = require('core/utils/object/extend');

    var urls = require('core/shared/urls');

    var BaseApp = require('core/apps/BaseApp');

    var kernel = require('core/host/kernel');


    var doc = window.document;

    // The base class for any "windowed" app, that is using another "window"
    // other than the window object on the page itself. Makes use of
    // Channel or Popup according to settings.
    // Having a "windowName" attribute defined on the settings object will
    // cause it to create a popup using that name, otherwise it will use the
    // Channel class with an expected container to put the iframe that Channel
    // uses. Covers the following:
    //    * Expects the instance or the derived class to have a "url" property
    //      defining url for the application. It is assumed to be a protocol-
    //      relative URL.
    //    * If a `getFrameSettings` method is defined on the instance or the
    //      derived class it will be called right before creating the "window"
    //      passing the automatically built settings object. The method is
    //      expected to return a settings object. It can be the same object
    //      that was passed to it or a new one, but it SHOULD return a valid
    //      settings object to be passed to Channel or Popup constructor.
    //    * Provides an `init` method as the main entry point. Calling this
    //      method will call trigger "state:INIT" event, then call `getFrame`
    //      to create the frame, which will call `getFrameSettings` as
    //      explained above. Assign the returned "frame" instance to `this.frame`
    //      proxy all events on the frame to the instance itself under the
    //      namespace "frame:" (eg frame:ready) and trigger "change:frame" after
    //      this. Then it will load the frame using the `target` attribute on
    //      frame settings, trigger 'state:LOADED' event when frame is loaded.
    //    * It will clean-up its frame when the instance is destroyed.
    //    * It will do and support everything BaseApp does and supports.
    var WindowedApp = BaseApp.extend({
        // You need a name that matches a key in next.host.urls.apps for the
        // app to get proper URLs
        name: null,
        loaderVersion: null,
        frame: null,
        origin: urls.ensureHTTPSProtocol('{{ DISQUS_URL }}'),
        state: null,

        getUrl: function (params, hashParams) {
            // If applicable, add the loader version to the params
            if (this.loaderVersion) {
                hashParams = extend({
                    version: this.loaderVersion,
                }, hashParams);
            }

            // NOTE: urls.get already does this but without the HTTPS enforcement
            //       This is a minor hack and should be fixed once the HTTPS
            //       experiment is finalized.

            return urls.ensureHTTPSProtocol(urls.get(this.name, params, hashParams));
        },

        getFrameSettings: function () {
            var frameSettings = {
                target: this.getUrl(),
                origin: this.origin,
                uid: this.uid,
                sandbox: this.sandbox,
            };

            var settings = this.settings;
            if (settings.windowName) {
                frameSettings.windowName = settings.windowName;
            } else {
                frameSettings.container = settings.container || doc.body;
            }

            if (settings.styles) {
                frameSettings.styles = settings.styles;
            }

            frameSettings.useSourcelessFrame = settings.useSourcelessFrame;

            return frameSettings;
        },

        getFrame: function () {
            var frameSettings = this.getFrameSettings();
            var FrameConstructor = frameSettings.windowName ? kernel.Popup : kernel.Channel;
            return new FrameConstructor(frameSettings);
        },

        setState: function (state) {
            var constructor = this.constructor; // eslint-disable-line no-shadow

            if (!(state in constructor.states)) {
                return false;
            }

            this.state = constructor.states[state];
            this.trigger('state:' + state);
        },

        init: function () {
            var self = this;
            var frame;

            self.frame = frame = this.getFrame();

            // We relay all events originating from the frame on our actual
            // instance by prefixing them with "frame:" which allows one to
            // listen to all "frame" events too even if the underlying frame
            // object is changed or not ready yet. This is almost the same
            // pattern we use in SessionModel to relay User events to session
            self.listenTo(frame, 'all', function (name, data) {
                self.trigger('frame:' + name, data, frame);
            });

            self.listenTo(frame, 'resize', function (data) {
                self.lastResizedHeight = data.height;
            });

            self.trigger('change:frame', frame);

            self.frame.load(function () {
                self.setState('LOADED');
            });

            self.setState('INIT');
        },

        destroy: function () {
            var frame = this.frame;
            if (frame) {
                this.stopListening(frame);
                frame.destroy();
            }

            this.setState('KILLED');
            this.frame = null;
            BaseApp.prototype.destroy.call(this);
        },

        events: {
            'frame:ready': function () {
                this.setState('READY');
            },
        },
    }, {
        states: {
            INIT: 0,  // Iframe has been created but received no further messages
            LOADED: 1,  // Received the iframe's load event
            READY: 2,  // Received a message from the iframe client indicating the code is ready
            RUNNING: 3,  // Iframe is operational and visible
            KILLED: 4,
        },
    });

    return WindowedApp;
});

define('core/utils/function/debounce',[],function () {
    'use strict';

    // NOTE: Ported from underscore 1.8.3
    return function debounce(func, wait, immediate) {
        var timeout, args, context, timestamp, result;

        var later = function () {
            var last = new Date().getTime() - timestamp;

            if (last < wait && last >= 0) {
                timeout = setTimeout(later, wait - last);
            } else {
                timeout = null;
                if (!immediate) {
                    result = func.apply(context, args);
                    if (!timeout) context = args = null;
                }
            }
        };

        return function () {
            context = this;  // eslint-disable-line consistent-this
            args = arguments;
            timestamp = new Date().getTime();
            var callNow = immediate && !timeout;
            if (!timeout) timeout = setTimeout(later, wait);
            if (callNow) {
                result = func.apply(context, args);
                context = args = null;
            }

            return result;
        };
    };
});

define('core/utils/array/indexOf',[],function () {
    'use strict';

    return function indexOf(arr, val) {
        for (var i = 0; i < arr.length; ++i) {
            if (arr[i] === val)
                return i;
        }

        return -1;
    };
});

define('core/utils/array/some',[],function () {
    'use strict';

    return function some(arr, callback, that) {
        for (var i = 0; i < arr.length; ++i) {
            if (callback.call(that, arr[i], i, arr))
                return true;
        }

        return false;
    };
});

define('core/utils/html/getCurrentStyle',[],function () {
    'use strict';

    // Cross-browser compatible function for getting computed styles on an element
    // Sorry for the stupid name, it's to avoid shadowing the global, native one.

    // http://www.quirksmode.org/dom/w3c_css.html
    // W3C (WebKit, Firefox, IE9+)
    if (window.getComputedStyle) {
        return function getCurrentStyle(elem, prop, _camel) {
            try {
                // We need this to both protect for the case where `elem` is not valid,
                // such as it being `document` and for the broken ShadowDOMPolyfill script.
                // See https://git.io/vrPIf for more details.
                return window.document.defaultView.getComputedStyle(elem, null).getPropertyValue(prop);
            } catch (err) {
                return null;
            }
        };
    }

    // IE < 9, Opera
    return function getCurrentStyle(elem, prop, camel) {
        return elem.currentStyle[prop] || elem.currentStyle[camel];
    };
});

define('core/utils/html/isVisible',[
    'core/utils/html/getCurrentStyle',
], function (
    getCurrentStyle
) {
    'use strict';

    /**
     * Determine if an element is visible in terms of page layout.
     * NOTE: "Visible" includes elements which have no width nor height but are positioned.
     *
     * @param {Element} elem - The element to check
     * @returns {boolean} - If the element has layout effect
     */

    return function isVisible(elem) {
        return Boolean(
            elem &&
            (elem.offsetWidth || elem.offsetHeight || elem.getClientRects().length) &&
            getCurrentStyle(elem, 'visibility') !== 'hidden'
        );
    };
});

define('core/utils/lang/isFunction',[],function () {
    'use strict';

    // NOTE: Approach adapted from underscore 1.8.3
    return function isFunction(obj) {
        return Object.prototype.toString.call(obj) === '[object Function]';
    };
});

define('core/utils/object/result',[
    'core/utils/lang/isFunction',
], function (
    isFunction
) {
    'use strict';

    // NOTE: Ported from underscore 1.8.3
    return function result(object, property, fallback) {
        var value = object === null || object === void 0 ? void 0 : object[property];
        if (value === void 0)
            value = fallback;
        return isFunction(value) ? value.call(object) : value;
    };
});

define('core/utils/lang/isElement',[],function () {
    'use strict';

    // NOTE: Ported from underscore 1.8.3
    return function isElement(obj) {
        return Boolean(obj && obj.nodeType === 1);
    };
});

/** @module stance/utils */

define('stance/utils',[
    'exports',

    'core/utils/lang/isElement',
    'core/utils/uniqueId',
], function (
    exports,

    isElement,
    uniqueId
) {
    'use strict';

    /**
     * Extracts element from container if applicable.
     *
     * @param {Element-like} obj
     * @returns {?HTMLElement}
     */
    exports.getElement = function (obj) {
        if (isElement(obj))
            return obj;

        return obj && obj.el;
    };

    exports.EL_ID_ATTR = 'data-visibility-id';
    exports.OBJ_ID_PROP = '_visibility_id';

    /**
     * Get or create an id for the element or element container, or return null.
     *
     * @param {Element-like} obj
     * @returns {?number} Id of the associated element / view
     */
    exports.getId = function (obj) {
        // Gets the id (possibly creating it)
        var id = null;

        // TODO: Refactor
        if (isElement(obj)) {
            // Store the id as an element attribute
            id = obj.getAttribute(exports.EL_ID_ATTR) || null;

            if (!id) {
                id = uniqueId();
                obj.setAttribute(exports.EL_ID_ATTR, id);
            }
        } else if (obj) {
            // Store it as a property
            id = obj[exports.OBJ_ID_PROP] || null;

            if (!id)
                id = obj[exports.OBJ_ID_PROP] = uniqueId();
        }
        return id;
    };

    /**
     * Calculate the the percentage of an element visible in
     * the viewport given the scroll position and the element's offset.
     *
     * @param {ViewportPos} pos - Scroll information.
     * @param {FullOffset} offset - Element's full offset information.
     * @returns {Integer} Percent between 0 and 100
     */
    exports.visiblePercent = function (pos, offset) {
        var percent = 0;

        if (!offset)
            return percent;

        var screenTop = pos.top;
        var screenBottom = screenTop + pos.height;

        var bleedsTop = offset.visibleTop < screenTop;
        var bleedsBottom = offset.visibleBottom > screenBottom;

        // If the view bleeds over the top and bottom of the viewport then it
        // is filling the entire viewport, so report 100%. Otherwise, if it
        // bleeds over neither, then it is completely in view, so also report 100%.
        if ((!bleedsTop && !bleedsBottom) || (bleedsTop && bleedsBottom))
            percent = 1;
        // If the view is bleeding off the top, the calculate how much of the bottom of the view is visible.
        else if (bleedsTop)
            percent = (offset.height - (screenTop - offset.visibleTop)) / offset.height;
        // Otherwise, if bleeding off the bottom, then calculate how much of the top of the view is visible.
        else if (bleedsBottom)
            percent = (screenBottom - offset.visibleTop) / offset.height;

        return Math.round(percent * 100);
    };

});

/** @module stance/tracking */

define('stance/tracking',[
    'core/utils/array/indexOf',
    'core/utils/array/some',
    'core/utils/html/isVisible',
    'core/utils/object/result',

    './utils',

    'exports',
], function (
    indexOf,
    some,
    isElementVisible,
    getResult,

    utils,

    exports
) {
    'use strict';

    /**
     * Currently registered event wrappers.
     *
     * @type {Array.<Stance>}
     */
    exports.events = [];

    /**
     * Last position passed to exports.scroll.
     * Useful for user-facing methods like isVisible.
     *
     * @type {?ViewportPos}
     */
    exports.lastPos = null;

    /**
     * Clear cached measurements.
     *
     * @param {Element-like} [obj] - Element or object to clear cached
     *   measurements for. If omitted, entire cache will be cleared.
     */
    exports.clearCache = function (obj) {
        if (obj === undefined) {
            exports.getElementOffset.cache = {};
        } else {
            var id = utils.getId(obj);
            if (id)
                exports.getElementOffset.cache[id] = null;
        }
    };

    /**
     * Offset of element.
     *
     * @typedef ElementOffset
     * @property {number} top - Offset of element from top of document.
     * @property {number} height - Height of element.
     */

    /**
     * Calculate the top offset and height of an element.
     * Returns null if element is not visible.
     *
     * @param {external:HTMLElement} el
     * @returns {?ElementOffset}
     */
    exports.calculateOffset = function (el) {
        if (!el)
            return null;

        // Element must be in DOM to measure
        if (!isElementVisible(el))
            return null;

        var docElem = el.ownerDocument.documentElement;
        return {
            height: el.offsetHeight,
            top: el.getBoundingClientRect().top +
                window.pageYOffset - (docElem.clientTop || 0),
        };
    };

    /**
     * Offset of element, modified by topEdgeOffset and bottomEdgeOffset.
     *
     * @typedef FullOffset
     * @property {number} visibleTop - First pixel from the top of the containing
     *   document which must be above screen bottom to consider element as visible.
     * @property {number} visibleBottom - Last pixel from the top of the containing
     *   document which must be below screen top to consider element as visible.
     * @property {number} offsetTop - Offset of element from the top of the
     *   containing document.
     * @property {number} height - Height of element.
     */

    /**
     * Get the modified offset of an element.
     *
     * @param {Element-like} obj
     * @returns {?FullOffset}
     */
    exports._getElementOffset = function (obj) {
        var el = utils.getElement(obj);
        if (!el)
            return null;

        var offset = exports.calculateOffset(el);
        if (!offset)
            return null;

        return {
            visibleTop: offset.top + (getResult(obj, 'topEdgeOffset') || 0),
            visibleBottom: offset.top + offset.height - (getResult(obj, 'bottomEdgeOffset') || 0),
            offsetTop: offset.top,
            height: offset.height,
        };
    };

    /**
     * Get the modified offset of an element, retrieving the cached version if possible
     *
     * @function
     * @param {Element-like} obj
     * @returns {?FullOffset}
     */
    exports.getElementOffset = (function () {
        // A modified _.memoize approach which:
        // 1. Better supports testing
        // 2. Does not cache when unable to generate key
        // 3. Does not cache when result is falsy
        var memoized = function (obj) {
            var cache = memoized.cache;
            var key = utils.getId(obj);

            if (key && cache[key])
                return cache[key];

            var result = exports._getElementOffset(obj);
            if (key && result)
                cache[key] = result;

            return result;
        };
        memoized.cache = {};
        return memoized;
    }());

    exports.EVENT_NAMES = [
        'enter',
        'exit',
        'visible',
        'invisible',
        'all',
    ];

    /**
     * Update internal tracking of element.
     *
     * Checks if there are any relevant event listeners on
     * the wrapper and starts or stops tracking as a result.
     *
     * @param {Stance} wrapper
     */
    exports.updateTracking = function (wrapper) {
        var lastIndex;
        var propOf = function (obj) {
            if (!obj)
                return function () { return undefined; };
            return function (key) {
                return obj[key];
            };
        };

        if (some(exports.EVENT_NAMES, propOf(wrapper._events))) {
            // Start tracking
            lastIndex = indexOf(exports.events, wrapper);
            if (lastIndex === -1)
                exports.events.push(wrapper);
        } else {
            // Remove existing tracking (if any)
            lastIndex = indexOf(exports.events, wrapper);
            if (lastIndex !== -1)
                exports.events.splice(lastIndex, 1);
        }
    };

    /**
     * Call any applicable event handlers.
     *
     * @param {ViewportPos} pos - Scroll information.
     */
    exports.processEvents = function (pos) {
        exports.lastPos = pos;
        var events = exports.events;

        if (!events.length)
            return;

        // Iterate backwards to allow events to remove themselves
        // (ex. via Backbone.Events.once)
        // TODO: This is not fully safe as an event callback could alter
        //       events other than itself
        for (var i = events.length - 1; i >= 0; --i) {
            var wrapper = events[i];
            var visible = wrapper.isVisible(pos);

            if (visible === null)
                continue;

            if (visible !== wrapper.lastVisible)
                wrapper.trigger(visible ? 'enter' : 'exit', wrapper, pos);

            wrapper.trigger(visible ? 'visible' : 'invisible', wrapper, pos);

            wrapper.lastVisible = visible;
        }
    };
});

/**
 * Library which triggers Backbone events based on element visibility.
 *
 * Main method wraps any element or {@link ElementContainer|view with an el property}
 * to make the library aware of it. This returns an event-aware
 * wrapper. The following events are supported:
 *
 * - enter
 * - exit
 * - visible
 * - invisible
 *
 * Enter and exit are called when an element's visibility changes, while
 * visible and invisible are called per (throttled) scroll event.
 *
 * Visibility can also be manually checked at any time using
 * {@link module:stance~isVisible|isVisible}.
 *
 * The library will cache element offsets and sizes.
 * To invalidate a measurement call {@link module:stance~invalidate|invalidate}
 * on the wrapper, or call the main {@link module:stance.invalidate|invalidate}
 * to clear all cached measurements.
 *
 * To stop tracking an element, simply remove any bound events.
 *
 * The {@link ElementContainer|view} that is wrapped can also affect visibility
 * measurements via two properties, topEdgeOffset and bottomEdgeOffset.
 *
 * Examples, use cases
 * -------------------
 *
 *  - You have a view and you want to do something once the first time
 *    it comes into the viewport:
 *
 *      view.listenToOnce(stance(view), 'visible', function () {
 *          // Do something like kick off an analytics tracking request
 *      });
 *
 *  -- NOTE: as the 'visible' event is bound to scroll, it will only fire
 *     if the user scrolls.
 *
 * @module stance
 */

define('stance/main',[
    'core/Events',
    'core/utils/function/debounce',
    'core/utils/function/throttle',
    'core/utils/object/extend',

    './tracking',
],
function (
    Events,
    debounce,
    throttle,
    extend,

    tracking
) {
    'use strict';

    /**
     * An object which has a .el property, such as a Backbone View.
     *
     * @typedef ElementContainer
     * @property {HTMLElement} el - The element to measure.
     * @property {?(number|function)} topEdgeOffset - Amount to adjust the
     *   top "visible" edge of the element by. Positive numbers decrease the
     *   apparent size of the element.
     * @property {?(number|?function)} bottomEdgeOffset - Amount to adjust the
     *   bottom "visible" edge of the element by. Positive numbers decrease the
     *   apparent size of the element.
     */

    /**
     * An html element or a container of an html element.
     *
     * @typedef Element-like
     * @type {external:HTMLElement|ElementContainer}
     */

    /**
     * Wrap element or container to track its visibility.
     * @class
     * @function
     * @implements {Events}
     * @param {Element-like} obj - The element or view to measure.
     * @property {Element-like} obj
     * @property {boolean} lastVisible - Last known visibility of element.
     * @returns {Stance}
     */
    function Stance(obj) {
        // Create new instance if not invoked as constructor
        if (!(this instanceof Stance))
            return new Stance(obj);
        this.obj = obj;
        this.lastVisible = false;
    }

    // Debounce the processing of events when we attach
    // new handlers.
    var _debouncedProcessEvents = debounce(function () {
        tracking.processEvents(tracking.lastPos);
    }, 250);

    extend(Stance.prototype, Events, {
        on: function (name) {
            // We only need to update tracking if the event binding is
            // entirely new, ie. if the event is not bound yet.
            // This must be checked before _events has been updated
            var needSort = !(this._events && this._events[name]);

            var ret = Events.on.apply(this, arguments);

            // updateTracking must be called after _events has been updated
            if (needSort)
                tracking.updateTracking(this);

            _debouncedProcessEvents();
            return ret;
        },

        off: function (name) {
            var ret = Events.off.apply(this, arguments);

            // If the event is entirely unbound, update tracking.
            // updateTracking must be called after _events has been updated
            if (!(this._events && this._events[name]))
                tracking.updateTracking(this);

            return ret;
        },

        /**
         * Get the modified offset for this element, retrieving the cached version if possible.
         *
         * @returns {?FullOffset}
         */
        offset: function () {
            return tracking.getElementOffset(this.obj);
        },

        /**
         * Decide if the element is visible.
         * Returns null if element visibility cannot be determined.
         *
         * An element's visibility can be affected by the container's
         * topEdgeOffset and bottomEdgeOffset properties.
         *
         * An element is visible if:
         *
         * 1. The top of the element is below the top of the viewport
         *    and its modified top edge is above the bottom of the viewport.
         * 2. The bottom of the element is above the bottom of the viewport
         *    and its modified bottom edge is below the top of the viewport.
         *
         * @param {ViewportPos} [pos] - Viewport position to calculate for.
         *   If omitted it will default to the last value passed to the scroll handler
         * @returns {?boolean} Visibility, or null if indeterminate.
         */
        isVisible: function (pos) {
            pos = pos || tracking.lastPos;

            if (!pos)
                return null;

            var screenTop = pos.top;
            var screenBottom = screenTop + pos.height;
            var offset = this.offset();

            if (!offset)
                return false;

            // See main function comment for a summary of this check
            return (offset.offsetTop >= screenTop && offset.visibleTop < screenBottom) ||
                (offset.offsetTop + offset.height <= screenBottom && offset.visibleBottom > screenTop);
        },

        /**
         * Invalidate the last cached offset for this element.
         *
         * @returns {Stance} this
         */
        invalidate: function () {
            tracking.clearCache(this.obj);

            return this;
        },
    });

    extend(Stance, {
        /**
         * Clear cached measurements.
         *
         * @todo TODO: Duplicates instance functionality, should this
         *   function accept a parameter at all?
         * @function
         * @static
         * @param {Element-like} [obj] - Element or container to clear cached
         *   measurements for. If omitted, entire cache will be cleared.
         */
        invalidate: tracking.clearCache,

        /**
         * @typedef ViewportPos
         * @property {number} top - Top edge of viewport relative to document.
         * @property {number} height - Height of viewport.
         */

        /**
         * Notify the library that a scroll event has occurred.
         *
         * Immediately calls all applicable event handlers.
         *
         * @function
         * @static
         * @param {ViewportPos} pos - Scroll information.
         */
        scroll: tracking.processEvents,


        _windowScrollHandlerBound: false,
        _ignoreCache: false,

        /**
         * Window scroll event handler. Automatically bound on load.
         *
         * @private
         * @static
         * @function
         */
        _windowScrollHandler: throttle(function () {
            if (Stance._ignoreCache)
                Stance.invalidate();

            // Trigger library scroll events
            tracking.processEvents({
                top: window.pageYOffset,
                height: window.document.documentElement.clientHeight,
            });
        }, 250),

        /**
         * Listen for window scroll and resize events.
         *
         * @static
         * @param {boolean} ignoreCache - If provided, will determine if the scroll handler
         *                                invalidates the position cache on each scroll event.
         */
        bindWindowEvents: function (ignoreCache) {
            if (this._windowScrollHandlerBound)
                return;

            if (typeof ignoreCache !== 'undefined')
                Stance._ignoreCache = ignoreCache;

            window.addEventListener('scroll', this._windowScrollHandler);
            window.addEventListener('resize', this._windowScrollHandler);

            this._windowScrollHandlerBound = true;

            // Set our initial `lastPos` values and process any already bound
            // scroll events.
            this._windowScrollHandler();
        },

        /**
         * Stop listening for window scroll and resize events.
         *
         * @static
         */
        unbindWindowEvents: function () {
            Stance._ignoreCache = false;

            window.removeEventListener('scroll', this._windowScrollHandler);
            window.removeEventListener('resize', this._windowScrollHandler);

            this._windowScrollHandlerBound = false;
        },
    });

    return Stance;
});

define('stance', ['stance/main'], function (main) { return main; });

define('core/utils/OnceTimer',['require','exports','module'],function (require, exports, module) {
    'use strict';

    module.exports = function OnceTimer(func, milliseconds) {
        var timer = null;
        var done = false;
        this.start = function () {
            if (done)
                return;

            timer = setTimeout(function () {
                done = true;
                func();
            }, milliseconds);
        };

        this.clear = function () {
            clearTimeout(timer);
        };
    };
});

define('core/utils/html/toHexColorString',[],function () {
    'use strict';

    function hex(colorInt) {
        // WARNING: The cast to Number here is crucial for preventing XSS
        // in case the color components have been tampered with
        colorInt = Number(colorInt);

        if (isNaN(colorInt) || colorInt > 255) // eslint-disable-line no-magic-numbers
            throw new Error('Color components should be numbers less than 256');

        colorInt = colorInt.toString(16);  // eslint-disable-line no-magic-numbers

        return colorInt.length === 1 ? '0' + colorInt : String(colorInt);
    }

    return function toHexColorString(components) {
        return '#' + hex(components.red) + hex(components.green) + hex(components.blue);
    };
});

define('core/utils/sandbox',[],function () {
    'use strict';

    // Reference https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe#attr-sandbox
    var ALLOWED_PERMISSIONS = [
        'allow-forms',
        'allow-pointer-lock',
        'allow-popups',
        'allow-same-origin',
        'allow-scripts',
        'allow-top-navigation',
    ];

    /**
     * Creates an HTML5 sandbox attribute given requested permissions
     * @param {Object} permissions - The allowed permissions, if any.
     * @returns {string} The sandbox attribute string
     */
    var getAttribute = function (permissions) {
        if (!permissions)
            return '';

        return ALLOWED_PERMISSIONS.reduce(function (attrVal, perm) {
            if (permissions[perm])
                attrVal += perm + ' ';
            return attrVal;
        }, '').trim();
    };

    return {
        getAttribute: getAttribute,
    };
});

define('core/utils/url/parseQueryString',[
    'core/utils/collection/each',
], function (
    each
) {
    'use strict';

    /**
     * Create an object from the key-value pairs in a query string.
     * Duplicate keys are not supported (only last value will be used).
     *
     * @param {string} [queryString] - The search portion of a url. Must start with a ?.
     *                                 Defaults to window.location.search.
     * @returns {Object<string>} - The mapping of query string keys to values.
     */
    return function parseQueryString(queryString) {
        if (typeof queryString === 'undefined')
            queryString = window.location.search;

        var params = {};

        each(queryString.substr(1).split('&'), function (item) {
            var pair = item.split('=').map(function (part) {
                return decodeURIComponent(part.replace(/\+/g, '%20'));
            });
            if (pair[0])
                params[pair[0]] = pair[1];
        });

        return params;
    };
});

define('core/analytics/reporting',['require','core/utils/collection/each','core/utils/url/serialize','core/config/urls'],function (require) {
    'use strict';

    var each = require('core/utils/collection/each');
    var serialize = require('core/utils/url/serialize');

    var urls = require('core/config/urls');

    var jesterUrl = urls.jester;

    function getLoaderVersionFromUrl(url) {
        var parts = url.split('.');
        var version = parts.length > 2 ? parts[parts.length - 2] : '';  // eslint-disable-line no-magic-numbers
        return version.match(/^[0-9a-f]{32}$/i) && version;
    }

    function logStat(eventName) {
        new window.Image().src = serialize(jesterUrl + '/stat.gif', { event: eventName });
    }

    function reportJester(payload) {
        new window.Image().src = serialize(jesterUrl + '/event.gif', payload);
    }

    function reportJesterPOST(payload) {
        var data = new window.URLSearchParams();
        each(payload, function (value, key) {
            if (value !== undefined) {
                data.append(key, value);
            }
        });
        var req = new window.XMLHttpRequest();
        req.open('POST', jesterUrl + '/event.json', true);
        req.withCredentials = true;
        req.send(data);
    }

    return {
        getLoaderVersionFromUrl: getLoaderVersionFromUrl,
        logStat: logStat,
        reportJester: reportJester,
        reportJesterPOST: reportJesterPOST,
    };
});

define('core/ads/safeFrameUtils',[], function () {
    'use strict';

    const isNumeric = num => num !== null && !isNaN(Number(num)) && isFinite(num);

    const min = numArray => Math.min(...numArray) || 0;

    const max = numArray => Math.max(...numArray) || 0;

    return {
        min,
        max,
        isNumeric,
    };

});

// Adapted from https://github.com/DeviantArt/Safeframe/blob/master/src/lib/noderect.js
define('core/ads/NodeRect',[
    'core/ads/safeFrameUtils',
], function (
    utils
) {
    'use strict';

    class NodeRect {
        constructor() {
            if (arguments.length === 1 && !utils.isNumeric(arguments[0])) {
                if (Array.isArray(arguments[0]))
                    return this.fromArray(arguments[0]);
                return this.fromObject(arguments[0]);
            }
            this.fromArray(arguments);
        }

        fromArray(arr) {
            this.reset();
            if (arr.length >= 6) { // eslint-disable-line no-magic-numbers
                this.top = arr[0];
                this.right = arr[1];
                this.bottom = arr[2];
                this.left = arr[3];
                this.width = arr[4];
                this.height = arr[5];
            } else if (arr.length >= 4) { // eslint-disable-line no-magic-numbers
                this.top = arr[0];
                this.right = arr[1];
                this.bottom = arr[2];
                this.left = arr[3];
            } else if (arr.length === 3) { // eslint-disable-line no-magic-numbers
                this.top = arr[0];
                this.right = arr[1];
                this.bottom = arr[2];
                this.left = 0;
            } else if (arr.length === 2) { // eslint-disable-line no-magic-numbers
                this.top = arr[0];
                this.right = arr[1];
                this.bottom = arr[0];
                this.left = arr[1];
            } else {
                this.top = arr[0];
                this.right = arr[0];
                this.bottom = arr[0];
                this.left = arr[0];
            }
            this.update();
        }

        fromObject(obj) {
            return this.fromArray([obj.top, obj.right, obj.bottom, obj.left, obj.width, obj.height]);
        }

        update() {
            if (!this.width)
                this.width = this.right - this.left;

            if (!this.height)
                this.height = this.bottom - this.top;
        }

        reset(value) {
            value = value || 0;
            this.top = value;
            this.right = value;
            this.bottom = value;
            this.left = value;
            this.width = value;
            this.height = value;
        }

        getArea() {
            return (this.right - this.left) * (this.bottom - this.top);
        }
    }

    NodeRect.getOverlapRect = (r1, r2) => {
        const left = utils.max([r1.left, r2.left]);
        const right = utils.min([r1.left + r1.width, r2.left + r2.width]);
        const top = utils.max([r1.top, r2.top]);
        const bottom = utils.min([r1.top + r1.height, r2.top + r2.height]);
        if (right >= left && bottom >= top)
            return new NodeRect(top, right, bottom, left, right - left, bottom - top);
        return false;
    };

    NodeRect.getOverlapArea = (r1, r2) => {
        const xoverlap = utils.max([0, utils.min([r1.right, r2.right]) - utils.max([r1.left, r2.left])]);
        const yoverlap = utils.max([0, utils.min([r1.bottom, r2.bottom]) - utils.max([r1.top, r2.top])]);

        return xoverlap * yoverlap;
    };

    return NodeRect;

});

// Adapted from https://github.com/DeviantArt/Safeframe/blob/master/src/lib/noderect.js
define('core/ads/domUtils',[
    'core/ads/NodeRect',
], function (
    NodeRect
) {
    'use strict';

    const ROOT_DOCUMENT_NODE_TYPE = 9;

    const getParentNode = node => node && node.parentNode;

    const getNodeStyle = (node, attr) => {
        if (!node)
            return null;

        const style = window.document.defaultView.getComputedStyle(node);
        if (attr && style.hasOwnProperty(attr))
            return style[attr];

        return style;
    };

    const getScroll = () => ({
        'x': window.pageXOffset,
        'y': window.pageYOffset,
    });

    const getRect = node => {
        let rect;
        if (node && node.style) {
            // If the node has display:none then getBoundingClientRect will return 0,0,0,0
            const oldDisplay = node.style.display;
            node.style.display = 'block'; // must be visible
            rect = node.getBoundingClientRect();
            node.style.display = oldDisplay;
            rect = new NodeRect(rect);
            const scroll = getScroll();

            // Convert it to absolute position
            rect.left += scroll.x;
            rect.right += scroll.x;
            rect.top += scroll.y;
            rect.bottom += scroll.y;
        } else {
            rect = new NodeRect(0);
        }
        return rect;
    };

    const getRectRelativeTo = (node, ref) => {
        const rect = getRect(node);

        // ref is usually node.offsetParent, which is null if the node is display:none
        if (ref) {
            const refRect = getRect(ref);
            rect.top = refRect.top - refRect.top + ref.scrollTop;
            rect.bottom = rect.top + rect.height + ref.scrollTop;
            rect.left = rect.left - refRect.left + ref.scrollLeft;
            rect.right = rect.left + rect.width + ref.scrollLeft;
        }
        return rect;
    };

    const getViewportRect = () => {
        const scroll = getScroll();
        const top = scroll.y;
        const right = scroll.x + window.innerWidth;
        const bottom = scroll.y + window.innerHeight;
        const left = scroll.x;
        const width = window.innerWidth;
        const height = window.innerHeight;

        return new NodeRect(top, right, bottom, left, width, height);
    };

    const getDocument = node => {
        try {
            if (node.nodeType === ROOT_DOCUMENT_NODE_TYPE)
                return node;
            return node.ownerDocument;
        } catch (err) {
            return null;
        }
    };

    const getWindow = node => {
        const doc = getDocument(node);
        let win;
        try {
            if (doc)
                win = doc.parentWindow || doc.defaultView || window;
        } catch (err) {
            win = window;
        }

        return win;
    };

    const getWindowRect = node => {
        const win = getWindow(node);
        const rect = new NodeRect(0, win.innerWidth, win.innerHeight, 0, win.innerWidth, win.innerHeight);
        // Convert it to absolute position
        const scroll = getScroll();
        rect.left += scroll.x;
        rect.right += scroll.x;
        rect.top += scroll.y;
        rect.bottom += scroll.y;
        return rect;
    };

    const getRootNode = node => {
        const doc = getDocument(node);
        if (doc)
            return doc.documentElement || doc.body; // body for opera
    };

    const getRootRect = node => {
        const root = getRootNode(node) || {};
        const rect = new NodeRect();
        rect.right =
        rect.width = root.scrollWidth || 0;
        rect.bottom =
        rect.height = root.scrollHeight || 0;
        return rect;
    };

    const isParentOf = (parent, node) => {
        while (node) {
            if (node === parent)
                return true;
            node = node.parentNode;
        }
        return false;
    };

    const hasLayout = node => {
        const style = getNodeStyle(node);
        return style.display === 'inline-block'
            || style.float !== 'none'
            || style.position === 'absolute'
            || style.position === 'fixed'
            || style.width !== 'auto'
            || style.height !== 'auto';
    };

    const getNodeOverflow = node => {
        const style = getNodeStyle(node);
        const overflow = {};

        // The scrollbar size is calculated as a difference between
        // the offsetWidth and clientWidth.
        //
        // The HTMLElement.offsetWidth read-only property returns the
        // layout width of an element. Typically, an element's
        // offsetWidth is a measurement which includes the element
        // borders, the element horizontal padding, the element
        // vertical scrollbar (if present, if rendered) and the element
        // CSS width.
        //
        // The Element.clientWidth property is zero for elements with
        // no CSS or inline layout boxes, otherwise it's the inner
        // width of an element in pixels. It includes padding but not
        // the vertical scrollbar (if present, if rendered), border or
        // margin.
        //
        if (style.overflowX === 'scroll' || style.overflowX === 'auto')
            overflow.xscroll = node.offsetWidth - node.clientWidth;
        else
            overflow.xscroll = 0;

        if (style.overflowY === 'scroll' || style.overflowY === 'auto')
            overflow.yscroll = node.offsetHeight - node.clientHeight;
        else
            overflow.yscroll = 0;

        overflow.xhidden = style.overflowX === 'hidden';
        overflow.yhidden = style.overflowY === 'hidden';
        return overflow;
    };

    const isNodeClipped = node => {
        const style = getNodeStyle(node);
        if ((style.clip && style.clip !== 'auto') ||
            (style.clipPath && style.clipPath !== 'none'))
            return true;

        return false;
    };

    return {
        getParentNode,
        getWindow,
        getScroll,
        getRect,
        getRectRelativeTo,
        getViewportRect,
        getDocument,
        getWindowRect,
        getRootNode,
        getRootRect,
        getNodeStyle,
        isParentOf,
        hasLayout,
        getNodeOverflow,
        isNodeClipped,
    };

});

// Adapted from https://github.com/DeviantArt/Safeframe/blob/master/src/host/geom.js
define('core/ads/Geom',[
    'core/ads/domUtils',
    'core/ads/safeFrameUtils',
], function (
    dom,
    utils
) {
    'use strict';

    const ELEMENT_NODE = 1;

    /**
     * Class that calculates the expand rectangle as specified in
     * [IAB SafeFrames v1.1 Draft](https://www.iab.com/wp-content/uploads/2014/08/SafeFrames_v1.1_final.pdf)
     * 5.4 Function $sf.ext.geom
     *
     * The algorithm to determine the visible portion of the base element can be
     * split into several steps:
     *
     * -  Finding the first ancestor element that has either the overflow or
     *    clip-path configured. This will be our reference element.
     *
     * -  Get the client bounding rectangle for the reference and base nodes
     *
     * -  Calculate the intersection to get the visible portion of the base element.
     *
     * -  We then find any elements that might overlap the base element and update
     *    base elements visibility info accordingly.
     *
     * @class GeomCalculator
     */
    class GeomCalculator {

        constructor(node) {
            this.node = node;
            this.document = dom.getDocument(node);
            this.window = dom.getWindow(node);
            this.root = dom.getRootNode(node);
            this.ref = this.getRefNode(node.parentNode);
        }

        // Go up the DOM tree and try to find a node that is obscurring the view of the base element either through
        // overflow, clipping, or scroll.
        getRefNode(node) {
            // Loop through parent nodes to check if any of them have clip / overflow setting which would obscure the
            // node
            while (node && node.nodeType === ELEMENT_NODE) {
                const style = dom.getNodeStyle(node);
                if (dom.hasLayout(node) || style.display === 'block' || style.clear !== 'none') {
                    // This parent node might obscure the base element because
                    // of the overflow setting
                    const scroll = dom.getNodeOverflow(node);
                    if (scroll.xscroll || scroll.yscroll || scroll.xhidden || scroll.yhidden)
                        return node;

                    // This parent node might obscure the base element because
                    // of the clip-path setting
                    if (dom.isNodeClipped(node))
                        return node;
                }
                node = node.parentNode;
            }

            return this.root;
        }

        getNodesOver(node, limit) {
            limit = limit || 1;
            const overlapNodes = [];
            const nodeRect = dom.getRect(node);
            const refRect = dom.getRect(this.ref);
            const viewRect = dom.getViewportRect(node);

            if (!window.document.elementFromPoint)
                return overlapNodes;

            // Find the nodes overlapping the base node.
            // To do this, we place an imaginary grid of points over the base node and
            // see if any of the belong to any other elements using the
            // document.elementFromPoint method.
            const grid = {
                top: utils.max([nodeRect.top, refRect.top]) - viewRect.top,
                right: utils.min([nodeRect.right, refRect.right]) - viewRect.left,
                bottom: utils.min([nodeRect.bottom, refRect.bottom]) - viewRect.top,
                left: utils.max([nodeRect.left, refRect.left]) - viewRect.left,
            };
            const xIncrement = (grid.right - grid.left) / 10; // eslint-disable-line no-magic-numbers
            const yIncrement = (grid.bottom - grid.top) / 10; // eslint-disable-line no-magic-numbers
            for (let xLeft = grid.left; xLeft < grid.right; xLeft += xIncrement) {
                for (let yTop = grid.top; yTop < grid.bottom; yTop += yIncrement) {
                    let elem = window.document.elementFromPoint(xLeft, yTop);
                    // Find the owner of this element that is also obscurring the base element
                    while (elem && elem.nodeType === ELEMENT_NODE) {
                        const style = dom.getNodeStyle(elem);
                        if (dom.hasLayout(elem) || style.display === 'block' || style.clear !== 'none')
                            break;
                        elem = elem.parentNode;
                    }

                    if (elem && elem.nodeType === ELEMENT_NODE   // if we found the elem
                            && elem !== this.node                // and it's different than this.node (our base node)
                            && elem !== this.root                // and it's not the page's root
                            && !dom.isParentOf(elem, this.node) // and elem is not this.node's ancestor
                    ) {
                        // that means it is an element that is probably obscurring this.node's view
                        overlapNodes.push(elem);
                        if (overlapNodes.length >= limit) {
                            // break
                            xLeft = grid.right;
                            yTop = grid.bottom;
                        }
                    }
                }
            }

            return overlapNodes;
        }

        /**
         * Identifies the location, width, and height (in pixels) of the browser or window
         * boundaries relative to the device screen.
         *
         * @returns {Object} {
         *     t: The y coordinate (in pixels) of the top boundary of the browser or window relative to the screen
         *     b: The y coordinate (in pixels) of the bottom boundary of the browser or window relative to the screen
         *     l: The x coordinate (in pixels) of the left boundary of the browser or window relative to the screen
         *     r: The x coordinate (in pixels) of the right boundary of the browser or window relative to the screen
         *     w: The width (in pixels) of the browser or window (win.r – win.l)
         *     h: The height (in pixels) of the browser or window (win.b – win.t)
         * }
         **/
        getWindowGeom() {
            const height = this.window.innerHeight || 0;
            const width = this.window.innerWidth || 0;
            const top = this.window.screenY || this.window.screenTop || 0;
            const bottom = top + height;
            const left = this.window.screenX || this.window.screenLeft || 0;
            const right = left + width;
            return {
                't': top,
                'r': right,
                'b': bottom,
                'l': left,
                'w': width,
                'h': height,
            };
        }

        /**
         * Identifies the z-index and location, width, and height (in pixels) of the SafeFrame container relative
         * to the browser or application window. In addition, width, height, and area percentage of
         * SafeFrame content in view is provided, based on how much of the container is located within the
         * boundaries of the browser or application window.
         *
         * @returns {Object} {
         *     t: The y coordinate (in pixels) of the top boundary of the SafeFrame container
         *     l: The x coordinate (in pixels) of the left side boundary of the SafeFrame container
         *     r: The x coordinate (in pixels) of the right side boundary of the SafeFrame container
         *     b: The y coordinate (in pixels) of the bottom boundary of the SafeFrame container
         *     z: The Z-index of the SafeFrame container
         *     w: The width (in pixels) of the SafeFrame container
         *     h: The height (in pixels) of the SafeFrame container
         *     xiv: The percentage (%) of width for the SafeFrame container in view (formatted as "0.14" or "1")
         *     yiv: The percentage (%) of height for the SafeFrame container in view (formatted as "0.14" or "1")
         *     iv: The percentage (%) of area for the SafeFrame container in view (formatted as "0.14" or "1")
         * }
         **/
        getSelfGeom() {
            const nodeRect = dom.getRect(this.node);
            const refRect = dom.getRect(this.ref);
            const nodeStyle = dom.getNodeStyle(this.node);
            const winRect = dom.getWindowRect(this.node);

            let xoverlapRef = nodeRect.width;
            let yoverlapRef = nodeRect.height;
            if (this.ref !== this.root) {
                // find the horizontal and vertical overlap between the base and the reference node
                xoverlapRef = utils.max([
                    0,
                    utils.min([nodeRect.right, refRect.right]) - utils.max([nodeRect.left, refRect.left]),
                ]);
                yoverlapRef = utils.max([
                    0,
                    utils.min([nodeRect.bottom, refRect.bottom]) - utils.max([nodeRect.top, refRect.top]),
                ]);
            }
            // find the horizontal and vertical overlap between the base node and the window
            const xoverlapWin = utils.max([
                0,
                utils.min(nodeRect.right, winRect.right) - utils.max([nodeRect.left, winRect.left]),
            ]);
            const yoverlapWin = utils.max([
                0,
                utils.min([nodeRect.bottom, winRect.bottom]) - utils.max([nodeRect.top, winRect.top]),
            ]);
            // The smaller of the two represent the visible area of the base node
            const xoverlap = utils.min([xoverlapRef, xoverlapWin]);
            const yoverlap = utils.min([yoverlapRef, yoverlapWin]);
            const xiv = nodeRect.width ? xoverlap / nodeRect.width : 0;
            const yiv = nodeRect.height ? yoverlap / nodeRect.height : 0;
            let iv = (xoverlap * yoverlap) / (nodeRect.width * nodeRect.height);

            // Deduct the areas of any absolutely positioned elements that might appear over the SafeFrame.
            const maxElementsToFind = 1;
            const stack = this.getNodesOver(this.node, maxElementsToFind);
            if (stack.length) {
                const obstructiveRect = dom.getRect(stack[0]);
                const xobstruct = utils.max([
                    0,
                    utils.min(
                        [obstructiveRect.right, nodeRect.right]) - utils.max([obstructiveRect.left, nodeRect.left]
                    ),
                ]);
                const yobstruct = utils.max([
                    0,
                    utils.min(
                        [obstructiveRect.bottom, nodeRect.bottom]) - utils.max([obstructiveRect.top, nodeRect.top]
                    ),
                ]);
                iv = utils.max([0, (xoverlap * yoverlap - xobstruct * yobstruct) / (nodeRect.width * nodeRect.height)]);
            }

            const scroll = dom.getScroll();
            /* eslint-disable no-magic-numbers */
            return {
                't': nodeRect.top - scroll.y,
                'r': nodeRect.right - scroll.x,
                'b': nodeRect.bottom - scroll.y,
                'l': nodeRect.left - scroll.x,
                'z': nodeStyle.zIndex,
                'w': nodeRect.width,
                'h': nodeRect.height,
                'xiv': xiv === 1 ? '1' : Number(xiv).toFixed(2),
                'yiv': yiv === 1 ? '1' : Number(yiv).toFixed(2),
                'iv': iv === 1 ? '1' : Number(iv).toFixed(2),
            };
            /* eslint-enable no-magic-numbers */
        }

        /**
         * Identifies the expected distance available for expansion within the host
         * content but still retaining visibility, along with information about
         * whether controls allow the end user  to scroll the page. If
         * “scrollable,” the SafeFrame content can expand to  dimensions greater
         * than those provided.
         *
         * @returns {Object} {
         *     t:The number of pixels that can be expanded upwards
         *     l: The number of pixels that can be expanded left
         *     r: The number of pixels that can be expanded right
         *     b: The number of pixels that can be expanded down
         *     xs: A response that indicates whether the host content is scrollable along the x-axis (1/0)
         *     yx: A response that indicates whether the host content is scrollable along the y-axis (1/0)
         * }
         **/
        getExpandGeom() {

            const ref = dom.getRect(this.ref);
            const node = dom.getRect(this.node);
            const win = dom.getWindowRect(this.node);

            const rect = {
                top: utils.max([ref.top, win.top]),
                right: utils.min([ref.right, win.right]),
                bottom: utils.min([ref.bottom, win.bottom]),
                left: utils.max([ref.left, win.left]),
            };

            const scroll = dom.getNodeOverflow(this.ref);
            return {
                't': utils.max([0, node.top - rect.top]),
                'r': utils.max([0, rect.right - node.right]),
                'b': utils.max([0, rect.bottom - node.bottom]),
                'l': utils.max([0, node.left - rect.left]),
                'xs': Boolean(scroll.yscroll),
                'yx': Boolean(scroll.xscroll),
            };
        }

        getGeom() {
            return {
                win: this.getWindowGeom(),
                self: this.getSelfGeom(),
                exp: this.getExpandGeom(),
            };
        }
    }

    const Geom = {
        get: node => {
            const calc = new GeomCalculator(node);
            return calc.getGeom();
        },
    };

    return Geom;

});

define('core/ads/ads',['require','core/shared/urls','core/apps/WindowedApp','core/host/json','stance/main','stance/utils','core/common/kernel/WindowBase','core/utils/OnceTimer','core/utils/html/toHexColorString','core/utils/object/extend','core/utils/sandbox','core/utils/url/parseQueryString','core/utils/url/serialize','core/utils/urls','core/utils/urls','core/analytics/reporting','core/ads/Geom'],function (require) {
    'use strict';

    var urls = require('core/shared/urls');

    var WindowedApp = require('core/apps/WindowedApp');
    var JSON = require('core/host/json'); // eslint-disable-line no-shadow

    var stance = require('stance/main');
    var stanceUtils = require('stance/utils');

    var WindowBase = require('core/common/kernel/WindowBase');
    var OnceTimer = require('core/utils/OnceTimer');
    var toHexColorString = require('core/utils/html/toHexColorString');
    var extend = require('core/utils/object/extend');
    var sandbox = require('core/utils/sandbox');
    var parseQueryString = require('core/utils/url/parseQueryString');
    var serialize = require('core/utils/url/serialize');
    var getOrigin = require('core/utils/urls').getOrigin;
    var getQuery = require('core/utils/urls').getQuery;
    var reporting = require('core/analytics/reporting');

    var Geom = require('core/ads/Geom');

    var AdsApp = WindowedApp.extend({
        name: 'ads',

        origin: undefined,  // origin is defined by the adUrl passed during construction

        onceEvents: {
            'view:enter': function () {
                this._reportLegacy({ verb: 'view', adverb: '0ms-no50perc' });
            },

            'view:iab': function () {
                this._reportLegacy({ verb: 'view', adverb: 'iab-scroll' });
            },
        },

        events: {
            'frame:ready': function (options) {
                this.forumId = options.forumId;

                this._reportLegacy({
                    verb: 'load',
                    extra_data: options.extraData,
                    advertisement_id: options.advertisement_id,
                    provider: options.provider,
                });

                // Start sending view events, now that the ad frame has initialized
                // TODO: Ideally this should occur after the ads are rendered, but
                // for now the ready event occurs as soon as our ads code loads
                this.bindViewEvents();
                this.triggerGeomUpdate();
            },
            'frame:resize': function (options) {
                this.frame.setInlineStyle('height', options.height + 'px');
                if (options.height === 0) { // No ad presented
                    this.trigger('ad-placement-empty');
                } else {
                    this.trigger('ad-placement-filled');
                }
                this.triggerGeomUpdate();
            },
            'frame:click': function () {
                this._reportOnce({ verb: 'click' }, 'click');
            },
            'frame:hover': function () {
                this._reportOnce({ verb: 'hover' }, 'hover');
            },
            'frame:error-provider-not-ready': function (options) {
                this._reportLegacy({
                    verb: 'fail',
                    object_type: 'provider',
                    object_id: options.provider || this.getProvider(),
                    adverb: 'provider_not_ready',
                });
            },
            'frame:error-no-height': function (options) {
                this._reportLegacy({
                    verb: 'fail',
                    object_type: 'provider',
                    object_id: options.provider || this.getProvider(),
                    adverb: 'no_height',
                });
            },
            'frame:clearSandbox': function () {
                if (this.frame.elem.hasAttribute('sandbox')) {
                    this.frame.elem.removeAttribute('sandbox');
                }
            },
            'frame:redirect': function (newUrl) {
                if (this.settings.isOnHostPage) {
                    this.frame.elem.src = newUrl;
                }
            },
            // TODO: Maybe remove this since it's no longer being fired.
            'frame:logAd': function (adData) {
                this._report(adData, { usePOST: true });
            },
            'frame:$sf-init': function () {
                if (this.settings.isOnHostPage) {
                    this.isSafeframe = true;
                }
            },
            'frame:error': function (error) {
                if (this.settings.isOnHostPage) {
                    this.postMessageDirect({
                        event: 'error',
                        data: {
                            error: error,
                        },
                    });
                }
            },
        },

        constructor: function () {
            WindowedApp.apply(this, arguments);
            this.origin = getOrigin(this.settings.adUrl);

            // Record of events which should only be reported once
            this._reportOnceHistory = {};

            if (this.settings.isOnHostPage) {
                this.detectLazyload = this.detectLazyload.bind(this);
                window.addEventListener('scroll', this.detectLazyload);
            }

            this.settings.useSourcelessFrame = this.settings.experiment.experiment &&
                this.settings.experiment.experiment.indexOf('srclessiframe') === 0 &&
                this.settings.experiment.variant === 'active' &&
                // Can only use sourceless iframes on the host page because it's not feasible
                // to whitelist all of the domains we use for the embed iframe's CSP.
                this.settings.isOnHostPage;
        },

        init: function () {
            this.settings.forum = parseQueryString(getQuery(this.settings.adUrl)).shortname;
            if (!this.settings.forum) {
                return;
            }

            // Ad preferences that the publisher has set on this
            // page via inline script
            var disableAds = this.settings.disableAds;

            // Bail out if publisher has turned off ads for
            // this page and are allowed to turn them off.
            // I.e., don't show ads on a page where they
            // have been explicitly disabled.
            //
            // We only use window.location.href if we're on
            // the host page because it's disqus.com from
            // within the disqus iframe, which will be
            // considered to be in home.
            var isInHome = this.settings.isInHome ||
                (this.settings.isOnHostPage && window.location.href.indexOf(urls.apps.home) === 0);
            if (!isInHome && disableAds && this.settings.canDisableAds) {
                return void this.trigger('prevented-ad-load');
            }

            this._reportOnce({
                verb: 'call',
                object_type: 'provider',
                object_id: this.getProvider(),
                adjective: 1,
            }, 'call');

            // Ads iframes should include sandbox attributes to prevent malicious or annoying ads
            // from annoying the user.
            if (this.settings.sandboxAds) {
                this.sandbox = sandbox.getAttribute({
                    'allow-scripts': true,
                    'allow-same-origin': true,
                    'allow-forms': true,
                    'allow-popups': true,
                });
            }

            WindowedApp.prototype.init.call(this);
        },

        detectLazyload: function () {
            // TODO: Figure out why this.frame is sometimes undefined.
            if (!this.frame || !this.settings.isOnHostPage) {
                return;
            }

            const distanceFromViewportTop = this.frame.elem.getBoundingClientRect().top;
            const distanceFromViewportBottom = distanceFromViewportTop - window.innerHeight;
            // Here we calculate the n-viewports threshold to use for lazyloading ads.
            const threshold = window.innerHeight * this.settings.lazyloadViewports;
            if (distanceFromViewportBottom < threshold) {
                this.postMessageDirect({
                    event: 'lazyload',
                });
                window.removeEventListener('scroll', this.detectLazyload);
            }
        },

        getProvider: function () {
            if (this._provider) {
                return this._provider;
            }

            // TODO - have the server add this as a key-value pair to the server-side config?
            // Matching a string seems brittle.
            // try to get provider from URL, memoize if we find it.
            var provider = this.settings.adUrl.match(/provider=(\w+)/);
            if (provider) {
                this._provider = provider[1];
            }

            return this._provider;
        },

        getUrl: function () {
            var settings = this.settings;

            var sourceUrl;
            if (settings.experiment.experiment === 'inthreaddisqusadstxt' &&
                settings.experiment.variant === 'active' &&
                settings.placement === 'inthread') {
                sourceUrl = window.document.location.href;
            } else if (settings.isOnHostPage) {
                sourceUrl = settings.url || window.document.location.href;
            } else {
                sourceUrl = settings.url || settings.referrer;
            }

            return serialize(settings.adUrl, {
                // send as hex color string because of API with Gravity
                // https://docs.google.com/document/d/16OhDwst-AXCLFoVWu-KOHOpyzqhrkH02gG5vE0Qi9i0/
                anchorColor: toHexColorString(settings.anchorColor),
                colorScheme: settings.colorScheme,
                sourceUrl: sourceUrl,
                typeface: settings.typeface,
                canonicalUrl: settings.canonicalUrl,
                disqus_version: settings.version,
            });
        },

        triggerGeomUpdate: function () {
            if (!this.frame.elem || !this.isSafeframe || !this.settings.isOnHostPage) {
                return;
            }

            var geom = Geom.get(this.frame.elem);

            this.postMessageDirect({
                event: 'geom-update',
                data: {
                    geom: geom,
                },
            });
        },

        // Sets up view event triggers for this frame
        // See discovery/views/BaseUnit for more details
        bindViewEvents: function () {
            if (this._viewEventsBound) {
                return;
            }

            this._viewEventsBound = true;

            // Make sure stance is listening for window scroll and resize events
            // (this will no-op after first call)
            stance.bindWindowEvents(true);

            var self = this;
            var trigger = function (name, percentViewable) {
                self.postMessageDirect({
                    event: name,

                    // Note: JSON.stringify removes undefined
                    percentViewable: percentViewable,
                });
            };

            var IAB_VIEW_DURATION = 1000;
            var iabTimer = new OnceTimer(function () {
                self.trigger('view:iab');
                trigger('view:iab');
            }, IAB_VIEW_DURATION);

            var fiftyVisible = false;

            this.listenTo(stance({
                el: this.frame.elem,
            }), {
                enter: function () {
                    self.trigger('view:enter');
                    trigger('view:enter');
                    self.triggerGeomUpdate();
                },
                exit: function () {
                    trigger('view:exit');
                    if (fiftyVisible) {
                        fiftyVisible = false;
                        trigger('view:50out');
                        iabTimer.clear();
                    }
                    self.triggerGeomUpdate();
                },
                visible: function (wrapper, pos) {
                    var percent = stanceUtils.visiblePercent(pos, wrapper.offset());
                    var half = 50;
                    if (percent >= half && !fiftyVisible) {
                        fiftyVisible = true;
                        trigger('view:50in');
                        iabTimer.start();
                    } else if (percent < half && fiftyVisible) {
                        fiftyVisible = false;
                        trigger('view:50out');
                        iabTimer.clear();
                    }
                    trigger('view', percent);
                    self.triggerGeomUpdate();
                },
            });
        },

        /**
         * Communicate an event to the app iframe directly, avoiding `bus`.
         *
         * Before sending:
         *  - Stringifies the message in order to support IE8 and IE9.
         *  - Namespaces the message with {space: 'disqus'} in order to
         *    avoid collisions with other third-party code on the host page
         *
         * Normally the host code and the iframe code communicate via an intermediate
         * 'bus' using `Channel.prototype.sendMessage()`
         *
         * However, the ads app needs to send messages directly to third-party code
         * running in its iframe -- e.g., postMessage view events manifest
         *
         * @param  {Object} message Data that will be communicated to iframe
         *                          via postMessage.
         * @returns {void}
         */
        postMessageDirect: function (message) {

            this.frame.requiresWindow(function (msg) {
                var formattedMessage = JSON.stringify(extend({}, msg, { space: 'disqus' }));
                WindowBase.postMessage(this.window, formattedMessage, this.origin);
                WindowBase.postMessage(this.window, 'disqus.' + msg.event, this.origin);
            })(message);
        },

        /**
         * Generates a Jester reporting event.
         *
         * @param {Object} data - data to be passed to jester
         * @param {string} data.object_id - unique identifier for this object
         * @param {string} data.object_type - classifying group for this object
         * @param {string} data.product - application generating this event i.e. embed, admin, etc.
         * @param {string} data.verb - what the object is doing
         * @param {string} data.zone - area of this application relevant to the event
         *
         * @param {Object} options - options
         * @param {bool} [options.usePOST] - if true, a POST request will be used, which supports more data
         */
        _report: function (data, options = {}) {
            const settings = this.settings;
            const provider = options.provider || this.getProvider();

            data.forum_id = settings.forumId || this.forumId;

            const method = options.usePOST ? 'reportJesterPOST' : 'reportJester';
            reporting[method](extend({
                imp: settings.impressionId,

                experiment: settings.experiment.experiment,
                variant: settings.experiment.variant,
                service: settings.experiment.service,

                area: settings.placement,

                product: 'embed',
                forum: settings.forum,
                zone: 'thread',
                version: settings.loaderVersion,
                page_url: settings.referrer || window.document.location.href,
                page_referrer: settings.hostReferrer || window.document.referrer,

                object_type: 'advertisement',

                provider: provider,

                event: 'activity',
            }, data));
        },

        _reportLegacy: function (options) {
            var settings = this.settings;

            this._report(extend({
                // TODO: this needs to default to iab_display for reporting events but we should fix this someday
                ad_product_name: 'iab_display',
                ad_product_layout: 'iab_display',
                // TODO: remove our dependency on sending bin - it's redundant
                bin: 'embed:promoted_discovery:' +
                    settings.experiment.service + ':' +
                    settings.experiment.experiment + ':' +
                    settings.experiment.variant,
                object_id: options.advertisement_id ? '[' + options.advertisement_id + ']' : '',
                section: 'default',
            }, options));
        },

        _reportOnce: function (options, id) {
            if (this._reportOnceHistory[id]) {
                return;
            }

            // TODO: point to this._report once we've deprecated the legacy params
            this._reportLegacy(options);
            this._reportOnceHistory[id] = true;
        },

        getFrameSettings: function () {
            var frameSettings = WindowedApp.prototype.getFrameSettings.call(this);

            frameSettings.insertBeforeEl = this.settings.insertBeforeEl;
            frameSettings.insertAfterEl = this.settings.insertAfterEl;

            return frameSettings;
        },
    });


    var AdsPublic = function (settings) {
        settings = settings || {};
        if (!settings.experiment) {
            // Set an `experiment` object to keep access consistent across use cases.
            // Some places have a dedicated experiment object and others just set
            // keys in the settings object
            settings.experiment = {
                experiment: settings.experimentName,
                variant: settings.experimentVariant,
                service: settings.experimentService,
            };
        }

        return new AdsApp(settings);
    };

    return {
        Ads: AdsPublic,
    };
});

define('core/config',[],function () {
    'use strict';

    // These should be collected from the server
    var origin = window.location.origin;

    // configure next-core
    return {
        urls: {
            avatar: {
                generic: 'https://c.disquscdn.com/images/noavatar92.png',
            },
            api: origin + '/api/3.0/',
            apiSettings: origin + '/users/self/',
            login: origin + '/next/login/',
            oauth: {
                twitter: origin + '/_ax/twitter/begin/',
                google: origin + '/_ax/google/begin/',
                facebook: origin + '/_ax/facebook/begin/',
            },
            oauthDestroy: function (service) {
                return origin + '/_ax/' + service + '/unmerge/';
            },
            oauthStatus: function (service) {
                return origin + '/_ax/' + service + '/merged/';
            },
            userDelete: origin + '/auth/json/user_delete/',
            verifyEmail: origin + '/next/verify/',
        },
        keys: {
            api: 'E8Uh5l5fHZ6gD8U3KycjAIAk46f68Zw7C6eW8WSjZvCLXebZ7p0r1yrYDrLilk2F',
        },

        // IMPORTANT: If you change this, you must update the embed, marketing, and publisher-admin's config
        // or else the counts will be out of sync.
        feedApiVersion: '12',
        debug: false,
    };
});

define('core/utils/browser',[
], function (
) {
    'use strict';

    var exports = {
        isIE: function () {
            // http://msdn.microsoft.com/en-us/library/dn321432.aspx
            // http://msdn.microsoft.com/en-us/library/cc196988(v=vs.85).aspx
            return Boolean(window.document.documentMode);
        },

        isSafari: function () {
            // http://stackoverflow.com/questions/7944460/detect-safari-browser
            var ua = window.navigator.userAgent.toLowerCase();
            return ua.indexOf('safari') > -1 && ua.indexOf('chrome') === -1;
        },

        isFirefox: function () {
            // https://stackoverflow.com/questions/7000190/detect-all-firefox-versions-in-js
            var ua = window.navigator.userAgent.toLowerCase();
            return ua.indexOf('firefox') > -1 && ua.indexOf('chrome') === -1;
        },

        isChrome: function () {
            // https://stackoverflow.com/questions/4565112/javascript-how-to-find-out-if-the-user-browser-is-chrome/13348618#13348618
            var ua = window.navigator.userAgent.toLowerCase();
            return ua.indexOf('crios') > -1 /* chrome ios */ ||
                (Boolean(window.chrome) /* chromium based */ &&
                    window.navigator.vendor === 'Google Inc.' /* from google */ &&
                    window.opr === undefined /* not opera */ &&
                    ua.indexOf('edge') === -1 /* not edge */);
        },

        isEdge: function () {
            var ua = window.navigator.userAgent.toLowerCase();
            return ua.indexOf('edge') > -1;
        },

        isOpera: function () {
            // https://stackoverflow.com/questions/1998293/how-to-determine-the-opera-browser-using-javascript
            var ua = window.navigator.userAgent.toLowerCase();
            return ua.indexOf('opera') > -1 || ua.indexOf('opr') > -1;
        },

        isCrawler: function (win) {
            // This logic MUST match the `is_crawler` check in rDISQUS as the
            // backend will return a different lounge response based on this.

            if (win === undefined)
                win = window;

            var ua = win.navigator.userAgent;
            return /bot|crawl|slurp|spider|facebookexternalhit|embedly|feedly|pinterest/i.test(ua);
        },
    };

    return exports;
});

define('core/utils/isMobileUserAgent',[],function () {
    'use strict';

    /**
     * Does the current device publish a mobile-like user agent (phone & tablet)?
     * Ported from https://gist.github.com/dalethedeveloper/1503252
     *
     * @param {window} [win] dependency injection for the main window global :|
     * @returns {boolean} `true` if the browser looks like a mobile browser, `false` otherwise
     */
    return function (win) {
        win = win || window;
        return /Mobile|iP(hone|od|ad)|Android|BlackBerry|IEMobile|Kindle|NetFront|Silk-Accelerated|(hpw|web)OS|Fennec|Minimo|Opera M(obi|ini)|Blazer|Dolfin|Dolphin|Skyfire|Zune/i.test(win.navigator.userAgent || win.navigator.vendor || win.opera);
    };
});

define('core/utils',[
    'jquery',
    'underscore',

    'core/config',
    'core/utils/browser',
    'core/utils/isMobileUserAgent',
], function (
    $,
    _,

    config,
    browser,
    isMobileUserAgent
) {
    'use strict';

    var doc = window.document;
    // From https://github.com/ryanseddon/H5F/blob/039588f4b1d8513b09a49f903d70ff269435d4b3/src/H5F.js#L20
    var emailPatt = /^[a-zA-Z0-9.!#$%&'*+-/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$/;
    var validateEmail = function (email) {
        return emailPatt.test(email);
    };

    /*
     * This uses the same url RegExp as Bleach version 1.0.3 and returns
     * the links it finds. This is not a direct match to Bleach, as there is no
     * true HTML parsing, but it is sufficient for finding urls.
     */
    // TODO: config.TLDS is included to support an Embed override. Embed gets
    // an up-to-date list every build via manifest.yaml and the interpolator;
    // an equivalent system should be incorporated in next-core
    var TLDS = config.TLDS ||
        'zw|zuerich|zone|zm|zip|za|yt|youtube|yokohama|yoga|yodobashi|ye|' +
        'yandex|yachts|xyz|xxx|xin|xerox|wtf|wtc|ws|world|works|work|wme|win|' +
        'williamhill|wiki|wien|whoswho|wf|weir|wedding|wed|website|webcam|' +
        'watch|wang|wales|vu|voyage|voto|voting|vote|vodka|vn|vlaanderen|' +
        'vision|villas|video|viajes|vi|vg|vet|versicherung|ventures|vegas|ve|' +
        'vc|vacations|va|uz|uy|us|uol|uno|university|uk|ug|ua|tz|tw|tv|tui|' +
        'tt|trust|travel|training|trading|trade|tr|toys|town|tours|toshiba|' +
        'toray|top|tools|tokyo|today|to|tn|tm|tl|tk|tj|tirol|tires|tips|' +
        'tienda|tickets|theater|th|tg|tf|tennis|temasek|tel|technology|tech|' +
        'team|td|tc|taxi|tax|tattoo|tatar|taipei|sz|systems|sydney|sy|sx|' +
        'swiss|sv|suzuki|surgery|surf|support|supply|supplies|sucks|su|style|' +
        'study|st|sr|spreadbetting|spiegel|space|soy|sony|solutions|solar|' +
        'sohu|software|social|so|sn|sm|sl|sky|sk|sj|site|singles|si|shriram|' +
        'show|shoes|shiksha|sh|sg|sexy|sex|sew|services|sener|seat|se|sd|' +
        'scot|science|schwarz|schule|school|scholarships|schmidt|scb|sca|sc|' +
        'sb|saxo|sarl|sap|samsung|sale|saarland|sa|ryukyu|rw|run|ruhr|ru|' +
        'rsvp|rs|rodeo|rocks|ro|rip|rio|rich|reviews|review|restaurant|rest|' +
        'republican|report|repair|rentals|rent|ren|reit|reisen|reise|rehab|' +
        'redstone|red|recipes|realtor|re|racing|quebec|qpon|qa|py|pw|pub|pt|' +
        'ps|property|properties|prof|productions|prod|pro|press|praxi|pr|' +
        'post|porn|poker|pohl|pn|pm|plus|plumbing|place|pl|pk|pizza|pink|' +
        'pictures|pictet|pics|piaget|physio|photos|photography|photo|philips|' +
        'pharmacy|ph|pg|pf|pe|party|parts|partners|paris|panerai|page|pa|ovh|' +
        'otsuka|osaka|organic|org|oracle|ooo|online|onl|ong|one|om|okinawa|' +
        'nz|nyc|nu|ntt|nrw|nra|nr|np|no|nl|nissan|ninja|nico|ni|nhk|ngo|ng|' +
        'nf|nexus|news|new|neustar|network|net|nec|ne|nc|navy|name|nagoya|' +
        'nadex|na|mz|my|mx|mw|mv|museum|mu|mtpc|mtn|mt|ms|mr|mq|mp|movie|mov|' +
        'motorcycles|moscow|mortgage|mormon|money|monash|moe|moda|mobi|mo|mn|' +
        'mma|mm|ml|mk|mini|mil|miami|mh|mg|menu|memorial|meme|melbourne|meet|' +
        'media|me|md|mc|marriott|markets|marketing|market|mango|management|' +
        'maison|maif|madrid|ma|ly|lv|luxury|luxe|lu|ltda|lt|ls|lr|love|lotto|' +
        'lotte|london|lol|loans|loan|lk|link|limo|limited|lighting|life|lidl|' +
        'liaison|li|lgbt|legal|leclerc|lease|lds|lc|lb|lawyer|latrobe|lat|' +
        'land|lacaixa|la|kz|kyoto|ky|kw|kred|krd|kr|kp|komatsu|koeln|kn|km|' +
        'kiwi|kitchen|kim|ki|kh|kg|ke|kddi|kaufen|juegos|jp|joburg|jobs|jo|' +
        'jm|jewelry|jetzt|je|jcb|java|iwc|it|is|irish|ir|iq|io|investments|' +
        'international|int|insure|institute|ink|ing|info|infiniti|industries|' +
        'in|immobilien|immo|im|il|ifm|ie|id|icu|ibm|hu|ht|hr|how|house|' +
        'hosting|host|horse|honda|homes|holiday|holdings|hockey|hn|hm|hk|hiv|' +
        'hitachi|hiphop|hermes|here|help|healthcare|haus|hangout|hamburg|gy|' +
        'gw|guru|guitars|guide|guge|gu|gt|gs|gripe|green|gratis|graphics|gr|' +
        'gq|gp|gov|gop|google|goog|goo|golf|goldpoint|gold|gn|gmx|gmo|gmail|' +
        'gm|globo|global|gle|glass|gl|gives|gifts|gift|gi|gh|ggee|gg|gf|gent|' +
        'ge|gdn|gd|gbiz|gb|garden|gallery|gal|ga|futbol|furniture|fund|' +
        'frogans|frl|fr|foundation|forsale|forex|football|foo|fo|fm|fly|' +
        'flsmidth|flowers|florist|flights|fk|fj|fitness|fit|fishing|fish|' +
        'firmdale|financial|finance|film|fi|feedback|fashion|farm|fans|fan|' +
        'faith|fail|express|exposed|expert|exchange|everbank|events|eus|' +
        'eurovision|eu|et|estate|esq|es|erni|er|equipment|epson|enterprises|' +
        'engineering|engineer|energy|emerck|email|eg|ee|education|edu|ec|eat|' +
        'dz|dvag|durban|download|doosan|domains|doha|dog|docs|do|dnp|dm|dk|' +
        'dj|discount|directory|direct|digital|diet|diamonds|dev|design|desi|' +
        'dentist|dental|democrat|delivery|degree|deals|de|dclk|day|datsun|' +
        'dating|date|dance|dad|dabur|cz|cyou|cymru|cy|cx|cw|cv|cuisinella|cu|' +
        'cruises|crs|cricket|creditcard|credit|cr|courses|country|coop|cool|' +
        'cooking|contractors|consulting|construction|condos|computer|company|' +
        'community|com|cologne|college|coffee|codes|coach|co|cn|cm|club|' +
        'clothing|clinic|click|cleaning|claims|cl|ck|city|citic|ci|church|' +
        'chrome|christmas|chloe|cheap|chat|channel|ch|cg|cfd|cfa|cf|cern|ceo|' +
        'center|cd|cc|cbn|catering|cat|casino|cash|casa|cartier|cars|careers|' +
        'career|care|cards|caravan|capital|capetown|canon|cancerresearch|' +
        'camp|camera|cal|cafe|cab|ca|bzh|bz|by|bw|bv|buzz|business|builders|' +
        'build|budapest|bt|bs|brussels|brother|broker|bridgestone|br|' +
        'boutique|boo|bond|boats|bo|bnpparibas|bn|bmw|bm|blue|bloomberg|' +
        'blackfriday|black|bj|biz|bio|bingo|bike|bid|bi|bh|bg|bf|best|berlin|' +
        'beer|be|bd|bbc|bb|bayern|bauhaus|bargains|barclays|barclaycard|bar|' +
        'bank|band|ba|az|axa|ax|aw|autos|auto|audio|auction|au|attorney|at|' +
        'associates|asia|as|arpa|army|archi|ar|aquarelle|aq|apartments|ao|' +
        'android|an|amsterdam|am|alsace|allfinanz|al|airforce|aig|ai|agency|' +
        'ag|afl|af|aero|ae|adult|ads|ad|actor|active|accountants|accountant|' +
        'accenture|academy|ac|abogado|abbott|abb';

    // Url RegExp
    var URL_RE = new RegExp(
        // http://
        // Note: First group must be removed from match when
        // processing, in python it was a look-behind.
        '([^@.]|^)\\b(?:\\w[\\w-]*:/{0,3}(?:(?:\\w+:)?\\w+@)?)?' +
        // xx.yy.tld
        '([\\w-]+\\.)+(?:' + TLDS + ')(?!\\.\\w)\\b' +
        // optional port
        '(?::\\d+)?' +
        // /path/zz (excluding "unsafe" chars from RFC 1738,
        // except for # and ~, which happen in practice)
        '(?:[/?][^\\s\\{\\}\\|\\\\\\^\\[\\]`<>"\\x80-\\xFF\\x00-\\x1F\\x7F]*)?',
        // Flags.
        // Note: ignore case is NOT set because Bleach version 1.0.3 does not
        // set it. This is a bug, resulting in urls being ignored if the TLD
        // is capitalized. However, it is repeated here for consistency with
        // the server; if we update Bleach we should update this method as well.
        'g'
    );

    var isUrl = function (urlStr) {
        return Boolean(urlStr.match(URL_RE));
    };

    // Protocol RegExp
    var PROTO_RE = /^[\w-]+:\/{0,3}/;
    // Punctuation RegExp.
    // This is global so that lastIndex is set.
    var PUNCT_RE = /([.,]+)$/g;

    var bleachFindUrls = function (message) {
        var urlRecord = [];
        var match, matchedStr, punctMatch, href, group1;

        if (!message) {
            return urlRecord;
        }
        while (match = URL_RE.exec(message)) {  // eslint-disable-line no-cond-assign
            matchedStr = match[0];
            group1 = match[1];

            // Remove first group of match (see comment in URL_RE)
            matchedStr = matchedStr.slice(group1.length);

            // Remove trailing punctuation
            PUNCT_RE.lastIndex = 0;
            punctMatch = PUNCT_RE.exec(matchedStr);
            if (punctMatch) {
                matchedStr = matchedStr.slice(0, matchedStr.length - punctMatch[0].length);
            }
            // Normalize protocol
            if (PROTO_RE.test(matchedStr)) {
                href = matchedStr;
            } else {
                href = 'http://' + matchedStr;
            }
            // Store match
            var index = match.index + group1.length;
            urlRecord.push({
                text: matchedStr,
                url: href,
                index: index,
                endIndex: index + matchedStr.length,
            });
        }

        return urlRecord;
    };

    // Regex to match sequence of 1 or more punctuation
    // characters at the end of a string
    // See: www.unicode.org/charts/
    var terminatingPuncRe = new RegExp('[' +
            // Basic Latin (ASCII punctuation blocks)
            '\\u0021-\\u002F' +
            '\\u003A-\\u0040' +
            '\\u005B-\\u0060' +
            '\\u007B-\\u007E' +
            // Latin-1 Supplement (Latin-1 punctuation)
            '\\u00A1-\\u00BF' +
            // General Punctuation
            '\\u2010-\\u2027' +
            '\\u2030-\\u205E' +
            // Miscellaneous technical
            '\\u2300-\\u23FF' +
            // Supplemental punctuation
            '\\u2E00-\\u2E7F' +
            // CJK Symbols and Punctuation
            '\\u3001-\\u303F' +
            // Vertical forms
            '\\uFE10-\\uFE19' +
            // CJK Compatibility Forms
            '\\uFE30-\\uFE4F' +
            // Small form variants
            '\\uFE50-\\uFE6B' +
            // Fullwidth ASCII Forms
            '\\uFF01-\\uFF0F' +
            '\\uFF1A-\\uFF20' +
            '\\uFF3B-\\uFF40' +
            '\\uFF5B-\\uFF60' +
            // Halfwidth CJK Punctuation
            '\\uFF5F-\\uFF64' +
        ']+$');

    var MAX_TRUNCATION_RATIO = 0.5;
    // Given a character limit (upperLimit) return the whole text
    // if it fits within the limit, otherwise try to truncate
    // within that limit without chopping off a word halfway or
    // returning text with dangling punctuation but also without
    // truncating the text more than halfway.
    var niceTruncate = function (text, upperLimit) {
        if (text.length <= upperLimit) {
            return text;
        }
        text = text.slice(0, upperLimit - 1);  // account the ellipsis char
        var max = text;

        // There's no way to know if the last sequence of chars is
        // a whole word or not, so scan the sliced text backwards
        // for the first whitespace character and truncate there

        // Greedily match everything up to the last chunk of whitespace
        var matches = /(^.*\S)\s/.exec(text);

        if (matches) {
            text = matches[1];
        }
        var endPunctuation = terminatingPuncRe.exec(text);

        // Remove any trailing punctuation
        if (endPunctuation) {
            text = text.slice(0, text.length - endPunctuation[0].length);
        }
        // If the further truncation above caused the text we're returning
        // to be less than 1/2 what it was before further truncation, we undo
        if (text.length < MAX_TRUNCATION_RATIO * max.length) {
            text = max;
        }
        return text + '\u2026';  // Ellipsis
    };

    var _hasStyleProperty = (function () {
        var el = doc.createElement('fakeelement');

        return function (_cssName, jsName) {
            return el.style[jsName] !== undefined;
        };
    }());

    // http://stackoverflow.com/questions/5023514/how-do-i-normalize-css3-transition-functions-across-browsers
    var transitionEndEvent = (function () {
        var transitions = {
            transition: 'transitionend',
            OTransition: 'otransitionend',
            MozTransition: 'transitionend',
            WebkitTransition: 'webkitTransitionEnd',
        };

        return _.find(transitions, _hasStyleProperty) || null;
    })();

    // https://developer.mozilla.org/en-US/docs/Web/Guide/CSS/Using_CSS_animations/Detecting_CSS_animation_support
    var animationEndEvent = (function () {
        var animations = {
            animation: 'animationend',
            OAnimation: 'oAnimationEnd',
            MozAnimation: 'animationend',
            WebkitAnimation: 'webkitAnimationEnd',
        };

        return _.find(animations, _hasStyleProperty) || null;
    })();

    /**
     * Utility helper for DOM event handlers that automatically calls preventDefault for you
     *
     * @param {function} handler The event handler to be wrapped/modified
     * @returns {function} The new, augmented event handler that prevents the default action for the event
     */
    function preventDefaultHandler(handler) {
        return function (evt) {
            if (evt && evt.preventDefault) {
                evt.preventDefault();
            }
            return handler.apply(this, arguments);
        };
    }

    /**
     * Utility helper for DOM event handlers that automatically calls stopPropagation for you
     *
     * @param {function} handler The event handler to be wrapped/modified
     * @returns {function} The new, augmented event handler that stops the propagation of the event
     */
    function stopPropagationHandler(handler) {
        return function (evt) {
            if (evt && evt.stopPropagation) {
                evt.stopPropagation();
            }
            return handler.apply(this, arguments);
        };
    }

    function stopEventHandler(handler) {
        return preventDefaultHandler(stopPropagationHandler(handler));
    }

    function getDomain(url) {
        // Extracts hostname from url, without the www prefix.

        if (!url) {
            return '';
        }
        // Force the protocol to http.
        // This resolves an issue where some browsers do not extract
        // the hostname if the url does not use a typical protocol.
        // Forcing a protocol is also required since if missing the
        // url will be resolved as a relative url on our domain.
        url = 'http://' + url.replace(/^([a-z+.-]+:)?\/+/i, '');

        var link = doc.createElement('a');
        link.href = url;

        // Remove www prefix and any trailing numbers.
        // Since getDomain is used only for display purposes this is a
        // safe operation.
        var domain = link.hostname.replace(/^www\d*\./i, '');

        // Normalize capitalization since browsers are inconsistent
        // about this.
        domain = domain.toLowerCase();

        return domain;
    }

    function serializeArgs(params) {
        var pcs = [];
        _.each(params, function (val, key) {
            if (val !== undefined) {
                pcs.push(key + (val === null ? '' : '=' + encodeURIComponent(val)));
            }
        });
        return pcs.join('&');
    }

    function serialize(url, params, nocache) {
        if (params) {
            if (url.indexOf('?') === -1) {
                url += '?';
            } else if (url.charAt(url.length - 1) !== '&') {
                url += '&';
            }
            url += this.serializeArgs(params);
        }

        if (nocache) {
            var ncp = {};
            ncp[(new Date()).getTime()] = null;
            return this.serialize(url, ncp);
        }

        var len = url.length;
        return url.charAt(len - 1) === '&' ? url.slice(0, len - 1) : url;
    }

    /**
     * window.open wrapper
     *
     * IMPORTANT: must obey same contract as window.open
     * i.e., same function signature, same return value
     *
     * We wrap it because it is not possible to stub `window.open`
     * reliably across browsers for testing, which causes issues from time to time.
     *
     * @param {string} url The URL for the new popup window
     * @param {string} [title] The title of the new popup window
     * @param {Object} [options] Options for the new window such as height and width. The following are overridden:
     *                           location, status, resizable, scrollbars for UX and cross-browser consistency.
     * @returns {window|null} The reference to the newly created popup window, or `null` if popup is blocked.
     */
    function openWindow(url, title, options) {
        // Don't add any defaults if options object is not provided. Not using
        // options is the only way to default to opening a new tab instead of a
        // window when using `window.open`
        if (options) {
            _.extend(options, {
                'location': 1,
                'status': 1,
                'resizable': 1,
                'scrollbars': 1,
            });
        } else {
            options = {};
        }

        if (options.width && options.height) {
            // By default, position window in the middle of the browser screen
            _.defaults(options, {
                left: window.screen.width / 2 - options.width / 2,
                top: window.screen.height / 2 - options.height / 2,
            });
        }

        var optionsStr = _.map(options, function (val, key) {
            return key + '=' + val;
        }).join(',');

        return window.open(url, title, optionsStr);
    }

    /**
     * Safely insert a string into another string at specified index.
     * Spaces will be guaranteed to surround the inserted string, except
     * at the beginning of the new string.
     *
     * @param {string} string The string to be inserted into
     * @param {number} index The position to insert into
     * @param {string} stringToInsert The string to be inserted
     *
     * @returns {string} The newly crafted string
     */
    function insertWithWhitespace(string, index, stringToInsert) {
        if (index < 0) {
            index = 0;
        }
        var before = string.substring(0, index);
        var after = string.substring(index);

        // Place a space before the new string if necessary
        if (before.length && !/\s$/.test(before)) {
            before += ' ';
        }
        // Place a space after the new string if necessary
        // Will also place a space if at the end of the text
        if (!/^\s/.test(after)) {
            after = ' ' + after;
        }
        return before + stringToInsert + after;
    }

    /**
     * Check if a clicked link will open a new window or tab.
     *
     * We don't have to delay link clicks if they will open a new tab via
     * command / shift / control key modifiers or if the 'target' attribute is '_blank'.
     *
     * @param  {$.Event}    evt The event object from the original click event.
     * @param  {jQuery}   $link jQuery wrapped link object.
     * @returns {boolean}
     */
    var willOpenNewWindow = function (evt, $link) {
        if (!$link) {
            $link = $(evt.currentTarget);
        }
        return $link.attr('target') === '_blank' ||
            evt.ctrlKey ||  // For Windows and Linux
            evt.metaKey || // For OS X
            evt.shiftKey || // For new window
            evt.altKey;  // God knows what
    };

    var LINK_CLICK_RECENCY_TIMEOUT = 500;  /* ms */
    /**
     * Determine if a click event should be logged to our analytics servers.
     *
     * We currently log clicks only if the link's href is intended to cause
     * the parent page to change locations (disregarding modifier keys, etc.).
     *
     * @param  {$.Event}  evt The jQuery event object.
     * @param  {jQuery}   $link jQuery wrapped link object.
     * @returns {boolean}
     */
    var clickShouldBeLogged = (function () {
        var logged = {};
        var urlFragmentReg = /#.*$/;

        var getLinkTrackingId = function ($link) {
            // Because a link's href may be modified during the course
            // of a click event, we need to attach our own IDs.
            var id = $link.attr('data-tid');
            if (!id) {
                id = _.uniqueId();
                $link.attr('data-tid', id);
            }
            return id;
        };

        return function (evt, $link) {
            // We don't do anything if we're already handling this event elsewhere.
            if (evt.isDefaultPrevented()) {
                return false;
            }
            // We don't bother if the clicked element is not a link.
            if (!$link.is('a')) {
                return false;
            }
            // We don't bother if the clicked link doesn't have an href attribute,
            // or if the clicked link's href attribute is just a hash.
            var href = ($link.attr('href') || '').replace(urlFragmentReg, '');
            if (!href) {
                return false;
            }
            // Because we re-trigger clicks, it is very possible that we're being
            // asked to log the same click twice. We keep an internal hash of
            // links clicks we've logged within the last .5s so that we don't
            // enter an infinite click loop.
            var linkId = getLinkTrackingId($link);
            var timestamp = new Date().getTime();

            // If we recently delayed this click, then bail out now.
            if (logged[linkId] && timestamp - logged[linkId] < LINK_CLICK_RECENCY_TIMEOUT) {
                return false;
            }
            logged[linkId] = timestamp;
            return true;
        };
    })();

    /**
     * This is a workaround for creating a deep-clone, since underscore.clone
     * and Object.assign only create shallow-copies
     * NOTE: This function is incompatible with values that don't have an
     * equivalent type in JSON (ie: Date, Function, Infinity). Additionally
     * undefined properties will be omitted from the cloned object.
     *
     * Ref: https://github.com/jashkenas/underscore/pull/595#issuecomment-34858191
     *
     * @param {*} original - The item that will be cloned
     * @returns {*}
     */
    function deepClone(original) {
        if (typeof original === 'undefined') {
            return null;
        }
        return JSON.parse(JSON.stringify(original));
    }

    return {
        validateEmail: validateEmail,
        isUrl: isUrl,
        bleachFindUrls: bleachFindUrls,
        niceTruncate: niceTruncate,
        transitionEndEvent: transitionEndEvent,
        animationEndEvent: animationEndEvent,
        isMobileUserAgent: isMobileUserAgent,
        preventDefaultHandler: preventDefaultHandler,
        stopPropagationHandler: stopPropagationHandler,
        stopEventHandler: stopEventHandler,
        getDomain: getDomain,
        serializeArgs: serializeArgs,
        serialize: serialize,
        openWindow: openWindow,
        insertWithWhitespace: insertWithWhitespace,
        willOpenNewWindow: willOpenNewWindow,
        clickShouldBeLogged: clickShouldBeLogged,
        deepClone: deepClone,
        browser: browser,
    };
});

define('home/mixins/asEmbedLayout',[
    'jquery',
    'underscore',

    'core/ads/ads',
    'core/frameBus',
    'core/utils',
], function (
    $,
    _,

    adsModule,
    FrameBus,
    coreUtils
) {
    'use strict';

    var AD_CONTAINER_SELECTOR = '#drawer-ad-inner-container';

    var asEmbedLayout = function () {
        var _events = this.events || {};
        this.events = _.extend({
            'click [data-action=close-drawer]': 'closeDrawer',
            'click .viewport': 'closeDrawerOnClick',
            'click [data-action=full-home]': 'openFullHome',
            'click [data-action=refresh-drawer]': 'handleRefresh',
            'keydown': 'handleKeyPress',

            // https://developer.mozilla.org/en-US/docs/Web/Events/wheel#Listening_to_this_event_across_browser
            'wheel .scrollable-measure-selector': 'handleScroll',
            'wheel .viewport': 'handleViewportScroll',
            'mousewheel .scrollable-measure-selector': 'handleScroll',
            'mousewheel .viewport': 'handleViewportScroll',
        }, _events);

        var _initialize = this.initialize;
        this.initialize = function () {
            _initialize.apply(this, arguments);
            this.listenTo(this.app, {
                'drawer:open': this.createAd,
            });
        };

        this.handleRefresh = function (evt) {
            evt.preventDefault();

            var elem = $(evt.currentTarget);
            elem.addClass('loading');

            var notifications = this.session.getOrCreateNotifications();
            var allUpdated = $.Deferred();
            var repliesUpdated = $.Deferred();

            $.when(allUpdated, repliesUpdated).done(function () {
                elem.removeClass('loading');
                notifications.all.trigger('clearUnreadCount');
            });

            notifications.all.fetchItems({
                reset: true,
                success: function () {
                    allUpdated.resolve();
                },
            });
            notifications.replies.fetchItems({
                reset: true,
                success: function () {
                    repliesUpdated.resolve();
                },
            });
        };

        this.openFullHome = function (evt) {
            evt.preventDefault();
            window.open(window.location.href, '_blank');
        };

        this.closeDrawerOnClick = function (evt) {
            // Don't close if user clicked somewhere in the home drawer
            // and not on the viewport directly
            if (!$(evt.target).hasClass('viewport')) {
                return;
            }

            this.closeDrawer(evt);
        };

        this.isIE10 = function () {
            return window.document.documentMode === 10;
        };

        this.handleKeyPress = function (evt) {
            if (evt.which === 27) {
                this.closeDrawer(evt);
            }
        };

        this.closeDrawer = function (evt) {
            evt.preventDefault();

            var body = $('body');
            body.removeClass('active');

            // this IE10 check is necessary to fix a bug where the css transitionend
            // event isn't called sometimes when the closing css transition completes.
            if (this.isIE10() || !coreUtils.transitionEndEvent) {
                _.delay(_.bind(FrameBus.sendHostMessage, this, 'close'), 300);
                _.delay(_.bind(FrameBus.trigger, FrameBus, 'close'), 300);
            } else {
                body.one(coreUtils.transitionEndEvent, function () {
                    FrameBus.sendHostMessage('close');
                    FrameBus.trigger('close');
                });
            }
        };

        var _onRender = this.onRender;
        this.onRender = function () {
            _onRender.apply(this, arguments);

            _.defer(_.bind(FrameBus.trigger, FrameBus, 'mainlayoutRendered'));
        };

        this.getScrollableContainer = function () {
            // if scrollableContainer isn't present or it doesn't have any parent due to
            // rerendering, we get the element again
            if (!this.scrollableContainer || !$.contains(window.document.documentElement, this.scrollableContainer[0])) {
                this.scrollableContainer = this.$('.scrollable-measure-selector');
            }

            return this.scrollableContainer;
        };

        this.handleViewportScroll = function (event) {
            event.preventDefault();
        };

        this.handleScroll = function (event) {
            var evt = event.originalEvent;

            // wheelDeltaY for mousewheel event - https://developer.mozilla.org/en-US/docs/Web/Events/mousewheel
            // deltaY for wheel event - https://developer.mozilla.org/en-US/docs/Web/Events/wheel
            var dir = evt.wheelDeltaY || -evt.deltaY;

            var scrollableContainer = this.getScrollableContainer();
            if (!scrollableContainer) {
                return;
            }

            // scrolled to top
            if (scrollableContainer.scrollTop() === 0 && dir > 0) {
                event.preventDefault();
            }

            // scrolled to bottom
            if ((scrollableContainer.scrollTop() + scrollableContainer.innerHeight() >=
                scrollableContainer[0].scrollHeight) && (dir < 0)) {
                event.preventDefault();
            }

            // so it doesn't propagate to the viewport scroll event
            event.stopPropagation();
        };

        this.removeAd = function () {
            if (this.sidebarAdApp) {
                this.sidebarAdApp = null;
            }
            var adContainer = $(AD_CONTAINER_SELECTOR);
            adContainer.empty();
            adContainer.hide();
        };

        this.createAd = function () {
            if (!this.session.config) {
                this.listenToOnce(this.session, 'config:ready', this.createAd);
                return;
            }

            var config = this.session.config;
            var adUrl = config.sidebarPlacementUrl;
            var minSizeForAd = 1024;
            var canFitAd = $(window.document).width() >= minSizeForAd;

            if (!adUrl || this.sidebarAdApp || !canFitAd) {
                return;
            }

            // Can't store adContainer in a variable earlier during showAd
            // because the view may render again between showAd and renderAd.
            // If that happens, then adContainer will point to an element
            // that's been removed from the DOM and the ad won't be visible.
            var adContainer = $(AD_CONTAINER_SELECTOR);
            adContainer.show();

            var sidebarAdsStyle = {};
            if (config.experimentName.indexOf('googlewidemargins') === 0 &&
                config.experimentVariant !== 'fallthrough') {
                sidebarAdsStyle.margin = config.experimentVariant;
            }

            this.sidebarAdApp = adsModule.Ads(_.extend({  // eslint-disable-line new-cap
                adUrl: adUrl,
                placement: 'sidebar',
                isInHome: true,
                isOnHostPage: false,
                forumId: config.forumDetails.id,
                version: config.version,
                styles: sidebarAdsStyle,
            }, config, {
                container: adContainer[0],
            }));

            this.listenToOnce(this.sidebarAdApp, 'ad-placement-empty', this.removeAd);
            this.listenToOnce(FrameBus, 'close', this.removeAd);
            this.sidebarAdApp.init();
        };
    };

    return asEmbedLayout;
});

define('home/mixins/withClickLinkTracking',[
    'jquery',
    'underscore',
    'core/bus',
], function (
    $,
    _,
    bus
) {
    'use strict';

    // Debounce triggerClick so that an element that has multiple click
    // handlers on it that call trackClickLink with different event
    // objects will end up being debounced by this function and only
    // tracked once.
    var triggerClick = _.debounce(function (evt, params) {
        bus.trigger('uiAction:clickLink', evt, params);
    }, 500, true);

    return function (area) {
        this.trackClickLink = function (evt) {
            // Ignore if the link is taking the user to edit their post.
            // Prevents us from tracking one click as two separate events.
            if (evt.currentTarget.dataset.action === 'edit')
                return;
            var $target = $(evt.currentTarget);
            var params = {
                adjective: $target.attr('data-link-name'),
            };

            // Use the area as given when this mixin was applied, if any.
            // Otherwise use an area defined in the dom, if any.
            if (area)
                params.area = area;
            else
                params.area = $target.closest('[data-jester-area]').attr('data-jester-area');

            triggerClick(evt, params);
        };
    };
});

define('core/api',[
    'jquery',
    'underscore',
    'backbone',

    'core/config',
    'core/utils',
], function (
    $,
    _,
    Backbone,

    config,
    utils
) {
    'use strict';

    // Throwaway anchor element for parsing URLs
    var doc = window.document;
    var anchor = doc.createElement('a');

    function getOrigin(href) {
        anchor.href = href;
        return anchor.origin || (anchor.protocol + '//' + anchor.hostname + (anchor.port ? ':' + anchor.port : ''));
    }

    // Default options for api calls (see: api.defaults())
    var defaults = {};

    function makeHttps(url) {
        return url.replace(/^(http:)?\/\//, 'https://');
    }

    function ajaxTransport(options) {
        options = _.defaults(options, defaults);

        // set options.traditional in order to force jQuery to serialize query
        // string parameters according to backend expectations. In other words
        // avoid square brackets in query parameters: b[]=1&b[]=2&b[]=3
        options.traditional = true;

        // If the target URL has a different origin than the current URL,
        // need to use withCredentials (CORS) in order to pass the session
        // cookie with requests
        if (getOrigin(window.location.href) !== getOrigin(options.url))
            options.xhrFields = { withCredentials: true };

        // API key always required for calls to Disqus API (disqus.com/api).
        // However, there are cases where the AJAX framework
        // needs to be used by parts of the code making requests
        // to other APIs (for example Discovery Promoted results
        // coming from Taboola).
        if (!options.omitDisqusApiKey) {
            options.data = options.data || {};
            if (window.FormData && options.data instanceof window.FormData) {
                // Cannot append to data (api server will reject request),
                // add to url instead
                options.url = utils.serialize(options.url, {
                    api_key: config.keys.api,
                });
            } else {
                options.data.api_key = config.keys.api;
            }
        }

        var originalErrorHandler = options.error;
        options.error = function (xhr) {
            api.trigger('error', xhr);

            if (_.isFunction(originalErrorHandler))
                originalErrorHandler(xhr);
        };

        return $.ajax(options);
    }

    function call(endpoint, options) {
        options = options || {};
        options.url = getURL(endpoint);

        if (!options.omitDisqusApiKey) {
            options.data = _.extend(options.data || {}, {
                api_key: config.keys.api,
            });
        }

        api.trigger('call', options);

        return ajaxTransport(options)
            .always(_.bind(this.trigger, this, 'complete', options));
    }

    function getURL(endpoint) {
        // If the endpoint contains a fully-formed URL, just return as-is but force https
        if (/(https?:)?\/\//.test(endpoint))
            return makeHttps(endpoint);

        return config.urls.api + endpoint;
    }

    var api = {
        ERROR_CODES: {
            OBJ_NOT_FOUND: 8,
            MAX_ITEMS_REACHED: 24,
        },
        ajax: ajaxTransport,
        call: call,
        getURL: getURL,

        defaults: function (options) {
            // sanitize options
            Object.keys(options).forEach(function (key) {
                var value = options[key];
                var existingValue = defaults[key];
                if (_.isObject(value) && _.isObject(existingValue))
                    _.extend(existingValue, value);
                else
                    defaults[key] = value;
            });
        },

        headers: function (headers) {
            var newHeaders = _.extend({}, defaults.headers, headers);
            // clean "falsy" values
            defaults.headers = _.pick(newHeaders, Boolean);

            return defaults.headers;
        },

        makeHttps: makeHttps,
    };

    _.extend(api, Backbone.Events);

    return api;
});

define('core/time',[],function () {
    'use strict';

    var ISO_8601 = 'YYYY-MM-DDTHH:mm:ssZ';

    function assureTzOffset(createdAt) {
        return createdAt.indexOf('+') >= 0 ? createdAt : createdAt + '+00:00';
    }

    return {
        ISO_8601: ISO_8601,
        assureTzOffset: assureTzOffset,
    };
});

define('core/models/BaseUser',[
    'backbone',

    'core/config',
], function (
    Backbone,

    config
) {
    'use strict';

    var BaseUser = Backbone.Model.extend({
        defaults: {
            about: null,
            avatar: {
                // NOTE: the avatar URLs may not be defined at declaration-time, and
                //       might be modified by the host application later
                cache: config.urls.avatar.generic,
                permalink: config.urls.avatar.generic,
            },
            connections: {},
            email: null,  // Should not be passed unless request is by moderator
            isAnonymous: true,  // Anonymous by default
            isFollowedBy: null,
            isFollowing: null,
            joinedAt: null,  // Date time in string. Format: YYYY-MM-DDTHH:mm:ss
            name: null,
            profileUrl: null,
            url: null,
            username: null,

            numPosts: null,
            numFollowing: null,
            numForumsFollowing: null,
            numFollowers: null,
            numLikesReceived: null,

            // optional, attached parameters, passed on request-by-request basis
            isFlagged: null,
        },

        hasValidAvatar: function (attrs) {
            var avatar = attrs ? attrs.avatar : this.get('avatar');
            return avatar && avatar.cache;
        },

        isAnonymous: function () {
            return !this.get('id');
        },

        isRegistered: function () {
            return !this.isAnonymous();
        },

        validate: function (attrs) {
            if (!this.hasValidAvatar(attrs))
                return 'None of the avatar related properties can be null, undefined or empty on User models.';
        },

        toJSON: function () {
            var data = Backbone.Model.prototype.toJSON.apply(this, arguments);
            data.thread = {};

            // Validation does not have any effect if silent flag is set, like
            // in the first initialization so we fix the value on toJSON for
            // templates etc.
            if (!this.hasValidAvatar())
                data.avatar = this.defaults.avatar;

            // Tell us if this user is a user w/ a registered account.
            data.isRegistered = this.isRegistered();

            return data;
        },
    });

    return BaseUser;
});

define('core/models/User',[
    'jquery',
    'underscore',
    'moment',

    'core/config',
    'core/time',
    'core/utils',
    'core/strings',
    'core/api',

    'core/models/BaseUser',
], function (
    $,
    _,
    moment,

    config,
    time,
    utils,
    strings,
    api,
    BaseUser
) {
    'use strict';

    var gettext = strings.get;

    function addError(validationErrors, name, error) {
        validationErrors[name] = validationErrors[name] || [];
        validationErrors[name].push(error);
    }

    // WARNING: Do not create User objects directly. Use UniqueModel instead.
    var User = BaseUser.extend({
        url: api.getURL('users/details'),

        validate: function (attrs) {
            // THOUGHT: I'm not sure that we should be calling gettext
            //          from the model. I think we should have the view
            //          do that. Coupling, etc.
            var validationErrors = {};

            if (attrs.display_name) {
                attrs.display_name = $.trim(attrs.display_name);
            }
            if (!attrs.display_name) {
                addError(validationErrors, 'display_name', gettext('Please enter your name.'));
            }
            if (!attrs.email) {
                addError(validationErrors, 'email', gettext('Please enter your email address.'));
            }
            if (!utils.validateEmail(attrs.email)) {
                addError(validationErrors, 'email', gettext('Invalid email address.'));
            }

            if (this.isNew()) {
                if (!attrs.password) {
                    addError(validationErrors, 'password', gettext('Please enter a password.'));
                } else if (attrs.password.length < User.MIN_PASSWORD_LEN) {
                    addError(validationErrors, 'password', gettext('Password must have at least 6 characters.'));
                }
            }

            if (attrs.name) {
                if (attrs.name.length < User.MIN_NAME_LEN) {
                    addError(validationErrors, 'name', strings.interpolate(
                        gettext('Name must have at least %(minLength)s characters.'),
                        { minLength: User.MIN_NAME_LEN }
                    ));
                }

                if (attrs.name.length > User.MAX_NAME_LEN) {
                    addError(validationErrors, 'name', strings.interpolate(
                        gettext('Name must have less than %(maxLength)s characters.'),
                        { maxLength: User.MAX_NAME_LEN }
                    ));
                }
            }

            if (attrs.location) {
                if (attrs.location.length > User.MAX_LOCATION_LEN) {
                    addError(validationErrors, 'location', strings.interpolate(
                        gettext('Location must have less than %(maxLength)s characters.'),
                        { maxLength: User.MAX_LOCATION_LEN }
                    ));
                }
            }

            if (attrs.url) {
                if (attrs.url.length > User.MAX_URL_LEN) {
                    addError(validationErrors, 'url', strings.interpolate(
                        gettext('Site must have less than %(maxLength)s characters.'),
                        { maxLength: User.MAX_URL_LEN }
                    ));
                }

                if (!utils.isUrl(attrs.url)) {
                    addError(validationErrors, 'url', gettext('Please enter a valid site.'));
                }
            }

            if (!_.isEmpty(validationErrors)) {
                return validationErrors;
            }
        },

        prepareFetchOptions: function (options) {
            options = options ? _.clone(options) : {};

            var data = {};

            if (this.get('id')) {
                data.user = this.get('id');
            } else if (this.get('username')) {
                data.user = 'username:' + this.get('username');
            }
            _.extend(data, options.data);
            options.data = data;

            return options;
        },

        fetch: function (options) {
            options = this.prepareFetchOptions(options);
            return BaseUser.prototype.fetch.call(this, options);
        },

        parse: function (response) {
            var data = response.response || response;
            data = this.handleBadgesUpdate(data);
            return data;
        },

        register: function (options) {
            var self = this;
            options = options || {};


            return api.call('internal/users/register.json', {
                data: _.extend(this.toRegisterJSON(), {
                    gRecaptchaResponse: options.gRecaptchaResponse,
                }),
                method: 'POST',
                success: function (data) {
                    api.call('users/acceptTerms', {
                        method: 'POST',
                    });
                    self.set(_.extend({}, data.response, {
                        // To speed up the signup process, assume the acceptTerms endpoint
                        // call will succeed
                        hasAcceptedGdprTerms: true,
                    }));
                    if (options.success) {
                        options.success(data);
                    }
                },
                error: options.error,
            });
        },

        /*
         * This method uses FormData which isn't supported in all browsers.
         * The Onboard.ProfileSectionView uses this method but checks to see
         * if FormData is supported first.
         */
        saveAvatar: function (fileInput) {
            var formData = new window.FormData();
            formData.append('avatar_file', fileInput);
            formData.append('api_key', config.keys.api);

            return api.call('internal/users/updateAvatar.json', {
                method: 'post',
                data: formData,
                cache: false,
                contentType: false,
                processData: false,
            });
        },

        saveProfile: function () {
            return api.call('users/updateProfile.json', {
                method: 'POST',
                data: {
                    name: this.get('name'),
                    about: this.get('about'),
                    location: this.get('location'),
                    url: this.get('url'),
                },
            });
        },

        toRegisterJSON: function () {
            return _.pick(this.toJSON(), 'display_name', 'email', 'password');
        },

        isSession: function (session) {
            return session.user.id && session.user.id === this.id;
        },

        isEditable: function (session) {
            return this.isSession(session) && !this.get('remote');
        },

        toJSON: function (options) {
            options = options || {};

            var json = BaseUser.prototype.toJSON.call(this);
            var thread = this.collection && this.collection.thread;

            json.thread.canModerate = Boolean(thread && thread.isModerator(this));

            // Optionally augment output JSON depending on active session
            if (options.session) {
                json.isSession = this.isSession(options.session);
                json.isEditable = this.isEditable(options.session);
            }
            return json;
        },

        // Calls users/follow if state is true ("following"), users/unfollow
        // if state is false ("not following")
        _changeFollowState: function (state) {
            this.set({
                isFollowing: state,
                numFollowers: Math.max(
                    0,
                    this.get('numFollowers') + (state ? 1 : -1)
                ),
            });

            var endpoint = 'users/' + (state ? 'follow' : 'unfollow');

            // NOTE: If the server returns 200 with a *different* state value
            //       than requested, we are ignoring that value. This should
            //       be exceedingly rare (race condition).

            var self = this;

            return api.call(endpoint + '.json', {
                data: { target: this.get('id') },
                method: 'POST',
                success: function (resp) {
                    self.trigger('sync', self, resp, {});
                },
            });
        },

        follow: function () {
            return this._changeFollowState(true);
        },

        unfollow: function () {
            return this._changeFollowState(false);
        },

        _changeBlockState: function (state) {
            var endpoint = 'users/block/' + (state ? 'create' : 'delete');

            var self = this;
            return api.call(endpoint + '.json', {
                data: { user: this.get('id') },
                method: 'POST',
                success: function (resp) {
                    self.set(resp.response);
                },
            });
        },

        block: function () {
            return this._changeBlockState(true);
        },

        unblock: function () {
            return this._changeBlockState(false);
        },

        report: function (reason) {
            var self = this;

            return api.call('users/report.json', {
                data: {
                    reason: reason,
                    user: this.get('id'),
                },
                method: 'POST',
                success: function () {
                    self.set('isFlagged', true);
                },
            });
        },

        toggleFollowState: function () {
            return this._changeFollowState(!this.get('isFollowing'));
        },

        /*
         * Checks to see if user was registered within a certain period.
         */
        registeredLessThan: function (num, period) {
            var joinedAtUtc = time.assureTzOffset(this.get('joinedAt'));
            var timePeriodAgo = moment().subtract(num, period);
            return moment(joinedAtUtc).isAfter(timePeriodAgo);
        },

        registeredToday: function () {
            return this.registeredLessThan(1, 'day'); // ago
        },

        registeredThisWeek: function () {
            return this.registeredLessThan(1, 'week'); // ago
        },

        /**
         * Whether or not this user has completed onboarding in home.
         * @returns {boolean}
         */
        shouldHomeOnboard: function () {
            return !this.get('homeOnboardingComplete');
        },

        /**
         * Sets the flag for whether or not this user has completed
         * onboarding in home.
         * @param {boolean} isComplete denotes if user has completed home onboarding
         */
        setHomeOnboardComplete: function (isComplete) {
            this.updateFlags({
                'homeOnboardingComplete': isComplete,
            });

            // Sometimes, immediately after completing onboarding the app will receive this
            // user's details through an api call and they have a falsey, out of date value for
            // homeOnboardingComplete which overwrites this change. Since it's not possible
            // to undo the completion of homeOnboarding from within the app, it's safe to
            // persist the truthy value.
            if (isComplete) {
                this.listenTo(this, 'change:homeOnboardingComplete',
                    _.bind(this.set, this, 'homeOnboardingComplete', isComplete, { silent: true }));
            }
        },

        handleBadgesUpdate: function (data) {
            // We get the users badges across all forums from the users/details endpoint
            // but when this.collection is defined (in the embed) we only want the badges for the current forum
            if (this.collection && this.collection.thread && this.collection.thread.forum && this.collection.thread.forum.get('badges') && data.badges) {
                // Filter out the users badges from other forums
                var forumBadges = this.collection.thread.forum.get('badges');
                data.badges = data.badges.filter(function (badge) {
                    return forumBadges[badge.id];
                });
            } else {
                data.badges = [];
            }
            return data;
        },

        /*
         * updateFlags expects an object with boolean values for flags:
         * {
         *     homeOnboardingComplete: true,
         *     homeFeedOnboardingComplete: false
         * }
         *
         * It will convert the boolean values to 1s and 0s for the api call
         * as the UpdateFlags endpoint expects that.
         */
        updateFlags: function (flags) {
            this.set(flags);

            return api.call('internal/users/updateFlags.json', {
                data: _.mapObject(flags, function (val) {
                    return val ? 1 : 0;
                }),
                method: 'POST',
            });
        },
    }, {
        MIN_PASSWORD_LEN: 6,
        MIN_NAME_LEN: 2,
        MAX_NAME_LEN: 30,
        MAX_LOCATION_LEN: 255,
        MAX_URL_LEN: 200,
    });

    return User;
});

define('core/models/Session',[
    'jquery',
    'underscore',
    'backbone',
    'moment',

    'core/api',
    'core/bus',
    'core/config',
    'core/time',
    'core/utils',
    'core/utils/cookies',
    'core/utils/guid',
    'core/utils/auth',

    'core/models/BaseUser',
    'core/models/User',
], function (
    $,
    _,
    Backbone,
    moment,

    api,
    bus,
    config,
    time,
    utils,
    cookies,
    guid,
    auth,

    BaseUser,
    User
) {
    'use strict';

    var fromCookie = function () {
        // Can't move implementation here, as it is imported via auth into React
        // applications. This should be the single access point for this function
        // across embed/home/next-core.
        return auth.getFromCookie();
    };

    /**
     * Session is a utility wrapper around a User instance.
     *
     * Usage:
     *
     *   var session = new Session(); // logged out (BaseUser)
     *   var user = new User({ username: 'janedoe' });
     *   session.setUser(user); // logged in
     *
     *
     * You can bind to the session "change" event like so:
     *
     *   session.on('change:id', this.handleSessionChange);
     *
     *
     * Any events fired on the wrapped User model also fire on the Session instance:
     *
     *   session.on('change:display_name', this.handleNameChange);
     *   user.set('display_name', 'Jane Doe'); // => triggers handler
     *
     */
    var Session = Backbone.Model.extend({

        initialize: function () {
            // Do the once wrapping upon initialization, not statically, so that
            // fromCookie can be tested. Otherwise it can only be called once per
            // test run.
            this.constructor.fromCookie = _.once(fromCookie);
            this.user = this.getAnonUserInstance();
        },

        setUser: function (user) {
            if (this.user)
                this.stopListening(this.user);

            this.user = user;
            this.setIfNewUser();
            this.listenTo(user, 'all', this.trigger);

            this.trigger('change:id', user);
        },

        isLoggedOut: function () {
            return !this.isLoggedIn();
        },

        /**
         * Is the current session authenticated with the server?
         *
         * The current logic just checks if the session user has an ID,
         * but we may change the underlying logic in the future to support
         * situations where we don't yet have the user ID but know that the
         * session is authenticated (of vice versa).
         *
         * @returns {boolean}
         */
        isLoggedIn: function () {
            return Boolean(this.user.get('id'));
        },

        fetch: function (options) {
            var opts = options || {};

            return api.call('users/details.json', {
                data: opts.data,
                success: _.bind(function (response) {
                    response = response.response;

                    if (response.id)
                        this.setUser(this.getUserInstance(response));

                    if (opts.success) opts.success(response);
                    if (opts.complete) opts.complete(response);
                }, this),

                error: function (response) {
                    if (opts.error) opts.error(response);
                    if (opts.complete) opts.complete(response);
                },
            });
        },

        getAnonUserInstance: function (attrs) {
            return new BaseUser(attrs);
        },

        getUserInstance: function (attrs) {
            return new User(attrs);
        },

        getCsrfToken: function () {
            var token = cookies.read('csrftoken');

            // We may not always have a token set so if is empty, we set it
            // ourselves. Since Django only compares the token passed in the
            // URL with the value from the cookie, this just works :)
            if (!token) {
                // Django expects the CSRF token to only contain alphanumeric
                // characters, and everything else gets replaced.
                token = guid.generate().replace(/\W/g, '');
                cookies.create('csrftoken', token, {
                    domain: window.location.hostname,
                    expiresIn: 365 * 24 * 60 * 60 * 1000,  // One year
                });
            }

            return token;
        },

        authenticate: function (service) {
            /** @type {Authenticator} */
            var authenticator = this.authServices[service];
            if (!authenticator)
                return;

            if (_.isFunction(authenticator))
                return authenticator.call(this);

            // TODO: move this uiAction event out of Session.
            // It belongs w/ the event handler method that triggers
            // authenticate.
            bus.trigger('uiAction:openLogin', service);

            var windowArgs = this.getAuthWindowArgs(authenticator);
            var url = authenticator.url;
            url += (url.indexOf('?') > -1 ? '&' : '?') + $.param(windowArgs);

            this.openAuthWindow(
                url,
                authenticator.width,
                authenticator.height
            );
        },

        /**
         * An authentication service.
         * @typedef {Object} Authenticator
         * @property {string} url - URL of popup window to initiate authentication.
         * @property {number} width - Width of popup window.
         * @property {number} height - Height of popup window.
         * @property {Object} [params] - Additional parameters to pass to window.
         * @property {boolean} [csrf] - Whether to attach CSRF token as parameter.
         * @property {boolean} [attachExperiment] - Whether to attach experiment
         *     information as a parameter (embed-only).
         */

        authServices: {
            /** @type {Authenticator} */
            disqus: {
                url: config.urls.login,
                width: 460,
                height: 355,
                attachExperiment: true,
            },

            /** @type {Authenticator} */
            twitter: {
                url: config.urls.oauth.twitter,
                width: 650,
                height: 680,
                csrf: true,
                attachExperiment: true,
            },

            /** @type {Authenticator} */
            facebook: {
                url: config.urls.oauth.facebook,
                width: 550,
                height: 300,
                csrf: true,
                attachExperiment: true,
            },

            /** @type {Authenticator} */
            google: {
                url: config.urls.oauth.google,
                width: 445,
                height: 635,
                csrf: true,
                attachExperiment: true,
            },
        },

        /**
         * @param {Authenticator} authenticator - Authentication service.
         * @returns {string}
         */
        getAuthWindowArgs: function (authenticator) {
            var windowArgs = {};

            if (authenticator.csrf)
                windowArgs.ctkn = this.getCsrfToken();

            _.extend(windowArgs, authenticator.params);

            return windowArgs;
        },

        openAuthWindow: function (url, width, height) {
            return utils.openWindow(url, '_blank', {
                width: width,
                height: height,
            });
        },

        /**
         * Tries to determine if session user is a newly registered user and sets a
         * joinedRecently attribute on the user model accordingly.
         *
         * We assume a user is newly registered if account was created in the last 10s.
         */
        setIfNewUser: function () {
            var joinedAt = this.user.get('joinedAt');

            // set to false if user is anonymous or doesn't have a joinedAt date set
            if (this.user.get('isAnonymous') || !joinedAt) {
                this.user.set('joinedRecently', false);
                return;
            }

            var joinedAtUtc = time.assureTzOffset(joinedAt);

            // if user joined in the last 10s, set joinedRecently on user model to true
            this.user.set('joinedRecently', moment().subtract(10, 'seconds').isBefore(joinedAtUtc));
        },

    });

    /**
     * Get session attributes from the `disqusauth` cookie.
     *
     * The `disqusauth` cookie is present on disqus.com whenever
     * a user is logged in with a valid session. It is safe to
     * assume that a user without a disqusauth cookie is not logged
     * in.
     *
     * The `disqusauth` cookie conflates session info with session
     * user info.
     *
     * @returns {Object} Set of session attributes from cookie
     */
    Session.fromCookie = fromCookie;

    /**
     * Checks the disqusauth cookie to see if no authenticated session exists.
     *
     * @returns {boolean}
     */
    Session.isKnownToBeLoggedOut = function () {
        return !Session.fromCookie().id;
    };

    return Session;
});

define('core/UniqueModel',[
    'underscore',
], function (
    _
) {
    'use strict';

    // This is a factory function that enforces uniqueness of model instances.
    // It stores all instances by their ID (actual key should be specified via
    // idAttribute on a model).
    //
    // Example: Registering a unique model.
    //
    //  UniqueModel.addType("User", User);
    //
    // Example: Creating a new instance.
    //
    //  var first = new UniqueModel(User, { id: 1, name: "Anton" });
    //  var second = new UniqueModel(User, { id: 1, name: "Anton" });
    //  first === second; // true
    //
    // If an instance already exists, this function will simply update its
    // attributes.
    //
    // Example: Declaring a collection.
    //
    //  var UsersCollection = Backbone.Collection.extend({
    //      model: _.bind(UniqueModel, {}, User),
    //      ...
    //  });
    function UniqueModel(Model, attrs, options) {
        var pool = UniqueModel.pool(Model);
        var key = attrs && attrs[Model.prototype.idAttribute];

        if (!key)
            return new Model(attrs, options);

        var instance = UniqueModel.get(Model, key);
        if (instance)
            pool[key].set(attrs);
        else
            pool[key] = new Model(attrs, options);

        return pool[key];
    }

    UniqueModel.pool = {};

    UniqueModel.pool = function (Model) {
        var pool = UniqueModel.pool[Model.__type__];
        if (!pool)
            throw new Error('Model not registered. Use UniqueModel.addType');
        return pool;
    };

    UniqueModel.get = function (Model, key) {
        return UniqueModel.pool(Model)[key];
    };

    UniqueModel.set = function (Model, model) {
        var pool = UniqueModel.pool(Model);
        var key = model && model.get(Model.prototype.idAttribute);

        if (!key)
            return model;

        var instance = UniqueModel.get(Model, key);
        if (instance)
            instance.set(model.attributes);
        else
            instance = pool[key] = model;

        return instance;
    };

    UniqueModel.addType = function (name, obj) {
        if (obj.__type__ && UniqueModel.pool[name])
            return;

        obj.__type__ = name;
        UniqueModel.pool[name] = {};
    };

    UniqueModel.boundModel = function (Model) {
        var constructor = _.bind(UniqueModel, UniqueModel, Model);
        constructor.prototype = Model.prototype;
        return constructor;
    };

    UniqueModel.wrap = UniqueModel.boundModel;

    return UniqueModel;
});

define('home/utils/backboneUtils',[
    'jquery',
], function (
    $
) {
    'use strict';

    return {
        memoizedFetch: function () {
            if (this.fetchPromise)
                return this.fetchPromise;

            var self = this;
            this.fetchPromise = this.constructor.__super__.fetch.apply(this, arguments).then(function () {
                self.fetchPromise = null;
                self.fetched = true;
                return arguments;
            }, function (err) {
                self.fetchPromise = null;
                // Leave self.fetched as its current value, true if at least 1 successful fetch, undefined otherwise
                return err;
            });

            return this.fetchPromise;
        },

        getPromiseFor: function (model, attributeName) {
            var attributeValue = $.Deferred();

            // Model.has() returns true if the value is non-null/undefined. Because "", false, {}, and 0 are
            // valid values for many attributes, we should resolve the attribute here because they will
            // likely never change.
            if (model.has(attributeName)) {
                attributeValue.resolve(model.get(attributeName));
            } else {
                model.once('change:' + attributeName, function (_model, value) {
                    attributeValue.resolve(value);
                });
            }

            return attributeValue.promise();
        },
    };
});

define('home/utils/sidebarUtils',[
], function (
) {
    'use strict';

    var exports = {};

    exports.isSidebar = function () {
        try {
            // If window.self !== window.top then we're iFramed
            // and this is the home sidebar
            return window.self !== window.top;
        } catch (err) {
            // If we got an error, it was a same origin policy error,
            // which means we _are_ in an iFrame.
            return true;
        }
    };

    return exports;
});

define('home/utils/navigationUtils',[
    'jquery',
    'underscore',
    'backbone',

    'core/utils/url/serialize',

    'home/utils/sidebarUtils',
    'home/config',
], function (
    $,
    _,
    Backbone,

    serialize,

    sidebarUtils,
    config
) {
    'use strict';

    var Session;

    var leadingHashRegex = /^#/;
    var trailingSlashRegex = /\/$/;
    var outboundLinksOpenNewWindow = true;
    var routeStripper = /^[#/]|\s+$/g;

    var navigateToLogin = function () {
        $('body').html('<div class="spinner"></div>');

        var params = {
            next: 'https://disqus.com' + window.location.pathname + window.location.search,
        };

        // Lazy load Session to prevent circular dependencies
        if (!Session)
            Session = require('home/models/Session');

        var session = Session.get();
        var forum = session.forum;
        if (forum)
            params.forum = forum.shortname;

        var location = serialize('https://disqus.com/profile/login/', params);
        window.top.location = location;
    };

    var navigateToHomepage = function () {
        $('body').html('<div class="spinner"></div>');

        window.top.location = 'https://disqus.com/';
    };

    var NavigationUtils = {
        scrollPositions: {},

        // The time of the last successful call to this.navigate()
        // in ms since the Epoch
        lastNavigateTime: null,

        /**
         * Global handler for clicks on links: <a> elements with href specified
         *
         * @param {Event} evt - Click event object
         */
        handleLinkClicks: function (evt) {
            var link = evt.currentTarget;

            // If this link click will open a new window then we definitely
            // don't want to do anything here.
            if (this.shouldNotHandleLinkClick(evt, link))
                return;

            var $link = $(link);
            var href = $link.attr('href');

            // If this link starts with a # then we treat it like
            // and anchor and try to scroll to the element.
            if (leadingHashRegex.test(href) && link.hash) {
                this.scrollToElement(evt);
                return;
            }

            // Else, if we are in the sidebar or we don't have an internal
            // route for this link and this link does not point to a page that
            // is on our network such as publishers.disqus.com, we simply add a
            // `target='_blank'` attribute and let the link open in a new tab.
            if (sidebarUtils.isSidebar() || !(this.matchesRoute(link) || this.isInternalLink(link))) {
                // If the link includes `data-link-out` attribute
                // we set the value of the attribute as the href.
                var redirectLink = $link.attr('data-link-out');
                if (redirectLink) {
                    var original = $link.attr('href');
                    // Set the link back to the orignal href after .5 second
                    _.delay(function () {
                        $link.attr('href', original);
                    }, 500);
                    $link.attr('href', redirectLink);
                }

                $link.attr('target', '_blank');
                return;
            } else if (this.isInternalLink(link) && !this.matchesRoute(link)) {
                // If this a link to our own network but not on the Home app,
                // do nothing so the link can work as it is as expected.
                return;
            }

            // Finally, we have a guarantee that we know how to handle this link
            // and that we should handle this link. At this point we just need to
            // cause navigation to occur.
            evt.preventDefault();
            this.navigate(link, true);
        },

        coerceTrailingSlash: function (loc) {
            if (trailingSlashRegex.test(loc.pathname))
                return;

            this.navigate(
                decodeURI(loc.pathname + '/' + loc.search + loc.hash),
                { replace: true }
            );
        },

        getFragmentFromLink: function (link) {
            // Basically entire function copied form Backbone.History.getFragment
            // but uses `link` instead of `location`.
            var fragment = decodeURI(link.pathname + link.search);
            var root = config.appRoot.replace(trailingSlashRegex, '');
            if (!fragment.indexOf(root))
                fragment = fragment.slice(root.length);
            return fragment.replace(routeStripper, '');
        },

        /**
         * This function will return true for links to any subdomain of the
         * current application domain.
         *
         * @param  {Object} link An object with at least the properties {host}
         * @returns {boolean}
         */
        isInternalLink: function (link) {
            var appHost = window.location.host;
            return appHost === link.host ||
                link.host.indexOf(appHost) > 1;  // include subdomains
        },

        /**
         * Is this an inbound link? An inbound link is one that does not require a
         * page reload.
         * @param  {Object}  link An object with at least the properties {href, pathname, search, hash}
         * @returns {boolean}
         */
        isInbound: function (link) {
            return (
                // if href begins with hash, it must be inbound
                link.href[0] === '#' ||
                this.matchesRoute(link)
            );
        },

        /**
         * Is the given link a path that our router handles?
         *
         * We use this method instead of Backbone.history.loadUrl or
         * the return value from Backbone.history.navigate because
         * both of those methods will update the browser's URL =/
         *
         * @param  {DOMElement} link - An anchor element to test
         * @returns {boolean}
         */
        matchesRoute: function (link) {
            // If the host (domain and port) does not match, then this link
            // should not be considered a match no matter what.
            if (link.host !== window.location.host)
                return false;

            var frag = this.getFragmentFromLink(link);
            return _.any(Backbone.history.handlers, function (handler) {
                return handler.route.test(frag);
            });
        },

        shouldNotHandleLinkClick: function (event, link) {
            return (
                // an earlier handler called preventDefault() on the event
                event.isDefaultPrevented() ||
                // the link was given a target attribute
                $(link).attr('target') ||
                // a modifier key was pressed while clicking link
                this.hasModifierKey(event) ||
                // click occured within a react subview, which does not have
                // the ability to preventDefault before evt is caught here
                $(link).closest('[data-view-type=react]').length
            );
        },

        hasModifierKey: function (event) {
            return (
                event.ctrlKey ||  // For Windows and Linux
                event.metaKey || // For OS X
                event.shiftKey || // For new window
                event.altKey  // God knows what
            );
        },

        linkClickChangesPage: function (event, link) {
            // links that open in a new window do not change the page
            if ($(link).attr('target') === '_blank')
                return false;

            // links that had a modifier key pressed open in a new
            // window and so do not change the page
            if (this.hasModifierKey(event))
                return false;

            // inbound links do not change the page
            // and if the link is not inbound it must be outbound
            // and so whether or not it opens in a new page
            // and consequently does not change the page is
            // determined by outboundLinksOpenNewWindow
            return !this.isInbound(link) && !outboundLinksOpenNewWindow;
        },

        // Scroll to the target element so that it goes up
        // to the top of the page but just below the Home nav bar
        scrollToElement: function (evt) {
            if (!evt)
                return;

            var selector = $(evt.currentTarget).attr('href');
            var $el = $(selector);

            if (!$el.length)
                return;

            evt.preventDefault();

            var $header = $('header.site-nav--wrapper');
            var headerHeight = $header.height();

            $('body').scrollTop($el.offset().top - headerHeight);
        },

        /*
         * Wrapper around Backbone.history.navigate
         */
        navigate: function (fragment, options) {
            options = options || {};
            var trigger = options.trigger;
            var hash = '';
            var returnVal;

            // If fragment is actually a link
            if (fragment.pathname) {
                hash = fragment.hash;
                fragment = this.getFragmentFromLink(fragment);
            }

            // If we get here and we aren't on the /by/ profile path,
            // then rewrite the URL to be correct. (backwards compatibility)
            if (fragment.indexOf('home/user') !== -1)
                fragment = fragment.replace('home/user', 'by');

            this.storeScrollPosition();

            // lastNavigateTime needs to be updated before call to .navigate() because
            // code triggered by .navigate() may rely on it.
            // Do not record if options.replace because replacing the url is not a true
            // navigation (cannot go back).
            if (!options.replace)
                NavigationUtils.lastNavigateTime = $.now();

            returnVal = Backbone.history.navigate(fragment + hash, options);

            if (trigger)
                this.applyScrollPosition();

            return returnVal;
        },

        notFoundRouteHandler: function () {
            NavigationUtils.navigate('/', { trigger: true, replace: true });
        },

        storeScrollPosition: function () {
            this.scrollPositions[Backbone.history.getFragment()] = window.pageYOffset || window.document.documentElement.scrollTop;
        },

        applyScrollPosition: function () {
            window.scrollTo(0, this.scrollPositions[Backbone.history.getFragment()]);
        },

        /*
         * Error codes at http://disqus.com/api/docs/errors/
         * Error code 2 occurs on certain calls (ex: users/details) that could
         * take a user param, or use the current logged-in user if none given.
         * These return error code 2 with a message along the lines of
         * "must specify user or have an authenticated user".
         */
        navigateToLoginOnAuthFail: function (xhr) {
            // When aborting, it seems that responseText is undefined
            // so don't assume it'll always exist
            if (!xhr.responseText)
                return xhr;

            try {
                var response = JSON.parse(xhr.responseText);
                if (
                    window.location.pathname !== '/home/welcome' &&
                    (
                        response.code === 4 ||
                        response.code === 2 && /authenticate/.test(response.response)
                    )
                )
                    navigateToLogin();
            } catch (err) {
                // Invalid JSON is acceptable as this is an api error handler.
                // Do nothing.
            }

            return xhr;
        },

        navigateToLogin: navigateToLogin,
        navigateToHomepage: navigateToHomepage,

    };

    return NavigationUtils;
});

define('home/templates/confirmModal',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    return " modal-dialog--light";
},"3":function(container,depth0,helpers,partials,data) {
    return "<button class=\"text-smaller modal-close\" data-dismiss=\"modal\">\n<span class=\"icon-cancel\"></span>\n</button>\n";
},"5":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"modal-footer\">\n<button type=\"button\" class=\"button button-outline button-small\" data-dismiss=\"modal\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Cancel",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":15,"column":0},"end":{"line":15,"column":20}}}))
    + "\n</button>\n<button type=\"button\" class=\"button button-fill--brand button-small\" data-dismiss=\"modal\" data-action=\"confirm\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Confirm",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":18,"column":0},"end":{"line":18,"column":21}}}))
    + "\n</button>\n</div>\n";
},"7":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"modal-footer\">\n<button type=\"button\" class=\"button button-outline button-small\" data-dismiss=\"modal\">\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Close",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":25,"column":0},"end":{"line":25,"column":19}}}))
    + "\n</button>\n</div>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"modal fade\" tabindex=\"-1\" role=\"dialog\" aria-labelledby=\"mySmallModalLabel\" aria-hidden=\"true\">\n<div class=\"modal-dialog"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,lookupProperty(helpers,"eq").call(alias1,(depth0 != null ? lookupProperty(depth0,"type") : depth0),((stack1 = (depth0 != null ? lookupProperty(depth0,"types") : depth0)) != null ? lookupProperty(stack1,"CLOSE_LIGHT") : stack1),{"name":"eq","hash":{},"data":data,"loc":{"start":{"line":2,"column":30},"end":{"line":2,"column":57}}}),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":2,"column":24},"end":{"line":2,"column":86}}})) != null ? stack1 : "")
    + "\">\n<div class=\"modal-content\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,lookupProperty(helpers,"eq").call(alias1,(depth0 != null ? lookupProperty(depth0,"type") : depth0),((stack1 = (depth0 != null ? lookupProperty(depth0,"types") : depth0)) != null ? lookupProperty(stack1,"CLOSE_ICON") : stack1),{"name":"eq","hash":{},"data":data,"loc":{"start":{"line":4,"column":6},"end":{"line":4,"column":32}}}),{"name":"if","hash":{},"fn":container.program(3, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":4,"column":0},"end":{"line":8,"column":7}}})) != null ? stack1 : "")
    + "<div data-role=\"content\">\n</div>\n</div>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,lookupProperty(helpers,"eq").call(alias1,(depth0 != null ? lookupProperty(depth0,"type") : depth0),((stack1 = (depth0 != null ? lookupProperty(depth0,"types") : depth0)) != null ? lookupProperty(stack1,"CONFIRM_CANCEL") : stack1),{"name":"eq","hash":{},"data":data,"loc":{"start":{"line":12,"column":6},"end":{"line":12,"column":36}}}),{"name":"if","hash":{},"fn":container.program(5, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":12,"column":0},"end":{"line":21,"column":7}}})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,lookupProperty(helpers,"eq").call(alias1,(depth0 != null ? lookupProperty(depth0,"type") : depth0),((stack1 = (depth0 != null ? lookupProperty(depth0,"types") : depth0)) != null ? lookupProperty(stack1,"CLOSE") : stack1),{"name":"eq","hash":{},"data":data,"loc":{"start":{"line":22,"column":6},"end":{"line":22,"column":27}}}),{"name":"if","hash":{},"fn":container.program(7, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":22,"column":0},"end":{"line":28,"column":7}}})) != null ? stack1 : "")
    + "</div>\n</div>\n";
},"useData":true})

});
define('home/utils/confirmModal',[
    'jquery',

    'home/utils/navigationUtils',
    'home/templates/confirmModal',
], function (
    $,

    navigationUtils,
    confirmModalTemplate
) {
    'use strict';

    // modal types enum
    // determines which actions are shown
    var TYPES = {
        'CLOSE': 1,
        'CONFIRM_CANCEL': 2,
        'CLOSE_ICON': 3,
        'CLOSE_LIGHT': 4,
    };

    // Calculate the width of the scrollbar and add css rules that will prevent the page from
    // jumping when modal visibility is toggled
    function getScrollbarWidth() {
        var scrollDiv = $('<div>').addClass('modal-scrollbar-measure')[0];
        $('body').append(scrollDiv);

        var scrollbarWidth = scrollDiv.offsetWidth - scrollDiv.clientWidth;
        $(scrollDiv).remove();

        return scrollbarWidth;
    }


    function insertCss(code) {
        var style = $('<style>').attr('type', 'text/css')[0];

        if (style.styleSheet)  // IE
            style.styleSheet.cssText = code;
        else  // Other browsers
            style.innerHTML = code;

        $('head').append(style);
    }

    $(function () {
        var scrollbarWidth = getScrollbarWidth();

        // Modal scroll fix only applies for screens larger than mobile.
        // This is because the body styling that causes content to jump when the modal
        // is opened only applies in desktop.
        var rules = [
            '@media only screen and (min-width: 480px) {',
            'body.scroll-fix { margin-right: ' + scrollbarWidth + 'px; }',
            'body.scroll-fix .compensation { margin-right: ' + scrollbarWidth + 'px; }',
            '}',
        ].join(' ');

        insertCss(rules);
    });

    /**
     * Creates and returns the jquery wrapped modal element, ready to be inserted into
     * the page and shown.
     * Modal has default support for body styling on open and close, and removes itself
     * from the DOM on close.
     *
     * @param  {Object} options - {
     *                              modal.type (optional) - one of the modal types (ex: TYPES.CLOSE),
     *                              handlers (optional) - a mapping from bootstrap modal events to handlers
     *                            }
     *
     * @returns {JQuery} JQuery-wrapped element
     */
    function getModal(options) {
        options = options || {};
        options.modal = options.modal || {};

        var $modal = $(confirmModalTemplate({
            type: options.modal.type || TYPES.CLOSE_ICON,
            types: TYPES,
        }));

        if (options.modal.content)
            $modal.find('[data-role=content]').html(options.modal.content);

        $modal
            .on('shown.bs.modal', function () {
                $('body').addClass('scroll-fix');
            })
            .on('hidden.bs.modal', function () {
                $('body').removeClass('scroll-fix');
                $modal.remove();
            })
            .on('click', 'a[data-action=close-and-navigate]', function (evt) {
                evt.preventDefault();

                var $target = $(evt.target);
                var href = $target.attr('href');
                if (href)
                    navigationUtils.navigate(href, { trigger: true });

                $modal.modal('hide');
            });

        $('body').append($modal);

        return $modal;
    }

    /**
     * Shows a confirmation modal containing the given html, and either a
     * Close button, or a Confirm and Cancel buttons, depending on the
     * specified type.
     *
     * Returns a promise that will resolve once the modal is closed, with
     * a truthy value if confirm was clicked, or a falsy value otherwise.
     *
     * @param  {number} type - One of the enums to specify which set of
     *                         buttons to show
     * @param  {string} content - HTML to fill the confirm modal
     * @returns {Promise} - A promise resolved once the modal is closed with
     *                     a boolean indicator of whether or not confirm was
     *                     selected and a reference to the modal.
     */
    function confirmationPromise(type, content) {
        type = type || TYPES.CLOSE;

        var deferred = $.Deferred();

        var $modal = getModal({
            modal: {
                type: type,
                content: content,
            },
        });

        $modal.on('click', '[data-action=confirm]', function () {
            deferred.resolve(true, $modal);
        })
        .on('hidden.bs.modal', function () {
            deferred.resolve(false, $modal);
        });

        $modal.modal('show');

        return deferred.promise();
    }

    return {
        TYPES: TYPES,
        getModal: getModal,
        confirmationPromise: confirmationPromise,
    };
});

define('home/templates/confirmBlacklistUser',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"modal-header\">\n<h4 class=\"modal-title\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Ban %(username)s?",{"name":"gettext","hash":{"username":lookupProperty(helpers,"tag").call(alias1,"b",{"name":"tag","hash":{"text":(depth0 != null ? lookupProperty(depth0,"username") : depth0)},"data":data,"loc":{"start":{"line":2,"column":65},"end":{"line":2,"column":90}}})},"data":data,"loc":{"start":{"line":2,"column":24},"end":{"line":2,"column":92}}}))
    + "</h4>\n</div>\n<div class=\"modal-body\">\n<p>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Click Confirm to ban and remove this user's recent comments and discussions. This user will no longer be able to post comments.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":5,"column":3},"end":{"line":5,"column":144}}}))
    + "</p>\n</div>\n";
},"useData":true})

});
define('home/models/User',[
    'jquery',
    'underscore',

    'core/api',
    'core/strings',
    'core/models/User',

    'home/utils/backboneUtils',
    'home/utils/confirmModal',

    'home/templates/confirmBlacklistUser',

    'core/UniqueModel',
], function (
    $,
    _,

    api,
    strings,
    CoreUser,

    backboneUtils,
    confirmModal,

    confirmBlacklistUserTemplate,

    UniqueModel
) {
    'use strict';

    var parent = CoreUser;
    var parentProto = parent.prototype;

    var gettext = strings.get;

    var SUPPORTED_MODERATE_ENTITIES = {
        'forum': true,
        'channel': true,
    };

    var User = parent.extend({
        defaults: _.defaults({
            // Unlike numForumsFollowing, numFollowing, or numFollowers,
            // numChannelsFollowing is not returned from users/details,
            // but derived from users/listFollowingChannels endpoint
            // (hence why default is not declared on the BaseUser class)
            numChannelsFollowing: null,
        }, parentProto.defaults),

        idAttribute: 'username',

        initialize: function (attributes, options) {
            parentProto.initialize.call(this, attributes, options);

            var Session = require('home/models/Session');
            this.session = Session.get();

            this.listenTo(this, 'followed:user', this.handleFollowedUser);
            this.listenTo(this, 'unfollowed:user', this.handleUnfollowedUser);
            this.listenTo(this, 'followed:forum', this.handleFollowedForum);
            this.listenTo(this, 'unfollowed:forum', this.handleUnfollowedForum);
            this.listenTo(this, 'followed:channel', this.handleFollowedChannel);
            this.listenTo(this, 'unfollowed:channel', this.handleUnfollowedChannel);
        },

        /*
         * Returns true if it looks like this user has not been fully
         * filled with data yet. Use this when showing a full profile
         * for a user.
         * @returns {boolean}
         */
        shouldFetch: function () {
            return !this.get('name') ||
                !this.has('numFollowers') ||
                !this.has('numFollowing') ||
                !this.has('numForumsFollowing');
        },

        /*
         * Returns true if it looks like this user does not have the
         * basic data fetched yet. Will not check for special aggregate
         * values used in showing a user's profile. Use this when showing
         * a user card.
         * @returns {boolean}
         */
        shouldFetchBasics: function () {
            return !this.get('name');
        },

        ensureFetchedBasics: function () {
            if (this.shouldFetchBasics()) {
                this.fetch();
            }
            return this.fetchPromise || $.Deferred().resolve().promise();
        },

        // TODO: override this.isSession--
        //      parentProto.isSession.call(this, this.session);
        isSessionUser: function () {
            return this.isSession(this.session);
        },

        // DisqusNetMod is a subset of Disqus Admins that can see
        // moderation tools within home
        isGlobalAdmin: function () {
            return this.session.user.get('isGlobalAdmin');
        },

        // Copies logic from disqus-web for friendly labels for user reputation
        // Only visible for DisqusNetMods
        getUserReputationLabel: function () {
            var rep = this.get('rep');

            if (rep < 0.25) {
                return 'Low 1';
            } else if (rep < 0.8) {
                return 'Low 2';
            } else if (rep < 2.9) {
                return 'Average';
            }
            return 'High';
        },

        prepareFetchOptions: function (options) {
            options = options ? _.clone(options) : {};
            options.data = _.extend({ attach: 'userFlaggedUser' }, options.data);
            return parentProto.prepareFetchOptions.call(this, options);
        },

        fetch: function (options) {
            options = this.prepareFetchOptions(options);
            return backboneUtils.memoizedFetch.call(this, options);
        },

        getNumTotalFollowing: function () {
            return this.get('numFollowing') +
                this.getNumCommunitiesFollowing();
        },

        getNumCommunitiesFollowing: function () {
            return this.get('numForumsFollowing') + this.get('numChannelsFollowing');
        },

        getNumBadges: function () {
            return this.get('badges') && this.get('badges').length;
        },

        toggleFollowed: function () {
            return this.get('isFollowing') ?
                this.unfollow() :
                this.follow();
        },

        /*
         * Allows the session user to follow this user
         */
        follow: function () {
            this.session.user.trigger('followed:user', this);
            return parentProto.follow.call(this);
        },

        /*
         * Allows the session user to unfollow this user
         */
        unfollow: function () {
            this.session.user.trigger('unfollowed:user', this);
            return parentProto.unfollow.call(this);
        },

        /*
         * Performs the necessary api call to break the "other user
         * follows this user" relationship.
         * @param  {Model} user The user following this user
         * @returns {Promise}      The jQuery ajax request promise
         */
        removeFollower: function (user) {
            // Only works for the currently authenticated user.
            if (!this.isSessionUser()) {
                return;
            }
            var numFollowers = this.get('numFollowers') - 1;
            this.set('numFollowers', Math.max(0, numFollowers));

            return api.call('users/removeFollower', {
                type: 'POST',
                data: {
                    follower: user.get('id'),
                },
            });
        },

        /**
         * Updates the necessary user data when this user has
         * followed another user
         */
        handleFollowedUser: function () {
            this.set({
                numFollowing: this.get('numFollowing') + 1,
            });
        },

        /**
         * Updates the necessary user data when this user has
         * unfollowed another user
         */
        handleUnfollowedUser: function () {
            this.set({
                numFollowing: Math.max(0, this.get('numFollowing') - 1),
            });
        },

        /**
         * Updates the necessary user data when this user has
         * followed a forum
         */
        handleFollowedForum: function () {
            this.set({
                numForumsFollowing: this.get('numForumsFollowing') + 1,
            });
        },

        /**
         * Updates the necessary user data when this user has
         * unfollowed a forum
         */
        handleUnfollowedForum: function () {
            this.set({
                numForumsFollowing: Math.max(0, this.get('numForumsFollowing') - 1),
            });
        },

        handleFollowedChannel: function () {
            this.set({
                numChannelsFollowing: this.get('numChannelsFollowing') + 1,
            });
        },

        handleUnfollowedChannel: function () {
            this.set({
                numChannelsFollowing: Math.max(0, this.get('numChannelsFollowing') - 1),
            });
        },

        /**
         * Add or remove the user as a moderator of a supported entity
         *
         * @param {Object} opts - Options supplied to moderating an entity
         * @param {Object} opts.entity - The model used to handle the toggle trigger
         * @param {string} opts.type - Type of entity
         * @param {string} opts.endpoint - Moderation endpoint for model
         * @param {string} opts.forumId - Id of the forum this model belongs to
         * @param {boolean} opts.shouldModerate - Id of the forum this model belongs to
         *
         * @returns {Promise} The promise object for the moderation API call
         */
        moderate: function (opts) {
            if (!SUPPORTED_MODERATE_ENTITIES[opts.type]) {
                return;
            }
            var action = opts.shouldModerate ? 'addModerator' : 'removeModerator';
            var url = opts.endpoint + '/' + action;
            var data = { user: 'username:' + this.get('username') };
            data[opts.type] = opts.entity.id;

            return $.when(
                // Ensure user basics have been fetched before triggering the
                // add/remove event. When triggering remove this won't kick
                // off a fetch since by the time we call remove we have basic
                // user details. When triggering add, want to ensure we have
                // user's name and avatar fetched so handlers of the addModerator
                // event will get a ready-to-display user.
                this.ensureFetchedBasics(),

                // Don't need to wait for user fetch to return to call add/remove
                // as all that's needed is the username.
                api.call(url, { method: 'POST', data: data })
            ).done(_.bind(function () {
                // Add/remove channel's primary forum to/from the list of forums this user moderates
                var moderatedForums = this.get('moderatedForums') || [];
                if (opts.shouldModerate) {
                    moderatedForums.push(opts.forumId);
                } else {
                    moderatedForums = _.reject(moderatedForums, function (moderatedForumId) {
                        return moderatedForumId === opts.forumId;
                    });
                }

                this.set('moderatedForums', moderatedForums);

                // Let channel handle the addition/removal of a moderator
                opts.entity.trigger(action, this);
            }, this));
        },

        moderateForum: function (forum, shouldModerate) {
            return this.moderate({
                entity: forum,
                type: 'forum',
                endpoint: 'forums',
                forumId: forum.id,
                shouldModerate: shouldModerate,
            });
        },

        moderateChannel: function (channel, shouldModerate) {
            return this.moderate({
                entity: channel,
                type: 'channel',
                endpoint: 'channels',
                forumId: channel.primaryForum.id,
                shouldModerate: shouldModerate,
            });
        },


        /*
         * Blacklists a user globally or by forum and removes most recent comments/threads
         */
        confirmBlacklist: function (options) {
            confirmModal.confirmationPromise(confirmModal.TYPES.CONFIRM_CANCEL,
                confirmBlacklistUserTemplate(this.toJSON()))
                .then(_.bind(function (isConfirmed) {
                    if (!isConfirmed) {
                        return;
                    }
                    this.addToBlacklist(options);
                }, this));
        },

        addToBlacklist: function (options) {
            options = options || {};
            var data = _.extend({}, options, {
                user: this.get('id'),
                retroactive: options && options.retroactive ? 1 : 0,
            });
            var url = data.forum ? 'blacklists/add.json' : 'blacklists/global/add.json';
            api.call(url, { method: 'POST', data: data })
                .done(_.bind(function (response) {
                    if (!response) {
                        return;
                    }
                    if (data.forum) {
                        this.trigger('blacklist:add', data.forum);
                    } else {
                        this.set('isOnGlobalBlacklist', true);
                    }
                    window.alert(gettext('User was added to the ban list')); // eslint-disable-line no-alert
                }, this))
                .error(function (response) {
                    // TODO provide a localized error because the server response will
                    // only be in English.
                    if (response && response.responseJSON) {
                        window.alert(response.responseJSON.response); // eslint-disable-line no-alert
                    }
                });
        },

        removeFromBlacklist: function (options) {
            options = options || {};
            var data = _.extend({}, options, { user: this.get('id') });
            var url = data.forum ? 'blacklists/remove.json' : 'blacklists/global/remove.json';
            api.call(url, { method: 'POST', data: data })
                .done(_.bind(function (response) {
                    if (!response) {
                        return;
                    }
                    if (data.forum) {
                        this.trigger('blacklist:remove', data.forum);
                    } else {
                        this.set('isOnGlobalBlacklist', false);
                    }
                    window.alert(gettext('User was removed from the ban list')); // eslint-disable-line no-alert
                }, this))
                .error(function (response) {
                    // TODO provide a localized error because the server response will
                    // only be in English.
                    if (response && response.responseJSON) {
                        window.alert(response.responseJSON.response); // eslint-disable-line no-alert
                    }
                });
        },

        requestSpamReview: function () {
            if (this.get('flaggedForSpamReview')) {
                return;
            }
            api.call('internal/users/requestSpamReview', { method: 'POST' })
                .done(_.bind(function () {
                    this.set('flaggedForSpamReview', true);
                }, this));
        },

        getDisplayName: function (attributes) {
            attributes = attributes || this.attributes;
            return attributes.name || attributes.username || 'Guest';
        },

        toJSON: function () {
            var result = parentProto.toJSON.apply(this, arguments);

            result.displayName = this.getDisplayName(result);

            return result;
        },
    });

    UniqueModel.addType('User', User);

    return User;
});

define('core/collections/PaginatedCollection',[
    'underscore',
    'backbone',
], function (
    _,
    Backbone
) {
    'use strict';

    /**
     * Augmented Backbone collection class that automatically records
     * and submits  the current cursor position when making fetches.
     *
     * See: the #more function, which paginates on the current cursor
     */
    var PaginatedCollection = Backbone.Collection.extend({

        PER_PAGE: 30, // Better backend performance to make less requests with higher limits

        initialize: function (_model, opts) {
            this.cid = _.uniqueId('collection');
            opts = opts || {};
            this.cursor = opts.cursor || {};
        },

        ensureFetched: _.memoize(function () {
            return this.fetch();
        }, function () {
            return this.cid;
        }),

        fetch: function (options) {
            options = options || {};
            options.data = _.defaults(options.data || {}, {
                cursor: options.cursor || '',
                limit: options.limit || this.PER_PAGE,
            });

            return Backbone.Collection.prototype.fetch.call(this, options);
        },

        hasPrev: function () {
            return this.cursor.hasPrev;
        },

        hasNext: function () {
            return this.cursor.hasNext;
        },

        next: function (options) {
            if (!this.cursor.hasNext)
                return void this.trigger('nodata');

            return this.fetch(_.extend({}, options, {
                add: true,
                remove: true,
                cursor: this.cursor.next,
            }));
        },

        prev: function (options) {
            if (!this.cursor.hasPrev)
                return void this.trigger('nodata');

            return this.fetch(_.extend({}, options, {
                add: true,
                remove: true,
                cursor: this.cursor.prev,
            }));
        },

        more: function (options) {
            var self = this;
            options = options || {};

            if (options.post ? !options.post.attributes.hasMore : !this.cursor.hasNext)
                return void self.trigger('nodata');

            // Accumulate models added to the collection, then fire a single
            // event that passes all added models.
            var added = [];
            function accum(model) {
                added.push(model);
            }

            var cursor;
            if (options.post) { // Was called in context of SubpaginatedPostCollection
                var postCursor = this.postCursors[options.post.id];
                cursor = postCursor && postCursor.cursor ? postCursor.cursor.next : '';
            } else {
                cursor = this.cursor.next;
            }

            this.on('add', accum);
            return this.fetch(_.extend({}, options, {
                add: true,
                remove: false,
                cursor: cursor,
                limit: this.PER_PAGE || this.perPage, // Two collections use this. One has PER_PAGE, the other perPage
                success: function () {
                    self.trigger('add:many', added, self, options);
                    self.off('add', accum);

                    if (options.success)
                        options.success.apply(this, arguments);
                },
            }));
        },

        parse: function (response) {
            // If `response` is an array of models, then we've already parsed the response, so do nothing.
            if (Array.isArray(response) && _.every(response, function (post) {
                return post instanceof Backbone.Model;
            }))
                return response;

            this.cursor = response.cursor || { hasNext: false };

            return response.response;
        },

        getLength: function () {
            return this.length;
        },
    });

    return PaginatedCollection;
});

define('core/models/Forum',[
    'backbone',

    'core/UniqueModel',
    'core/api',
], function (
    Backbone,

    UniqueModel,
    api
) {
    'use strict';

    var Forum = Backbone.Model.extend({
        defaults: {
            settings: {},
            badges: [],
            followUrl: 'forums/follow',
            unfollowUrl: 'forums/unfollow',
            isFollowing: false,
        },

        initialize: function (_attributes, options) {
            if (options && options.channel) {
                this.channel = options.channel;
            }
            this.getFeatures();
            this.on('change:id', this.getFeatures);
            this.on('change:id', this.getBadges);
        },

        _changeFollowingState: function (path) {
            return api.call(path, {
                method: 'POST',
                data: {
                    target: this.get('id'),
                },
            });
        },

        follow: function () {
            this.set('isFollowing', true);

            return this._changeFollowingState(this.get('followUrl'));
        },

        unfollow: function () {
            this.set('isFollowing', false);

            return this._changeFollowingState(this.get('unfollowUrl'));
        },

        toggleFollowed: function () {
            if (this.channel && this.channel.get('options').isCurationOnlyChannel) {
                return this.channel.toggleFollowed();
            }
            var retval = this.get('isFollowing') ?
                this.unfollow() :
                this.follow();

            this.trigger('toggled:isFollowing');

            return retval;
        },

        // This api call lets us see what features are enabled for a forum. There are
        // a couple of features that require us to check if the feature is enabled
        // at an org level in addition to (or instead of) at the forum level.
        //
        // It checks to make sure that we have a forum id, which all forums should have.
        // The only time we don't have a forum id should be when initializing
        // the forum in the embed. We don't need to worry about the forum changing
        // because when that happens the embed has to have reloaded as well.
        getFeatures: function () {
            var self = this;
            if (self.id) {
                api.call('forums/details', {
                    data: {
                        forum: this.id,
                        attach: 'forumFeatures',
                    },
                    success: function (response) {
                        if (response && response.response) {
                            self.set('features', response.response.features);
                        }
                    },
                });
            }
        },

        // Convert the forum badges array into an object that is indexed by
        // badge.id to improve lookup efficiency
        getBadges: function () {
            if (this.id && this.get('badges')) {
                var badges = {};
                var badgeForum = {};
                // Add additional forum data to match the users/details badges format
                badgeForum.id = this.get('pk');
                badgeForum.url = this.get('id');
                this.get('badges').forEach(function (badge) {
                    badge.forum = badgeForum;
                    badges[badge.id] = badge;
                });
                this.set('badges', badges);
            }
        },
    });

    UniqueModel.addType('Forum', Forum);

    return Forum;
});

define('home/models/Forum',[
    'jquery',
    'underscore',
    'backbone',
    'require',

    'core/utils/html',
    'core/models/Forum',

    'core/api',
    'core/utils',
], function (
    $,
    _,
    Backbone,
    require,

    html,
    CoreForum,

    api,
    utils
) {
    'use strict';

    var Forum = CoreForum.extend({
        // Removes protocol, trailing slash to make a user-friendly
        // displayable url that goes to this forum's website
        getFriendlyUrl: function () {
            var friendlyUrl = utils.getDomain(this.get('url'));
            return friendlyUrl.indexOf('disqus.com') > -1 ? 'disqus.com' : friendlyUrl;
        },

        initialize: function (attrs, options) {
            if (!this.get('id'))
                throw new Error('Forum must be initialized with an id');

            CoreForum.prototype.initialize.call(this, attrs, options);

            this.fetch = _.memoize(_.bind(this.fetch, this));

            this.buildChannel(options);
            this.listenTo(this, 'change:channel', this.updateChannel);

            // Event specifically for when a user action cause the isFollowing attr to
            // toggle its value. Cannot use change:isFollowing because it is triggered
            // on sync events.
            this.listenTo(this, 'toggled:isFollowing', this.handleFollowingToggled);
        },

        /*
         * Initialize the related Channel model, if given channel details,
         * either in the given options, or in this Forum's attributes
         */
        buildChannel: function (options) {
            if (this.channel)
                return;

            var channel = options && options.channel || this.get('channel');
            if (!channel)
                return;

            // Prefer to pass primaryForum as an attribute, rather than an option,
            // because if the Channel model already exists, UniqueModel will only
            // update its attributes and will ignore the given options.
            if ($.isPlainObject(channel)) {
                channel.primaryForum = this;
            } else {
                // channel may be just an id, so pass primaryForum as an option
                options = _.defaults({
                    primaryForum: this,
                }, options);
            }

            var Channel = require('home/models/Channel');
            this.initializeRelated('channel',
                options,
                Channel);
        },

        /*
         * Handle getting Channel details in this Forum's attributes.
         * If necessary, initialize a new Channel or update an existing one.
         */
        updateChannel: function () {
            var channelAttrs = this.get('channel');
            this.unset('channel');

            if (!channelAttrs)
                return;

            if (!this.channel)
                this.buildChannel({ channel: channelAttrs });
            else if (this.channel.shouldFetch() && _.isObject(channelAttrs))
                this.channel.set(channelAttrs);
        },

        url: function () {
            return api.getURL('forums/details?forum=' + this.get('id'));
        },

        parse: function (response) {
            return response.response || response;
        },

        /*
         * Returns true if it looks like this forum has not been filled
         * with data yet.
         * @returns {boolean}
         */
        shouldFetch: function () {
            return !this.get('name');
        },

        shouldFetchWithAttachments: function (attachments) {
            return this.shouldFetch() || _.some(attachments, function (attachmentName) {
                return !this.has(attachmentName);
            }, this);
        },

        fetchWithAttachments: function (attachments) {
            this.fetch({
                data: {
                    attach: attachments,
                },
            });
        },

        hasFavicon: function () {
            var favicon = this.getFavicon();
            return favicon && !favicon.match(/favicon-default\.png/);
        },

        getFavicon: function () {
            var forumFavicon = (this.get('favicon') || {}).cache;
            return this.channel && this.channel.get('options').favicon || forumFavicon;
        },

        hasGuidelines: function () {
            // Empty guidelines are returned as empty <p> tags. Check text length
            // to determine if there are guidelines to show.
            return Boolean($(this.get('guidelines')).text().length);
        },

        /*
         * Handles updating counts and triggering events when a user
         * follows/unfollows this forum (or related channel).
         *
         * IMPORTANT: Should only be called when a user action resulted in
         * the following state changing, not when the following state is set
         * via a sync.
         */
        handleFollowingToggled: function () {
            var eventName, followersDelta;
            if (this.get('isFollowing')) {
                eventName = 'followed';
                followersDelta = 1;
            } else {
                eventName = 'unfollowed';
                followersDelta = -1;
            }

            var Session = require('home/models/Session');
            var sessionUser = Session.get().user;

            sessionUser.trigger(eventName + ':forum', this);

            if (this.has('numFollowers'))
                this.set('numFollowers', this.get('numFollowers') + followersDelta);
        },

        toJSON: function () {
            var existing = Backbone.Model.prototype.toJSON.apply(this, arguments);
            var data = _.defaults({
                forumRoute: this.getForumRoute(),
                faviconImage: this.getFavicon(),
            }, existing);

            // Include a subset of Channel information because we will otherwise
            // cause a circular dependency loop by including the full Channel JSON
            if (this.channel)
                data.channelInfo = _.pick(this.channel.attributes, ['name', 'slug', 'options']);

            return data;
        },

        getPlainDescription: function () {
            var description = this.get('description');
            if (!description)
                return;

            return html.stripTags(description);
        },

        getForumRoute: function () {
            var route = this.channel ? [
                'channel',
                this.channel.id,
            ] : [
                'forum',
                this.id,
            ];

            return route.join('/');
        },
    });

    return Forum;
});

define('home/models/Badge',[
    'underscore',
    'backbone',

    'core/strings',
    'core/UniqueModel',

    'home/models/Forum',
], function (
    _,
    Backbone,

    strings,
    UniqueModel,

    Forum
) {
    'use strict';

    var gettext = strings.get;

    var Badge = Backbone.Model.extend({
        defaults: {
            image: null,
            name: null,
            criteria: null,
            target: 0,
        },

        initialize: function () {
            if (this.get('forum')) {
                var badgeForum = this.get('forum');
                // Handle the differences in frontend/backend naming schemes
                badgeForum.pk = badgeForum.id;
                badgeForum.id = badgeForum.url;
                this.initializeRelated('forum', badgeForum, Forum);
            }
        },

        getCriteriaText: function () {
            var badgeTarget = this.get('target');
            switch (this.get('criteria')) {
            case 'MANUAL':
                return gettext('Manually awarded');
            case 'COMMENTS':
                return strings.interpolate(gettext('%(target)s Comments'), { target: badgeTarget });
            case 'FEATURED_COMMENTS':
                return strings.interpolate(gettext('%(target)s Featured comments'), { target: badgeTarget });
            case 'COMMENT_UPVOTES':
                return strings.interpolate(gettext('%(target)s Upvotes on a comment'), { target: badgeTarget });
            default:
                return null;
            }
        },
    });

    UniqueModel.addType('Badge', Badge);

    return Badge;
});

define('home/collections/BadgeCollection',[
    'core/collections/PaginatedCollection',
    'core/UniqueModel',

    'home/models/Badge',
], function (
    PaginatedCollection,
    UniqueModel,

    Badge
) {
    'use strict';

    var BadgeCollection = PaginatedCollection.extend({
        model: UniqueModel.boundModel(Badge),
    });

    return BadgeCollection;
});

define('home/collections/PaginatedUserCollection',[
    'core/collections/PaginatedCollection',
    'core/UniqueModel',

    'home/models/User',
], function (
    PaginatedCollection,
    UniqueModel,

    User
) {
    'use strict';

    var PaginatedUserCollection = PaginatedCollection.extend({
        model: UniqueModel.boundModel(User),

        initialize: function (_models, options) {
            if (options && options.url)
                this.url = options.url;
        },
    });

    return PaginatedUserCollection;
});

define('home/collections/common/ExtensibleCollection',[
    'jquery',
    'underscore',
    'backbone',

    'core/collections/PaginatedCollection',
], function (
    $,
    _,
    Backbone,

    PaginatedCollection
) {
    'use strict';

    /**
     * A collection that supplements the thread portion of its contents
     * with additional data from embedly.
     */
    var ExtensibleCollection = PaginatedCollection.extend({
        // Override the default value, 30 since activity endpoints are slow
        PER_PAGE: 10,

        initialize: function () {
            PaginatedCollection.prototype.initialize.call(this, arguments);

            this.once('sync', this.extendData, this);
            this.on('add:many', this.extendData, this);
            this.on('nodata', this.onNoData, this);
        },

        /**
         * Called when an extensible collection is first fetched, when a set of models
         * are added to an extensible colleciton, or when a model in an extensible
         * collection has been fetched.
         * Because of these different triggers, data may be a collection, an array
         * of models, or a single model.
         */
        extendData: function (data) {
            var models;
            if (data.models) {
                models = data.models;
            } else if (data instanceof Backbone.Model) {
                models = [data];

                // This case occurs when a single model in this collection is fetched.
                // Need to rebind the sync listener for future fetches.
                this.once('sync', this.extendData, this);
            } else {
                models = data;
            }

            if (!models.length) {
                // Thought there was more items available but they were
                // probably filtered before being returned.
                this.cursor.hasNext = false;
                this.trigger('nodata');
                return;
            }

            // track amount of data we received
            /* TODO: check if thread is already subsidize, now that we're using unique models,
             * a lot of threads are duplicates */
            var from = 0;
            this.extensionRequestsCount = 0;
            do {
                var to = Math.min(from + 10, models.length);
                var subset = models.slice(from, to);

                this.requestExData(subset);
                from += 10;
                this.extensionRequestsCount += 1;
            } while (from <= models.length - 1);
        },

        getThreadFromModel: function (model) {
            if (!model.getThread)
                throw new Error('Any model that is in an ExtensibleCollection must define function getThread');

            return model.getThread();
        },

        // Subsidizes existing feed item models with data from embedly.
        // This typically includes an image and a snippet from the thread
        // stored in the feed item, to be used as the thread preview.
        requestExData: function (models, attempts) {
            attempts = attempts || 0;

            var modelsByUrl = {};
            _.each(models, function (model) {
                var thread = this.getThreadFromModel(model);
                var links = thread && thread.getLinks() || [];

                // If thread contains multiple links, don't choose any of them
                var url = links.length === 1 ? links[0] : null;

                if (!this.shouldExtend(thread, url)) {
                    if (thread)
                        thread.set({ extending: false });
                    return;
                }

                thread.set({ extending: true });
                modelsByUrl[url] = model;
            }, this);

            var urls = _.keys(modelsByUrl);
            // Bail out if no threads or urls to extend
            if (!urls.length)
                return;

            var params = {
                url: urls,
                words: 200,
                image_width: 320,
            };

            $.ajax({
                url: ExtensibleCollection.EXTRACT_URL,
                data: params,
                traditional: true,
                dataType: 'jsonp',
                success: function (response) {
                    models.timeouts = 0;
                    this.onExtendData(response, modelsByUrl);
                },
                error: function (response) {
                    this.extendDataFailed(response, models, attempts);
                },
                context: this,
                timeout: 3000,
                complete: this.checkExtendDataComplete,
            });
        },

        shouldExtend: function (thread, url) {
            // Don't bother hitting embedly for urls in rich media. They'll be
            // fetched when the media is rendered.
            return thread && url && !_.any(thread.getMedia(), function (media) {
                return media.url === url;
            });
        },

        onExtendData: function (response, modelsByUrl) {
            this.extensionRequestsCount -= 1;
            _.each(response, function (item) {
                // IE sometimes gets an `undefined` or `null` `item` here
                // so first check that and then try to get the model
                var model = item && modelsByUrl[item.original_url];
                if (!model)
                    return;

                var thread = this.getThreadFromModel(model);

                thread.setEmbedlyData(item);
                thread.set({ extending: false });
            }, this);
        },

        extendDataFailed: function (response, models, attempts) {
            // Try request 3 times if timeout
            if (response.statusText === 'timeout' && attempts < 3) {
                this.handleTimeout(models, attempts);
                return;
            }

            _.each(models, function (model) {
                var thread = this.getThreadFromModel(model);
                thread.set({ extending: false });
            }, this);
            this.extensionRequestsCount -= 1;
        },

        handleTimeout: function (models, attempts) {
            this.requestExData(models, attempts + 1);
        },

        checkExtendDataComplete: function () {
            if (this.extensionRequestsCount)  // wait for more responses
                return;

            this.finalizeExtendingData(this.cursor.hasNext);
        },

        finalizeExtendingData: function (hasNext) {
            this.trigger('extend', hasNext);
        },

        onNoData: function () {
            this.finalizeExtendingData();
        },
    }, {
        EXTRACT_URL: '//extract.services.disqus.com',
    });

    return ExtensibleCollection;
});

define('core/advice',[
    'underscore',
], function (_) {
    'use strict';

    // fn is a supporting object that implements around, before and after
    var fn = {
        around: function (base, wrapped) {
            return function () {
                var args = _.toArray(arguments);
                return wrapped.apply(this, [_.bind(base, this)].concat(args));
            };
        },
        before: function (base, before) {
            return fn.around(base, function () {
                var args = _.toArray(arguments);
                var orig = args.shift();

                before.apply(this, args);
                return orig.apply(this, args);
            });
        },
        after: function (base, after) {
            return fn.around(base, function () {
                var args = _.toArray(arguments);
                var orig = args.shift();
                var res = orig.apply(this, args);

                after.apply(this, args);
                return res;
            });
        },
    };

    // FlightJS advice-style mixins
    // https://gist.github.com/angus-c/2864853

    // mixin augments target object with around, before and after methods
    // method is the base method, advice is the augmenting function

    function withAdvice() {
        _.each(['before', 'after', 'around'], function (originalMethod) {
            this[originalMethod] = function (method, advice) {
                if (typeof this[method] === 'function')
                    this[method] = fn[originalMethod](this[method], advice);
                else
                    this[method] = advice;

                return this[method];
            };
        }, this);
    }

    return {
        withAdvice: withAdvice,
    };
});

define('core/models/mixins',[
    'underscore',
    'moment',

    'core/time',
], function (
    _,
    moment,

    time
) {
    'use strict';

    function withCreatedAt() {
        // Changes moment's relative time format
        // We want the future text to be custom
        moment.locale('en', {
            relativeTime: {
                future: '%s from now',
                past: '%s ago',
                s: 'a few seconds',
                ss: '%d seconds',
                m: 'a minute',
                mm: '%d minutes',
                h: 'an hour',
                hh: '%d hours',
                d: 'a day',
                dd: '%d days',
                M: 'a month',
                MM: '%d months',
                y: 'a year',
                yy: '%d years',
            },
        });

        /**
         * Gets the moment for a post attribute. Defaults to getting createdAt if no attribute is given.
         *
         * @param {string} [attr] - the post attribute to get the moment of
         * @returns {Object} - the moment for the post attribute
         */
        this._getCreatedMoment = _.memoize(function _getCreatedMoment(attr) {
            var datetime = this.get(attr || 'createdAt');

            if (!datetime)
                return;

            return moment(time.assureTzOffset(datetime),
                time.ISO_8601);
        }, function (attr) { return this.get(attr || 'createdAt'); });

        /**
         * Gets the relative time for a post attribute. Defaults to getting createdAt if no attribute is given.
         * Can't memoize this since it relies on the changing value of "now"
         *
         * @param {string} [attr] - the post attribute to get the relative time of
         * @returns {Object} - the moment for the post attribute's relative time
         */
        this.getRelativeCreatedAt = function (attr) {
            var datetime = this._getCreatedMoment(attr);
            // Using .from(+new Date()) instead of .fromNow since it is about
            // 2x faster. `moment()` is kind of expensive.
            return datetime && datetime.from(Number(new Date()));
        };

        /**
         * Gets the formatted time for a post attribute. Defaults to getting createdAt if no attribute is given.
         *
         * @param {string} [attr] - the post attribute to get the formatted time of
         * @returns {Object} - the moment for the post attribute's formatted time
         */
        this.getFormattedCreatedAt = _.memoize(function getFormattedCreatedAt(attr) {
            var datetime = this._getCreatedMoment(attr);
            return datetime && datetime.format('LLLL');
        }, function (attr) { return this.get(attr || 'createdAt'); });
    }

    return {
        withCreatedAt: withCreatedAt,
    };
});

define('core/collections/UserCollection',[
    'jquery',
    'backbone',

    'core/models/User',
], function (
    $,
    Backbone,

    User
) {
    'use strict';

    var UserCollection = Backbone.Collection.extend({
        model: User,

        initialize: function (_models, options) {
            Backbone.Collection.prototype.initialize.apply(this, arguments);

            this.thread = options && options.thread;
        },

        // this is a client-only collection so return an already resolved promise
        fetch: function () {
            return $.when(true);
        },
    });

    return UserCollection;
});

define('core/collections/VotersUserCollection',[
    'underscore',
    'backbone',

    'core/api',
    'core/collections/UserCollection',
], function (
    _,
    Backbone,

    api,
    UserCollection
) {
    'use strict';

    var VotersUserCollection = UserCollection.extend({
        LIMIT: 50,

        // NOTE: Intentionally using a function here because `api`
        //       has its base URL configured at run-time, and may not
        //       be configured by the time VotersUserCollection
        //       is declared.

        url: function () {
            return api.getURL('posts/listUsersVotedPost');
        },

        initialize: function (_models, options) {
            this.postId = options.postId;
            this.threadId = options.threadId;
        },

        fetch: function (options) {
            return Backbone.Collection.prototype.fetch.call(this, _.extend({
                data: {
                    post: this.postId,
                    thread: this.threadId,
                    vote: options.vote,
                    limit: this.LIMIT,
                },
            }, options));
        },
    });

    return VotersUserCollection;
});

define('core/models/Vote',[
    'backbone',
], function (Backbone) {
    'use strict';

    var Vote = Backbone.Model.extend({
        defaults: {
            score: 0,
        },
    });

    return Vote;
});

define('core/collections/VoteCollection',[
    'backbone',

    'core/models/Vote',
], function (
    Backbone,

    Vote
) {
    'use strict';

    var VoteCollection = Backbone.Collection.extend({
        model: Vote,
    });

    return VoteCollection;
});

define('core/models/Post',[
    'jquery',
    'underscore',
    'backbone',
    'moment',

    'core/config/urls',

    'core/api',
    'core/strings',
    'core/time',
    'core/utils',
    'core/utils/html',
    'core/advice',
    'remote/config',

    'core/models/mixins',

    'core/collections/VotersUserCollection',
    'core/collections/VoteCollection',
], function (
    $,
    _,
    Backbone,
    moment,

    urls,

    api,
    strings,
    time,
    utils,
    htmlUtils,
    advice,
    config,

    modelMixins,

    VotersUserCollection,
    VoteCollection
) {
    'use strict';

    var VOTE_RATE_LIMIT = 1000; // 1s rate limit on voting
    var LAST_VOTE = 0;

    var acquireVoteLock = function () {
        var now = $.now();
        if (now - LAST_VOTE < VOTE_RATE_LIMIT) {
            return false;
        }
        LAST_VOTE = now;
        return true;
    };

    var gettext = strings.get;

    var Post = Backbone.Model.extend({
        votersCollectionClass: VotersUserCollection,

        defaults: function () {
            return {
                createdAt: moment().format(time.ISO_8601),
                editableUntil: moment().add(config.max_post_edit_days, 'days').format(time.ISO_8601),
                dislikes: 0,
                isApproved: true, // Assume approved
                isDeleted: false,
                isEdited: false,
                isFlagged: false,
                isFlaggedByUser: false,
                isHighlighted: false,
                isRealtime: false,
                isImmediateReply: false,
                isMinimized: null,
                hasMedia: false,
                message: null,
                raw_message: null,
                likes: 0,
                media: [],
                parent: null,
                points: 0,
                depth: 0,
                userScore: 0,
                rating: null,
            };
        },

        initialize: function () {
            this.votes = new VoteCollection();
        },

        messageText: function () {
            var msg = this.get('message');
            return msg && htmlUtils.stripTags(msg);
        },

        permalink: function (thread, useCurrentPage) {
            var id = this.id;
            if (!(id && thread)) {
                return '';
            }
            // Favor currentUrl if useCurrentPage is not false and always fallback to permalink
            var baseUrl = useCurrentPage !== false &&  // default to true
                          thread.currentUrl || thread.permalink();
            var urlTool = window.document.createElement('a');
            urlTool.href = baseUrl;
            urlTool.hash = '#comment-' + id;

            return urlTool.href;
        },

        shortLink: function () {
            return urls.shortener + '/p/' + Number(this.id).toString(36);
        },

        twitterText: function (permalink) {
            var charsRemaining = 140;

            var author = this.author.get('name') || this.author.get('username');
            charsRemaining -= author.length + 3;  // +3 for space dash space before author
            charsRemaining -= permalink.length + 1;  // +1 for space before url
            charsRemaining -= 2;  // For the quotation marks

            var text = utils.niceTruncate(this.messageText(), charsRemaining);

            return '"' + text + '" \u2014 ' + author;
        },

        toJSON: function (options) {
            var json = Backbone.Model.prototype.toJSON.call(this);
            if (options) {
                var session = options.session;
                var thread = options.thread;

                json.canBeEdited = this.canBeEdited(session, thread);
                json.canBeRepliedTo = this.canBeRepliedTo(session, thread);
                json.canBeShared = this.canBeShared();
                json.permalink = this.permalink(thread);
            }

            json.shortLink = this.shortLink();
            json.isMinimized = this.isMinimized();
            json.plaintext = this.messageText();

            // Add relativeCreatedAt for display in the UI (e.g., "Comment created 1 hour ago")
            json.relativeCreatedAt = this.getRelativeCreatedAt();
            // formattedCreatedAt is nice absolute time (e.g. "Jan 1, 2008, 12:00 pm")
            json.formattedCreatedAt = this.getFormattedCreatedAt();
            // expose cid to make it easier to find the model in collections later
            json.cid = this.cid;

            return json;
        },

        /**
         * Is this post visible to all users?
         * @returns {boolean}
         */
        isPublic: function () {

            // Posts that are highlighted or sponsored are always public.
            if (this.get('isHighlighted') || this.get('isSponsored')) {
                return true;
            }
            // Otherwise, if they are deleted they are definitely *not* public.
            if (this.get('isDeleted')) {
                return false;
            }
            // Finally, if they are approved then they are public.
            return this.get('isApproved');
        },

        isMinimized: function () {
            // If comment has been highlighted by a moderator, it is NOT minimized
            // (highlighting is implicit approval by the moderator)
            if (this.get('isHighlighted')) {
                return false;
            }
            // If the comment has been explicitly expanded (unminimized) by
            // the user, it is NOT minimized
            if (this.get('isMinimized') === false) {
                return false;
            }
            return !this.get('isApproved');
        },

        // These methods are stubbed out because they rely on the Session object,
        // which hasn't been ported to next-core yet. They still exist, and return
        // sensible default values, because they're called from Post.prototype.toJSON.
        //
        // NOTE: Until Session is ported to next-core, any applications using Post w/
        //       sessions will need to override these prototype methods

        isAuthorSessionUser: function () { return false; },

        canBeEdited: function () { return false; },

        canBeRepliedTo: function () { return false; },

        canBeShared: function () { return false; },

        validateMessage: function (attrs) {
            if (_.isString(attrs.raw_message)) {
                if (attrs.raw_message === '') {
                    return gettext('Comments can\'t be blank.');
                }
                // eslint-disable-next-line no-magic-numbers
                if (attrs.raw_message.length < 2) {
                    return gettext('Comments must have at least 2 characters.');
                }
            }
        },

        validate: function (attrs) {
            if (this.id || attrs.id) {
                return;
            }
            var messageError = this.validateMessage(attrs);
            if (messageError) {
                return messageError;
            }
            if (attrs.author_email) {
                attrs.author_email = $.trim(attrs.author_email);
            }
            if (attrs.author_name) {
                attrs.author_name = $.trim(attrs.author_name);
            }
            if (attrs.author_email === '' && attrs.author_name === '') {
                return gettext('Please sign in or enter a name and email address.');
            }
            else if (attrs.author_email === '' || attrs.author_name === '') {
                return gettext('Please enter both a name and email address.');
            }

            // Simple client-side email validation. This is obviously not a complete
            // regex, but it should catch 90+% of errors. We can catch the rest on
            // the server.
            if (_.isString(attrs.author_email) && !this.validateEmail(attrs.author_email)) {
                return gettext('Invalid email address format.');
            }
        },

        validateEmail: function (email) {
            return utils.validateEmail(email);
        },

        report: function (reason) {
            this.set('isFlagged', true);

            var data = {
                post: this.id,
            };

            if (reason) {
                data.reason = reason;
            }
            api.call('posts/report.json', {
                data: data,
                method: 'POST',
            });
        },

        _highlight: function (shouldBeHighlighted) {
            this.set('isHighlighted', shouldBeHighlighted);
            api.call('posts/' + (shouldBeHighlighted ? 'highlight' : 'unhighlight') + '.json', {
                data: {
                    post: this.id,
                },
                method: 'POST',
            });
        },

        highlight: function () {
            this._highlight(true);
        },

        unhighlight: function () {
            this._highlight(false);
        },

        /**
         * Override for post models that don't store the thread id
         * in the thread attr
         *
         * @returns {string} id of thread.
         */
        getThreadId: function () {
            return this.get('thread');
        },

        getUpvotersUserCollection: _.memoize(function () {
            var CollectionClass = this.votersCollectionClass;

            return new CollectionClass(undefined, {
                postId: this.id,
                threadId: this.getThreadId(),
            });
        }, function () {
            return [this.id, '1'].join('');
        }),

        getDownvotersUserCollection: _.memoize(function () {
            var CollectionClass = this.votersCollectionClass;

            return new CollectionClass(undefined, {
                postId: this.id,
                threadId: this.getThreadId(),
            });
        }, function () {
            return [this.id, '-1'].join('');
        }),

        // This function does score calculations and increments/decrements
        // counters. We can't just bind it to the 'add' event because
        // we want to call _vote before making a network request and adding
        // a freshly created vote to a collection. (sad face)

        _vote: function (vote, score, voter) {
            var delta = vote - score;
            var updates = {
                likes: this.get('likes'),
                dislikes: this.get('dislikes'),
                points: this.get('points'),
            };

            // If the vote is unchanged from the user's previous vote,
            // so ignore - there's nothing to do

            if (delta === 0) {
                return delta;
            }
            // Update likes and dislikes. This is tricky because a
            // switched vote requires updating *both* attributes, whereas
            // a new vote only touches one.

            if (vote > 0) {
                updates.likes += vote;
                updates.dislikes += score;
            } else if (vote < 0) {
                updates.dislikes -= vote;
                updates.likes -= score;
            } else if (score > 0) {
                updates.likes -= score;
            } else {
                updates.dislikes += score;
            }

            updates.points += delta;

            // add user into correct collection and remove from the other one
            if (voter) {
                if (vote === 1) {
                    this.getUpvotersUserCollection().add(voter);
                    this.getDownvotersUserCollection().remove(voter);
                } else {
                    this.getDownvotersUserCollection().add(voter);
                    this.getUpvotersUserCollection().remove(voter);
                }
            }


            // All these values should be updated at once to prevent any "half-baked"
            // data to trigger the view or any other thing that listens on change
            // events of these properties.
            this.set(updates);

            return delta;
        },

        // Vote on a post, taking into account any earlier votes
        // made by the current user (via the userScore attribute).
        //
        // @params vote {Integer} Can be one of -1, 0, or 1

        vote: function (vote) {
            // Rate limit voting on the Post's public vote interface.
            // We don't rate limit on the private interface because that
            // is used for realtime votes which could come in faster than
            // the rate limit.
            if (!acquireVoteLock()) {
                return 0;
            }
            var self = this;
            var delta = self._vote(vote, self.get('userScore'));

            if (delta === 0) {
                return;
            }
            self.set('userScore', vote);
            api.call('posts/vote.json', {
                data: {
                    post: self.id,
                    vote: vote,
                },
                method: 'POST',
                success: function (data) {
                    // We have merge:true in order to update existing vote instances,
                    // so when the same vote will come from realtime it won't be recognized
                    // as a change.
                    self.votes.add({ id: data.response.id, score: vote }, { merge: true });
                },
            });
        },

        _delete: function () {
            this.set({
                isApproved: false,
                isDeleted: true,
            });

            return api.call('posts/remove.json', {
                data: { post: this.id },
                method: 'POST',
            });
        },

        spam: function () {
            this.set({
                isApproved: false,
                isDeleted: true,
                isSpam: true,
            });

            this.trigger('spam');

            api.call('posts/spam.json', {
                data: { post: this.id },
                method: 'POST',
            });
        },

        _create: function (model, options) {
            var self = this;
            var attrs = model.attributes;
            var params = {
                thread: attrs.thread,
                message: attrs.raw_message,
                rating: attrs.rating,
            };

            if (attrs.parent) {
                params.parent = attrs.parent;
            }
            // Anon posting
            if (attrs.author_name) {
                params.author_name = attrs.author_name;
                params.author_email = attrs.author_email;
            }

            return api.call('posts/create.json', {
                data: params,
                method: 'POST',
                success: function (data) {
                    self.set(data.response);
                    if (options.success) {
                        options.success();
                    }
                },
                error: options.error,
            });
        },

        _update: function (model, options) {
            var self = this;
            var attrs = model.attributes;

            var params = {
                post: attrs.id,
                message: attrs.raw_message,
                rating: attrs.rating,
            };


            return api.call('posts/update.json', {
                data: params,
                method: 'POST',
                success: function (data) {
                    self.set(data.response);
                    if (options.success) {
                        options.success();
                    }
                },
                error: options.error,
            });
        },

        _read: function (_model, options) {
            var self = this;
            options = options || {};

            return api.call('posts/details.json', {
                data: { post: self.id },
                method: 'GET',
                success: function (data) {
                    self.set(data.response);
                    if (options.success) {
                        options.success();
                    }
                },
                error: options.error,
            });
        },

        sync: function (method, model, options) {
            options = options || {};

            var error = options.error;
            if (error) {
                options.error = function (xhr) {
                    var response = {};
                    try {
                        response = JSON.parse(xhr.responseText);
                    } catch (err) {
                        // ignore
                    }

                    error(response);
                };
            }

            switch (method) {
            case 'create':
                return this._create(model, options);
            case 'update':
                return this._update(model, options);
            case 'delete':
                return this._delete();
            case 'read':
                return this._read(model, options);
            default:
                return null;
            }
        },

        /**
         * Generate key for storing draft posts in local storage.
         * A draft post is one that has not yet been saved on the back
         * end.
         *
         * Example: drafts:thread:1:parent:0
         *
         * @returns {string} key name
         */
        storageKey: function () {
            // Only allow draft posts to be stored in local storage
            if (!this.isNew()) {
                return;
            }
            if (!this.getThreadId()) {
                return;
            }
            return ['drafts', 'thread', this.getThreadId(), 'parent', this.get('parent') || 0].join(':');
        },
    }, {
        /**
         * Get an escaped approximation of how a raw message
         * will be formatted by our API.
         *
         * This method currently _only_ formats newlines into
         * <p> and <br> tags.
         *     TODO: make this method handle mentions and various
         *           supported tags.
         *
         * @params {string} text Text to format.
         * @returns {string} Escaped and <p> <br> message.
         */
        formatMessage: (function () {

            var paragraphReg = /(?:\r\n|\r|\n){2,}/;
            var lineReg = /\r\n|\r|\n/;

            return function (text) {

                // Any series of two or more newlines is a paragraph.
                // Use `compact()` to filter empty values.
                var paragraphs = _.chain(text.split(paragraphReg))
                    .compact()
                    .value();

                var html = _.map(paragraphs, function (paragraph) {

                    // Single newlines are spaced with <br> tags.
                    // Use `compact()` to filter empty values.
                    return _.chain(paragraph.split(lineReg))
                        .compact()

                        // Escape text to prevent users from
                        // accidentally XXSing themselves.
                        .map(_.escape)
                        .join('<br>')
                        .value();

                }).join('</p><p>');

                return '<p>' + html + '</p>';
            };

        })(),
    });

    //
    // Applied mixins
    //

    modelMixins.withCreatedAt.call(Post.prototype);
    advice.withAdvice.call(Post.prototype);

    //
    // Optional mixins
    //

    /**
     * Adds `author` as a sub-model of Post
     */

    Post.withAuthor = function (UserModel) {
        this.around('set', function (set, key, val, options) {
            var attrs;

            // eslint-disable-next-line eqeqeq, no-eq-null
            if (key == null) {
                return this;
            }
            // Handle both `"key", value` and `{key: value}` -style arguments.
            if (typeof key === 'object') {
                attrs = key;
                options = val;
            } else {
                attrs = {};
                attrs[key] = val;
            }

            var author = attrs.author;

            if (author) {
                // Convert 'author' attributes to a model instance. Attributes
                // should never contain nested properties, but that's what the API
                // returns, so we convert it here.
                //
                // NOTE: This kind of stuff is made easier with a Backbone plugin
                //       called Backbone-Relational, but I'm not sure we need it
                //       just yet. (https://github.com/PaulUithol/Backbone-relational)

                if (_.isString(author) || _.isNumber(author)) {
                    var id = author;
                    author = {};
                    author[UserModel.prototype.idAttribute || 'id'] = id;
                }

                // Convert the forum badge IDs on the post author to forum badge objects
                if (this.collection && this.collection.thread && this.collection.thread.forum && this.collection.thread.forum.get('badges') && author.badges) {
                    var badges = [];
                    var badgeIds = author.badges || [];
                    var forum = this.collection.thread.forum;
                    var forumBadges = forum.get('badges');
                    badgeIds.forEach(function (badgeId) {
                        if (forumBadges[badgeId]) {
                            badges.push(forumBadges[badgeId]);
                        }
                    });
                    author.badges = badges;
                }

                this.author = new UserModel(author);

                // This is the standard event structure for when a related model is
                // set (used in home).
                this.trigger('changeRelated:author');

                delete attrs.author;
            }

            return set.call(this, attrs, options);
        });

        this.around('toJSON', function (toJSON) {
            var json = toJSON.apply(this, _.rest(arguments));

            if (this.author) {
                json.author = this.author.toJSON();
            }
            return json;
        });
    };

    /**
     * Adds `media` as a sub-collection of Post
     *
     * @param {Object} MediaCollection - a MediaCollection class that encapsulates media attributes
     * @returns {undefined}
     */
    Post.withMediaCollection = function (MediaCollection) {
        this.after('set', function (attrs) {
            if (attrs && typeof attrs !== 'string') {

                // Convert 'media' attribute into collection
                if (!_.isUndefined(attrs.media)) {
                    // Populate media collection
                    if (this.media) {
                        this.media.reset(attrs.media);
                    } else {
                        this.media = new MediaCollection(attrs.media);
                    }
                    delete attrs.media;
                }
            }
        });

        this.around('toJSON', function (toJSON) {
            var json = toJSON.apply(this, _.rest(arguments));

            if (this.media) {
                json.media = this.media.toJSON();
            }
            return json;
        });
    };

    return Post;
});

(function (global, factory) {
	typeof exports === 'object' && typeof module !== 'undefined' ? module.exports = factory() :
	typeof define === 'function' && define.amd ? define('dompurify',factory) :
	(global.DOMPurify = factory());
}(this, (function () { 'use strict';

var freeze$1 = Object.freeze || function (x) {
  return x;
};

var html = freeze$1(['a', 'abbr', 'acronym', 'address', 'area', 'article', 'aside', 'audio', 'b', 'bdi', 'bdo', 'big', 'blink', 'blockquote', 'body', 'br', 'button', 'canvas', 'caption', 'center', 'cite', 'code', 'col', 'colgroup', 'content', 'data', 'datalist', 'dd', 'decorator', 'del', 'details', 'dfn', 'dir', 'div', 'dl', 'dt', 'element', 'em', 'fieldset', 'figcaption', 'figure', 'font', 'footer', 'form', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'head', 'header', 'hgroup', 'hr', 'html', 'i', 'img', 'input', 'ins', 'kbd', 'label', 'legend', 'li', 'main', 'map', 'mark', 'marquee', 'menu', 'menuitem', 'meter', 'nav', 'nobr', 'ol', 'optgroup', 'option', 'output', 'p', 'pre', 'progress', 'q', 'rp', 'rt', 'ruby', 's', 'samp', 'section', 'select', 'shadow', 'small', 'source', 'spacer', 'span', 'strike', 'strong', 'style', 'sub', 'summary', 'sup', 'table', 'tbody', 'td', 'template', 'textarea', 'tfoot', 'th', 'thead', 'time', 'tr', 'track', 'tt', 'u', 'ul', 'var', 'video', 'wbr']);

// SVG
var svg = freeze$1(['svg', 'a', 'altglyph', 'altglyphdef', 'altglyphitem', 'animatecolor', 'animatemotion', 'animatetransform', 'audio', 'canvas', 'circle', 'clippath', 'defs', 'desc', 'ellipse', 'filter', 'font', 'g', 'glyph', 'glyphref', 'hkern', 'image', 'line', 'lineargradient', 'marker', 'mask', 'metadata', 'mpath', 'path', 'pattern', 'polygon', 'polyline', 'radialgradient', 'rect', 'stop', 'style', 'switch', 'symbol', 'text', 'textpath', 'title', 'tref', 'tspan', 'video', 'view', 'vkern']);

var svgFilters = freeze$1(['feBlend', 'feColorMatrix', 'feComponentTransfer', 'feComposite', 'feConvolveMatrix', 'feDiffuseLighting', 'feDisplacementMap', 'feDistantLight', 'feFlood', 'feFuncA', 'feFuncB', 'feFuncG', 'feFuncR', 'feGaussianBlur', 'feMerge', 'feMergeNode', 'feMorphology', 'feOffset', 'fePointLight', 'feSpecularLighting', 'feSpotLight', 'feTile', 'feTurbulence']);

var mathMl = freeze$1(['math', 'menclose', 'merror', 'mfenced', 'mfrac', 'mglyph', 'mi', 'mlabeledtr', 'mmultiscripts', 'mn', 'mo', 'mover', 'mpadded', 'mphantom', 'mroot', 'mrow', 'ms', 'mspace', 'msqrt', 'mstyle', 'msub', 'msup', 'msubsup', 'mtable', 'mtd', 'mtext', 'mtr', 'munder', 'munderover']);

var text = freeze$1(['#text']);

var freeze$2 = Object.freeze || function (x) {
  return x;
};

var html$1 = freeze$2(['accept', 'action', 'align', 'alt', 'autocomplete', 'background', 'bgcolor', 'border', 'cellpadding', 'cellspacing', 'checked', 'cite', 'class', 'clear', 'color', 'cols', 'colspan', 'controls', 'coords', 'crossorigin', 'datetime', 'default', 'dir', 'disabled', 'download', 'enctype', 'face', 'for', 'headers', 'height', 'hidden', 'high', 'href', 'hreflang', 'id', 'integrity', 'ismap', 'label', 'lang', 'list', 'loop', 'low', 'max', 'maxlength', 'media', 'method', 'min', 'minlength', 'multiple', 'name', 'noshade', 'novalidate', 'nowrap', 'open', 'optimum', 'pattern', 'placeholder', 'poster', 'preload', 'pubdate', 'radiogroup', 'readonly', 'rel', 'required', 'rev', 'reversed', 'role', 'rows', 'rowspan', 'spellcheck', 'scope', 'selected', 'shape', 'size', 'sizes', 'span', 'srclang', 'start', 'src', 'srcset', 'step', 'style', 'summary', 'tabindex', 'title', 'type', 'usemap', 'valign', 'value', 'width', 'xmlns']);

var svg$1 = freeze$2(['accent-height', 'accumulate', 'additive', 'alignment-baseline', 'ascent', 'attributename', 'attributetype', 'azimuth', 'basefrequency', 'baseline-shift', 'begin', 'bias', 'by', 'class', 'clip', 'clip-path', 'clip-rule', 'color', 'color-interpolation', 'color-interpolation-filters', 'color-profile', 'color-rendering', 'cx', 'cy', 'd', 'dx', 'dy', 'diffuseconstant', 'direction', 'display', 'divisor', 'dur', 'edgemode', 'elevation', 'end', 'fill', 'fill-opacity', 'fill-rule', 'filter', 'filterunits', 'flood-color', 'flood-opacity', 'font-family', 'font-size', 'font-size-adjust', 'font-stretch', 'font-style', 'font-variant', 'font-weight', 'fx', 'fy', 'g1', 'g2', 'glyph-name', 'glyphref', 'gradientunits', 'gradienttransform', 'height', 'href', 'id', 'image-rendering', 'in', 'in2', 'k', 'k1', 'k2', 'k3', 'k4', 'kerning', 'keypoints', 'keysplines', 'keytimes', 'lang', 'lengthadjust', 'letter-spacing', 'kernelmatrix', 'kernelunitlength', 'lighting-color', 'local', 'marker-end', 'marker-mid', 'marker-start', 'markerheight', 'markerunits', 'markerwidth', 'maskcontentunits', 'maskunits', 'max', 'mask', 'media', 'method', 'mode', 'min', 'name', 'numoctaves', 'offset', 'operator', 'opacity', 'order', 'orient', 'orientation', 'origin', 'overflow', 'paint-order', 'path', 'pathlength', 'patterncontentunits', 'patterntransform', 'patternunits', 'points', 'preservealpha', 'preserveaspectratio', 'primitiveunits', 'r', 'rx', 'ry', 'radius', 'refx', 'refy', 'repeatcount', 'repeatdur', 'restart', 'result', 'rotate', 'scale', 'seed', 'shape-rendering', 'specularconstant', 'specularexponent', 'spreadmethod', 'stddeviation', 'stitchtiles', 'stop-color', 'stop-opacity', 'stroke-dasharray', 'stroke-dashoffset', 'stroke-linecap', 'stroke-linejoin', 'stroke-miterlimit', 'stroke-opacity', 'stroke', 'stroke-width', 'style', 'surfacescale', 'tabindex', 'targetx', 'targety', 'transform', 'text-anchor', 'text-decoration', 'text-rendering', 'textlength', 'type', 'u1', 'u2', 'unicode', 'values', 'viewbox', 'visibility', 'version', 'vert-adv-y', 'vert-origin-x', 'vert-origin-y', 'width', 'word-spacing', 'wrap', 'writing-mode', 'xchannelselector', 'ychannelselector', 'x', 'x1', 'x2', 'xmlns', 'y', 'y1', 'y2', 'z', 'zoomandpan']);

var mathMl$1 = freeze$2(['accent', 'accentunder', 'align', 'bevelled', 'close', 'columnsalign', 'columnlines', 'columnspan', 'denomalign', 'depth', 'dir', 'display', 'displaystyle', 'encoding', 'fence', 'frame', 'height', 'href', 'id', 'largeop', 'length', 'linethickness', 'lspace', 'lquote', 'mathbackground', 'mathcolor', 'mathsize', 'mathvariant', 'maxsize', 'minsize', 'movablelimits', 'notation', 'numalign', 'open', 'rowalign', 'rowlines', 'rowspacing', 'rowspan', 'rspace', 'rquote', 'scriptlevel', 'scriptminsize', 'scriptsizemultiplier', 'selection', 'separator', 'separators', 'stretchy', 'subscriptshift', 'supscriptshift', 'symmetric', 'voffset', 'width', 'xmlns']);

var xml = freeze$2(['xlink:href', 'xml:id', 'xlink:title', 'xml:space', 'xmlns:xlink']);

var hasOwnProperty = Object.hasOwnProperty;
var setPrototypeOf = Object.setPrototypeOf;

var _ref$1 = typeof Reflect !== 'undefined' && Reflect;
var apply$1 = _ref$1.apply;

if (!apply$1) {
  apply$1 = function apply(fun, thisValue, args) {
    return fun.apply(thisValue, args);
  };
}

/* Add properties to a lookup table */
function addToSet(set, array) {
  if (setPrototypeOf) {
    // Make 'in' and truthy checks like Boolean(set.constructor)
    // independent of any properties defined on Object.prototype.
    // Prevent prototype setters from intercepting set as a this value.
    setPrototypeOf(set, null);
  }

  var l = array.length;
  while (l--) {
    var element = array[l];
    if (typeof element === 'string') {
      var lcElement = element.toLowerCase();
      if (lcElement !== element) {
        // Config presets (e.g. tags.js, attrs.js) are immutable.
        if (!Object.isFrozen(array)) {
          array[l] = lcElement;
        }

        element = lcElement;
      }
    }

    set[element] = true;
  }

  return set;
}

/* Shallow clone an object */
function clone(object) {
  var newObject = {};

  var property = void 0;
  for (property in object) {
    if (apply$1(hasOwnProperty, object, [property])) {
      newObject[property] = object[property];
    }
  }

  return newObject;
}

var seal = Object.seal || function (x) {
  return x;
};

var MUSTACHE_EXPR = seal(/\{\{[\s\S]*|[\s\S]*\}\}/gm); // Specify template detection regex for SAFE_FOR_TEMPLATES mode
var ERB_EXPR = seal(/<%[\s\S]*|[\s\S]*%>/gm);
var DATA_ATTR = seal(/^data-[\-\w.\u00B7-\uFFFF]/); // eslint-disable-line no-useless-escape
var ARIA_ATTR = seal(/^aria-[\-\w]+$/); // eslint-disable-line no-useless-escape
var IS_ALLOWED_URI = seal(/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|cid|xmpp):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i // eslint-disable-line no-useless-escape
);
var IS_SCRIPT_OR_DATA = seal(/^(?:\w+script|data):/i);
var ATTR_WHITESPACE = seal(/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205f\u3000]/g // eslint-disable-line no-control-regex
);

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; };

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var _ref = typeof Reflect !== 'undefined' && Reflect;
var apply = _ref.apply;

var arraySlice = Array.prototype.slice;
var freeze = Object.freeze;

var getGlobal = function getGlobal() {
  return typeof window === 'undefined' ? null : window;
};

if (!apply) {
  apply = function apply(fun, thisValue, args) {
    return fun.apply(thisValue, args);
  };
}

/**
 * Creates a no-op policy for internal use only.
 * Don't export this function outside this module!
 * @param {?TrustedTypePolicyFactory} trustedTypes The policy factory.
 * @param {Document} document The document object (to determine policy name suffix)
 * @return {?TrustedTypePolicy} The policy created (or null, if Trusted Types
 * are not supported).
 */
var _createTrustedTypesPolicy = function _createTrustedTypesPolicy(trustedTypes, document) {
  if ((typeof trustedTypes === 'undefined' ? 'undefined' : _typeof(trustedTypes)) !== 'object' || typeof trustedTypes.createPolicy !== 'function') {
    return null;
  }

  // Allow the callers to control the unique policy name
  // by adding a data-tt-policy-suffix to the script element with the DOMPurify.
  // Policy creation with duplicate names throws in Trusted Types.
  var suffix = null;
  var ATTR_NAME = 'data-tt-policy-suffix';
  if (document.currentScript && document.currentScript.hasAttribute(ATTR_NAME)) {
    suffix = document.currentScript.getAttribute(ATTR_NAME);
  }

  var policyName = 'dompurify' + (suffix ? '#' + suffix : '');

  try {
    return trustedTypes.createPolicy(policyName, {
      createHTML: function createHTML(html$$1) {
        return html$$1;
      }
    });
  } catch (error) {
    // Policy creation failed (most likely another DOMPurify script has
    // already run). Skip creating the policy, as this will only cause errors
    // if TT are enforced.
    console.warn('TrustedTypes policy ' + policyName + ' could not be created.');
    return null;
  }
};

function createDOMPurify() {
  var window = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : getGlobal();

  var DOMPurify = function DOMPurify(root) {
    return createDOMPurify(root);
  };

  /**
   * Version label, exposed for easier checks
   * if DOMPurify is up to date or not
   */
  DOMPurify.version = '2.0.7';

  /**
   * Array of elements that DOMPurify removed during sanitation.
   * Empty if nothing was removed.
   */
  DOMPurify.removed = [];

  if (!window || !window.document || window.document.nodeType !== 9) {
    // Not running in a browser, provide a factory function
    // so that you can pass your own Window
    DOMPurify.isSupported = false;

    return DOMPurify;
  }

  var originalDocument = window.document;
  var useDOMParser = false;
  var removeTitle = false;

  var document = window.document;
  var DocumentFragment = window.DocumentFragment,
      HTMLTemplateElement = window.HTMLTemplateElement,
      Node = window.Node,
      NodeFilter = window.NodeFilter,
      _window$NamedNodeMap = window.NamedNodeMap,
      NamedNodeMap = _window$NamedNodeMap === undefined ? window.NamedNodeMap || window.MozNamedAttrMap : _window$NamedNodeMap,
      Text = window.Text,
      Comment = window.Comment,
      DOMParser = window.DOMParser,
      TrustedTypes = window.TrustedTypes;

  // As per issue #47, the web-components registry is inherited by a
  // new document created via createHTMLDocument. As per the spec
  // (http://w3c.github.io/webcomponents/spec/custom/#creating-and-passing-registries)
  // a new empty registry is used when creating a template contents owner
  // document, so we use that as our parent document to ensure nothing
  // is inherited.

  if (typeof HTMLTemplateElement === 'function') {
    var template = document.createElement('template');
    if (template.content && template.content.ownerDocument) {
      document = template.content.ownerDocument;
    }
  }

  var trustedTypesPolicy = _createTrustedTypesPolicy(TrustedTypes, originalDocument);
  var emptyHTML = trustedTypesPolicy ? trustedTypesPolicy.createHTML('') : '';

  var _document = document,
      implementation = _document.implementation,
      createNodeIterator = _document.createNodeIterator,
      getElementsByTagName = _document.getElementsByTagName,
      createDocumentFragment = _document.createDocumentFragment;
  var importNode = originalDocument.importNode;


  var hooks = {};

  /**
   * Expose whether this browser supports running the full DOMPurify.
   */
  DOMPurify.isSupported = implementation && typeof implementation.createHTMLDocument !== 'undefined' && document.documentMode !== 9;

  var MUSTACHE_EXPR$$1 = MUSTACHE_EXPR,
      ERB_EXPR$$1 = ERB_EXPR,
      DATA_ATTR$$1 = DATA_ATTR,
      ARIA_ATTR$$1 = ARIA_ATTR,
      IS_SCRIPT_OR_DATA$$1 = IS_SCRIPT_OR_DATA,
      ATTR_WHITESPACE$$1 = ATTR_WHITESPACE;
  var IS_ALLOWED_URI$$1 = IS_ALLOWED_URI;

  /**
   * We consider the elements and attributes below to be safe. Ideally
   * don't add any new ones but feel free to remove unwanted ones.
   */

  /* allowed element names */

  var ALLOWED_TAGS = null;
  var DEFAULT_ALLOWED_TAGS = addToSet({}, [].concat(_toConsumableArray(html), _toConsumableArray(svg), _toConsumableArray(svgFilters), _toConsumableArray(mathMl), _toConsumableArray(text)));

  /* Allowed attribute names */
  var ALLOWED_ATTR = null;
  var DEFAULT_ALLOWED_ATTR = addToSet({}, [].concat(_toConsumableArray(html$1), _toConsumableArray(svg$1), _toConsumableArray(mathMl$1), _toConsumableArray(xml)));

  /* Explicitly forbidden tags (overrides ALLOWED_TAGS/ADD_TAGS) */
  var FORBID_TAGS = null;

  /* Explicitly forbidden attributes (overrides ALLOWED_ATTR/ADD_ATTR) */
  var FORBID_ATTR = null;

  /* Decide if ARIA attributes are okay */
  var ALLOW_ARIA_ATTR = true;

  /* Decide if custom data attributes are okay */
  var ALLOW_DATA_ATTR = true;

  /* Decide if unknown protocols are okay */
  var ALLOW_UNKNOWN_PROTOCOLS = false;

  /* Output should be safe for jQuery's $() factory? */
  var SAFE_FOR_JQUERY = false;

  /* Output should be safe for common template engines.
   * This means, DOMPurify removes data attributes, mustaches and ERB
   */
  var SAFE_FOR_TEMPLATES = false;

  /* Decide if document with <html>... should be returned */
  var WHOLE_DOCUMENT = false;

  /* Track whether config is already set on this instance of DOMPurify. */
  var SET_CONFIG = false;

  /* Decide if all elements (e.g. style, script) must be children of
   * document.body. By default, browsers might move them to document.head */
  var FORCE_BODY = false;

  /* Decide if a DOM `HTMLBodyElement` should be returned, instead of a html
   * string (or a TrustedHTML object if Trusted Types are supported).
   * If `WHOLE_DOCUMENT` is enabled a `HTMLHtmlElement` will be returned instead
   */
  var RETURN_DOM = false;

  /* Decide if a DOM `DocumentFragment` should be returned, instead of a html
   * string  (or a TrustedHTML object if Trusted Types are supported) */
  var RETURN_DOM_FRAGMENT = false;

  /* If `RETURN_DOM` or `RETURN_DOM_FRAGMENT` is enabled, decide if the returned DOM
   * `Node` is imported into the current `Document`. If this flag is not enabled the
   * `Node` will belong (its ownerDocument) to a fresh `HTMLDocument`, created by
   * DOMPurify. */
  var RETURN_DOM_IMPORT = false;

  /* Try to return a Trusted Type object instead of a string, retrun a string in
   * case Trusted Types are not supported  */
  var RETURN_TRUSTED_TYPE = false;

  /* Output should be free from DOM clobbering attacks? */
  var SANITIZE_DOM = true;

  /* Keep element content when removing element? */
  var KEEP_CONTENT = true;

  /* If a `Node` is passed to sanitize(), then performs sanitization in-place instead
   * of importing it into a new Document and returning a sanitized copy */
  var IN_PLACE = false;

  /* Allow usage of profiles like html, svg and mathMl */
  var USE_PROFILES = {};

  /* Tags to ignore content of when KEEP_CONTENT is true */
  var FORBID_CONTENTS = addToSet({}, ['annotation-xml', 'audio', 'colgroup', 'desc', 'foreignobject', 'head', 'iframe', 'math', 'mi', 'mn', 'mo', 'ms', 'mtext', 'noembed', 'noframes', 'plaintext', 'script', 'style', 'svg', 'template', 'thead', 'title', 'video', 'xmp']);

  /* Tags that are safe for data: URIs */
  var DATA_URI_TAGS = addToSet({}, ['audio', 'video', 'img', 'source', 'image']);

  /* Attributes safe for values like "javascript:" */
  var URI_SAFE_ATTRIBUTES = null;
  var DEFAULT_URI_SAFE_ATTRIBUTES = addToSet({}, ['alt', 'class', 'for', 'id', 'label', 'name', 'pattern', 'placeholder', 'summary', 'title', 'value', 'style', 'xmlns']);

  /* Keep a reference to config to pass to hooks */
  var CONFIG = null;

  /* Ideally, do not touch anything below this line */
  /* ______________________________________________ */

  var formElement = document.createElement('form');

  /**
   * _parseConfig
   *
   * @param  {Object} cfg optional config literal
   */
  // eslint-disable-next-line complexity
  var _parseConfig = function _parseConfig(cfg) {
    if (CONFIG && CONFIG === cfg) {
      return;
    }

    /* Shield configuration object from tampering */
    if (!cfg || (typeof cfg === 'undefined' ? 'undefined' : _typeof(cfg)) !== 'object') {
      cfg = {};
    }

    /* Set configuration parameters */
    ALLOWED_TAGS = 'ALLOWED_TAGS' in cfg ? addToSet({}, cfg.ALLOWED_TAGS) : DEFAULT_ALLOWED_TAGS;
    ALLOWED_ATTR = 'ALLOWED_ATTR' in cfg ? addToSet({}, cfg.ALLOWED_ATTR) : DEFAULT_ALLOWED_ATTR;
    URI_SAFE_ATTRIBUTES = 'ADD_URI_SAFE_ATTR' in cfg ? addToSet(clone(DEFAULT_URI_SAFE_ATTRIBUTES), cfg.ADD_URI_SAFE_ATTR) : DEFAULT_URI_SAFE_ATTRIBUTES;
    FORBID_TAGS = 'FORBID_TAGS' in cfg ? addToSet({}, cfg.FORBID_TAGS) : {};
    FORBID_ATTR = 'FORBID_ATTR' in cfg ? addToSet({}, cfg.FORBID_ATTR) : {};
    USE_PROFILES = 'USE_PROFILES' in cfg ? cfg.USE_PROFILES : false;
    ALLOW_ARIA_ATTR = cfg.ALLOW_ARIA_ATTR !== false; // Default true
    ALLOW_DATA_ATTR = cfg.ALLOW_DATA_ATTR !== false; // Default true
    ALLOW_UNKNOWN_PROTOCOLS = cfg.ALLOW_UNKNOWN_PROTOCOLS || false; // Default false
    SAFE_FOR_JQUERY = cfg.SAFE_FOR_JQUERY || false; // Default false
    SAFE_FOR_TEMPLATES = cfg.SAFE_FOR_TEMPLATES || false; // Default false
    WHOLE_DOCUMENT = cfg.WHOLE_DOCUMENT || false; // Default false
    RETURN_DOM = cfg.RETURN_DOM || false; // Default false
    RETURN_DOM_FRAGMENT = cfg.RETURN_DOM_FRAGMENT || false; // Default false
    RETURN_DOM_IMPORT = cfg.RETURN_DOM_IMPORT || false; // Default false
    RETURN_TRUSTED_TYPE = cfg.RETURN_TRUSTED_TYPE || false; // Default false
    FORCE_BODY = cfg.FORCE_BODY || false; // Default false
    SANITIZE_DOM = cfg.SANITIZE_DOM !== false; // Default true
    KEEP_CONTENT = cfg.KEEP_CONTENT !== false; // Default true
    IN_PLACE = cfg.IN_PLACE || false; // Default false

    IS_ALLOWED_URI$$1 = cfg.ALLOWED_URI_REGEXP || IS_ALLOWED_URI$$1;

    if (SAFE_FOR_TEMPLATES) {
      ALLOW_DATA_ATTR = false;
    }

    if (RETURN_DOM_FRAGMENT) {
      RETURN_DOM = true;
    }

    /* Parse profile info */
    if (USE_PROFILES) {
      ALLOWED_TAGS = addToSet({}, [].concat(_toConsumableArray(text)));
      ALLOWED_ATTR = [];
      if (USE_PROFILES.html === true) {
        addToSet(ALLOWED_TAGS, html);
        addToSet(ALLOWED_ATTR, html$1);
      }

      if (USE_PROFILES.svg === true) {
        addToSet(ALLOWED_TAGS, svg);
        addToSet(ALLOWED_ATTR, svg$1);
        addToSet(ALLOWED_ATTR, xml);
      }

      if (USE_PROFILES.svgFilters === true) {
        addToSet(ALLOWED_TAGS, svgFilters);
        addToSet(ALLOWED_ATTR, svg$1);
        addToSet(ALLOWED_ATTR, xml);
      }

      if (USE_PROFILES.mathMl === true) {
        addToSet(ALLOWED_TAGS, mathMl);
        addToSet(ALLOWED_ATTR, mathMl$1);
        addToSet(ALLOWED_ATTR, xml);
      }
    }

    /* Merge configuration parameters */
    if (cfg.ADD_TAGS) {
      if (ALLOWED_TAGS === DEFAULT_ALLOWED_TAGS) {
        ALLOWED_TAGS = clone(ALLOWED_TAGS);
      }

      addToSet(ALLOWED_TAGS, cfg.ADD_TAGS);
    }

    if (cfg.ADD_ATTR) {
      if (ALLOWED_ATTR === DEFAULT_ALLOWED_ATTR) {
        ALLOWED_ATTR = clone(ALLOWED_ATTR);
      }

      addToSet(ALLOWED_ATTR, cfg.ADD_ATTR);
    }

    if (cfg.ADD_URI_SAFE_ATTR) {
      addToSet(URI_SAFE_ATTRIBUTES, cfg.ADD_URI_SAFE_ATTR);
    }

    /* Add #text in case KEEP_CONTENT is set to true */
    if (KEEP_CONTENT) {
      ALLOWED_TAGS['#text'] = true;
    }

    /* Add html, head and body to ALLOWED_TAGS in case WHOLE_DOCUMENT is true */
    if (WHOLE_DOCUMENT) {
      addToSet(ALLOWED_TAGS, ['html', 'head', 'body']);
    }

    /* Add tbody to ALLOWED_TAGS in case tables are permitted, see #286, #365 */
    if (ALLOWED_TAGS.table) {
      addToSet(ALLOWED_TAGS, ['tbody']);
      delete FORBID_TAGS.tbody;
    }

    // Prevent further manipulation of configuration.
    // Not available in IE8, Safari 5, etc.
    if (freeze) {
      freeze(cfg);
    }

    CONFIG = cfg;
  };

  /**
   * _forceRemove
   *
   * @param  {Node} node a DOM node
   */
  var _forceRemove = function _forceRemove(node) {
    DOMPurify.removed.push({ element: node });
    try {
      node.parentNode.removeChild(node);
    } catch (error) {
      node.outerHTML = emptyHTML;
    }
  };

  /**
   * _removeAttribute
   *
   * @param  {String} name an Attribute name
   * @param  {Node} node a DOM node
   */
  var _removeAttribute = function _removeAttribute(name, node) {
    try {
      DOMPurify.removed.push({
        attribute: node.getAttributeNode(name),
        from: node
      });
    } catch (error) {
      DOMPurify.removed.push({
        attribute: null,
        from: node
      });
    }

    node.removeAttribute(name);
  };

  /**
   * _initDocument
   *
   * @param  {String} dirty a string of dirty markup
   * @return {Document} a DOM, filled with the dirty markup
   */
  var _initDocument = function _initDocument(dirty) {
    /* Create a HTML document */
    var doc = void 0;
    var leadingWhitespace = void 0;

    if (FORCE_BODY) {
      dirty = '<remove></remove>' + dirty;
    } else {
      /* If FORCE_BODY isn't used, leading whitespace needs to be preserved manually */
      var matches = dirty.match(/^[\s]+/);
      leadingWhitespace = matches && matches[0];
      if (leadingWhitespace) {
        dirty = dirty.slice(leadingWhitespace.length);
      }
    }

    /* Use DOMParser to workaround Firefox bug (see comment below) */
    if (useDOMParser) {
      try {
        doc = new DOMParser().parseFromString(dirty, 'text/html');
      } catch (error) {}
    }

    /* Remove title to fix a mXSS bug in older MS Edge */
    if (removeTitle) {
      addToSet(FORBID_TAGS, ['title']);
    }

    /* Otherwise use createHTMLDocument, because DOMParser is unsafe in
    Safari (see comment below) */
    if (!doc || !doc.documentElement) {
      doc = implementation.createHTMLDocument('');
      var _doc = doc,
          body = _doc.body;

      body.parentNode.removeChild(body.parentNode.firstElementChild);
      body.outerHTML = trustedTypesPolicy ? trustedTypesPolicy.createHTML(dirty) : dirty;
    }

    if (dirty && leadingWhitespace) {
      doc.body.insertBefore(document.createTextNode(leadingWhitespace), doc.body.childNodes[0] || null);
    }

    /* Work on whole document or just its body */
    return getElementsByTagName.call(doc, WHOLE_DOCUMENT ? 'html' : 'body')[0];
  };

  // Firefox uses a different parser for innerHTML rather than
  // DOMParser (see https://bugzilla.mozilla.org/show_bug.cgi?id=1205631)
  // which means that you *must* use DOMParser, otherwise the output may
  // not be safe if used in a document.write context later.
  //
  // So we feature detect the Firefox bug and use the DOMParser if necessary.
  //
  // Chrome 77 and other versions ship an mXSS bug that caused a bypass to
  // happen. We now check for the mXSS trigger and react accordingly.
  if (DOMPurify.isSupported) {
    (function () {
      try {
        var doc = _initDocument('<svg><p><textarea><img src="</textarea><img src=x abc=1//">');
        if (doc.querySelector('svg img')) {
          useDOMParser = true;
        }
      } catch (error) {}
    })();

    (function () {
      try {
        var doc = _initDocument('<x/><title>&lt;/title&gt;&lt;img&gt;');
        if (/<\/title/.test(doc.querySelector('title').innerHTML)) {
          removeTitle = true;
        }
      } catch (error) {}
    })();
  }

  /**
   * _createIterator
   *
   * @param  {Document} root document/fragment to create iterator for
   * @return {Iterator} iterator instance
   */
  var _createIterator = function _createIterator(root) {
    return createNodeIterator.call(root.ownerDocument || root, root, NodeFilter.SHOW_ELEMENT | NodeFilter.SHOW_COMMENT | NodeFilter.SHOW_TEXT, function () {
      return NodeFilter.FILTER_ACCEPT;
    }, false);
  };

  /**
   * _isClobbered
   *
   * @param  {Node} elm element to check for clobbering attacks
   * @return {Boolean} true if clobbered, false if safe
   */
  var _isClobbered = function _isClobbered(elm) {
    if (elm instanceof Text || elm instanceof Comment) {
      return false;
    }

    if (typeof elm.nodeName !== 'string' || typeof elm.textContent !== 'string' || typeof elm.removeChild !== 'function' || !(elm.attributes instanceof NamedNodeMap) || typeof elm.removeAttribute !== 'function' || typeof elm.setAttribute !== 'function' || typeof elm.namespaceURI !== 'string') {
      return true;
    }

    return false;
  };

  /**
   * _isNode
   *
   * @param  {Node} obj object to check whether it's a DOM node
   * @return {Boolean} true is object is a DOM node
   */
  var _isNode = function _isNode(obj) {
    return (typeof Node === 'undefined' ? 'undefined' : _typeof(Node)) === 'object' ? obj instanceof Node : obj && (typeof obj === 'undefined' ? 'undefined' : _typeof(obj)) === 'object' && typeof obj.nodeType === 'number' && typeof obj.nodeName === 'string';
  };

  /**
   * _executeHook
   * Execute user configurable hooks
   *
   * @param  {String} entryPoint  Name of the hook's entry point
   * @param  {Node} currentNode node to work on with the hook
   * @param  {Object} data additional hook parameters
   */
  var _executeHook = function _executeHook(entryPoint, currentNode, data) {
    if (!hooks[entryPoint]) {
      return;
    }

    hooks[entryPoint].forEach(function (hook) {
      hook.call(DOMPurify, currentNode, data, CONFIG);
    });
  };

  /**
   * _sanitizeElements
   *
   * @protect nodeName
   * @protect textContent
   * @protect removeChild
   *
   * @param   {Node} currentNode to check for permission to exist
   * @return  {Boolean} true if node was killed, false if left alive
   */
  // eslint-disable-next-line complexity
  var _sanitizeElements = function _sanitizeElements(currentNode) {
    var content = void 0;

    /* Execute a hook if present */
    _executeHook('beforeSanitizeElements', currentNode, null);

    /* Check if element is clobbered or can clobber */
    if (_isClobbered(currentNode)) {
      _forceRemove(currentNode);
      return true;
    }

    /* Now let's check the element's type and name */
    var tagName = currentNode.nodeName.toLowerCase();

    /* Execute a hook if present */
    _executeHook('uponSanitizeElement', currentNode, {
      tagName: tagName,
      allowedTags: ALLOWED_TAGS
    });

    /* Take care of an mXSS pattern using p, br inside svg, math */
    if ((tagName === 'svg' || tagName === 'math') && currentNode.querySelectorAll('p, br').length !== 0) {
      _forceRemove(currentNode);
      return true;
    }

    /* Remove element if anything forbids its presence */
    if (!ALLOWED_TAGS[tagName] || FORBID_TAGS[tagName]) {
      /* Keep content except for black-listed elements */
      if (KEEP_CONTENT && !FORBID_CONTENTS[tagName] && typeof currentNode.insertAdjacentHTML === 'function') {
        try {
          var htmlToInsert = currentNode.innerHTML;
          currentNode.insertAdjacentHTML('AfterEnd', trustedTypesPolicy ? trustedTypesPolicy.createHTML(htmlToInsert) : htmlToInsert);
        } catch (error) {}
      }

      _forceRemove(currentNode);
      return true;
    }

    /* Remove in case a noscript/noembed XSS is suspected */
    if (tagName === 'noscript' && /<\/noscript/i.test(currentNode.innerHTML)) {
      _forceRemove(currentNode);
      return true;
    }

    if (tagName === 'noembed' && /<\/noembed/i.test(currentNode.innerHTML)) {
      _forceRemove(currentNode);
      return true;
    }

    /* Convert markup to cover jQuery behavior */
    if (SAFE_FOR_JQUERY && !currentNode.firstElementChild && (!currentNode.content || !currentNode.content.firstElementChild) && /</g.test(currentNode.textContent)) {
      DOMPurify.removed.push({ element: currentNode.cloneNode() });
      if (currentNode.innerHTML) {
        currentNode.innerHTML = currentNode.innerHTML.replace(/</g, '&lt;');
      } else {
        currentNode.innerHTML = currentNode.textContent.replace(/</g, '&lt;');
      }
    }

    /* Sanitize element content to be template-safe */
    if (SAFE_FOR_TEMPLATES && currentNode.nodeType === 3) {
      /* Get the element's text content */
      content = currentNode.textContent;
      content = content.replace(MUSTACHE_EXPR$$1, ' ');
      content = content.replace(ERB_EXPR$$1, ' ');
      if (currentNode.textContent !== content) {
        DOMPurify.removed.push({ element: currentNode.cloneNode() });
        currentNode.textContent = content;
      }
    }

    /* Execute a hook if present */
    _executeHook('afterSanitizeElements', currentNode, null);

    return false;
  };

  /**
   * _isValidAttribute
   *
   * @param  {string} lcTag Lowercase tag name of containing element.
   * @param  {string} lcName Lowercase attribute name.
   * @param  {string} value Attribute value.
   * @return {Boolean} Returns true if `value` is valid, otherwise false.
   */
  // eslint-disable-next-line complexity
  var _isValidAttribute = function _isValidAttribute(lcTag, lcName, value) {
    /* Make sure attribute cannot clobber */
    if (SANITIZE_DOM && (lcName === 'id' || lcName === 'name') && (value in document || value in formElement)) {
      return false;
    }

    /* Allow valid data-* attributes: At least one character after "-"
        (https://html.spec.whatwg.org/multipage/dom.html#embedding-custom-non-visible-data-with-the-data-*-attributes)
        XML-compatible (https://html.spec.whatwg.org/multipage/infrastructure.html#xml-compatible and http://www.w3.org/TR/xml/#d0e804)
        We don't need to check the value; it's always URI safe. */
    if (ALLOW_DATA_ATTR && DATA_ATTR$$1.test(lcName)) {
      // This attribute is safe
    } else if (ALLOW_ARIA_ATTR && ARIA_ATTR$$1.test(lcName)) {
      // This attribute is safe
      /* Otherwise, check the name is permitted */
    } else if (!ALLOWED_ATTR[lcName] || FORBID_ATTR[lcName]) {
      return false;

      /* Check value is safe. First, is attr inert? If so, is safe */
    } else if (URI_SAFE_ATTRIBUTES[lcName]) {
      // This attribute is safe
      /* Check no script, data or unknown possibly unsafe URI
        unless we know URI values are safe for that attribute */
    } else if (IS_ALLOWED_URI$$1.test(value.replace(ATTR_WHITESPACE$$1, ''))) {
      // This attribute is safe
      /* Keep image data URIs alive if src/xlink:href is allowed */
      /* Further prevent gadget XSS for dynamically built script tags */
    } else if ((lcName === 'src' || lcName === 'xlink:href' || lcName === 'href') && lcTag !== 'script' && value.indexOf('data:') === 0 && DATA_URI_TAGS[lcTag]) {
      // This attribute is safe
      /* Allow unknown protocols: This provides support for links that
        are handled by protocol handlers which may be unknown ahead of
        time, e.g. fb:, spotify: */
    } else if (ALLOW_UNKNOWN_PROTOCOLS && !IS_SCRIPT_OR_DATA$$1.test(value.replace(ATTR_WHITESPACE$$1, ''))) {
      // This attribute is safe
      /* Check for binary attributes */
      // eslint-disable-next-line no-negated-condition
    } else if (!value) {
      // Binary attributes are safe at this point
      /* Anything else, presume unsafe, do not add it back */
    } else {
      return false;
    }

    return true;
  };

  /**
   * _sanitizeAttributes
   *
   * @protect attributes
   * @protect nodeName
   * @protect removeAttribute
   * @protect setAttribute
   *
   * @param  {Node} currentNode to sanitize
   */
  // eslint-disable-next-line complexity
  var _sanitizeAttributes = function _sanitizeAttributes(currentNode) {
    var attr = void 0;
    var value = void 0;
    var lcName = void 0;
    var idAttr = void 0;
    var l = void 0;
    /* Execute a hook if present */
    _executeHook('beforeSanitizeAttributes', currentNode, null);

    var attributes = currentNode.attributes;

    /* Check if we have attributes; if not we might have a text node */

    if (!attributes) {
      return;
    }

    var hookEvent = {
      attrName: '',
      attrValue: '',
      keepAttr: true,
      allowedAttributes: ALLOWED_ATTR
    };
    l = attributes.length;

    /* Go backwards over all attributes; safely remove bad ones */
    while (l--) {
      attr = attributes[l];
      var _attr = attr,
          name = _attr.name,
          namespaceURI = _attr.namespaceURI;

      value = attr.value.trim();
      lcName = name.toLowerCase();

      /* Execute a hook if present */
      hookEvent.attrName = lcName;
      hookEvent.attrValue = value;
      hookEvent.keepAttr = true;
      _executeHook('uponSanitizeAttribute', currentNode, hookEvent);
      value = hookEvent.attrValue;

      /* Remove attribute */
      // Safari (iOS + Mac), last tested v8.0.5, crashes if you try to
      // remove a "name" attribute from an <img> tag that has an "id"
      // attribute at the time.
      if (lcName === 'name' && currentNode.nodeName === 'IMG' && attributes.id) {
        idAttr = attributes.id;
        attributes = apply(arraySlice, attributes, []);
        _removeAttribute('id', currentNode);
        _removeAttribute(name, currentNode);
        if (attributes.indexOf(idAttr) > l) {
          currentNode.setAttribute('id', idAttr.value);
        }
      } else if (
      // This works around a bug in Safari, where input[type=file]
      // cannot be dynamically set after type has been removed
      currentNode.nodeName === 'INPUT' && lcName === 'type' && value === 'file' && hookEvent.keepAttr && (ALLOWED_ATTR[lcName] || !FORBID_ATTR[lcName])) {
        continue;
      } else {
        // This avoids a crash in Safari v9.0 with double-ids.
        // The trick is to first set the id to be empty and then to
        // remove the attribute
        if (name === 'id') {
          currentNode.setAttribute(name, '');
        }

        _removeAttribute(name, currentNode);
      }

      /* Did the hooks approve of the attribute? */
      if (!hookEvent.keepAttr) {
        continue;
      }

      /* Take care of an mXSS pattern using namespace switches */
      if (/svg|math/i.test(currentNode.namespaceURI) && new RegExp('</(' + Object.keys(FORBID_CONTENTS).join('|') + ')', 'i').test(value)) {
        _removeAttribute(name, currentNode);
        continue;
      }

      /* Sanitize attribute content to be template-safe */
      if (SAFE_FOR_TEMPLATES) {
        value = value.replace(MUSTACHE_EXPR$$1, ' ');
        value = value.replace(ERB_EXPR$$1, ' ');
      }

      /* Is `value` valid for this attribute? */
      var lcTag = currentNode.nodeName.toLowerCase();
      if (!_isValidAttribute(lcTag, lcName, value)) {
        continue;
      }

      /* Handle invalid data-* attribute set by try-catching it */
      try {
        if (namespaceURI) {
          currentNode.setAttributeNS(namespaceURI, name, value);
        } else {
          /* Fallback to setAttribute() for browser-unrecognized namespaces e.g. "x-schema". */
          currentNode.setAttribute(name, value);
        }

        DOMPurify.removed.pop();
      } catch (error) {}
    }

    /* Execute a hook if present */
    _executeHook('afterSanitizeAttributes', currentNode, null);
  };

  /**
   * _sanitizeShadowDOM
   *
   * @param  {DocumentFragment} fragment to iterate over recursively
   */
  var _sanitizeShadowDOM = function _sanitizeShadowDOM(fragment) {
    var shadowNode = void 0;
    var shadowIterator = _createIterator(fragment);

    /* Execute a hook if present */
    _executeHook('beforeSanitizeShadowDOM', fragment, null);

    while (shadowNode = shadowIterator.nextNode()) {
      /* Execute a hook if present */
      _executeHook('uponSanitizeShadowNode', shadowNode, null);

      /* Sanitize tags and elements */
      if (_sanitizeElements(shadowNode)) {
        continue;
      }

      /* Deep shadow DOM detected */
      if (shadowNode.content instanceof DocumentFragment) {
        _sanitizeShadowDOM(shadowNode.content);
      }

      /* Check attributes, sanitize if necessary */
      _sanitizeAttributes(shadowNode);
    }

    /* Execute a hook if present */
    _executeHook('afterSanitizeShadowDOM', fragment, null);
  };

  /**
   * Sanitize
   * Public method providing core sanitation functionality
   *
   * @param {String|Node} dirty string or DOM node
   * @param {Object} configuration object
   */
  // eslint-disable-next-line complexity
  DOMPurify.sanitize = function (dirty, cfg) {
    var body = void 0;
    var importedNode = void 0;
    var currentNode = void 0;
    var oldNode = void 0;
    var returnNode = void 0;
    /* Make sure we have a string to sanitize.
      DO NOT return early, as this will return the wrong type if
      the user has requested a DOM object rather than a string */
    if (!dirty) {
      dirty = '<!-->';
    }

    /* Stringify, in case dirty is an object */
    if (typeof dirty !== 'string' && !_isNode(dirty)) {
      // eslint-disable-next-line no-negated-condition
      if (typeof dirty.toString !== 'function') {
        throw new TypeError('toString is not a function');
      } else {
        dirty = dirty.toString();
        if (typeof dirty !== 'string') {
          throw new TypeError('dirty is not a string, aborting');
        }
      }
    }

    /* Check we can run. Otherwise fall back or ignore */
    if (!DOMPurify.isSupported) {
      if (_typeof(window.toStaticHTML) === 'object' || typeof window.toStaticHTML === 'function') {
        if (typeof dirty === 'string') {
          return window.toStaticHTML(dirty);
        }

        if (_isNode(dirty)) {
          return window.toStaticHTML(dirty.outerHTML);
        }
      }

      return dirty;
    }

    /* Assign config vars */
    if (!SET_CONFIG) {
      _parseConfig(cfg);
    }

    /* Clean up removed elements */
    DOMPurify.removed = [];

    if (IN_PLACE) {
      /* No special handling necessary for in-place sanitization */
    } else if (dirty instanceof Node) {
      /* If dirty is a DOM element, append to an empty document to avoid
         elements being stripped by the parser */
      body = _initDocument('<!-->');
      importedNode = body.ownerDocument.importNode(dirty, true);
      if (importedNode.nodeType === 1 && importedNode.nodeName === 'BODY') {
        /* Node is already a body, use as is */
        body = importedNode;
      } else if (importedNode.nodeName === 'HTML') {
        body = importedNode;
      } else {
        // eslint-disable-next-line unicorn/prefer-node-append
        body.appendChild(importedNode);
      }
    } else {
      /* Exit directly if we have nothing to do */
      if (!RETURN_DOM && !SAFE_FOR_TEMPLATES && !WHOLE_DOCUMENT && RETURN_TRUSTED_TYPE && dirty.indexOf('<') === -1) {
        return trustedTypesPolicy ? trustedTypesPolicy.createHTML(dirty) : dirty;
      }

      /* Initialize the document to work on */
      body = _initDocument(dirty);

      /* Check we have a DOM node from the data */
      if (!body) {
        return RETURN_DOM ? null : emptyHTML;
      }
    }

    /* Remove first element node (ours) if FORCE_BODY is set */
    if (body && FORCE_BODY) {
      _forceRemove(body.firstChild);
    }

    /* Get node iterator */
    var nodeIterator = _createIterator(IN_PLACE ? dirty : body);

    /* Now start iterating over the created document */
    while (currentNode = nodeIterator.nextNode()) {
      /* Fix IE's strange behavior with manipulated textNodes #89 */
      if (currentNode.nodeType === 3 && currentNode === oldNode) {
        continue;
      }

      /* Sanitize tags and elements */
      if (_sanitizeElements(currentNode)) {
        continue;
      }

      /* Shadow DOM detected, sanitize it */
      if (currentNode.content instanceof DocumentFragment) {
        _sanitizeShadowDOM(currentNode.content);
      }

      /* Check attributes, sanitize if necessary */
      _sanitizeAttributes(currentNode);

      oldNode = currentNode;
    }

    oldNode = null;

    /* If we sanitized `dirty` in-place, return it. */
    if (IN_PLACE) {
      return dirty;
    }

    /* Return sanitized string or DOM */
    if (RETURN_DOM) {
      if (RETURN_DOM_FRAGMENT) {
        returnNode = createDocumentFragment.call(body.ownerDocument);

        while (body.firstChild) {
          // eslint-disable-next-line unicorn/prefer-node-append
          returnNode.appendChild(body.firstChild);
        }
      } else {
        returnNode = body;
      }

      if (RETURN_DOM_IMPORT) {
        /* AdoptNode() is not used because internal state is not reset
               (e.g. the past names map of a HTMLFormElement), this is safe
               in theory but we would rather not risk another attack vector.
               The state that is cloned by importNode() is explicitly defined
               by the specs. */
        returnNode = importNode.call(originalDocument, returnNode, true);
      }

      return returnNode;
    }

    var serializedHTML = WHOLE_DOCUMENT ? body.outerHTML : body.innerHTML;

    /* Sanitize final string template-safe */
    if (SAFE_FOR_TEMPLATES) {
      serializedHTML = serializedHTML.replace(MUSTACHE_EXPR$$1, ' ');
      serializedHTML = serializedHTML.replace(ERB_EXPR$$1, ' ');
    }

    return trustedTypesPolicy && RETURN_TRUSTED_TYPE ? trustedTypesPolicy.createHTML(serializedHTML) : serializedHTML;
  };

  /**
   * Public method to set the configuration once
   * setConfig
   *
   * @param {Object} cfg configuration object
   */
  DOMPurify.setConfig = function (cfg) {
    _parseConfig(cfg);
    SET_CONFIG = true;
  };

  /**
   * Public method to remove the configuration
   * clearConfig
   *
   */
  DOMPurify.clearConfig = function () {
    CONFIG = null;
    SET_CONFIG = false;
  };

  /**
   * Public method to check if an attribute value is valid.
   * Uses last set config, if any. Otherwise, uses config defaults.
   * isValidAttribute
   *
   * @param  {string} tag Tag name of containing element.
   * @param  {string} attr Attribute name.
   * @param  {string} value Attribute value.
   * @return {Boolean} Returns true if `value` is valid. Otherwise, returns false.
   */
  DOMPurify.isValidAttribute = function (tag, attr, value) {
    /* Initialize shared config vars if necessary. */
    if (!CONFIG) {
      _parseConfig({});
    }

    var lcTag = tag.toLowerCase();
    var lcName = attr.toLowerCase();
    return _isValidAttribute(lcTag, lcName, value);
  };

  /**
   * AddHook
   * Public method to add DOMPurify hooks
   *
   * @param {String} entryPoint entry point for the hook to add
   * @param {Function} hookFunction function to execute
   */
  DOMPurify.addHook = function (entryPoint, hookFunction) {
    if (typeof hookFunction !== 'function') {
      return;
    }

    hooks[entryPoint] = hooks[entryPoint] || [];
    hooks[entryPoint].push(hookFunction);
  };

  /**
   * RemoveHook
   * Public method to remove a DOMPurify hook at a given entryPoint
   * (pops it from the stack of hooks if more are present)
   *
   * @param {String} entryPoint entry point for the hook to remove
   */
  DOMPurify.removeHook = function (entryPoint) {
    if (hooks[entryPoint]) {
      hooks[entryPoint].pop();
    }
  };

  /**
   * RemoveHooks
   * Public method to remove all DOMPurify hooks at a given entryPoint
   *
   * @param  {String} entryPoint entry point for the hooks to remove
   */
  DOMPurify.removeHooks = function (entryPoint) {
    if (hooks[entryPoint]) {
      hooks[entryPoint] = [];
    }
  };

  /**
   * RemoveAllHooks
   * Public method to remove all DOMPurify hooks
   *
   */
  DOMPurify.removeAllHooks = function () {
    hooks = {};
  };

  return DOMPurify;
}

var purify = createDOMPurify();

return purify;

})));
//# sourceMappingURL=purify.js.map
;
define('core/utils/threadRatingsHelpers',[
    'core/utils/object/get',
], function (
    get
) {
    'use strict';

    var exports = {};

    /**
     * Checks if star ratings is enabled for a thread.
     *
     * DO NOT USE WITH BACKBONE MODELS
     *
     * Must check if it's enabled on the thread, forum, and as a saas feature. All flags must be on
     * to show star ratings, but the BE doesn't change every flag when one changes.
     *
     * @param  {Object}  thread - the thread to check if ratings are enabled
     * @param  {Object}  forum - the thread's forum
     * @returns {boolean} - whether or not star ratings is enabled on the thread
     */
    exports.isThreadRatingsEnabled = function (thread, forum) {
        // Ensure thread's forum matches with passed forum
        if (!thread || !thread.forum || !forum || forum.id !== thread.forum)
            return false;

        return Boolean(get(thread, ['ratingsEnabled']) && get(forum, ['settings', 'threadRatingsEnabled']) &&
            get(forum, ['features', 'threadRatings']));
    };

    /**
     * Checks if star ratings is enabled for a thread.
     *
     * Must be used with a Backbone model. This is kept separate from `isThreadRatingsEnabled`
     * to keep each function simpler.
     *
     * Must check if it's enabled on the thread, forum, and as a saas feature. All flags must be on
     * to show star ratings, but the BE doesn't change every flag when one changes.
     *
     * @param  {Object}  thread - Backbone model for the thread to check if ratings are enabled
     * @returns {boolean} - whether or not star ratings is enabled on the thread
     */
    exports.isThreadModelRatingsEnabled = function (thread) {
        if (!thread || !thread.forum)
            return false;

        var forumSettings = thread.forum.get('settings');
        var forumFeatures = thread.forum.get('features');

        return Boolean(thread.get('ratingsEnabled') &&
            forumSettings && forumSettings.threadRatingsEnabled &&
            forumFeatures && forumFeatures.threadRatings);
    };

    /**
     * Checks if star ratings is enabled for a forum.
     *
     * DO NOT USE WITH BACKBONE MODELS
     *
     * Must check if it's enabled the forum and as a saas feature. Both flags must be on
     * to show star ratings, but the BE doesn't change both flags when one changes.
     *
     * @param  {Object}  forum - the forum to check if ratings are enabled
     * @returns {boolean} - whether or not star ratings is enabled on the forum
     */
    exports.isForumRatingsEnabled = function (forum) {
        if (!forum)
            return false;

        return Boolean(get(forum, ['settings', 'threadRatingsEnabled']) &&
            get(forum, ['features', 'threadRatings']));
    };

    /**
     * Checks if star ratings is enabled for a forum.
     *
     * Must be used with a Backbone model. This is kept separate from `isForumRatingsEnabled`
     * to keep each function simpler.
     *
     * Must check if it's enabled the forum and as a saas feature. Both flags must be on
     * to show star ratings, but the BE doesn't change both flags when one changes.
     *
     * @param  {Object}  forum - the forum to check if ratings are enabled
     * @returns {boolean} - whether or not star ratings is enabled on the forum
     */
    exports.isForumModelRatingsEnabled = function (forum) {
        if (!forum)
            return false;

        var forumSettings = forum.get('settings');
        var forumFeatures = forum.get('features');

        return Boolean(forumSettings && forumSettings.threadRatingsEnabled &&
            forumFeatures && forumFeatures.threadRatings);
    };

    return exports;
});

define('core/models/Thread',[
    'underscore',
    'backbone',
    'loglevel',

    'core/config/urls',

    'core/utils',
    'core/api',
    'core/config',
    'core/advice',
    'core/UniqueModel',
    'core/utils/threadRatingsHelpers',

    'core/models/User',
], function (
    _,
    Backbone,
    logger,

    urls,

    utils,
    api,
    config,
    advice,
    UniqueModel,
    threadRatingsHelpers,

    User
) {
    'use strict';

    var parent = Backbone.Model;
    var parentProto = parent.prototype;


    var Thread = parent.extend({
        defaults: {
            author: null,
            category: null,
            createdAt: null,  // Date time in string. Format: YYYY-MM-DDTHH:mm:ss
            forum: null,
            identifiers: [],
            ipAddress: null,
            isClosed: false,
            isDeleted: false,
            hasStreaming: false,
            link: null,  // Direct url to this thread
            message: null,
            slug: null,
            title: null,
            userSubscription: false,

            // Counters
            posts: 0,
            likes: 0,
            dislikes: 0,
            userScore: 0,
        },

        initialize: function (_attributes, options) {
            options = options || {};

            // Array of moderator ids for this thread (integers)
            this.moderators = options.moderators;

            this.forum = options.forum;

            this.on('change:userScore', function () {
                var userScore = this.get('userScore');

                // If the user voted this Thread but likes is 0, means we got a
                // cached result for likes, so update it to not confuse the user
                if (userScore > 0 && this.get('likes') === 0)
                    this.set('likes', userScore);

                // NOTE: Note that we don't handle dislikes and negative user
                //       votes above since we don't have that concept yet.
            }, this);
        },

        _vote: function (vote, score) {
            var delta = vote - score;

            // If the vote is unchanged, ignore it.
            if (delta === 0)
                return delta;

            this.set('likes', this.get('likes') + delta);
            return delta;
        },

        vote: function (vote) {
            var self = this;
            var delta = self._vote(vote, self.get('userScore'));

            if (delta === 0)
                return;

            this.set('userScore', vote);

            api.call('threads/vote.json', {
                data: {
                    thread: this.id,
                    vote: vote,
                },
                method: 'POST',
                success: function (data) {
                    if (!data.response.id)
                        return;

                    self.trigger('vote:success', data);
                },
            });
        },

        fetch: function (options) {
            var self = this;
            var attrs = self.attributes;
            var query;

            options = options || {};

            if (attrs.identifier)
                query = 'ident:' + attrs.identifier;
            else
                query = 'link:' + attrs.url;

            api.call('threads/details.json', {
                data: {
                    thread: query,
                    forum: attrs.forum,
                },

                success: function (data) {
                    self.set(data.response);
                    if (options.success) options.success();
                },

                error: function () {
                    if (config.debug)  // Create a new thread
                        self.save({}, { success: options.success });
                    else  // For Alpha release only.
                        logger.info('Couldn\'t find thread; not creating in production.');
                },
            });
        },

        _toggleState: function (isOpen, options) {
            if (!options)
                options = {};

            var action = isOpen ? 'open.json' : 'close.json';
            this.set('isClosed', !isOpen);

            return api.call('threads/' + action, {
                method: 'POST',
                data: {
                    thread: this.id,
                },
                success: options.success,
                error: options.error,
            });
        },

        open: function (options) {
            return this._toggleState(true, options);
        },

        close: function (options) {
            return this._toggleState(false, options);
        },

        /**
         * Change the thread's premoderation status. Auth'd user must have write
         * privileges for the thread.
         *
         * @param {boolean} isPremoderated - the new premoderation status
         * @param {Object} [options] - options to pass to the api call
         * @returns {jqXHR}
         */
        premoderate: function (isPremoderated, options) {
            this.set('validateAllPosts', isPremoderated);

            return api.call('threads/update', _.extend({}, options, {
                method: 'POST',
                data: _.extend({
                    thread: this.id,
                    validateAllPosts: isPremoderated ? 1 : 0,
                }, options && options.data),
            }));
        },

        sync: function () {
            var self = this;
            var attrs = self.attributes;

            api.call('threads/create.json', {
                data: {
                    title: attrs.title,
                    forum: attrs.forum,
                    identifier: attrs.identifier,
                    url: attrs.url,
                },
                method: 'POST',
                success: function (data) {
                    self.set(data.response);
                },
            });
        },

        fetchRatings: function () {
            var self = this;

            var data = { thread: self.id };

            return api.call('threads/ratingsSummary.json', {
                data: data,
                method: 'GET',
                success: function (response) {
                    self.set('ratings', response.response);
                },
            });
        },

        toggleRatingsEnabled: function () {
            var self = this;
            if (!threadRatingsHelpers.isForumModelRatingsEnabled(self.forum))
                return;

            var ratingsEnabled = self.get('ratingsEnabled');

            var data = {
                thread: self.id,
                ratingsEnabled: ratingsEnabled ? 0 : 1, // invert the ratings enabled
            };

            self.set('ratingsEnabled', !ratingsEnabled);

            return api.call('threads/update.json', {
                data: data,
                method: 'POST',
            });
        },

        /**
         * Increment the reported count of posts for this thread.
         *
         * You cannot decrement the post count below 0.
         * @param  {number} inc A positive or negative number
         */
        incrementPostCount: function (inc) {
            var count = this.get('posts') + inc;
            this.set('posts', count > 0 ? count : 0);
        },

        isModerator: function (user) {
            // Accepts user instance or user id and returns true, false,
            // or undefined (if function cannot determine)
            var id;

            if (!this.moderators)
                return;

            id = user instanceof User || _.isObject(user) ? user.id : user;
            id = parseInt(id, 10);
            return _(this.moderators).contains(id);
        },

        subscribe: function (subscribe) {
            subscribe = subscribe !== false;  // default is to subscribe

            // the below can be a boolean or the e-mail used to subscribe
            var currentSubscription = this.get('userSubscription');
            if (currentSubscription === subscribe)
                return;  // do nothing if the state is same

            this.set('userSubscription', subscribe);

            var endpoint = subscribe ? 'subscribe.json' : 'unsubscribe.json';
            var data = { thread: this.id };

            return api.call('threads/' + endpoint, {
                data: data,
                method: 'POST',
            });
        },

        twitterText: function (url) {
            var charsRemaining = 140 - (url.length + 1);  // +1 for space before url
            var text = this.get('clean_title');
            text = utils.niceTruncate(text, charsRemaining);
            return text;
        },

        permalink: function () {
            // Sometimes url or link isn't available. In which case, use the "current
            // URL", which is the referring URL that opened the current embed context
            return this.get('url') || this.get('link') || this.currentUrl;
        },

        shortLink: function () {
            return urls.shortener + '/t/' + Number(this.id).toString(36);
        },

        toJSON: function () {
            var json = parentProto.toJSON.call(this);

            json.permalink = this.permalink();
            json.shortLink = this.shortLink();

            return json;
        },

        /**
         * Returns a full path to the discussion page on home for this thread.
         *
         * If channel is given, or if this thread is on the primary forum
         * for a channel, the discussion page will contain a link to the
         * channel.
         *
         * @param {Channel} [channel] - the channel the discussion page is to link to
         * @returns {string}
         */
        getDiscussionRoute: function (channel) {
            var route = [
                '',  // for leading slash
                'home',
                'discussion',
                this.forum.id,
                this.get('slug'),
                '',  // for trailing slash
            ];

            channel = channel || this.forum.channel;
            if (channel) {
                channel = channel.attributes || channel;
                route.splice(2, 0, 'channel', channel.slug);
            }

            return route.join('/');
        },
    });

    advice.withAdvice.call(Thread.prototype);


    Thread.withThreadVoteCollection = function (ThreadVoteCollection) {
        this.after('initialize', function () {
            this.votes = new ThreadVoteCollection();

            this.on('vote:success', function (data) {
                if (this.votes.get(data.response.id))
                    return;

                this.votes.add({
                    id: data.response.id,
                    score: data.response.vote, // TODO

                    // mark this vote as made by current user so we can ignore
                    // it when it comes through realtime
                    currentUser: true,
                });

            }, this);
        });
    };

    Thread.withPostCollection = function (PostCollection) {
        this.after('initialize', function (options) {
            options = options || {};
            this.posts = new PostCollection(options.posts, {
                thread: this,
                cursor: options.postCursor,
                order: options.order,
                perPage: this.postsPerPage,
            });

            this.listenTo(this.posts, 'add reset', function (posts) {
                // Reset returns Collection object, so can't use
                posts = posts.models ? posts.models : [posts];

                if (this.users) {
                    _.each(posts, function (post) {
                        if (!this.users.get(post.author.id))
                            this.users.add(post.author);
                    });
                }

                this.recalculatePostCount();
            });

            this.listenTo(
                this.posts,
                'change:isDeleted change:isFlagged',
                function (_post, value) {
                    // If isDeleted or isFlagged is true then we decrement the post count.
                    if (value)
                        this.incrementPostCount(-1);
                }
            );
        });

        /**
         * Recalculate `posts` attribute of this thread.
         *
         * If the current reported post count is 50 or less then we manually count how many
         * of the posts we currently have on the page are publicly visible.
         * If the API reported more than 50 then we don't care about accuracy as much.
         */
        this.recalculatePostCount = function () {
            var count = this.get('posts');
            if (count > 50)
                return;

            // We want to count _all_ the posts that we have, not
            // just the posts that we're displaying.
            count = this.posts.reduce(function (memo, post) {
                return post.isPublic() ? memo + 1 : memo;
            }, 0);
            this.set('posts', count);
        };
    };

    UniqueModel.addType('Thread', Thread);

    return Thread;
});

define('home/models/Topic',[
    'underscore',
    'backbone',

    'core/strings',

    'core/UniqueModel',
], function (
    _,
    Backbone,

    strings,

    UniqueModel
) {
    'use strict';

    var gettext = strings.get;

    var Topic = Backbone.Model.extend({
        idAttribute: 'identifier',
        defaults: {
            identifier: null,
            displayName: null,
        },

        validate: function (attrs) {
            var topicName = attrs.displayName;
            if (!topicName) {
                return {
                    attrName: 'displayName',
                    message: gettext('Topic name cannot be empty.'),
                };
            }

            var nameRanges = Topic.TOPIC_NAME_RANGES;

            if (topicName.length > nameRanges.maxLength ||
                topicName.length < nameRanges.minLength) {

                return {
                    attrName: 'displayName',
                    message: strings.interpolate(
                        gettext('A topic must be between %(minLength)s and %(maxLength)s characters.'), {
                            minLength: nameRanges.minLength,
                            maxLength: nameRanges.maxLength,
                        }
                    ),
                };
            }
        },
    }, {

        TOPIC_NAME_RANGES: {
            minLength: 2,
            maxLength: 30,
        },

        cleanTopicName: function (topicName) {
            return topicName
                // Remove extra whitespace
                .replace(/\s+/g, ' ')
                .trim();
        },

        getOrCreateTopic: function (displayName) {
            var cleanDisplayName = Topic.cleanTopicName(displayName);

            if (!cleanDisplayName)
                return null;

            // Search for an existing topic with the same display name. Ignore casing,
            // different casings map to the same topic.
            var lowerTopicName = cleanDisplayName.toLowerCase();
            var existing = _.find(UniqueModel.pool(Topic), function (topic) {
                return topic.get('displayName').toLowerCase() === lowerTopicName;
            });

            // Existing topic found, return.
            if (existing)
                return existing;

            return new UniqueModel(Topic, {
                displayName: cleanDisplayName,
            });
        },

    });

    UniqueModel.addType('Topic', Topic);

    return Topic;
});

define('home/collections/TopicCollection',[
    'underscore',
    'backbone',

    'home/models/Topic',
    'core/UniqueModel',

    'core/api',
    'core/strings',
], function (
    _,
    Backbone,

    Topic,
    UniqueModel,

    api,
    strings
) {
    'use strict';

    var gettext = strings.get;

    var TopicCollection = Backbone.Collection.extend({
        model: UniqueModel.boundModel(Topic),

        initialize: function (_models, options) {
            if (options && options.thread)
                this.thread = options.thread;
        },

        /**
         * Returns the intersection of topics in this collection and categories
         * on the channel for this collection's thread, case insensitive.
         * Technically this can return more than 1, ex: during editing a user
         * may input more than 1 category as a topic. Validation should prevent
         * a thread from being saved with more or less than 1 returned category.
         */
        getCategoryTopics: function () {
            var channel = this.thread.forum.channel;
            var categories = channel.getCategories();

            if (!categories)
                return [];

            categories = categories && _.keys(categories);
            return this.filter(function (topic) {
                var lowerDisplayName = topic.get('displayName').toLowerCase();

                return _.find(categories, function (category) {
                    return Topic.cleanTopicName(category).toLowerCase() === lowerDisplayName;
                });
            });
        },

        isValid: function () {
            var error = this.validationError = this.validate() || null;
            if (!error)
                return true;

            this.trigger('invalid', this, error, { validationError: error });
            return false;
        },

        validate: function () {
            // First check for topics invalid on their own
            var invalidModel = this.find(function (topic) {
                return !topic.isValid();
            });

            if (invalidModel)
                return invalidModel.validationError;

            // No restrictions on topic collections not bound to a thread
            if (!this.thread)
                return;

            // Check max length. Only check non-hidden topics (those editable by and
            // visible to the user).
            var countsByHidden = this.countBy(function (topic) {
                return topic.get('hidden') ? 'hidden' : 'visible';
            });
            if (countsByHidden.visible > TopicCollection.MAX_LENGTH) {
                return {
                    attrName: 'topics',
                    message: strings.interpolate(gettext('You may not have more than %(num)s topics'), { num: TopicCollection.MAX_LENGTH }),
                };
            }

            var channel = this.thread.forum.channel;
            var categories = channel && channel.getCategories();
            if (categories) {
                var chosenCategories = this.getCategoryTopics();

                if (chosenCategories.length < 1) {
                    return {
                        attrName: 'category',
                        message: gettext('You must choose a category'),
                    };
                }

                var collidesWithCategory = _.any(
                    chosenCategories,
                    function (category) { return !category.get('hidden'); }
                );
                if (collidesWithCategory) {
                    return {
                        attrName: 'topics',
                        message: gettext('You may not enter a category as a topic'),
                    };
                }
            }
        },

        _syncTopicsOnThread: function (topics, method) {
            var options = {
                url: this.urls[method],
                type: 'POST',
                processData: true,
                emulateHTTP: true,
                data: {
                    thread: this.thread.id,
                    topics: _.map(topics, function (item) {
                        return item.get('displayName');
                    }),
                },
            };

            return Backbone.sync(method, this, options);
        },

        urls: {
            'addTopicsToThread': api.getURL('timelines/curation/addTopicsToThread'),
            'removeTopicsFromThread': api.getURL('timelines/curation/removeTopicsFromThread'),
        },

        save: function () {
            if (!this.thread || !this.isValid())
                return;

            var syncedTopics = this.thread.topics.models;
            var addedTopics = _.difference(this.models, syncedTopics);
            var removedTopics = _.difference(syncedTopics, this.models);
            var thread = this.thread;

            if (addedTopics.length) {
                this._syncTopicsOnThread(addedTopics, 'addTopicsToThread').then(function (response) {
                    if (response.response) {
                        // Endpoint returned topic details: consistent casing for display names and
                        // identifiers. Add these full topics to the thread's topic collection.
                        thread.topics.add(_.map(response.response, function (attrs) {
                            return new UniqueModel(Topic, attrs);
                        }));
                    }
                });
            }

            if (removedTopics.length) {
                this._syncTopicsOnThread(removedTopics, 'removeTopicsFromThread').then(function () {
                    thread.topics.remove(removedTopics);
                });
            }
        },

        parse: function (response) {
            return response.response;
        },
    }, {
        MAX_LENGTH: 5,
    });

    return TopicCollection;
});

define('home/templates/confirmDeleteThread',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"modal-header\">\n<h4 class=\"modal-title\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Remove %(discussionTitle)s?",{"name":"gettext","hash":{"discussionTitle":lookupProperty(helpers,"tag").call(alias1,"b",{"name":"tag","hash":{"text":(depth0 != null ? lookupProperty(depth0,"title") : depth0)},"data":data,"loc":{"start":{"line":2,"column":82},"end":{"line":2,"column":104}}})},"data":data,"loc":{"start":{"line":2,"column":24},"end":{"line":2,"column":106}}}))
    + "</h4>\n</div>\n<div class=\"modal-body\">\n<p>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Click Confirm to remove and close the discussion so it can't be easily found. This prevents new comments from being posted.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":5,"column":3},"end":{"line":5,"column":140}}}))
    + "</p>\n</div>\n";
},"useData":true})

});
define('home/utils/datetimeUtils',[
    'moment',
], function (
    moment
) {
    'use strict';

    var ISO_8601 = 'YYYY-MM-DDTHH:mm:ssZ';

    var assureTzOffset = function (createdAt) {
        return createdAt.indexOf('+') >= 0 ? createdAt : createdAt + '+00:00';
    };

    var getRelativeDatetime = function (datetime) {
        if (!datetime || datetime === Infinity)
            return null;

        datetime = assureTzOffset(datetime);
        return moment
            .utc(datetime, ISO_8601) // Input time as UTC
            .local()                 // Convert to local
            .fromNow();
    };

    return {
        getRelativeDatetime: getRelativeDatetime,
    };
});

define('home/models/Thread',[
    'jquery',
    'underscore',
    'backbone',
    'dompurify',

    'core/api',
    'core/bus',
    'core/models/mixins',
    'core/models/Thread',
    'core/UniqueModel',
    'core/utils',
    'core/utils/auth',
    'core/utils/html',

    'home/collections/common/ExtensibleCollection',
    'home/collections/TopicCollection',
    'home/models/Forum',
    'home/models/User',
    'home/models/Post',
    'home/templates/confirmDeleteThread',
    'home/utils/backboneUtils',
    'home/utils/datetimeUtils',
    'home/utils/confirmModal',
    'home/utils/navigationUtils',
], function (
    $,
    _,
    Backbone,
    dompurify,

    api,
    bus,
    mixins,
    BaseThread,
    UniqueModel,
    utils,
    auth,
    html,

    ExtensibleCollection,
    TopicCollection,
    Forum,
    User,
    Post,
    confirmDeleteThreadTemplate,
    backboneUtils,
    datetimeUtils,
    confirmModal,
    navigationUtils
) {
    'use strict';

    var SHARER_ENCODING_BASE = 36;

    // An "original thread" is a thread created on Home.
    // For original threads our backend returns a thread.link value
    // of the form: https://<forum_shortname>.disqus.com/thread/<slug>
    var originalThreadUrlRegex = /^https:\/\/[^.]+\.disqus\.com\/thread\//;

    var parent = BaseThread;
    var parentProto = parent.prototype;


    var Thread = parent.extend({
        defaults: _.defaults({
            id: null,

            content: { // populated by Embedly
                title: '',
                description: '',
                keywords: [],
                image: {
                    url: '',
                    height: '',
                    width: '',
                },
            },

            // Used when starting a discussion to supplement the
            // discussion/thread title
            message: undefined, // e.g., a caption or a link

            // Whether or not the currently authenticated user can moderate/
            // can edit/is the author of this thread.
            // These are computed and may change to true after initialization.
            canModerate: false,
            canEdit: false,
            isAuthor: false,
        }, parentProto.defaults),

        initialize: function (attrs, options) {
            parentProto.initialize.call(this, attrs, options);

            this.initializeRelated('forum', options, Forum, 'name');

            this.listenTo(this, 'change:forum', function (_thread, value) {
                if (!(value instanceof Backbone.Model))
                    this.forum.set(value);
            });

            this.listenTo(this, 'change:author', function (_thread, author) {
                this.setAuthor(author);
            });

            this.listenTo(this, 'change:message', this._clearDescriptions);

            this.topics = new TopicCollection([], { thread: this });
            var self = this;
            backboneUtils.getPromiseFor(this, 'topics').then(function (topics) {
                self.topics.add(topics);

                // Unset attribute once values have been copied to the Collection
                self.unset('topics');
            });

            this.checkUserGenerated(options);

            this.listenTo(this, 'change:userSubscription', this.onChangeUserSubscription);
        },

        onChangeUserSubscription: function (_model, isSubscribed) {
            // Propagate subscription change event to session user
            var Session = require('home/models/Session');
            var session = Session.get();
            session.loadPromise().always(_.bind(function () {
                session.user.trigger(isSubscribed ? 'subscribe:thread' : 'unsubscribe:thread', this);
            }, this));
        },

        validate: function (attrs) {
            if (!attrs.title || !attrs.title.trim()) {
                return {
                    attrName: 'title',
                    message: 'Please enter a title for your discussion.',
                };
            }

            if (attrs.title.length > 200) {
                return {
                    attrName: 'title',
                    message: 'Please shorten your title.',
                };
            }

            if (!attrs.message || attrs.message.trim().length < 2) {
                return {
                    attrName: 'message',
                    message: 'Please enter a longer discussion body',
                };
            }

            var channelCategories = this.forum.channel && this.forum.channel.getCategories();
            if (channelCategories) {
                var chosenCategory = _.chain(channelCategories).keys().find(function (category) {
                    return attrs.title.indexOf(category) === 0;
                }).value();

                // Leave the validation of categories to topic collection's validation.
                // Just validate title here.

                if (chosenCategory && !attrs.title.match(new RegExp(chosenCategory + '.*\\w+'))) {
                    return {
                        attrName: 'title',
                        message: 'Your title must contain more than just a category.',
                    };
                }
            }
        },

        checkUserGenerated: function (options) {
            options = options || {};

            // Cannot initialize this as a User Generated Thread until the details have
            // been fetched
            if (this.shouldFetch()) {
                this.listenToOnce(this, 'sync', _.bind(this.checkUserGenerated, this, options));
                return;
            }

            if (!this.forum.channel) {
                this.set({
                    isUserGenerated: false,
                });

                // No futher work required for non-User Generated Threads.
                return;
            }

            this.setAuthor(options.author);
            this.initializeRecentPosts(options);

            this.set({
                isUserGenerated: true,
            });
        },

        setAuthor: function (author) {
            author = author || this.get('author');

            if (this.author) {
                if (_.isObject(author))
                    this.author.set(author);
            } else if (_.isObject(author)) {
                this.initializeRelated('author', { author: author }, User);
            } else {
                author = this.getAuthorFromUniqueModel(author);
                if (author)
                    this.author = author;
            }
        },

        getAuthorFromUniqueModel: function (author) {
            if (!_.isString(author) || !author.length)
                return;

            return _.find(UniqueModel.pool(User), function (user) {
                return user.get('id') === author;
            });
        },

        fetchAuthor: function () {
            var author = this.get('author');
            var model;

            model = this.getAuthorFromUniqueModel(author);
            if (model) {
                this.setAuthor(model);
                return $.Deferred().resolve(model).promise();
            }

            model = new User({ id: author });
            return model.fetch().then(_.bind(function () {
                this.setAuthor(model.attributes);
            }, this));
        },

        initializeRecentPosts: function (options) {
            if (!Post)
                Post = require('home/models/Post');

            this.recentPosts = new Backbone.Collection(
                _.map(options.recentPosts,
                    function (post) {
                        if (post instanceof Post)
                            return post;

                        return new UniqueModel(Post,
                            post,
                            { thread: this }
                        );
                    },
                    this
                ));
        },

        getLinks: function () {
            var links = [];

            if (this.get('isUserGenerated'))
                links = this.getLinksFromMessage();
            else
                links = [this.get('link')];

            return links;
        },

        getFriendlySourceUrl: function () {
            var friendlyUrl = utils.getDomain(this.get('link'));
            return friendlyUrl.indexOf('disqus.com') > -1 ? 'disqus.com' : friendlyUrl;
        },

        getLinksFromMessage: _.memoize(function () {
            var $wrapper = $('<div>').html(this.get('message'));
            return $wrapper.find('a[href]').map(function (__, el) {
                return $(el).attr('href');
            });
        }, function () {
            return this.id;
        }),

        shouldFetch: function () {
            return !this.get('clean_title');
        },

        url: function (type) {
            return this.urls[type] || this.urls.read;
        },

        urls: {
            'read': api.getURL('threads/details'),
            'create': api.getURL('threads/create'),
            'update': api.getURL('threads/update'),
            'delete': api.getURL('threads/remove'),
            'restore': api.getURL('threads/restore'),
            'inviteUserGroup': api.getURL('threads/inviteUserGroup'),
            'approve': api.getURL('threads/approve'),
            'spam': api.getURL('threads/spam'),
        },

        buildFetchData: function (existing) {
            var data;

            if (this.get('id')) {
                data = {
                    thread: this.get('id'),
                };
            } else if (this.get('slug') && this.forum.id) {
                data = {
                    thread: 'slug:' + this.get('slug'),
                    forum: this.forum.id,
                };
            } else {
                throw new Error('Cannot fetch thread without an id or a slug plus forum');
            }

            return _.extend(data, existing);
        },

        fetch: function (options) {
            if (this.fetchPromise)
                return this.fetchPromise;

            options = options || {};
            options.data = _.extend(this.buildFetchData(), options.data);

            // Topics must be requested explicitly for threads
            options.data.attach = options.data.attach || [];
            options.data.attach.push('topics');

            if (this.forum.shouldFetch()) {
                options.data.related = options.data.related || [];
                options.data.related.push('forum');
            }

            this.fetchPromise = Backbone.Model.prototype.fetch.call(this, options);

            var self = this;
            this.fetchPromise.always(function () {
                self.fetchPromise = null;
            });

            return this.fetchPromise;
        },

        sync: function (method, self, options) {
            var attrs = self.attributes;
            options = options || {};

            options.url = this.url(method);

            // Must set processData to true, otherwise Backbone.sync sets it to false,
            // which results in a POST body of '[object Object]' to the API endpoint
            options.processData = true;

            // Must set emulateHTTP to true so that the request type will be POST instead
            // of PUT/DELETE/PATCH
            options.emulateHTTP = true;

            switch (method) {
            case 'create':
                var forum = attrs.forum;
                if (!attrs.forum)
                    forum = this.forum.id;


                options.data = _.extend({
                    title: attrs.title,
                    forum: forum,
                    message: attrs.message,
                }, options.data);

                break;
            case 'update':
                // Update the only fields that are updatable through home
                var updatable = {
                    title: attrs.title,
                    message: attrs.message,
                };

                options.data = _.extend({ thread: attrs.id }, updatable);
                break;
            case 'delete':
                options.data = _.extend({ thread: attrs.id }, options.data);
                break;
            case 'restore':
            case 'inviteUserGroup':
            case 'spam':
            case 'approve':
                // TODO: we should only use sync for crud operations, so this case should be moved to it's own RPC type method in the future.
                options.data = _.extend({ thread: attrs.id }, options.data);
                options.type = 'POST';
                break;
            }

            // TODO - call base class sync method
            return Backbone.sync(method, self, options);
        },

        parse: function (resp) {
            // resp differs depending on whether model.parse
            // is called as a result of model.fetch or collection.fetch
            return resp.response || resp;
        },

        toJSON: function () {
            var json = parentProto.toJSON.call(this);

            _.extend(json, {
                forum: this.forum.toJSON(),
                author: this.author ? this.author.toJSON() : undefined,
            });

            if (!json.link) {
                // try to make link go to the Discussion page on Home
                if (json.slug)
                    json.link = this.getDiscussionRoute();
            } else if (originalThreadUrlRegex.test(json.link)) {
                json.link = this.getDiscussionRoute();
            }

            return json;
        },

        getThread: function () {
            return this;
        },

        getHostname: function () {
            var url = this.get('link');
            if (!url)
                return '';

            var anchor = $('<a>').attr('href', url)[0];

            return anchor.hostname || url;
        },

        // Deprecated
        getRelativeCreatedAt: function () {
            return datetimeUtils.getRelativeDatetime(this.get('createdAt'));
        },

        // Deprecated
        getRelativeCommentTimestamp: function () {
            return datetimeUtils.getRelativeDatetime(this.get('most_recent_comment_timestamp'));
        },

        // Deprecated
        // Returns the user details of the most recent commenter, if
        // the most recent commenter exists and is not anonymous
        getMostRecentCommenter: function () {
            var commenter = this.get('most_recent_commenter');
            if (commenter && !commenter.isAnonymous)
                return commenter;
        },

        // Extends this model with embedly data
        setEmbedlyData: function (data) {
            this.set({
                content: {
                    title: dompurify.sanitize(data.title),
                    description: dompurify.sanitize(data.description),
                    image: data.images && data.images[0] || {},
                    keywords: data.keywords.length ?
                        data.keywords.map(function (kword) { return dompurify.sanitize(kword); }).slice(0, 3) :
                        [],
                },
            });
        },

        getImage: function () {
            var image;
            if (this.get('isUserGenerated'))
                image = this.getUserGeneratedImage();

            return image || this.getEmbedlyImage();
        },

        getEmbedlyImage: function () {
            var content = this.get('content');
            if (content && content.image && content.image.url && this.hasValidImageUrl(content.image)) {
                return {
                    src: content.image.url,
                    title: this.get('title'),
                };
            }
        },

        hasValidImageUrl: function (image) {
            // Check that url param from returned cdn image link isn't empty
            var matches = image.url.match(/url=([^&]+)/m);
            return matches && matches.length > 1 && matches[1].length;
        },

        getUserGeneratedImage: function () {
            var media = this.getMedia();
            var firstMedia = media && media[0];

            if (firstMedia && firstMedia.thumbnailUrl) {
                return {
                    src: firstMedia.thumbnailUrl,
                    title: firstMedia.title,
                };
            }
        },

        getMedia: function () {
            return this.get('media');
        },

        hasPreview: function () {
            var content = this.get('content');
            return Boolean(content && (content.image.url || content.description));
        },

        // TODO - rename to use 'vote' terminology like base class
        toggleFavorited: function () {
            var vote = this.get('userScore') ? 0 : 1;

            if (vote === 1)
                bus.trigger('threadFavorited', this);

            parentProto.vote.call(this, vote);
        },

        toggleIsSpam: function () {
            this.markAsSpam(!this.get('isSpam'));
        },

        /**
         * Marks the thread as either spam or not spam, as specified by
         * the given argument. If nothing is passed, will mark as spam.
         * @param  {boolean} [isSpam] - Whether or not this thread is spam.
         *                              Defaults to true.
         */
        markAsSpam: function (isSpam) {
            // Default to true
            isSpam = isSpam !== false;

            var onSuccess = _.bind(this.set, this, 'isSpam', isSpam);
            this.sync(isSpam ? 'spam' : 'approve', this).then(onSuccess);
        },

        /**
          * Returns the embedly excerpt of the default embedly length
          * of 70 words.
          * @returns {string} - description shortened to 70 words
          */
        getDefaultDescription: function () {
            return this._getDescription(70);
        },

        /**
         * Returns the embedly excerpt of the short embedly length
         * of 50 words.
         * @returns {string} - description shortened to 70 words
         */
        getShortDescription: function () {
            return this._getDescription(50);
        },

        /**
          * Returns a longer embedly excerpt than default. Used in
          * views such as the discussion cover view.
          * @returns {string} - description shortened to 200 words
          */
        getLongDescription: function () {
            return this._getDescription(200);
        },

        getFullDescription: function () {
            return this._getDescription(Infinity);
        },

        /**
         * Returns a plain text description without any HTML,
         * URLs or newlines
         * @returns {string} - description with tags removed
         */
        getPlainDescription: function () {
            // Important to call strip tags before truncating.
            // Use getFullDescription to get the proper description field
            // and gaurantee a string is returned (possibly empty)
            return this._truncate(html.stripTags(this.getFullDescription()), 50);
        },

        /**
          * Returns the thread description truncated to roughly numWords.
          * @param {number} numWords - target number of words
          * @returns {string}        - thread description truncated
          */
        _getDescription: function (numWords) {
            // Try to use an earlier truncated description for the given numWords
            if (this.descriptions && this.descriptions[numWords])
                return this.descriptions[numWords];

            var description;

            if (this.get('isUserGenerated'))
                description = this.get('message');
            else if (this.has('content'))
                description = this.get('content').description;

            if (!description || !numWords)
                return '';

            var truncated = this._truncate(description, numWords);
            if (this.get('shouldSanitizeMessage'))
                truncated = _.escape(truncated);
            this._storeDescription(truncated, numWords);
            return truncated;
        },

        /**
          * Returns the given text truncated to roughly numWords.
          * This returns a number of words as close to the given number
          * of words as possible while maintaining full sentences.
          * @param {string} text     - given text
          * @param {number} numWords - target number of words
          * @returns {string}        - given text truncated
          */
        _truncate: function (text, numWords) {
            var words = text.split(' ');
            var wordsLength = words.length;

            // Not enough words to return. Return as much as possible.
            if (numWords >= wordsLength)
                return text;

            var distance,
                breakIndex,
                word;

            // Start looking for a break point, starting at the exact number of words
            // requested and moving outwards, looking first forward and then back at
            // each further distance. (Prefer more words to less words).
            for (distance = 0; numWords - 1 - distance >= 0 || numWords + distance - 1 < wordsLength; distance++) {
                // Consider word <distance> ahead of requested numWords
                breakIndex = numWords - 1 + distance;
                word = words[breakIndex];
                if (word && word.slice(-1) === '.')
                    break;

                // Consider word <distance> prior to requested numWords
                breakIndex = numWords - 1 - distance;
                word = words[breakIndex];
                if (word && word.slice(-1) === '.')
                    break;

                // In case the search exits without having seen a single break point,
                // will want to return the entire text.
                breakIndex = wordsLength - 1;
            }

            // Return truncated text
            return words.slice(0, breakIndex + 1).join(' ');
        },

        _storeDescription: function (description, numWords) {
            if (!this.descriptions)
                this.descriptions = {};

            this.descriptions[numWords] = description;
        },

        // Clear cached descriptions.
        _clearDescriptions: function () {
            this.descriptions = {};
        },

        // TODO - get this out of the model, models should have no knowledge of things like modals
        confirmDelete: function (preventNavigation) {
            confirmModal.confirmationPromise(confirmModal.TYPES.CONFIRM_CANCEL,
                confirmDeleteThreadTemplate(this.toJSON()))
                .then(_.bind(function (isConfirmed) {
                    if (!isConfirmed)
                        return;

                    this.removeThread();

                    if (!preventNavigation) {
                        navigationUtils.navigate('/home/channel/' + this.forum.channel.id + '/', {
                            trigger: true,
                            replace: true,
                        });
                    }
                }, this));
        },

        removeThread: function () {
            if (this.topics.length > 0) {
                // Make a new, empty topic collection so it can compare
                // this differences properly when syncing
                var newTopicsCollection = new TopicCollection([], { thread: this });
                newTopicsCollection.save();
            }

            if (!this.get('isDeleted'))
                this.sync('delete', this).then(_.bind(this.set, this, { isDeleted: true }));

            if (!this.get('isClosed'))
                this.sync('close', this).then(_.bind(this.set, this, { isClosed: true }));
        },

        // Un-deletes a thread
        restore: function () {
            if (this.get('isDeleted') || this.get('isClosed')) {
                this.sync('restore', this).then(_.bind(this.set, this, { isDeleted: false }));
                this.sync('open', this).then(_.bind(this.set, this, { isClosed: false }));
            }
        },

        toggleSubscription: function () {
            return this.subscribe(!this.get('userSubscription'));
        },

        /**
         * Invites user group by name.
         * @param {string} groupName - user's group name
         * @returns {Promise}        - sync request (ajax implemented through Backbone)
         */
        inviteUserGroup: function (groupName) {
            return this.sync('inviteUserGroup', this, { data: { userGroup: groupName } });
        },

        /**
         * Returns a promise which will resolve with a boolean representing
         * whether or not the given session can make updates to this thread.
         *
         * Thread authors, thread moderators, and Disqus admins can edit non
         * deleted threads.
         *
         * @param {Model} session - The Session Model
         * @returns {Promise}     - A promise that will resolve with a boolean
         */
        getEditPermissions: function (session) {
            if (this.get('isDeleted'))
                return $.Deferred().resolve(false).promise();

            return $.when(this.isAuthorSessionUser(session), this.getModeratePermissions(session)).then(
                _.bind(function (isAuthorSessionUser, canModerate) {
                    var canEdit = isAuthorSessionUser || canModerate;
                    this.set('canEdit', canEdit);
                    return canEdit;
                }, this)
            );
        },

        /**
         * Returns a promise which will resolve with a boolean representing
         * whether or not the session user can moderate this Thread.
         *
         * @param  {Model} session - The Session Model
         * @returns {Promise} - A promise that will resolve with a boolean
         */
        getModeratePermissions: function (session) {
            if (this.get('canModerate') || auth.getFromCookie().staff) {
                this.set('canModerate', true);
                return $.Deferred().resolve(true).promise();
            }

            return session.loadModeratedForums().then(_.bind(function () {
                var canModerate = _.contains(session.moderatedForums, this.forum.id);
                this.set('canModerate', canModerate);
                return canModerate;
            }, this));
        },

        /**
         * Returns a promise which will resolve with a boolean representing
         * whether or not the current session user is the author of this Thread.
         *
         * @param {Model} session - The Session Model
         * @returns {Promise} - A promise that will resolve with a boolean
         */
        isAuthorSessionUser: function (session) {
            // Thread may have converted author attribute into user model, which
            // may not yet be fully fetched. Compare ids instead of whole models.
            var authorId = this.author ?
                this.author.get('id') :
                this.get('author');

            return session.loadPromise().then(_.bind(function () {
                var isAuthor = session.user.get('id') && session.user.get('id') === authorId;
                this.set('isAuthor', isAuthor);
                return isAuthor;
            }, this));
        },

        getShareUrl: function () {
            return 'https://disq.us/t/' + Number(this.id).toString(SHARER_ENCODING_BASE);
        },

        shareThread: function (network) {
            var urlToShare = this.getShareUrl();
            var shareTitle = this.get('clean_title');
            var baseUrl, shareUrl;

            switch (network) {
            case 'twitter':
                baseUrl = 'https://twitter.com/intent/tweet';
                shareUrl = baseUrl +
                    '?text=' + window.encodeURIComponent(shareTitle) +
                    '&url=' + window.encodeURIComponent(urlToShare);
                break;
            case 'facebook':
                baseUrl = 'https://www.facebook.com/sharer.php';
                shareUrl = baseUrl + '?u=' + window.encodeURIComponent(urlToShare);
                break;
            default:
                return;
            }

            this._showSharePopup(shareUrl);
        },

        _showSharePopup: function (url) {
            return utils.openWindow(url, '_blank', { width: 550, height: 520 });
        },

        storageKey: function () {
            if (!this.isNew())
                return;

            if (!this.forum.id)
                return;

            return ['drafts', 'forum', this.forum.id].join(':');
        },

    }, {
        // The string separating the user's title from the category, if any
        CATEGORY_TITLE_SEPARATOR: ': ',

        getOrCreateThread: function (forumId, threadSlug, fetchOptions) {
            var threads = UniqueModel.pool(Thread);
            var thread = _.find(threads, function (thread) {
                return thread.get('slug') === threadSlug && thread.forum.get('id') === forumId;
            });

            if (!thread) {
                // Necessary to insert thread into an ExtensibleCollection so that the fetch for
                // embedly data will kick off after the thread fetch completes.
                var directThreads = new ExtensibleCollection();

                thread = new Thread({
                    slug: threadSlug,
                    forum: {
                        id: forumId,
                    },
                });

                directThreads.add(thread);
                thread.fetch(fetchOptions).then(function () {
                    // Can't create a unique model initially since we only have the thread slug,
                    // not the id. Once the id is fetched, register thread with unique model.
                    UniqueModel.set(Thread, thread);
                });
            }

            return thread;
        },
    });

    UniqueModel.addType('Thread', Thread);
    mixins.withCreatedAt.call(Thread.prototype);

    return Thread;
});

define('home/collections/VotersUserCollection',[
    'core/UniqueModel',
    'home/models/User',
    'core/collections/VotersUserCollection',
], function (
    UniqueModel,
    User,
    VotersUserCollection
) {
    'use strict';

    return VotersUserCollection.extend({
        // Bind User model with Unique Model
        model: UniqueModel.boundModel(User),

        parse: function (response) {
            return response.response;
        },
    });
});

define('home/models/Post',[
    'jquery',
    'underscore',

    'core/models/Post',

    'core/UniqueModel',
    'home/models/Thread',
    'home/models/User',
    'home/collections/VotersUserCollection',
], function (
    $,
    _,

    CorePost,

    UniqueModel,
    Thread,
    User,
    VotersUserCollection
) {
    'use strict';

    var parent = CorePost;
    var parentProto = parent.prototype;


    var Post = CorePost.extend({

        // TODO: unify Home's VotersUserCollection with embed's
        votersCollectionClass: VotersUserCollection,

        initialize: function (attrs, options) {
            parentProto.initialize.call(this, attrs, options);

            this.set({ state: this._getPostState() });
            this.initializeRelated(
                'thread',
                _.extend({ forum: attrs.forum }, options),
                Thread
            );

            // this.author is set via the Post.withAuthor mixin from next-core
        },

        toJSON: function () {
            var stringifiable = parentProto.toJSON.apply(this, arguments);
            stringifiable.thread = this.thread.toJSON();
            return stringifiable;
        },

        getLinks: _.memoize(function () {
            var $wrapper = $('<div>').html(this.get('message'));
            return $wrapper.find('a[href]').map(function (__, el) {
                return $(el).attr('href');
            });
        }, function () {
            return this.id;
        }),

        getThreadId: function () {
            return this.thread.id;
        },

        _getPostState: function () {
            if (this.get('isSpam'))
                return 'spam';

            if (this.get('isDeleted'))
                return 'deleted';

            // Once a post is flagged to over the site flag threshold it is unapproved
            // Flagged + approved means it's still visible
            if (this.get('isFlagged') && !this.get('isApproved'))
                return 'flagged';

            if (!this.get('isApproved'))
                return 'pending';

            return 'visible';
        },
    });

    CorePost.withAuthor.call(Post.prototype, UniqueModel.boundModel(User));

    // TODO - apply Post.withMediaCollection mixin

    UniqueModel.addType('Post', Post);

    return Post;
});

define('home/collections/PostCollection',[
    'core/collections/PaginatedCollection',
    'core/UniqueModel',
    'home/models/Post',
], function (
    PaginatedCollection,
    UniqueModel,
    Post
) {
    'use strict';

    return PaginatedCollection.extend({
        model: UniqueModel.boundModel(Post),
    });
});

define('home/models/Feed',[
    'underscore',
    'jquery',
    'backbone',
], function (
    _,
    $,
    Backbone
) {
    'use strict';

    /**
     * A Feed. Contains the collection of items in this feed, and also manages
     * fetching the feed, maintaining whether or not there's more pages of the
     * feed, the fetching state, and whether or not there's been a fetch error.
     */
    var Feed = Backbone.Model.extend({
        // Return these from a function so that all instances don't share
        // the fetchOptions object
        defaults: function () {
            return {
                fetching: false,
                fetched: false,
                hasNext: true,
                error: false,
                items: null,
                numPages: 0,
                fetchOptions: {},

                // Deprecated
                active: false,
            };
        },

        initialize: function (_attributes, options) {
            if (!(options && (options.collectionClass || options.collection)))
                throw new Error('Feed must specify the type of collection it maintains, or pass the collection');

            var items = options.collection ||
                new options.collectionClass([], options.collectionOptions);  // eslint-disable-line new-cap

            if (items.cursor && _.has(items.cursor, 'hasNext'))
                this.set('hasNext', items.cursor.hasNext);

            if (options.collectionUrl)
                items.url = options.collectionUrl;

            this.set({ items: items }); // Deprecated, should access items as property, not attribute
            this.items = items; // New

            items.on('extend', this.onExtendComplete, this);
            items.on('sync', this.onSync, this);

            this.listenTo(items, 'all', this.propagateCollectionEvents);

            // Deprecated
            this.on('change:active', this.activeChanged, this);
        },

        propagateCollectionEvents: function () {
            var args = Array.prototype.slice.apply(arguments);
            args[0] = 'items:' + args[0];
            this.trigger.apply(this, args);
        },

        // Deprecated
        activeChanged: function () {
            if (this.get('active') && !this.get('items').length)
                this.fetchItems();
        },

        fetchItems: function (options) {
            options = options || {};

            if (!options.reset && !this.get('hasNext'))
                return $.Deferred().resolve();

            // Don't kick off request again if already fetching, unless the last
            // fetch call timed out. In that case, there isn't an active request,
            // but fetching remains set to true to continue showing the fetching
            // state while reattemting the request.
            if (this.get('fetching') && !this.get('timeouts'))
                return this.fetchPromise;

            this.set({ fetching: true });

            if (options.reset)
                this.set({ fetched: false });

            options.data = options.data || {};
            _.extend(options.data, this.get('fetchOptions'));

            var existingErr = options.error;
            var existingSuccess = options.success;
            var self = this;

            options.error = function (_collection, resp) {
                // Requests seem to hang occasionally. Should investigate. In the meantime,
                // timeout a hanging request and try it again, up to 3 times in a row.
                if (resp.statusText === 'timeout' && (self.get('timeouts') || 0) < 3) {
                    self.set({
                        timeouts: (self.get('timeouts') || 0) + 1,
                    });
                    self.fetchItems();
                    return;
                }

                self.set({
                    fetching: false,
                    error: true,
                    hasNext: false,
                    timeouts: 0,
                });

                if (existingErr)
                    existingErr.apply(this, arguments);
            };
            options.success = function () {
                self.set({
                    error: false,
                    timeouts: 0,
                    numPages: self.get('numPages') + 1,
                });

                if (existingSuccess)
                    existingSuccess.apply(this, arguments);
            };

            // If the collection of feed items is storing a cursor, it has already
            // made the initial fetch request
            var isInitialFetch = $.isEmptyObject(self.get('items').cursor) || options.reset;

            this.fetchPromise = self.get('items')[isInitialFetch ? 'fetch' : 'more'](options);
            return this.fetchPromise;
        },

        // Called on sync event. This is when the collection is synced with the
        // server, either fetched or saved
        onSync: function (_items, response) {
            this.set({
                fetched: true,
                fetching: false,
                hasNext: response.cursor && response.cursor.hasNext,
            });
        },

        ensureFetched: function () {
            if (!this.get('fetched') && !this.get('fetching') && !this.fetchPromise)
                this.fetchItems({ reset: true });

            return this.fetchPromise ? this.fetchPromise : $.Deferred().resolve();
        },

        // Called on extend event. This is when the recently fetched items have
        // been subsidized with data from embedly.
        onExtendComplete: function (hasNext) {
            this.set({
                hasNext: hasNext,
            });
        },
    });

    return Feed;
});

define('home/models/ActivityFeedItem',[
    'jquery',
    'underscore',
    'backbone',
    'core/api',

    'home/collections/PostCollection',

    'home/models/Thread',
    'home/models/Feed',

    'home/utils/datetimeUtils',
], function (
    $,
    _,
    Backbone,
    api,

    PostCollection,

    Thread,
    Feed,

    datetimeUtils
) {
    'use strict';

    /**
     * Represents 1 item in a feed. This item may contain multiple
     * activities rolled up.
     *
     * Default Attributes:
     *
     * verb: type of activity, ex: reply, follow
     * published: when this activity was created
     * totalActors: number of actors who performed this action
     *              ex: 40 users followed you, only have details for
     *              some number of them, ~ 3-5.
     * totalActivities: number of activities rolled up into this activity,
     *                  only have details for some number of them, ~ 3-5
     * score: the score used to determine the order of activities in a
     *        feed. this is the greater of the score naturally calculated
     *        on the backend based on user interaction and time, and the
     *        boosted score, which is a manually overridden value used to
     *        bump this activity up in a feed.
     * boostedScore: the manually overridden score
     * calculatedScore: the naturally calculated score
     * fixedUntil: an ISO string representation of the datetime
     *             when the boost should expire
     */
    var ActivityFeedItem = Backbone.Model.extend({
        initialize: function (_attributes, options) {
            // Some activity types don't have threads (ex: user followed user)
            if (options.thread)
                this.initializeRelated('thread', options, Thread);

            this.activities = options.activities;

            if (!this.id)
                this.id = ActivityFeedItem.buildId(this.activities);

            // While notifications only contain a single activity, just
            // return the unread status of that activity
            this.set({ isUnread: this.activities[0].get('isUnread') });

            this.handleBoostEnd();
            this.on('change:fixedUntil', this.handleBoostEnd);
        },

        parse: function (response) {
            // Break out the parts that make up the score object.
            // Store them separately, don't store score as an object,
            // since it's not useful for determining what attrs inside
            // are changing
            var boostAttrs = response.score;
            if (boostAttrs) {
                boostAttrs = {
                    // The score used to sort the feed
                    score: boostAttrs.value,
                    // The naturally calculated score (as if this was unboosted)
                    naturalScore: boostAttrs.calculated || boostAttrs.value,
                    // The boosted score, if boosted
                    boostedScore: boostAttrs.boost,
                    // The datetime that this boost expires, if boosted
                    fixedUntil: boostAttrs.fixedUntil,
                };
            }

            return _.extend(response, boostAttrs);
        },

        url: function (type) {
            return api.getURL('timelines/curation/' + this.urls[type]);
        },

        urls: {
            'boost': 'boostThreadInChannel',
            'unboost': 'unboostThreadInChannel',
        },

        sync: function (method, self, options) {
            options = options || {};
            options.url = self.url(method);

            // Must set processData to true, otherwise Backbone.sync sets it to false,
            // which results in a POST body of '[object Object]' to the API endpoint
            options.processData = true;

            // Must set emulateHTTP to true so that the request type will be POST instead
            // of PUT/DELETE/PATCH
            options.emulateHTTP = true;

            switch (method) {
            case 'boost':
                options.type = 'POST';
                options.data = _.extend({
                    score: self.get('score'),
                    fixedUntil: self.get('fixedUntil'),
                }, options.data);

                break;
            case 'unboost':
                options.type = 'POST';
                break;
            }

            options.data = _.defaults({
                thread: self.thread.id,
            }, options.data);

            return Backbone.sync(method, self, options);
        },

        toJSON: function () {
            return _.defaults({
                activities: _.invoke(this.activities, 'toJSON'),
                actors: _.invoke(this.actors, 'toJSON'),
                thread: this.thread && this.thread.toJSON(),
                relativeTime: this.getRelativeTimestamp(),
            },
            Backbone.Model.prototype.toJSON.apply(this, arguments));
        },

        getThread: function () {
            return this.thread;
        },

        getPosts: function () {
            if (!this.posts) {
                var postsFeedMeta = {
                    collectionClass: PostCollection,
                    collectionUrl: api.getURL('threads/listPosts'),
                };
                this.posts = {
                    desc: new Feed({
                        fetchOptions: {
                            thread: this.thread.id,
                            order: 'desc',
                        },
                    }, postsFeedMeta),
                    asc: new Feed({
                        fetchOptions: {
                            thread: this.thread.id,
                            order: 'asc',
                        },
                    }, postsFeedMeta),
                };
            }

            return this.posts;
        },

        /**
         * Returns whether or not this item has an image, whether from
         * rich media or pulled from embedly.
         * @returns {Boolean/Promise} - Either a boolean or a promise that resolves
         *                             with a boolean
         */
        hasThreadImage: function () {
            var image = $.Deferred();
            var thread = this.thread;

            if (!thread) {
                image.resolve(false);
            } else if (thread.getImage()) {
                image.resolve(true);
            } else if (thread.get('extending') === false) {
                image.resolve(false);
            } else {
                thread.on('change:extending', function (thread, isExtending) {
                    if (isExtending !== false)
                        return;

                    image.resolve(Boolean(thread.getImage()));
                });
            }

            return image.promise();
        },

        getBackendId: function () {
            // While feed items only contain a single activity, just return
            // the backend id of that activity
            return this.activities[0].get('backendId');
        },

        /**
         * Returns a string representing the timestamp for this feed item
         * relative to now. What the timestamp represents depends on the
         * type of activity this item represents. ex: trending items show
         * the time of the most recent comment on the trending thread,
         * comment items show the time of the comment.
         *
         * For rolled up activities, returns the time of the most recent activity.
         *
         * @returns {string} - Timestamp for this feed item relative to now.
         */
        getRelativeTimestamp: function () {
            return datetimeUtils.getRelativeDatetime(this.get('published'));
        },

        getRelativeBoostTimeRemaining: function () {
            var fixedUntil = this.get('fixedUntil');
            return fixedUntil && datetimeUtils.getRelativeDatetime(fixedUntil);
        },

        getSelectedPost: function () {
            return this.activities[0].get('selectedPost');
        },

        setSelectedPost: function (selectedPost) {
            this.activities[0].set({ selectedPost: selectedPost });
        },

        getThreadOverrides: function () {
            // When the server returns a threadOverrides object, it's as an empty
            // dictionary. We return an empty dictionary even if the threadOverrides
            // object is not set to maintain that expectation.
            return this.activities[0].get('threadOverrides') || {};
        },

        setThreadOverrides: function (threadOverrides) {
            this.activities[0].set({ threadOverrides: threadOverrides });
        },

        getPostsPreviewCollection: function () {
            if (!this.previewPostsCollection) {
                var selectedPost = this.getSelectedPost();
                var recentPosts = this.thread.recentPosts;

                this.previewPostsCollection = recentPosts.clone();
                if (selectedPost)
                    this.previewPostsCollection.add(selectedPost, { at: 0 });
            }

            return this.previewPostsCollection;
        },

        /**
         * When the boost expiration is reached, update the attributes on this model
         * to indicate that it is no longer boosted.
         * It's not necessary to call the unboost endpoint, since the backend will
         * unboost on its own due to the expiration having been reached.
         */
        handleBoostEnd: function () {
            if (this.boostEndTimeout) {
                clearTimeout(this.boostEndTimeout);
                this.boostEndTimeout = null;
            }

            if (!this.get('fixedUntil'))
                return;

            var boostEndMs = new Date(this.get('fixedUntil')).getTime();
            var boostEndRelativeMs = boostEndMs - new Date().getTime();

            if (boostEndRelativeMs < 1)
                this.unboost();
            else
                this.boostEndTimeout = setTimeout(_.bind(this.unboost, this), boostEndRelativeMs);
        },

        /**
         * Updates the attributes to boost this activity to the given score
         * @param  {number} newScore
         */
        boostInChannel: function (channelId, newScore, boostTimeMs) {
            // Determine the expiration by adding the given boost time to the current time,
            // or using the previous boost settings if not given a new boost time
            var fixedUntil = boostTimeMs ?
                new Date(new Date().getTime() + boostTimeMs).toISOString() :
                this.get('fixedUntil');

            this.set({
                boostedScore: newScore,
                fixedUntil: fixedUntil,
                score: newScore,
            });

            // If all the necessary boost details were given, call the boost endpoint.
            // Otherwise wait until user fills in all the details, which will trigger
            // a boost call.
            if (fixedUntil) {
                return this.sync('boost', this, {
                    data: {
                        channel: channelId,
                        fixedUntil: fixedUntil,
                    },
                });
            }
        },

        /**
         * Unboosts this item by removing the boost attributes. Does not call endpoint
         * to unboost on the backend.
         * This can be called from an unboost handler which also calls the endpoint,
         * and when the boost expiration has been reached.
         */
        unboost: function () {
            this.set({
                score: this.get('naturalScore'),
                boostedScore: null,
                fixedUntil: null,
            });
        },

        unboostInChannel: function (channelId) {
            this.unboost();

            return this.sync('unboost', this, {
                data: {
                    channel: channelId,
                },
            });
        },

    }, {
        buildId: function (activities) {
            return _.pluck(activities, 'id').join('|');
        },

        // Default time a card should maintain its boosted score
        DEFAULT_BOOST_TIME_MS: 1000 * 60 * 60, // 1 hour

        // Default frequency a card should halve its score after boost time ends
        DEFAULT_DECAY_RATE_SEC: 60 * 30, // 30 min
    });

    return ActivityFeedItem;
});

define('home/models/UnreadCounter',[
    'backbone',
    'core/api',
    'core/config',
], function (
    Backbone,
    api,
    coreConfig
) {
    'use strict';

    var parent = Backbone.Model;
    var parentProto = parent.prototype;


    /**
     * UnreadCounter
     * convenient interface to getUnreadCount endpoint
     */
    return parent.extend({
        initialize: function (_attributes, options) {
            options = options || {};
            this.uniqueTogether = {
                type: options.type,
                index: options.index,
                target: options.target,
            };
            this.prepareFetchOptions = options.prepareFetchOptions;
        },

        defaults: {
            // Deliberately set to undefined and not 0 to be able
            // to use this.has('numUnread') as a way to check if value
            // has ever been set.
            numUnread: undefined,
        },

        url: api.getURL('timelines/getUnreadCount'),

        fetch: function (options) {
            if (this.prepareFetchOptions)
                options = this.prepareFetchOptions(options);

            options.data.routingVersion = coreConfig.feedApiVersion;

            return parentProto.fetch.call(this, options);
        },

        parse: function (response, options) {
            // Do not set numUnread if this response is only intended to initialize
            // the numUnread value but numUnread has already been set or cleared.
            //
            // This is to protect from a possible race condition between
            // the fetch for notifications and the fetch for unread count.
            // If the notifications fetch returns before the unread count,
            // then we can end up in a situation where the notifications
            // response causes the notifications bubble to be cleared, but then
            // the unread count response comes in and causes the notifications
            // bubble to be populated with a possibly outdated numUnread value.
            if (options.initializeOnly && this.has('numUnread'))
                return;

            return { numUnread: response.response };
        },
    });
});

define('core/models/Channel',[
    'underscore',
    'backbone',

    'core/UniqueModel',
    'core/api',
    'core/models/Forum',
    'core/strings',
], function (
    _,
    Backbone,

    UniqueModel,
    api,
    Forum,
    strings
) {
    'use strict';

    var gettext = strings.get;

    var Channel = Backbone.Model.extend({
        defaults: {
            primaryForum: {},
            slug: null,
            name: null,
            options: {},
            followUrl: 'channels/follow',
            unfollowUrl: 'channels/unfollow',
        },

        idAttribute: 'slug',

        initialize: function (_attributes, options) {
            this.buildPrimaryForum(options);
            this.listenTo(this, 'change:primaryForum', this.updatePrimaryForum);
            this.listenTo(this, 'change:primaryCategory', this.updatePrimaryCategory);
        },

        buildPrimaryForum: function () {
            if (this.primaryForum)
                return;

            var primaryForum = this.get('primaryForum');
            if (!primaryForum)
                return;

            this.primaryForum = new UniqueModel(Forum, primaryForum, { channel: this });

            // Don't want to store forum attributes in multiple places,
            // especially as they are unsynced and will diverge
            this.unset('primaryForum');
        },

        updatePrimaryForum: function () {
            var updated = this.get('primaryForum');
            if (!updated)
                return;

            if (!this.primaryForum)
                this.buildPrimaryForum();

            this.primaryForum.set(updated);

            this.unset('primaryForum');
        },

        /**
         * Creates or updates the related primaryCategory model (a Channel Model
         * set as a property directly on this, not in attributes).
         */
        updatePrimaryCategory: function () {
            var object = this.get('primaryCategory');
            var existing = this.primaryCategory;

            // To delete a related category, set it to null in attributes
            if (object === null)
                this.primaryCategory = undefined;
            else if (existing)
                existing.set(object);
            else
                this.primaryCategory = new UniqueModel(Channel, object);

            // Don't want to store attributes in multiple places, especially
            // as they are unsynced and will diverge. Can remove details
            // from attributes as they are now stored within the related
            // model.
            this.unset('primaryCategory');
            this.trigger('changeRelated:primaryCategory');
        },

        fetch: function (options) {
            options = options ? _.clone(options) : {};
            options.data = this.buildFetchData(options.data);
            return Backbone.Model.prototype.fetch.call(this, options);
        },

        buildFetchData: function (existing) {
            var data = existing ? _.clone(existing) : {};

            if (this.id)
                data.channel = this.id;

            return data;
        },

        url: function (type) {
            return api.getURL(this.constructor.URLS[type] || this.constructor.URLS.read);
        },

        sync: function (method, self, options) {
            var attrs = self.attributes;

            options = _.extend({
                url: this.url(method),

                // Must set emulateHTTP to true so that the request type will be POST instead
                // of PUT/DELETE/PATCH
                emulateHTTP: true,
            }, options);

            var defaultData = {
                bannerColor: attrs.bannerColor,
                description: attrs.description,

                // If related primaryCategory model isn't set, send empty to the server
                // by passing ''. The empty string turns into empty when converted
                // to FormData, and the server will set those fields to null.
                primaryCategory: self.primaryCategory && self.primaryCategory.get('slug') || '',
            };

            // Only set avatar if default is selected OR
            // file is select and user has uploaded a file
            //
            // NOTE: sending null for avatar will result
            // in an api error
            if (options.avatarType === 'default')
                defaultData.avatar = '';
            else if (attrs.avatar && !_.isString(attrs.avatar))
                defaultData.avatar = attrs.avatar;

            if (options.bannerType !== 'file')
                defaultData.banner = '';
            else if (attrs.banner && !_.isString(attrs.banner))
                defaultData.banner = attrs.banner;

            switch (method) {
            case 'create':
                // Set processData and contentType to false so data is sent as FormData
                options.processData = false;
                options.contentType = false;

                defaultData.name = attrs.name;
                options.data = this.toFormData(_.extend({}, defaultData, options.data));

                break;
            case 'update':
                // Set processData and contentType to false so data is sent as FormData
                options.processData = false;
                options.contentType = false;

                defaultData.channel = attrs.slug;
                options.data = this.toFormData(_.extend({}, defaultData, options.data));
            }

            return Backbone.sync(method, self, options);
        },

        toFormData: function (data) {
            return _.reduce(data, function (formData, value, key) {
                formData.append(key, _.isString(value) ? value.trim() : value);
                return formData;
            }, new window.FormData());
        },

        parse: function (response) {
            return response.response || response;
        },

        shouldFetch: function () {
            // If the channel was hard-coded, then the name will exist but dateAdded
            // will not, so we will need to fetch.
            return !this.get('name') || !this.get('dateAdded');
        },

        ensureFetched: function () {
            if (this.shouldFetch())
                this.fetch();
        },

        validate: function (attrs) {
            var validationErrors = [];

            var name = attrs.name.trim();

            if (name.length < this.constructor.MIN_NAME_LENGTH) {
                validationErrors.push({
                    attrName: 'name',
                    message: strings.interpolate(
                        gettext('Name must have at least %(minLength)s characters.'),
                        { minLength: this.constructor.MIN_NAME_LENGTH }),
                });
            } else if (name.length > this.constructor.MAX_NAME_LENGTH) {
                validationErrors.push({
                    attrName: 'name',
                    message: strings.interpolate(
                        gettext('Name must have less than %(maxLength)s characters.'),
                        { maxLength: this.constructor.MAX_NAME_LENGTH }),
                });
            }

            var description = attrs.description.trim();

            if (description.length < this.constructor.MIN_DESCRIPTION_LENGTH) {
                validationErrors.push({
                    attrName: 'description',
                    message: strings.interpolate(
                        gettext('Description must have at least %(minLength)s characters.'),
                        { minLength: this.constructor.MIN_DESCRIPTION_LENGTH }),
                });
            } else if (description.length > this.constructor.MAX_DESCRIPTION_LENGTH) {
                validationErrors.push({
                    attrName: 'description',
                    message: strings.interpolate(
                        gettext('Description must have less than %(maxLength)s characters.'),
                        { maxLength: this.constructor.MAX_DESCRIPTION_LENGTH }),
                });
            }

            if (!this.constructor.BANNER_COLORS[attrs.bannerColor]) {
                validationErrors.push({
                    attrName: 'bannerColor',
                    message: strings.interpolate(
                        gettext('Banner color must be one of ' + _.invoke(_.values(this.constructor.BANNER_COLORS), 'toLowerCase').join(', ')) + '.'
                    ),
                });
            }

            if (!_.isEmpty(validationErrors))
                return validationErrors;
        },

        _changeFollowingState: function (path, options) {
            options = options || {};
            options.type = 'POST';
            options.data = _.extend({
                target: this.get('slug'),
            }, options.data);

            return api.call(path, options);
        },

        follow: function (options) {
            this.primaryForum.set('isFollowing', true);

            return this._changeFollowingState(this.get('followUrl'), options);
        },

        unfollow: function (options) {
            this.primaryForum.set('isFollowing', false);

            return this._changeFollowingState(this.get('unfollowUrl'), options);
        },

        /**
         * Toggles the followed state on this Channel.
         *
         * NOTE: Only curation-only channels can be followed directly.
         * All normal channels should be followed via their primary forums.
         *
         * The followed state of this channel is stored and updated on the
         * primary forum model, even for a curation-only channel that is
         * followed directly. This is to remain consistent with normal
         * channels that follow their primary forum.
         *
         * @returns {Object} - The promise from making the api call to (un)follow,
         *                     or undefined if this channel cannot be followed
         *                     directly.
         */
        toggleFollowed: function () {
            // Can't follow a non-curation-only channel directly.
            // Can't determine current follow state without a primary forum.
            if (!this.get('options').isCurationOnlyChannel || !this.primaryForum)
                return;

            var retval = this.primaryForum.get('isFollowing') ?
                this.unfollow() :
                this.follow();

            this.primaryForum.trigger('toggled:isFollowing');

            return retval;
        },

        toJSON: function () {
            var json = Backbone.Model.prototype.toJSON.call(this);

            return _.defaults({
                primaryCategory: this.primaryCategory ? this.primaryCategory.toJSON() : {},
            }, json);
        },
    }, {
        URLS: {
            read: 'channels/details',
            create: 'channels/create',
            update: 'channels/update',
        },
        BANNER_COLORS: {
            gray: gettext('Gray'),
            blue: gettext('Blue'),
            green: gettext('Green'),
            yellow: gettext('Yellow'),
            orange: gettext('Orange'),
            red: gettext('Red'),
            purple: gettext('Purple'),
        },
        MIN_NAME_LENGTH: 3,
        MAX_NAME_LENGTH: 100,
        MIN_DESCRIPTION_LENGTH: 5,
        MAX_DESCRIPTION_LENGTH: 200,
    });

    UniqueModel.addType('Channel', Channel);

    return Channel;
});

define('core/utils/objectExpander',[
    'underscore',

    'core/UniqueModel',
    'core/models/Channel',
    'core/models/Thread',
], function (
    _,

    UniqueModel,
    Channel,
    Thread
) {
    'use strict';

    /**
     * A set of functions to expand references to other models in a model
     *
     * Contrived example --
     *
     * 1. given an object mapping
     * objects = {
     *     'Thread?456': {id: 456, forum: 'Forum?shortnameExample', url: 'example.com'},
     *     'Forum?shortnameExample': {id: 'shortnameExample', name: 'Example'}
     * }
     *
     * 2. and a compact, serialized representation of a model
     * post = {
     *     id: 123,
     *     thread: 'Thread?456'
     * }
     *
     * 3. produce a fully expanded representation
     * post = {
     *     id: 123,
     *     thread: {
     *         id: 456,
     *         forum: {
     *             id: 'shortnameExample',
     *             name: 'Example'
     *         }
     *         url: 'example.com'
     *     }
     * }
     */
    return {
        // Store local reference to model(s) so that inheriting expanders can overwite
        // model classes with project-specific models
        Channel: Channel,
        Thread: Thread,

        /**
         * Returns an object's attributes, given either the attributes themselves
         * or the id with which to lookup the attributes in the given objects mapping.
         *
         * @param  {Object} objects - Mapping of model type/id to model attributes
         * @param  {object/string} attrs   - Either the object's attributes or the
         *                                   type/id string to lookup the attributes
         *                                   in the objects mapping
         * @returns {Object}         - The object's attributes
         */
        parseObject: function (objects, attrs) {
            return _.isString(attrs) ? objects[attrs] : attrs;
        },

        /**
         * Creates and returns a new unique thread model.
         * Looks up and passes the appropriate forum attributes to the thread
         * constructor so it doesn't need a separate fetch call to populate its
         * forum.
         *
         * @param  {Object} objects  - Mapping of model type/id to model attributes
         * @param  {string} threadAttrs - either the thread attributes or the type/id
         *                                string to lookup the thread attributes
         *
         * @returns {Thread}          - A Thread UniqueModel with a Forum model set as the
         *                             forum
         */
        buildThread: function (objects, threadAttrs) {
            if (threadAttrs instanceof this.Thread)
                return threadAttrs;

            threadAttrs = this.parseObject(objects, threadAttrs);

            // If not an object, threadAttrs.author equals either
            // 'auth.User?id=<numeric_id>' or '<numeric_id>'
            if (_.isString(threadAttrs.author)) {
                var author = threadAttrs.author.replace('auth.User?id=', '');
                // it's important (e.g., for API calls) that if 'auth.User?id=' + author
                // is not in the objects mapping that threadAttrs.author === '<numeric_id>'
                threadAttrs.author = objects['auth.User?id=' + author] || author;
            }

            return new UniqueModel(
                this.Thread,
                threadAttrs,
                {
                    forum: this.parseObject(objects, threadAttrs.forum),
                    author: threadAttrs.author,
                }
            );
        },

        buildChannel: function (objects, channelAttrs) {
            if (channelAttrs instanceof this.Channel)
                return channelAttrs;

            channelAttrs = this.parseObject(objects, channelAttrs);

            return new UniqueModel(
                this.Channel,
                channelAttrs
            );
        },
    };
});

define('core/utils/models',[
    'underscore',
], function (
    _
) {
    'use strict';

    /**
     * A Utility file for model functionality shared between backbone models and
     * react representations of those models.
     */

    var channelUtils = {
        /**
         * Adds some commonly expected additional fields to the json of a channel.
         *
         * @param  {Object} json - A json representation of a channel (either the
         *                         channel details from the api or the result of
         *                         calling toJSON on a backbone channel model)
         *
         * @returns {Object} - The given json with some additional common fields
         */
        extendJSON: function (json) {
            var name = json.name || '';

            return _.defaults({
                // TODO: should name this just avatar. Can get rid of withChannelAvatar
                // and access those values from channel's json. At that time, rename
                // channelAvatar to avatar.
                // https://trello.com/c/NgiflpfS/121-remove-withchannelavatar-mixin
                channelAvatar: json.avatar || json.options.favicon,
                bannerColorClass: json.bannerColor ? '-' + json.bannerColor : '',
                channelInitial: name.charAt(0),
            }, json);
        },
    };

    return {
        channel: channelUtils,
    };
});

define('home/models/Channel',[
    'underscore',

    'core/UniqueModel',
    'core/switches',
    'core/models/Channel',
    'core/utils/auth',
    'core/utils/models',
    'core/strings',

    'home/models/Forum',

    'remote/config',
], function (
    _,

    UniqueModel,
    switches,
    CoreChannel,
    auth,
    modelUtils,
    strings,

    Forum,

    remoteConfig
) {
    'use strict';

    // To be imported lazily to prevent circular dependency
    var CategoryCollection;

    var gettext = strings.get;

    var Channel = CoreChannel.extend({
        // Overwrites core's buildPrimaryForum since home's initializeRelated is used
        buildPrimaryForum: function (options) {
            var forum = options && options.primaryForum || this.get('primaryForum');
            if (_.isEmpty(forum)) {
                this.listenToOnce(this, 'change:primaryForum', _.bind(this.buildPrimaryForum, this, options));
                return;
            }

            if (!Forum)
                Forum = require('home/models/Forum');

            this.initializeRelated('primaryForum', _.defaults({ channel: this }, options), Forum);
            this.trigger('changeRelated:primaryForum');
        },

        getCategories: function () {
            var options = this.get('options');
            var categories = options && options.categories;

            return _.isEmpty(categories) ? null : categories;
        },

        shouldFetch: function () {
            // If channel was created, and then attributes set as the related
            // model for a forum, then name will exist but primaryForum will not.
            // Need to fetch. primaryForum is not initialized by CoreChannel, so
            // it will not have checked for its existance.
            return CoreChannel.prototype.shouldFetch.call(this) || !this.primaryForum;
        },

        /**
         * Most channels allow all users to create. Returns false if this is a curation
         * only channel, or if a whitelist of creators is specified and the user is not
         * in that list.
         * Doesn't check for authentication, because for standard channels we want to show
         * logged out users the option to create discussion, but trying to do so will
         * prompt them to log in.
         *
         * @param {User} user - The User Model to check for creation privileges.
         * @returns {boolean} - Whether or not the given user can create a thread on this
         *                      channel.
         */
        userCanCreate: function (user) {
            // Nobody can create on curation channels
            if (this.get('options').isCurationOnlyChannel)
                return false;

            // Only admins can create on admin channels
            if (switches.isFeatureActive('home_admin_channel', this.attributes))
                return auth.getFromCookie().staff;

            var creatorsWhitelist = remoteConfig.lounge &&
                remoteConfig.lounge.home_channel_creator_whitelists &&
                remoteConfig.lounge.home_channel_creator_whitelists[this.id];

            // Only admins and whitelisted users can create on whitelist channels
            return !creatorsWhitelist ||
                    auth.getFromCookie().staff ||
                    _.contains(creatorsWhitelist, user.get('username'));
        },

        /**
         * A more stringent ensureFetched. Requires not only the standard fetch data
         * but also requies counters, which are not returned in standard transformers
         * but requires a specific api call.
         */
        ensureFetchedWithCounters: function () {
            if (!this.primaryForum || !this.primaryForum.has('numThreads'))
                this.fetch();
        },

        buildFetchData: function (existing) {
            var data = CoreChannel.prototype.buildFetchData.call(this, existing);

            // Only in home make sure to fetch channel stats (counters) and categories
            // when fetching. These are shown on pages specific to one channel, ex:
            // the channel profile page or a channel discussion page.
            return _.extend({
                attach: ['counters', 'channel_categories'],
            }, data);
        },

        validate: function (attrs) {
            var validationErrors = CoreChannel.prototype.validate.call(this, attrs) || [];

            if (!CategoryCollection)
                CategoryCollection = require('home/collections/CategoryCollection');

            var validCategories = CategoryCollection.get().pluck('slug');
            if (!attrs.primaryCategory) {
                validationErrors.push({
                    attrName: 'primaryCategory',
                    message: 'Primary cateogry is required',
                });
            } else if (!_.contains(validCategories, attrs.primaryCategory.slug)) {
                validationErrors.push({
                    attrName: 'primaryCategory',
                    message: gettext('Invalid primary category'),
                });
            }

            if (!_.isEmpty(validationErrors))
                return validationErrors;
        },

        toJSON: function () {
            var json = CoreChannel.prototype.toJSON.call(this);

            return modelUtils.channel.extendJSON(_.defaults({
                primaryForum: this.primaryForum ? this.primaryForum.toJSON() : {},
            }, json));
        },

        follow: function (options) {
            var retval = CoreChannel.prototype.follow.call(this, options);

            var Session = require('home/models/Session');
            var sessionUser = Session.get().user;

            sessionUser.trigger('followed:channel', this);

            return retval;
        },

        unfollow: function (options) {
            var Session = require('home/models/Session');
            var sessionUser = Session.get().user;

            options = options || {};
            options.success = _.bind(function () {
                // Trigger unsubscribing from curation-only channels after success because
                // subscribers may need to refresh certain feeds after this completes.
                if (this.get('options').isCurationOnlyChannel && !this.primaryForum.get('isFollowing'))
                    sessionUser.trigger('unfollowed:curationchannel', this);
            }, this);

            var retval = CoreChannel.prototype.unfollow.call(this, options);

            sessionUser.trigger('unfollowed:channel', this);

            return retval;
        },
    }, {
        getOrCreate: function (attrs, options) {
            var id = attrs[Channel.prototype.idAttribute];
            if (id) {
                var existing = UniqueModel.get(Channel, id);
                if (existing)
                    return existing;
            }

            return new UniqueModel(Channel, attrs, options);
        },
    });

    return Channel;
});

define('home/models/Announcement',[
    'backbone',
], function (
    Backbone
) {
    'use strict';

    var Announcement = Backbone.Model.extend({
        defaults: {
            subject: null,
            title: null,
            body: null,
            name: null,

            // optional
            // link
            // callToAction
            // image
        },
    });

    return Announcement;
});

define('home/activityExpander',[
    'underscore',

    'core/UniqueModel',
    'core/utils/objectExpander',

    'home/models/User',
    'home/models/Post',
    'home/models/Thread',
    'home/models/Forum',
    'home/models/Channel',
    'home/models/Announcement',
], function (
    _,

    UniqueModel,
    objectExpander,

    User,
    Post,
    Thread,
    Forum,
    Channel,
    Announcement
) {
    'use strict';

    /**
     * See core/objectExpander for docs.
     */
    return _.extend(objectExpander, {
        // Overwrite local reference to model(s) so that builders inherited from
        // core's objectExpander will build project-sprecific models
        Channel: Channel,
        Thread: Thread,

        /**
         * Creates and returns a new unique post model.
         * Looks up and passes the appropriate thread, author, and forum attributes
         * to the post constructor so it doesn't need a separate fetch call to
         * populate those models.
         *
         * @param  {Object} objects - Mapping of model type/id to model attributes
         * @param  {object/string} postAttrs - either the post attributes or the
         *                                     type/id string to lookup the attributes
         *                                     in the objects mapping
         *
         * @returns {Post}           - A Post UniqueModel with a User model set as the
         *                            author and a Thread model set as the thread
         */
        buildPost: function (objects, postAttrs) {
            if (postAttrs instanceof Post)
                return postAttrs;

            postAttrs = this.parseObject(objects, postAttrs);

            var threadAttrs = this.parseObject(objects, postAttrs.thread) ||
                // TODO remove this hack
                // This is here because the endpoint currently doesn't return the thread
                // of a parent post in the same way as with activity level posts.
                // Parent posts have just the thread id, and that thread may not be in
                // the objects mapping.
                // First try to look up the thread attrs in the objects mapping, it may
                // be there.
                // If it's not, look up the unique thread model that should already exist,
                // since it would have been created for the reply post before the parent
                // post is created.
                objects['forums.Thread?id=' + postAttrs.thread] ||
                UniqueModel.pool(Thread)[postAttrs.thread];

            return new UniqueModel(
                Post,
                postAttrs,
                {
                    author: this.parseObject(objects, postAttrs.author),
                    thread: this.buildThread(objects, threadAttrs),
                }
            );
        },

        buildAnnouncement: function (objects, announcementAttrs) {
            return new Announcement(this.parseObject(objects, announcementAttrs));
        },

        /**
         * Creates and returns a new unique user model.
         *
         * @param  {Object} objects  - Mapping of model type/id to model attributes
         * @param  {string} userAttrs - either the user attributes or the type/id
         *                                string to lookup the user attributes
         *
         * @returns {User}          - A User UniqueModel
         */
        buildUser: function (objects, userAttrs) {
            if (userAttrs instanceof User)
                return userAttrs;

            userAttrs = this.parseObject(objects, userAttrs);

            return new UniqueModel(
                User,
                userAttrs
            );
        },

        buildForum: function (objects, forumAttrs) {
            if (forumAttrs instanceof Forum)
                return forumAttrs;

            forumAttrs = this.parseObject(objects, forumAttrs);

            return new UniqueModel(
                Forum,
                forumAttrs
            );
        },
    });
});

define('home/models/Activity',[
    'underscore',
    'backbone',

    'home/utils/datetimeUtils',

    'core/UniqueModel',
], function (
    _,
    Backbone,

    datetimeUtils,

    UniqueModel
) {
    'use strict';

    /**
     * An activity, represented by an actor, verb,
     * object, and target.
     */
    var Activity = Backbone.Model.extend({
        defaults: {
            version: 0,
            verb: null,
        },

        buildId: function (attributes) {
            attributes = attributes || this.attributes;  // eslint-disable-line backbone/no-model-attributes

            return this.constructor.buildId(
                attributes.actor,
                attributes.verb || this.constructor.prototype.defaults.verb,
                attributes.target,
                attributes.object
            );
        },

        parse: function (resp, options) {
            if (resp.id && options && options.objects) {
                resp = this.parseRelatedModels(resp, options.objects);
                resp.backendId = resp.id;
                // We set our own id for de-duplication via UniqueModel
                resp.id = this.buildId(resp);
            }

            return resp;
        },

        toJSON: function () {
            return _.defaults({
                actor: this.actor && this.actor.toJSON(),
                target: this.target && this.target.toJSON(),
                object: this.object && this.object.toJSON(),
                thread: this.thread && this.thread.toJSON(),

                // Deprecated
                forum: this.thread && this.thread.forum.toJSON(),
            }, Backbone.Model.prototype.toJSON.call(this));
        },

        getThread: function () {
            return this.thread;
        },

        /**
         * Returns the relative timestamp for this single activity.
         * If showing a timestamp for a group of activities, should
         * use ActivityFeedItem.getRelativeTimestamp for the group
         * of rolled up activities.
         */
        getRelativeCreatedAt: function () {
            return datetimeUtils.getRelativeDatetime(this.object.get('createdAt'));
        },
    }, {
        // Must keep this static method for backwards compatibility
        buildId: function (actor, verb, object, target) {
            return [
                actor ? actor.id : '',
                verb,
                object ? object.id : '',
                target ? target.id : '',
            ].join('|');
        },
    });

    UniqueModel.addType('Activity', Activity);

    return Activity;
});

define('home/models/activities/ThreadActivity',[
    'underscore',
    'home/models/Activity',
    'home/activityExpander',
], function (
    _,
    Activity,
    activityExpander
) {
    'use strict';

    /**
     * Base class for activities that have thread targets
     */
    return Activity.extend({
        initialize: function (attributes) {
            this.target = attributes.target;
            this.thread = this.target;
            this.targetChannel = attributes.targetChannel;
        },

        parseRelatedModels: function (attributes, objects) {
            if (attributes.target && attributes.type === 'TrendingThreadOnChannel')
                attributes.targetChannel = activityExpander.buildChannel(objects, attributes.target);

            attributes.target = activityExpander.buildThread(objects, attributes.object);
            var thread = attributes.thread = attributes.target;

            // Parse selected (curated) post if present
            if (attributes.selectedPost) {
                var excerpt = attributes.selectedPost.excerpt;
                attributes.selectedPost = activityExpander.buildPost(objects, attributes.selectedPost.post);
                attributes.selectedPost.set({ excerpt: excerpt });
            }

            // Augment the thread with recent comments, if any, passed through the activity
            thread.initializeRecentPosts({
                recentPosts: _.map(attributes.recentPosts,
                    _.bind(activityExpander.buildPost, activityExpander, objects)
                ),
            });

            return attributes;
        },
    });
});

define('home/models/activities/FavoriteChannelThreadActivity',[
    'home/models/activities/ThreadActivity',
    'home/activityExpander',
], function (
    ThreadActivity,
    activityExpander
) {
    'use strict';

    /**
     * User favorites a channel thread
     *
     * Relations {
     *     actor: {
     *         type: 'user',
     *         description: 'The user that favorited the thread'
     *     },
     *     target: {
     *         type: 'thread',
     *         description: 'The thread that was favorited'
     *     }
     * }
     */
    var FavoriteChannelThreadActivity = ThreadActivity.extend({
        defaults: {
            verb: 'recommend',
        },

        initialize: function (attributes) {
            ThreadActivity.prototype.initialize.call(this, attributes);
            this.actor = attributes.actor;
        },

        parseRelatedModels: function (attributes, objects) {
            ThreadActivity.prototype.parseRelatedModels.call(this, attributes, objects);
            attributes.actor = activityExpander.buildUser(objects, attributes.actor);
            return attributes;
        },
    });

    return FavoriteChannelThreadActivity;
});


define('home/models/activities/ChannelPostActivity',[
    'home/models/Activity',
    'home/activityExpander',
], function (
    Activity,
    activityExpander
) {
    'use strict';

    /**
     * User writes and submits a comment to a channel
     *
     * Relations {
     *     actor: {
     *         type: 'user',
     *         description: 'The user that posted the comment'
     *     },
     *     object: {
     *         type: 'post',
     *         description: 'The comment that was posted'
     *     }
     * }
     */
    var ChannelPostActivity = Activity.extend({
        defaults: {
            verb: 'channel-post',
        },

        initialize: function (attributes) {
            this.actor = attributes.actor;
            this.object = attributes.object;
            this.thread = this.object.thread;
        },

        parseRelatedModels: function (attributes, objects) {
            attributes.actor = activityExpander.buildUser(objects, attributes.actor);
            attributes.object = activityExpander.buildPost(objects, attributes.object);

            return attributes;
        },
    });

    return ChannelPostActivity;
});


define('home/models/activities/FavoriteThreadActivity',[
    'home/models/activities/ThreadActivity',
    'home/activityExpander',
], function (
    ThreadActivity,
    activityExpander
) {
    'use strict';

    /**
     * User favorites a thread
     *
     * Relations {
     *     actor: {
     *         type: 'user',
     *         description: 'The user that favorited the thread'
     *     },
     *     target: {
     *         type: 'thread',
     *         description: 'The thread that was favorited'
     *     }
     * }
     */
    var FavoriteThreadActivity = ThreadActivity.extend({
        defaults: {
            verb: 'favorite',
        },

        initialize: function (attributes) {
            ThreadActivity.prototype.initialize.call(this, attributes);
            this.actor = attributes.actor;
        },

        parseRelatedModels: function (attributes, objects) {
            ThreadActivity.prototype.parseRelatedModels.call(this, attributes, objects);
            attributes.actor = activityExpander.buildUser(objects, attributes.actor);
            return attributes;
        },
    });

    return FavoriteThreadActivity;
});

define('home/models/activities/ReplyActivity',[
    'home/models/Activity',
    'home/activityExpander',
], function (
    Activity,
    activityExpander
) {
    'use strict';

    /**
     * User writes and submits a reply to another comment
     *
     * Relations {
     *     actor: {
     *         type: 'user',
     *         description: 'The user that posted the reply'
     *     },
     *     object: {
     *         type: 'post',
     *         description: 'The comment that was written in reply to another comment'
     *     }
     *     target: {
     *         type: 'post',
     *         description: 'The comment to which the reply was written'
     *     }
     * }
     */
    return Activity.extend({
        defaults: {
            verb: 'reply',
        },

        initialize: function (attributes) {
            this.actor = attributes.actor;
            this.object = attributes.object;
            this.target = attributes.target;
            this.thread = this.object.thread;
        },

        parseRelatedModels: function (attributes, objects) {
            attributes.object = activityExpander.buildPost(objects, attributes.object);

            if (attributes.actor)
                attributes.actor = activityExpander.buildUser(objects, attributes.actor);
            else
                // For anonymous replies, the backend leaves the
                // "actor" field blank (presumably because there is no
                // id for an anonymous user) but our model needs it, so
                // we infer the actor from the object
                attributes.actor = attributes.object.author;

            attributes.target = activityExpander.buildPost(objects, attributes.object.get('parent_post'));

            return attributes;
        },
    });
});

define('home/models/activities/MentionActivity',[
    'home/models/Activity',
    'home/activityExpander',
], function (
    Activity,
    activityExpander
) {
    'use strict';

    /**
     * Activity for a user mentioning another user in a post.
     *
     * @class MentionActivity
     * @augments Activity
     *
     * @property {User} actor - The user that mentioned another user in a post.
     * @property {User} object - The user which was mentioned.
     * @property {Post} target - The comment in which the mention occured.
     * @property {Thread} thread - The thread that the post belongs to.
     */
    return Activity.extend({
        defaults: {
            verb: 'mention',
        },

        initialize: function (attributes) {
            this.actor = attributes.actor;
            this.object = attributes.object;
            this.target = attributes.target;
            this.thread = attributes.target.thread;
        },

        parseRelatedModels: function (attributes, objects) {
            attributes.object = activityExpander.buildUser(objects, attributes.object);
            attributes.actor = activityExpander.buildUser(objects, attributes.actor);
            attributes.target = activityExpander.buildPost(objects, attributes.target);

            return attributes;
        },
    });
});

define('home/models/activities/PostActivity',[
    'home/models/Activity',
    'home/activityExpander',
], function (
    Activity,
    activityExpander
) {
    'use strict';

    /**
     * User writes and submits a top-level comment (not a reply)
     *
     * Relations {
     *     actor: {
     *         type: 'user',
     *         description: 'The user that posted the comment'
     *     },
     *     object: {
     *         type: 'post',
     *         description: 'The comment that the user submitted'
     *     }
     *     target: {
     *         type: 'thread',
     *         description: 'The thread on which the comment was submitted'
     *     }
     * }
     */
    var PostActivity = Activity.extend({
        defaults: {
            verb: 'post',
        },

        initialize: function (attributes) {
            this.actor = attributes.actor;
            this.object = attributes.object;
            this.target = this.object.thread;
            this.thread = this.object.thread;
        },

        parseRelatedModels: function (attributes, objects) {
            attributes.actor = activityExpander.buildUser(objects, attributes.actor);
            attributes.object = activityExpander.buildPost(objects, attributes.object);
            attributes.target = attributes.object.thread;

            return attributes;
        },
    });

    return PostActivity;
});

define('home/models/activities/LikePostActivity',[
    'home/models/Activity',
    'home/activityExpander',
], function (
    Activity,
    activityExpander
) {
    'use strict';

    /*
        User likes a comment

        Relations {
            actor: {
                type: 'user',
                description: 'The user that liked the comment'
            },
            target: {
                type: 'post',
                description: 'The comment that was liked'
            }
        }
     */
    return Activity.extend({
        defaults: {
            verb: 'favorite',
        },

        initialize: function (attributes) {
            this.actor = attributes.actor;
            this.target = attributes.target;
            this.thread = this.target.thread;
        },

        parseRelatedModels: function (attributes, objects) {
            attributes.actor = activityExpander.buildUser(objects, attributes.actor);
            attributes.target = activityExpander.buildPost(objects, attributes.object);

            return attributes;
        },
    });
});

define('home/models/activities/TrendingThreadActivity',[
    'home/models/activities/ThreadActivity',
], function (
    ThreadActivity
) {
    'use strict';

    /**
     * A thread is marked as "trending" by the system
     *
     * Relations {
     *     target: {
     *         type: 'thread',
     *         description: 'The thread that is identified as trending'
     *     }
     * }
     */
    return ThreadActivity.extend({
        defaults: {
            verb: 'trending',
        },
    });
});

define('home/models/activities/FollowUserActivity',[
    'home/models/Activity',
    'home/activityExpander',
], function (
    Activity,
    activityExpander
) {
    'use strict';

    /**
     * User follows (the current) user
     *
     * Relations {
     *     actor: {
     *         type: 'user',
     *         description: 'The user that did the following action'
     *     },
     *     target: {
     *         type: 'user',
     *         description: 'The user being followed'
     *     }
     * }
     */
    return Activity.extend({
        defaults: {
            verb: 'follow',
        },

        initialize: function (attributes) {
            this.actor = attributes.actor;
            this.target = attributes.target;
        },

        parseRelatedModels: function (attributes, objects) {
            attributes.actor = activityExpander.buildUser(objects, attributes.actor);
            attributes.target = activityExpander.buildUser(objects, attributes.object);

            return attributes;
        },
    });
});

define('home/models/activities/AnnouncementActivity',[
    'home/models/Activity',
    'home/activityExpander',
], function (
    Activity,
    activityExpander
) {
    'use strict';

    /**
     * A system message for end users
     *
     * Relations {
     *     object: {
     *         type: 'Announcement',
     *         description: 'The contents of the announcement'
     *     }
     * }
     */
    return Activity.extend({
        defaults: {
            verb: 'send',
        },

        initialize: function (attributes) {
            this.object = attributes.object;
        },

        parseRelatedModels: function (attributes, objects) {
            attributes.object = activityExpander.buildAnnouncement(objects, attributes.object);
            return attributes;
        },
    });
});

define('home/models/activities/CreateThreadActivity',[
    'home/models/activities/ThreadActivity',
], function (
    ThreadActivity
) {
    'use strict';

    return ThreadActivity.extend({
        defaults: {
            verb: 'create',
        },
    });
});

define('home/models/activities/ShareThreadActivity',[
    'home/models/activities/ThreadActivity',
], function (
    ThreadActivity
) {
    'use strict';

    /**
     * A thread is shared into a curated feed by a moderator
     *
     * Relations {
     *     target: {
     *         type: 'thread',
     *         description: 'The thread that is identified as shared'
     *     }
     * }
     */
    return ThreadActivity.extend({
        defaults: {
            verb: 'share',
        },
    });
});

define('home/models/activities/ThreadInviteActivity',[
    'home/models/Activity',
    'home/activityExpander',
], function (
    Activity,
    activityExpander
) {
    'use strict';

    /**
     * User invites (the current) user to a thread
     *
     * Relations {
     *     actor: {
     *         type: 'user',
     *         description: 'The user that did the inviting action'
     *     },
     *     target: {
     *         type: 'thread',
     *         description: 'The thread to which the target is invited'
     *     }
     * }
     */
    return Activity.extend({
        defaults: {
            verb: 'threadInvite',
        },

        initialize: function (attributes) {
            this.actor = attributes.actor;
            this.thread = attributes.target;
        },

        parseRelatedModels: function (attributes, objects) {
            attributes.actor = activityExpander.buildUser(objects, attributes.actor);
            attributes.target = activityExpander.buildThread(objects, attributes.target);

            return attributes;
        },
    });
});

define('home/models/activities/ChannelInviteActivity',[
    'home/models/Activity',
    'home/activityExpander',
], function (
    Activity,
    activityExpander
) {
    'use strict';

    /**
     * User invites (the current) user to a channel
     *
     * Relations {
     *     actor: {
     *         type: 'user',
     *         description: 'The user that did the inviting action'
     *     },
     *     target: {
     *         type: 'channel',
     *         description: 'The channel to which the target is invited'
     *     }
     * }
     */
    return Activity.extend({
        defaults: {
            verb: 'channelInvite',
        },

        initialize: function (attributes) {
            this.actor = attributes.actor;
            this.channel = attributes.target;
        },

        parseRelatedModels: function (attributes, objects) {
            attributes.actor = activityExpander.buildUser(objects, attributes.actor);
            attributes.target = activityExpander.buildChannel(objects, attributes.target);

            return attributes;
        },
    });
});

define('home/models/activities/HighlightPostActivity',[
    'home/models/Activity',
    'home/activityExpander',
], function (
    Activity,
    activityExpander
) {
    'use strict';

    /*
        User highlighted a comment on a channel thread

        Relations {
            actor: {
                type: 'user',
                description: 'The user that highlighted the comment'
            },
            target: {
                type: 'post',
                description: 'The comment that was liked'
            }
        }
     */
    return Activity.extend({
        defaults: {
            verb: 'highlight',
        },

        initialize: function (attributes) {
            this.actor = attributes.actor;
            this.target = attributes.target;
            this.thread = this.target.thread;
        },

        parseRelatedModels: function (attributes, objects) {
            attributes.actor = activityExpander.buildUser(objects, attributes.actor);
            attributes.target = activityExpander.buildPost(objects, attributes.object);

            return attributes;
        },
    });
});

define('home/models/activities/AddModActivity',[
    'home/models/Activity',
    'home/activityExpander',
], function (
    Activity,
    activityExpander
) {
    'use strict';

    /**
     * User added (the current) user as a moderator to a forum
     *
     * Relations {
     *     actor: {
     *         type: 'user',
     *         description: 'The user that did the adding'
     *     },
     *     object: {
     *         type: 'forum',
     *         description: The forum to which the user was added as a moderator
     *     }
     * }
     */
    return Activity.extend({
        defaults: {
            verb: 'add-mod',
        },

        initialize: function (attributes) {
            this.actor = attributes.actor;
            this.target = attributes.target;
        },

        parseRelatedModels: function (attributes, objects) {
            attributes.actor = activityExpander.buildUser(objects, attributes.actor);
            attributes.target = activityExpander.buildForum(objects, attributes.target);

            return attributes;
        },
    });
});

define('home/ActivityFactory',[
    'underscore',

    'home/activityExpander',
    'core/UniqueModel',
    'home/models/Activity',

    'home/models/activities/FavoriteChannelThreadActivity',
    'home/models/activities/ChannelPostActivity',
    'home/models/activities/FavoriteThreadActivity',
    'home/models/activities/ReplyActivity',
    'home/models/activities/MentionActivity',
    'home/models/activities/PostActivity',
    'home/models/activities/LikePostActivity',
    'home/models/activities/TrendingThreadActivity',
    'home/models/activities/FollowUserActivity',
    'home/models/activities/AnnouncementActivity',
    'home/models/activities/CreateThreadActivity',
    'home/models/activities/ShareThreadActivity',
    'home/models/activities/ThreadInviteActivity',
    'home/models/activities/ChannelInviteActivity',
    'home/models/activities/HighlightPostActivity',
    'home/models/activities/AddModActivity',
], function (
    _,

    activityExpander,
    UniqueModel,
    Activity,

    FavoriteChannelThreadActivity,
    ChannelPostActivity,
    FavoriteThreadActivity,
    ReplyActivity,
    MentionActivity,
    PostActivity,
    LikePostActivity,
    TrendingThreadActivity,
    FollowUserActivity,
    AnnouncementActivity,
    CreateThreadActivity,
    ShareThreadActivity,
    ThreadInviteActivity,
    ChannelInviteActivity,
    HighlightPostActivity,
    AddModActivity
) {
    'use strict';

    var ActivityFactory = function () {};

    var methods = {
        createActivity: function (attributes, options) {
            var ActivityClass = this.getActivityClass(attributes, options);
            if (!ActivityClass)
                return null;

            var activity = new ActivityClass(attributes, options);

            // Must invoke UniqueModel after instantiating the model
            // because we do not have the final model id until after
            // instantiation
            return UniqueModel.set(Activity, activity);
        },

        getActivityClass: function (attributes, options) {
            switch (attributes.type) {
            case 'RegisteredUserFavoriteThread':
            case 'AnonymousUserFavoriteThread':
                if (attributes.routings[0].type === 'ThreadAuthorRelation') {
                    attributes.verb = FavoriteChannelThreadActivity.prototype.defaults.verb;
                    return FavoriteChannelThreadActivity;
                }

                attributes.verb = FavoriteThreadActivity.prototype.defaults.verb;
                return FavoriteThreadActivity;
            case 'RegisteredUserSubmitPost':
            case 'AnonymousUserSubmitPost':
                var object = activityExpander.buildPost(
                    options.objects,
                    attributes.object
                );
                attributes.object = object;
                if (attributes.routings[0].type === 'ThreadAuthorRelation') {
                    attributes.verb = ChannelPostActivity.prototype.defaults.verb;
                    return ChannelPostActivity;
                } else if (object.get('parent_post')) {
                    attributes.verb = ReplyActivity.prototype.defaults.verb;
                    return ReplyActivity;
                }

                attributes.verb = PostActivity.prototype.defaults.verb;
                return PostActivity;
            case 'UserMentionUserOnPost':
                attributes.verb = MentionActivity.prototype.defaults.verb;
                return MentionActivity;
            case 'RegisteredUserLikePost':
            case 'AnonymousUserLikePost':
                attributes.verb = LikePostActivity.prototype.defaults.verb;
                return LikePostActivity;
            case 'RegisteredUserCreateThread':
                attributes.verb = CreateThreadActivity.prototype.defaults.verb;
                return CreateThreadActivity;
            case 'TrendingThread':
            case 'TrendingThreadOnChannel':
            case 'TrendingThreadOnForum':
                attributes.verb = TrendingThreadActivity.prototype.defaults.verb;
                return TrendingThreadActivity;
            case 'UserFollowUser':
                attributes.verb = FollowUserActivity.prototype.defaults.verb;
                return FollowUserActivity;
            case 'SendAnnouncementToUser':
                attributes.verb = AnnouncementActivity.prototype.defaults.verb;
                return AnnouncementActivity;
            case 'UserShareThreadToChannel':
                attributes.verb = ShareThreadActivity.prototype.defaults.verb;
                return ShareThreadActivity;
            case 'UserInviteUserToThread':
            case 'UserInviteUserGroupToThread':
                attributes.verb = ThreadInviteActivity.prototype.defaults.verb;
                return ThreadInviteActivity;
            case 'UserInviteUserToChannel':
                attributes.verb = ChannelInviteActivity.prototype.defaults.verb;
                return ChannelInviteActivity;
            case 'UserAddModeratorToForum':
                attributes.verb = AddModActivity.prototype.defaults.verb;
                return AddModActivity;
            case 'UserHighlightPost':
                attributes.verb = HighlightPostActivity.prototype.defaults.verb;
                return HighlightPostActivity;
            case 'UserFollowForum':
                // Not supported
                return null;
            }
        },
    };

    _.extend(ActivityFactory.prototype, methods);

    return ActivityFactory;
});

define('home/collections/FeedItemCollection',[
    'underscore',

    'home/collections/common/ExtensibleCollection',

    'home/models/ActivityFeedItem',
    'home/models/UnreadCounter',
    'home/ActivityFactory',
    'home/activityExpander',

    'core/api',
], function (
    _,

    ExtensibleCollection,

    ActivityFeedItem,
    UnreadCounter,
    ActivityFactory,
    activityExpander,

    api
) {
    'use strict';

    var TIMELINE_ACTIVITIES_PATHNAME = 'timelines/activities';

    var parent = ExtensibleCollection;
    var parentProto = parent.prototype;


    var FeedItemCollection = parent.extend({
        url: api.getURL(TIMELINE_ACTIVITIES_PATHNAME),

        initialize: function (models, options) {
            parentProto.initialize.call(this, models, options);
            options = options || {};

            // Activity timelines are made distinct by these three parameters
            // e.g.,
            // Home feed : {type: 'home'}
            // Recent channel comments : {type: 'profile', index: 'user_created_threads', target: 'channel'}
            this.uniqueTogether = {
                type: options.type,
                index: options.index,
                target: options.target,
            };
            this.unreadCounter = new UnreadCounter(null, _.extend({
                prepareFetchOptions: this.prepareFetchOptions,
            }, this.uniqueTogether));
        },

        prepareFetchOptions: function (options) {
            options = options ? _.clone(options) : {};

            // Ensure that the parameters that distinguish the feed are serialized
            // into the URL. (Undefined values will simply be omitted by jQuery.)
            options.data = _.extend({}, this.uniqueTogether, options.data);

            return options;
        },

        fetch: function (options) {
            options = this.prepareFetchOptions(options);
            return parentProto.fetch.call(this, options);
        },

        canUpdate: function () {
            return (
                // only update non-empty collection
                this.length &&
                // right now we only know how to update collections backed by
                // 'timelines/activities' endpoint, not 'timelines/ranked' or others
                this.url.indexOf(TIMELINE_ACTIVITIES_PATHNAME) > 0
            );
        },

        updateUnreadCount: function () {
            if (!this.canUpdate())
                return;

            this.unreadCounter.fetch({
                data: {
                    readPosition: this.latestPosition,
                },
            }).then(_.bind(function () {
                this.fetchUnread(this.unreadCounter.get('numUnread'));
            }, this));
        },

        /**
         * Updates this.uniqueTogether with new attributes.
         *
         * @param {Object} options - should have at least one of:
         *                           type, index, or target, all of which should be strings
         * @returns {void}
         */
        updateUniqueTogether: function (options) {
            if (!options || !_.isObject(options))
                return;

            var newUniqueTogether = _.pick(options, 'type', 'index', 'target');
            this.uniqueTogether = _.extend(this.uniqueTogether, newUniqueTogether);

            // Also update the unreadCounter's uniqueTogether
            if (this.unreadCounter)
                this.updateUniqueTogether.call(this.unreadCounter, this.uniqueTogether);
        },

        fetchUnread: function (numUnread) {
            if (numUnread <= 0)
                return;

            // lazily instantiate
            this.unreadQueue = this.unreadQueue || new this.constructor(null, _.clone(this.uniqueTogether));
            this.unreadQueue.fetch({
                reset: true,
                data: {
                    limit: numUnread,
                },
            }).then(_.bind(function () {
                // adjust counter, if necessary
                var numQueued = this.unreadQueue.length;
                this.unreadCounter.set('numUnread', numQueued);
                this.trigger('unreadItemsReady', numQueued);
            }, this));
        },

        addUnread: function () {
            this.latestPosition = this.unreadQueue.latestPosition;
            this.unreadQueue.invoke('set', 'isFromUnreadQueue', true);
            this.add(this.unreadQueue.models, {
                at: 0,
            });
            this.unreadQueue.reset();
            this.unreadCounter.set('numUnread', 0);
        },

        parse: function (response, options) {
            options = options || {};

            // Store latestPosition in order to later ask the server (via getUnreadCount
            // endpoint) how many new items have been added to the feed since the last
            // request.
            if (!this.latestPosition || options.reset)
                this.latestPosition = response.response.latestPosition;

            var boundTransform = _.bind(FeedItemCollection.transform, FeedItemCollection, response.response.objects);

            response.response = _.chain(response.response.activities)
                .map(boundTransform)
                .compact()
                .value();


            if (this.uniqueTogether.type === 'home' && Boolean(response) && Boolean(response.response) && _.isArray(response.response)) {
                response.response = _.filter(response.response, function (item) {
                    return item.thread.forum.id.indexOf('channel-') === -1 || item.thread.forum.id === 'channel-discussdisqus';
                });
            }

            return parentProto.parse.call(this, response, options);
        },
    }, {
        activityFactory: new ActivityFactory(),

        /**
         * Switches the transformer used for this item based on if it's a
         * single activity item or a grouped activities item.
         */
        transform: function (objects, item) {
            return item.items ?
                this.buildFeedItemFromGroupedActivities(objects, item) :
                this.buildFeedItemFromSingleActivity(objects, item);
        },

        /**
         * Builds a FeedItem from a group of activities passed from the backend.
         * @param  {Object} objects    - The model definitions sent from the backend.
         *                               The items reference these models by type/id,
         *                               and the actual model details are contained in
         *                               this objects mapping.
         * @param  {Object} group      - The json representation of a group of activities
         * @returns {ActivityFeedItem}  - The model representation of the given item
         */
        buildFeedItemFromGroupedActivities: function (objects, group) {
            group.actors = group.actors || { items: [] };

            var activities = _.chain(group.items)
                .map(_.bind(this.buildActivity, this, objects))
                .compact()
                .value();
            var actors = _.map(group.actors.items, _.bind(activityExpander.buildUser, activityExpander, objects));
            var activity = activities[0];
            var verb = activity && activity.get('verb');

            if (!activity)
                return;

            // Occurs for anonymous reply activity. The backend returns
            // group.actors.items = []
            if (!actors.length && activity.actor) {
                group.actors.totalItems = 1;
                actors = [activity.actor];
            }

            var feedItemId = ActivityFeedItem.buildId(activities);
            var attributes = ActivityFeedItem.prototype.parse.call(null, {
                id: feedItemId,

                // Multiple replies are treated as a group of comments
                verb: verb === 'reply' && activities.length > 1 ? 'post' : verb,
                published: group.published,
                totalActors: group.actors && group.actors.totalItems || 0,
                totalActivities: group.totalItems,
                score: group.score,
            });
            var options = {
                activities: activities,
                thread: activity.thread,
            };
            // Do not use UniqueModel, because boost attributes can be changed on the
            // ActivityFeedItem, and those changes are specific to this feed.
            // Don't want those changes to affect the same activity in another feed.
            var feedItem = new ActivityFeedItem(
                attributes,
                options
            );

            feedItem.actors = actors;

            return feedItem;
        },

        /**
         * Builds a FeedItem from a single activity passed from the backend.
         * FeedItem supports multiple activities, this transformer will populate
         * the model with only the single activity.
         * @param  {Object} objects    - The model definitions sent from the backend.
         *                               The items reference these models by type/id,
         *                               and the actual model details are contained in
         *                               this objects mapping.
         * @param  {Object} item       - The json definition of one feed item.
         * @returns {ActivityFeedItem}  - The model representation of the given item
         */
        buildFeedItemFromSingleActivity: function (objects, item) {
            var activity = this.buildActivity(objects, item);

            if (!activity)
                return;

            var activities = [ activity ];
            var feedItemId = ActivityFeedItem.buildId(activities);
            var attributes = _.defaults({
                id: feedItemId,
                totalActors: 1,
                totalActivities: 1,
                verb: activity.get('verb'),
            }, item);
            var options = {
                activities: activities,
                thread: activity.thread,
            };
            // Do not use UniqueModel, because boost attributes can be changed on the
            // ActivityFeedItem, and those changes are specific to this feed.
            // Don't want those changes to affect the same activity in another feed.
            var feedItem = new ActivityFeedItem(
                attributes,
                options
            );

            feedItem.actors = activity.actor ? [activity.actor] : [];

            return feedItem;
        },

        /**
         * Builds an Activity model from the given activity item
         * and objects mapping.
         * @param  {Object} objects - Mapping of model type/id to model attributes
         * @param  {Object} item    - description of the activity, including actor, type,
         *                            published, routings, and object.
         * @returns {Activity}       - Activity model representing the activity
         */
        buildActivity: function (objects, item) {
            try {
                return this.activityFactory.createActivity(item, {
                    objects: objects,
                    parse: true,
                });
            } catch (err) {
                if (window.Raven)
                    window.Raven.captureMessage('error parsing activity item', { extra: item });
            }
        },
    });

    return FeedItemCollection;
});

define('home/collections/ForumCollection',[
    'core/collections/PaginatedCollection',
    'core/UniqueModel',

    'home/models/Forum',
], function (
    PaginatedCollection,
    UniqueModel,

    Forum
) {
    'use strict';

    var ForumCollection = PaginatedCollection.extend({
        model: UniqueModel.boundModel(Forum),

        parse: function (response) {
            response = PaginatedCollection.prototype.parse.call(this, response);

            return response;
        },
    });

    return ForumCollection;
});

define('home/collections/FollowingForumCollection',[
    'underscore',
    'home/utils/backboneUtils',

    'home/collections/ForumCollection',

    'core/api',
], function (
    _,
    BackboneUtils,

    ForumCollection,

    api
) {
    'use strict';

    var FollowingForumCollection = ForumCollection.extend({
        url: api.getURL('users/listFollowingForums'),

        initialize: function () {
            this.on('add', this.completeModel);
        },

        completeModel: function (model) {
            if (!model.get('name'))
                model.fetch();
        },

        fetch: function (options) {
            options = options || {};

            // Load the max possible number of forums at a time
            // to prevent pagination issues for now, as almost
            // no users follow more than 100 forums.
            options.data = _.defaults({
                limit: 100,
            }, options.data);

            return BackboneUtils.memoizedFetch.call(this, options);
        },

        parse: function (response) {
            if (Boolean(response) && Boolean(response.response) && _.isArray(response.response)) {
                response = _.defaults({ response: _.filter(response.response, function (channel) {
                    return channel.id.indexOf('channel-') === -1 || channel.id === 'channel-discussdisqus';
                }) }, response);
            }

            response = ForumCollection.prototype.parse.call(this, response);

            return response;
        },
    });

    return FollowingForumCollection;
});

define('core/collections/ChannelCollection',[
    'underscore',

    'core/collections/PaginatedCollection',
    'core/UniqueModel',
    'core/api',
    'core/models/Channel',
    'core/utils/objectExpander',
], function (
    _,

    PaginatedCollection,
    UniqueModel,
    api,
    Channel,
    objectExpander
) {
    'use strict';

    var ChannelCollection = PaginatedCollection.extend({
        url: api.getURL('channels/list'),

        model: UniqueModel.boundModel(Channel),

        initialize: function (_models, options) {
            PaginatedCollection.prototype.initialize.call(this, _models, options);
            options = options || {};
            this.listName = options.listName;
        },

        fetch: function (options) {
            options = options || {};

            if (this.listName)
                options.data = _.extend({ listName: this.listName }, options.data);

            return PaginatedCollection.prototype.fetch.call(this, options);
        },

        parse: function (response) {
            if (Boolean(response) && Boolean(response.response) && _.isArray(response.response)) {
                response = _.defaults({ response: _.filter(response.response, function (channel) {
                    return !channel || !channel.primaryForum || !channel.primaryForum.id ||
                        channel.primaryForum.id === 'channel-discussdisqus';
                }) }, response);
            }

            response = PaginatedCollection.prototype.parse.call(this, response);

            // Some endpoints use reference/objects mapping for channels, which are handled
            // differently.
            if (response.items) {
                return _.map(response.items, function (listedChannel) {
                    return objectExpander.buildChannel(response.objects, listedChannel.reference);
                });
            }

            return response;
        },
    });

    return ChannelCollection;
});

define('home/collections/ChannelCollection',[
    'core/collections/ChannelCollection',
    'core/UniqueModel',
    'home/models/Channel',
], function (
    CoreChannelCollection,
    UniqueModel,
    Channel
) {
    'use strict';

    var ChannelCollection = CoreChannelCollection.extend({
        model: UniqueModel.boundModel(Channel),
    });

    return ChannelCollection;
});

define('home/collections/FollowingChannelCollection',[
    'underscore',
    'home/utils/backboneUtils',

    'home/collections/ChannelCollection',

    'core/api',
], function (
    _,
    BackboneUtils,

    ChannelCollection,

    api
) {
    'use strict';

    var FollowingChannelCollection = ChannelCollection.extend({
        url: api.getURL('users/listFollowingChannels'),

        initialize: function () {
            this.on('add', this.completeModel);
        },

        completeModel: function (model) {
            if (model.shouldFetch())
                model.fetch();
        },

        fetch: function (options) {
            options = options || {};

            // Load the max possible number of channels at a time
            // to prevent pagination issues for now, as almost
            // no users follow more than 100 channels.
            options.data = _.defaults({
                limit: 100,
            }, options.data);

            return BackboneUtils.memoizedFetch.call(this, options);
        },
    });

    return FollowingChannelCollection;
});

define('home/collections/FollowingUserCollection',[
    'home/collections/PaginatedUserCollection',

    'core/api',
], function (
    PaginatedUserCollection,

    api
) {
    'use strict';

    return PaginatedUserCollection.extend({
        url: api.getURL('users/listFollowing'),
    });
});

define('home/models/ForumBadges',[
    'backbone',

    'core/UniqueModel',

    'home/models/Badge',
    'home/models/Forum',
], function (
    Backbone,

    UniqueModel,

    Badge,
    Forum
) {
    'use strict';

    var ForumBadgeSet = Backbone.Collection.extend({
        model: UniqueModel.boundModel(Badge),

        initialize: function (_models, options) {
            if (options.forum) {
                _models.forEach(function (badge) {
                    badge.forum = options.forum;
                });
            }
        },
    });

    var ForumBadges = Backbone.Model.extend({

        initialize: function () {
            // The ForumBadges model contains a related `forum` and a `badges` collection
            // of Badge models for the forum
            var badgeForum = this.get('forum');
            // Handle the differences in frontend/backend naming schemes
            badgeForum.pk = badgeForum.id;
            badgeForum.id = badgeForum.url;
            this.initializeRelated('forum', badgeForum, Forum);

            this.set('badges', new ForumBadgeSet(this.get('badges'), { forum: badgeForum }));
        },
    });

    UniqueModel.addType('ForumBadges', ForumBadges);

    return ForumBadges;
});

define('home/collections/ForumBadgesCollection',[
    'core/collections/PaginatedCollection',
    'core/UniqueModel',

    'home/models/ForumBadges',
], function (
    PaginatedCollection,
    UniqueModel,

    ForumBadges
) {
    'use strict';

    var ForumBadgesCollection = PaginatedCollection.extend({
        model: UniqueModel.boundModel(ForumBadges),
    });

    return ForumBadgesCollection;
});

define('home/collections/MostActiveForumCollection',[
    'backbone',

    'home/models/Forum',

    'core/UniqueModel',
    'core/api',
], function (
    Backbone,

    Forum,

    UniqueModel,
    api
) {
    'use strict';

    var MostActiveForumCollection = Backbone.Collection.extend({
        url: api.getURL('users/listMostActiveForums'),
        model: UniqueModel.boundModel(Forum),

        parse: function (response) {
            return response.response;
        },
    });

    return MostActiveForumCollection;
});

define('home/collections/UserManagedChannelCollection',[
    'underscore',

    'core/api',

    'home/collections/ChannelCollection',
], function (
    _,

    api,

    ChannelCollection
) {
    'use strict';

    /**
     * A collection of Channel models that are managed by the given user
     * ie: created or moderated by the given user.
     */
    var UserManagedChannelCollection = ChannelCollection.extend({
        // listModeratedChannels includes channels that are owned
        url: api.getURL('users/listModeratedChannels'),

        initialize: function (_models, options) {
            this.user = options.user;
            this.listenTo(this.user, 'change:id', this.sort);
        },

        /**
         * Sorts the collection so that channels created by the given user
         * appear above channels that are moderated by the given user.
         * Within each section, channels are sorted alphabetically by name,
         * case-insensitive.
         */
        comparator: function (channel1, channel2) {
            var userId = this.user.get('id');
            var sessionUserOwnsChannel1 = channel1.get('owner_id') === userId;
            var sessionUserOwnsChannel2 = channel2.get('owner_id') === userId;

            // If both channels are (not) owned, compare their names. Don't need
            // to handle name equality, as channel names are unique.
            if (sessionUserOwnsChannel1 === sessionUserOwnsChannel2) {
                return channel1.get('name').toLowerCase() < channel2.get('name').toLowerCase() ?
                    -1 : 1;
            }

            // If channel1 is owned and channel2 is not, channel1 should appear
            // above channel2.
            if (sessionUserOwnsChannel1)
                return -1;

            // If channel2 is owned and channel1 is not, channel2 should appear
            // above channel1.
            return 1;
        },

        fetch: function (options) {
            return ChannelCollection.prototype.fetch.call(this, _.defaults({
                data: {
                    user: 'username:' + this.user.get('username'),
                    // TODO: remove this once D18919 deploys to make excludeOwned false by default
                    excludeOwned: 0,
                },
            }, options));
        },
    });

    return UserManagedChannelCollection;
});

define('home/models/UserModerationDetails',[
    'backbone',

    'home/utils/backboneUtils',

    'core/api',
], function (
    Backbone,

    backboneUtils,

    api
) {
    'use strict';

    var UserModerationDetails = Backbone.Model.extend({
        idAttribute: 'username',
        url: api.getURL('internal/users/moderationDetails'),

        initialize: function (options) {
            options = options || {};
            this.forum = options.forum;
            this.network = options.network;
        },

        shouldFetch: function () {
            return !this.get('username') || !this.get('forumsPostedIn');
        },

        fetch: function () {
            var options = {
                data: {
                    user: 'username:' + this.get('username'),
                    forum: this.forum || null,
                    network: this.network ? 'username:' + this.network : null,
                },
            };

            return backboneUtils.memoizedFetch.call(this, options);
        },

        ensureFetched: function () {
            if (this.shouldFetch())
                this.fetch();
        },

        parse: function (response) {
            return response.response;
        },

    });

    return UserModerationDetails;
});

define('home/models/UserProfile',[
    'jquery',
    'underscore',
    'backbone',

    'core/switches',

    'home/utils/backboneUtils',

    'home/collections/BadgeCollection',
    'home/collections/PaginatedUserCollection',
    'home/collections/FeedItemCollection',
    'home/collections/FollowingForumCollection',
    'home/collections/FollowingChannelCollection',
    'home/collections/FollowingUserCollection',
    'home/collections/ForumBadgesCollection',
    'home/collections/MostActiveForumCollection',
    'home/collections/UserManagedChannelCollection',

    'core/UniqueModel',
    'home/models/Badge',
    'home/models/User',
    'home/models/Feed',
    'home/models/UserModerationDetails',

    'core/api',
], function (
    $,
    _,
    Backbone,

    switches,

    backboneUtils,

    BadgeCollection,
    PaginatedUserCollection,
    FeedItemCollection,
    FollowingForumCollection,
    FollowingChannelCollection,
    FollowingUserCollection,
    ForumBadgesCollection,
    MostActiveForumCollection,
    UserManagedChannelCollection,

    UniqueModel,
    Badge,
    User,
    Feed,
    UserModerationDetails,

    api
) {
    'use strict';

    var UserProfile = Backbone.Model.extend({
        idAttribute: 'username',

        initialize: function (_attributes, options) {
            this.initializeRelated(
                'user',
                _.defaults({
                    user: { username: this.get('username') },
                }, options),
                User
            );

            this.user.listenTo(this, 'change:username', this.updateUsername);
            this.listenTo(this.user, 'change:isFollowing', this.updateFollowers);

            var userFetchString = 'username:' + this.user.get('username');
            var fetchOptions = {
                user: userFetchString,
                order: 'desc',
            };

            this.forumsFollowing = new Feed({
                fetchOptions: fetchOptions,
            }, {
                collectionClass: FollowingForumCollection,
            });

            // channelsFollowing is a list of channels that are followed directly because
            // their primary forums cannot be followed (as opposed to followedChannels below,
            // which contains channels followed via any means).
            // ex: Disqus Picks is followed by too many people, if the forum were followed
            // it would result in activities being copied to too many users' activity feeds.
            this.channelsFollowing = new Feed({
                fetchOptions: fetchOptions,
            }, {
                collectionClass: FollowingChannelCollection,
            });
            this.listenToOnce(this.channelsFollowing, 'items:sync', function () {
                this.user.set({
                    numChannelsFollowing: this.channelsFollowing.items.length,
                });
            });

            this.syncFollowingCommunities();

            this.following = new Feed({
                fetchOptions: fetchOptions,
            }, {
                collectionClass: FollowingUserCollection,
            });

            this.followers = new Feed({
                fetchOptions: fetchOptions,
            }, {
                collectionClass: PaginatedUserCollection,
                collectionUrl: api.getURL('users/listFollowers'),
            });

            this.forumBadges = new Feed({
                fetchOptions: {
                    user: userFetchString,
                },
            }, {
                collectionClass: ForumBadgesCollection,
                collectionUrl: api.getURL('badges/awarded'),
            });

            this.mostActiveForums = new Feed({
                fetchOptions: {
                    user: userFetchString,
                    limit: 5,
                },
            }, {
                collectionClass: MostActiveForumCollection,
            });

            // A feed of channels the user manages: either as a mod or creator
            this.managedChannels = new Feed(undefined, {
                collectionClass: UserManagedChannelCollection,
                collectionOptions: {
                    user: this.user,
                },
            });

            // A feed of channels the user follows, either directly or via a primary forum.
            // Excludes managed channels, as those are fetched in another feed.
            this.followedChannels = new Feed({
                fetchOptions: {
                    user: userFetchString,

                    // Endpoint expects 1 for true, 0 for false
                    includeFollowedPrimaryForums: 1,
                    excludeModerated: 1,
                    excludeOwned: 1,
                },
            }, {
                collectionClass: FollowingChannelCollection,
                collectionOptions: {
                    url: api.getURL('users/listFollowingChannels'),
                },
            });


            // For the endpoints that expect a target argument of the forum
            // <object_type>:<object_id>
            // ex: {target: 'user:username:joesmith'}
            var target = 'user:' + userFetchString;

            this.posts = new Feed(undefined, {
                collectionClass: FeedItemCollection,
                collectionOptions: {
                    type: 'profile',
                    index: 'comments',
                    target: target,
                },
            });

            this.favorites = new Feed(undefined, {
                collectionClass: FeedItemCollection,
                collectionOptions: {
                    type: 'profile',
                    index: 'favorites',
                    target: target,
                },
            });

            this.threads = new Feed(undefined, {
                collectionClass: FeedItemCollection,
                collectionOptions: {
                    type: 'profile',
                    index: 'threads',
                    target: target,
                },
            });

            this.profileFeed = new Feed(undefined, {
                collectionClass: FeedItemCollection,
                collectionOptions: {
                    type: 'profile',
                    target: target,
                },
            });

            this.moderationDetails = new UserModerationDetails({
                username: this.user.get('username'),
            });

            this.listenTo(this.user, 'change:isOnGlobalBlacklist', this.handleChangeGlobalBlacklist);
            this.listenTo(this.user, 'blacklist:add', this.removeUserDiscussions);
            this.listenTo(this.user, 'change:username', this.updateUsernameInChildren);
        },

        // On the frontend we want to treat followed channels and followed forums the
        // same. Copy all the followed channels' primary forums into the followed
        // forums list so they will be shown where we show followed communities.
        syncFollowingCommunities: function () {
            var forums = this.forumsFollowing.items;
            var channels = this.channelsFollowing.items;

            this.listenTo(channels, {
                reset: function () {
                    forums.add(_.pluck(channels.models, 'primaryForum'), { at: 0 });
                },
                add: function (channel) {
                    forums.add(channel.primaryForum, { at: 0 });
                },
                remove: function (channel) {
                    forums.remove(channel.primaryForum);
                },
            });

            // When forumsFollowing is fetched it'll reset and overwrite all the forums
            // manually added from followingChannels. Re-add them.
            this.listenTo(forums, 'reset', function () {
                forums.add(_.pluck(channels.models, 'primaryForum'), { at: 0 });
            });
        },

        handleChangeGlobalBlacklist: function () {
            if (!this.user.get('isOnGlobalBlacklist')) {
                return;
            }
            this.removeUserDiscussions();
        },

        // Pages through all the user's discussions and deletes them. If a `forum` is
        // passed, it'll only delete discussions from that forum.
        removeUserDiscussions: function (forum) {
            // If we've already fetched this user's discussions, go ahead and start
            // loading the next page with `fetchItems()`. If we haven't fetched threads
            // yet, call `ensureFetched()` because this handles the logic of not
            // duplicating a fetch that's in progress.
            var fetchPromise = this.threads.get('fetched') ? this.threads.fetchItems() : this.threads.ensureFetched();
            fetchPromise.then(_.bind(function () {
                this.threads.items.each(function (threadActivity) {
                    var thread = threadActivity.thread;
                    if (forum && thread.forum.id !== forum) {
                        return;
                    }
                    thread.removeThread();
                });

                // Repeat as long as there's more pages
                if (this.threads.get('hasNext')) {
                    this.removeUserDiscussions(forum);
                }
            }, this));
        },

        isPrivate: function () {
            return !this.user.isSessionUser() && this.user.get('isPrivate');
        },

        isBlocked: function () {
            return !this.user.isSessionUser() && this.user.get('isBlocked');
        },

        getBadgesCollection: function () {
            var collection = new BadgeCollection();
            if (this.user.get('badges')) {
                this.user.get('badges').forEach(function (badge) {
                    collection.add(new Badge(badge));
                });
            }
            return collection;
        },

        ensureFetched: function () {
            // We require Session inline because of a circular dependency
            // between the UserProfile and Session models
            var Session = require('home/models/Session');
            var session = Session.get();

            session.loadPromise().always(_.bind(function () {
                var isGlobalAdmin = session.user.isGlobalAdmin();
                // Wait until we can tell if the user is private
                // before fetching anything else
                backboneUtils.getPromiseFor(this.user, 'isPrivate').then(_.bind(function () {
                    if (this.isPrivate() && !isGlobalAdmin) {
                        return;
                    }
                    this.favorites.ensureFetched();
                    this.posts.ensureFetched();
                    this.threads.ensureFetched();
                    this.mostActiveForums.ensureFetched();

                    // Don't fetch followedChannels or managedChannels. Those are only
                    // shown for the session user and are fetched directly when needed.

                    // numChannelsFollowing is not returned by the user details API endpoint
                    // like both numFollowing (users) and numForumsFollowing are,
                    // so we need to fetch channels to get the count
                    this.channelsFollowing.ensureFetched();

                    // Only load moderation details for Disqus admins
                    var self = this;
                    if (isGlobalAdmin) {
                        self.moderationDetails.ensureFetched();
                        $.when(self.moderationDetails.fetchPromise).then(function () {
                            self.trigger('moderationDetailsReady');
                        });
                    }
                }, this));

            }, this));

            this.fetchUser();
        },

        ensureFetchedAllChannels: function () {
            this.managedChannels.ensureFetched();
            this.followedChannels.ensureFetched();
        },

        toJSON: function () {
            return _.defaults({
                user: this.user.toJSON(),
                following: this.following.toJSON(),
                followers: this.followers.toJSON(),
                mostActiveForums: this.mostActiveForums.toJSON(),
                posts: this.posts.toJSON(),
                threads: this.threads.toJSON(),
                profileFeed: this.profileFeed.toJSON(),
                moderationDetails: this.moderationDetails.toJSON(),
            }, Backbone.Model.prototype.toJSON.call(this));
        },

        /**
         * Makes the necessary fetch calls in order to render the profile
         * view for this user.
         */
        fetchUser: function () {
            // If this user has an id, it should also have a username. Users
            // get ids along with all the rest of the user details, whereas
            // it's possible to have just a username with no other details.
            if (!this.user.get('username')) {
                throw new Error('UserProfile requires a username or id in order to be fetched');
            }
            if (this.user.shouldFetch()) {
                this.user.fetch({ data: { user: 'username:' + this.user.get('username') } });
            }
        },

        fetchFollowing: function () {
            this.following.fetchItems({ reset: true });
        },

        fetchForumsFollowing: function () {
            this.forumsFollowing.fetchItems({ reset: true });
        },

        fetchChannelsFollowing: function () {
            this.channelsFollowing.fetchItems({ reset: true });
        },

        /**
         * Updates the list of this user's followers when the
         * session user follows/unfollows this user.
         */
        updateFollowers: function () {
            var Session = require('home/models/Session');
            var session = Session.get();

            // Don't add an anonymous user to the followers list.
            //
            // (If an anon user tried to follow someone, they'll be prompted
            // to login. That happens elsewhere and may happen after this
            // handler)
            if (session.isAnonymous()) {
                return;
            }
            var items = this.followers.get('items');
            if (this.user.get('isFollowing')) {
                items.add(session.user);
            } else {
                items.remove(session.user);
            }
        },

        /**
         * Updates an object's username.
         * Meant to be used as an event listener
         *
         * @param  {Object} _model - the Backbone model that was updated
         * @param  {string} username - the new username
         * @returns {void}
         */
        updateUsername: function (_model, username) {
            this.set('username', username);
        },

        /**
         * Updates the username for children.
         * Meant to be used as an event listener, listening to changes to this.user.username.
         *
         * Doesn't need to update `this.managedChannels` because it has a reference to `this.user`.
         *
         * @param  {Object} _model - the Backbone model that was updated
         * @param  {string} username - the new username
         * @returns {void}
         */
        updateUsernameInChildren: function (_model, username) {
            // Some places use `username:<username>` and others use `user:username:<username>`.
            // The ones that use `username:<username>` are initialized with `fetchOptions`.
            // The ones that use `user:username:<username>` are initialized with `collectionOptions`.
            var targetUsername = 'username:' + username;
            var usernameObj = { user: targetUsername };

            var objsUsingFetchOptions = [this.forumsFollowing, this.channelsFollowing, this.following,
                this.followers, this.mostActiveForums, this.followedChannels];
            _.each(objsUsingFetchOptions, function (feed) {
                feed.set('fetchOptions', _.extend(feed.get('fetchOptions'), usernameObj));
            });

            targetUsername = 'user:' + targetUsername;
            var uniqueTogether = { target: targetUsername };

            var objsUsingUniqueTogether = [this.posts, this.favorites, this.threads, this.profileFeed];
            _.each(objsUsingUniqueTogether, function (feed) {
                feed.items.updateUniqueTogether(uniqueTogether);
            });

            this.moderationDetails.set('username', username); // Just has a reference to username
        },
    });

    UniqueModel.addType('UserProfile', UserProfile);

    return UserProfile;
});

define('home/models/AnonUser',[
    'core/models/BaseUser',

    'home/utils/navigationUtils',
], function (
    BaseUser,

    navigationUtils
) {
    'use strict';

    var AnonUser = BaseUser.extend({
        initialize: function () {
            this.listenTo(this, 'followed:user', this.promptLogin);
            this.listenTo(this, 'unfollowed:user', this.promptLogin);
            this.listenTo(this, 'followed:forum', this.promptLogin);
            this.listenTo(this, 'unfollowed:forum', this.promptLogin);
            this.listenTo(this, 'followed:channel', this.promptLogin);
            this.listenTo(this, 'unfollowed:channel', this.promptLogin);
            this.listenTo(this, 'subscribe:thread', this.promptLogin);
            this.listenTo(this, 'unsubscribe:thread', this.promptLogin);
        },

        promptLogin: function () {
            navigationUtils.navigateToLogin();
        },

        isGlobalAdmin: function () {
            return false;
        },
    });

    return (function () {
        var _anonUser;

        return function () {
            if (!_anonUser)
                _anonUser = new AnonUser();

            return _anonUser;
        };
    })();
});

define('home/collections/NotificationCollection',[
    'underscore',
    'backbone',

    'core/api',
    'core/config',

    'home/collections/FeedItemCollection',
], function (
    _,
    Backbone,

    api,
    coreConfig,

    FeedItemCollection
) {
    'use strict';

    var parent = FeedItemCollection;
    var parentProto = parent.prototype;

    var NotificationCollection = parent.extend({
        fetch: function (options) {
            options = options ? _.clone(options) : {};
            options.data = options.data ? _.clone(options.data) : {};

            // no need to check if readPosition is undefined because
            // $.ajax will ignore undefined values in options.data
            options.data.readPosition = this.readPosition;
            options.data.routingVersion = coreConfig.feedApiVersion;

            return parentProto.fetch.call(this, options);
        },

        parse: function (response, options) {
            // readPosition is saved to pass on subsequent fetches for more notifications.
            // This will ensure that the api will correctly mark the returned notifications
            // as read or not, based on the original readPosition and not based on a
            // readPosition that we update ourselves during this session.
            if (!this.readPosition || options.reset)
                this.readPosition = response.response.readPosition;

            var parsed = parentProto.parse.apply(this, arguments);
            var NotificationCardCollectionView = require('home/views/NotificationCardCollectionView');

            return _.filter(parsed, function (item) {
                if (_.chain(NotificationCardCollectionView.ITEM_VIEWS).keys().contains(item.get('verb')).value())
                    return true;

                if (window.Raven)
                    window.Raven.captureMessage('unsupported activity item', { extra: item });
            });
        },

        syncReadPosition: function () {
            var latestPosition = this.latestPosition;

            if (!latestPosition ||
                // avoid calling setReadPosition repeatedly with same value
                latestPosition === this.previousLatestPosition ||
                latestPosition === this.readPosition)
                return;

            this.previousLatestPosition = latestPosition;

            // TODO use this.sync here?
            Backbone.ajax({
                url: api.getURL('timelines/setReadPosition'),
                type: 'POST',
                data: _.extend({}, this.uniqueTogether, {
                    position: latestPosition,
                }),
            });
        },
    });

    return NotificationCollection;
});

define('home/models/TimelineFilter',[
    'backbone',

    'core/api',
    'core/config',
], function (
    Backbone,

    api,
    config
) {
    'use strict';

    return Backbone.Model.extend({

        urls: {
            'update': api.getURL('timelines/filters/add'),
            'delete': api.getURL('timelines/filters/remove'),
        },

        parse: function (response) {
            return response.response || response;
        },

        serializeData: function () {
            return {
                filter: this.id,
                api_key: config.keys.api,
            };
        },

        sync: function (method, model, options) {
            options.emulateHTTP = true;
            options.emulateJSON = false;
            options.processData = true;
            if (method === 'update' || method === 'delete')
                options.data = model.serializeData();
            options.url = this.urls[method];
            return Backbone.Model.prototype.sync.call(this, method, model, options);
        },

    }, {
        // IDs of filters
        FILTER_LIKEPOST: 'likepost',
        FILTER_INVITE: 'invite',
        FILTER_RECOMMEND: 'favoritethread',
        FILTER_THREADREPLIES: 'threadreplies',
        FILTER_MENTIONS: 'mentions',
    });
});

define('home/collections/TimelineFiltersCollection',[
    'jquery',
    'backbone',

    'core/api',

    'home/models/TimelineFilter',
], function (
    $,
    Backbone,

    api,

    Filter
) {
    'use strict';

    return Backbone.Collection.extend({

        model: Filter,

        initialize: function (_items, options) {
            options = options || {};
            this.type = options.type;
        },

        url: function () { return api.getURL('timelines/filters/list') + '?' + $.param({ type: this.type }); },

        addFilter: function (filterName) {
            var exists = this.get(filterName);
            if (!exists)
                exists = this.add({ id: filterName });
            return exists.save();
        },

        removeFilter: function (filterName) {
            var exists = this.get(filterName);
            if (!exists)
                exists = new Filter({ id: filterName });
            return exists.destroy();
        },

        parse: function (response) {
            return response.response || response;
        },
    });
});

define('home/models/FollowRecommendation',[
    'backbone',

    'core/UniqueModel',
], function (
    Backbone,

    UniqueModel
) {
    'use strict';

    var FollowRecommendation = Backbone.Model.extend({
        defaults: {
            reason: '',
        },

        initialize: function () {
            this.object = this.get('object');
            this.unset('object');
        },
    });

    UniqueModel.addType('FollowRecommendation', FollowRecommendation);

    return FollowRecommendation;
});

define('home/collections/FollowRecommendationCollection',[
    'underscore',
    'backbone',

    'core/UniqueModel',
    'home/models/FollowRecommendation',
], function (
    _,
    Backbone,

    UniqueModel,
    FollowRecommendation
) {
    'use strict';

    return Backbone.Collection.extend({
        model: UniqueModel.boundModel(FollowRecommendation),

        initialize: function (_models, options) {
            this.expander = options.expander;
        },

        parse: function (response) {
            response = response.response;
            return _.map(response.items, function (followRecommendation) {

                return {
                    object: this.expander(response.objects, followRecommendation.id),
                    reason: followRecommendation.reason,
                };
            }, this);
        },
    });
});

define('home/models/FollowRecommendationFeed',[
    'underscore',

    'core/api',

    'home/activityExpander',
    'home/models/Feed',
    'home/collections/FollowRecommendationCollection',
], function (
    _,

    api,

    activityExpander,
    Feed,
    FollowRecommendationCollection
) {
    'use strict';

    var FollowRecommendationFeed = Feed.extend({
        defaults: {
            fetchOptions: {
                limit: 3,
            },
        },

        initialize: function (attrs, options) {
            options = options || {};
            options.collectionClass = FollowRecommendationCollection;

            return Feed.prototype.initialize.call(this, attrs, options);
        },
    }, {
        // Factory methods for creating common FollowRecommendationFeeds:
        // users and forums
        createUserFollowRecommendationFeed: function (attrs) {
            attrs = attrs || {};

            return new FollowRecommendationFeed(attrs, {
                collectionOptions: {
                    expander: _.bind(activityExpander.buildUser, activityExpander),
                },
                collectionUrl: api.getURL('users/interestingUsers'),
            });
        },

        createForumFollowRecommendationFeed: function (attrs) {
            attrs = attrs || {};

            return new FollowRecommendationFeed(attrs, {
                collectionOptions: {
                    expander: _.bind(activityExpander.buildForum, activityExpander),
                },
                collectionUrl: api.getURL('forums/interestingForums'),
            });
        },
    });

    return FollowRecommendationFeed;
});

define('home/models/Notifications',[
    'backbone',

    'home/models/Feed',
    'home/collections/NotificationCollection',
    'home/collections/TimelineFiltersCollection',
    'home/models/FollowRecommendationFeed',
], function (
    Backbone,

    Feed,
    NotificationCollection,
    TimelineFiltersCollection,
    FollowRecommendationFeed
) {
    'use strict';

    var Session;

    var Notifications = Backbone.Model.extend({

        initialize: function (attrs) {
            this.session = attrs.session;

            var timeComparator = function (notification) {
                // Sort notifications by time descending
                return -1 * new Date(notification.get('published')).getTime();
            };

            this.all = new Feed({}, {
                collectionClass: NotificationCollection,
                collectionOptions: {
                    comparator: timeComparator,
                    type: 'notifications',
                },
            });
            this.replies = new Feed({}, {
                collectionClass: NotificationCollection,
                collectionOptions: {
                    comparator: timeComparator,
                    type: 'notifications',
                    index: 'replies',
                },
            });

            this.interestingForums = FollowRecommendationFeed.createForumFollowRecommendationFeed();
            this.interestingUsers = FollowRecommendationFeed.createUserFollowRecommendationFeed();

            this.unreadCounter = this.all.items.unreadCounter;
            this.filters = new TimelineFiltersCollection();

            this.listenTo(this.all, 'clearUnreadCount', this.clearUnreadCount);
        },

        // Fetch recommendations needed for notifications view
        ensureFetchedRecommendations: function () {
            this.interestingForums.ensureFetched();
            this.interestingUsers.ensureFetched();
        },

        // This should only contain fetches useful across all pages (ex: unread count)
        // It should not fetch things needed only on the notifications page, since this
        // is called upon app initialization.
        ensureFetched: function () {
            // Lazy load Session to prevent circular dependency
            if (!Session)
                Session = require('home/models/Session');

            // If the user isn't logged in then we
            // definitely don't have any notifications
            // to fetch.
            if (Session.isKnownToBeLoggedOut() ||

                // Also, don't fetch if already fetched
                this.all.fetched)
                return;

            this.unreadCounter.fetch({
                initializeOnly: true,
            });
            this.all.fetchItems();
        },

        /**
         * Updates the backend readPosition so that future
         * calls will mark all the currently-showing notifications as read.
         * Does not visually mark items already in the UI as read.
         */
        clearUnreadCount: function () {
            // Note: set to 0, as opposed to calling `.unset()` so the model
            // knows the value has been set
            this.unreadCounter.set({ numUnread: 0 });
            this.all.items.syncReadPosition();
        },
    });

    return Notifications;
});

define('home/models/Session',[
    'jquery',
    'underscore',
    'backbone',

    'core/api',
    'core/models/Session',
    'core/UniqueModel',

    'home/models/User',
    'home/models/UserProfile',
    'home/models/AnonUser',
    'home/models/Notifications',
    'home/utils/backboneUtils',
    'home/utils/sidebarUtils',
], function (
    $,
    _,
    Backbone,

    api,
    SharedSession,
    UniqueModel,

    User,
    UserProfile,
    AnonUser,
    Notifications,
    BackboneUtils,
    SidebarUtils
) {
    'use strict';

    var Session = SharedSession.extend({
        initialize: function () {
            SharedSession.prototype.initialize.apply(this, arguments);
            this.moderatedForums = []; // array of forum ids that this user moderates
            this._load = $.Deferred();
            this._loadPromise = this._load.promise();

            // Load may not be called more than once per Session instance.
            this.load = _.once(this.load, this);
            this.loadModeratedForums = _.once(this.loadModeratedForums, this);
        },

        // Overridden from parent. This returns the usr instance to use
        // when no user is logged in.
        getAnonUserInstance: function (attrs) {
            return new AnonUser(attrs);
        },

        isAnonymous: function () {
            return this.user.get('isAnonymous');
        },

        setUser: function (user) {
            if (this.user)
                this.stopListening(this.user);

            this.listenTo(user, 'all', this.trigger);

            return SharedSession.prototype.setUser.apply(this, arguments);
        },

        /**
         * Load session user's moderated forums.
         *
         * Returns immediately if disqusauth cookie indicates user
         * is not a moderator. Otherwise makes a network request.
         *
         * This method is memoized with `_.once`.
         * @returns {Promise}
         */
        loadModeratedForums: function () {
            var user = this.user;
            var self = this;

            if (Session.fromCookie().isModerator) {
                // When the session logs in, we look to see what forums the
                // session user moderates
                return Backbone.ajax({
                    url: api.getURL('internal/users/details'),
                    success: function (data) {
                        var moderatedForums = data.response.moderated_forums;
                        self.moderatedForums = moderatedForums;
                        self.trigger('setModeratedForums', moderatedForums);
                        user.set({
                            isModerator: Boolean(moderatedForums.length),
                            moderatedForums: moderatedForums,
                        });
                    },
                    context: user,
                });
            }

            return $.Deferred().resolve().promise();
        },

        /**
         * Who is providing user authentication and details for this session?
         *
         * @returns {string} account type or '' if there is no session information
         */
        provider: function () {
            var username = Session.fromCookie().username;
            if (!username)
                return '';

            return username.indexOf('-') === -1 ? 'disqus' : username.split('-')[0];
        },

        fromSessionStorage: function () {
            var attrs;
            try {
                attrs = JSON.parse(window.sessionStorage[Session.STORAGE_KEY]);
                delete window.sessionStorage[Session.STORAGE_KEY];
            } catch (err) {
                // Pass
            }
            return _.isObject(attrs) ? attrs : undefined;
        },

        /**
         * Load the session.
         *
         * First looks at session storage. If not there, determines if user is logged
         * out based on the disqusauth cookie. If user is logged in, kicks off a network
         * fetch call.
         * Resolves or rejects the promise returned by `this.session.loadPromise()`.
         *
         * This method is memoized with `_.once`.
         */
        load: function () {
            var load = this._load;

            // First we check if we can load a valid user from
            // session storage. We assume the user is valid if the
            // attributes have a username and an ID.
            //
            // Only do this in the sidebar, because home uses User attrs
            // that are not set in sessionstorage
            var userAttrs = this.fromSessionStorage();
            if (SidebarUtils.isSidebar() && userAttrs && userAttrs.username && userAttrs.id) {
                this.setUser(this.getUserInstance(userAttrs));
                this.fetched = true;
                load.resolve(this);
            }

            // If we didn't load from sesssion storage, we should
            // check if we think the user is even logged in.
            else if (!SharedSession.isKnownToBeLoggedOut()) {  // eslint-disable-line no-negated-condition

                var self = this;
                self.fetch()
                    .done(function () { load.resolve(self); })
                    .fail(function () { load.reject(self); });
            }

            else {
                load.reject(this);
            }
        },

        loadPromise: function () {
            return this._loadPromise;
        },

        fetch: function () {
            if (this.fetchPromise)
                // Return early if we're already fetching so we don't
                // bind handlers multiple times
                return this.fetchPromise;

            var self = this;
            var fetchPromise = BackboneUtils.memoizedFetch.apply(this, arguments);

            // The base/shared session does not go through Backbone,
            // so sync/error events are not properly fired. Thus, we
            // are left with creating our own
            fetchPromise.then(function () {
                self.trigger('fetch:success');
            }, function () {
                self.trigger('fetch:error');
            });

            return fetchPromise;
        },

        getUserInstance: function (attrs) {
            return new UniqueModel(
                User,
                attrs
            );
        },

        getUserProfile: function () {
            if (this.isAnonymous())
                return;

            return this.userProfile;
        },

        getOrCreateNotifications: function () {
            if (!this.notifications) {
                this.notifications = new Notifications({ session: this });
                this.notifications.ensureFetched();
            }

            return this.notifications;
        },

        toJSON: function () {
            return this.user.toJSON.apply(this.user, arguments);
        },

        /**
         * Creates the userProfile model for the session user.
         * @param  {string} username - The username of the session user.
         */
        initUserProfile: function (username) {
            if (!username)
                return;

            // Unbind listeners on previous user profile
            if (this.userProfile)
                this.userProfile.stopListening(this);

            this.userProfile = new UniqueModel(UserProfile, {
                username: username,
            });

            var markChannelsOrForums = function (forums) {
                // Check if given a single forum because items:sync may be a propagated
                // event from a single item in the collection.
                // Wrap forum as an underscore collection, as function expects.
                if (forums instanceof Backbone.Model)
                    forums = _([forums]);

                forums.each(function (forum) {
                    // If this is a channel, make sure we're marking its primary forum
                    if (forum.primaryForum)
                        forum = forum.primaryForum;

                    forum.set('isFollowing', true);
                });
            };
            // Listen for when following forums are loaded so that they can be
            // properly marked as followed by the session user
            this.userProfile.forumsFollowing.on('items:sync', markChannelsOrForums);
            this.userProfile.channelsFollowing.on('items:sync', markChannelsOrForums);

            // Listen for when the session user (un)follows a forum/user, so the user profile's
            // following collections can be properly updated
            var followingUsers = this.userProfile.following.get('items');
            var followingForums = this.userProfile.forumsFollowing.get('items');
            var followingChannels = this.userProfile.channelsFollowing.get('items');
            this.userProfile.listenTo(this, 'followed:user', _.bind(followingUsers.add, followingUsers));
            this.userProfile.listenTo(this, 'unfollowed:user', _.bind(followingUsers.remove, followingUsers));
            this.userProfile.listenTo(this, 'followed:forum', _.bind(followingForums.add, followingForums));
            this.userProfile.listenTo(this, 'unfollowed:forum', _.bind(followingForums.remove, followingForums));
            this.userProfile.listenTo(this, 'followed:channel', _.bind(followingChannels.add, followingChannels));
            this.userProfile.listenTo(this, 'unfollowed:channel', _.bind(followingChannels.remove, followingChannels));

            this.fetchFollowedForums();
            this.fetchFollowedChannels();
        },

        /**
         * Fetches the list of forums the session user is following (up to 100) so that they can
         * be marked as followed. This is so that we can indicate to the user correctly when they
         * see a forum whether or not they are following it, as that information is not returned
         * in forum details from the api.
         *
         * Written as a separate function so that the asEmbedApp can overwrite with a no-op, as
         * the sidebar does not need it for all routes. Will be manually called by each view
         * if necessary. Currently needed for forum profile and user profile following forums tab.
         */
        fetchFollowedForums: function () {
            this.userProfile.fetchForumsFollowing();
        },

        fetchFollowedChannels: function () {
            this.userProfile.fetchChannelsFollowing();
        },

        logout: function () {
            this.setUser(this.getAnonUserInstance());
            window.top.location = '//disqus.com/logout/?redirect=http%3A%2F%2Fdisqus.com';
        },
    }, {
        STORAGE_KEY: 'home.session',
    });


    // Linter wants the definition moved to the top of the file, defining it here close
    // to use is more readable.
    var _session;  // eslint-disable-line one-var

    Session.get = function () {
        _session = _session || new Session();
        return _session;
    };

    // Normally this method should only be used by tests
    Session.forget = function () {
        if (_session) {
            _session.stopListening();
            _session.off();
            _session = null;
        }
    };

    return Session;
});

define('core/analytics/jester',[
    'jquery',
    'underscore',
    'backbone',

    'core/analytics/identity',
    'core/config/urls',
], function (
    $,
    _,
    Backbone,

    identity,
    urls
) {
    'use strict';

    /*
        Jester is an ActivityStreams logger for Disqus.

        # About Product, Zone, Section, Area:

        Yeah, you are probably confused about what these descriptors mean. We are mostly confused, too.
        So, to help out, here is a comprehensive guide:

            Product
                A product is a suite of one or many applications that fall underneath an analytics
                'umbrella'. These are currently only 'embed' and 'home'.

            Zone
                A zone represents the product application that the user is currently interacting with.
                These are currently 'thread', 'notifications', 'profile', 'onboard', and 'community'.

            Section
                Section is the "route" that the application is currently displaying. This is analogous
                to a Backbone.Router method. It must uniquely represent the *visual state* of the application
                at the time of the interaction we are logging. Applications may have only one route, or
                they may have many routes.

            Area
                An xpath-ish type identifier that describes where in the DOM the logged interaction took place,
                if any. Some interactions may not have a DOM location, in which case 'n/a' is sent instead.
                Actual Xpath not really required.

        # Serializing Product, Zone, Section, Area:

        When we serialize Product, Zone, Section, or Area as an ActivitySteam object, we use a specific format
        that allows for proper analytics rollups both between products and between cross product applications:

        Products:
            object_type='product'
            object_id=<product name>

        Zones:
            object_type='zone'
            object_id=<zone name>

        Sections:
            object_type='section'
            object_id=<zone name>/<section name>

        Areas:
            object_type='area'
            object_id=<zone name>/<section name>#<area name>
    */

    var ActivityClient = Backbone.Model.extend({
        url: urls.jester + '/event.js',

        defaults: {
            experiment: 'default',
            variant: 'control',
        },

        setHostReferrer: function (url) {

            if (!url) {
                // Indicate no referrer as direct traffic
                this.set('page_referrer', 'direct');
            } else if (url.indexOf('http') === -1) {
                // We should only set fully qualified URLs as
                // the referrer domain.
            } else {
                // If this the client visited cnn.com from facebook.com/xxxx,
                // and cnn.com loaded this embed, the page_referrer would
                // be facebook.com/xxxx.
                this.set('page_referrer', url);
            }
        },

        decoratePayload: function (payload) {

            // The default category for all our events
            // is 'activity'. Only allow overrides of this
            // during an `emit` call.
            if (!payload.event)
                payload.event = 'activity';

            // Allow payload attributes to override attributes
            // set on the client instance.
            payload = _.extend(this.toJSON(), payload);

            _.extend(payload, {
                imp: identity.impression.impId,
                prev_imp: identity.impression.prevImp,
            });

            // If there is no current application route for this event,
            // we assume it is the 'default' route of the application.
            if (!payload.section)
                payload.section = 'default';

            // If there is no specified event xpath (maybe this event did not
            // originate in the DOM), then we pass Not Available.
            if (!payload.area)
                payload.area = 'n/a';

            // IE8 and IE9 has a stupid limit on the URL length and we cannot
            // use POST method with Jester yet due to CORS issues (again in IE8
            // and IE9) so we simply check total length of the QSA part as
            // mentioned in MS KB article http://support.microsoft.com/kb/q208427
            // and if it is longer than the limit, 2048 chars, we replace it
            // with a more modest, page_referrer_domain
            //
            // NOTE: The final URL is still NOT guaranteed to be < 2048 chars
            var qsaLength = $.param(payload).length;
            if (qsaLength > 2048 && this.has('page_referrer')) {
                var referrerLink = window.document.createElement('a');
                referrerLink.href = this.get('page_referrer');
                var hostname = referrerLink.hostname;

                if (hostname)
                    payload.page_referrer_domain = hostname;

                delete payload.page_referrer;
            }

            return payload;
        },

        emit: function (payload) {
            // Fire the event to the jester endpoint and return
            // the deferred object
            return $.ajax({
                url: _.result(this, 'url'),
                data: this.decoratePayload(payload),
                dataType: 'script',

                // default is false for 'script' dataType, setting to true
                // so that "_={timestamp}" isn't appended to this request
                cache: true,
            });
        },
    });

    var logStat = function logStat(name) {
        var beacon = new window.Image();
        beacon.src = urls.jester + '/stat.gif?' + $.param({ event: name });

        return beacon;
    };

    var telemetry = function telemetry(endpoint, payload) {
        if (_.any(payload, function (val) { return val < 0; }))
            return;  // discard the whole data set if anything looks wrong

        // Round all values since statsd expects integers
        _.each(payload, function (val, key) { payload[key] = Math.round(val); });

        var beacon = new window.Image();
        beacon.src = urls.jester + '/telemetry/' + endpoint + '.gif?' + $.param(payload);

        return beacon;
    };

    var client = new ActivityClient();

    client.setHostReferrer(window.document.referrer);

    return {
        ActivityClient: ActivityClient,
        client: client,
        logStat: logStat,
        telemetry: telemetry,
    };
});

define('home/utils/trackingUtils',[
    'jquery',
    'underscore',

    'home/models/Session',

    'home/utils/sidebarUtils',
    'home/utils/navigationUtils',
    'core/analytics/jester',
    'core/bus',
], function (
    $,
    _,

    Session,

    sidebarUtils,
    navigationUtils,
    jester,
    bus
) {
    'use strict';

    // Holds page-specific params to add to track calls, or a promise
    // to be resolved with params. These are cleared out when the page
    // changes.
    var pageParams = {};

    // The jester params that may be added as data attrs on a link
    // for which a click is being tracked
    var linkParams = {
        'forum_id': 'data-forum-pk',
        'thread_id': 'data-thread-id',
        'channel_slug': 'data-channel-slug',
    };

    /**
     * Which params we allow sending to jester. There may be others
     * returned from page views, used by other tracking systems.
     * Use this to filter them out.
     */
    var jesterAllowedPageParams = [
        'channel_slug',
        'forum',
    ];

    /*
     * This must be used instead of jester.client.emit.
     * will not send events to jester if zone is DNT
     */
    var jesterEmit = function (trackingParams) {
        if (trackingParams.zone === 'DNT') {
            return;
        }

        // zone might not be specified in the trackingParams
        // so we have to check the default zone too
        if (!trackingParams.zone && jester.client.get('zone') === 'DNT') {
            return;
        }

        $.when(pageParams).then(function (params) {
            // Emit the event, filtering the params to those allowed by jester
            // (There may be other page params used by other tracking systems)
            jester.client.emit(_.defaults(trackingParams, _.pick(params, jesterAllowedPageParams)));
        });
    };

    var listeners = {
        'openSection': function () {
            jesterEmit({
                verb: 'open',
                object_type: 'section',
                object_id: jester.client.get('zone') + '/' + jester.client.get('section'),
            });
        },

        'viewSection': function (config) {
            config = config || {};
            jesterEmit({
                verb: 'view',
                object_type: 'section',
                object_id: jester.client.get('zone') + '/' + jester.client.get('section'),
                forum: config.forum || null,
                forum_id: config.forumId || null,
            });
        },

        'viewFeed': function (fetchableCollectionView) {
            var params = {
                verb: 'open',
                object_type: 'section',
                object_id: jester.client.get('zone') + '/' + jester.client.get('section') + '/page-1',
            };

            if (fetchableCollectionView.isError()) {
                params.adjective = 'error';
            } else if (!fetchableCollectionView.collection.length) {
                params.adjective = 'empty';
            }

            jesterEmit(params);
        },

        'viewMoreFeed': function (numPages) {
            jesterEmit({
                verb: 'open',
                object_type: 'section',
                object_id: jester.client.get('zone') + '/' + jester.client.get('section') + '/page-' + numPages,
            });
        },

        'removeFollower': function (follower) {
            jesterEmit({
                verb: 'remove-follower',
                object_type: 'user',
                object_id: follower.get('id'),
            });
        },

        // When the UI has successfully created a post.
        // The created post is passed as the first argument.
        'uiCallback:postCreated': function (post, params) {
            params = params || {};
            _.extend(params, {
                object_type: 'post',
                object_id: post.id,
                verb: 'post',
            });

            if (post.has('parent')) {
                // If post is a 'reply' then set
                // the target for the activity to
                // the parent post.
                params.target_type = 'comment';
                params.target_id = post.get('parent'); // parent is just the ID
            }

            jesterEmit(params);
        },

        // Like/dislike a comment
        'uiAction:postUpvote': function (post) {
            jesterEmit({
                verb: 'like',
                object_type: 'post',
                object_id: post.id,
            });
        },
        'uiAction:postUnvote': function (post) {
            // ActivityStreams has no verb for 'undislike'
            // so we don't bother differentiating for now.
            jesterEmit({
                verb: 'unlike',
                object_type: 'post',
                object_id: post.id,
            });
        },
        'uiAction:postDownvote': function (post) {
            jesterEmit({
                verb: 'dislike',
                object_type: 'post',
                object_id: post.id,
            });
        },
        'uiAction:clickLink': function (evt, params) {
            var $target = $(evt.currentTarget);
            var isInternal = navigationUtils.isInbound($target[0]);

            // Check if any of the link params exist as data attrs on the
            // clicked link. Add any specified params.
            _.each(linkParams, function (attrName, paramName) {
                var value = $target.attr(attrName);
                if (value) {
                    params[paramName] = value;
                }
            });

            jesterEmit(_.extend({
                verb: 'click',
                object_type: 'link',
                object_id: $target.attr('href'),
                adverb: isInternal ? 'internal' : 'external',
            }, params));
        },
        // Clicks on edit link
        'uiAction:postStartUpdate': function (post, params) {
            params = params || {};
            _.extend(params, {
                verb: 'click',
                adjective: 'edit',
                object_type: 'link',
                object_id: post.id,
            });
            jesterEmit(params);
        },
        'threadFavorited': function (thread) {
            jesterEmit({
                verb: 'like',
                object_type: 'thread',
                object_id: thread.id,
            });
        },
    };

    // the keys for jesterZoneNames are regexps
    // to match the current url
    //
    // Set values to 'DNT' to disable jester tracking
    // for that url
    var jesterZoneNames = {
        'user': 'profile',
        '/by/\\w+': 'profile',
        'inbox': 'notifications',
        '/welcome/?$': 'welcome',
        '/explore(/.+)?': 'explore',
        'discussion': 'thread',
        'discuss': 'thread',
        'edit': 'thread',
        'forum': 'community',
        'topic': 'topic',
        'settings': 'settings',
        'discover': 'discover',
        '/channels(\\/(yours|explore))?\\/?(\\?.+)?$': 'discover',
        '/channels?/\\w+': 'channel',
        '/home/?$': 'activityfeed',
        'preload': 'DNT',
    };

    // Fallback to n/a when no zone is found so that we
    // know when we are tracking events that
    // 1) need a proper zone OR
    // 2) shouldn't be tracked at all
    var defaultZoneName = 'n/a';

    return {
        init: function () {
            var settings =
                {
                    experiment: 'V2',
                    variant: 'active',
                    product: this.productName(),
                    page_referrer_url: window.document.referrer,
                };

            jester.client.set(settings);

            bus.on(listeners);
        },

        /*
         * if home is opened in an iframe in the embed, the product
         * should be bridge instead of home
         */
        productName: function () {
            return sidebarUtils.isSidebar() ? 'bridge' : 'home';
        },

        jesterEmit: jesterEmit,

        /**
         * Updates url based properties, and clears out page-specific
         * properties set from the previous page
         */
        pageChanged: function () {
            this.urlChanged();

            this.setSection();
            pageParams = {};
        },

        /**
         * Updates the url and zone on url change, since these 2
         * properties are set based on the url value.
         */
        urlChanged: function () {
            var url = window.document.location.href;
            var zone = _.find(jesterZoneNames, function (_zone, regex) {
                return new RegExp(regex).test(url);
            });

            jester.client.set({
                page_url: url,
                zone: zone || defaultZoneName,
            });
        },

        setSection: function (sectionName) {
            jester.client.set({ section: sectionName || 'default' });
        },

        setPageParams: function (paramsPromise) {
            pageParams = paramsPromise;
        },

        initUser: function (userId) {
            if (userId) {
                jester.client.set('user_id', userId);
            }
        },

        trackVisit: function () {
            if (!jester.client.has('zone')) {
                this.urlChanged();
            }

            var productName = this.productName();

            var jesterTrack = function () {
                jesterEmit({
                    verb: 'view',
                    object_type: 'product',
                    object_id: productName,
                });
            };

            var session = Session.get();
            session.loadPromise().always(_.bind(function () {
                this.initUser(session.user.get('id'));
                jesterTrack();
            }, this));
        },
    };
});

define('home/collections/UserCollection',[
    'backbone',

    'core/UniqueModel',
    'home/models/User',
], function (
    Backbone,

    UniqueModel,
    User
) {
    'use strict';

    var UserCollection = Backbone.Collection.extend({
        model: UniqueModel.boundModel(User),

        initialize: function (_models, options) {
            if (options && options.url)
                this.url = options.url;
        },

        parse: function (response) {
            return response.response;
        },
    });

    return UserCollection;
});

define('home/collections/ModeratorCollection',[
    'underscore',

    'home/collections/UserCollection',
], function (
    _,

    UserCollection
) {
    'use strict';

    var ModeratorCollection = UserCollection.extend({
        initialize: function (_models, options) {
            this.channel = options && options.channel;
        },

        parse: function (response) {
            return _.pluck(response.response, 'user');
        },

        /**
         * Sorts the collection so that the channel owner will appear at
         * the top of the list, and the other users will appear in alphabetical
         * order (case-insensitive)
         */
        comparator: function (user1, user2) {
            var channelOwnerId = this.channel && this.channel.get('owner_id');
            var user1IsOwner = user1.get('id') === channelOwnerId;
            var user2IsOwner = user2.get('id') === channelOwnerId;

            // If both users are/are not the channel owner, compare their names.
            // Don't worry about name equality, for equal names the sort order
            // is arbitrary.
            if (user1IsOwner === user2IsOwner) {
                return user1.get('name').toLowerCase() < user2.get('name').toLowerCase() ?
                    -1 : 1;
            }

            // If user1 is the channel owner, user1 should appear above user2
            if (user1IsOwner)
                return -1;

            // If user2 is the channel owner, user2 should appear above user1
            return 1;
        },
    });

    return ModeratorCollection;
});

define('home/collections/SourceForumCollection',[
    'underscore',
    'core/api',
    'home/collections/ForumCollection',
], function (
    _,
    api,
    ForumCollection
) {
    'use strict';

    var SourceForumCollection = ForumCollection.extend({
        url: api.getURL('internal/channels/listSourceForums'),

        initialize: function (_models, options) {
            this.channelId = options && options.channelId;
        },

        fetch: function (options) {
            options = options || {};
            options.data = _.extend({
                channel: this.channelId,
                attach: 'counters',
            }, options.data);

            return ForumCollection.prototype.fetch.call(this, options);
        },
    });

    return SourceForumCollection;
});

define('home/models/ChannelProfile',[
    'underscore',
    'backbone',

    'core/utils/storage',
    'core/UniqueModel',
    'core/strings',

    'home/models/Feed',
    'home/models/Channel',
    'home/collections/FeedItemCollection',
    'home/collections/UserCollection',
    'home/collections/ModeratorCollection',
    'home/collections/TopicCollection',
    'home/collections/SourceForumCollection',
    'home/utils/backboneUtils',

    'core/api',
], function (
    _,
    Backbone,

    storage,
    UniqueModel,
    strings,

    Feed,
    Channel,
    FeedItemCollection,
    UserCollection,
    ModeratorCollection,
    TopicCollection,
    SourceForumCollection,
    backboneUtils,

    api
) {
    'use strict';

    var gettext = strings.get;

    /**
     * View-model for channel pages
     */
    var ChannelProfile = Backbone.Model.extend({
        defaults: {
            channel: undefined, // Channel.prototype.idAttribute
        },

        initialize: function (_attributes, options) {
            options = options || {};

            this.initializeRelated(
                'channel',
                options,
                Channel
            );

            this.listenTo(this.channel, 'addModerator', function (user) {
                this.moderators.items.add(user);
            });

            this.listenTo(this.channel, 'removeModerator', function (user) {
                this.moderators.items.remove(user);
            });

            var channelId = this.channel.id;
            var target = 'channel:' + channelId;
            var fetchOptions;

            this.recentActivities = new Feed(options.recentActivitiesOptions, {
                collectionClass: FeedItemCollection,
                collectionOptions: {
                    type: 'profile',
                    target: target,
                },
            });

            // Allow us to manually test out the different sorts for top activities
            // Values:
            //   - None (don't pass) - Current sort method
            //   - hotPosts - Just uses posts to sort feed
            //   - hotRecommends - Just uses recommends to sort the feed
            //   - hotCombined - Equal weight to posts/recommends
            //   - hotCombinedHighRecommends - Highly weighted towards recommends, with a small amount of posts as a fallback
            if (storage.get('channelSort')) {
                options.topActivitiesOptions = options.topActivitiesOptions || {};
                options.topActivitiesOptions.fetchOptions = _.defaults({
                    sort: storage.get('channelSort'),
                }, options.topActivitiesOptions.fetchOptions);
            }

            this.topActivities = new Feed(options.topActivitiesOptions, {
                collectionClass: FeedItemCollection,
                collectionUrl: api.getURL('timelines/ranked'),
                collectionOptions: {
                    type: 'default',
                    target: target,
                },
            });

            this.sourceForums = new SourceForumCollection([], {
                channelId: this.channel.id,
            });

            fetchOptions = {
                channel: this.channel.id,
                limit: 10,
            };

            this.leaders = new Feed({
                fetchOptions: fetchOptions,
            }, {
                collectionClass: UserCollection,
                collectionUrl: api.getURL('channels/communityLeaders'),
            });

            // Fetch the moderators for the primary forum.
            // Wait unti channel has fetched to get the primary forum's id, if necessary
            if (this.channel.primaryForum) {
                fetchOptions = {
                    forum: this.channel.primaryForum.id,
                };
            } else {
                this.listenToOnce(this.channel, 'changeRelated:primaryForum', function () {
                    this.moderators.set({ fetchOptions: { forum: this.channel.primaryForum.id } });
                });
                fetchOptions = null;
            }

            // This list is shown in the moderators tab on a channel's page. It also has a side
            // effect when fetched, where it adds this channel's primary forum as a moderated
            // forum to the User model for each of the moderators. This results in Mod badges
            // showing up when those users appear on the channel page.
            this.moderators = new Feed({
                fetchOptions: fetchOptions,
            }, {
                collectionClass: ModeratorCollection,
                collectionOptions: {
                    channel: this.channel,
                },
                collectionUrl: api.getURL('forums/listModerators'),
            });

            this.trendingTopics = new Feed({
                fetchOptions: {
                    channel: this.channel.id,
                    limit: 15,
                },
            }, {
                collectionClass: TopicCollection,
                collectionUrl: api.getURL('channels/listTrendingTopics'),
            });

            // Mapping from topic id to Feed model.
            // Filled in lazily.
            this.topicFilteredFeeds = {};
        },

        toJSON: function () {
            var json = Backbone.Model.prototype.toJSON.apply(this, arguments);

            return _.defaults({
                channel: this.channel.toJSON(),
                recentActivities: this.recentActivities.toJSON(),
                topActivities: this.topActivities.toJSON(),
                trendingTopics: this.trendingTopics && this.trendingTopics.items.toJSON(),
            }, json);
        },

        getFetchedTopicFilteredFeed: function (topicId) {
            // TODO remove when releasing globally
            if (!this.trendingTopics)
                return;

            if (!this.topicFilteredFeeds[topicId]) {
                this.topicFilteredFeeds[topicId] = new Feed({
                    fetchOptions: {
                        topic: topicId,
                    },
                }, {
                    collectionClass: FeedItemCollection,
                    collectionUrl: api.getURL('timelines/ranked'),
                    collectionOptions: {
                        type: 'default',
                        target: 'channel:' + this.channel.id,
                    },
                });
            }

            var feed = this.topicFilteredFeeds[topicId];
            feed.ensureFetched();
            return feed;
        },

        ensureFetched: function () {
            this.channel.ensureFetchedWithCounters();

            this.recentActivities.ensureFetched();

            this.ensureFetchedTopActivities();

            this.ensureFetchedLeaders();

            this.ensureFetchedModerators();

            this.ensureFetchedTrendingTopics();
        },

        ensureFetchedTrendingTopics: function () {
            if (this.trendingTopics)
                this.trendingTopics.ensureFetched();
        },

        ensureFetchedTopActivities: function () {
            this.topActivities.ensureFetched();
        },

        ensureFetchedLeaders: function () {
            this.leaders.ensureFetched();
            this.leadersPromise = this.leaders.fetchPromise;
            return this.leadersPromise;
        },

        ensureFetchedModerators: function () {
            if (this.moderatorsPromise)
                return this.moderatorsPromise;

            if (this.moderators.get('fetchOptions')) {
                this.moderators.ensureFetched();
                this.moderatorsPromise = this.moderators.fetchPromise;
            } else {

                // If the fetch options haven't been built, wait until they are
                // before kicking off fetch.
                var moderators = this.moderators;
                this.moderatorsPromise = backboneUtils.getPromiseFor(moderators, 'fetchOptions').then(function () {
                    moderators.ensureFetched();
                    return moderators.fetchPromise;
                });
            }

            return this.moderatorsPromise.then(_.bind(this.markModerators, this));
        },

        ensureFetchedSourceForums: function () {
            if (!this.sourceForumsPromise)
                this.sourceForumsPromise = this.sourceForums.fetch();

            return this.sourceForumsPromise;
        },

        markModerators: function () {
            var forumId = this.channel.primaryForum.id;
            this.moderators.items.each(function (user) {
                var moderatedForums = user.get('moderatedForums') || [];
                // Must set moderatedForums to a new value instead of adding forumId to
                // the existing value in order for a change event to be triggered
                user.set({ moderatedForums: _.union(moderatedForums, [forumId]) });
            });
        },

        /**
         * Works the same way as validate, but since validate takes only current attributes
         * and not proposed changes, need a separate function to handle proposed additions
         * to the moderators list.
         */
        validateNewModerator: function (user) {
            if (!user.get('username').trim().length) {
                return {
                    attrName: 'username',
                    message: gettext('You must enter a username.'),
                };
            }

            if (this.moderators.items.contains(user)) {
                return {
                    attrName: 'username',
                    message: gettext('This user is already a moderator.'),
                };
            }
        },
    });

    UniqueModel.addType('ChannelProfile', ChannelProfile);

    return ChannelProfile;
});

define('home/collections/ChannelProfileCollection',[
    'underscore',

    'core/collections/PaginatedCollection',
    'core/UniqueModel',

    'home/activityExpander',
    'home/models/ChannelProfile',
], function (
    _,

    PaginatedCollection,
    UniqueModel,

    activityExpander,
    ChannelProfile
) {
    'use strict';

    var CollectionModel = ChannelProfile;
    var ChannelProfileCollection = PaginatedCollection.extend({
        model: UniqueModel.boundModel(CollectionModel),

        parse: function (response) {
            response = PaginatedCollection.prototype.parse.call(this, response);

            // Some endpoints use reference/objects mapping for channels, which are handled
            // differently.
            if (response.items) {
                return _.map(response.items, function (listedChannel) {
                    var channel = activityExpander.buildChannel(response.objects, listedChannel.reference);
                    var attrs = {
                        channel: channel,
                    };
                    attrs[CollectionModel.prototype.idAttribute] = channel.id;

                    return {
                        id: channel.id,
                        channel: channel,
                    };
                });
            }

            return response;
        },
    });

    return ChannelProfileCollection;
});

define('home/models/ChannelProfileFeed',[
    'underscore',

    'core/api',
    'core/UniqueModel',

    'home/collections/ChannelProfileCollection',

    'home/models/Feed',
], function (
    _,

    api,
    UniqueModel,

    ChannelProfileCollection,

    Feed
) {
    'use strict';

    var ChannelProfileFeed = Feed.extend({
        // `listName` is a param passed to the channels/list API endpoint
        // which retrieves a unique collection of channels
        idAttribute: 'listName',

        initialize: function (attrs, options) {
            options = _.extend({
                // Define `collectionClass` and `collectionUrl` here because this
                // feed is uniquely bound to the `listName` attribute which is only
                // supported by the channels/list endpoint. Specifying a different
                // collectionClass wouldn't work if you were retrieving an existing
                // instance of this Feed anyways.
                collectionClass: ChannelProfileCollection,
                collectionUrl: api.getURL('channels/list'),
            }, options);

            Feed.prototype.initialize.call(this, attrs, options);

            this.set('fetchOptions', _.extend({
                listName: this.get('listName'),
                attach: 'counters',
            }, this.get('fetchOptions')));
        },
    }, {
        LIST_NAMES: {
            promoted: 'promoted',
            explore: 'explore',
        },
    });

    UniqueModel.addType('ChannelProfileFeed', ChannelProfileFeed);

    return ChannelProfileFeed;
});

define('home/templates/nav',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"site-nav__item\">\n<a class=\"site-nav__link\" data-role=\"discover\" data-page-icon=\"channels\" href=\"/home/channels/\">\n<span class=\"site-nav__icon--wrapper\">\n<svg class=\"icon-discover site-nav__icon -discover\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" version=\"1.1\" x=\"0px\" y=\"0px\" viewBox=\"0 0 18 18\" enable-background=\"new 0 0 18 18\" xml:space=\"preserve\"><rect x=\"14\" width=\"4\" height=\"4\" class=\"dot\"/><rect x=\"14\" y=\"7\" width=\"4\" height=\"4\" class=\"dot\"/><rect x=\"14\" y=\"14\" width=\"4\" height=\"4\" class=\"dot\"/><rect x=\"7\" width=\"4\" height=\"4\" class=\"dot\"/><rect x=\"7\" y=\"7\" width=\"4\" height=\"4\" class=\"dot\"/><rect x=\"7\" y=\"14\" width=\"4\" height=\"4\" class=\"dot\"/><rect width=\"4\" height=\"4\" class=\"dot\"/><rect y=\"7\" width=\"4\" height=\"4\" class=\"dot\"/><rect y=\"14\" width=\"4\" height=\"4\" class=\"dot\"/></g></svg>\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Channels",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":32,"column":0},"end":{"line":32,"column":22}}}))
    + "\n</span>\n</a>\n</div>\n<div class=\"site-nav__item\">\n<a class=\"site-nav__link\" data-role=\"explore\" data-page-icon=\"explore exploreChannel\" href=\"/home/explore/\">\n<span class=\"site-nav__icon--wrapper\">\n<svg class=\"icon-explore-svg site-nav__icon -explore\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\"  viewBox=\"0 0 22 22\" version=\"1.1\" x=\"0px\" y=\"0px\"><g class=\"outline\"><path d=\"M11,22 C17.0751325,22 22,17.0751325 22,11 C22,4.92486745 17.0751325,0 11,0 C4.92486745,0 0,4.92486745 0,11 C0,17.0751325 4.92486745,22 11,22 L11,22 Z M5.69559185,5.6975623 L9.23181625,12.7679396 L16.3021935,16.3041641 L12.7676954,9.2320604 L5.69559185,5.6975623 L5.69559185,5.6975623 Z M7.32147215,7.3591919 L11.9771118,10.0310669 L10.0346069,12.0039673 L7.32147215,7.3591919 L7.32147215,7.3591919 Z\" class=\"fill\"></path></g></svg>\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Explore",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":41,"column":0},"end":{"line":41,"column":21}}}))
    + "\n</span>\n</a>\n</div>\n";
},"3":function(container,depth0,helpers,partials,data) {
    return "<div class=\"site-nav__item text-center\"\ndata-role=\"onboarding-steps-icon\" data-onboarding-step=\""
    + container.escapeExpression(container.lambda(depth0, depth0))
    + "\">\n\n<div class=\"onboarding__bar\"></div>\n</div>\n";
},"5":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"site-nav__item -skip site-nav--onboarding hidden-md\">\n<a href=\"/home/\" data-action=\"skip-onboarding\">"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Skip",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":60,"column":47},"end":{"line":60,"column":65}}}))
    + "</a>\n</div>\n";
},"7":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"site-nav__item -discuss\">\n<button class=\"button button-small button-outline\" data-action=\"create-discussion\">\n<span class=\"icon-create-discussion icon-small\"></span>\n<span class=\"text-medium spacing-left-small hidden-lg\">"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Discuss",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":67,"column":55},"end":{"line":67,"column":76}}}))
    + "</span>\n</button>\n</div>\n";
},"9":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\"/admin/\" data-action=\"admin-click\">\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Admin",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":106,"column":0},"end":{"line":106,"column":19}}}))
    + "\n</a>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<nav class=\"site-nav section-contained\">\n<div class=\"align\">\n<div class=\"site-nav__item -logo site-nav__logo--wrapper\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"navLogo"),depth0,{"name":"navLogo","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n<div class=\"site-nav--secondary\" data-role=\"icon-links\">\n<div class=\"site-nav__item\">\n<a href=\"/home/\" class=\"site-nav__link\" data-page-icon=\"home\">\n<span class=\"site-nav__icon--wrapper\">\n<svg class=\"icon-home site-nav__icon\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" version=\"1.1\" x=\"0px\" y=\"0px\" viewBox=\"0 0 16 18\" enable-background=\"new 0 0 16 18\" xml:space=\"preserve\"><polygon points=\"6,18 6,12 10,12 10,18 16,18 16,7.9 8,0 0,7.9 0,18\" class=\"fill\" /></svg>\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Home",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":12,"column":0},"end":{"line":12,"column":18}}}))
    + "\n</span>\n</a>\n</div>\n<div class=\"site-nav__item\">\n<a class=\"site-nav__link\" data-role=\"notifications\" data-page-icon=\"inbox\" href=\"/home/inbox/\">\n<span class=\"site-nav__icon--wrapper\">\n<div class=\"notif-count\" data-role=\"unread-notification-count\"></div>\n<svg class=\"icon-notif site-nav__icon\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" version=\"1.1\" x=\"0px\" y=\"0px\" viewBox=\"0 0 20 20\" enable-background=\"new 0 0 20 20\" xml:space=\"preserve\"><path d=\"M10.4 20c5.3 0 9.6-4.5 9.6-10S15.7 0 10.4 0C5 0 0.7 4.5 0.7 10 c0 1.5 0.3 2.9 0.9 4.1L0 18.2l4.1-0.6C5.8 19.1 8 20 10.4 20z\" class=\"icon-notif__fill\" /><path d=\"M11 11.2v2.6l4-3.9L11 6v2.3C6.1 8.3 5 14 5 14 C6.4 11.4 8.3 11.2 11 11.2z\" class=\"arrow\"/></svg>\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Notifications",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":22,"column":0},"end":{"line":22,"column":27}}}))
    + "\n</span>\n</a>\n</div>\n"
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"onboardingWithoutChannels") : depth0),{"name":"unless","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":26,"column":0},"end":{"line":45,"column":11}}})) != null ? stack1 : "")
    + "</div>\n</div>\n<div class=\"site-nav--onboarding\" data-role=\"onboarding-steps\">\n"
    + ((stack1 = lookupProperty(helpers,"each").call(alias1,(depth0 != null ? lookupProperty(depth0,"stepNumbers") : depth0),{"name":"each","hash":{},"fn":container.program(3, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":49,"column":0},"end":{"line":55,"column":9}}})) != null ? stack1 : "")
    + "</div>\n<div class=\"align site-nav__user--wrapper\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"userCanSkipOnboarding") : depth0),{"name":"if","hash":{},"fn":container.program(5, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":58,"column":0},"end":{"line":62,"column":7}}})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"onboardingWithoutChannels") : depth0),{"name":"unless","hash":{},"fn":container.program(7, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":63,"column":0},"end":{"line":70,"column":11}}})) != null ? stack1 : "")
    + "<div class=\"tooltipped site-nav__item -profile\"\ndata-role=\"user\" data-page-icon=\"profile\" data-toggle=\"tooltip\" data-placement=\"bottom\" title=\""
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Profile",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":72,"column":95},"end":{"line":72,"column":116}}}))
    + "\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"navUserIcon"),depth0,{"name":"navUserIcon","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n<div class=\"tooltipped bottom-right site-nav__item -settings\"\ndata-toggle=\"tooltip\" data-placement=\"bottom\" title=\""
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Settings",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":76,"column":53},"end":{"line":76,"column":75}}}))
    + "\" data-role=\"settings\">\n<div class=\"dropdown\" data-action=\"toggle-dropdown\" data-dropdown=\"settings\">\n<a data-toggle=\"dropdown\" class=\"dropdown-toggle nav__lnk--settings\" href=\"#\">\n<svg class=\"icon-settings site-nav__icon -settings\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" version=\"1.1\" x=\"0px\" y=\"0px\" viewBox=\"0 0 20 20\" enable-background=\"new 0 0 20 20\" xml:space=\"preserve\"><path d=\"M10 13.8c2.1 0 3.8-1.7 3.8-3.8S12.1 6.2 10 6.2S6.2 7.9 6.2 10 S7.9 13.8 10 13.8z M20 8.8v2.5c0 0.3-0.2 0.6-0.5 0.6l-2.3 0.3c-0.1 0.5-0.3 0.9-0.6 1.4l1.4 1.8c0.2 0.2 0.2 0.6-0.1 0.8L16.2 18 c-0.1 0.1-0.3 0.2-0.5 0.2c-0.1 0-0.3 0-0.4-0.1l-1.8-1.4c-0.4 0.2-0.9 0.4-1.4 0.6l-0.3 2.3c0 0.3-0.3 0.5-0.6 0.5H8.8 c-0.3 0-0.6-0.2-0.6-0.5l-0.3-2.3c-0.5-0.1-0.9-0.3-1.4-0.6L4.6 18c-0.1 0.1-0.2 0.1-0.4 0.1c-0.2 0-0.3-0.1-0.4-0.2L2 16.2 C1.8 16 1.8 15.6 2 15.4l1.4-1.8c-0.2-0.4-0.4-0.9-0.6-1.4l-2.3-0.3c-0.3 0-0.5-0.3-0.5-0.6V8.8c0-0.3 0.2-0.6 0.5-0.6l2.3-0.3 C3 7.3 3.2 6.9 3.4 6.5L2 4.6C1.8 4.4 1.8 4 2 3.8L3.8 2c0.1-0.1 0.3-0.2 0.4-0.2c0.1 0 0.3 0 0.4 0.1l1.8 1.4 C6.9 3.2 7.3 3 7.8 2.8l0.3-2.3C8.2 0.2 8.4 0 8.8 0h2.5c0.3 0 0.6 0.2 0.6 0.5l0.3 2.3c0.5 0.2 0.9 0.3 1.4 0.6L15.4 2 c0.1-0.1 0.2-0.1 0.4-0.1c0.2 0 0.3 0.1 0.5 0.2L18 3.8C18.2 4 18.2 4.4 18 4.6l-1.4 1.8c0.2 0.4 0.4 0.9 0.6 1.4l2.3 0.3 C19.8 8.2 20 8.4 20 8.8z\" class=\"fill\"/></svg>\n</a>\n<ul class=\"dropdown-menu dropdown-settings\">\n<li class=\"hidden-md\">\n<a href=\"/home/settings/profile/\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Edit Profile",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":84,"column":0},"end":{"line":84,"column":26}}}))
    + "\n</a>\n</li>\n<li class=\"hidden-md\">\n<a href=\"/home/settings/account/\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Settings",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":89,"column":0},"end":{"line":89,"column":22}}}))
    + "\n</a>\n</li>\n<li class=\"visible-md\">\n<a href=\"/home/settings/\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Settings",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":94,"column":0},"end":{"line":94,"column":22}}}))
    + "\n</a>\n</li>\n<li>\n<a href=\"/follow/facebook/\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Find Friends",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":99,"column":0},"end":{"line":99,"column":26}}}))
    + "\n</a>\n</li>\n<li role=\"presentation\" class=\"divider hidden-md\"></li>\n<li>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"isModerator") : depth0),{"name":"if","hash":{},"fn":container.program(9, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":104,"column":0},"end":{"line":108,"column":7}}})) != null ? stack1 : "")
    + "</li>\n<li>\n<a href=\"https://publishers.disqus.com/engage?utm_source=Home-Nav\" class=\"hidden-md\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Add %(disqus)s To Site",{"name":"gettext","hash":{"disqus":"Disqus"},"data":data,"loc":{"start":{"line":112,"column":0},"end":{"line":112,"column":54}}}))
    + "\n</a>\n</li>\n<li role=\"presentation\" class=\"divider\"></li>\n<li>\n<a href=\"https://disqus.com/about/\" data-role=\"about\">About</a>\n</li>\n<li>\n<a href=\"https://help.disqus.com/\" data-role=\"help\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Help",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":121,"column":0},"end":{"line":121,"column":18}}}))
    + "\n</a>\n</li>\n<li>\n<a href=\"/logout/?redirect=https%3A%2F%2Fdisqus.com%2F\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Log Out",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":126,"column":0},"end":{"line":126,"column":21}}}))
    + "\n</a>\n</li>\n</ul>\n</div>\n\n</div>\n</div>\n</nav>\n";
},"usePartial":true,"useData":true})

});
define('home/templates/anonNav',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"spacing-top-narrow\">\n<a href=\"/home/explore/\"\nclass=\"button button-explore button-small hidden-md\"\ndata-role=\"icon-links\">\n<span class=\"icon-explore button-explore__icon\"></span>\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Explore",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":11,"column":0},"end":{"line":11,"column":21}}}))
    + "\n</a>\n<a href=\"https://disqus.com/profile/login/\"\nclass=\"button button-outline button-small spacing-right-small\"\ndata-action=\"navigate-return\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Log In",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":16,"column":0},"end":{"line":16,"column":20}}}))
    + "\n</a>\n<a href=\"https://disqus.com/profile/signup/\"\nclass=\"button button-fill--brand button-small\"\ndata-action=\"navigate-return\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Sign Up",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":21,"column":0},"end":{"line":21,"column":21}}}))
    + "\n</a>\n</div>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<nav class=\"site-nav section-contained\">\n<div class=\"site-nav__item -logo\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"navLogo"),depth0,{"name":"navLogo","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n"
    + ((stack1 = lookupProperty(helpers,"unless").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"sessionIsFetching") : depth0),{"name":"unless","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":5,"column":0},"end":{"line":24,"column":11}}})) != null ? stack1 : "")
    + "</nav>\n";
},"usePartial":true,"useData":true})

});
define('home/templates/createDiscussionNav',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"discuss-tile__wrap align align--stretch\">\n<a href=\"/home/discuss/"
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"primaryForum") : depth0)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + "/\" data-action=\"confirm\" alt=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"name") : depth0), depth0))
    + "\"\nclass=\"discuss-tile__link text-center link-gray-dark align align--column\">\n<div class=\"tile__wrapper\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = (depth0 != null ? lookupProperty(depth0,"options") : depth0)) != null ? lookupProperty(stack1,"tile") : stack1),{"name":"if","hash":{},"fn":container.program(2, data, 0),"inverse":container.program(4, data, 0),"data":data,"loc":{"start":{"line":14,"column":0},"end":{"line":22,"column":7}}})) != null ? stack1 : "")
    + "</div>\n<div class=\"discuss-tile__description align align--middle\">\n<p>"
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"options") : depth0)) != null ? lookupProperty(stack1,"description") : stack1), depth0))
    + "</p>\n</div>\n</a>\n</div>\n";
},"2":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<img src=\""
    + container.escapeExpression(container.lambda(((stack1 = (depth0 != null ? lookupProperty(depth0,"options") : depth0)) != null ? lookupProperty(stack1,"tile") : stack1), depth0))
    + "\" class=\"img-responsive border-radius-sm block__item\" />\n";
},"4":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"tile__overlay\">\n<h1 class=\"tile__name\">"
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"name") : depth0), depth0))
    + "</h1>\n</div>\n<img src=\"https://media.disquscdn.com/home/blank_tile.png\"\nclass=\"img-responsive border-radius-sm block__item\" />\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<button class=\"text-smaller modal-close -light\" data-dismiss=\"modal\">\n<span class=\"icon-cancel\"></span>\n</button>\n<div class=\"text-center padding-default\">\n<h1 class=\"text-larger text-gray-darker spacing-top spacing-bottom-small\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Start a discussion",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":5,"column":74},"end":{"line":5,"column":106}}}))
    + "</h1>\n<p class=\"text-gray\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Pick the channel that best fits your discussion topic",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":6,"column":21},"end":{"line":6,"column":88}}}))
    + "</p>\n</div>\n<div class=\"padding-default align align--wrap\">\n"
    + ((stack1 = lookupProperty(helpers,"each").call(alias1,(depth0 != null ? lookupProperty(depth0,"channels") : depth0),{"name":"each","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":9,"column":0},"end":{"line":29,"column":9}}})) != null ? stack1 : "")
    + "</div>\n";
},"useData":true})

});
define('home/mixins/withOnboarding',[
    'underscore',

    'home/models/Session',
    'home/utils/navigationUtils',
], function (
    _,

    Session,
    navigationUtils
) {
    'use strict';

    var NUM_STEPS = 3;
    var ONBOARDING_ROUTE_PATHS = ['explore', 'exploreChannel', 'exploreDiscussions'];

    /**
     * Mixes in helper functions to determine if/where user is in the
     * onboarding process.
     *
     * Can be applied to any Backbone object (Model, View, Collection).
     */
    var onboardingMixinWrapper = function () {
        var _stepNumber;
        return {
            events: {
                'click [data-action=skip-onboarding]': 'completeOnboarding',
            },

            initialize: function (_initialize) {
                _initialize.apply(this, _.rest(arguments));

                var session = Session.get();
                session.loadPromise().then(_.bind(function () {
                    var forumsFollowing = session.getUserProfile().forumsFollowing;
                    this.listenTo(forumsFollowing.items, 'add remove reset', this.updateStepNumber);
                    this.updateStepNumber();
                }, this));
            },

            getStepNumber: function () {
                return _stepNumber;
            },

            isInOnboarding: function (app, session) {
                return session.isLoggedIn() &&
                    session.user.shouldHomeOnboard() &&
                    _.contains(ONBOARDING_ROUTE_PATHS, app.getCurrentRouteName());
            },

            userCanSkip: function () {
                var session = Session.get();
                return session.isLoggedIn() && !session.user.registeredThisWeek();
            },

            updateStepNumber: function () {
                // Each "step" is the following of a channel (not forum).
                // Must follow some number in order to complete all "steps"
                // of onboarding.
                var channelsFollowing = this.getChannelsFollowing();
                var numChannelsFollowing = channelsFollowing.length || 0;

                var newStepNumber = Math.min(numChannelsFollowing, NUM_STEPS) + 1;

                var changed = newStepNumber !== _stepNumber;
                _stepNumber = newStepNumber;
                if (changed)
                    this.trigger('change:stepNumber');
            },

            getChannelsFollowing: function () {
                var forumsFollowing = Session.get().getUserProfile().forumsFollowing;
                return forumsFollowing.items.filter(function (forum) {
                    return forum.channel;
                });
            },

            completeOnboarding: function (evt) {
                if (evt)
                    evt.preventDefault();

                var user = Session.get().user;
                user.setHomeOnboardComplete(true);
                navigationUtils.navigate('/home/', { trigger: true });
            },
        };
    };

    return function withOnboarding() {
        var onboardingMixin = onboardingMixinWrapper();

        this.constructor.NUM_STEPS = NUM_STEPS;

        this.initialize = _.wrap(this.initialize, onboardingMixin.initialize);

        this.events = _.extend(onboardingMixin.events, this.events);

        _.extend(this, _.pick(onboardingMixin, [
            'getStepNumber',
            'isInOnboarding',
            'userCanSkip',
            'updateStepNumber',
            'getChannelsFollowing',
            'completeOnboarding',
        ]));
    };
});

define('home/mixins/withSubviews',[
    'underscore',
    'jquery',
    'backbone-marionette',
], function (
    _,
    $,
    Marionette
) {
    'use strict';

    /**
     * Class used internally by withSubviews mixin.
     *
     * Has very little in common with Marionette Regions.
     *
     * @param {string} selector   A jQuery selector
     */
    function Region(selector) {
        this.selector = selector;

        // set when rendered, equal to parentView.$(selector)[0];
        this.el = null;

        // set in .render()
        // NEVER assign this to a different value without calling .close()
        // first unless you want to create memory leaks
        this.currentView = null;
    }

    Region.prototype = {
        setElement: function (el) {
            this.$el = el instanceof $ ? el : $(el);
            this.el = this.$el[0];
        },

        /**
         * Renders the view parameter into this region
         * @param {Backbone.View} view
         */
        render: function (view) {
            if (this.currentView)
                return;

            var attachmentPoint = this.el;
            var $attachmentPoint = this.$el;

            // If region doesn't have an attachment point, don't render.
            // This could happen, for example, if the parent view by closing
            // the region removes the region's element from the DOM, and then
            // the parent view tries to re-render this region without
            // re-rendering itself first.
            if (!attachmentPoint)
                return;

            this.currentView = view;

            // In other words, should we append the subview?
            if (!view.$el.is(attachmentPoint))
                $attachmentPoint.append(view.el);

            view.render();
        },

        /**
         * This function is irreversible if this.el === currentView.el!
         * Views that use this region must take this into account if
         * they ever want to close and then re-open this region.
         *
         * Generally speaking the right way to close a region and then
         * re-open it is:
         *     1. parent view closes region: region.close()
         *     2. parent view re-renders itself
         *     3. parent view renders region: region.render()
         */
        close: function () {
            var view = this.currentView;

            this.el = null;
            this.currentView = null;

            if (!view)
                return;

            if (view.close)
                view.close();
            else if (view.remove)
                view.remove();
        },
    };


    function detachIfActive(region) {
        var subview = region && region.currentView;
        return (
            // Region must have a current view or else it means
            // it's been closed or not yet rendered
            subview &&

            // This view must contain subview or else it means
            // the subview has somehow already been removed
            // (and should not be marked for re-attachment)
            $.contains(this.el, subview.el) &&

            // Desired side effect (detach returns the jquery set
            // i.e., a truthy value)
            subview.$el.detach()
        );
    }


    function attachIfFound(region) {
        var selector = region.selector;
        var $regionEl = this.$(selector);

        // If a region we previously detached is not to be found in the
        // newly rendered template, we need to close it, especially since
        // some of the clean up done in the close method would have been
        // done by jQuery if we hadn't detached the region first.
        if (!$regionEl.length) {
            region.close();
            return;
        }

        var $subviewEl = region.currentView.$el;

        // A subview either shares the same element as the region or is
        // appended into that region's element.
        if ($subviewEl.is(selector)) {
            $regionEl.replaceWith($subviewEl);
            region.setElement($subviewEl);
        } else {
            $regionEl.append($subviewEl);
            region.setElement($regionEl);
        }
    }


    function triggerShow() {
        Marionette.triggerMethod.call(this, 'show');
    }


    function closeRegion(region, key) {
        if (!region)
            return;

        region.close();
        this._regions[key] = null;
    }


    var SubviewsMixin = {
        initialize: function (_initialize, options) {
            this._regions = {};
            this.initializeRegions();
            _initialize.call(this, options);
        },

        initializeRegions: function () {
            _.each(this.regions, function (selector, propertyName) {
                this[propertyName] = this.addRegion(selector);
            }, this);
        },

        addRegion: function (selector) {
            var region = this._regions[selector];

            if (!region) {
                region = new Region(selector);
                this._regions[selector] = region;
            }

            return region;
        },

        activateRegion: function (region, viewFactory) {
            var view = region.currentView;
            if (view)
                return view;

            // Important to set region element before calling the viewFactory
            // because the viewFactory may reference the region element, e.g.:
            //
            //      createSubview: function () {
            //          return new View({el: this.someRegion.el})
            //      }
            //
            region.setElement(this.$(region.selector));

            view = viewFactory.call(this);
            region.render(view);

            // Propagate show event from parent view to its subview
            view.listenTo(this, 'show', triggerShow);

            // Trigger show on the view if the containing view is
            // already showing
            if (this._isShown)
                triggerShow.call(view);

            return view;
        },

        render: function (_render) {

            // Detach subviews, if any, before (re)rendering
            // because rendering, as it is typically accomplished
            // with jQuery.html(), removes data and event handlers
            // from child elements
            var toReAttach = _.filter(this._regions, detachIfActive, this);

            _render.call(this);

            // Re-attach subviews
            _.each(toReAttach, attachIfFound, this);

            return this;
        },

        close: function (_close) {
            _.each(this._regions, closeRegion, this);
            return _close.call(this);
        },
    };

    return function withSubviews() {

        // If this mixin has already been applied ...
        if (this.initializeRegions && this.addRegion)
            return;

        this.initialize = _.wrap(this.initialize, SubviewsMixin.initialize);
        this.render = _.wrap(this.render, SubviewsMixin.render);
        this.close = _.wrap(this.close, SubviewsMixin.close);

        _.extend(this, _.pick(SubviewsMixin,
            'initializeRegions',
            'addRegion',
            'activateRegion'
        ));
    };
});

define('home/views/NavView',[
    'underscore',
    'jquery',
    'backbone-marionette',

    'core/UniqueModel',

    'home/utils/confirmModal',

    'home/models/Channel',
    'home/models/Session',
    'home/models/ChannelProfileFeed',

    'home/templates/nav',
    'home/templates/anonNav',
    'home/templates/createDiscussionNav',

    'home/mixins/withClickLinkTracking',
    'home/mixins/withOnboarding',
    'home/mixins/withSubviews',
], function (
    _,
    $,
    Marionette,

    UniqueModel,

    confirmModal,

    Channel,
    Session,
    ChannelProfileFeed,

    navTemplate,
    anonNavTemplate,
    createDiscussionNavTemplate,

    withClickLinkTracking,
    withOnboarding,
    withSubviews
) {
    'use strict';

    var parent = Marionette.ItemView;
    var parentProto = parent.prototype;

    var NavView = parent.extend({
        className: 'compensation',

        template: function (data) {
            if (data.id)
                return navTemplate(data);

            return anonNavTemplate(data);
        },

        templateHelpers: function () {
            return {
                // For development
                customBase: this.devBase,
                // For anon nav template
                sessionIsFetching: this.session.fetchPromise,

                stepNumbers: _.range(1, this.constructor.NUM_STEPS + 1),
                userCanSkipOnboarding: this.userCanSkip(),
                onboardingWithoutChannels: this.app.onboardingWithoutChannels,
            };
        },

        events: {
            'show.bs.dropdown [data-action=toggle-dropdown]': 'removeTooltip',
            'hide.bs.dropdown [data-action=toggle-dropdown]': 'addTooltip',
            'click [data-role=settings] a[data-link-name]': 'trackClickLinkWithArea',
            'click [data-action=navigate-return]': 'navigateAndReturn',
            'click [data-action=create-discussion]': 'handleCreateDiscussionNavClick',
        },

        initialize: function (options) {
            this.session = Session.get();
            this.app = options.app;

            this.notifications = this.session.getOrCreateNotifications();

            this.promotedChannels = new UniqueModel(ChannelProfileFeed, {
                listName: ChannelProfileFeed.LIST_NAMES.promoted,
            });
            this.promotedChannels.ensureFetched();

            if (!this.session.user.get('isAnonymous'))
                this.changeUser();
            this.listenTo(
                this.session,
                'change:id fetch:error fetch:success change:isModerator',
                this.changeUser
            );
            this.listenTo(this.notifications.unreadCounter, 'change:numUnread', this.updateNotifications);
            this.listenTo(this.app, 'route', this.activatePageIcon);
            this.listenTo(this.app, 'route', this.toggleIconLinks);

            this.listenTo(this.app, 'route', this.updateOnboardingSteps);
            this.listenTo(this, 'change:stepNumber', this.updateOnboardingSteps);

            this.devBase = $('body').attr('data-disqus-dev-base');
        },

        /**
         * Changes the model being used
         * Meant to be used in an event listener, listening to changes to `this.session.user`
         * @returns {void}
         */
        changeUser: function () {
            // Remove the listener before attaching the same one because we only want to keep a single listener
            this.stopListening(this.model, 'change:username', this.debouncedRender);
            this.model = this.session.user;
            this.listenTo(this.model, 'change:username', this.debouncedRender);
            this.debouncedRender();
        },

        debouncedRender: _.debounce(function () {
            this.render.apply(this, arguments);
        }, 300),

        render: function () {
            var result = parentProto.render.apply(this, arguments);
            this.updateOnboardingSteps();
            this.updateNotifications();
            return result;
        },

        onDomRefresh: function () {
            $('.tooltipped').tooltip();
        },

        updateNotifications: function () {
            var numUnread = this.notifications.unreadCounter.get('numUnread');
            this.$('[data-role=notifications]').toggleClass('has-notifs', Boolean(numUnread));
            this.$('[data-role=unread-notification-count]').text(numUnread > 9 ? '9+' : numUnread);
        },

        /**
         * Navigates to the href specified by the anchor element that was clicked.
         * Adds/modifies the next url param to return to this url when complete.
         *
         * @param {Event} evt - Click event object
         */
        navigateAndReturn: function (evt) {
            if (!evt)
                return;

            evt.preventDefault();

            var url = $(evt.currentTarget).attr('href');
            if (!url)
                return;

            var regex = /(\?|&)next=[^&]+/;
            var nextParam = 'next=' + encodeURIComponent('https://disqus.com' + window.location.pathname);
            var matched = false;

            url = url.replace(regex, function (_match, p1) {
                // An existing url param next was found. Replace it with the current path,
                // and mark the matched flag as true.
                matched = true;
                return p1 + nextParam;
            });

            if (!matched) {
                // No url param next was found. Add it.
                if (url.indexOf('?') === -1)
                    url += '?';
                else if (url.charAt(url.length - 1) !== '&')
                    url += '&';

                url += nextParam;
            }

            window.top.location = url;
        },

        /**
         * Returns a list of channels to suggest to the user for creating
         * a new discussion.
         * This includes promoted channels, the channels the user is following,
         * and the channel for the page the user is on, if any.
         *
         * @returns {Promise} - List of channels wrapped in a promise
         */
        getDiscussChannels: function () {
            return this.promotedChannels.ensureFetched().then(_.bind(function () {
                // Promoted channels
                var promotedChannels = this.promotedChannels.items.map(function (channelProfile) {
                    return channelProfile.channel;
                });

                // Channels followed by the session user (may contain nulls)
                var sessionUserProfile = this.session.getUserProfile();
                var followedChannels = _.pluck(sessionUserProfile.forumsFollowing.items.models, 'channel');

                // Current page channel (if any, otherwise null)
                var currentViewModel = this.app.getCurrentView().model || {};
                var viewChannel = currentViewModel instanceof Channel ?
                    currentViewModel :
                    currentViewModel.channel;

                // we need to ensure channel is a real channel (has an id), since
                // some views can have a new channel without id (channel create view)
                if (viewChannel && !viewChannel.id)
                    viewChannel = null;

                var sessionUser = this.session.user;

                // Combined list of channels to pass to the modal, removes nulls
                return _.chain([viewChannel, promotedChannels, followedChannels])
                    .flatten()
                    .compact()
                    .filter(function (channel) {
                        return channel.userCanCreate(sessionUser);
                    })
                    .uniq(false, function (channel) {
                        return channel.id;
                    })
                    .invoke('toJSON')
                    .value();
            }, this));
        },

        /**
         * Opens a modal with a list of links to the discussion creation page for
         * various channels.
         * List of channels includes promoted channels, channels followed by the
         * current user, and the channel for the current page, if any.
         * Curation-only channels are not shown.
         */
        handleCreateDiscussionNavClick: function () {
            this.getDiscussChannels().then(function (combined) {
                var model = {
                    channels: combined,
                };
                confirmModal.confirmationPromise(
                    confirmModal.TYPES.CLOSE_LIGHT,
                    createDiscussionNavTemplate(model)
                ).then(function (navigated) {
                    // Make sure all modals are removed when
                    // navigating to a new create discussion page.
                    //
                    // All of the links in the channel selection
                    // modal should have `data-action="confirm"`,
                    // which will resolve this promise to `true`.
                    if (navigated)
                        $('.modal').remove();
                });
            }, this);
        },

        /**
         * Updates the active state of any page icons in this view.
         * The only page icon that should be active is one that is linked to the current route.
         * The active state typically adjusts the icon's style to visually indicate which page
         * is currently visible to the user.
         *
         * @param {string} routeName - Name of the active page
         * @param {Array} routeArgs - Url arguments
         */
        activatePageIcon: function (routeName, routeArgs) {
            // If the page rerenders after this is called, the element lose its active class.
            // If that happens, need to reactivate the element using the current arguments (the
            // most recent route name and args).
            // Store the reactivation handler so it can be removed before another is added,
            // at most 1 handler will ever be bound.
            if (this.reactivatePageIcon)
                this.stopListening(this, 'render', this.reactivatePageIcon);

            this.reactivatePageIcon = _.bind(this.activatePageIcon, this, routeName, routeArgs);
            this.listenTo(this, 'render', this.reactivatePageIcon);

            // Remove any previously activated icons, then activate the one matching the current
            // route.
            this.$('[data-page-icon].active').removeClass('active');

            // Special case for profile to only highlight if viewing the session user's profile
            if (routeName !== 'profile' || routeArgs[0] === this.session.user.id)
                this.$('[data-page-icon~="' + routeName + '"]').addClass('active');
        },

        toggleIconLinks: function (routeName) {
            if (routeName === 'home' && this.session.isLoggedOut())
                $('[data-role=icon-links]').hide();
            else
                $('[data-role=icon-links]').show();
        },

        /**
         * If current route is an onboarding route, apply the is-onboarding class to the nav view and
         * update the active/completed state of the onboarding steps.
         */
        updateOnboardingSteps: function () {
            // defer so that onboarding transitions are the last to occur and can be seen
            _.defer(_.bind(function () {
                var inOnboarding = this.isInOnboarding(this.app, this.session);

                this.$('[data-role=onboarding-steps-icon]').removeClass('is-complete');
                this.$el.toggleClass('is-onboarding', inOnboarding);

                if (!inOnboarding)
                    return;

                // mark all previous steps as completed, if any
                var stepNumber = this.getStepNumber();
                _.each(_.range(1, stepNumber), function (step) {
                    this.$('[data-role=onboarding-steps-icon][data-onboarding-step=' + step + ']')
                        .addClass('is-complete');
                }, this);
            }, this));
        },

        completeHomeOnboarding: function () {
            this.session.user.setHomeOnboardComplete(true);
        },

        removeTooltip: function (evt) {
            if (!evt)
                return;

            $(evt.currentTarget).closest('.tooltipped').tooltip('destroy');
        },

        addTooltip: function (evt) {
            if (!evt)
                return;

            $(evt.currentTarget).closest('.tooltipped').tooltip();
        },
    });


    var proto = NavView.prototype;
    withClickLinkTracking.call(proto, 'top_nav_user');
    withSubviews.call(proto);
    withOnboarding.call(proto);

    return NavView;
});

define('home/templates/message',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"alert-message-success\">\n<div class=\"section-contained alert-message\">\n"
    + alias1(container.lambda((depth0 != null ? lookupProperty(depth0,"message") : depth0), depth0))
    + "\n<button class=\"close\" aria-hidden=\"true\" title=\""
    + alias1(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Don't show this message again",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":4,"column":48},"end":{"line":4,"column":91}}}))
    + "\" data-action=\"hide-message\">\n<span class=\"icon-cancel\"></span>\n</button>\n</div>\n</div>\n";
},"useData":true})

});
define('home/views/MessageView',[
    'backbone-marionette',

    'home/templates/message',
], function (
    Marionette,

    messageTemplate
) {
    'use strict';
    var MessageView = Marionette.ItemView.extend({
        template: messageTemplate,
        events: {
            'click [data-action=hide-message]': 'close',
        },

        close: function (evt) {
            evt.preventDefault();
            this.remove();
        },
    });

    return MessageView;
});

define('home/views/MessageCollectionView',[
    'backbone-marionette',

    'home/views/MessageView',
], function (
    Marionette,

    MessageView
) {
    'use strict';
    var MessageCollectionView = Marionette.CollectionView.extend({
        itemView: MessageView,
    });

    return MessageCollectionView;
});

define('home/templates/mainLayout',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"drawer-footer\">\n<a href=\"/\" data-action=\"full-root\" target=\"_blank\" class=\"nav-logo\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"customBase") : depth0),{"name":"if","hash":{},"fn":container.program(2, data, 0),"inverse":container.program(4, data, 0),"data":data,"loc":{"start":{"line":11,"column":0},"end":{"line":15,"column":7}}})) != null ? stack1 : "")
    + "</a>\n<button class=\"drawer-close button button-outline -border-muted\" data-action=\"close-drawer\"><span class=\"icon-cancel text-smaller\"></span>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Close",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":17,"column":138},"end":{"line":17,"column":157}}}))
    + "</button>\n<div class=\"drawer-footer-right\" data-jester-area=\"drawer_footer\">\n<a class=\"nav-expand truncate-line\" data-action=\"full-root\" target=\"_blank\" href=\"/home/\">\n<svg class=\"icon-home\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" version=\"1.1\" x=\"0px\" y=\"0px\" viewBox=\"0 0 40 40\" enable-background=\"new 0 0 40 40\" xml:space=\"preserve\"><path d=\"M39.5 20.7L21.7 2.5c-0.9-1-2.4-1-3.3 0L0.5 20.7c-0.9 1-0.6 1.7 0.8 1.7H5v13.9c0 1 0 1.8 1.8 1.8h8.7v-14 h9.1v14h9.1c1.4 0 1.4-0.8 1.4-1.8V22.4h3.7C40.1 22.4 40.4 21.6 39.5 20.7z\"/></svg>\n<span class=\"hidden-md\">Disqus Home</span>\n</a>\n<a class=\"nav-feedback truncate-line\" target=\"_blank\" href=\"//www.surveymonkey.com/s/MMWLGSR?u="
    + alias2(container.lambda((depth0 != null ? lookupProperty(depth0,"userId") : depth0), depth0))
    + "\" data-link-name=\"feedback\">\n<span class=\"icon-checkmark\"></span>\n<span class=\"hidden-md\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Feedback?",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":26,"column":24},"end":{"line":26,"column":47}}}))
    + "</span>\n</a>\n<a class=\"nav-help truncate-line\" target=\"_blank\" href=\"//help.disqus.com\" data-link-name=\"help\">\n<span class=\"icon-forward\"></span>\n<span class=\"hidden-md\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Get Help",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":30,"column":24},"end":{"line":30,"column":46}}}))
    + "</span>\n</a>\n</div>\n</div>\n\n<div class=\"drawer-nav\">\n<a class=\"drawer-nav-option drawer-nav-close\" data-action=\"close-drawer\" href=\"#\"><span class=\"drawer-nav-option-text\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Close",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":36,"column":119},"end":{"line":36,"column":138}}}))
    + "</span><span class=\"icon-cancel\"></span></a>\n<a class=\"drawer-nav-option drawer-nav-full\" data-action=\"full-home\" href=\"#\"><span class=\"drawer-nav-option-text\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"View on %(disqus)s",{"name":"gettext","hash":{"disqus":"Disqus"},"data":data,"loc":{"start":{"line":37,"column":115},"end":{"line":37,"column":165}}}))
    + "</span><span class=\"icon-expand\"></span></a>\n</div>\n\n<div class=\"drawer-ad-outer-container\">\n<div class='drawer-ad-inner-container' id='drawer-ad-inner-container'/>\n</div>\n";
},"2":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<img src=\""
    + container.escapeExpression(lookupProperty(helpers,"urlfor").call(depth0 != null ? depth0 : (container.nullContext || {}),"cdn",{"name":"urlfor","hash":{},"data":data,"loc":{"start":{"line":12,"column":10},"end":{"line":12,"column":26}}}))
    + "/img/disqus-logo-dev.svg\" alt=\"Disqus dev\">\n";
},"4":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<img src=\""
    + container.escapeExpression(lookupProperty(helpers,"urlfor").call(depth0 != null ? depth0 : (container.nullContext || {}),"cdn",{"name":"urlfor","hash":{},"data":data,"loc":{"start":{"line":14,"column":10},"end":{"line":14,"column":26}}}))
    + "/img/disqus-logo-blue-white.svg\" alt=\"Disqus\">\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"viewport\">\n<header class=\"site-nav--wrapper\" data-role=\"nav-view\">\n</header>\n\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"isSidebar") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":5,"column":0},"end":{"line":43,"column":7}}})) != null ? stack1 : "")
    + "\n<div data-role=\"messages-view\" class=\"alert-global\">\n</div>\n\n<div id=\"container-main\">\n</div>\n</div>\n";
},"useData":true})

});
define('home/views/MainLayout',[
    'jquery',
    'underscore',
    'backbone',
    'backbone-marionette',

    'core/bus',
    'core/utils/metatags',

    'home/mixins/asEmbedLayout',
    'home/mixins/withClickLinkTracking',
    'home/utils/trackingUtils',
    'home/utils/sidebarUtils',

    'home/models/Session',
    'home/views/NavView',
    'home/views/MessageCollectionView',

    'home/templates/mainLayout',
], function (
    $,
    _,
    Backbone,
    Marionette,

    bus,
    metatags,

    asEmbedLayout,
    withClickLinkTracking,
    trackingUtils,
    sidebarUtils,

    Session,
    NavView,
    MessageCollectionView,

    mainLayoutTemplate
) {
    'use strict';

    var parent = Marionette.Layout;
    var parentProto = parent.prototype;

    var MainLayout = parent.extend({
        id: 'container-page',

        template: mainLayoutTemplate,

        templateHelpers: function () {
            return {
                // For development
                customBase: $('body').attr('data-disqus-dev-base'),
            };
        },

        serializeData: function () {
            var data = parentProto.serializeData.apply(this, arguments);

            var user = this.session.user;
            if (user && user.toJSON) {
                _.extend(data, user.toJSON());
            }
            // for survey monkey link in nav bar
            var userId = Session.fromCookie().id;
            if (userId) {
                data.userId = userId;
            }
            data.isSidebar = sidebarUtils.isSidebar();
            data.messages = this.app.messages;

            return data;
        },

        events: {
            // Need to specify specific areas to track click from, otherwise all
            // clicks from all subviews will be tracked both here and by the
            // subviews themselves.
            'click [data-jester-area=drawer_footer] a[data-link-name]': 'trackClickLink',
            'click [data-jester-area=mobile_sidebar] a[data-link-name]': 'trackClickLink',
        },

        regions: {
            content: {
                selector: '#container-main',
            },
            nav: '[data-role=nav-view]',
            alerts: '[data-role=messages-view]',
        },

        initialize: function (options) {
            this.container = options.container;
            this.session = options.session;
            this.app = options.app;

            this.windowHeight = $(window).height();
            $(window).resize(
                _.bind(function () {
                    this.windowHeight = $(window).height();
                    this.toggleHeight();
                }, this)
            );
        },

        onRender: function () {
            $(this.container).html(this.$el);

            // don't show NavView in sidebar
            if (sidebarUtils.isSidebar()) {
                return;
            }
            this.nav.show(new NavView({
                app: this.app,
            }));

            var messages = new Backbone.Collection(this.app.messages);

            this.alerts.show(new MessageCollectionView({
                collection: messages,
            }));
        },

        showView: function (view, options) {
            if (!this.rendered) {
                // This is essentially lazy rendering of MainLayout.
                // It relieves us of having to find or create the right
                // place to render the MainLayout in the course of app
                // initialization.
                this.render();
                this.rendered = true;
            }

            options = options || {};
            this.updateBackgroundClass(options.lightBackground);

            if (view.getPageTrackingParams) {
                trackingUtils.setPageParams(view.getPageTrackingParams());
            }
            // Clear previous fill preferences
            this.$(this.content.el).removeData('height');

            if (this.content.currentView) {
                this.stopListening(this.content.currentView);
            }
            this.listenTo(view, 'all', this.handleContentEvents);

            this.content.show(view);

            // Set the metatags and title for the page. `getMetaAttrs` returns
            // either a promise or a truthy object. If the view does not have a
            // `getMetaAttrs` method, we default to an empty dictionary which
            // resolves the $.when.
            $.when(view.getMetaAttrs ? view.getMetaAttrs() : {})
                .then(metatags.set);

            bus.trigger('viewSection', this.session && this.session.config);
        },

        updateBackgroundClass: function (lightBackground) {
            this.$el.toggleClass('bg--light', Boolean(lightBackground));
        },

        /*
         * Handles special events propagated up from the content view and its subviews.
         *
         * @param  {string} eventName - The name of the event triggered, with possible
         *                              prefixes from parent views that propagated the
         *                              event, ex: itemView:<orig event name>
         * @param  {View(s)} - Any parent views that propagated the event, ex:
         *                     CollectionView, FetchableCollectionView
         * @param  {*} - Any params passed to the original event
         */
        handleContentEvents: function (eventName) {
            // By checking the exact eventName, this only listens to events from the
            // top level view in the content region of this layout.
            if (eventName === 'show' || eventName === 'render') {
                this.toggleHeight();  // Update the height of the content container
            }
            // Check for a toggleHeight event on any (sub)view in the content region
            else if (/toggleHeight/.test(eventName)) {
                // Grab the the argument passed to the original event. Should be the height preference to use.
                this.toggleHeight(_.last(arguments));
            }
        },

        /**
         * Updates the content container to fill either the height of the
         * window or to remain the height of its content. Saves the given
         * preference on the container while it is showing this view.
         *
         * @param {('fill'|'content')} [heightPreference] - fill, by default
         */
        toggleHeight: function (heightPreference) {
            if (!this.content || !this.content.$el) {
                return;
            }
            if (!heightPreference) {
                // The default height preference, if not explicitly specified otherwise, is fill
                heightPreference = this.content.$el.data('height') || 'fill';
            }
            var minHeight;

            switch (heightPreference) {
            case 'fill':
                this.navHeight = this.navHeight || (this.nav.$el ? this.nav.$el.height() : 0);
                minHeight = (this.windowHeight - this.navHeight) + 'px';
                break;
            case 'content':
                // pass empty string to jquery to clear previously set value
                minHeight = '';
                break;
            default:
                break;
            }

            this.content.$el
                .css({ 'min-height': minHeight })
                .data({ height: heightPreference });
        },
    });

    if (sidebarUtils.isSidebar()) {
        asEmbedLayout.call(MainLayout.prototype);
    }
    withClickLinkTracking.call(MainLayout.prototype);

    return MainLayout;
});

define('home/views/common/TabbedView',[
    'jquery',
    'underscore',
    'backbone-marionette',

    'core/utils/metatags',
    'core/bus',
    'home/utils/trackingUtils',
    'home/utils/navigationUtils',
], function (
    $,
    _,
    Marionette,

    metatags,
    bus,
    trackingUtils,
    navigationUtils
) {
    'use strict';

    /**
     * Not intended to be instantiated.
     *
     * Parent class for views with multiple "tabs" of content that can be switched.
     *
     * Provides region for a content area that shows the active content.
     *
     * Provides listeners/handlers for clicks that switch the tab content,
     * and optionally update the url without causing a backbone router navigation.
     *
     * ex:
 == JavaScript ==
        var TwoTabs = TabbedView.extend({
            template: 'twotabs',

            // must provide. used by base class
            getTabView(tab) {
                switch(tab) {
                    case 'one':
                        return new View({name: 'one'});
                    case 'two':
                        return new View({name: 'two'});
                }
            }
        });

 == HTML/Handlebars ==
        {{! 'twotabs' template }}
        <nav>
            {{! including href in conjunction with switch-tab will use pushState to update the browser address bar }}
            <a href="/home/area/one" data-action="switch-tab" {{! no data-tab attr means this triggers the default tab }}>One</a>
            <a href="/home/area/two" data-action="switch-tab" data-tab="two">Two</a>
        </nav>
        {{! must have data-role=content-area for loading tab content }}
        <section data-role="content-area"></section>

 == CSS ==
        .active {
            // these rules will be applied to the tab currently selected
         }
     */
    var TabbedView = Marionette.Layout.extend({
        // Must override, either a function that returns a string, or the
        // string itself, that is the name of tab that's active by default
        defaultTab: undefined,

        // Mark this view's top element as a tabbed view so that we can determine
        // when a tab belongs to a nested tabbed view
        attributes: {
            'data-view-type': 'tabbed',
        },

        /**
         * Must override.
         * Returns a view instance to show when the given tab is active.
         * @param {string} [activeTab] - The name of the active tab
         */
        getTabView: function () {
            throw new Error('Not implemented');
        },

        /**
         * Can override in order to specify the section to be passed on
         * jester event tracking.
         * @param {string} [activeTab]
         * @returns {string} The section to send with jester events, or null
         *                  to pass defaults.
         */
        getTrackingSection: function () {
            return null;
        },

        // Child view's template should define below element(s)
        regions: {
            contentRegion: '[data-role=content-area]',
        },

        events: {
            'click [data-action=switch-tab]': 'switchTab',
        },

        initialize: function (options) {
            options = options || {};
            this.activeTab = options.activeTab;
            this.isModule = options.isModule;
            this.setTrackingSection();
        },

        switchTab: function (evt) {
            if (!evt)
                return false;

            // Don't allow tab changes in nested tabbed views propagate to parent
            // tabbed views.
            evt.preventDefault();
            evt.stopPropagation();

            var requestedTab = $(evt.currentTarget).data('tab');

            this.toggleDropdown();

            // User clicked the tab that is currently displayed: so do nothing
            if (requestedTab === this.activeTab)
                return;

            this.activeTab = requestedTab || _.result(this, 'defaultTab');

            // Find an anchor inside the tab, whether the user clicked on an element inside
            // the anchor, or on the top level tab element that contains the anchor.
            var $tab = $(evt.target).closest('[data-action=switch-tab]');
            var $anchor = $tab.find('a[href]').addBack('a[href]');

            // If href specified, update the url to represent the new href
            // (without triggering route handler)
            // Do this before updating the content of the tab so that any events triggered
            // during the showing of the content will have the correct url
            if ($anchor.length)
                navigationUtils.navigate($anchor[0]);

            this.updateTab();
        },

        toggleDropdown: function () {
            var navItem = this.$('.nav__item');
            if (navItem.length > 0)
                navItem.toggleClass('dropdown-open');
        },

        updateTab: function () {
            if (!this.activeTab)
                this.activeTab = _.result(this, 'defaultTab');

            var activeTab = this.activeTab;
            var newView = this.getTabView(activeTab);

            if (!newView) {
                this.trigger('badTab');
                activeTab = this.activeTab = _.result(this, 'defaultTab');
                newView = this.getTabView(activeTab);
            }

            this.setTrackingSection();

            this.updateTabContent(newView);

            this.updateTabClasses();

            this.trigger('change:activeTab', activeTab);
            bus.trigger('viewTab');
        },

        /**
         * Returns the elements within this view for changing tabs. Excludes those
         * used for changing tabs in a nested TabbedView.
         * @returns {jQuery}
         */
        getTabs: function () {
            // Exclude tabs from a TabbedView nested within this TabbedView
            var $allTabs = this.$('[data-action=switch-tab]');
            var $nestedTabs = this.$('[data-view-type=tabbed] [data-action=switch-tab]');

            return $allTabs.not($nestedTabs);
        },

        updateTabClasses: function () {
            if (!this.activeTab)
                this.activeTab = _.result(this, 'defaultTab');

            // Update the tabs to show which one is currently active
            var $tabs = this.getTabs();
            $tabs.filter('.active').removeClass('active');
            $tabs.filter('[data-tab="' + this.activeTab + '"]').addClass('active');
        },

        updateTabContent: function (newView) {
            var oldView = this.contentRegion.currentView;

            if (oldView) {
                // Prevent oldView from being closed, so that there isn't a time between closing
                // the old view and adding the new view, which causes a page jump. Will manually
                // close oldView later.
                oldView.onBeforeClose = function () {
                    return false;
                };

                // If this is a full-page view, ensure that the new view is tall enough so that it
                // will fill the current viewport, otherwise the page will get shorter and the
                // scrollbar will jump up, causing a jarring ux, unless the page is already
                // scrolled to top and then the minHeigh is not necessary.
                if (!this.isModule) {
                    var scrollTop = $(window).scrollTop();

                    if (scrollTop) {
                        var minHeight = scrollTop + $(window).height() - oldView.$el.offset().top;
                        newView.$el.css('minHeight', minHeight);
                    }
                }
            }

            this.contentRegion.show(newView);

            // Set the metatags and title for the page. `getMetaAttrs` returns
            // either a promise or a truthy object. If the view does not have a
            // `getMetaAttrs` method, we default to an empty dictionary which
            // resolves the $.when.
            if (this.getMetaAttrs)
                $.when(this.getMetaAttrs()).then(metatags.set);

            if (oldView) {
                // Now that the newView is in the dom, close the oldView.
                oldView.onBeforeClose = null;
                oldView.close();
            }
        },

        onDomRefresh: function () {
            // Don't bother creating views to fill in the regions if the regions don't
            // exist. This occurs when showing the fetching icon.

            if (this.$(this.contentRegion.el).length)
                this.updateTab();
        },

        setTrackingSection: function () {
            trackingUtils.setSection(
                this.getTrackingSection(this.activeTab) || _.result(this, 'defaultTab')
            );
        },

    });

    return TabbedView;
});

define('home/templates/allstarModal',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"modal-header\">\n<h4 class=\"modal-title\">\n<span class=\"icon__position -allstar -inline\">\n<span class=\"icon-allstar allstar__icon\"></span>\n</span>\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"%(Disqus)s All-Star",{"name":"gettext","hash":{"Disqus":"Disqus"},"data":data,"loc":{"start":{"line":6,"column":0},"end":{"line":6,"column":51}}}))
    + "\n</h4>\n</div>\n<div class=\"modal-body\">\n<p>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"All-Stars are the star contributors of %(Disqus)s. If you’ve come across them, you know they have a lot to say in their comments and discussions. They stand out for bringing their authenticity, knowledge, and personality to communities. Often, they are the hearts of the community and what makes this corner of the Internet a special place to be.",{"name":"gettext","hash":{"Disqus":"Disqus"},"data":data,"loc":{"start":{"line":10,"column":3},"end":{"line":10,"column":381}}}))
    + "</p>\n</div>\n<div class=\"modal-footer\">\n<a href=\"/home/channel/announcements/discussion/channel-announcements/all_stars/\"\nclass=\"button button-fill--brand button-padding-taller button-wide\"\ndata-action=\"close-and-navigate\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Learn More",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":16,"column":0},"end":{"line":16,"column":24}}}))
    + "\n</a>\n</div>\n";
},"useData":true})

});
define('home/mixins/withAllstarPopover',[
    'underscore',

    'home/utils/confirmModal',
    'home/templates/allstarModal',
], function (
    _,

    confirmModal,
    allstarModalTemplate
) {
    'use strict';

    /**
     * Adds to the allstar icon a tooltip and on-click modal with additional
     * information about allstars.
     */
    var withAllstarPopover = {
        events: {
            'click [data-action=show-allstar-modal]': 'showAllstarModal',
        },

        onDomRefresh: function (_onDomRefresh) {
            if (_onDomRefresh)
                _onDomRefresh.call(this);

            this.$('[data-toggle=tooltip]').tooltip();
        },

        // Debounce this in case an allstar icon appear in a nested view where multiple
        // click handlers are bound by multiple views.
        showAllstarModal: _.debounce(function () {
            confirmModal.getModal({
                modal: {
                    type: confirmModal.TYPES.CLOSE_ICON,
                    content: allstarModalTemplate(),
                },
            }).modal('show');
        }),
    };

    return function () {
        this.events = _.extend({}, withAllstarPopover.events, this.events);
        this.onDomRefresh = _.wrap(this.onDomRefresh, withAllstarPopover.onDomRefresh);
        _.defaults(this, _.pick(withAllstarPopover, [
            'showAllstarModal',
        ]));
    };
});

define('home/templates/recommendation',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div data-role=\"recommended-object\"></div>\n<div class=\"recommended__reason\"><em>"
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"reason") : depth0), depth0))
    + "</em></div>\n";
},"useData":true})

});
define('home/views/RecommendationView',[
    'backbone-marionette',

    'home/mixins/withAllstarPopover',
    'home/mixins/withSubviews',

    'home/templates/recommendation',
], function (
    Marionette,

    withAllstarPopover,
    withSubviews,

    recommendationTemplate
) {
    'use strict';

    /**
     * A View that shows an object (like a user or a forum) and a reason that the
     * object is recommended.
     *
     * This View should be backed by a FollowRecommendation.
     *
     * This View should be initialized with the View to use to show the object that
     * is being recommended (ex: RecommendedObjectView: UserSuggestionView).
     */
    var RecommendationView = Marionette.ItemView.extend({
        template: recommendationTemplate,
        className: 'recommended-wrap',

        regions: {
            recommendedObjectRegion: '[data-role=recommended-object]',
        },

        initialize: function (options) {
            this.RecommendedObjectView = options && options.RecommendedObjectView;
        },

        onRender: function () {
            if (this.RecommendedObjectView)
                this.activateRegion(this.recommendedObjectRegion, this.createRecommendedObjectView);
        },

        createRecommendedObjectView: function () {
            return new this.RecommendedObjectView({ model: this.model.object });
        },
    });

    withAllstarPopover.call(RecommendationView.prototype);
    withSubviews.call(RecommendationView.prototype);

    return RecommendationView;
});

define('home/views/BaseSuggestionView',[
    'backbone-marionette',
], function (
    Marionette
) {
    'use strict';

    /**
     * A view showing a single followable (with avatar, name, and follow button)
     */
    return Marionette.ItemView.extend({
        events: {
            'click [data-action=toggle-follow]': 'toggleFollow',
        },
        modelEvents: {
            'change:name': 'render',
            'change:isFollowing': 'handleFollowedClass',
        },

        handleFollowedClass: function () {
            this.$('[data-action=toggle-follow]').toggleClass('active', this.model.get('isFollowing'));
        },

        /**
         * Track event and toggle model, meant to be extended by concrete class
         * @param  {Event} evt            Event object
         * @param  {string} eventName   Provided by concrete class
         */
        toggleFollow: function (evt) {
            if (evt)
                evt.preventDefault();

            this.model.toggleFollowed();
        },
    });
});

define('home/templates/userSuggestion',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = container.invokePartial(lookupProperty(partials,"userAvatar"),depth0,{"name":"userAvatar","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "<h3 class=\"recommended__name truncate-line\">"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"userName"),depth0,{"name":"userName","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</h3>\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"genericFollowButton"),depth0,{"name":"genericFollowButton","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "");
},"usePartial":true,"useData":true})

});
define('home/views/UserSuggestionView',[
    'home/views/BaseSuggestionView',
    'home/templates/userSuggestion',
], function (
    BaseSuggestionView,
    userSuggestionTemplate
) {
    'use strict';

    /**
     * A view showing a single user's avatar, name, and follow button.
     */
    return BaseSuggestionView.extend({
        template: userSuggestionTemplate,
        className: 'recommended__item',

        toggleFollow: function (evt) {
            this.constructor.__super__.toggleFollow.call(this, evt, 'follow user');
        },
    });
});

define('home/templates/forumSuggestion',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = container.invokePartial(lookupProperty(partials,"forumAvatarLink"),depth0,{"name":"forumAvatarLink","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "");
},"3":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"avatar--empty\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"defaultForumAvatar"),depth0,{"name":"defaultForumAvatar","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"hasFavicon") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"data":data,"loc":{"start":{"line":1,"column":0},"end":{"line":7,"column":8}}})) != null ? stack1 : "")
    + "<h3 class=\"recommended__name truncate-line\">\n<a href=\"/home/forum/"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"id") : depth0), depth0))
    + "/\"\ndata-link-name=\"forum_name\"\ndata-forum-pk=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"pk") : depth0), depth0))
    + "\">\n\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"forumName"),depth0,{"name":"forumName","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</a>\n</h3>\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"genericFollowButton"),depth0,{"name":"genericFollowButton","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "");
},"usePartial":true,"useData":true})

});
define('home/views/ForumSuggestionView',[
    'home/views/BaseSuggestionView',
    'home/templates/forumSuggestion',
], function (
    BaseSuggestionView,
    forumSuggestionTemplate
) {
    'use strict';

    /**
     * A view showing a single forum's avatar, name, and follow button.
     */
    var ForumSuggestionView = BaseSuggestionView.extend({
        template: forumSuggestionTemplate,
        className: 'recommended__item',

        templateHelpers: function () {
            return {
                hasFavicon: this.model.hasFavicon(),
            };
        },

        toggleFollow: function (evt) {
            this.constructor.__super__.toggleFollow.call(this, evt, 'follow forum');
        },
    });

    return ForumSuggestionView;
});

define('home/templates/ProfileModuleEmpty',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"post-comments__wrapper\">\n<div class=\"empty-message\">\n<span class=\"icon-heart-break text-gray-light icon-huge\"></span>\n<p class=\"text-gray-light\">"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Nothing to see.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":4,"column":27},"end":{"line":4,"column":56}}}))
    + "</p>\n</div>\n</div>\n";
},"useData":true})

});
define('home/views/ProfileModuleEmptyView',[
    'backbone-marionette',
    'home/templates/ProfileModuleEmpty',
], function (
    Marionette,
    profileModuleEmptyTemplate
) {
    'use strict';

    var ProfileModuleEmptyView = Marionette.ItemView.extend({
        template: profileModuleEmptyTemplate,
    });

    return ProfileModuleEmptyView;
});

define('home/templates/recommendedUsersModule',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<footer class=\"module-footer\">\n<a href=\"/home/explore/people/\" class=\"nav-lnk -color-muted -flushed\">\n<div class=\"nav-lnk__blk\">"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Discover More People",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":17,"column":26},"end":{"line":17,"column":60}}}))
    + "</div>\n<div class=\"nav-lnk__pointer\">\n<span class=\"icon icon-right-bracket\"></span>\n</div>\n</a>\n</footer>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<header class=\"module-header text-center\">\n<button data-action=\"refresh\" class=\"icon__position--corner\">\n<span class=\"icon icon-refresh text-gray-light text-small\"></span>\n</button>\n<div class=\"module-header__icon\">\n<span class=\"icon text-brand icon-interesting-commenters\"></span>\n</div>\n<div class=\"module-header__title\">\n<h2 class=\"module-header__heading\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Interesting Commenters",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":9,"column":35},"end":{"line":9,"column":71}}}))
    + "</h2>\n<p class=\"module-header__subheading\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Follow people from around the %(disqus)s Network.",{"name":"gettext","hash":{"disqus":"Disqus"},"data":data,"loc":{"start":{"line":10,"column":37},"end":{"line":10,"column":118}}}))
    + "</p>\n</div>\n</header>\n<div data-role=\"items\" class=\"module-body\"></div>\n"
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"hideDiscoverLink") : depth0),{"name":"unless","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":14,"column":0},"end":{"line":23,"column":11}}})) != null ? stack1 : "");
},"useData":true})

});
define('home/templates/recommendedForumsModule',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<footer class=\"module-footer\">\n<a href=\"/home/explore/\" class=\"nav-lnk -color-muted -flushed\">\n<div class=\"nav-lnk__blk\">"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Discover More Communities",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":17,"column":26},"end":{"line":17,"column":65}}}))
    + "</div>\n<div class=\"nav-lnk__pointer\">\n<span class=\"icon icon-right-bracket\"></span>\n</div>\n</a>\n</footer>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<header class=\"module-header text-center\">\n<button data-action=\"refresh\" class=\"icon__position--corner\">\n<span class=\"icon icon-refresh text-gray-light text-small\"></span>\n</button>\n<div class=\"module-header__icon\">\n<span class=\"icon text-brand icon-communities\"></span>\n</div>\n<div class=\"module-header__title\">\n<h2 class=\"module-header__heading\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Lively Communities",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":9,"column":35},"end":{"line":9,"column":67}}}))
    + "</h2>\n<p class=\"module-header__subheading\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Follow sites from around the %(disqus)s Network.",{"name":"gettext","hash":{"disqus":"Disqus"},"data":data,"loc":{"start":{"line":10,"column":37},"end":{"line":10,"column":117}}}))
    + "</p>\n</div>\n</header>\n<div data-role=\"items\" class=\"module-body\"></div>\n"
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"hideDiscoverLink") : depth0),{"name":"unless","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":14,"column":0},"end":{"line":23,"column":11}}})) != null ? stack1 : "");
},"useData":true})

});
define('home/views/RecommendationsModuleView',[
    'underscore',
    'backbone-marionette',

    'home/views/RecommendationView',
    'home/views/UserSuggestionView',
    'home/views/ForumSuggestionView',
    'home/views/ProfileModuleEmptyView',

    'home/templates/recommendedUsersModule',
    'home/templates/recommendedForumsModule',
], function (
    _,
    Marionette,

    RecommendationView,
    UserSuggestionView,
    ForumSuggestionView,
    ProfileModuleEmptyView,

    recommendedUsersModuleTemplate,
    recommendedForumsModuleTemplate
) {
    'use strict';

    var RecommendationsModuleView = Marionette.CompositeView.extend({
        // Must be given ItemView and template options

        className: 'aside__wrap -padded',
        itemView: RecommendationView,
        emptyView: ProfileModuleEmptyView,
        itemViewContainer: '[data-role=items]',
        events: {
            'click [data-action=refresh]': 'refreshModule',
        },

        templateHelpers: function () {
            return {
                hideDiscoverLink: this.hideDiscoverLink,
            };
        },

        initialize: function (options) {
            this.collection = this.model && this.model.items;
            this.hideDiscoverLink = options && options.hideDiscoverLink;
        },

        refreshModule: function () {
            var $el = this.$el;
            $el.addClass('is-refreshing');
            var handleResetComplete = function () {
                $el.removeClass('is-refreshing');
            };
            this.model.fetchItems({ reset: true }).then(handleResetComplete);
        },
    }, {
        // Factory methods for creating 2 common RecommendationsModuleViews:
        // users and forums
        createUserRecommendedModuleView: function (options) {
            return new RecommendationsModuleView(_.extend({
                template: recommendedUsersModuleTemplate,
                itemViewOptions: {
                    RecommendedObjectView: UserSuggestionView,
                },
            }, options));
        },

        createForumRecommendedModuleView: function (options) {
            return new RecommendationsModuleView(_.extend({
                template: recommendedForumsModuleTemplate,
                itemViewOptions: {
                    RecommendedObjectView: ForumSuggestionView,
                },
            }, options));
        },
    });

    return RecommendationsModuleView;
});

define('home/views/FetchingView',[
    'backbone-marionette',
], function (
    Marionette
) {
    'use strict';

    var FetchingView = Marionette.ItemView.extend({
        className: 'spinner',
        template: function () {},
        initialize: function (options) {
            Marionette.ItemView.prototype.initialize.call(this, options);

            options = options || {};
            if (options.className)
                this.className = options.className;
        },
    });

    return FetchingView;
});

define('home/views/common/FetchableCollectionView',[
    'underscore',
    'jquery',
    'backbone',
    'backbone-marionette',

    'stance/main',

    'home/views/FetchingView',
], function (
    _,
    $,
    Backbone,
    Marionette,

    stance,

    FetchingView
) {
    'use strict';

    /**
     * An extended Marionette Collection view that shows not only the empty view,
     * but also a fetching view and an error view. If any of these views are not
     * given, it will use defaults. If the intention is to show nothing for one
     * of these states, override the default view with a blank view. Defaults
     * explained below.
     *
     * Any given views will be passed this view's model as a model, should this
     * view have a model.
     *
     * In order to determine the state of the collection (fetching/error), the view
     * will first check the view's model's attributes, if a model was given. If
     * a model was not given, it will check the fetching/error property or function
     * on the view's collection.
     *
     * fetchingView - if given, will be shown when fetching is true and the collection
     *                is empty. (don't want to hide existing collection items if more
     *                are being fetched)
     *                default: full page centered spinner
     * emptyView - if given, will be shown when the collection is empty and both fetching
     *             and error are false.
     *             default: blank
     */
    var FetchableCollectionView = Marionette.CollectionView.extend({
        fetchingView: FetchingView,

        // If emptyView is not specified, show a view that renders nothing rather than
        // not specifying an emptyView at all. Looks the same to the user, but this way
        // _showingEmptyView will be set to true when empty.
        emptyView: Backbone.View,

        initialize: function (options) {
            this.listenable = this.model || this.collection;
            this.listenTo(this.listenable, 'change:fetching', this.render);
            this.listenTo(this.collection, 'add', this.closeNonItemViews);
            this.listenTo(this.collection, 'reset', this.closeViews);
            this.listenTo(this, 'before:item:added', this.onFirstItem);

            if (options.infiniteScroll) {
                this.setupInfiniteScroll();
            }

            // Only trigger the renderInitialContent event once
            this.triggerRenderInitialContent = _.once(_.bind(this.trigger, this, 'renderInitialContent'));
        },

        setupInfiniteScroll: function () {
            stance.bindWindowEvents(); // noops after first call
            this.listenTo(this, 'after:item:added', _.debounce(this.updateInfiniteScrollTrigger, 0));
        },

        // Performance: track the time to show the first card on the DOM
        onFirstItem: function (view) {

            // Don't count fetching views, error views, empty views, etc.
            // (Specifically not using isShowingNonEmptyView because
            // this is more explicit.)
            if (this.collection.at(0) !== view.model) {
                return;
            }

            this.stopListening(this, 'before:item:added', this.onFirstItem);

            // Note: 'before:item:added' is fired before 'show'
            // See Marionette.CollectionView.prototype.addItemView
            this.listenToOnce(view, 'show', function () {
                this.trigger('showFirstItem', view);
            });
        },

        infiniteScrollTriggerOffset: function () {
            return -$(window).height();
        },

        updateInfiniteScrollTrigger: function () {
            // Don't set up inifinite scroll trigger if the view
            // has no items.
            if (!this.collection.length) {
                return;
            }

            var views = _.values(this.children._views);

            if (!views.length) {
                return;
            }

            var lastVisibleViewIndex = _.findLastIndex(views, function (view) { // eslint-disable-line no-shadow
                return !/(\s|^)hidden(\s|$)/.test(view.$el.attr('class'));
            });

            if (lastVisibleViewIndex < 0) {
                return;
            }

            var view = views[lastVisibleViewIndex];

            if (!view) {
                return;
            }

            var infiniteScrollTrigger = this.infiniteScrollTrigger;

            // Since this function can be triggered by adding a single
            // item to the collection, be sure to clean up the stance object
            // that was previously bound (don't want to fire multiple 'enter' events
            // at the same time)
            if (infiniteScrollTrigger) {
                this.stopListening(infiniteScrollTrigger);
            }

            infiniteScrollTrigger = stance({
                el: view.el,
                topEdgeOffset: this.infiniteScrollTriggerOffset,
            });
            this.infiniteScrollTrigger = infiniteScrollTrigger;

            this.listenToOnce(infiniteScrollTrigger, 'enter', this.loadMore);
        },

        loadMore: function () {
            var listenable = this.listenable;
            if (listenable.fetchItems) {
                listenable.fetchItems();
            } else if (listenable.more) {
                listenable.more();
            }

            this.infiniteScrollTrigger = null;
        },

        // Hack to fix bad Marionette behaviour where the empty view is shown briefly
        // while closing this CollectionView. Must set _showingEmptyView back to false
        // after close.
        onCollectionBeforeClose: function () {
            this._showingEmptyView = true;
        },
        onCollectionClosed: function () {
            this._showingEmptyView = false;
        },

        render: function () {
            var isEmpty = !this.collection.length;
            var isFetching = this.isFetching();
            var isError = this.isError();

            if (isEmpty) {
                if (isFetching) {
                    this.showFetchingView();

                } else if (isError) {
                    // Show nothing on initial fetch error. Footer view will show the
                    // error message.
                    this.closeViews();

                    // The function will only trigger the event once.
                    this.triggerRenderInitialContent();

                } else if (!this._showingEmptyView) {
                    Marionette.CollectionView.prototype.render.apply(this, arguments);

                    // The function will only trigger the event once.
                    this.triggerRenderInitialContent();
                }
            } else if (!this.children.length || this.isShowingNonItemView()) {
                // Only rerender the page if it's not already showing the
                // default marionette collection view because rerendering would
                // cause the page to scroll back up to the top
                // and show the same content as before.
                // Do this even if there's an error. Error message will show below any
                // previously fetched content in the footer view.
                this.closeViews();
                Marionette.CollectionView.prototype.render.apply(this, arguments);

                // The function will only trigger the event once.
                this.triggerRenderInitialContent();
            }
        },

        buildItemView: function (item, ItemViewType, itemViewOptions) {
            var emptyViewOptions = Marionette.getOption(this, 'emptyViewOptions');
            if (this._showingEmptyView && emptyViewOptions) {
                itemViewOptions = emptyViewOptions;
                if (_.isFunction(itemViewOptions)) {
                    itemViewOptions = itemViewOptions.call(this);
                }
            }

            return Marionette.CollectionView.prototype.buildItemView.call(this, item, ItemViewType, itemViewOptions);
        },

        /*
         * Required to show items in their sorted order, for a sorted collection.
         * This is the default behaviour in Marionette 2.0+.
         *
         * Copied from
         * https://github.com/marionettejs/backbone.marionette/wiki/Adding-support-for-sorted-collections
         */
        appendHtml: function (collectionView, itemView, index) {
            if (collectionView.isBuffering) {
                collectionView._bufferedChildren.push(itemView);
            }

            var childrenContainer = collectionView.isBuffering ?
                $(collectionView.elBuffer) :
                collectionView.$el;

            var children = childrenContainer.children();
            if (children.size() <= index) {
                childrenContainer.append(itemView.el);
            } else {
                children.eq(index).before(itemView.el);
            }
        },

        isFetching: function () {
            return this.checkState('fetching');
        },

        isError: function () {
            return this.checkState('error');
        },

        checkState: function (state) {
            // If this.listenable is not defined, the child class probably forgot
            // to call the parent's initialize method in the overridden initialize
            return this.listenable.get ?
                this.listenable.get(state) :
                _.result(this.listenable, state);
        },

        /*
         * Special views (fetching/error) may be closed from marionette's
         * collection view calling closeChildren. When this happens, need
         * to update the state which tracks if any of the special views
         * are currently showing.
         */
        bindViewClose: function (view, propertyName) {
            var self = this;

            // Must use view.on, not this.listenTo, because this.stopListening will
            // be called for view before close is triggered on view, so the event
            // will never fire.
            view.on('close', function () {
                self[propertyName] = false;
            });
        },

        /*
         * Closes all the special case views: fetching/error/empty.
         * This occurs when the collection is updated. Marionette's
         * collection view will handle showing/removing item views,
         * this just ensures that none of the special views are showing
         * at the same time as item views.
         */
        closeNonItemViews: function () {
            if (this.isShowingNonItemView()) {
                this.closeViews();
            }
        },

        isShowingNonItemView: function () {
            return this._showingFetchingView ||
                this._showingEmptyView;
        },

        /*
         * Closes all views, the special ones (fetching/error/empty),
         * and also the item views, should they be showing. This occurs
         * when a new special view is shown.
         */
        closeViews: function () {
            // Hack to ensure that this.closeChildren() does not trigger
            // the empty view to show. Must set to null immediately after
            // calling this.closeChildren()
            this._showingEmptyView = true;

            this.closeChildren();

            this._showingEmptyView = false;
            this._showingFetchingView = false;
        },

        showFetchingView: function () {
            var view = Marionette.getOption(this, 'fetchingView');

            if (view && !this._showingFetchingView) {
                this.closeViews();
                this._showingFetchingView = true;
                var model = this.model || new Backbone.Model();
                var fetchingView = this.addItemView(model, view, 0);
                this.bindViewClose(fetchingView, '_showingFetchingView');
            }
        },
    });

    return FetchableCollectionView;
});

define('home/templates/threadCardDefaultFooter',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    return "<span class=\"icon-lock icon-tiny spacing-right-small\"></span>\n";
},"3":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"1 Comment",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":11,"column":0},"end":{"line":11,"column":23}}}))
    + "\n";
},"5":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"%(posts)s Comments",{"name":"gettext","hash":{"posts":(depth0 != null ? lookupProperty(depth0,"posts") : depth0)},"data":data,"loc":{"start":{"line":13,"column":0},"end":{"line":13,"column":44}}}))
    + "\n";
},"7":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<li class=\"action\">\n<a href=\"#\" data-action=\"favorite\"\nclass=\"action-favorite "
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"favorited") : depth0),{"name":"if","hash":{},"fn":container.program(8, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":21,"column":23},"end":{"line":21,"column":53}}})) != null ? stack1 : "")
    + "\">\n\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"favorited") : depth0),{"name":"if","hash":{},"fn":container.program(10, data, 0),"inverse":container.program(12, data, 0),"data":data,"loc":{"start":{"line":23,"column":0},"end":{"line":27,"column":7}}})) != null ? stack1 : "")
    + "\n<span class=\"icon icon-heart\"></span>\n</a>\n</li>\n";
},"8":function(container,depth0,helpers,partials,data) {
    return "active";
},"10":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Recommended",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":24,"column":0},"end":{"line":24,"column":25}}}))
    + "\n";
},"12":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Recommend",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":26,"column":0},"end":{"line":26,"column":23}}}))
    + "\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, alias3=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<ul class=\"actions\">\n<li class=\"action\">\n<a href=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"discussionRoute") : depth0), depth0))
    + "\"\ndata-link-name=\"comment_count\"\ndata-thread-id=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"id") : depth0), depth0))
    + "\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias3,(depth0 != null ? lookupProperty(depth0,"isClosed") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":6,"column":0},"end":{"line":8,"column":7}}})) != null ? stack1 : "")
    + "\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias3,lookupProperty(helpers,"eq").call(alias3,(depth0 != null ? lookupProperty(depth0,"posts") : depth0),1,{"name":"eq","hash":{},"data":data,"loc":{"start":{"line":10,"column":6},"end":{"line":10,"column":18}}}),{"name":"if","hash":{},"fn":container.program(3, data, 0),"inverse":container.program(5, data, 0),"data":data,"loc":{"start":{"line":10,"column":0},"end":{"line":14,"column":7}}})) != null ? stack1 : "")
    + "<span class=\"icon icon-comment\"></span>\n</a>\n</li>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias3,(depth0 != null ? lookupProperty(depth0,"authenticated") : depth0),{"name":"if","hash":{},"fn":container.program(7, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":18,"column":0},"end":{"line":32,"column":7}}})) != null ? stack1 : "")
    + "</ul>\n";
},"useData":true})

});
define('home/mixins/withThreadSharing',[
    'jquery',
    'underscore',
], function (
    $,
    _
) {
    'use strict';

    /**
     * Default method for retrieving the thread off the model.
     * Expects the model to have a direct relation to the thread
     * (ex: activity, post), or be the thread itself.
     *
     * @returns {Thread}
     */
    var getThread = function () {
        return this.model.thread || this.model;
    };

    return function () {
        this.events = _.extend({
            'click [data-action=share]': 'handleShareThread',
        }, this.events);

        this.handleShareThread = function (event) {
            if (!event)
                return;

            event.preventDefault();
            event.stopPropagation();

            var thread = getThread.call(this);
            var network = $(event.currentTarget).attr('data-network');

            thread.shareThread(network);
        };
    };
});

define('home/views/ThreadCardDefaultFooterView',[
    'backbone-marionette',

    'home/models/Session',
    'home/templates/threadCardDefaultFooter',
    'home/mixins/withThreadSharing',
], function (
    Marionette,

    Session,
    threadCardDefaultFooterTemplate,
    withThreadSharing
) {
    'use strict';

    /**
     * The default footer view for cards backed by a thread. Shows
     * basic actions.
     *
     * Expects a thread as the model. Channel is optional.
     */
    var ThreadCardDefaultFooterView = Marionette.ItemView.extend({
        template: threadCardDefaultFooterTemplate,
        templateHelpers: function () {
            var session = Session.get();

            return {
                favorited: this.model.get('userScore') > 0,
                discussionRoute: this.model.getDiscussionRoute(this.channel),
                authenticated: !session.isAnonymous(),
                likes: this.model.get('likes'),
            };
        },

        events: {
            'click [data-action=favorite]': 'toggleThreadFavorited',
            'click [data-action=toggle-subscription]': 'toggleSubscription',
        },

        initialize: function (options) {
            this.listenTo(this.model, 'change:userScore', this.render);
            this.listenTo(this.model, 'change:userSubscription', this.render);
            this.channel = options && options.channel;
        },

        toggleThreadFavorited: function (event) {
            if (event)
                event.preventDefault();

            this.model.toggleFavorited();
        },

        toggleSubscription: function (event) {
            if (event)
                event.preventDefault();

            this.model.toggleSubscription();
        },
    });

    withThreadSharing.call(ThreadCardDefaultFooterView.prototype);

    return ThreadCardDefaultFooterView;
});

define('home/mixins/withThreadCardDefaultFooter',[
    'underscore',
    'home/mixins/withSubviews',
    'home/views/ThreadCardDefaultFooterView',
], function (
    _,
    withSubviews,
    ThreadCardDefaultFooterView
) {
    'use strict';

    /**
     * Default method for retrieving the thread off the model.
     * Expects the model to have a direct relation to the thread
     * (ex: activity, post), or be the thread itself.
     *
     * Can be overwritten by passing function to withThreadCardDefaultFooter
     * @returns {Thread}
     */
    var getThread = function () {
        return this.model.thread || this.model;
    };

    var withThreadCardDefaultFooter = {
        render: function (_render) {
            _render.call(this);
            this.footerRegion = this.addRegion('[data-role=footer]');
            this.activateRegion(this.footerRegion, this.createThreadDefaultFooter);
            return this;
        },

        createThreadDefaultFooter: function () {
            var thread = getThread.call(this);

            return new ThreadCardDefaultFooterView({
                el: this.footerRegion.el,
                model: thread,
                channel: this.channel,
            });
        },
    };

    return function () {
        withSubviews.call(this);

        this.createThreadDefaultFooter = withThreadCardDefaultFooter.createThreadDefaultFooter;
        this.render = _.wrap(this.render, withThreadCardDefaultFooter.render);
    };
});

define('home/mixins/withTruncate',[
    'jquery',
    'underscore',
], function (
    $,
    _
) {
    'use strict';

    var withTruncate = {
        onDomRefresh: function (_onDomRefresh) {
            if (_onDomRefresh)
                _onDomRefresh.call(this);

            this.$('.truncate').each(function (__, el) {
                $(el).trunk8({
                    lines: $(el).data('truncateLines') || 1,
                });
            });

            this.trigger('truncate:complete');
        },
    };

    return function () {
        this.onDomRefresh = _.wrap(this.onDomRefresh, withTruncate.onDomRefresh);
    };
});

define('home/mixins/asGenericCard',[
    'underscore',

    'home/utils/layoutUtils',
    'home/mixins/withThreadCardDefaultFooter',
    'home/mixins/withTruncate',
], function (
    _,

    layoutUtils,
    withThreadCardDefaultFooter,
    withTruncate
) {
    'use strict';

    var asGenericCard = {
        className: function (existingClassName) {
            if (_.isFunction(existingClassName))
                existingClassName = existingClassName.apply(this, _.rest(arguments));

            existingClassName = existingClassName || '';

            return [
                'card',
                'card-generic',
                'card-generic-' + this.model.get('verb'),
                existingClassName,
            ].join(' ');
        },

        initialize: function (_initialize, options) {
            options = options || {};
            _initialize.call(this, options);

            this.channel = options.channel;
            this.hideImage = options.hideImage;
            this.listenTo(this.model.thread, 'change:content', this.render);
            this.numTitleLines = options.numTitleLines || 3;
        },

        serializeData: function (_serializeData) {
            var data = _serializeData.call(this);
            var thread = this.model.thread;

            return _.defaults(data, {
                discussionRoute: thread.getDiscussionRoute(this.channel),
                threadDescriptionHTML: thread.getDefaultDescription(),
                image: !this.hideImage && !layoutUtils.isNarrowLayout() && thread.getImage(),
                numTitleLines: this.numTitleLines,
            });
        },
    };

    return function () {
        withThreadCardDefaultFooter.apply(this, arguments);
        withTruncate.apply(this, arguments);

        this.className = _.wrap(this.className, asGenericCard.className);
        this.initialize = _.wrap(this.initialize, asGenericCard.initialize);
        this.serializeData = _.wrap(this.serializeData, asGenericCard.serializeData);
    };
});

define('core/utils/views',[
    'underscore',
], function (
    _
) {
    'use strict';

    /*
     * Basic implementation of mixin pattern. Copies all the properties/events from
     * mixin object to current view. In addition mixin customization is available through
     * mixinConfig (this is useful to split mixin configuration from view configuration).
     * All conflicting properties/events will be untouched in original view except initialize method,
     * which will be chained with mixin.initialize.
     *
     * Example of usage:
     *
     * utils.mixin(ViewClass, LocalScroll, {
     *      mixinProp: 'myconfig'
     * });
     */
    var mixer = function (viewClass, mixin, mixinConfig) {
        var proto = viewClass.prototype;
        var extendedMixin = _.extend({}, mixin, mixinConfig);
        _.defaults(proto, extendedMixin);
        _.defaults(proto.events, extendedMixin.events);
        if (proto.initialize !== undefined && extendedMixin.initialize !== undefined) {
            var originalInit = proto.initialize;
            proto.initialize = function () {
                var value = originalInit.apply(this, arguments);
                extendedMixin.initialize.apply(this, arguments);
                return value;
            };
        }
    };

    return {
        mixin: mixer,
    };
});

define('core/views/common/HoverCard',[
    'jquery',
    'underscore',
    'backbone',

    'core/bus',
    'core/utils',
], function (
    $,
    _,
    Backbone,

    Bus,
    utils
) {
    'use strict';

    /**
     * HoverCard is a base class that cannot be instantiated on its own.
     * It includes all the functionality for revealing and hiding a
     * hovercard. How the card is rendered or updated, is handled by the
     * concrete class (see ProfileCard, ContextCard).
     *
     * HoverCard also maintains an internal list of instances keyed by
     * by concrete class name. This is because it is common for hovercards
     * (both types) to be re-used for different targets. For example, you
     * only need a single ContextCard for a thread with 1 parent comment
     * and 20 replies. The HoverCard class ensures that a single card is
     * created for this purpose, *but* can be bound to different targets.
     */

    var HoverCard = Backbone.View.extend({
        // CAREFUL! Backbone events defined in concrete classes completely
        // replace events defined here unless you explicitly copy them over.
        events: {
            'mouseenter': 'enter',
            'mouseleave': 'leave',
        },

        initialize: function () {
            this._id = _.uniqueId();

            this._rendered = false;
            this._hoverState = 'out';
            this._visible = false;
            this._enterTimeout = null;
            this._leaveTimeout = null;

            HoverCard.open = {};

            // Show profile event is mandatory for all HoverCards as user is
            // able to open other user's profile from any HoverCard at the moment.
            // Append the event to (probably) existing events object in order to preserve
            // child class events.
            this.events = this.events || {};
            this.events['click [data-action=profile]'] = 'handleShowProfile';

            this.listenTo(this, 'authenticating', this.keepOpen);
        },

        // should be called by after subclass finished with rendering
        render: function () {
            this.hide();
            $('body').append(this.el);

            return this;
        },

        target: function ($target) {
            // Add hover events to $target that open the hovercard

            // TODO: This is slow. We're creating *two* events for each
            //       element that launches the hovercard. We should probably
            //       delegate a hover event on the entire embed/<body>, and
            //       maintain active targets in a hash. It also leaks memory.
            $target.on('mouseenter', _.bind(this.enter, this, $target));
            $target.on('mouseleave', _.bind(this.leave, this));
        },

        enter: function ($target) {
            var self = this;

            // This method is both used in `target` above with a bound $target
            // argument and as an event handler so `$target` can also be the
            // jQuery event object. Normalize for this. See T8522.
            if ($target.originalEvent)
                $target = null;

            // re-assign target here as single card may listen for several mouseover events
            // from different targets and just showup near the target user just hovered.
            // So $target basically means current target.
            if ($target)
                self.$target = $target;

            if (self._leaveTimeout)
                clearTimeout(self._leaveTimeout);

            if (self._hoverState === 'in')
                return;

            self._hoverState = 'in';
            self._enterTimeout = _.delay(function () {
                if (self._hoverState === 'in')
                    self.show();

                self._enterTimeout = null;
            }, HoverCard.DELAY_ENTER);

            HoverCard.open[this.uid] = this;
        },

        leave: function () {
            var self = this;

            if (self._enterTimeout)
                clearTimeout(self._enterTimeout);

            if (self._hoverState === 'out')
                return;

            self._hoverState = 'out';

            self._leaveTimeout = _.delay(function () {
                if (self._hoverState === 'out')
                    self.hide();

                self._leaveTimeout = null;
            }, HoverCard.DELAY_LEAVE);

            if (HoverCard.open[this.uid])
                delete HoverCard.open[this.uid];
        },

        show: function () {
            var self = this;

            if (!self._rendered) {
                self._rendered = true;
                self.render();
            }
            // Element is hidden at this moment because of two possible reasons:
            // 1. It was just rendered - we render it with display:none style
            // 2. It was rendered, shown and then hidden, so now it is a time to show it again
            // So it is safe to move it to its position and show afterwards (won't have flickering)
            self.moveTo(self.$target);

            self.$el.show();

            self._visible = true;

            self.trigger('show');
        },

        // Displays current view's element near the target element.
        // By default the position of the tooltip is below the target, but
        // if there is no space at the bottom, the tooltip will be displayed
        // above the target.
        moveTo: function (target) {
            if (!target)  // if no target specified - there is no place to move to
                return;

            var posOffset = HoverCard.POSITION_OFFSET; // show tooltip with posOffset overlap on target
            var pos = target.offset();
            var el = this.$el;
            var elHeight = el.height();
            var containerPos = this.getContainerPosition();

            pos.top -= posOffset;  // show it slightly above the target

            // try to position tooltip below the target
            var cardBottom = pos.top + elHeight + containerPos.containerOffset.top;
            var containerBottom = containerPos.pageOffset + containerPos.containerHeight;

            if (cardBottom <= containerBottom)
                el.css('top', pos.top);
            else  // if there is not space in a bottom, show tooltip above the target
                el.css('top', pos.top - elHeight + posOffset * 2);

            el.css('left', pos.left + posOffset);
        },

        getContainerPosition: function () {
            return {
                pageOffset: $(window).scrollTop(),
                containerOffset: {
                    top: 0,
                    height: $(window).height(),
                },
                containerHeight: $(window).height(),
            };
        },

        // Override for lounge
        // getContainerPosition: function () {
        //     var loungePos = common.getLounge().getPosition();

        //     return {
        //         pageOffset: loungePos.pageOffset,
        //         containerOffset: loungePos.frameOffset,
        //         containerHeight: loungePos.height
        //     };
        // },

        hide: function () {
            if (this._keepOpen)
                return;

            if (this._enterTimeout)
                clearTimeout(this._enterTimeout);

            this.$el.hide();
            this._visible = false;
        },

        // Keeps the hover card open while the user is off doing something else
        // e.g., if the user clicks the "follow" button in a hover card while logged out,
        // call this function to keep the hover card open while the user logs in
        keepOpen: function () {
            this._keepOpen = true;
            this.setupKeepOpenCanceler();
        },

        setupKeepOpenCanceler: function () {
            var self = this;
            var cancel = function () {
                if (self._hoverState !== 'out')
                    return;

                self.stopListening(Bus, 'window.click', cancel);
                $('body').off('click', cancel);
                self._keepOpen = false;
                self.hide();
            };

            // When you bind to 'click' in the middle of handling a
            // click, the handler that you bind during the click gets
            // triggered by the click in which you bound the handler (!)
            // Hence the delay.
            _.delay(function () {
                // Click outside of the iframe
                self.listenTo(Bus, 'window.click', cancel);
                // Click inside the iframe
                $('body').on('click', cancel);
            }, 100);
        },

        isVisible: function () {
            return this._visible;
        },

        /**
         * This handler should only contain hover card specific actions.
         * Actual opening of profile will be handled when the event
         * propagates to the lounge click event handlers.
         */
        handleShowProfile: utils.preventDefaultHandler(function () {
            this.hide();
        }),

    }, {
        // Class properties (HoverCard.*)

        // Hash/truth table of open hovercard instances. Used to bulk exit
        // multiple hovercards (i.e. when the user mouseouts the iframe)
        open: {},

        // Instances track open card instances by concrete class name
        // {
        //    ProfileCard: { 1: true, 2: true, 3: true },
        //    ContextCard: { 8: true, 9: true }
        // }
        instances: {},

        // Time in milliseconds before mouseenter triggers show
        DELAY_ENTER: 350,

        // Time in milliseconds before mouseouts triggers reveal
        DELAY_LEAVE: 175,

        // Amount of pixels to overlap with target element position
        POSITION_OFFSET: 20,

        // Exits every open hovercard. Used in conjunction with document mouseout
        // so that we only have a single event handler that closes hovercards
        // when the user mouses out of the iframe.

        exitAll: function () {
            _.invoke(HoverCard.open, 'leave');
        },

        // A common trait of hovercards is that a single card can appear
        // in multiple contexts. Rather than re-create the hovercard
        // over and over, it's easier to create a single instance and
        // reposition it. This helper tracks concrete class instances and
        // ensures that no duplicates are made.

        create: function (id, options, className, ClassConstructor) {
            var classInstances = HoverCard.instances[className];
            if (!classInstances)
                HoverCard.instances[className] = classInstances = {};

            // TODO: Work with anonymous profiles
            var card = classInstances[id];
            if (!card) {
                card = new ClassConstructor(options);
                classInstances[id] = card;
            }

            if (options.targetElement)
                card.target(options.targetElement);

            return card;
        },
    });

    (function () {
        // Detect when mouse leaves iframe window
        // http://stackoverflow.com/questions/923299/how-can-i-detect-when-the-mouse-leaves-the-window
        $(window.document).on('mouseout', _.debounce(function (evt) {
            var from = evt.relatedTarget || evt.toElement;
            if (!from || from.nodeName === 'HTML')
                HoverCard.exitAll();
        }, 10));
    })();

    return HoverCard;
});

define('core/views/common/mixins/LocalScroll',[
], function (
) {
    'use strict';

    // LocalScroll mixin prevent scrolling outside area user is in currently.
    // To be used via utils/mixin
    var LocalScroll = {
        events: {
            'mousewheel': 'handleScrollEvent', // Chrome, IE, Safari version
            'wheel': 'handleScrollEvent', // FF version
        },

        // selector for the element which contain scrollable content.
        // content should hold the whole necessary width for it, i.e. no
        // overflow:scroll
        scrollMeasureSelector: '',

        getScrollMeasure: function () {
            if (!this.scrollMeasure) {
                this.scrollMeasure = this.$el;
                if (this.scrollMeasureSelector)
                    this.scrollMeasure = this.$el.find(this.scrollMeasureSelector);
            }
            return this.scrollMeasure;
        },

        // prevent user to scroll in parent container while in the view
        // TODO: implement the same logic for scrolling via keyboard
        handleScrollEvent: function (evt) {
            // if dir is greater than 0 - means direction up and
            // if dir is less than 0 - user scrolling down
            var event = evt.originalEvent;
            var dir = event.wheelDeltaY || -event.deltaY;

            var el = this.$el;
            var height = el.height(); // height of visible area
            var measure = this.getScrollMeasure(); // measures scrollable content area height
            var scrollHeight = measure.height(); // height of inner content
            var scrollTop = measure.parent()[0].scrollTop; // current position of the scroll
            var isBottom = scrollTop >= scrollHeight - height;
            var isTop = scrollTop === 0;

            if ((isBottom && dir < 0) || (isTop && dir > 0))
                evt.preventDefault();
        },
    };

    return LocalScroll;
});

define('core/templates/usersCard',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    return "guests-only";
},"3":function(container,depth0,helpers,partials,data,blockParams,depths) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"each").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"users") : depth0),{"name":"each","hash":{},"fn":container.program(4, data, 0, blockParams, depths),"inverse":container.noop,"data":data,"loc":{"start":{"line":4,"column":0},"end":{"line":6,"column":9}}})) != null ? stack1 : "");
},"4":function(container,depth0,helpers,partials,data,blockParams,depths) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = container.invokePartial(lookupProperty(partials,"cardUser"),depth0,{"name":"cardUser","hash":{"forumId":(depths[1] != null ? lookupProperty(depths[1],"forumId") : depths[1]),"highlight":(depths[1] != null ? lookupProperty(depths[1],"highlight") : depths[1])},"data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "");
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data,blockParams,depths) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"tooltip voters "
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"users") : depth0)) != null ? lookupProperty(stack1,"length") : stack1),{"name":"unless","hash":{},"fn":container.program(1, data, 0, blockParams, depths),"inverse":container.noop,"data":data,"loc":{"start":{"line":1,"column":27},"end":{"line":1,"column":73}}})) != null ? stack1 : "")
    + "\">\n<ul class=\"scroll-measure\" data-role=\"content\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"users") : depth0)) != null ? lookupProperty(stack1,"length") : stack1),{"name":"if","hash":{},"fn":container.program(3, data, 0, blockParams, depths),"inverse":container.noop,"data":data,"loc":{"start":{"line":3,"column":0},"end":{"line":7,"column":7}}})) != null ? stack1 : "")
    + "</ul>\n</div>\n<div class=\"tooltip-point hidden\"></div>\n";
},"usePartial":true,"useData":true,"useDepths":true})

});
define('core/views/UsersCard',[
    'jquery',
    'underscore',
    'handlebars',
    'core/config',
    'core/bus',
    'core/utils/views',
    'core/views/common/HoverCard',
    'core/views/common/mixins/LocalScroll',

    'core/templates/usersCard',
], function (
    $,
    _,
    Handlebars,
    config,
    Bus,
    utils,
    HoverCard,
    LocalScrollMixin,

    usersCardTemplate
) {
    'use strict';

    var shouldAnonymize = function (user) {
        return user.get('isAnonymous') || user.get('isBlocked');
    };

    // UsersCard shows a list of users
    var UsersCard = HoverCard.extend({
        guestTextPartialName: 'cardOtherUserText',

        className: 'tooltip-outer voters-outer',

        initialize: function (options) {
            HoverCard.prototype.initialize.call(this, options);

            this.collection = this.collection || options.collection;
            this.session = options.session;

            // The total number of users in the set shown here.
            // This may be greater than the number in the given collection
            // if it exceeds the fetch limit, or if there are guests
            this.numUsers = options.numUsers;
            this.voteType = options.voteType;

            this.listenTo(this.collection, 'add', this.addUser);
            this.listenTo(this.collection, 'change:isBlocked', this.render);
            this.listenTo(this.collection, 'remove', this.removeUser);
            this.listenTo(this.collection, 'reset', this.render);
        },

        addUser: function (user) {
            if (shouldAnonymize(user)) {
                this.updateGuests();
            } else if (this.$listEl && this.$listEl.length) {
                this.$listEl.prepend(Handlebars.partials.cardUser(this.getUserTemplateData(user)));
                this.stopHighlightUsername();
            }
        },

        removeUser: function (user) {
            if (shouldAnonymize(user)) {
                this.updateGuests();
            } else {
                var userEl = this.$el.find('[data-username=' + user.get('username') + ']');
                if (userEl.length)
                    userEl.remove();
            }
        },

        // stop animation after 1.1s as the animation durations is 1s
        stopHighlightUsername: _.debounce(function () {
            var usernameEl = this.$el.find('.highlight');
            usernameEl.removeClass('highlight');
        }, 1100),

        getGuestCount: function () {
            return Math.max(this.numUsers - this.collection.reject(shouldAnonymize).length, 0);
        },

        updateGuests: function () {
            var guestEl = this.$el.find('[data-role=guest]');
            var guestCount = this.getGuestCount();
            var guestText = Handlebars.partials[this.guestTextPartialName]({
                guestCount: guestCount,
            });

            var data = {
                guestCount: guestCount,
                guestAvatarUrl: config.urls.avatar.generic,
                highlight: guestEl.length,
                guestText: guestText,
            };

            var html = Handlebars.partials.cardGuestUser(data);

            if (guestEl.length) {
                guestEl.replaceWith(html);
                this.stopHighlightUsername();
            } else if (this.$listEl && this.$listEl.length) { // if this is the first guest
                this.$listEl.append(html);
            }
        },

        getTemplateData: function () {
            return {
                users: _.invoke(this.collection.reject(shouldAnonymize), 'toJSON'),
                highlight: false,
            };
        },

        getUserTemplateData: function (user) {
            return _.extend({
                highlight: true,
            }, user.toJSON());
        },

        render: function () {
            // cleanup dom references
            delete this.pointEl;

            // do render
            this.$el.html(usersCardTemplate(this.getTemplateData()));

            HoverCard.prototype.render.call(this);
            this.$listEl = this.$el.find('.voters ul');

            this.updateGuests();
        },

        show: function () {
            // if there is are no users, or if the card is already visible,
            // nothing needs to be done
            if (!this.numUsers || this.isVisible())
                return;

            // show/render list of users
            HoverCard.prototype.show.call(this);

            Bus.trigger('uiAction:userCardShow');
        },

        // shows "bubble-speech" pointer at specified location.
        // currently only two locations are supported:
        // 'tl' - stands for top left
        // 'bl' - stands for bottom left
        showPoint: function (position) {
            var supportedPositions = ['tl', 'bl'];
            if (!this.pointEl) {
                this.pointEl = this.$el.find('.tooltip-point');
                this.pointEl.removeClass('hidden');
            }
            _.each(supportedPositions, function (pos) {
                this.pointEl.removeClass('point-position-' + pos);
            }, this);
            this.pointEl.addClass('point-position-' + position);
        },

        // Displays current view's element near the target element.
        // By default the position of the tooltip is above the target, but
        // if there is no space above, the tooltip will be displayed
        // below the target.
        moveTo: function (target, heightIncrease) {
            // Note: it is safe to call moveTo when element is hidden, i.e.
            // style=display:none. Looks like jQuery will make element visible,
            // compute its dimensions and hide again.
            if (!target) // if no target specified - there is no place to move to
                return;

            var posOffset = HoverCard.POSITION_OFFSET; // show tooltip with posOffset overlap on target
            var pos = target.offset();
            var el = this.$el;
            var elHeight = el.height();
            var containerPos = this.getContainerPosition();

            // animation is going to delay height increase, so we need to consider future height
            // in our calculations now.
            if (heightIncrease)
                // height doesn't include paddings/margings, so use +10 for it.
                elHeight += el.find('li.user').height() + 10;

            // try to position tooltip on top of the target
            if (pos.top - elHeight - posOffset >= 0 && pos.top - elHeight + containerPos.containerOffset.top >= containerPos.pageOffset) {
                el.css({
                    'bottom': containerPos.containerOffset.height - pos.top + posOffset,
                    'top': 'inherit',
                });
                this.showPoint('bl');
            } else { // if there is not space on a top, show tooltip below the target
                el.css({
                    'bottom': 'inherit',
                    'top': pos.top + posOffset * 2,
                });
                this.showPoint('tl');
            }
            el.css('left', pos.left - posOffset);
        },

        handleShowProfile: function (evt) {
            HoverCard.prototype.handleShowProfile.call(this, evt);

            var $target = $(evt.currentTarget);
            var username = $target.attr('data-username');

            Bus.trigger('uiCallback:showProfile', username);
        },

    }, {
        create: function (id, options) {
            return HoverCard.create(id, options, 'UsersCard', UsersCard);
        },
    });

    utils.mixin(UsersCard, LocalScrollMixin, {
        scrollMeasureSelector: '[data-role=content]',
    });

    return UsersCard;
});

define('home/utils/cardUtils',[
    'core/bus',
    'home/utils/navigationUtils',
    'home/utils/sidebarUtils',
], function (
    Bus,
    NavigationUtils,
    sidebarUtils
) {
    'use strict';

    Bus.on({
        'uiCallback:showProfile': function (username) {
            var userFragment = '/by/' + username + '/';
            if (sidebarUtils.isSidebar())
                window.open(userFragment);
            else
                NavigationUtils.navigate(userFragment, { trigger: true });
        },
    });
});

define('home/views/ActivityActorsHoverCard',[  // eslint-disable-line requirejs/amd-function-arity
    'underscore',
    'backbone',
    'home/models/Session',
    'core/views/UsersCard',
    'core/views/common/HoverCard',

    // imported for side effects
    'home/utils/cardUtils',
], function (
    _,
    Backbone,
    Session,
    UsersCard,
    HoverCard
) {
    'use strict';

    var ActivityActorsHoverCard = UsersCard.extend({
        initialize: function (options) {
            var activityFeedItem = options.activityFeedItem;
            var numShownActors = options.numShownActors;

            // Update users collection and all counts to remove the users already shown in
            // the reason line. Those aren't counted/displayed in this hover card.
            _.extend(options, {
                numUsers: activityFeedItem.get('totalActors') - numShownActors,
                session: Session.get(),
                collection: new Backbone.Collection(activityFeedItem.actors.slice(numShownActors)),
            });

            UsersCard.prototype.initialize.apply(this, arguments);
        },

        show: function () {
            UsersCard.prototype.show.apply(this, arguments);

            this.trigger('uiAction:activityActorsCardShow');
        },
    }, {
        create: function (options) {
            return HoverCard.create(options.activityId, options, 'ActivityActorsHoverCard', ActivityActorsHoverCard);
        },
    });

    return ActivityActorsHoverCard;
});

define('home/mixins/withReason',[
    'underscore',
    'home/views/ActivityActorsHoverCard',
    'core/utils',

], function (
    _,
    ActivityActorsHoverCard,
    utils
) {
    'use strict';

    var initHoverCard = function () {
        // We don't use voter cards on mobile-like user agents.
        if (utils.isMobileUserAgent())
            return;

        var target = this.$('[data-role=actors]');
        if (!target.length)
            return;

        if (this.hoverCard)
            this.hoverCard.remove();

        this.hoverCard = ActivityActorsHoverCard.create({
            targetElement: target,
            activityFeedItem: this.model,
            activityId: this.model.id,

            // The avatar for 1 actor is shown in the reason line. Other actors
            // are shown as "n other(s)"
            numShownActors: 1,
        });
    };

    /*
     * Returns the number of times this action occurred.
     * For right now, we only show a count if there was only 1 actor
     * and more than 1 occurrence.
     * ex: Nicole commented 2 times
     */
    var getNumOccurrences = function () {
        if (!this.model.actors || this.model.actors.length !== 1)
            return 0;

        var numOccurrences = this.model.get('totalActivities');
        return numOccurrences > 1 ? numOccurrences : 0;
    };

    var withReason = function () {
        this.initialize = _.wrap(this.initialize, function (_initialize) {
            _initialize.apply(this, _.rest(arguments));

            // Whenever this view (re)renders, reinitialize the hovercard so the
            // event handlers are tied to the correct elements.
            this.listenTo(this, 'render', initHoverCard);
        });

        var _templateHelpers = this.templateHelpers;
        this.templateHelpers = function () {
            var enableBestOfDisqusCallout = this.options && this.options.enableBestOfDisqusCallout;
            var thread = this.model.thread;
            var firstActivity = this.model.activities[0];
            var isBestOfDisqus = enableBestOfDisqusCallout &&
                firstActivity.get('type') === 'TrendingThreadOnChannel' &&
                (firstActivity.targetChannel && firstActivity.targetChannel.get('options').isCurationOnlyChannel);

            return _.extend({
                relativeTime: this.model.getRelativeTimestamp(),
                numRemainingActors: this.model.get('totalActors') - 1,
                numOccurrences: getNumOccurrences.call(this),
                firstActor: this.model.actors[0] && this.model.actors[0].toJSON(),
                isBestOfDisqus: isBestOfDisqus,

                // If thread was recommended by "Best of Disqus" add that as one "like".
                // (mainly makes a difference when there are 0 other likes)
                threadLikes: thread && thread.get('likes') + (isBestOfDisqus ? 1 : 0),
            }, _.isFunction(_templateHelpers) ? _templateHelpers.apply(this, arguments) : _templateHelpers);
        };
    };

    return withReason;
});


define('home/templates/postActions',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\"#\" class=\"vote-up"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"sessionUserHasUpvoted") : depth0),{"name":"if","hash":{},"fn":container.program(2, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":2,"column":26},"end":{"line":2,"column":69}}})) != null ? stack1 : "")
    + "\" data-action=\"vote\" data-vote=\"1\">\n<span class=\"vote__count text-gray text-small\" data-role=\"upvotes\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"likes") : depth0),{"name":"if","hash":{},"fn":container.program(4, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":4,"column":0},"end":{"line":4,"column":29}}})) != null ? stack1 : "")
    + "\n</span>\n<span class=\"icon-arrow-up icon-tiny\"></span>\n</a>\n";
},"2":function(container,depth0,helpers,partials,data) {
    return " active";
},"4":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"likes") : depth0), depth0));
},"6":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\"#\" class=\"vote-down"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"sessionUserHasDownvoted") : depth0),{"name":"if","hash":{},"fn":container.program(2, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":11,"column":28},"end":{"line":11,"column":73}}})) != null ? stack1 : "")
    + "\" data-action=\"vote\" data-vote=\"-1\">\n<span class=\"icon-arrow-down icon-tiny\"></span>\n<span class=\"vote__count text-gray text-small\" data-role=\"downvotes\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"showDownvoteCount") : depth0),{"name":"if","hash":{},"fn":container.program(7, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":14,"column":0},"end":{"line":14,"column":44}}})) != null ? stack1 : "")
    + "\n</span>\n</a>\n";
},"7":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"dislikes") : depth0), depth0));
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.lambda, alias3=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"showUpvote") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":1,"column":0},"end":{"line":8,"column":7}}})) != null ? stack1 : "")
    + "\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"showDownvote") : depth0),{"name":"if","hash":{},"fn":container.program(6, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":10,"column":0},"end":{"line":17,"column":7}}})) != null ? stack1 : "")
    + "\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"replyOrEditLink"),depth0,{"name":"replyOrEditLink","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "\n<a href=\""
    + alias3(alias2((depth0 != null ? lookupProperty(depth0,"discussionRoute") : depth0), depth0))
    + "#comment-"
    + alias3(alias2((depth0 != null ? lookupProperty(depth0,"id") : depth0), depth0))
    + "\"\nclass=\"view-comment link-gray\"\ndata-link-name=\"view_comment\"\ndata-thread-id=\""
    + alias3(alias2(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + "\">\n\n<span class=\"visible-md\">"
    + alias3(lookupProperty(helpers,"gettext").call(alias1,"View",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":26,"column":25},"end":{"line":26,"column":43}}}))
    + "</span><span class=\"hidden-md\">"
    + alias3(lookupProperty(helpers,"gettext").call(alias1,"View in discussion",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":26,"column":74},"end":{"line":26,"column":106}}}))
    + "</span><span class=\"icon-expand\"></span>\n</a>\n";
},"usePartial":true,"useData":true})

});
define('home/utils/features',[
    'modernizr',
], function (
    Modernizr
) {
    'use strict';

    var defines = {
        browser: {
            // Modified from:
            // http://stackoverflow.com/questions/3514784/best-way-to-detect-handheld-device-in-jquery
            // Note: includes tablets
            mobile:
                /iPhone|Android|iPod|iPad|webOS|Mobile Safari|Windows Phone|BlackBerry|Opera Mini|IEMobile/i.test(window.navigator.userAgent),
        },
    };

    var canUseContentEditable = Modernizr.contenteditable &&
        !defines.browser.mobile &&
        !(window.opera && window.opera.version);


    return {
        canUseContentEditable: function () {
            return canUseContentEditable;
        },
    };
});

define('core/templates/alert',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<span class=\"icon icon-"
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"iconType") : depth0), depth0))
    + "\"></span>\n";
},"3":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = container.lambda((depth0 != null ? lookupProperty(depth0,"message") : depth0), depth0)) != null ? stack1 : "")
    + "\n";
},"5":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"message") : depth0), depth0))
    + "\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a class=\"close\" data-action=\"dismiss\" title=\""
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(alias1,"Dismiss",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":1,"column":46},"end":{"line":1,"column":67}}}))
    + "\">×</a>\n<span>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"icon") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":3,"column":0},"end":{"line":5,"column":7}}})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"safe") : depth0),{"name":"if","hash":{},"fn":container.program(3, data, 0),"inverse":container.program(5, data, 0),"data":data,"loc":{"start":{"line":6,"column":0},"end":{"line":10,"column":7}}})) != null ? stack1 : "")
    + "</span>\n";
},"useData":true})

});
define('core/views/AlertView',[
    'backbone',

    'core/templates/alert',
], function (
    Backbone,

    alertTemplate
) {
    'use strict';

    var AlertView = Backbone.View.extend({
        defaultClassName: 'alert',

        events: {
            'click [data-action=dismiss]': 'dismiss',
        },

        // Options:
        //   message {string} - the message to display (required)
        //   safe {boolean} - if true, template doesn't escape message
        //   type {string} - one of: error, info, success, warn
        initialize: function (options) {
            this.options = options;

            this.message = options.message;
            this.safe = options.safe;
            this.type = options.type;
            this.className = options.className || this.defaultClassName;
        },

        render: function () {
            var $el = this.$el;

            $el.html(alertTemplate({
                message: this.message,
                safe: this.safe,
                icon: Boolean(this.type),
                iconType: this.type === 'error' || this.type === 'warn' ? 'warning' : this.type,
            }));

            // reset classes
            $el.attr('class', this.className);

            if (this.type)
                $el.addClass(this.type);

            return this;
        },

        dismiss: function (evt) {
            if (evt && evt.preventDefault)
                evt.preventDefault();

            this.remove();
            this.trigger('dismiss');
        },
    });

    return AlertView;
});

define('core/mixins/withAlert',[
    'underscore',

    'core/views/AlertView',
], function (
    _,

    AlertView
) {
    'use strict';

    /**
     * @typedef {('error'|'info'|'success'|'warn')} AlertStyle
     */

    var mixin = {
        /**
         * Render an alert box in above the current view
         *
         * @param {string} message - the message to display (required)
         * @param {Object} [options] - options
         * @param {boolean} [options.safe] - don't HTML-escape message contents
         * @param {string} [options.target] - a selector for an element to place the alert within
         * @param {AlertStyle} [options.type] - the style of alert to use
         * @returns {AlertView}
         */
        alert: function (message, options) {
            if (!_.isObject(options))
                options = {};

            var alertSelector = options.target || this._alertSelector;

            // Only one alert box at one time
            this.dismissAlert();

            var alert = this._alert = new AlertView(_.extend({
                message: message,
            }, options));

            this.listenToOnce(this._alert, 'dismiss', function () {
                this._alert = null;
            });

            alert.render();

            // If a selector is given, insert the alert at that
            // location. Otherwise insert before the element.
            if (alertSelector) {

                var alertContianerEl = this.$el.find(alertSelector);

                /* TODO: @taylangocmen when you enable and disable comments the open/close state and alert has not
                    been updated and fetched in the BE, do an optimistic rendering for those in that case */

                // Sometimes when alert is called threadView and alertContainerEl is not rendered yet
                // in that case listen to threadView to render then try alert again
                if (alertContianerEl.length)
                    alertContianerEl.prepend(alert.el);
                else
                    this.listenToOnce(this, 'threadView:render', function () { return this.alert(message, options); });

            } else if (this.el.parentNode) {
                this.el.parentNode.insertBefore(alert.el, this.el);
            }

            return alert;
        },

        /**
         * Dismiss any active alert.
         *
         * @param {function(AlertView): *} [filter] -
         *     if provided, the alert will only be dismissed if the function returns truthy
         */
        dismissAlert: function (filter) {
            if (!this._alert)
                return;

            if (filter && !filter(this._alert))
                return;

            this.stopListening(this._alert);
            this._alert.dismiss();
            this._alert = null;
        },

        /**
         * Returns the current alert, if any.
         *
         * @returns {?AlertView}
         */
        getAlert: function () {
            return this._alert || null;
        },

        /**
         * Specify a selector string that designates where the alert should be prepended.
         * e.g. this.setAlertSelector('.someClass');
         *
         * @param {string} selector - The selector string
         */
        setAlertSelector: function (selector) {
            this._alertSelector = selector;
        },
    };

    var withAlert = function () {
        return _.extend(this, mixin);
    };

    return withAlert;
});

define('core/models/Media',[
    'underscore',
    'backbone',

    'core/api',
    'core/UniqueModel',
], function (
    _,
    Backbone,

    api,
    UniqueModel
) {
    'use strict';

    var Media = Backbone.Model.extend({
        idAttribute: 'url',

        defaults: {
            // The server returns these ids, but they are not currently used
            // forum: -1,
            // id: -1,
            // post: -1,
            // thread: -1,

            mediaType: null,

            // HTML
            html: '',
            htmlWidth: null,
            htmlHeight: null,

            // Thumbnail
            thumbnailUrl: '',
            thumbnailWidth: null,
            thumbnailHeight: null,

            url: '',
            urlRedirect: '',
            resolvedUrl: '',
            resolvedUrlRedirect: '',

            // Text fields
            title: '',
            description: '',
            providerName: '',
        },

        parse: function (response) {
            return response.response;
        },

        sync: function (method, _model, options) {
            if (method !== 'read')
                throw new Error('Media models do not support methods other than "read".');

            return api.call('media/details.json', _.extend({
                method: 'POST',
                data: {
                    url: this.get('url'),
                    forum: options.forum,
                },
            }, options));
        },
    }, {
        MEDIA_TYPES: {
            IMAGE: '1',
            IMAGE_UPLOAD: '2',
            YOUTUBE_VIDEO: '3',
            WEBPAGE: '4',
            TWITTER_STATUS: '5',
            FACEBOOK_PAGE: '6',
            FACEBOOK_POST: '7',
            FACEBOOK_PHOTO: '8',
            FACEBOOK_VIDEO: '9',
            SOUNDCLOUD_SOUND: '10',
            GOOGLE_MAP: '11',
            VIMEO_VIDEO: '12',
            // ... GIST ...
            VINE_VIDEO: '14',
            GIF_VIDEO: '15',
        },
        WEBPAGE_TYPES: [
            '4',
            '6',
            '7',
        ],
    });

    UniqueModel.addType('Media', Media);

    return Media;
});

/* global Promise */

define('core/utils/media/upload',[
    'underscore',

    'exports',

    'core/api',
    'core/models/Media',
    'core/UniqueModel',
], function (
    _,

    exports,

    api,
    Media,
    UniqueModel
) {
    'use strict';

    // FormData is required to support uploadMedia
    exports.uploadSupported = Boolean(window.FormData);

    exports._extractFirstImageFile = function (files) {
        return _.find(files, function (file) {
            return file.type.match(/^image\//);
        });
    };

    exports._uploadViaApi = function (url, formData, options) {
        return Promise.resolve(api.call(url, {
            data: formData,
            // contentType: false allows the default header value
            // (multipart/form-data) to be used
            contentType: false,
            // processData: false prevents jQuery from throwing an
            // exception when it attempts to convert the properties
            // to strings
            processData: false,
            method: 'POST',
            // Workaround to listen to upload progress events
            xhr: function () {
                var xhr = new window.XMLHttpRequest();

                var onProgress = options && options.onProgress;
                if (onProgress) {
                    xhr.upload.addEventListener('progress', function (evt) {
                        // Update percentage remaining of upload
                        if (evt.total)
                            onProgress(100 * evt.loaded / evt.total);
                    });
                }

                return xhr;
            },
        }));
    };

    // API url for uploadMediaUrl
    // TODO: Get this url from the manifest
    exports.UPLOAD_URL = 'https://uploads.services.disqus.com/api/3.0/media/create.json';

    /**
     * Upload one image.
     * When given multiple images, will upload just the first.
     *
     * @param {FileList} files -
     *     The list of files; only the first image will be uploaded
     * @param {Object} [options] - Options
     * @param {function(number)} [options.onProgress] -
     *     Callback which will be passed the upload progress
     *     as a percentage (0-100)
     * @returns {Promise.<Media>}
     */
    exports.uploadMediaUrl = function (files, options) {
        var data = new window.FormData();
        var error;

        var imageFile = exports._extractFirstImageFile(files);
        if (!imageFile) {
            error = new Error('No image file to upload');
            error.code = 'invalid-content-type';
            return Promise.reject(error);
        }

        data.append('upload', imageFile);

        // Opt-in to permanent media urls
        data.append('permanent', 1);

        return exports._uploadViaApi(
            exports.UPLOAD_URL,
            data,
            options
        ).then(function (response) {
            var uploads = response.response;
            // Get the first upload
            var media = _.first(_.values(uploads));

            if (!media || !media.ok) {
                error = new Error('Upload failed');
                error.code = media && media['error-code'];
                throw error;
            }

            return new UniqueModel(Media, {
                mediaType: Media.MEDIA_TYPES.IMAGE_UPLOAD,
                url: media.url,
                thumbnailUrl: media.url,
            });
        }, function (jqXHR) {
            if (jqXHR.responseJSON && jqXHR.responseJSON.code === 4) {
                error = new Error('Upload failed');
                error.code = 'not-authenticated';
                throw error;
            }
            throw jqXHR;
        });
    };
});

define('core/views/media/DragDropUploadView',[
    'underscore',
    'backbone',

    'core/utils',
], function (
    _,
    Backbone,

    utils
) {
    'use strict';

    var handler = utils.stopEventHandler;

    // Drag and drop view
    // Expects to be assigned an element, which it will watch
    // for image files being dropped on
    // TODO: Refactor, this should not be a view
    var DragDropUploadView = Backbone.View.extend({
        events: {
            'dragover': '_dragOn',
            'dragenter': '_dragOn',
            'dragleave': '_dragOff',
            'dragexit': '_dragOff',
            'drop': '_drop',
        },

        _dragOn: handler(function () {
            this.trigger('uploader:dragEnter');
            this._toggleDragPlaceholder(true);
        }),

        _dragOff: handler(function () {
            this._toggleDragPlaceholder(false);
        }),

        _drop: handler(function (evt) {
            this._toggleDragPlaceholder(false);

            var files = evt.originalEvent.dataTransfer.files;
            if (!files.length)
                return void this.trigger('uploader:dropError', 'No files');

            this.trigger('uploader:attachMedia', files);
        }),

        _toggleDragPlaceholder: _.throttle(function (show) {
            if (show)
                this.trigger('uploader:showPlaceholder');
            else
                this.trigger('uploader:hidePlaceholder');
        }, 50),
    });

    return DragDropUploadView;
});

define('core/templates/postMediaUploadButton',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\"#\" tabindex=\"-1\" data-action=\"attach\" class=\"attach\" title=\""
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Upload Images",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":1,"column":69},"end":{"line":1,"column":96}}}))
    + "\">\n<div class=\"wysiwyg__attach wysiwyg__attach-dims\"\nrole=\"img\"\naria-label=\"A\"\n/>\n</a>\n<input type=\"file\" data-role=\"media-upload\" tabindex=\"-1\" accept=\"image/*\">\n";
},"useData":true})

});
define('core/views/media/UploadButtonView',[
    'jquery',
    'underscore',
    'backbone',

    'core/templates/postMediaUploadButton',
    'core/utils',
], function (
    $,
    _,
    Backbone,

    uploadButtonTemplate,
    utils
) {
    'use strict';

    var handler = utils.stopEventHandler;

    // TODO: Simplify selector
    var inputSelector = 'input[type=file][data-role=media-upload]';

    // Upload button
    // Uses a hidden input element to open a browse dialog
    var UploadButtonView = Backbone.View.extend({
        events: (function () {
            var events = {
                'click [data-action=attach]': '_attachMedia',
            };
            events['change ' + inputSelector] = '_selectorChange';
            return events;
        }()),

        initialize: function (options) {
            this.template = options && options.template || this.generateImageUploadButton;
        },

        generateImageUploadButton: function () {
            return uploadButtonTemplate({
                imageUrl: 'https://c.disquscdn.com/next/embed/assets/img/attach.03c320b14aa9c071da30c904d0a0827f.svg',
            });
        },

        render: function () {
            this.$el.html(this.template());

            return this;
        },

        _attachMedia: handler(_.throttle(function () {
            this.$(inputSelector).click();
        }, 1000, { trailing: false })),  // throttle modal for uploading image by 1s to prevent multiple popups

        _selectorChange: function (evt) {
            var input = evt.target;
            var files = input.files;

            if (!files.length)
                return;

            this.trigger('uploader:attachMedia', files);

            // Clear file input by replacing with a clone
            $(input).replaceWith(input.cloneNode());
        },
    });

    return UploadButtonView;
});

define('core/templates/postMediaUploadProgress',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<li>\n<div class=\"media-progress-box\">\n<div class=\"media-progress\">\n<div class=\"bar\" style=\"right: "
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"remainingPerc") : depth0), depth0))
    + "%\"></div>\n</div>\n</div>\n</li>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"each").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"collection") : depth0),{"name":"each","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":1,"column":0},"end":{"line":9,"column":9}}})) != null ? stack1 : "");
},"useData":true})

});
define('core/views/media/UploadsProgressSubView',[
    'backbone',

    'core/templates/postMediaUploadProgress',
], function (
    Backbone,

    postMediaUploadProgressTemplate
) {
    'use strict';

    // View to display progress of one or more uploads
    var UploadsProgressSubView = Backbone.View.extend({
        initialize: function () {
            this.collection = new Backbone.Collection();
            this.listenTo(this.collection, 'add remove change', this.render);
        },

        hasVisible: function () {
            return Boolean(this.collection.length);
        },

        render: function () {
            this.$el.html(postMediaUploadProgressTemplate({
                collection: this.collection.toJSON(),
            }));
            return this;
        },
    });

    return UploadsProgressSubView;
});

define('core/templates/postMediaUploadRich',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(container.lambda(((stack1 = (depth0 != null ? lookupProperty(depth0,"media") : depth0)) != null ? lookupProperty(stack1,"title") : stack1), depth0));
},"3":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Media attachment",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":6,"column":81},"end":{"line":6,"column":111}}}));
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<li class=\"publisher-border-color\">\n<div class=\"media-box\">\n<div class=\"media-ct\">\n<div class=\"media-surface\">\n<a href=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"media") : depth0)) != null ? lookupProperty(stack1,"url") : stack1), depth0))
    + "\" target=\"_blank\">\n<img src=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"media") : depth0)) != null ? lookupProperty(stack1,"thumbnailUrl") : stack1), depth0))
    + "\" alt=\""
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = (depth0 != null ? lookupProperty(depth0,"media") : depth0)) != null ? lookupProperty(stack1,"title") : stack1),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"data":data,"loc":{"start":{"line":6,"column":39},"end":{"line":6,"column":118}}})) != null ? stack1 : "")
    + "\">\n</a>\n</div>\n</div>\n</div>\n</li>\n";
},"useData":true})

});
define('core/views/media/UploadsRichSubView',[
    'underscore',
    'backbone',

    'core/models/Media',
    'core/UniqueModel',
    'core/utils',

    'core/templates/postMediaUploadRich',
], function (
    _,
    Backbone,

    Media,
    UniqueModel,
    utils,

    postMediaUploadRichTemplate
) {
    'use strict';

    // View which renders a collection of Media models as thumbnails.
    // Supports synchronizing the model collection with the urls
    // present in text input; see updateFromText
    var UploadsRichSubView = Backbone.View.extend({
        initialize: function () {
            // Track if any thumbnails were rendered.
            // This is used by parent views, via the hasVisible method.
            this._hasVisible = false;

            this.collection = new Backbone.Collection([], {
                model: Media,

                // Keep the collection sorted by the
                // order of the urls in the text
                // (by index of bleachFindUrls result)
                comparator: 'index',
            });

            // Render on every event which could update visible media previews
            this.listenTo(this.collection, 'add remove reset sort ' +
                'change:thumbnailUrl change:mediaType change:editsFinished', this.render);

            // Workaround: Backbone will not sort the collection when
            // the model changes
            // Ref: https://github.com/jashkenas/backbone/issues/2237
            this.listenTo(this.collection, 'change:index',
                _.bind(this.collection.sort, this.collection));
        },

        render: function () {
            this.$el.empty();
            this._hasVisible = false;
            this.collection.each(function (model) {
                // Don't render element if there isn't a thumbnail
                if (!model.get('thumbnailUrl'))
                    return;

                // Don't render element if it's a webpage type
                if (_.contains(Media.WEBPAGE_TYPES, model.get('mediaType')))
                    return;

                // Don't render element if the user is likely to
                // be editing the url
                if (!model.get('editsFinished'))
                    return;

                // Add to DOM
                this.$el.append(postMediaUploadRichTemplate({
                    media: model.toJSON(),
                }));

                // Keep track of there being at least one visible
                // Media model for this view
                this._hasVisible = true;
            }, this);

            return this;
        },

        hasVisible: function () {
            return this._hasVisible;
        },

        addMedia: function (mediaAttrs, options) {
            var media = UniqueModel.get(Media, mediaAttrs.url);
            if (media) {
                // Update existing Media model
                media.set(mediaAttrs);
            } else {
                // Abort if it's possible the user is editing the url
                if (!mediaAttrs.editsFinished)
                    return;

                // Create and fetch Media model
                media = new UniqueModel(Media, mediaAttrs);
                media.fetch(options);
            }

            this.collection.add(media);

            return media;
        },

        updateFromText: function (text, cursorPosition, options) {
            if (!text)
                return void this.collection.reset();

            // Find urls in text
            var matches = utils.bleachFindUrls(text);

            // Remove duplicates, to avoid trigerring sort events
            matches = _.uniq(matches, false, function (match) {
                return match.url;
            });

            // Keep track of which urls we updated, so we can remove the others later
            var urlsUpdated = {};

            // Add models to collection
            _.each(matches, function (match) {
                urlsUpdated[match.url] = true;

                var mediaAttrs = _.pick(match, 'index', 'url');

                // Check if cursor is within url
                var beingEdited = (match.index < cursorPosition &&
                                   cursorPosition <= match.endIndex) ||
                    text[match.endIndex] === '.';

                // Permit the model to be rendered if the cursor is
                // at any time not in the url, or there is a paste
                // event.
                if (!beingEdited || options.isPasteEvent)
                    mediaAttrs.editsFinished = true;

                this.addMedia(mediaAttrs, options);
            }, this);

            // Remove urls which are no longer present.
            // Algorithm is not efficient, but is capped by the number of urls the user enters.
            var currentUrls = this.collection.pluck('url');
            urlsUpdated = _.keys(urlsUpdated);
            var removeUrls = _.difference(currentUrls, urlsUpdated);
            this.collection.remove(this.collection.filter(function (model) {
                return _.contains(removeUrls, model.get('url'));
            }));
        },
    });

    return UploadsRichSubView;
});

define('core/templates/postMediaUploads',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<ul data-role=\"media-progress-list\"></ul>\n<ul data-role=\"media-rich-list\"></ul>\n<div class=\"media-expanded empty\" data-role=\"media-preview-expanded\">\n<img src=\"data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\"\ndata-role=\"media-preview-expanded-image\" alt=\""
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Media preview placeholder",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":6,"column":46},"end":{"line":6,"column":85}}}))
    + "\">\n</div>\n";
},"useData":true})

});
define('core/views/media/UploadsView',[
    'backbone',

    'core/views/media/UploadsProgressSubView',
    'core/views/media/UploadsRichSubView',

    'core/templates/postMediaUploads',
], function (
    Backbone,

    UploadsProgressSubView,
    UploadsRichSubView,

    postMediaUploadsTemplate
) {
    'use strict';

    // UploadsView acts as a container for the legacy and rich subviews.
    var UploadsView = Backbone.View.extend({
        initialize: function () {
            // Initialize subviews
            this.richView = new UploadsRichSubView();
            this.rich = this.richView.collection;

            this.uploadProgressView = new UploadsProgressSubView();
            this.uploadProgress = this.uploadProgressView.collection;

            // Watch models to expand / collapse textarea
            this.listenTo(this.rich, 'all', this._updateEmpty);
            this.listenTo(this.uploadProgress, 'all', this._updateEmpty);
        },

        render: function () {
            // Must detach subview before this.$el.html() or else
            // jQuery will undelegate all events on subview
            this.richView.$el.detach();
            this.uploadProgressView.$el.detach();

            this.$el.html(postMediaUploadsTemplate());

            this._updateEmpty();

            // Re-attach subview elements
            this.richView.setElement(this.$('[data-role=media-rich-list]')[0]);
            this.uploadProgressView.setElement(this.$('[data-role=media-progress-list]')[0]);

            return this;
        },

        clear: function () {
            this.rich.reset();
            this.uploadProgress.reset();
        },

        _updateEmpty: function () {
            if (!this.richView.hasVisible() && !this.uploadProgressView.hasVisible())
                this.$el.addClass('empty');
            else
                this.$el.removeClass('empty');
        },
    });

    return UploadsView;
});

define('core/mixins/withUploadForm',[
    'underscore',
    'backbone',

    'core/strings',
    'core/utils',
    'core/utils/media/upload',
    'core/utils/storage',
    'core/views/media/DragDropUploadView',
    'core/views/media/UploadButtonView',
    'core/views/media/UploadsView',
], function (
    _,
    Backbone,

    strings,
    utils,
    upload,
    storage,
    DragDropUploadView,
    UploadButtonView,
    UploadsView
) {
    'use strict';

    var gettext = strings.get;

    var exports = function withUploadForm() {
        _.defaults(this, exports.bothProto, exports.uploadsProto, exports.previewsProto);
    };


    var ERROR_MESSAGES = {
        'invalid-image-file': gettext(
            'Unfortunately your image upload failed. Please verify ' +
            'that the file is valid and in a supported format (JPEG, PNG, or GIF).'
        ),
        'invalid-content-type': gettext(
            'Unfortunately your image upload failed. Please verify ' +
            'that the file is in a supported format (JPEG, PNG, or GIF).'
        ),
        'file-too-large': gettext(
            'Unfortunately your image upload failed. Please verify ' +
            'that your image is under 5MB.'
        ),
        'not-authenticated': gettext(
            'You must be logged in to upload an image.'
        ),
    };
    var DEFAULT_ERROR_MESSAGE = gettext(
        'Unfortunately your image upload failed. Please verify ' +
        'that your image is in a supported format (JPEG, PNG, or GIF) and ' +
        'under 5MB. If you continue seeing this error, please try again later.'
    );


    // Mixin for methods to preview uploaded media, as well as
    // rich media resulting from a textarea
    exports.previewsProto = {
        initMediaPreviews: function ($el, textarea) {
            // Set up media preview instance
            this.mediaUploadsView = new UploadsView({
                el: $el[0],
            });

            this.mediaUploadsView.render();

            // Update rich media when textarea updates
            this.updateLiveMediaDebounced = _.partial(
                _.debounce(this.updateLiveMedia, 500),
                textarea,
                false  // Not a paste event
            );
            this.stopListening(textarea, 'keychange');
            this.stopListening(textarea, 'paste');
            this.listenTo(textarea, {
                keychange: this.updateLiveMediaDebounced,

                paste: function (_evt, options) {
                    if (options && options.fake)
                        return;

                    // We defer the processing since the actual text change
                    // occurs slightly after the paste event
                    _.defer(_.bind(this.updateLiveMedia, this, textarea, true));
                },
            });

            // Also update immediately to display previews for restored drafts
            // (draft restoration is handled in TextareaView.prototype.initialize)
            this.updateLiveMedia(textarea, true);
        },

        clearMediaPreviews: function () {
            if (this.mediaUploadsView)
                this.mediaUploadsView.clear();
        },

        // Called when textarea updates
        // Will update rich media collection based on urls in the textarea
        updateLiveMedia: function (textarea, isPasteEvent) {
            if (!this.mediaUploadsView)
                return;

            var text = textarea.get();
            var cursorPosition = textarea.offset();

            this.mediaUploadsView.richView.updateFromText(
                text,
                cursorPosition,
                { isPasteEvent: isPasteEvent, forum: this.thread.forum.id }
            );
        },
    };

    // Mixin for methods to upload media, via drag-and-drop
    // and an upload button.
    // Depends on: above previewsProto, as well as withAlert.
    exports.uploadsProto = {
        initMediaUploads: function ($dragDropPlaceholder, $dragDropEl, $buttonEl) {
            // Set up drag-and-drop events
            // Note that DragDropUploadView only provides events;
            // it has nothing to render.
            if (this.mediaDragDropView)
                this.stopListening(this.mediaDragDropView);

            this.mediaDragDropView = new DragDropUploadView({
                el: $dragDropEl[0],
            });
            this.listenTo(this.mediaDragDropView, {
                'uploader:attachMedia': function () {
                    // Avoid notifying user in the future about drag-drop support
                    storage.set('usedDragDrop', 1);

                    // Upload media and update UI
                    this.handleAttachMedia.apply(this, arguments);
                },
                // Expand post area when user drags media over it
                // Cannot bind $el.addClass since $el may change
                'uploader:dragEnter': function () {
                    // TODO: Refactor out of mixin?
                    this.$el.addClass('expanded');
                },
                'uploader:showPlaceholder': function () {
                    $dragDropPlaceholder.show();
                },
                'uploader:hidePlaceholder': function () {
                    $dragDropPlaceholder.hide();
                },
                'uploader:dropError': function () {
                    var errorMessage = gettext(
                        'Sorry we didn\'t catch that. Try again?');
                    this.alert(errorMessage, { type: 'error', isUploadError: true });
                },
            });

            // Set up attach media button events
            if (this.mediaUploadButtonView)
                this.stopListening(this.mediaUploadButtonView);

            this.mediaUploadButtonView = new UploadButtonView({
                el: $buttonEl[0],
            });
            this.listenTo(this.mediaUploadButtonView, {
                'uploader:attachMedia': this.handleUploadViaButton,
            });
            this.mediaUploadButtonView.render();
        },

        handleUploadViaButton: function (files) {
            // Notify user about drag-drop support
            if (files && storage.isPersistent && !storage.get('usedDragDrop') &&
                // Don't show on mobile because ... who actually uses drag and drop on mobile?
                !utils.isMobileUserAgent()) {
                var alertView = this.alert(gettext(
                    'Did you know you can drag and drop images too? Try it now!'));
                this.listenToOnce(alertView, 'dismiss', function () {
                    storage.set('usedDragDrop', 1);
                });
            }

            // Upload media and update UI
            this.handleAttachMedia.apply(this, arguments);
        },

        // Called when the user starts a file upload
        // Will display a progress bar during upload, then update the
        // UI to reflect the upload result
        handleAttachMedia: function (files, options) {
            var self = this;

            var progressModel = new Backbone.Model({
                remainingPerc: 100,
            });
            self.mediaUploadsView.uploadProgress.add(progressModel);

            options = _.extend(options || {}, {
                onProgress: function (percent) {
                    progressModel.set('remainingPerc', 100 - percent);
                },
            });

            var removeProgress = function () {
                self.mediaUploadsView.uploadProgress.remove(progressModel);
            };

            upload.uploadMediaUrl(files, options).then(function (media) {
                // Fetch model to force rich media system to retrieve it immediately.
                // Should help resolve issues where rich media is not available when
                // the post or thread is created.
                media.fetch({ forum: self.thread.forum.id });

                // Update text with url
                self.textarea.insertAtCursor(media.get('url'));

                // Update previews
                self.updateLiveMedia(self.textarea, true);

                self.dismissUploadError();
            }).catch(function (error) {
                var errorMessage;

                if (error && error.code)
                    errorMessage = ERROR_MESSAGES[error.code];

                if (!errorMessage)
                    errorMessage = DEFAULT_ERROR_MESSAGE;

                self.alert(errorMessage, { type: 'error', isUploadError: true });
            }).then(removeProgress, removeProgress);
        },

        dismissUploadError: function () {
            this.dismissAlert(function (alert) {
                return alert.options && alert.options.isUploadError;
            });
        },

        uploadSupported: upload.uploadSupported,

        isUploadInProgress: function () {
            return this.mediaUploadsView &&
                this.mediaUploadsView.uploadProgress.length;
        },
    };

    exports.bothProto = {
        // Initialize media previews and uploads based on options
        // Options:
        //   mediaembedEnabled -- Enables rich media url parsing and previews
        //   allowUploads -- Enables upload UI (drag-drop, button).
        //                   mediaembedEnabled MUST be true if this is.
        //   textarea -- The textarea to look for rich media urls in.
        //               Must be provided if mediaembedEnabled is true.
        //   storageKey -- The key to use for storing uploads as drafts
        // Expects several elements, part of the PostReplyView template, to exist
        initMediaViews: function (options) {
            if (options.mediaembedEnabled || options.gifPickerEnabled) {
                this.initMediaPreviews(
                    this.$('[data-role=media-preview]'),
                    options.textarea
                );
            }

            if (options.allowUploads) {
                this.initMediaUploads(
                    this.$('[data-role=drag-drop-placeholder]'),
                    this.$('[data-role=textarea]'),
                    this.$('[data-role=media-uploader]')
                );
            }
        },
    };

    return exports;
});

/* eslint-disable valid-jsdoc */
/**
 * editable.js - a xbrowser library for contentEditable
 *
 * https://github.com/benvinegar/editable.js
 *
 * MIT License
 */
define('core/editable',[],function () {
    'use strict';

    var document = window.document;
    var character = 'character';
    var nbspRe = new RegExp(String.fromCharCode(160), 'gi');
    var blockElemList = 'h1 h2 h3 h4 h5 h6 p pre blockquote address ul ol dir menu li dl div form'.split(' ');
    var blockElems = {};
    var i = 0;

    // build a list of block level elements
    for (i = 0; i < blockElemList.length; i++)
        blockElems[blockElemList[i]] = true;

    function normalizeSpace(str) {
        return str.replace(nbspRe, ' ');
    }

    /**
     * Helper function to recursively aggregate all text from a set
     * of HTML nodes
     */
    function getTextHelper(nodes, nodeCallback, blockJoin) {
        var text = '';
        var blocks = [];
        var name, node, tmp, i;

        if (typeof blockJoin !== 'string')
            blockJoin = '\n\n';

        for (i = 0; i < nodes.length; ++i) {
            node = nodes[i];
            name = node.nodeName.toLowerCase();

            if (node.nodeType === 1) { // html node
                tmp = nodeCallback && nodeCallback(node);

                if (tmp) {
                    text += tmp;
                } else if (blockElems.hasOwnProperty(name)) {
                    // Inside a block-level element, ignore any subsequent block-level
                    // elements (i.e. nested divs or paragraphs)
                    if (text)
                        blocks.push(text);
                    text = getTextHelper(node.childNodes, nodeCallback, blockJoin);
                } else if (name === 'br') {
                    // Always convert breaking tags to newlines
                    text += '\n';
                } else {
                    // Some other (inline) element; recur inside to extract text
                    text += getTextHelper(node.childNodes, nodeCallback, blockJoin);
                }
            }
            else if (node.nodeType === 3) { // text node
                text += normalizeSpace(node.nodeValue);
            }
        }
        // Block elements should get two new lines normally
        blocks.push(text);
        return blocks.join(blockJoin);
    }

    var Editable = function (elem, emulate, overrides) {
        var self = this;

        if (!elem || !elem.contentEditable)
            throw new Error('First argument must be contentEditable');

        this.elem = elem;
        this.emulateTextarea = elem.getAttribute('plaintext-only') || emulate;

        if (this.emulateTextarea) {
            this.pasteHandler = function (evt) {
                var pasted = evt && evt.clipboardData || window.clipboardData;
                // check that the pasted content is text
                // TODO: Support directly pasted images
                if (pasted && !pasted.getData('text')) {
                    evt.preventDefault();
                    evt.stopPropagation();
                }
                var func = self.plainTextReformat;
                var later = function () {
                    func.timeout = null;
                    func.call(self);
                };
                if (func.timeout)
                    clearTimeout(func.timeout);
                func.timeout = setTimeout(later, 0);
            };

            elem.addEventListener('paste', this.pasteHandler);
        }
        for (var prop in overrides) {
            if (overrides.hasOwnProperty(prop))
                this[prop] = overrides[prop];
        }
    };

    Editable.prototype = {

        /**
         * helper function for inserting random html
         */
        insertHTML: function (html) {
            if (document.all) {
                var range = document.selection.createRange();
                range.pasteHTML(html);
                range.collapse(false);
                return range.select();
            }

            return document.execCommand('insertHTML', false, html);
        },

        insertNode: function (node) {
            var selection, range, html;
            if (window.getSelection) {
                selection = window.getSelection();
                if (selection.getRangeAt && selection.rangeCount) {
                    range = selection.getRangeAt(0);
                    range.deleteContents();
                    range.insertNode(node);
                    range.collapse(false);
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
            } else if (document.selection && document.selection.createRange) {
                range = document.selection.createRange();
                html = node.nodeType === 3 ? node.data : node.outerHTML;
                range.pasteHTML(html);
                range.collapse(false);
            }
        },

        /**
         * Grab all text nodes relative to their parents
         */
        // TODO make this function private and have the public version
        // only return textNodes for the wrapped textArea
        getTextNodes: function (nodeList) {
            var elem = this.elem;

            // special case a single node by massaging into a list of nodes
            if (nodeList && nodeList.nodeType)
                nodeList = [nodeList];
            // if nothing is passed in, get text nodes for elem
            else if (!nodeList)
                nodeList = elem.childNodes;

            var textNodes = [];

            for (var i = 0, node; i < nodeList.length; ++i) {
                node = nodeList[i];

                if (!node)
                    continue; // HACK to avoid erroring on whitespace nodes

                switch (node.nodeType) {
                case 1:
                    textNodes = textNodes.concat(this.getTextNodes(node.childNodes));
                    break;
                case 3:
                    // HACK don't count garbage FF nodes
                    if (!/^\n\s+/.test(node.nodeValue))
                        textNodes.push(node);
                    break;
                }
            }
            return textNodes;
        },

        /**
         * Get unformatted text
         */
        text: function (nodeCallback) {
            var elem = this.elem;
            var out, nodes, i;

            // massage the NodeList into an Array of HTMLElements
            try {
                nodes = Array.prototype.slice.call(elem.childNodes);
            } catch (err) {
                nodes = [];
                for (i = 0; i < elem.childNodes.length; ++i)
                    nodes.push(elem.childNodes[i]);
            }
            out = getTextHelper(nodes, nodeCallback, this.emulateTextarea && '\n');
            return out.replace(/^\s+|\s+$/g, ''); // trim the text
        },

        setText: function (str) {
            str = str || '';  // ensure we have a string
            var el = document.createDocumentFragment();
            // 2 consequent line breaks -> we have a paragraph unless we emulate
            var paragraphs = [str]; // we fix the input in TextareaView's fixInputStructure now

            var lenP = paragraphs && paragraphs.length;
            var i, par, paragraph;

            for (i = 0; i < lenP; i++) {
                par = paragraphs[i];
                // parse string and convert it into dom tree wrapped in paragraph
                paragraph = this.createParagraph(par);
                // add paragraph to dom
                el.appendChild(paragraph);
            }
            // We'll keep only the last paragraphs excess <br> since it is
            // necessary for editing.
            el.lastChild.appendChild(document.createElement('br'));

            this.elem.innerHTML = '';  // clear first
            this.elem.appendChild(el);

            // Fix Chrome bug where cursor is sometimes placed before the first element.
            // Selection.modify() causes the page to scroll to the bottom in Firefox
            // and isn't supported in IE.
            if ('WebkitAppearance' in document.documentElement.style && window.navigator.userAgent.indexOf('Firefox') === -1 && window.navigator.userAgent.indexOf('MSIE') === -1) {
                // NOTE: These methods of browser-detection are not future-proof and
                // Selection.modify() is considered a non-standard feature, so we
                // might want to find an alternative solution.
                // https://developer.mozilla.org/en-US/docs/Web/API/Selection/modify
                var sel = window.getSelection && window.getSelection();
                if (sel && sel.anchorNode === this.elem && sel.modify)
                    sel.modify('move', 'forward', 'line');
            }
        },

        createParagraph: function (text) {
            var paragraph = document.createElement('p');
            var i, j, lines, line, lenL, lenC, children;

            // line break inside "paragraph" -> Text + <br>
            lines = text.split(/\r\n|\r|\n/);
            for (j = 0, lenL = lines.length; j < lenL; j++) {
                line = lines[j];
                // Note the line below escapes HTML tags!
                // i.e. <b>Yo</b> becomes &lt;b&gt;Yo&lt;/b&gt;
                children = this.getHtmlElements(line);
                for (i = 0, lenC = children.length; i < lenC; i++)
                    paragraph.appendChild(children[i]);

                paragraph.appendChild(document.createElement('br'));
            }

            // If we do have a last child in the paragraph, it is a line
            // break which we don't want. "ali".split("\n") would give you
            // ["ali"] where we add a <br> at the end of EVERY item.
            if (paragraph.lastChild)
                paragraph.removeChild(paragraph.lastChild);

            return paragraph;
        },

        // Accepts a string and return an array of HTMLElements created from the string
        getHtmlElements: function (line) {
            return [document.createTextNode(line)];
        },

        plainTextReformat: function () {
            if (this.elem.getElementsByTagName('p').length <= 1)
                return;

            this.emulateTextarea = false;
            var rawText = this.text();
            this.emulateTextarea = true;
            this.setText(rawText);
        },

        removeNode: function (node) {
            var prev, sel, range;

            // Webkit/FF
            if (window.getSelection) {
                // HACK in webkit, deleting the node that contains the current
                // range means that there are no more ranges in the Selection
                // object. This means that we have to programatically set the
                // range on the node previous to the mention in order to still
                // maintain document focus
                prev = node.previousSibling;
                node.parentNode.removeChild(node);
                sel = window.getSelection();
                range = document.createRange();
                if (prev) {
                    range.setStart(prev, prev.length);
                    range.setEnd(prev, prev.length);
                }
                sel.addRange(range);
            }
            // IE
            else {
                // TODO port this over to using the selection
                // code, it's complicated so maybe not the best
                // idea to do right now
                node.parentNode.removeChild(node);
            }
        },
        /**
         * Get currently selected text node in
         * the contentEditable element.
         */
        selectedTextNode: function () {
            var elem = this.elem;
            var sel, range, node, textNode, textNodes, prevNode, snippet, i, j;

            // Webkit/Firefox
            if (window.getSelection) {
                sel = window.getSelection();
                return sel.anchorNode;
            }
            // Internet Explorer
            else if (document.selection.createRange) {
                // I wish that you never have to touch this code. You're probably sitting here
                // looking at this function saying "wtf" to yourself becuase it's so hiddeous.
                // If Internet Explorer 9 every becomes the lowest rung on the Microsoft browser family,
                // simple delete this conditional and never look back. If you have the misfortune of
                // modifying the following snippet, I wish you the best of luck in your endeavor.
                range = document.selection.createRange().duplicate();

                // Microsoft thinks about the entire contentEditable container like a single
                // line of text. Because of this, you won't be able to get the anchorNode of
                // the current selection. What we're doing here is simply moving the caret to
                // the front of the entire block of text.
                while (range.moveStart(character, -1000) === -1000)
                    continue;

                var text = range.text;
                // The trick is that we know where the end of our caret is
                // so all we have to do is loop over all text nodes and find
                // out where the two strings differ. Notice how we are truncating
                // the copied string for each iteration of the inner loop. This
                // is done so that when the two strings differ, we can simply
                // compare the remaining piece of the copied string with the
                // current node, this saves us an extra couple of loops.
                for (i = 0; i < elem.childNodes.length; ++i) {

                    node = elem.childNodes[i];
                    textNodes = this.getTextNodes(node);

                    for (j = 0; j < textNodes.length; ++j) {
                        textNode = textNodes[j];
                        snippet = normalizeSpace(textNode.nodeValue);

                        if (text.indexOf(snippet) > -1) {
                            prevNode = textNode;
                            text = text.replace(snippet, '');
                        }
                        // special case where textNode content is longer
                        // than the selected portion of the textNode
                        else if (snippet.indexOf(text) > -1) {
                            return textNode;
                        }
                    }
                }
                return prevNode;
            }
        },

        /**
         * Get relative offset in the currently active text node
         */
        selectedTextNodeOffset: function (node) {
            var range, offset, newOffset;

            // Webkit/Firefox
            if (window.getSelection) {
                var sel = window.getSelection();
                // wondering if this should really
                // be the focus offset, does it even
                // really matter? probably not me thinks
                if (sel && sel.anchorOffset)
                    newOffset = sel.anchorOffset;
            }

            // Internet Explorer
            else if (node && document.selection.createRange) {
                var textNodeText = normalizeSpace(node.nodeValue);

                range = document.selection.createRange();
                var r2 = range.duplicate();
                var prevParent = r2.parentElement();

                // move backwards over the range and compare the selected text
                // node text with the range. break if either we've found a match
                // or the previous range we create each iteration has a different
                // parent element
                for (offset = 0; range.moveStart(character, -1) !== 0; offset++) {
                    if (
                        textNodeText.indexOf(normalizeSpace(range.text)) === 0 ||
                        prevParent !== range.parentElement()
                    ) break;

                    r2 = range.duplicate();
                    prevParent = r2.parentElement();
                }
                newOffset = offset;
            }


            return isNaN(newOffset) ? 0 : newOffset;
        },

        /**
         * Get cursor offset relative to results returned by .text().
         */
        offset: function () {
            var sel = window.getSelection();
            if (!(sel && sel.anchorNode && sel.anchorNode.nodeType === 3))  // This method only supports text nodes
                return 0;

            var elem = this.elem;
            var nodes;

            // massage the NodeList into an Array of HTMLElements
            try {
                nodes = Array.prototype.slice.call(elem.childNodes);
            } catch (error) {
                nodes = [];
                for (var i = 0; i < elem.childNodes.length; ++i)
                    nodes.push(elem.childNodes[i]);
            }

            function getTextAroundCursor(nodes, blockJoin) {
                if (typeof blockJoin !== 'string')
                    blockJoin = '\n\n';

                var sections = [];
                var text = '';

                function extendBySections(nextSections) {
                    text += nextSections[0];
                    for (var i = 1; i < nextSections.length; ++i) {
                        sections.push(text);
                        text = nextSections[i];
                    }
                }

                for (var i = 0; i < nodes.length; ++i) {
                    var node = nodes[i];
                    var name = node.nodeName.toLowerCase();

                    if (node.nodeType === 1) { // html node
                        if (blockElems.hasOwnProperty(name)) {
                            if (text)
                                text += blockJoin;
                            extendBySections(getTextAroundCursor(node.childNodes, blockJoin));
                        } else if (name === 'br') {
                            text += '\n';
                        } else {
                            extendBySections(getTextAroundCursor(node.childNodes, blockJoin));
                        }
                    } else if (node.nodeType === 3) { // text node
                        if (node === sel.anchorNode) {
                            text += normalizeSpace(node.nodeValue.slice(0, sel.anchorOffset));
                            sections.push(text);
                            text = normalizeSpace(node.nodeValue.slice(sel.anchorOffset));
                        } else {
                            text += normalizeSpace(node.nodeValue);
                        }
                    }
                }

                // Block elements should get two new lines normally
                sections.push(text);
                return sections;
            }

            var sections = getTextAroundCursor(nodes, this.emulateTextarea && '\n');
            if (sections.length === 1)  // Cursor was not found
                return 0;

            var offset = sections[0].length;
            var out = sections.join('');

            // Correct for trailing whitespace
            var trailingSpaces = out.match(/\s+$/);
            if (trailingSpaces) {
                var trailingSpaceCount = trailingSpaces[0].length;
                offset = Math.min(offset, out.length - trailingSpaceCount);
            }

            // Correct for leading whitespace
            var leadingSpaces = out.match(/^\s+/);
            if (leadingSpaces) {
                var leadingSpaceCount = leadingSpaces[0].length;
                offset -= leadingSpaceCount;
            }

            return offset;
        },

        /**
         * Select some text in the contentEditable div
         */
        selectNodeText: function (node, start, end) {
            var elem = this.elem;
            var sel, range;

            // Webkit/Firefox
            if (window.getSelection) {
                // clear all ranges
                sel = window.getSelection();
                sel.removeAllRanges();
                // select the new one
                range = document.createRange();
                range.setStart(node, start);
                range.setEnd(node, end);
                sel.addRange(range);
                return sel;
            }

            // Internet Explorer
            else if (document.selection.createRange) {
                range = document.selection.createRange();

                // KLUDGE
                // if there is a substring match before we hit the start of the text node
                // then this code will break. Might want to think about a more robust way
                // about doing this.
                var text = normalizeSpace(node.nodeValue);

                // MASSIVE HACK for ie < 9, clicks change the focus, so we need to
                // focus back on the contentEditable div and refind out
                // start position. The rest of the function can continue as
                // normal afterwards.
                if (range.parentElement().nodeName.toLowerCase() === 'body') {
                    elem.focus();
                    range = document.selection.createRange();
                    // expand over the entire extArea
                    while (range.moveStart(character, -1000) === -1000)
                        continue;
                    while (range.moveEnd(character, 1000) === 1000)
                        continue;
                    var rangeText = normalizeSpace(range.text);
                    var index = rangeText.indexOf(text);
                    if (index > 0)
                        range.moveStart(character, index + 2); // put us inside the range
                    range.collapse();
                }

                // move start cursor to start of text node
                while (range.moveStart(character, -1) === -1 && text.indexOf(normalizeSpace(range.text)) !== 0)
                    continue;

                // move end cursor to end of text node
                while (range.moveEnd(character, 1) === 1 && text !== normalizeSpace(range.text))
                    continue;

                // move the start and end indicies of the Range and select
                range.moveStart(character, start);
                range.moveEnd(character, -1 * (end - start - range.text.length));
                range.select();

                return range;
            }
        },
    };

    Editable.normalizeSpace = normalizeSpace;

    // assign to the current window
    return Editable;
});


define('core/utils/html/nodeTypes',[],function () {
    'use strict';

    var isP = function (node) {
        return node.nodeName.toLowerCase() === 'p';
    };

    var isDiv = function (node) {
        return node.nodeName.toLowerCase() === 'div';
    };

    var isText = function (node) {
        return node.nodeName.toLowerCase() === '#text';
    };

    var isBr = function (node) {
        return node.nodeName.toLowerCase() === 'br';
    };

    var isButton = function (node) {
        return node.nodeName.toLowerCase() === 'button';
    };

    var isNewline = function (node) {
        return node.nodeName.toLowerCase() === 'br' || (node.nodeName.toLowerCase() === '#text' && node.nodeValue === '\n');
    };

    var isPorDiv = function (node) {
        return node.nodeName.toLowerCase() === 'p' || node.nodeName.toLowerCase() === 'div';
    };

    return {
        isP: isP,
        isDiv: isDiv,
        isText: isText,
        isBr: isBr,
        isButton: isButton,
        isNewline: isNewline,
        isPorDiv: isPorDiv,
    };
});

define('core/CappedStorage',[
    'core/utils/storage',
], function (
    storage
) {
    'use strict';

    /**
     * Like local storage but caps the number of items you can put into it.
     * Once you hit the cap, the first item that was stored is removed
     * in order to make room for the new item.
     *
     * @param {number} max      the maximum number of items in the store
     * @param {string} queueKey key to be used by the underlying storage for this object
     */
    var CappedStorage = function (max, queueKey) {
        this.max = max || 10;
        this.queueKey = queueKey || '__queue';

        if (!this.getQueue())
            this.setQueue([]);
    };

    CappedStorage.prototype.set = function (key, value) {
        var queue = this.getQueue() || this.setQueue([]);

        if (queue.length === this.max)
            storage.remove(queue.shift());

        storage.set(key, value);

        queue.push(key);
        this.setQueue(queue);
    };

    CappedStorage.prototype.get = function (key) {
        return storage.get(key);
    };

    CappedStorage.prototype.remove = function (key) {
        storage.remove(key);
        var queue = this.getQueue() || [];

        for (var i = 0; i < queue.length; i++) {
            if (queue[i] === key) {
                queue.splice(i, 1);
                break;
            }
        }
        this.setQueue(queue);
    };

    CappedStorage.prototype.clear = function () {
        storage.clear();
        this.setQueue([]);
    };

    CappedStorage.prototype.getQueue = function () {
        return storage.get(this.queueKey);
    };

    CappedStorage.prototype.setQueue = function (queue) {
        storage.set(this.queueKey, queue);
        return queue;
    };

    return CappedStorage;
});

/* Autoresize plugin that works with both jQuery and Ender */

define('core/extensions/jquery.autoresize',[
    'jquery',
    'underscore',
], function (
    $,
    _
) {
    'use strict';

    $.fn.autoresize = function (options) {

        // Just some abstracted details,
        // to make plugin users happy:
        var settings = _.extend({
            extraSpace: 0,
            maxHeight: 1000,
        }, options);

        // Only textarea's auto-resize:
        return this.each(function () {

            // Get rid of scrollbars and disable WebKit resizing:
            var textarea = $(this).css({ resize: 'none', 'overflow': 'hidden' });

            var method = String(textarea[0].contentEditable) === 'true' ?
                'html' : 'val';
            var newline = method === 'html' ? '<br>' : '\n';

            var origHeight = textarea.height();

            // Need clone of textarea, hidden off screen:
            var clone = (function () {
                // Create object of styles to apply:
                var props = {};
                _.each(props, function (__, prop) {
                    props[prop] = textarea.css(prop);
                });

                // Clone the actual textarea removing unique properties
                // and insert before original textarea:
                var cloned = $(textarea[0].cloneNode(true));

                cloned
                    .removeAttr('id')
                    .removeAttr('name')
                    .css({
                        visibility: 'hidden',
                        position: 'absolute',
                        top: '-9999px',
                        left: '-9999px',
                        contentEditable: false, // ignored if unsupported
                    })
                    .css(props)
                    .attr('tabIndex', '-1');

                cloned.insertAfter(textarea[0]);
                return cloned;
            })();

            var lastScrollTop = null;
            var updateSize = function () {
                // Prepare the clone:
                // don't know that we have to reset the height here...
                clone[0].style.height = 0;

                clone[method](textarea[method]() + newline);
                clone.scrollTop(clone[0].scrollHeight);

                // Find the height of text:
                var scrollTop = Math.max(clone[0].scrollHeight, origHeight) +
                    parseInt(settings.extraSpace, 10);


                if (settings.maxHeight) {
                    if (scrollTop >= settings.maxHeight) {
                        textarea.css('overflow', ''); // Scrollbars retrn
                        scrollTop = settings.maxHeight;
                    } else {
                        textarea.css('overflow', 'hidden'); // Remove scrollbars
                    }
                }

                // Don't do anything if scrollTip hasen't changed:
                if (lastScrollTop === scrollTop)
                    return;

                lastScrollTop = scrollTop;

                textarea.height(scrollTop);

                if (textarea.trigger)
                    textarea.trigger('resize');
            };

            var throttledUpdateSize = _.throttle(updateSize, 500);

            var handleKeyUp = function (evt) {
                // If the keypress is the enter/return key, always
                // update size. If it's a regular keypress (i.e. user
                // typing normally), then throttle.
                if (evt.keyCode === 13) // enter/return
                    updateSize();
                else
                    throttledUpdateSize();
            };

            // Bind namespaced handlers to appropriate events:
            textarea
                .bind('keyup', handleKeyUp)
                .bind('paste', updateSize)
                // potentially could have overflow default to hidden, and flip on instead
                .css('overflow', 'hidden');

            updateSize();
        });
    };

    return $;
});


define('core/views/TextareaView',[  // eslint-disable-line requirejs/amd-function-arity
    'underscore',
    'jquery',
    'backbone',

    'core/utils',
    'core/utils/html/nodeTypes',
    'core/CappedStorage',

    // imported for side effects
    'core/extensions/jquery.autoresize',
], function (
    _,
    $,
    Backbone,

    utils,
    nodeTypes,
    CappedStorage
) {
    'use strict';

    var TextareaView = Backbone.View.extend({
        events: {
            'keydown  [data-role=editable]': 'handleKeyDown',
            'keyup    [data-role=editable]': 'handleKeyUp',
            'paste    [data-role=editable]': 'handlePaste',
            'focusin  [data-role=editable]': 'handleFocusIn',
            'blur     [data-role=editable]': 'handleBlur',
        },

        initialize: function (options) {
            options = options || {};
            this.storageKey = options.storageKey;
            this.value = options.value || this.getDraft()[0];
            this.history = [this.value];
            this.historyPosition = 0;
            this.placeholder = options.placeholder;
            this.selectionIndices = {
                start: 0,
                end: 0,
                endElemInd: 0,
                endElemSelectionInd: 0,
                startElemInd: 0,
                startElemSelectionInd: 0,
            };
            this.inputFixed = false;

            this.listenTo(this, 'keychange', _.debounce(this.saveDraft, this.constructor.SAVE_DRAFT_INTERVAL));
        },

        render: function () {
            this.$input = this.createInput();
            this.set(this.value);
            this.$el.append(this.$input);

            // Note: this plugin must be applied after the element
            // is on the DOM
            this.$input.autoresize({ maxHeight: this.constructor.MAX_TEXTAREA_HEIGHT });

            return this;
        },

        createInput: function () {
            return $('<textarea>').attr({
                'class': 'textarea',
                'placeholder': this.placeholder,
                'data-role': 'editable',
            });
        },

        resize: function () {
            // Just need to trigger 'paste' on textarea in order
            // to invoke autoresize plugin
            // -- NOTE: We don't use 'change' because contentEditable doesn't
            //          support the 'change' event in IE, and it throws an error
            this.$input.trigger('paste', { fake: true });
        },

        get: function () {
            return this.$input.val().replace(/^\s+|\s+$/g, ''); // trim the text;
        },

        getSelected: function () {
            var inputEl = this.$input[0];
            if (typeof inputEl.selectionStart === 'number')
                return this.$input.val().substring(inputEl.selectionStart, inputEl.selectionEnd);

            return '';
        },

        /**
         * Returns index of cursor in text returned by .get.
         *
         * Ex. If the text box contains
         *     The[cursor] quick brown fox jumps over...
         * Then .offset() will return 3.
         *
         * @returns {number} index of cursor in text
         */
        offset: function () {
            var inputEl = this.$input[0];
            var out = this.$input.val();
            var offset = typeof inputEl.selectionStart === 'number' ?
                inputEl.selectionStart :
                0;

            // Correct for trailing whitespace
            var trailingSpaces = out.match(/\s+$/);
            if (trailingSpaces) {
                var trailingSpaceCount = trailingSpaces[0].length;
                offset = Math.min(offset, out.length - trailingSpaceCount);
            }

            // Correct for leading whitespace
            var leadingSpaces = out.match(/^\s+/);
            if (leadingSpaces) {
                var leadingSpaceCount = leadingSpaces[0].length;
                offset = Math.max(offset - leadingSpaceCount, 0);
            }

            return offset;
        },

        insertAtCursor: function (str) {
            this.focus();

            var text = this.get();
            var offset = this.offset();
            var newText = utils.insertWithWhitespace(text, offset, str);
            var inputEl = this.$input[0];
            this.set(newText);

            // Put the cursor after the inserted text
            if (inputEl.setSelectionRange) {
                // The + 1 below is for the trailing whitespace of insertWithWhitespace
                var newCursorIndex = newText.indexOf(str, offset) + str.length + 1;
                inputEl.setSelectionRange(newCursorIndex, newCursorIndex);
            }
        },

        insertAroundSelection: function (beforeText, afterText) {
            this.focus();

            var inputEl = this.$input[0];

            var start, end;
            if (typeof inputEl.selectionStart === 'number') {
                start = inputEl.selectionStart;
                end = inputEl.selectionEnd;
            } else {
                start = end = 0;
            }

            var text = this.get();

            var newText = text.substring(0, start) +
                beforeText +
                text.substring(start, end) +
                afterText +
                text.substring(end);

            this.set(newText);

            // Keep the selection around the original text
            if (inputEl.setSelectionRange)
                inputEl.setSelectionRange(start + beforeText.length, end + beforeText.length);
        },

        set: function (str) {
            this.$input.val(str);
        },

        clear: function () {
            this.set('');
        },

        focus: function () {
            this.$input.focus();
        },

        handleKeyDown: function (evt) {
            this.trigger('keydown', evt);
        },

        handleKeyUp: function (evt) {
            this.trigger('keychange', evt);
        },

        handlePaste: function (_evt, options) {
            options = options || {};
            this.trigger(options.fake ? 'paste' : 'paste keychange');
            this.$input.trigger('resize');
        },

        handleFocusIn: function () {
            // need to fix the html elements (like we do in set selection)
            // mouse up is not being called when focusing in for the first time
            this.fixInputStructure();
            this.trigger('focus');
        },

        handleBlur: function () {
            this.trigger('blur');
        },

        /**
         * Save the textarea value plus some metadata to local storage
         * Storage format: [ value, timestamp, etc. ]
         * @returns {void}
         */
        saveDraft: function () {
            if (!this.storageKey)
                return;

            // If text box is empty, don't save. Remove draft.
            if (!$.trim(this.get()))
                return void this.removeDraft();

            this.constructor.storage.set(
                this.storageKey,
                this.toJSON()
            );
        },

        /**
         * Serialize for this.saveDraft()
         * @returns {Array} An array of data to put into local storage
         */
        toJSON: function () {
            return [
                this.get(),
                $.now(),  // timestamp, to expire old values
            ];
        },

        /**
         * Gets the array from local storage that contains the draft string,
         * as well as metadata (e.g., timestamp)
         *
         * The first array element is a string that represents the saved draft that the
         * user was working on in the textarea.
         *
         * @returns {Array} an array whose first element is the draft string
         */
        getDraft: function () {
            var record = [''];

            if (!this.storageKey)
                return record;

            var val = this.constructor.storage.get(this.storageKey);
            if (!val)
                return record;

            record = val;
            if (!record.length)
                return [''];

            var olderThanOneDay = $.now() - record[1] >= this.constructor.DRAFT_MAX_AGE;

            if (olderThanOneDay) {
                // Record has expired; remove it from storage
                this.removeDraft();
                return [''];
            }

            return record;
        },

        removeDraft: function () {
            if (!this.storageKey)
                return;

            this.constructor.storage.remove(this.storageKey);
        },

        fixInputStructure: function () {
            var parentNode, pNode, pNodeReplacement, numOfPsChildren, numOfDivsChildren, node, i;
            var shouldFocusEnd = false;
            var shouldFocusSpecificIndicies = false;
            var document = window.document;

            var inputEl = this.$input[0];

            if (inputEl.type && inputEl.type === 'textarea') {
                // This happens when you focus an being-edited comment, we can skip this since textarea has content
                // and not elements

            } else if (utils.browser.isChrome()) {
                // chrome
                /*
                * If the div only has <br> as <p>s first child (no text in chrome)
                * The structure is as:
                * <div>
                *     <p>
                *         <br>
                *     </p>
                * </div>
                *
                * When the comment box is empty and the user continues to delete, then the structure is as:
                * <div>
                * </div>
                *
                * The structure is otherwise as:
                * <div>
                *     <p>
                *         ...<br>
                *         ...<br>
                *         ...
                *     </p>
                * </div>
                *
                * will replace <br>s with #text '\n' nodes so that it is easy to work with and no different in view
                *
                * <div>
                *     <p>
                *         #text(#text'\n')
                *         #text(#text'\n')
                *         ...
                *         #text
                *     </p>
                * </div
                *
                * */
                if (inputEl.childNodes.length === 0) {
                    pNode = inputEl.appendChild(document.createElement('p'));
                    pNode.appendChild(document.createTextNode('\n'));
                    // The text node needs to contain something inside it so that when the user
                    // actually types something it will be entered into that text node, or else the
                    // user entered text will be a separate text node that's a sibling to the p node.
                    shouldFocusEnd = true;
                } else {
                    parentNode = inputEl.childNodes[0];
                    // For chrome for easier handling replace all the <br> nodes with #text nodes
                    parentNode.childNodes.forEach(function (node) {
                        if (nodeTypes.isBr(node))
                        // This works in chrome but doesn't in FF, doesn't create new lines, piles on the same line
                            parentNode.replaceChild(document.createTextNode('\n'), node);
                    });
                }

            } else if (utils.browser.isIE()) {
                /*
                * Empty when loaded
                * <div>
                *     <p>
                *         <br> -> convert this to <p>#text('')<p>
                *     </p>
                * </div>
                *
                * One line when typing or when loaded
                * <div>
                *     <p>
                *         #text<br> -> convert this to <p>#text<p>
                *     </p>
                * </div>
                *
                * Everything deleted
                * <div>
                * </div>
                *
                * Multiline when typing
                * <div>
                *     (<p>#text</p>)*    #text is not be there for empty lines (just <p></p>)
                *     <p>#text<br></p>
                * </div>
                *
                * Multiline when loaded
                * <div>
                *     <p>
                *         (#text<br>)*
                *     </p>
                * </div>
                *
                * Convert everything to
                * <div>
                *     (<p>#text</p>)*    #text will always be there
                * </div>
                * */

                if (inputEl.childNodes.length === 0) {
                    pNodeReplacement = document.createElement('p');
                    pNodeReplacement.appendChild(document.createTextNode(''));
                    inputEl.appendChild(pNodeReplacement);
                    shouldFocusEnd = true;

                } else {
                    numOfDivsChildren = inputEl.childNodes.length;
                    for (i = 0; i < numOfDivsChildren; i++) {

                        // take each pNode
                        if (nodeTypes.isP(inputEl.childNodes[i])) {
                            numOfPsChildren = inputEl.childNodes[i].childNodes.length;

                            if (numOfPsChildren === 0) {
                                // <p></p>  ->  to  -> <p>#text</p>
                                inputEl.childNodes[i].appendChild(document.createTextNode(''));
                                // place the cursor at the end if we make it <div><p>#text('')</p></div>
                                // so that we keep all the elements within <div>
                                if (numOfDivsChildren === 1) shouldFocusEnd = true;

                            } else if (numOfPsChildren === 1) {
                                // <p><br></p> ->  to  -> <p>#text</p>
                                if (nodeTypes.isBr(inputEl.childNodes[i].childNodes[0])) {
                                    inputEl.childNodes[i].replaceChild(document.createTextNode(''), inputEl.childNodes[i].childNodes[0]);
                                    // place the cursor at the end if we make it <div><p>#text('')</p></div>
                                    // so that we keep all the elements within <div>
                                    if (numOfDivsChildren === 1) shouldFocusEnd = true;
                                }

                            } else {
                                // <p>#text<br></p> Single line (last line) while typing or when draft is loaded
                                // <p>(#text<br>)*</p> multi line when draft is loaded
                                // ->  to  ->
                                // (<p>#text</p>)*
                                while (numOfPsChildren > 0) {
                                    // insert empty #text nodes inside empty <p> nodes to reference for everything
                                    node = inputEl.childNodes[i].childNodes[0];

                                    if (numOfPsChildren === 1 && nodeTypes.isBr(node)) {
                                        inputEl.childNodes[i].replaceChild(document.createTextNode(''), node);
                                        numOfPsChildren -= 1;

                                    } else if (numOfPsChildren === 2 // eslint-disable-line no-magic-numbers
                                        && nodeTypes.isBr(node)
                                        && nodeTypes.isText(inputEl.childNodes[i].childNodes[1])
                                        && this.inputFixed) {
                                        // this is when user presses shift + enter in IE a <br> is inserted
                                        // before the text node in this <p> node, we can add this node if this is not
                                        // multiline draft when page is reloaded (ie. multiline reloaded)
                                        pNodeReplacement = document.createElement('p');
                                        pNodeReplacement.appendChild(document.createTextNode(''));
                                        inputEl.insertBefore(pNodeReplacement, inputEl.childNodes[i]);
                                        i += 1;
                                        numOfDivsChildren += 1;
                                        inputEl.childNodes[i].removeChild(node);
                                        numOfPsChildren -= 2; // eslint-disable-line no-magic-numbers
                                        // will be done with this <p> node after this

                                        this.selectionIndices = {
                                            startElemInd: i,
                                            endElemInd: i,
                                            startElemSelectionInd: 0,
                                            endElemSelectionInd: 0,
                                        };
                                        shouldFocusSpecificIndicies = true;


                                    } else if (numOfPsChildren === 2 // eslint-disable-line no-magic-numbers
                                        && nodeTypes.isText(node)
                                        && nodeTypes.isBr(inputEl.childNodes[i].childNodes[1])) {
                                        if (this.inputFixed) {
                                            pNodeReplacement = document.createElement('p');
                                            pNodeReplacement.appendChild(document.createTextNode(''));
                                            if (i === numOfDivsChildren - 1)
                                                inputEl.appendChild(pNodeReplacement);
                                            else
                                                inputEl.insertBefore(pNodeReplacement, inputEl.childNodes[i + 1]);
                                            numOfDivsChildren += 1;

                                            this.selectionIndices = {
                                                startElemInd: i + 1,
                                                endElemInd: i + 1,
                                                startElemSelectionInd: 0,
                                                endElemSelectionInd: 0,
                                            };
                                            shouldFocusSpecificIndicies = true;
                                        }

                                        inputEl.childNodes[i].removeChild(inputEl.childNodes[i].childNodes[1]);
                                        numOfPsChildren -= 2; // eslint-disable-line no-magic-numbers

                                    } else if (numOfPsChildren > 2 // eslint-disable-line no-magic-numbers
                                        && nodeTypes.isText(node)
                                        && nodeTypes.isBr(inputEl.childNodes[i].childNodes[1])) {

                                        pNodeReplacement = document.createElement('p');
                                        pNodeReplacement.appendChild(document.createTextNode(node.nodeValue));
                                        inputEl.insertBefore(pNodeReplacement, inputEl.childNodes[i]);
                                        i += 1;
                                        numOfDivsChildren += 1;
                                        inputEl.childNodes[i].removeChild(inputEl.childNodes[i].childNodes[1]);
                                        inputEl.childNodes[i].removeChild(node);
                                        numOfPsChildren -= 2; // eslint-disable-line no-magic-numbers

                                    } else {
                                        numOfPsChildren -= 1;
                                    }
                                }
                            }
                        }
                    }
                }

            } else if (utils.browser.isFirefox()) {

                // the p tags can be sometimes div s when everything has been deleted
                /*
                * FF is unique
                * empty loaded fine  can go to <br> collection
                * <div>
                *     <p>
                *         <br>
                *     </p>
                * </div>
                *
                * one line typing or reloaded fine can go to <br> collection
                * <div>
                *     <p>
                *         #text<br>
                *     </p>
                * </div>
                *
                * one line typing after deleting everything and typing
                * CONVERT THIS TO one line typing or reloaded fine
                * since the this.get will be an empty string, the text will be focused
                * <div>
                *     #text<br>
                * </div>
                *
                * empty erased
                * This will be the same as the one above
                * <div>
                * </div>
                *
                * empty erased with selecting all
                * <div>
                *     <br>
                * </div>
                *
                * multiline while typing
                * <div>
                *     (<p> #text <p> || <p> <br> </p>)*
                *     </p> #text<br> </p>
                * </div>
                *
                * multiline when fresh loaded
                * multiple line breaks get combined to 1 line break
                * leaving max 2 linebreaks in a row
                * CONVERTING THIS TO THE multiline while typing OPTION
                * <div>
                *     <p>
                *         (#text <br> || <br>)*
                *         #text
                *     </p>
                * </div>
                *
                * multiline typing after erasing everything
                * <div>
                *     (<div> #text <div> || <div> <br> </div>)*
                *     </div> #text<br> </div>
                * </div>
                * */


                // FRESH MULTILINE CONVERT THIS TO TYPING WHILE MULTILINE
                if (inputEl.childNodes.length === 1 &&
                    nodeTypes.isP(inputEl.childNodes[0]) &&
                    inputEl.childNodes[0].childNodes.length > 2) {
                    // convert multiline fresh loaded to multiline while typing
                    // after text node there should be a <br> node
                    // eliminate <br> node, put text node in a <p> node
                    // if there is a <br> node next put it in a <p> node
                    // add a final <br> node with <p> around it if it is not there

                    numOfPsChildren = inputEl.childNodes[0].childNodes.length;
                    for (i = 0; i < numOfPsChildren; i++) {
                        node = inputEl.childNodes[0].childNodes[i];

                        if (nodeTypes.isText(node)) {
                            pNodeReplacement = document.createElement('p');
                            pNodeReplacement.appendChild(document.createTextNode(node.nodeValue));
                            if (i < numOfPsChildren - 1 && nodeTypes.isBr(inputEl.childNodes[0].childNodes[i + 1]))
                                i += 1;

                        } else if (nodeTypes.isBr(node)) {
                            pNodeReplacement = document.createElement('p');
                            pNodeReplacement.appendChild(document.createElement('br'));

                        }

                        inputEl.appendChild(pNodeReplacement);
                    }

                    inputEl.removeChild(inputEl.childNodes[0]);

                } else if (inputEl.childNodes.length === 1 && nodeTypes.isBr(inputEl.childNodes[0])) {
                    /*
                    * <div>
                    *     <br>
                    * </div>
                    *
                    * -> to ->
                    *
                    * <div>
                    *     <p>
                    *         <br>
                    *     </p>
                    * </div>
                    * */

                    inputEl.removeChild(inputEl.childNodes[0]);
                    pNodeReplacement = document.createElement('p');
                    pNodeReplacement.appendChild(document.createElement('br'));
                    inputEl.appendChild(pNodeReplacement);

                } else if (inputEl.childNodes.length === 0) {
                    /*
                    * <div>
                    * </div>
                    *
                    * -> to ->
                    *
                    * <div>
                    *     <p>
                    *         <br>
                    *     </p>
                    * </div>
                    * */

                    pNodeReplacement = document.createElement('p');
                    pNodeReplacement.appendChild(document.createElement('br'));
                    inputEl.appendChild(pNodeReplacement);
                    shouldFocusEnd = true;
                }

                for (i = 0; i < inputEl.childNodes.length; i++) {
                    var currPNode = inputEl.childNodes[i];
                    if (nodeTypes.isP(currPNode) && currPNode.childNodes.length === 1 && nodeTypes.isBr(currPNode.childNodes[0])) {
                        // this is what we want to set as #text + br
                        /*
                        * all of the
                        * <p>
                        *     <br>
                        * </p>
                        * -> to ->
                        * <p>
                        *     #text('')<br>
                        * </p>
                        * */

                        currPNode.insertBefore(document.createTextNode(''), currPNode.childNodes[0]);

                    } else if (nodeTypes.isDiv(currPNode)) {

                        pNodeReplacement = document.createNode('P');

                        if (currPNode.childNodes.length === 1 && nodeTypes.isBr(currPNode.childNodes[0])) {
                            pNodeReplacement.appendChild(document.createTextNode(''));
                            pNodeReplacement.appendChild(document.createNode('BR'));

                        } else if (currPNode.childNodes.length === 2
                            && nodeTypes.isText(currPNode.childNodes[0])
                            && currPNode.childNodes[0].nodeValue.length > 0
                            && nodeTypes.isBr(currPNode.childNodes[1])) {
                            pNodeReplacement.appendChild(document.createTextNode(currPNode.childNodes[0].nodeValue));
                        }

                        inputEl.replaceChild(pNodeReplacement, currPNode);

                    }
                }


            } else if (utils.browser.isSafari() || utils.browser.isEdge()) {

                /*
                * safari & edge are similar to chrome
                * empty loaded
                * <div>
                *     <p>
                *         <br>
                *     </p>
                * </div>
                *
                * empty erased -> replace for Edge & Safari Different
                * <div>
                *     (<br>) -> Edge has the br Safari doesnt
                * </div>
                * -> replace with
                * <div>
                *     <p>
                *         #text
                *     </p>
                * <div>
                * then focus on the element
                *
                * erased -> and then typing (this shoud not happen b/c option 2 fixes)
                * <div>
                *     #text
                * </div>
                *
                * erased -> and then typing multiline (this shoud not happen b/c option 2 fixes)
                * <div>
                *     #text<br>
                *     #text<br>
                * </div>
                *
                * one line typing
                * <div>
                *     <p>
                *         #text
                *     </p>
                * </div>
                *
                * oneline typing then press enter
                * <div>
                *     <p>
                *         (#text<br>)*
                *         <br>
                *     </p>
                * </div>
                *
                * multiline typing for Edge & Safari Different
                * <div>
                *     <p>
                *         (#text<br>)*
                *         #text (<br>) <- Safari doesnt have this last br (replaces when trying to type)
                *     </p>
                * </div>
                *
                * multiline loaded
                * <div>
                *     <p>
                *         ((#text)(<br>)*)*
                *     </p>
                * </div>
                *
                * multiline
                * <div>
                *     <p>
                *         (#text<br>)*
                *         #text || <br> (depending on empty or not last line)
                *     </p>
                * </div>
                *
                * convert everything to
                * <div>
                *     <p>
                *         (#text<br>)*
                *     </p>
                * </div>
                *
                * */

                if (inputEl.childNodes.length === 0 || !nodeTypes.isP(inputEl.childNodes[0])) {
                    /* This is for when you keep deleting an empty textarea, Safari and Edge has some differences
                    * but if the first child of inputEl is not <p> reset it
                    * <div></div> || <div>(<br>)*</div>
                    * -> replace with
                    * <div>
                    *     <p>
                    *         (#text('')<br>)*
                    *     </p>
                    * <div>
                    */
                    pNodeReplacement = document.createElement('p');
                    pNodeReplacement.appendChild(document.createTextNode(''));
                    pNodeReplacement.appendChild(document.createElement('br'));
                    while (inputEl.firstChild)
                        inputEl.removeChild(inputEl.firstChild);
                    inputEl.appendChild(pNodeReplacement);
                    shouldFocusEnd = true;
                } else {
                    /* make everything
                    * <div>
                    *     <p>
                    *         (#text<br>)* (there might not be a last br)
                    *     </p>
                    * <div> */

                    parentNode = inputEl.childNodes[0];
                    numOfPsChildren = parentNode.childNodes.length;
                    for (i = 0; i < numOfPsChildren; i += 1) {
                        // for all the br nodes that either have another br before them || the first child that is br
                        if (nodeTypes.isBr(parentNode.childNodes[i])
                            && (i === 0 || nodeTypes.isBr(parentNode.childNodes[i - 1]))) {
                            parentNode.insertBefore(document.createTextNode(''), parentNode.childNodes[i]);
                            // to avoid duplicating the #text nodes when replacing the last <br>
                            if (i === numOfPsChildren - 1) shouldFocusEnd = true;
                        }
                    }

                    for (i = 0; i < numOfPsChildren - 1; i += 1) {
                        // for all the #text('') nodes that have another #text node after, delete the empty #text node
                        if (nodeTypes.isText(parentNode.childNodes[i])
                            && parentNode.childNodes[i].nodeValue === ''
                            && nodeTypes.isText(parentNode.childNodes[i + 1])) {
                            parentNode.removeChild(parentNode.childNodes[i]);
                            i -= 1;
                            numOfPsChildren -= 1;
                        }
                    }
                }

            } else if (utils.browser.isOpera()) {

                /*
                * Empty when loaded
                * <div>
                *     <p>
                *         <br>
                *     </p>
                * </div>
                *
                * Single line when loaded
                * <div>
                *     <p>
                *         #text<br>
                *     </p>
                * </div>
                *
                * Single line when typing
                * <div>
                *     <p>
                *         #text<br>
                *     </p>
                * </div>
                *
                * When everything is erased
                * make this similar to empty when loaded
                * <div>
                * </div>
                *
                * Multiline while typing
                * <div>
                *     <p>
                *         (#text)*(#text'\n')*
                *     </p>
                * </div>
                *
                * Multiline when loaded
                *  -> replace <br>s with #text'\n's
                * <div>
                *     <p>
                *         (#text)*(<br>)*
                *     </p>
                * </div>
                *
                * replace all <br>s with #text'\n'
                * */

                if (inputEl.childNodes.length === 0) {
                    pNodeReplacement = document.createElement('p');
                    pNodeReplacement.appendChild(document.createTextNode('\n'));
                    inputEl.appendChild(pNodeReplacement);
                    shouldFocusEnd = true;

                } else {
                    parentNode = inputEl.childNodes[0];
                    for (i = 0; i < parentNode.childNodes.length; i++) {
                        if (nodeTypes.isBr(parentNode.childNodes[i]))
                            parentNode.replaceChild(document.createTextNode('\n'), parentNode.childNodes[i]);
                    }
                }
            }

            this.inputFixed = true;

            if (shouldFocusSpecificIndicies)
                this.selectText();
            else if (shouldFocusEnd)
                this.focusEndOfText();
        },

        focusEndOfText: function () {
            var inputEl = this.$input[0];
            var parentNode;
            var startElemInd = 0;
            var endElemInd = 0;
            var startElemSelectionInd = 0;
            var endElemSelectionInd = 0;


            if (utils.browser.isChrome() || utils.browser.isOpera()) {
                /* <div>
                *      <p>
                *         (#text)*
                *     </p>
                * </div> */
                parentNode = inputEl.childNodes[0];
                startElemInd = endElemInd = parentNode.childNodes.length - 1;
                startElemSelectionInd = endElemSelectionInd = parentNode.childNodes[startElemInd].nodeValue.length;

            } else if (utils.browser.isSafari() || utils.browser.isEdge()) {
                /* <div>
                *      <p>
                *         (#text<br>)* (there might not be a last br)
                *     </p>
                * </div> */
                parentNode = inputEl.childNodes[0];
                startElemInd = endElemInd = nodeTypes.isText(parentNode.childNodes[parentNode.childNodes.length - 1]) ?
                    parentNode.childNodes.length - 1 :
                    parentNode.childNodes.length - 2; // eslint-disable-line no-magic-numbers
                startElemSelectionInd = endElemSelectionInd = parentNode.childNodes[startElemInd].nodeValue.length;

            } else if (utils.browser.isFirefox() || utils.browser.isIE()) {
                /* <div>
                *     (<p>#text</p>)*    #text will always be there
                * </div> */
                startElemInd = endElemInd = inputEl.childNodes.length - 1;
                startElemSelectionInd = inputEl.childNodes[startElemInd].childNodes[0].nodeValue.length;
                endElemSelectionInd = startElemSelectionInd;
            }

            this.selectionIndices = {
                startElemInd: startElemInd,
                startElemSelectionInd: startElemSelectionInd,
                endElemInd: endElemInd,
                endElemSelectionInd: endElemSelectionInd,
            };
            this.selectText();
        },

        getWhichChildIndex: function (parent, child) {
            var i = 0;
            for (; i < parent.childNodes.length; i++) {
                if (parent.childNodes[i] === child)
                    return i;
            }
            return -1;
        },

        getNodeLength: function (node) {
            // This function will be useful esp. for FF, don't like to see the same macro everywhere
            return nodeTypes.isBr(node) ? 1 : node.nodeValue.length;
        },

        placeholderSetSelection: function () {
            var selectionStart, selectionEnd;
            var editorSelection = window.getSelection();

            if (this.$input[0].type && this.$input[0].type === 'textarea') {
                selectionStart = this.$input[0].selectionStart;
                selectionEnd = this.$input[0].selectionEnd;

            } else if (editorSelection.anchorNode.tagName === 'DIV') {
                // all has been selected
                selectionStart = 0;
                selectionEnd = this.get().length;

            } else if (editorSelection.anchorNode.tagName === 'P') {
                // empty area of textarea has been clicked
                selectionStart = selectionEnd = this.get().length;

            } else {
                selectionStart = Math.min(editorSelection.focusOffset, editorSelection.anchorOffset);
                selectionEnd = Math.max(editorSelection.focusOffset, editorSelection.anchorOffset);
            }

            this.selectionIndices = {
                start: selectionStart,
                end: selectionEnd,
                endElemInd: 0,
                endElemSelectionInd: 0,
                startElemInd: 0,
                startElemSelectionInd: 0,
            };
        },

        setSelection: function () {
            var parentNode, selectionStart, selectionEnd, startElemInd, endElemInd, startElemSelectionInd,
                endElemSelectionInd;

            this.fixInputStructure();

            var inputEl = this.$input[0];
            var shouldSelectText = false;
            var selectionObj = window.getSelection();

            if (inputEl.type && inputEl.type === 'textarea') {
                // for editing posts that are already commented (uses <textarea> different than the div.textarea)
                // Dont need to set these b/c they are not used in textarea
                // startElemInd, endElemInd, startElemSelectionInd, endElemSelectionInd;
                selectionStart = inputEl.selectionStart;
                selectionEnd = inputEl.selectionEnd;

            } else if (selectionObj.rangeCount) {
                var selectionRange = selectionObj.getRangeAt(0);

                if (utils.browser.isChrome()) {
                    ////////////////////////////////////////////////////////////////////////////////////////////////////
                    //                                             CHROME
                    ////////////////////////////////////////////////////////////////////////////////////////////////////
                    /* the structure is
                    * <div>
                    *     <p>
                    *         #text(#text'\n')
                    *         #text(#text'\n')
                    *         ...
                    *         #text
                    *     </p>
                    * </div
                    *
                    * will capture the indicies of the text elements and the selection indicies within the elements
                    * */

                    parentNode = inputEl.childNodes[0];

                    // Tally up the nodes lengths up to the starting node as well as find starting node
                    selectionStart = startElemInd = 0;
                    while (parentNode.childNodes[startElemInd] !== selectionRange.startContainer) {
                        selectionStart += this.getNodeLength(parentNode.childNodes[startElemInd]);
                        startElemInd += 1;
                    }

                    // the caret position within the element
                    startElemSelectionInd = selectionRange.startOffset;
                    // selection within the element, which was not accounted for in the loop
                    selectionStart += selectionRange.startOffset;


                    if (selectionRange.collapsed) {
                        // selection is a caret, end values are the same as start values
                        endElemInd = startElemInd;
                        selectionEnd = selectionStart;
                        endElemSelectionInd = startElemSelectionInd;

                    } else if (selectionRange.startContainer === selectionRange.endContainer) {
                        // selection is within the same element, just add the endOffset to start values for end values
                        endElemInd = startElemInd;
                        endElemSelectionInd = selectionRange.endOffset;
                        // start offset has been added to the selection start value, just add the difference
                        selectionEnd = selectionStart + (selectionRange.endOffset - selectionRange.startOffset);

                    } else {
                        // selection is through multiple elements find the endContainer's index
                        // start from start element
                        endElemInd = startElemInd;
                        // remove the already added startOffset
                        selectionEnd = selectionStart - selectionRange.startOffset;

                        // Keep tallying up the lengths of the nodes from startContainer to end
                        while (parentNode.childNodes[endElemInd] !== selectionRange.endContainer) {
                            selectionEnd += this.getNodeLength(parentNode.childNodes[endElemInd]);
                            endElemInd += 1;
                        }
                        // after finding the starting node and ending node, if the ending node is a break node, go back
                        // to the end of the previous node. This can be done in the while loop above but more explicit
                        // this way
                        if (nodeTypes.isNewline(parentNode.childNodes[endElemInd])) {
                            // the end index is the end of the previous element
                            endElemSelectionInd = this.getNodeLength(parentNode.childNodes[endElemInd - 1]);
                            endElemInd -= 1;
                        } else {
                            // the selection within the end container which was not accounted for in the loop
                            selectionEnd += selectionRange.endOffset;
                            endElemSelectionInd = selectionRange.endOffset;
                        }
                    }
                } else if (utils.browser.isIE()) {
                    ////////////////////////////////////////////////////////////////////////////////////////////////////
                    //                                               IE
                    ////////////////////////////////////////////////////////////////////////////////////////////////////
                    /*
                    The structure is
                    * <div>
                    *     (<p>#text</p>)*    #text will always be there
                    *     <p>#text<br></p>
                    * </div>
                    * */

                    if (nodeTypes.isDiv(selectionRange.startContainer)
                        && nodeTypes.isDiv(selectionRange.endContainer)
                        && selectionRange.collapsed) {

                        // when first focusing on the textbox (needs to be reloaded multiline for the most part)
                        // by just clicking and not dragging, ie. not selecting & just focusing
                        startElemInd = inputEl.childNodes.length - 1;
                        endElemInd = inputEl.childNodes.length - 1;
                        startElemSelectionInd = inputEl.childNodes[startElemInd].childNodes[0].nodeValue.length;
                        endElemSelectionInd = inputEl.childNodes[endElemInd].childNodes[0].nodeValue.length;

                        // we set the selection at the very end b/c we don't know where the user clicked to focus in
                        shouldSelectText = true; // a way to focus on the very end here

                    } else if (nodeTypes.isDiv(selectionRange.startContainer)
                        && nodeTypes.isDiv(selectionRange.endContainer)
                        && !selectionRange.collapsed) {

                        // when first focusing on the textbox (needs to be reloaded multiline for the most part)
                        // by clicking and dragging so selecting & focusing at the same time
                        startElemInd = selectionRange.startOffset;
                        endElemInd = selectionRange.endOffset - 1; // this one is the end container index + 1
                        // selectionRange returns as [s, e) we use as [s, e] but the selection indices [sSel, eSel)
                        startElemSelectionInd = 0;
                        endElemSelectionInd = inputEl.childNodes[endElemInd].childNodes[0].nodeValue.length;

                    } else if (nodeTypes.isText(selectionRange.startContainer)
                        && nodeTypes.isText(selectionRange.endContainer)) {

                        startElemInd = this.getWhichChildIndex(inputEl, selectionRange.startContainer.parentNode);
                        endElemInd = this.getWhichChildIndex(inputEl, selectionRange.endContainer.parentNode);
                        startElemSelectionInd = selectionRange.startOffset;
                        endElemSelectionInd = selectionRange.endOffset;

                    } else if (nodeTypes.isText(selectionRange.startContainer)
                        && nodeTypes.isDiv(selectionRange.endContainer)) {

                        startElemInd = this.getWhichChildIndex(inputEl, selectionRange.startContainer.parentNode);
                        endElemInd = selectionRange.endOffset - 1;
                        startElemSelectionInd = selectionRange.startOffset;
                        endElemSelectionInd = inputEl.childNodes[endElemInd].childNodes[0].nodeValue.length;

                    } else {
                        // should never reach here but leave it in case something goes very bad
                        // using all zeros will not be an issue, since we fix the input everytime
                        startElemInd = 0;
                        endElemInd = 0;
                        startElemSelectionInd = 0;
                        endElemSelectionInd = 0;
                    }

                } else if (utils.browser.isFirefox()) {
                    ////////////////////////////////////////////////////////////////////////////////////////////////////
                    //                                            FIRE FOX
                    ////////////////////////////////////////////////////////////////////////////////////////////////////
                    /*
                    * The structure is
                    * <div>
                    *     <p>
                    *         (#text <br> || <br>)*
                    *         #text
                    *     </p>
                    * </div>
                    * */

                    if (nodeTypes.isDiv(selectionRange.startContainer)
                        && nodeTypes.isDiv(selectionRange.endContainer)
                        && selectionRange.startContainer === inputEl
                        && selectionRange.endContainer === inputEl
                        && selectionRange.collapsed) {

                        // when first focusing on the textbox by just clicking and not selecting & focusing
                        startElemInd = inputEl.childNodes.length - 1;
                        endElemInd = inputEl.childNodes.length - 1;
                        startElemSelectionInd = inputEl.childNodes[startElemInd].childNodes[0].nodeValue.length;
                        endElemSelectionInd = inputEl.childNodes[endElemInd].childNodes[0].nodeValue.length;

                        shouldSelectText = true; // a way to focus on the very end here

                    } else if (nodeTypes.isDiv(selectionRange.startContainer)
                        && nodeTypes.isDiv(selectionRange.endContainer)
                        && selectionRange.startContainer === inputEl
                        && selectionRange.endContainer === inputEl
                        && !selectionRange.collapsed) {

                        // ctrl/cmd + a within the textbox, or clicking and drag selection
                        // endoffset becomes the last selected child + 1, like [s, e), but we use it as [s, e]
                        // thus endoffset -1
                        startElemInd = selectionRange.startOffset;
                        endElemInd = selectionRange.endOffset - 1;
                        startElemSelectionInd = 0;
                        endElemSelectionInd = inputEl.childNodes[endElemInd].childNodes[0].nodeValue.length;

                    } else if (nodeTypes.isDiv(selectionRange.startContainer)
                        && nodeTypes.isText(selectionRange.endContainer)
                        && selectionRange.startContainer === inputEl) {

                        // when first focusing on the textbox by just dragging (selecting and focusing)
                        // ending at a #text node
                        startElemInd = 0;
                        endElemInd = this.getWhichChildIndex(inputEl, selectionRange.endContainer.parentNode);
                        startElemSelectionInd = 0;
                        endElemSelectionInd = selectionRange.endOffset;

                    } else if (nodeTypes.isDiv(selectionRange.startContainer)
                        && nodeTypes.isP(selectionRange.endContainer)
                        && selectionRange.startContainer === inputEl) {

                        // when first focusing on the textbox by just dragging (selecting and focusing)
                        // ending at a p node
                        startElemInd = 0;
                        endElemInd = this.getWhichChildIndex(inputEl, selectionRange.endContainer); // use the node (p)
                        startElemSelectionInd = 0;
                        endElemSelectionInd = inputEl.childNodes[endElemInd].childNodes[0].nodeValue.length; // the end of the endContainer's text part

                    } else if (nodeTypes.isText(selectionRange.startContainer)
                        && nodeTypes.isText(selectionRange.endContainer)) {

                        startElemInd = this.getWhichChildIndex(inputEl, selectionRange.startContainer.parentNode);
                        endElemInd = this.getWhichChildIndex(inputEl, selectionRange.endContainer.parentNode);
                        startElemSelectionInd = selectionRange.startOffset;
                        endElemSelectionInd = selectionRange.endOffset;

                    } else if (nodeTypes.isText(selectionRange.startContainer)
                        && nodeTypes.isP(selectionRange.endContainer)) {

                        startElemInd = this.getWhichChildIndex(inputEl, selectionRange.startContainer.parentNode);
                        endElemInd = this.getWhichChildIndex(inputEl, selectionRange.endContainer);
                        startElemSelectionInd = selectionRange.startOffset;
                        endElemSelectionInd = startElemInd === endElemInd ?
                            inputEl.childNodes[endElemInd].childNodes[0].nodeValue.length :
                            0;

                    } else if (nodeTypes.isP(selectionRange.startContainer)
                        && nodeTypes.isText(selectionRange.endContainer)) {

                        // if the end selection index is === 0 we should handle as if it is an all brs selection
                        // if the end selection index is > 0 it looks as if only the end ind much has been selected from
                        // the end element

                        startElemInd = this.getWhichChildIndex(inputEl, selectionRange.startContainer);
                        endElemInd = this.getWhichChildIndex(inputEl, selectionRange.endContainer.parentNode);
                        startElemSelectionInd = 0;
                        endElemSelectionInd = selectionRange.endOffset;

                    } else if (nodeTypes.isP(selectionRange.startContainer)
                        && nodeTypes.isP(selectionRange.endContainer)) {
                        // when triple clicking on a line to select, it selects the entire <p>

                        startElemInd = this.getWhichChildIndex(inputEl, selectionRange.startContainer);
                        endElemInd = this.getWhichChildIndex(inputEl, selectionRange.endContainer);
                        startElemSelectionInd = 0;
                        endElemSelectionInd = inputEl.childNodes[endElemInd].childNodes[0].nodeValue.length;

                    } else {
                        // should never reach here but leave it in case something goes very bad
                        // using all zeros will not be an issue, since we fix the input everytime
                        startElemInd = 0;
                        endElemInd = 0;
                        startElemSelectionInd = 0;
                        endElemSelectionInd = 0;
                    }

                } else if (utils.browser.isSafari() || utils.browser.isEdge()) {
                    ////////////////////////////////////////////////////////////////////////////////////////////////////
                    //                                         SAFARI & EDGE
                    ////////////////////////////////////////////////////////////////////////////////////////////////////
                    /*
                    * The shape is guaranteed to be
                    /* make everything
                    * <div>
                    *     <p>
                    *         (#text<br>)* (there might not be a last br)
                    *     </p>
                    * <div> */

                    // if either container in the selection range is a p we can
                    // easily go to the end of the previous text node

                    parentNode = inputEl.childNodes[0];

                    if (nodeTypes.isText(selectionRange.startContainer)) {
                        // selection starts on a text node this is fine
                        startElemInd = this.getWhichChildIndex(parentNode, selectionRange.startContainer);
                        startElemSelectionInd = selectionRange.startOffset;

                    } else if (nodeTypes.isP(selectionRange.startContainer)) {
                        // start container node is <p> when user holds down shift and presses the arrow keys to select
                        // in this case the #text node of the previous <p> node should be the selection node
                        if (selectionRange.startOffset < parentNode.childNodes.length
                            && nodeTypes.isText(parentNode.childNodes[selectionRange.startOffset])) {
                            startElemInd = selectionRange.collapsed ?
                                selectionRange.startOffset :
                                selectionRange.startOffset - 2; // eslint-disable-line no-magic-numbers
                        } else {
                            startElemInd = selectionRange.startOffset - 1;
                        }

                        startElemSelectionInd = parentNode.childNodes[startElemInd].nodeValue.length;

                    } else if (nodeTypes.isDiv(selectionRange.startContainer)) {
                        if (selectionRange.collapsed) {
                            // When you focus for first time on edge, containers are divs and the range is collapsed
                            startElemInd = nodeTypes.isText(parentNode.childNodes[parentNode.childNodes.length - 1]) ?
                                parentNode.childNodes.length - 1 :
                                parentNode.childNodes.length - 2; // eslint-disable-line no-magic-numbers
                            startElemSelectionInd = parentNode.childNodes[startElemInd].nodeValue.length;

                        } else {
                            // When you ctrl + a on edge, containers are divs and the range is not collapsed
                            startElemInd = 0;
                            startElemSelectionInd = 0;
                        }
                    }

                    if (nodeTypes.isText(selectionRange.endContainer)) {
                        // selection ends on a text node this is fine
                        endElemInd = this.getWhichChildIndex(parentNode, selectionRange.endContainer);
                        endElemSelectionInd = selectionRange.endOffset;

                    } else if (nodeTypes.isP(selectionRange.endContainer)) {
                        // end container node is <p> when user holds down shift and presses the arrow keys to select
                        // in this case the #text node of the previous <p> node should be the selection node
                        if (selectionRange.endOffset < parentNode.childNodes.length
                            && nodeTypes.isText(parentNode.childNodes[selectionRange.endOffset])) {
                            endElemInd = selectionRange.collapsed ?
                                selectionRange.endOffset :
                                selectionRange.endOffset - 2; // eslint-disable-line no-magic-numbers

                        } else if (selectionRange.endOffset - 1 < parentNode.childNodes.length
                            && nodeTypes.isText(parentNode.childNodes[selectionRange.endOffset - 1])) {
                            // the endoffset is the index element of the last <br> choose the #text right before
                            endElemInd = selectionRange.endOffset - 1;
                        } else if (selectionRange.endOffset - 1 < parentNode.childNodes.length
                            && nodeTypes.isBr(parentNode.childNodes[selectionRange.endOffset - 1])) {
                            // the endoffset is right after the <br> node, the index of <br> + 1 to select the text
                            // node right before we need to select two before the offset we get
                            endElemInd = selectionRange.endOffset - 2; // eslint-disable-line no-magic-numbers
                        } else {
                            // should never reach here but a fallback case nonetheless
                            endElemInd = parentNode.childNodes.length - 2; // eslint-disable-line no-magic-numbers
                        }

                        endElemSelectionInd = parentNode.childNodes[endElemInd].nodeValue.length;

                    } else if (nodeTypes.isDiv(selectionRange.endContainer)) {
                        // When you focus for first time on edge, containers are divs and the range is collapsed
                        // When you ctrl + a on edge, containers are divs and the range is not collapsed
                        // in either case end point should be the end of the text
                        endElemInd = nodeTypes.isText(parentNode.childNodes[parentNode.childNodes.length - 1]) ?
                            parentNode.childNodes.length - 1 :
                            parentNode.childNodes.length - 2; // eslint-disable-line no-magic-numbers
                        endElemSelectionInd = parentNode.childNodes[startElemInd].nodeValue.length;
                    }

                } else if (utils.browser.isOpera()) {
                    ////////////////////////////////////////////////////////////////////////////////////////////////////
                    //                                             OPERA
                    ////////////////////////////////////////////////////////////////////////////////////////////////////
                    /*
                    * The structure is
                    * <div>
                    *     <p>
                    *         (#text)*(#text'\n')*
                    *     </p>
                    * </div>
                    * */

                    parentNode = inputEl.childNodes[0];
                    startElemInd = this.getWhichChildIndex(parentNode, selectionRange.startContainer);
                    endElemInd = this.getWhichChildIndex(parentNode, selectionRange.endContainer);
                    startElemSelectionInd = selectionRange.startOffset;
                    endElemSelectionInd = selectionRange.endOffset;

                } else {
                    // TODO: @taylangocmen is there a way to address the other browsers?
                    return this.placeholderSetSelection();
                }
            } else {
                this.focusEndOfText();
            }

            this.selectionIndices = {
                start: selectionStart,
                end: selectionEnd,
                startElemInd: startElemInd,
                startElemSelectionInd: startElemSelectionInd,
                endElemInd: endElemInd,
                endElemSelectionInd: endElemSelectionInd,
            };

            if (shouldSelectText)
                this.selectText();
        },

        addTagTextarea: function (tagName) {
            // this is the old add tag, this will be removed when <div.textarea> and <textarea> are consolidated
            var leftTag, rightTag, editedText;
            var selectionStart = this.selectionIndices.start;
            var selectionEnd = this.selectionIndices.end;
            var startElemInd = this.selectionIndices.startElemInd;
            var endElemInd = this.selectionIndices.endElemInd;
            var startElemSelectionInd = this.selectionIndices.startElemSelectionInd;
            var endElemSelectionInd = this.selectionIndices.endElemSelectionInd;

            switch (tagName) {
            case 'a':
                leftTag = '<a href="#">';
                rightTag = '</a>';
                break;
            default:
                leftTag = '<' + tagName + '>';
                rightTag = '</' + tagName + '>';
            }

            // Dissect the current text to add tags around the selection
            var text = this.get();
            var left = text.slice(0, selectionStart);
            var selectedText = text.slice(selectionStart, selectionEnd);
            var right = text.slice(selectionEnd);

            var leftTagRegex = new RegExp('<' + tagName + '[^<>]*>');
            var rightTagRegex = new RegExp(rightTag + '$');
            var leftTagMatch = selectedText.match(leftTagRegex);
            var rightTagMatch = selectedText.match(rightTagRegex);

            if (leftTagMatch && rightTagMatch &&
                leftTagMatch.index === 0 &&
                rightTagMatch.index === selectionEnd - selectionStart - rightTag.length) {
                // Remove tags from the selected text since the matches are at the beginning & end of selection
                editedText = selectedText.replace(leftTagRegex, '').replace(rightTagRegex, '');
                selectionEnd -= leftTagMatch[0].length + rightTagMatch[0].length;
                endElemSelectionInd -= leftTagMatch[0].length + rightTagMatch[0].length;
            } else {
                // Add tags around the selected text
                editedText = leftTag + selectedText + rightTag;
                selectionEnd += leftTag.length + rightTag.length;
                endElemSelectionInd += leftTag.length + rightTag.length;
            }

            this.selectionIndices = {
                start: selectionStart,
                end: selectionEnd,
                startElemInd: startElemInd,
                endElemInd: endElemInd,
                startElemSelectionInd: startElemSelectionInd,
                endElemSelectionInd: endElemSelectionInd,
            };

            this.set(left + editedText + right);

            this.debouncedSaveHistory();

            this.selectText();
        },

        addTag: function (tagName) {
            /* Select tags are not stripped by the backend, when a text editor button is clicked we take the current
              * text in the editable area and the previously recorded selection (or cursor position if selection range
              * len is 0) and add tags with carets around them as opening and closing tags around the selected text.
              *
              * If the selected text have the match for opening and closing tags with the tagName around them, we
              * remove the tag. */

            var document = window.document;
            var inputEl = this.$input[0];
            var leftTag, rightTag, editedText, leftTagMatch, rightTagMatch, commonReplacementText, leftReplacementText,
                rightReplacementText, parentNode, startElem, endElem, startElemVal, endElemVal;
            var selectionStart = this.selectionIndices.start;
            var selectionEnd = this.selectionIndices.end;
            var startElemInd = this.selectionIndices.startElemInd;
            var endElemInd = this.selectionIndices.endElemInd;
            var startElemSelectionInd = this.selectionIndices.startElemSelectionInd;
            var endElemSelectionInd = this.selectionIndices.endElemSelectionInd;

            // Set the tags as <X> </X>
            switch (tagName) {
            case 'a':
                leftTag = '<a href="#">';
                rightTag = '</a>';
                break;
            default:
                leftTag = '<' + tagName + '>';
                rightTag = '</' + tagName + '>';
            }

            // regex's to match fast, gotta go fast
            var leftTagRegex = new RegExp('<' + tagName + '[^<>]*>');
            // previously tried removing $ to capture the matched in the form of aaa[<x>bbb</x>]ccc
            // but then we catch the first </x> in: aaaa[<x>bbbb<x>ccc</x>dddd</x>]eeeeee
            // ([] indicating the selection start and end) the solution is to match with $ in the substring
            var rightTagRegex = new RegExp(rightTag + '$');

            if (inputEl.type && inputEl.type === 'textarea') {
                return this.addTagTextarea(tagName);

            } else if (utils.browser.isChrome() || utils.browser.isSafari() || utils.browser.isOpera() || utils.browser.isEdge()) {
                parentNode = inputEl.childNodes[0];
                // #text elements in the <p> tag which we will replace, also called anchor elements
                startElem = parentNode.childNodes[startElemInd];
                endElem = parentNode.childNodes[endElemInd];

                // https://stackoverflow.com/questions/21311299/nodevalue-vs-innerhtml-and-textcontent-how-to-choose
                // textContent of the elements, nodeValue is the fastest
                startElemVal = startElem.nodeValue;
                endElemVal = endElem.nodeValue;

                // Matches within the anchor elements, returns an array of matches
                leftTagMatch = startElemVal.slice(startElemSelectionInd).match(leftTagRegex);
                // match with $ in the substring of the selection, the index will be respect to the whole string
                rightTagMatch = endElemVal.slice(0, endElemSelectionInd).match(rightTagRegex);

                // 0 based index of the whole match we use to check if it was indeed our selection indicies
                if (leftTagMatch && rightTagMatch &&
                    leftTagMatch.index === 0 &&
                    rightTagMatch.index === endElemSelectionInd - rightTag.length) {

                    // Remove tags from the selected text since the matches are at the beginning & end of selection
                    if (startElemInd === endElemInd) {
                        // same element only replace once
                        commonReplacementText = startElemVal.slice(0, startElemSelectionInd)
                            + startElemVal.slice(startElemSelectionInd, endElemSelectionInd).replace(leftTagRegex, '').replace(rightTagRegex, '')
                            + startElemVal.slice(endElemSelectionInd);
                        parentNode.replaceChild(document.createTextNode(commonReplacementText), startElem);
                        endElemSelectionInd -= leftTagMatch[0].length + rightTagMatch[0].length;
                    } else {
                        // different elements replace twice
                        leftReplacementText = startElemVal.slice(0, startElemSelectionInd) + startElemVal.slice(startElemSelectionInd).replace(leftTagRegex, '');
                        rightReplacementText = endElemVal.slice(0, endElemSelectionInd).replace(rightTagRegex, '') + endElemVal.slice(endElemSelectionInd);
                        parentNode.replaceChild(document.createTextNode(leftReplacementText), startElem);
                        parentNode.replaceChild(document.createTextNode(rightReplacementText), endElem);
                        endElemSelectionInd -= rightTagMatch[0].length;
                    }

                    // set the end selections for textinput from the edit view
                    selectionEnd -= leftTagMatch[0].length + rightTagMatch[0].length;
                } else {
                    // Add tags around the selected text
                    if (startElemInd === endElemInd) {
                        // same element replaces once
                        commonReplacementText = startElemVal.slice(0, startElemSelectionInd) + leftTag +
                            startElemVal.slice(startElemSelectionInd, endElemSelectionInd) + rightTag +
                            startElemVal.slice(endElemSelectionInd);
                        parentNode.replaceChild(document.createTextNode(commonReplacementText), startElem);
                        endElemSelectionInd += leftTag.length + rightTag.length;
                    } else {
                        // different elements replace twice
                        leftReplacementText = startElemVal.slice(0, startElemSelectionInd) + leftTag +
                            startElemVal.slice(startElemSelectionInd);
                        rightReplacementText = endElemVal.slice(0, endElemSelectionInd) + rightTag +
                            endElemVal.slice(endElemSelectionInd);
                        parentNode.replaceChild(document.createTextNode(leftReplacementText), startElem);
                        parentNode.replaceChild(document.createTextNode(rightReplacementText), endElem);
                        endElemSelectionInd += rightTag.length;
                    }

                    // set the end selections for textinput from the edit view
                    selectionEnd += leftTag.length + rightTag.length;
                }

            } else if (utils.browser.isFirefox() || utils.browser.isIE()) {
                // TODO: @taylangocmen this and the chrome section are very similar try to combine both into one method
                ////////////////////////////////////////////////////////////////////////////////////////////////////
                //                                             FF & IE
                ////////////////////////////////////////////////////////////////////////////////////////////////////

                var startP = inputEl.childNodes[this.selectionIndices.startElemInd];
                var endP = inputEl.childNodes[this.selectionIndices.endElemInd];
                startElem = startP.childNodes[0];
                endElem = endP.childNodes[0];
                startElemVal = startElem.nodeValue;
                endElemVal = endElem.nodeValue;

                // Matches within the anchor elements, returns an array of matches
                leftTagMatch = startElemVal.slice(startElemSelectionInd).match(leftTagRegex);
                // match with $ in the substring of the selection, the index will be respect to the whole string
                rightTagMatch = endElemVal.slice(0, endElemSelectionInd).match(rightTagRegex);

                // 0 based index of the whole match we use to check if it was indeed our selection indicies
                if (leftTagMatch && rightTagMatch &&
                    leftTagMatch.index === 0 &&
                    rightTagMatch.index === endElemSelectionInd - rightTag.length) {

                    // Remove tags from the selected text since the matches are at the beginning & end of selection
                    if (startElemInd === endElemInd) {
                        // same element only replace once
                        commonReplacementText = startElemVal.slice(0, startElemSelectionInd)
                            + startElemVal.slice(startElemSelectionInd, endElemSelectionInd).replace(leftTagRegex, '').replace(rightTagRegex, '')
                            + startElemVal.slice(endElemSelectionInd);
                        startP.replaceChild(document.createTextNode(commonReplacementText), startElem);
                        endElemSelectionInd -= leftTagMatch[0].length + rightTagMatch[0].length;
                    } else {
                        // different elements replace twice
                        leftReplacementText = startElemVal.slice(0, startElemSelectionInd) + startElemVal.slice(startElemSelectionInd).replace(leftTagRegex, '');
                        rightReplacementText = endElemVal.slice(0, endElemSelectionInd).replace(rightTagRegex, '') + endElemVal.slice(endElemSelectionInd);
                        startP.replaceChild(document.createTextNode(leftReplacementText), startElem);
                        endP.replaceChild(document.createTextNode(rightReplacementText), endElem);
                        endElemSelectionInd -= rightTagMatch[0].length;
                    }

                    // set the end selections for textinput from the edit view
                    selectionEnd -= leftTagMatch[0].length + rightTagMatch[0].length;
                } else {
                    // Add tags around the selected text
                    if (startElemInd === endElemInd) {
                        // same element replaces once
                        commonReplacementText = startElemVal.slice(0, startElemSelectionInd) + leftTag +
                            startElemVal.slice(startElemSelectionInd, endElemSelectionInd) + rightTag +
                            startElemVal.slice(endElemSelectionInd);
                        startP.replaceChild(document.createTextNode(commonReplacementText), startElem);
                        endElemSelectionInd += leftTag.length + rightTag.length;
                    } else {
                        // different elements replace twice
                        leftReplacementText = startElemVal.slice(0, startElemSelectionInd) + leftTag +
                            startElemVal.slice(startElemSelectionInd);
                        rightReplacementText = endElemVal.slice(0, endElemSelectionInd) + rightTag +
                            endElemVal.slice(endElemSelectionInd);
                        startP.replaceChild(document.createTextNode(leftReplacementText), startElem);
                        endP.replaceChild(document.createTextNode(rightReplacementText), endElem);
                        endElemSelectionInd += rightTag.length;
                    }

                    // set the end selections for textinput from the edit view
                    selectionEnd += leftTag.length + rightTag.length;
                }

            } else {
                ////////////////////////////////////////////////////////////////////////////////////////////////////
                //                                             else
                ////////////////////////////////////////////////////////////////////////////////////////////////////
                var text = this.get();
                var left = text.slice(0, selectionStart);
                var selectedText = text.slice(selectionStart, selectionEnd);
                var right = text.slice(selectionEnd);

                leftTagMatch = selectedText.match(leftTagRegex);
                rightTagMatch = selectedText.match(rightTagRegex);

                if (leftTagMatch && rightTagMatch &&
                    leftTagMatch.index === 0 &&
                    rightTagMatch.index === selectionEnd - selectionStart - rightTag.length) {
                    // Remove tags from the selected text since the matches are at the beginning & end of selection
                    editedText = selectedText.replace(leftTagRegex, '').replace(rightTagRegex, '');
                    selectionEnd = selectionEnd - leftTagMatch[0].length - rightTagMatch[0].length;
                } else {
                    // Add tags around the selected text
                    editedText = leftTag + selectedText + rightTag;
                    selectionEnd = selectionEnd + leftTag.length + rightTag.length;
                }

                this.set(left + editedText + right);
            }

            this.debouncedSaveHistory();

            this.selectionIndices = {
                start: selectionStart,
                end: selectionEnd,
                startElemInd: startElemInd,
                startElemSelectionInd: startElemSelectionInd,
                endElemInd: endElemInd,
                endElemSelectionInd: endElemSelectionInd,
            };

            // this was once needed for FF, may not need it after the improved version of this editor
            // will keep this for now
            // TODO: maybe remove this v
            this.selectText();
        },

        selectText: function () {
            var rangeStartElem, rangeStartInd, rangeEndElem, rangeEndInd;
            var inputEl = this.$input[0];
            var range = window.document.createRange();
            var selectionStart = this.selectionIndices.start;
            var selectionEnd = this.selectionIndices.end;
            var parentNode = inputEl.childNodes[0];
            var selection = window.getSelection();

            if (inputEl.type && inputEl.type === 'textarea') {
                // For PostEditView .textarea is a <textarea> which requires setSelectionRange for selecting edited text
                inputEl.setSelectionRange(selectionStart, selectionEnd);

            } else if (utils.browser.isChrome() || utils.browser.isSafari() || utils.browser.isOpera() || utils.browser.isEdge()) {
                // For PostReplyView .textarea is an contentEditable <div>, requires addRange for selecting edited text
                // anchor elements and the selection indicies within to create ranges

                rangeStartElem = parentNode.childNodes[this.selectionIndices.startElemInd];
                rangeStartInd = this.selectionIndices.startElemSelectionInd;
                rangeEndElem = parentNode.childNodes[this.selectionIndices.endElemInd];
                rangeEndInd = this.selectionIndices.endElemSelectionInd;

                // create the range with the anchor elements
                range.setStart(rangeStartElem, rangeStartInd);
                range.setEnd(rangeEndElem, rangeEndInd);

                // set selection
                selection.removeAllRanges();
                selection.addRange(range);

            } else if (utils.browser.isFirefox() || utils.browser.isIE()) {

                rangeStartElem = inputEl.childNodes[this.selectionIndices.startElemInd].childNodes[0];
                rangeStartInd = this.selectionIndices.startElemSelectionInd;
                rangeEndElem = inputEl.childNodes[this.selectionIndices.endElemInd].childNodes[0];
                rangeEndInd = this.selectionIndices.endElemSelectionInd;

                // create the range with the anchor elements
                range.setStart(rangeStartElem, rangeStartInd);
                range.setEnd(rangeEndElem, rangeEndInd);

                // set selection
                // https://stackoverflow.com/questions/16160996
                // solves SCRIPT606: Could not complete the operation due to error 800a025e. error on ie
                if (!utils.browser.isIE() || (selection.rangeCount > 0 && selection.getRangeAt(0).getClientRects().length > 0))
                    selection.removeAllRanges();

                selection.addRange(range);

            } else {
                // For PostReplyView .textarea is an contentEditable <div>, requires addRange for selecting edited text
                var textEl = parentNode.childNodes[0];

                range.setStart(textEl, selectionStart);
                range.setEnd(textEl, selectionEnd);

                selection.removeAllRanges();
                selection.addRange(range);
            }

            // after adding clicking a tag (different dom node than textbox) all browsers (seemingly not edge)
            // still have the focus in textbox, edge seems to change the focus to the clicked node but the caret
            // is still in the textbox, so typing and selecting events are all not firing, refocusing fixes this
            // ie & ffr: focusing out of the textbox element in edge

            // textarea also focuses out, only used in comment editing
            if (utils.browser.isEdge() || (inputEl.type && inputEl.type === 'textarea'))
                this.focus();
        },

        debouncedSaveHistory: _.debounce(function () {
            var newValue = this.toJSON()[0];
            if (newValue !== this.history[this.historyPosition]) {
                if (this.historyPosition !== this.history.length - 1)
                    this.history = this.history.slice(0, this.historyPosition + 1);
                this.history.push(newValue);
                this.historyPosition += 1;
            }
        }, 200),

        undoTextarea: function () {
            if (this.historyPosition > 0) {
                this.historyPosition -= 1;
                this.set(this.history[this.historyPosition]);
                this.fixInputStructure();
                this.focusEndOfText();
            }
        },

        redoTextarea: function () {
            if (this.historyPosition < this.history.length - 1) { // not the last one
                this.historyPosition += 1;
                this.set(this.history[this.historyPosition]);
                this.fixInputStructure();
                this.focusEndOfText();
            }
        },
    }, {
        MAX_TEXTAREA_HEIGHT: 350,  // px
        SAVE_DRAFT_INTERVAL: 500,  // ms
        DRAFT_MAX_AGE: 1000 * 60 * 60 * 24,  // 1 day in ms
        storage: new CappedStorage(5, 'drafts.queue'),
    });

    return TextareaView;
});

define('core/views/ContentEditableView',[
    'jquery',
    'underscore',
    'core/editable',
    'core/views/TextareaView',
], function (
    $,
    _,
    Editable,
    TextareaView
) {
    'use strict';

    var doc = window.document;

    var parent = TextareaView;
    var parentProto = parent.prototype;

    var ContentEditableView = parent.extend({
        events: _.defaults({
            'focusout [data-role=editable]': 'handleFocusOut',
            'click .placeholder': 'handlePlaceholderClick',
        }, parentProto.events),

        initialize: function () {
            parentProto.initialize.apply(this, arguments);

            this.hasFocus = false;
            this._selectionRange = null;
        },

        saveSelection: function () {
            var sel = window.getSelection();
            this._selectionRange = sel && sel.rangeCount && sel.getRangeAt(0);
        },

        restoreSelection: function () {
            if (!this._selectionRange)
                return;

            var sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(this._selectionRange);

            this._selectionRange = null;
        },

        render: function () {
            this.$input = this.createInput();
            this.$el.append(this.$input);
            this.set(this.value);
            this.renderPlaceholder();
            return this;
        },

        createInput: function () {
            var $input = $('<div>').attr({
                'class': 'textarea',
                'tabIndex': 0,
                'role': 'textbox',
                'aria-multiline': 'true',
                'contenteditable': 'PLAINTEXT-ONLY',
                'data-role': 'editable',
            }).css({
                'overflow': 'auto',
                'word-wrap': 'break-word',
                // MAX_TEXTAREA_HEIGHT inherited from parent constructor (TextareaView)
                'max-height': this.constructor.MAX_TEXTAREA_HEIGHT + 'px',
            });

            var input = $input[0];

            // NOTE: See http://stackoverflow.com/a/18316972/90297 for the 'plaintext-only' thing
            if (input.contentEditable !== 'plaintext-only')
                input.contentEditable = 'true';

            this.content = new Editable(input, true);

            return $input;
        },

        renderPlaceholder: function () {
            // contentEditable doesn't work w/ HTML5 input placeholders
            var placeholder = this.placeholder;
            if (!placeholder)
                return;

            // NOTE: Placeholder is **not** HTML escaped!

            // Set the placeholder as aria-label to make it accessible to
            // screen readers. They won't recognize a "placeholder"
            // attribute on a span or div.
            this.$input.attr('aria-label', placeholder);
            this.$placeholder = $('<span class="placeholder">' + placeholder + '</span>');
            this.updatePlaceholderDisplay();
        },

        // Show or hide the placeholder, dependent on
        // state of textarea focus and content.
        updatePlaceholderDisplay: function () {
            if (!this.$placeholder)
                return;

            if (!this.hasFocus && !this.content.text())
                this.$el.prepend(this.$placeholder);
            else
                this.$placeholder.remove();
        },

        handlePlaceholderClick: function () {
            // Note that clicking on placeholder doesn't focus inside
            // actual textarea body; we need to do that ourselves

            // NOTE: This will trigger the handleFocusIn event below
            this.$input.focus();
        },

        handleFocusIn: function () {
            parentProto.handleFocusIn.call(this);

            this.restoreSelection();

            this.hasFocus = true;
            this.updatePlaceholderDisplay();
        },

        handleFocusOut: function () {
            this.saveSelection();
            this.hasFocus = false;
            this.updatePlaceholderDisplay();
        },

        /**
         * Get unformatted comment text
         *
         * @returns {string} Unformatted/stripped content text (plain text)
         */
        get: function () {
            return this.content.text();
        },

        /**
         * Get selected text.
         *
         * Note that this method ignores newlines
         *   @returns {string} Selected string or empty string if it fails.
         */
        getSelected: function () {
            if (this.hasFocus && window.getSelection)
                return window.getSelection().toString();
            else if (this._selectionRange)
                return this._selectionRange.toString();

            return '';
        },

        /**
         * Get index of cursor in text returned by .get.
         *
         * Ex. If the text box contains
         *     The[cursor] quick brown fox jumps over...
         * Then .offset() will return 3.
         *
         * @returns {number} The current cursor offset
         */
        offset: function () {
            return this.content.offset();
        },

        /**
         * Set unformatted comment text
         *
         * @param {string} str The plain text to be set as the content
         */
        set: function (str) {
            this.content.setText(str);
            this.resize();
            this.updatePlaceholderDisplay();
        },

        insertAtCursor: function (str) {
            // See http://phabricator.local.disqus.net/D18445#314506
            //
            // If the contentEditable div does not have focus when
            // insertNode is called (below), then insertNode could
            // insert the node anywhere on the page, wherever the user
            // has selected, i.e., whatever window.getSelection returns
            this.focus();

            // Include whitespace around string to separate from other text
            var text = ' ' + str + ' ';

            // Attempt to use insertText, which will insert the text
            // in a similar way to how the user would type it in.
            if (doc.queryCommandSupported && doc.queryCommandSupported('insertText')) {
                if (doc.execCommand('insertText', false, text))
                    return;
            }

            // Fallback if unable to use execCommand
            this.content.insertNode(doc.createTextNode(text));
        },

        clear: function () {
            parentProto.clear.call(this);
            _.defer(function (self) {
                self.$input.blur();  // mostly necessary for Chrome which keeps focus
            }, this);
        },

        insertAroundSelection: function (beforeText, afterText) {
            // See http://phabricator.local.disqus.net/D18445#314506
            //
            // If the contentEditable div does not have focus when
            // insertNode is called (below), then insertNode could
            // insert the node anywhere on the page, wherever the user
            // has selected, i.e., whatever window.getSelection returns
            this.focus();

            var selection = window.getSelection();
            // if rangeCount is 0, there is no selection to wrap
            if (!selection.rangeCount)
                return;

            var range = selection.getRangeAt(0);

            // Insert tags
            var afterRange = range.cloneRange();
            afterRange.collapse(false);
            var afterNode = doc.createTextNode(afterText);
            afterRange.insertNode(afterNode);

            var beforeRange = range.cloneRange();
            beforeRange.collapse(true);
            var beforeNode = doc.createTextNode(beforeText);
            beforeRange.insertNode(beforeNode);

            // Select original text again
            // NOTE: Does not maintain selection direction
            range.setStart(beforeNode, beforeText.length);
            range.setEnd(afterNode, 0);
            selection.removeAllRanges();
            selection.addRange(range);
        },
    });

    return ContentEditableView;
});

define('home/templates/postReply',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"avatar\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = (depth0 != null ? lookupProperty(depth0,"user") : depth0)) != null ? lookupProperty(stack1,"isRegistered") : stack1),{"name":"if","hash":{},"fn":container.program(2, data, 0),"inverse":container.program(4, data, 0),"data":data,"loc":{"start":{"line":9,"column":0},"end":{"line":15,"column":7}}})) != null ? stack1 : "")
    + "</div>\n";
},"2":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = container.invokePartial(lookupProperty(partials,"userAvatar"),(depth0 != null ? lookupProperty(depth0,"user") : depth0),{"name":"userAvatar","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "");
},"4":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<span class=\"user\">\n<img data-role=\"user-avatar\" src=\""
    + container.escapeExpression(container.lambda(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"user") : depth0)) != null ? lookupProperty(stack1,"avatar") : stack1)) != null ? lookupProperty(stack1,"cache") : stack1), depth0))
    + "\"/>\n</span>\n";
},"6":function(container,depth0,helpers,partials,data) {
    return "style=\"margin-left: 0\"";
},"8":function(container,depth0,helpers,partials,data) {
    return "<div class=\"media-preview empty\" data-role=\"media-preview\"></div>\n";
},"10":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"post-actions\">\n<ul class=\"wysiwyg\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"displayMediaUploadButton") : depth0),{"name":"if","hash":{},"fn":container.program(11, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":33,"column":0},"end":{"line":35,"column":7}}})) != null ? stack1 : "")
    + "</ul>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"user") : depth0)) != null ? lookupProperty(stack1,"isRegistered") : stack1),{"name":"if","hash":{},"fn":container.program(13, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":38,"column":0},"end":{"line":48,"column":7}}})) != null ? stack1 : "")
    + "</div>\n";
},"11":function(container,depth0,helpers,partials,data) {
    return "<li data-role=\"media-uploader\"></li>\n";
},"13":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"logged-in\">\n<section>\n<div class=\"temp-post\" style=\"text-align: right\">\n<button class=\"btn\">\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(alias1,"Post as %(username)s",{"name":"gettext","hash":{"username":lookupProperty(helpers,"getPartial").call(alias1,"userSpan",(depth0 != null ? lookupProperty(depth0,"user") : depth0),{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":43,"column":44},"end":{"line":43,"column":72}}})},"data":data,"loc":{"start":{"line":43,"column":0},"end":{"line":43,"column":74}}}))
    + "\n</button>\n</div>\n</section>\n</div>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"alert error\" style=\"display:none\" role=\"alert\">\n<a class=\"close\" data-action=\"dismiss-alert\" title=\""
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Dismiss",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":2,"column":52},"end":{"line":2,"column":73}}}))
    + "\">×</a>\n<span></span>\n</div>\n\n<div class=\"postbox\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"showAvatar") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":7,"column":0},"end":{"line":17,"column":7}}})) != null ? stack1 : "")
    + "\n<div class=\"textarea-wrapper\" "
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"showAvatar") : depth0),{"name":"unless","hash":{},"fn":container.program(6, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":19,"column":30},"end":{"line":19,"column":85}}})) != null ? stack1 : "")
    + "\ndata-role=\"textarea\" dir=\"auto\">\n<div data-role=\"drag-drop-placeholder\" class=\"media-drag-hover\" style=\"display: none\">\n<div class=\"drag-text\">\n&#11015; "
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Drag and drop your images here to upload them.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":23,"column":9},"end":{"line":23,"column":69}}}))
    + "\n</div>\n</div>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"displayMediaPreviews") : depth0),{"name":"if","hash":{},"fn":container.program(8, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":26,"column":0},"end":{"line":28,"column":7}}})) != null ? stack1 : "")
    + "<div class=\"edit-alert\" role=\"postbox-alert\"></div>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"showSubmitButton") : depth0),{"name":"if","hash":{},"fn":container.program(10, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":30,"column":0},"end":{"line":50,"column":7}}})) != null ? stack1 : "")
    + "</div>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/templates/blacklistErrorMessage',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"We are unable to post your comment because %(blocker)s has placed your account in a timeout. You will be able to comment again when your timeout expires.",{"name":"gettext","hash":{"blocker":(depth0 != null ? lookupProperty(depth0,"blocker") : depth0)},"data":data,"loc":{"start":{"line":2,"column":0},"end":{"line":2,"column":183}}}))
    + "\n";
},"3":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"We are unable to post your comment because you have been banned by %(blocker)s.",{"name":"gettext","hash":{"blocker":(depth0 != null ? lookupProperty(depth0,"blocker") : depth0)},"data":data,"loc":{"start":{"line":4,"column":0},"end":{"line":4,"column":110}}}))
    + "\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"isTemp") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"data":data,"loc":{"start":{"line":1,"column":0},"end":{"line":5,"column":7}}})) != null ? stack1 : "")
    + "<a target=\"_blank\" href=\"https://help.disqus.com/customer/portal/articles/466223-who-deleted-or-removed-my-comment-\">"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(alias1,"Find out more.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":6,"column":117},"end":{"line":6,"column":146}}}))
    + "</a>\n";
},"useData":true})

});
define('home/templates/mustVerifyEmail',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    return "Disqus.com requires you to\n<a href=\"#\" data-action=\"verify-email\">verify your email address</a> before posting\n";
},"useData":true})

});
define('home/views/PostReplyView',[
    'jquery',
    'underscore',
    'backbone',

    'core/bus',
    'core/mixins/withAlert',
    'core/mixins/withUploadForm',
    'core/strings',
    'core/views/ContentEditableView',
    'core/views/TextareaView',

    'home/templates/postReply',
    'home/templates/blacklistErrorMessage',
    'home/templates/mustVerifyEmail',
], function (
    $,
    _,
    Backbone,

    bus,
    withAlert,
    withUploadForm,
    strings,
    ContentEditableView,
    TextareaView,

    postReplyTemplate,
    blacklistErrorMessageTemplate,
    mustVerifyEmailTemplate
) {
    'use strict';

    var gettext = strings.get;

    var PostReplyView = Backbone.View.extend({
        tagName: 'form',

        className: 'reply-form',

        events: {
            'click [data-action=cancel]': 'hide',
            'submit': 'submitForm',
        },

        postboxAlertSelector: '[role=postbox-alert]',

        initialize: function (options) {
            this.session = options.session;
            this.thread = options.thread;
            this.showSubmitButton = options.showSubmitButton !== false;
            this.showAvatar = options.showAvatar !== false;
            this.placeholderText = options.placeholder;
            this.canUseContentEditable = options.canUseContentEditable;
            this.showMediaPreviews = options.showMediaPreviews;
            this.showMustVerifyAlert = options.showMustVerifyAlert !== false;

            // TODO: Do not use postboxAlertSelector as the default;
            // the default alert location is expected to be above
            // the textarea, while postboxAlertSelector is below
            this.setAlertSelector(this.postboxAlertSelector);

            this._isHidden = false;

            this.listenTo(this.model, {
                'error': this.onerror,
            });

            // When model gets valid id, it means it has been successfully
            // saved to the server
            this.listenTo(this.model, 'change:id', function () {
                if (!this.model.id)
                    return;

                this.textarea.removeDraft();
            });
        },

        redraw: function () {
            var isExpanded = this.$el.hasClass('expanded');
            var oldEl = this.el;
            var msg = this.$el.find('textarea').val();

            this.render();

            this.$el.find('textarea').val(msg);

            if (isExpanded)
                this.$el.addClass('expanded');

            // Hasn't been appended to DOM yet; no need to update
            if ($(oldEl).parent().length === 0)
                return;

            // If it has, we need to replace the existing DOM element
            // with the new one
            oldEl.parentNode.replaceChild(this.el, oldEl);
        },

        getPlaceholderText: function () {
            return this.placeholderText || 'Discuss…';
        },

        render: function () {
            var $el = this.$el;

            var mediaembedEnabled = this.showMediaPreviews &&
                this.thread.forum.get('settings').mediaembedEnabled;
            var gifPickerEnabled = this.thread.forum.get('settings').gifPickerEnabled;
            var allowUploads = mediaembedEnabled && this.uploadSupported;

            $el.html(postReplyTemplate({
                showAvatar: this.showAvatar,
                showSubmitButton: this.showSubmitButton,
                user: this.session.toJSON(),
                displayMediaPreviews: mediaembedEnabled || gifPickerEnabled,
                displayMediaUploadButton: allowUploads,
            }));

            if (this.model.get('parent'))
                $el.addClass('expanded');
            else
                $el.removeClass('expanded');

            $el.addClass('authenticated');

            this.initTextarea();

            this.initMediaViews({
                mediaembedEnabled: mediaembedEnabled,
                gifPickerEnabled: gifPickerEnabled,
                allowUploads: allowUploads,
                textarea: this.textarea,
            });

            if (this.showMustVerifyAlert &&
                this.constructor.mustVerifyEmailToPost(this.session.user))
                this._alertMustVerify();

            if (this._isHidden)
                $el.addClass('hidden');

            return this;
        },

        initTextarea: function () {
            var TextareaViewClass = this.canUseContentEditable ?
                ContentEditableView :
                TextareaView;

            var textarea = this.textarea = new TextareaViewClass({
                placeholder: this.getPlaceholderText(),
                userSuggestions: this.userSuggestions,

                // If the model has raw_message, it means that we are editing
                // an existing post, rather than creating a new one.
                value: this.model.get('raw_message'),

                storageKey: this.model.storageKey(),
            });

            this.$('[data-role=textarea]').prepend(textarea.render().el);

            this.listenTo(textarea, {
                focus: function () {
                    this.$el.addClass('expanded');

                    // Use _.delay instead of updateDom before triggering resize,
                    // because the 'expanded' class triggers a CSS animation (duration 200ms),
                    // and we can't detect when the animation finishes with JS
                    _.delay(_.bind(this.resize, this), 200);
                },

                blur: function () {
                    this.trigger('blur');
                },
            });
        },

        resize: function () {
            this.textarea.resize();
        },

        focus: function () {
            this.textarea.focus();
        },

        /**
         * Called after a form is submitted; clears the form (and hides it, depending
         * on context)
         */
        clear: function () {
            var self = this;
            self.textarea.clear();

            self.clearMediaPreviews();

            self.$el.removeClass('expanded');

            if (self.model.get('parent'))
                self.hide();
        },

        restore: function (post) {
            var self = this;

            self.textarea.set(post.get('raw_message'));

            // focus in on textarea so that placeholder is removed
            self.textarea.handleFocusIn();

            _.delay(function () {
                self.resize();
            }, 200);

            if (self.model.get('parent'))
                self.show();
        },

        _alertMustVerify: function (error) {
            // This is really gross, but I don't know a better "easy to translate"
            // why of getting the anchor into here.

            var msg = mustVerifyEmailTemplate();

            this.alert(msg, {
                safe: true,
                type: error ? 'error' : 'warn',
                target: error ? this.postboxAlertSelector : null,
            });
        },

        submitForm: function (ev) {
            ev.preventDefault();
            this.dismissAlert();
            return this.createPost();
        },

        onerror: function (_model, response) {
            var self = this;
            var post = this.model;
            var errorMessage;

            if (response.code === 12 && /temporarily do not have permission to post on this thread/.test(response.response)) {
                errorMessage = blacklistErrorMessageTemplate({
                    blocker: this.thread.forum.get('name'),
                    isTemp: true,
                });

                this.alert(errorMessage, { type: 'error', target: this.postboxAlertSelector, safe: true });

            } else if (response.code === 12 && /not have permission to post on this thread/.test(response.response)) {
                errorMessage = blacklistErrorMessageTemplate({
                    blocker: self.session.user.get('isOnGlobalBlacklist') ? 'Disqus' : self.thread.forum.get('name'),
                    isTemp: false,
                });

                self.alert(errorMessage, { type: 'error', target: self.postboxAlertSelector, safe: true });

            } else if (response.code === 12 && /verify/.test(response.response)) {

                self._alertMustVerify(true);

            } else if (_.isString(response.response)) {
                // NOTE: Error responses returned by the API aren't exactly
                //       human-friendly. But we *really* should never hit this
                //       area unless a rare error has occurred. Consider this
                //       an "error of last resort".
                //
                // Sample response:
                // "Invalid argument, 'author_email': Invalid email address"

                self.alert(response.response, { type: 'error', target: self.postboxAlertSelector });
            } else {

                // If we didn't get a response from the server at all we
                // display a generic connection error message.
                self.alert(gettext('Oops! We\'re having trouble posting your comment. Check your internet connection and try again.'), {
                    type: 'error',
                    target: self.postboxAlertSelector,
                });
            }

            self.restore(post);
        },

        createPost: function () {
            var post = this.model;
            this.dismissAlert();

            // If we have ongoing image uploads
            if (this.isUploadInProgress()) {
                return void this.alert(
                    gettext('Please wait until your images finish uploading.'),
                    { type: 'error', target: this.postboxAlertSelector }
                );
            }

            var success = post.save({
                raw_message: this.textarea.get(),
            });

            if (!success) {
                return void this.alert(post.validationError, {
                    type: 'error',
                    target: this.postboxAlertSelector,
                });
            }

            success.done(function () {
                bus.trigger('uiCallback:postCreated', post);
            });

            this.clear();

            return post;
        },

        toggle: function () {
            if (this.isOpen())
                this.hide();
            else
                this.show();
        },

        show: function () {
            var self = this;
            self._isHidden = false;
            self.$el.removeClass('hidden');
            self.trigger('show');
        },

        hide: function () {
            var self = this;
            self._isHidden = true;
            self.dismissAlert();
            self.$el.addClass('hidden');
            self.trigger('hide');
        },

        isOpen: function () {
            return !this._isHidden;
        },
    }, {
        /**
         * Checks if the user needs to verify her email address before
         * posting.
         *
         * @param  {Backbone.Model} user - the user to check
         * @returns {boolean}
         */
        mustVerifyEmailToPost: function (user) {
            return !user.get('isVerified');
        },
    });

    withAlert.call(PostReplyView.prototype);
    withUploadForm.call(PostReplyView.prototype);

    return PostReplyView;
});

define('home/ReplyViewManager',[
    'underscore',
    'jquery',
    'backbone',
    'home/utils/features',
    'home/models/Post',
    'home/models/Session',
    'home/views/PostReplyView',
], function (
    _,
    $,
    Backbone,
    featureUtils,
    Post,
    Session,
    PostReplyView
) {
    'use strict';

    function ReplyViewManager(parentPostView) {
        this.view = parentPostView;
        this.model = this.view.model;

        this.listenTo(this.view, 'close', function () {
            this.stopListening();
        });
    }

    var protoFuncs = {
        /**
         * This is intended to be the only public method of this class.
         * Shows and hides the postbox (aka PostReplyView)
         * @param  {HTMLElement} replyToggleEl the link/button clicked to open the post box
         */
        toggleReplyView: function (replyToggleEl) {
            var $replyToggle = $(replyToggleEl);

            if (this.replyView) {
                this.replyView.toggle();
            } else {
                this.replyView = this.createReplyView().render();
                $replyToggle.parent().after(this.replyView.el);
            }

            if (!this.replyView._isHidden)
                this.replyView.focus();
        },

        /**
         * Convert reply box to a post view.
         * @private
         * @param  {Post} model the post just submitted
         */
        vivifyReply: function (model) {
            var view = new this.view.constructor({
                model: model,
                session: Session.get(),
            });

            this.replyView.$el.after(view.render().el);
            view.trigger('show');
            this.replyView.remove();
            this.replyView = null;
        },

        /**
         * Creates a new postbox with a new post model and sets up a listener
         * to handle when the postbox is successfully submitted (ie, when its
         * model gets successfully saved to the server)
         * @private
         * @returns {PostReplyView}
         */
        createReplyView: function () {
            var reply = new Post({
                thread: this.model.thread.id,
                parent: this.model.id,
                depth: this.model.get('depth') + 1,
                author: Session.get().user.id,
            });

            this.listenTo(reply, 'change:id', this.vivifyReply);

            return new PostReplyView({
                model: reply,
                thread: reply.thread,
                session: Session.get(),
                canUseContentEditable: featureUtils.canUseContentEditable(),
                showMediaPreviews: true,
            });
        },
    };

    _.extend(ReplyViewManager.prototype, protoFuncs, Backbone.Events);

    return ReplyViewManager;
});

define('core/views/VotersCard',[
    'underscore',
    'core/views/common/HoverCard',
    'core/views/UsersCard',
    'core/utils',
], function (
    _,
    HoverCard,
    UsersCard,
    utils
) {
    'use strict';

    var handler = utils.preventDefaultHandler;

    // VotersCard shows list of users who upvoted some particular comment
    var VotersCard = UsersCard.extend({
        guestTextPartialName: 'cardGuestVoterText',

        initialize: function (options) {
            this.voteType = options.voteType;
            var model = options.model;
            var collection = this.voteType === 1 ? model.getUpvotersUserCollection() : model.getDownvotersUserCollection();

            _.extend(options, {
                collection: collection,
                numUsers: this.voteType === 1 ? model.get('likes') : model.get('dislikes'),
            });

            UsersCard.prototype.initialize.call(this, options);

            this.model = model;
            this.session = options.session;
            this.likes = model.get('likes');
            this.dislikes = model.get('dislikes');
            this.hadLikes = Boolean(this.likes);  // preserve initial state of likes
            this.hadDislikes = Boolean(this.dislikes);  // preserve initial state of dislikes

            this._fetched = false;
            this._rendered = false;

            this.listenTo(this.model, 'change:userScore', this.updateUserSet);
            if (this.voteType === 1)
                this.listenTo(this.model, 'change:likes', this.updateGuests);
            else
                this.listenTo(this.model, 'change:dislikes', this.updateGuests);
        },

        updateGuests: function () {
            // Update the value of numUsers to remain synced with likes
            // when the value of likes has changed.
            this.numUsers = (this.voteType === 1 ? this.model.get('likes') : this.model.get('dislikes')) || 0;
            UsersCard.prototype.updateGuests.call(this);
        },

        // Updates the set of users to contain/not contain the session user
        // based on his current vote status for this post.
        updateUserSet: function () {
            var user = this.session.user;

            var hadLikes = this.likes;
            var hadDislikes = this.dislikes;
            var heightIncrease = false;

            this.likes = this.model.get('likes');
            this.dislikes = this.model.get('dislikes');

            // add or remove current user from the list
            if (this.model.get('userScore') === this.voteType) {
                // users collection should not contain Guest users
                // NOTE: Backbone ignores duplicate adds by default (we want this)
                if (this.session.isLoggedIn())
                    this.collection.add(user);

                // update list visibility depending on absence/presence of likes
                if ((this.voteType === 1 && this.likes && !hadLikes) || (this.voteType === -1 && this.dislikes && !hadDislikes)) {
                    this._rendered = false;
                    this.show();
                } else { // if there were some likes previously, just add current user
                    // height will increase when we either add current user or
                    // if current user is a Guest and there are no guets upvotes yet
                    heightIncrease = this.session.isLoggedOut() ?
                        true : Boolean((this.voteType === 1 ? this.likes : this.dislikes) - 1 - this.collection.length);
                }
            } else {
                this.collection.remove(user);
                // if there is no likes - tooltip should be hidden
                if ((this.voteType === 1 && !this.likes) || (this.voteType === -1 && !this.dislikes))
                    this.hide();
            }
            this.updateGuests();
            // fix list position after UI changes
            this.moveTo(this.$target, heightIncrease);
        },

        show: function () {
            // if there is no likes - there is no reason to show the card
            // if the card is already visible - there is no need to do something else
            if ((this.voteType === 1 && !this.likes) || (this.voteType === -1 && !this.dislikes) || this.isVisible())
                return;

            // if there was no likes - there is no reason to make another request
            if ((this.voteType === 1 && !this.hadLikes) || (this.voteType === -1 && !this.hadDislikes))
                this._fetched = true;

            // if we haven't fetched data yet - do the request
            if (!this._fetched) {
                this.collection.fetch({ vote: this.voteType })
                    .done(_.bind(function () {
                        this._fetched = true;
                        this.show();
                    }, this));

                return;
            }

            // In case when current user upvoted the comment earlier than data
            // arrives from the server - we should make sure he appears in the
            // list correctly.
            var user = this.session.user;
            if (this.model.get('userScore') === this.voteType && this.session.isLoggedIn() && !this.collection.contains(user))
                this.collection.add(user);

            // show/render list of voters
            UsersCard.prototype.show.call(this);
        },

        handleShowProfile: handler(function (evt) {
            UsersCard.prototype.handleShowProfile.call(this, evt);
        }),

        getTemplateData: function () {
            var data = UsersCard.prototype.getTemplateData.apply(this, arguments);
            return _.extend({}, data, {
                forumId: this.model.get('forum'),
            });
        },

        getUserTemplateData: function () {
            var data = UsersCard.prototype.getUserTemplateData.apply(this, arguments);
            return _.extend({}, data, {
                forumId: this.model.get('forum'),
            });
        },
    }, {
        create: function (options) {
            // Do not create card if we cannot prevent it from being duplicated
            var post = options.model;

            if (!post.has('id'))
                return;

            return HoverCard.create([post.get('id'), '-', options.voteType].join(''), options, 'VotersCard', VotersCard);
        },
    });

    return VotersCard;
});

define('core/views/Tooltip',[
    'jquery',
    'core/views/common/HoverCard',
], function (
    $,
    HoverCard
) {
    'use strict';

    /**
     * Simple HoverCard, shown on hover, hidden when cursor moves away.
     * Can be given either a template or plainttext to show.
     */
    var Tooltip = HoverCard.extend({
        className: 'tooltip-outer message-card',

        initialize: function (options) {
            HoverCard.prototype.initialize.call(this, options);

            this.template = options.template;
            this.message = options.message;
        },

        render: function () {
            if (this.template)
                this.$el.html(this.template());
            else if (this.message)
                this.$el.html($('<div>').addClass('tooltip').text(this.message));
            else
                return;

            HoverCard.prototype.render.call(this);
        },

        // Shows the tooltip on top
        moveTo: function (target) {
            if (!target)
                return;

            var posOffset = this.constructor.POSITION_OFFSET;
            var pos = target.offset();
            var containerPos = this.getContainerPosition();
            var tooltipWidth = this.$el.width();

            this.$el.css({
                bottom: containerPos.containerOffset.height - pos.top + posOffset,
                top: 'inherit',
                left: pos.left - tooltipWidth / 2,
            });
        },
    }, {
        create: function (options) {
            return HoverCard.create(options.id, options, 'Tooltip', Tooltip);
        },

        POSITION_OFFSET: 10,
    });

    return Tooltip;
});

define('core/views/ClickTooltip',[
    'underscore',
    'core/views/common/HoverCard',
    'core/views/Tooltip',
], function (
    _,
    HoverCard,
    Tooltip
) {
    'use strict';

    /**
     * Implemented as a Tooltip, but overrides the show condition to only
     * show when target clicked instead of on hover. Still hides when cursor
     * is moved away from target or tooltip.
     * Must be given a template to show.
     */
    var ClickTooltip = Tooltip.extend({
        // Show on click, not on hover
        target: function ($target) {
            $target.on('click', _.bind(this.targetClicked, this, $target));
            $target.on('mouseleave', _.bind(this.leave, this));

        },

        targetClicked: function ($target) {
            if ($target)
                this.$target = $target;

            if (this._hoverState === 'in')
                return;

            this._hoverState = 'in';
            this.show();

            Tooltip.open[this.uid] = this;
        },
    }, {
        create: function (options) {
            return HoverCard.create(options.id, options, 'ClickTooltip', ClickTooltip);
        },
    });

    return ClickTooltip;
});

define('home/templates/anonUpvoteCard',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"tooltip\">\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"You must sign in to up-vote this post.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":2,"column":0},"end":{"line":2,"column":52}}}))
    + "\n</div>\n";
},"useData":true})

});
define('home/templates/anonDownvoteCard',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"tooltip\">\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"You must sign in to down-vote this post.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":2,"column":0},"end":{"line":2,"column":54}}}))
    + "\n</div>\n";
},"useData":true})

});
define('core/constants/voteConstants',[
    'exports',
], function (
    exports
) {
    'use strict';

    // Warning: By default `forum.votingType` will be null
    exports.VOTING_TYPES = {
        DETAILED: 0,
        DOWNVOTE_LIMITED: 1,
        DOWNVOTE_DISABLED: 2,
        DISABLED: 3,
    };

    exports.DEFAULT_VOTING_TYPE = exports.VOTING_TYPES.DETAILED;
});

define('home/views/PostActionsView',[
    'jquery',
    'backbone-marionette',
    'home/templates/postActions',
    'home/ReplyViewManager',
    'home/models/Session',
    'core/views/VotersCard',
    'core/views/ClickTooltip',

    'home/templates/anonUpvoteCard',
    'home/templates/anonDownvoteCard',

    'core/bus',
    'core/constants/voteConstants',
    'core/utils',
], function (
    $,
    Marionette,
    postActionsTemplate,
    ReplyViewManager,
    Session,
    VotersCard,
    ClickTooltip,

    anonUpvoteCardTemplate,
    anonDownvoteCardTemplate,

    bus,
    voteConstants,
    utils
) {
    'use strict';

    var PostActionView = Marionette.ItemView.extend({
        template: postActionsTemplate,
        templateHelpers: function () {
            return {
                discussionRoute: this.model.thread.permalink(),
                sessionUserHasUpvoted: this.model.get('userScore') > 0,
                sessionUserHasDownvoted: this.model.get('userScore') < 0,
                wasAuthoredBySessionUser: this.model.author.isSessionUser(),
                isLoggedIn: Session.get().isLoggedIn(),
                isWithinEditPeriod: (new Date()).toISOString() < this.model.get('editableUntil'),
                showDownvoteCount: this.model.get('dislikes') &&
                    this.model.thread.forum.get('votingType') !== voteConstants.VOTING_TYPES.DOWNVOTE_LIMITED,
                showDownvote: this.model.thread.forum.get('votingType') !== voteConstants.VOTING_TYPES.DOWNVOTE_DISABLED &&
                    this.model.thread.forum.get('votingType') !== voteConstants.VOTING_TYPES.DISABLED,
                showUpvote: this.model.thread.forum.get('votingType') !== voteConstants.VOTING_TYPES.DISABLED,
            };
        },

        events: {
            'click [data-action=vote]': 'vote',
            'click [data-action=reply]': 'toggleReplyView',
            'click [data-action=edit]': 'trackEdit',
        },

        initialize: function (options) {
            this.session = Session.get();
            this.initializeReplyViewManager(options);
        },

        initializeReplyViewManager: function (options) {
            this.replyViewManager = new ReplyViewManager(options.parentPostView);
        },

        onRender: function () {
            this.initVotersCard();
            this.initAnonVoteCards();
        },

        initAnonVoteCards: function () {
            // Don't show anon vote tooltip if user is not anon, or
            // if forum allows anon voting
            if (!Session.isKnownToBeLoggedOut() ||
                this.model.thread.forum.get('settings').allowAnonVotes)
                return;

            if (this.anonUpvoteCard)
                this.anonUpvoteCard.remove();

            var $target = this.$('[data-action=vote][data-vote=1]');
            if (!$target.length)
                return;

            this.anonUpvoteCard = ClickTooltip.create({
                targetElement: $target,
                template: anonUpvoteCardTemplate,
                id: 'anonUpvote',
            });

            this.listenTo(this.anonUpvoteCard, 'show', this.closeUpvotersCard);

            if (this.anonDownvoteCard)
                this.anonDownvoteCard.remove();

            $target = this.$('[data-action=vote][data-vote=-1]');
            if (!$target.length)
                return;

            this.anonDownvoteCard = ClickTooltip.create({
                targetElement: $target,
                template: anonDownvoteCardTemplate,
                id: 'anonDownvote',
            });

            this.listenTo(this.anonDownvoteCard, 'show', this.closeDownvotersCard);
        },

        closeUpvotersCard: function () {
            if (!this.upvoteHoverCard)
                return;

            this.upvoteHoverCard.hide();
        },

        closeDownvotersCard: function () {
            if (!this.downvoteHoverCard)
                return;

            this.downvoteHoverCard.hide();
        },

        initVotersCard: function () {
            // We don't use voter cards on devices with mobile-like UA strings.
            if (utils.isMobileUserAgent())
                return;

            if (this.upvoteHoverCard)
                this.upvoteHoverCard.remove();

            if (this.downvoteHoverCard)
                this.downvoteHoverCard.remove();

            var upvoteTarget = this.$('[data-action=vote][data-vote=1]');
            var downvoteTarget = this.$('[data-action=vote][data-vote=-1]');
            var forumVotingType = this.model.thread.forum.get('votingType');

            if (upvoteTarget.length && forumVotingType !== voteConstants.VOTING_TYPES.DISABLED) {
                this.upvoteHoverCard = VotersCard.create({
                    targetElement: upvoteTarget,
                    model: this.model,
                    session: this.session,
                    voteType: 1,
                });
            }

            if (downvoteTarget.length && (forumVotingType === null || forumVotingType === undefined ||
                forumVotingType === voteConstants.VOTING_TYPES.DETAILED)) {
                this.downvoteHoverCard = VotersCard.create({
                    targetElement: downvoteTarget,
                    model: this.model,
                    session: this.session,
                    voteType: -1,
                });
            }
        },

        vote: function (evt) {
            // Don't allow voting if user is anon and forum does not
            // allow anon voting
            if (!evt ||
                (!this.model.thread.forum.get('settings').allowAnonVotes &&
                    Session.isKnownToBeLoggedOut()))
                return;

            evt.preventDefault();
            evt.stopPropagation();

            var $anchor = $(evt.currentTarget);
            var vote = parseInt($anchor.data('vote'), 10);

            // Is the user undoing a vote?
            var isUndo = this.model.get('userScore') === vote;
            if (isUndo)
                bus.trigger('uiAction:postUnvote', this.model, evt);
            else if (vote === 1)
                bus.trigger('uiAction:postUpvote', this.model, evt);
            else if (vote === -1)
                bus.trigger('uiAction:postDownvote', this.model, evt);

            this.model.vote(isUndo ? 0 : vote);
            this.$('[data-vote=1]').toggleClass('active', this.model.get('userScore') === 1);
            this.$('[data-vote=-1]').toggleClass('active', this.model.get('userScore') === -1);

            var forumVotingType = this.model.thread.forum.get('votingType');
            if (forumVotingType !== voteConstants.VOTING_TYPES.DISABLED)
                this.$('[data-role=upvotes]').text(this.model.get('likes') || '');
            if (forumVotingType === null || forumVotingType === undefined || forumVotingType === voteConstants.VOTING_TYPES.DETAILED)
                this.$('[data-role=downvotes]').text(this.model.get('dislikes') || '');
        },

        toggleReplyView: function (evt) {
            if (!evt)
                return;

            evt.preventDefault();
            evt.stopPropagation();

            this.replyViewManager.toggleReplyView(evt.currentTarget);
        },

        trackEdit: function () {
            bus.trigger('uiAction:postStartUpdate', this.model, {
                'forum_id': this.model.thread.forum.attributes.pk,
                'thread_id': this.model.thread.id,
            });
        },
    });

    return PostActionView;
});

define('core/collections/MediaCollection',[
    'backbone',

    'core/models/Media',
], function (
    Backbone,

    Media
) {
    'use strict';

    var MediaCollection = Backbone.Collection.extend({
        model: Media,
    });

    return MediaCollection;
});

define('core/models/RichMediaViewModel',[
    'backbone',
], function (
    Backbone
) {
    'use strict';

    // This model holds view state for RichMediaView instances
    return Backbone.Model.extend({
        defaults: {
            // If true, media will be displayed inline and load when near viewport.
            // If false, a button will be displayed to load the media.
            // RichMediaView will set based on user preference during initialize.
            deferred: true,

            showButtons: true,

            // Activated tracks if media is displayed
            activated: false,

            // Valid kinds: 'image', 'html', 'webpage'
            kind: 'image',

            // Used to set the height of the placeholder and, in the case of
            // iframe content, the height of the iframe.
            // RichMediaView will calculate an appropriate deferredHeight.
            deferredHeight: 0,

            // Resource-independent provider details that are not contained
            // in the media model. These should be set before the RichMediaView
            // is instantiated.
            providerExpandMessage: '',
            providerCollapseMessage: '',
            providerIcon: 'icon-proceed',

            // Not all RichMedia objects should respect forum/user settings.
            // RichMedia inside Sponsored Comment should not repsect user preferences (because this is an ad)
            respectSettings: true,
        },
    });
});

define('core/mediaConfig',[
    'underscore',
    'backbone',
], function (
    _,
    Backbone
) {
    'use strict';

    var MEDIA_PERSISTED_WIDTHS = [320, 480, 600, 800];

    // Calculates closest thumbnail width based on available
    // width (document.body.offsetWidth) and caches this value
    // for future use by PostView.
    function findClosestThumbnailSize() {
        var width = window.document.body.offsetWidth;

        // get closest image width we have to @width argument
        var thumbnailsWidths = MEDIA_PERSISTED_WIDTHS;
        var len = thumbnailsWidths.length;

        return _.find(thumbnailsWidths, function (__, i) {
            return (i + 1 === len) ||
                (Math.abs(thumbnailsWidths[i + 1] - width) > Math.abs(thumbnailsWidths[i] - width));
        });
    }

    var config = new Backbone.Model({
        collapsed: false,

        defaultIframeHeight: 300,
        mediaPersistedWidths: MEDIA_PERSISTED_WIDTHS,

        loadedThumbnailWidth: findClosestThumbnailSize(),
    });

    // for testing
    config.findClosestThumbnailSize = findClosestThumbnailSize;

    return config;
});

define('core/templates/postMediaInlineLink',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"hasUserText") : depth0),{"name":"if","hash":{},"fn":container.program(2, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":2,"column":0},"end":{"line":5,"column":7}}})) != null ? stack1 : "");
},"2":function(container,depth0,helpers,partials,data) {
    var alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"href") : depth0), depth0))
    + "\" rel=\"nofollow\">"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"text") : depth0), depth0))
    + "</a>\n";
},"4":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, alias3=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"href") : depth0), depth0))
    + "\" class=\"post-media-link\" data-action=\"expand-collapse-media\" rel=\"nofollow\">"
    + ((stack1 = lookupProperty(helpers,"if").call(alias3,((stack1 = (depth0 != null ? lookupProperty(depth0,"model") : depth0)) != null ? lookupProperty(stack1,"providerIcon") : stack1),{"name":"if","hash":{},"fn":container.program(5, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":10,"column":3},"end":{"line":10,"column":74}}})) != null ? stack1 : "")
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"mediaLinkText") : depth0), depth0))
    + ((stack1 = lookupProperty(helpers,"if").call(alias3,(depth0 != null ? lookupProperty(depth0,"domain") : depth0),{"name":"if","hash":{},"fn":container.program(7, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":14,"column":3},"end":{"line":14,"column":87}}})) != null ? stack1 : "")
    + "</a>\n";
},"5":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<i class=\""
    + container.escapeExpression(container.lambda(((stack1 = (depth0 != null ? lookupProperty(depth0,"model") : depth0)) != null ? lookupProperty(stack1,"providerIcon") : stack1), depth0))
    + "\"></i>";
},"7":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<span class=\"post-media-link-domain\"> &mdash; "
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"domain") : depth0), depth0))
    + "</span>";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = (depth0 != null ? lookupProperty(depth0,"model") : depth0)) != null ? lookupProperty(stack1,"deferred") : stack1),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(4, data, 0),"data":data,"loc":{"start":{"line":1,"column":0},"end":{"line":16,"column":7}}})) != null ? stack1 : "");
},"useData":true})

});
define('core/views/RichMediaLinkView',[
    'backbone',

    'core/utils',
    'core/templates/postMediaInlineLink',
], function (
    Backbone,

    utils,
    postMediaInlineLinkTemplate
) {
    'use strict';

    return Backbone.View.extend({
        tagName: 'span',

        events: {
            'click [data-action=expand-collapse-media]': 'handleToggle',
        },

        initialize: function (options) {
            // Expects same model and media as RichMediaView
            this.media = options.media;

            // Extract link information
            var $link = options.$link;
            this.linkText = $link.text();
            this.linkHref = $link.attr('href');
            this.linkDomain = utils.getDomain(this.linkHref);
            this.linkHasUserText = this.isUserText($link);

            // Find correct title
            this.hasGenericMessage = false;
            if (this.linkHasUserText) {
                this.mediaLinkText = this.linkText;
            } else if (this.media.get('title')) {
                this.mediaLinkText = utils.niceTruncate(this.media.get('title'), 60);
            } else {
                this.hasGenericMessage = true;
                this.mediaLinkText = this.model.get('providerExpandMessage');
            }

            this.listenTo(this.model, 'change:deferred', this.render);
            this.listenTo(this.model, 'change:activated', this.onChangeActivated);
        },

        isUserText: function ($link) {
            // Try to guess if the user has customized the link text.
            if ($link[0].nodeName !== 'A')
                return false;
            var text = ($link.text() || '').toLowerCase();
            if (!text)
                return false;
            // If the text starts with a http or www it's unlikely to be customized
            if (text.indexOf('http') === 0 || text.indexOf('www') === 0)
                return false;
            // Remove the trailing ... our server adds
            text = text.replace(/\.\.\.$/, '');
            // If the href contains the text it's unlikely to be customized
            var href = ($link.attr('href') || '').toLowerCase();
            return href.indexOf(text) === -1;
        },

        render: function () {
            var mediaLinkText = this.mediaLinkText;
            // Use correct collapse message if we have one
            if (this.hasGenericMessage) {
                if (this.model.get('activated'))
                    mediaLinkText = this.model.get('providerCollapseMessage');
            }

            this.$el.html(postMediaInlineLinkTemplate({
                model: this.model.toJSON(),
                text: this.linkText,
                href: this.linkHref,
                mediaLinkText: mediaLinkText,
                domain: this.linkDomain,
                hasUserText: this.linkHasUserText,
            }));

            return this;
        },

        onChangeActivated: function () {
            // If there is a generic view / hide, re-render
            if (this.hasGenericMessage)
                this.render();
        },

        handleToggle: function (evt) {
            if (!this.model.get('deferred')) {
                this.model.set('activated', !this.model.get('activated'));
                // Only prevent the link from opening if the media is collapsible.
                // If the media is deferred, this view looks like a normal link
                // and should function as the user expects.
                if (evt && evt.preventDefault)
                    evt.preventDefault();
            }
        },
    });
});

define('core/templates/postMedia',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = (depth0 != null ? lookupProperty(depth0,"media") : depth0)) != null ? lookupProperty(stack1,"providerName") : stack1),{"name":"if","hash":{},"fn":container.program(2, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":5,"column":26},"end":{"line":5,"column":90}}})) != null ? stack1 : "")
    + container.escapeExpression(container.lambda(((stack1 = (depth0 != null ? lookupProperty(depth0,"media") : depth0)) != null ? lookupProperty(stack1,"title") : stack1), depth0));
},"2":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(container.lambda(((stack1 = (depth0 != null ? lookupProperty(depth0,"media") : depth0)) != null ? lookupProperty(stack1,"providerName") : stack1), depth0))
    + " &ndash; ";
},"4":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<i class=\""
    + container.escapeExpression(container.lambda(((stack1 = (depth0 != null ? lookupProperty(depth0,"model") : depth0)) != null ? lookupProperty(stack1,"providerIcon") : stack1), depth0))
    + " publisher-background-color\"></i>";
},"6":function(container,depth0,helpers,partials,data) {
    return "media-video";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, alias3=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "\n<a class=\"media-button media-button-expand publisher-color publisher-border-color\" href=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"media") : depth0)) != null ? lookupProperty(stack1,"url") : stack1), depth0))
    + "\" rel=\"nofollow\" target=\"_blank\" data-action=\"expand\"\ntitle=\""
    + ((stack1 = lookupProperty(helpers,"if").call(alias3,((stack1 = (depth0 != null ? lookupProperty(depth0,"media") : depth0)) != null ? lookupProperty(stack1,"title") : stack1),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":5,"column":7},"end":{"line":5,"column":112}}})) != null ? stack1 : "")
    + "\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias3,((stack1 = (depth0 != null ? lookupProperty(depth0,"model") : depth0)) != null ? lookupProperty(stack1,"providerIcon") : stack1),{"name":"if","hash":{},"fn":container.program(4, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":6,"column":0},"end":{"line":6,"column":98}}})) != null ? stack1 : "")
    + "\n"
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"model") : depth0)) != null ? lookupProperty(stack1,"providerExpandMessage") : stack1), depth0))
    + "\n</a>\n<a class=\"media-button media-button-contract publisher-color publisher-border-color\" href=\"#\" target=\"_blank\" data-action=\"contract\">\n<i class=\"icon-cancel publisher-background-color\"></i> "
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"model") : depth0)) != null ? lookupProperty(stack1,"providerCollapseMessage") : stack1), depth0))
    + "\n</a>\n<div class=\"media-content-loader\" data-role=\"content-loader\"></div>\n<div data-role=\"content-placeholder\" class=\"media-content-placeholder media-"
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"media") : depth0)) != null ? lookupProperty(stack1,"providerName") : stack1), depth0))
    + " "
    + ((stack1 = lookupProperty(helpers,"if").call(alias3,(depth0 != null ? lookupProperty(depth0,"isVideo") : depth0),{"name":"if","hash":{},"fn":container.program(6, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":15,"column":99},"end":{"line":15,"column":132}}})) != null ? stack1 : "")
    + "\"></div>\n";
},"useData":true})

});
define('core/templates/postMediaPlaceholder',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\"#\" class=\"media-force-load\" data-action=\"force-load\"><i class=\""
    + container.escapeExpression(container.lambda(((stack1 = (depth0 != null ? lookupProperty(depth0,"model") : depth0)) != null ? lookupProperty(stack1,"providerIcon") : stack1), depth0))
    + "\"></i></a>\n";
},"useData":true})

});
define('core/constants/mediaTypeConstants',[
    'exports',
], function (
    exports
) {
    'use strict';

    exports.VIDEO_CODES = [
        '3',     // YOUTUBE_VIDEO
        '9',     // FACEBOOK_VIDEO
        '12',    // VIMEO_VIDEO
        '14',    // VINE_VIDEO
    ];
});

define('core/views/RichMediaView',[
    'jquery',
    'underscore',
    'backbone',

    'core/utils',
    'core/mediaConfig',
    'core/views/RichMediaLinkView',
    'core/templates/postMedia',
    'core/templates/postMediaPlaceholder',
    'core/constants/mediaTypeConstants',
], function (
    $,
    _,
    Backbone,

    utils,
    mediaConfig,
    RichMediaLinkView,
    postMediaTemplate,
    postMediaPlaceholderTemplate,
    mediaTypeConstants
) {
    'use strict';

    var handler = utils.preventDefaultHandler;

    var classFromModelAttr = function ($el, model, attribute, cls) {
        $el[model.get(attribute) ? 'addClass' : 'removeClass'](cls);
    };

    return Backbone.View.extend({
        className: 'media-container',
        // Block of html that can be deferred and collapsed. Subclasses must
        // implement getMediaDimensions.
        events: {
            'click [data-action=expand]': 'handleExpand',
            'click [data-action=contract]': 'handleContract',
            'click [data-action=force-load]': 'handleForceLoad',
        },

        template: postMediaTemplate,

        initialize: function (options) {
            this.options = options;
            this.media = options.media;
            this.template = options.template || this.template;

            this.$linkEl = null;

            this.setupMode();

            // Bind model events
            this.listenTo(this.model, 'change:activated', this.applyState);
            this.listenTo(this.model, 'change:deferredHeight',
                this.onChangeDeferredHeight);
            this.listenTo(this.model, 'change:showButtons', this.updateElementClass);
            this.listenTo(this.model, 'change:deferred', this.render);

            // Change mode when use toggles setting
            this.listenTo(mediaConfig, 'change:collapsed', this.setupMode);
        },

        getMediaDimensions: function () {
            // Get the expected width and height of the media which will be
            // embedded. Values should be null or an integer.
            // These values are used to scale the content to fit the embed.
            // They should avoid performing much calculation; estimations are
            // acceptable and will be corrected when the content loads.

            return {
                width: null,
                height: null,
            };
        },

        getAvailableWidth: function () {
            // This value will be unavailable until posts are rendered
            return this.$el.parent().width() || mediaConfig.get('loadedThumbnailWidth');
        },

        updateDeferredHeight: function () {
            this.model.set('deferredHeight', this.calculateDeferredHeight());
        },

        calculateDeferredHeight: function () {
            // Set deferredHeight to a best estimate of the scaled height of
            // the scaled height of the embedded media.

            var dimensions = this.getMediaDimensions();

            var width = dimensions.width;
            var height = dimensions.height;

            // If width or height are missing, or if either is 0, we can't
            // scale the media dimensions.
            // If width is missing, we should use the exact height provided.
            // If both are missing, this will clear deferredHeight.
            if (!width || !height)
                return height;

            // We have a numeric width and height, can scale it to fit the
            // actual width we have available while maintaining aspect ratio.
            var availableWidth = this.getAvailableWidth();
            var expectedHeight = availableWidth * height / width;
            return expectedHeight;
        },

        convertToButton: function ($link) {
            // Converts $link into a RichMediaLinkView.
            this.model.set('showButtons', false);
            if (this.linkSubview)
                this.linkSubview.remove();
            this.linkSubview = new RichMediaLinkView({
                model: this.model,
                media: this.media,
                $link: $link,
            });
            $link.replaceWith(this.linkSubview.$el);
            this.linkSubview.render();
        },

        applyContentNodeHeight: function (height) {
            // Set the height of the contentNode, or clear it
            this.contentNode.height(height || 'auto');
        },

        shouldAutoplay: function () {
            // Content should autoplay when the user manually expanded it.
            // Since this function is only invoked when about to display the
            // content, we can check deferred to see if we're in collapsible
            // mode at all (in which case it should be auto played).
            return !this.model.get('deferred');
        },

        generateContentHtml: function () {
            // Returns the HTML of the content.
            // This is overridden in subclasses.

            return this.media.get('html');
        },

        createContentNode: function (html) {
            // Converts html to a DOM node.
            // This is overridden in subclasses.

            return $(html);
        },

        insertContentNode: function ($node) {
            // Replaces displayed content with $node.
            // This is overridden in subclasses.

            this.contentNode.html($node);
        },

        prepareElementEvents: function (/* $node */) {
            // Forward load and error events from the content element to the view.
            // This is overridden in subclasses.
        },

        displayContent: function () {
            // Create and display the rich media.
            this.updateDeferredHeight();
            var html = this.generateContentHtml();
            var $node = this.createContentNode(html);
            this.prepareElementEvents($node);
            this.insertContentNode($node);
            this.applyContentNodeHeight(null);
        },

        configureDeferred: function () {
            // rNEXT overwrites this function (see comment in rNEXT for why this function exists)
            this.enterViewport();
        },

        configureContentFromActivated: function () {
            if (this.model.get('activated'))
                this.displayContent();
            else
                this.displayPlaceholder();
        },

        displayPlaceholder: function () {
            this.contentNode.html(postMediaPlaceholderTemplate({
                model: this.model.toJSON(),
            }));
        },

        updateElementClass: function () {
            // Update element classes
            var $el = this.$el;
            var model = this.model;

            classFromModelAttr($el, model, 'deferred', 'media-mode-deferred');
            classFromModelAttr($el, model, 'activated', 'media-activated');
            classFromModelAttr($el, model, 'showButtons', 'media-show-buttons');
        },

        applyState: function () {
            this.configureDeferred();

            this.configureContentFromActivated();

            this.updateElementClass();
        },

        render: function () {
            this.$el.html(this.template({
                model: this.model.toJSON(),
                media: this.media.toJSON(),
                isVideo: _.contains(mediaTypeConstants.VIDEO_CODES, this.media.get('mediaType')),
            }));

            this.contentNode = this.$el.find('[data-role=content-placeholder]');

            // Will insert content (if necessary),
            // ensure correct buttons are displayed (if any),
            // and enable view tracking (if applicable)
            this.applyState();

            return this;
        },

        remove: function () {
            if (this.linkSubview)
                this.linkSubview.remove();

            Backbone.View.prototype.remove.apply(this, arguments);
        },

        enterViewport: function () {
            // Only trigger the load if we've entered view while deferred
            if (this.model.get('deferred'))
                this.activate();
        },

        activate: function () {
            this.model.set('activated', true);
        },

        setupMode: function () {
            if (!this.model.get('respectSettings'))
                return;

            // De-activate the view if necessary
            this.model.set('activated', false);

            var collapse = mediaConfig.get('collapsed');
            if (collapse)
                this.model.set('deferred', false);
            else
                this.model.set('deferred', true);
        },

        // Model Events
        onChangeDeferredHeight: function () {
            // Apply new deferred height to content if necessary
            if (this.model.get('deferred') && !this.model.get('activated'))
                this.applyContentNodeHeight(this.model.get('deferredHeight'));
        },

        // DOM Events
        handleExpand: handler(function () {
            this.model.set('activated', true);
        }),

        handleContract: handler(function () {
            this.model.set('activated', false);
        }),

        handleForceLoad: handler(function () {
            if (this.model.get('deferred'))
                this.model.set('activated', true);
        }),
    });
});

define('core/templates/postMediaImage',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return " height=\""
    + container.escapeExpression(container.lambda(((stack1 = (depth0 != null ? lookupProperty(depth0,"model") : depth0)) != null ? lookupProperty(stack1,"deferredHeight") : stack1), depth0))
    + "\" ";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, alias3=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"imageUrl") : depth0), depth0))
    + "\" target=\"_blank\" rel=\"nofollow\">\n<img src=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"thumbnailUrl") : depth0), depth0))
    + "\" alt=\""
    + alias2(lookupProperty(helpers,"gettext").call(alias3,"Thumbnail",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":3,"column":33},"end":{"line":3,"column":56}}}))
    + "\" "
    + ((stack1 = lookupProperty(helpers,"if").call(alias3,((stack1 = (depth0 != null ? lookupProperty(depth0,"model") : depth0)) != null ? lookupProperty(stack1,"deferredHeight") : stack1),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":3,"column":58},"end":{"line":3,"column":128}}})) != null ? stack1 : "")
    + ">\n</a>\n";
},"useData":true})

});
define('core/views/ImageRichMediaView',[
    'core/views/RichMediaView',
    'core/utils',
    'core/config',
    'core/mediaConfig',
    'core/templates/postMediaImage',
], function (
    RichMediaView,
    utils,
    config,
    mediaConfig,
    postMediaImageTemplate
) {
    'use strict';

    // regex that will match main Disqus CDN domain -- i.e., 'disquscdn.com' --
    // at end of string: domainMatchesDisqusCDN.test('a.disquscdn.com') -> true
    var domainMatchesDisqusCDN = new RegExp(
        // prevent matching e.g., evil-disquscdn.com
        // by requiring the disquscdn.com part to be
        // preceded either by the string start (e.g. 'disquscdn.com')
        // or a dot '.' (e.g., '.disquscdn.com')
        '(^|\\.)'

        // take only the last two parts, ignore subdomains --
        // e.g. 'a.disquscdn.com' -> 'disquscdn\.com'
        + utils.getDomain(config.urls.media)
            .split('.').slice(-2).join('\\.')

        // only match at end of string
        + '$'
    );

    return RichMediaView.extend({
        // ImageRichMediaView displays the image within a link to the source.
        // The thumbnail url is used for the inline img.

        getMediaDimensions: function () {
            return {
                width: this.media.get('thumbnailWidth'),
                height: this.media.get('thumbnailHeight'),
            };
        },

        getImageUrl: function () {
            return this.media.get('resolvedUrlRedirect') ||
                this.media.get('urlRedirect') ||
                this.media.get('thumbnailUrl');
        },

        getImageThumbnailUrl: function () {
            var url = this.media.get('thumbnailUrl');

            // If this url is on the disqus cdn, request it to be resized.
            // This will apply to both uploaded and linked images.
            // Linked images are proxied via our cdn to support this feature
            // (as well as for several other benefits; see RichMedia property
            // signed_thumbnail_url in rDISQUS for further information).
            if (this.constructor.isOnDisqusCDN(url)) {
                url = utils.serialize(url, {
                    // Use loadedThumbnailWidth to allow server to maintain only
                    // a few different sizes of the image.
                    'w': mediaConfig.get('loadedThumbnailWidth'),
                    'h': this.model.get('deferredHeight'),
                });
            }

            return url;
        },

        generateContentHtml: function () {
            return postMediaImageTemplate({
                model: this.model.toJSON(),
                media: this.media.toJSON(),
                thumbnailUrl: this.getImageThumbnailUrl(),
                imageUrl: this.getImageUrl(),
            });
        },

        prepareElementEvents: function ($node) {
            var self = this;
            var $img = $node.find('img');

            $img.on('load.richMediaView error.richMediaView', function (evt) {
                self.trigger(evt.type);
                $img.off('.richMediaView');
            });
        },

        calculateDeferredHeight: function () {
            // To avoid upscaling, return the smaller of the calculated
            // height and the media height

            var deferredHeight = Math.floor(RichMediaView.prototype.calculateDeferredHeight.apply(this, arguments));
            var mediaHeight = this.getMediaDimensions().height;

            return Math.min(mediaHeight, deferredHeight) || null;
        },
    }, {
        /**
         * Checks if url is on the main Disqus CDN domain, i.e.: disquscdn.com
         * @param  {string}  url the image url to check
         * @returns {boolean}     does the image live on Disqus CDN?
         */
        isOnDisqusCDN: function (url) {
            var urlDomain = utils.getDomain(url);
            return domainMatchesDisqusCDN.test(urlDomain);
        },
    });
});

define('core/views/IframeRichMediaView',[
    'underscore',
    'core/mediaConfig',
    'core/views/RichMediaView',
], function (
    _,
    mediaConfig,
    RichMediaView
) {
    'use strict';

    return RichMediaView.extend({
        // IframeRichMediaView displays arbitrary html in the embed.
        // A loader is displayed until the content is ready.

        getMediaDimensions: function () {
            return {
                width: this.media.get('htmlWidth'),
                height: this.media.get('htmlHeight'),
            };
        },

        _findIframe: function ($el) {
            // Locate the iframe element
            // Must be $el or a descendant

            if ($el.is('iframe'))
                return $el;

            return $el.find('iframe');
        },

        configureContentFromActivated: function () {
            RichMediaView.prototype.configureContentFromActivated.apply(this, arguments);

            // If de-activated, the loading div should be hidden
            if (!this.model.get('activated'))
                this.$el.removeClass('media-loading');
        },

        createContentNode: function () {
            var $node = RichMediaView.prototype.createContentNode.apply(this, arguments);

            $node.attr({
                // Always fill width of embed
                width: '100%',
                height: this.model.get('deferredHeight'),
            });

            return $node;
        },

        insertContentNode: function ($node) {
            // Display the loader
            this.loaderNode = this.$el.find('[data-role=content-loader]');
            this.loaderHeight = this.model.get('deferredHeight') ||
                mediaConfig.get('defaultIframeHeight');
            this.loaderNode.height(this.loaderHeight);

            // Hide iframe until loaded
            this.$el.addClass('media-loading');

            // Insert the iframe to start it loading
            RichMediaView.prototype.insertContentNode.call(this, $node);
        },

        prepareElementEvents: function ($node) {
            var $iframe = this._findIframe($node);
            $iframe.one('load', _.bind(this.finishLoad, this, $iframe));
        },

        finishLoad: function ($iframe) {
            // Stop the loader
            this.$el.removeClass('media-loading');
            // Show the iframe
            $iframe.height(this.loaderHeight);
            // Notify listeners of load
            this.trigger('load');
        },
    });
});

define('core/views/FacebookPhotoRichMediaView',[
    'core/views/ImageRichMediaView',
], function (
    ImageRichMediaView
) {
    'use strict';

    return ImageRichMediaView.extend({
        getImageThumbnailUrl: function () {
            // If possible, use the larger image that Facebook provides
            return this.media.get('metadata').imageUrl ||
                ImageRichMediaView.prototype.getImageThumbnailUrl.call(this);
        },
    });
});

define('core/views/AutoplayRichMediaView',[
    'underscore',
    'jquery',
    'core/utils',
    'core/views/IframeRichMediaView',
], function (
    _,
    $,
    utils,
    IframeRichMediaView
) {
    'use strict';

    return IframeRichMediaView.extend({
        // Support autoplay of YouTube, Vimeo, Vine, and SoundCloud embeds
        createContentNode: function () {
            var $node = IframeRichMediaView.prototype.createContentNode.apply(this, arguments);

            var src = $node.attr('src');
            // Do not enable autoplay if we are going to use playerjs,
            // as it will be played via 'send'
            if (this.shouldAutoplay() && src && !this.model.get('playerjs')) {
                src = utils.serialize(src, {
                    // Early SoundCloud embeds, pre embedly iframe src
                    auto_play: true,
                    // Everything else
                    autoplay: 1,
                });
                $node.attr('src', src);
            }

            return $node;
        },

        insertContentNode: function ($node) {
            if (this.model.get('playerjs')) {
                // Communicate with player using Player.js Spec
                // https://github.com/embedly/player.js/blob/master/SPEC.rst
                var $iframe = this._findIframe($node);

                var src = $iframe.attr('src');
                if (src.substr(0, 2) === '//')
                    src = window.location.protocol + src;

                var origin = src.split('/');
                origin = origin[0] + '//' + origin[2];

                this.playerjs = {
                    ready: false,
                    queue: [],
                    origin: origin,
                    $iframe: $iframe,
                };

                if (this.model.get('mute'))
                    this.send('mute');

                // To guarantee the embed is muted before it plays, createContentNode
                // will not enable autoplay via the iframe src.
                if (this.shouldAutoplay())
                    this.send('play');

                var readyFn = _.once(_.bind(function () {
                    this.playerjs.ready = true;
                    // Send queued messages
                    var queue = this.playerjs.queue;
                    this.playerjs.queue = [];
                    _.each(queue, this.send, this);
                }, this));

                $(window).on('message', function (event) {
                    event = event.originalEvent;

                    if (event.origin !== origin)
                        return;

                    var data;
                    try {
                        data = JSON.parse(event.data);
                    } catch (err) {
                        return;
                    }

                    if (data.event === 'ready' && data.value && data.value.src === src)
                        readyFn();
                });
            }

            return IframeRichMediaView.prototype.insertContentNode.apply(this, arguments);
        },

        send: function (method) {
            if (!this.playerjs)
                return;

            if (!this.playerjs.ready)
                return void this.playerjs.queue.push(method);

            var data = {
                context: 'player.js',
                version: '0.0.10',
                method: method,
            };

            this.playerjs.$iframe[0].contentWindow.postMessage(
                JSON.stringify(data), this.playerjs.origin);
        },
    });
});

define('core/views/DynamicHeightRichMediaView',[
    'underscore',
    'core/views/RichMediaView',
], function (
    _,
    RichMediaView
) {
    'use strict';

    return RichMediaView.extend({
        insertContentNode: function () {
            RichMediaView.prototype.insertContentNode.apply(this, arguments);

            this.finishLoad();
        },

        finishLoad: function () {
            var self = this;

            // With dynamic-height content, an initial measurement is most likely
            // inaccurate. Since load times vary, an acceptable solution is to
            // re-measure the height at a regular rate.
            var callCount = 0;
            var CALL_RATE = 150;
            var MAX_CALLS = 20;
            var updateFunction = function () {
                callCount += 1;
                if (callCount < MAX_CALLS)
                    _.delay(updateFunction, CALL_RATE);
                else
                    self.trigger('load');
            };
            updateFunction();
        },
    });
});

define('core/templates/postMediaTwitterContent',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<meta name=\"twitter:widgets:csp\" content=\"on\">\n<blockquote class=\"twitter-tweet\" data-theme=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"theme") : depth0), depth0))
    + "\" data-link-color=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"linkColor") : depth0), depth0))
    + "\" lang=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"language") : depth0), depth0))
    + "\">\n<a href=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"url") : depth0), depth0))
    + "\"></a>\n</blockquote>\n<script src=\"//platform.twitter.com/widgets.js\"></script>\n";
},"useData":true})

});
define('core/views/TwitterRichMediaView',[
    'underscore',
    'core/views/DynamicHeightRichMediaView',
    'core/templates/postMediaTwitterContent',
], function (
    _,
    DynamicHeightRichMediaView,
    postMediaTwitterContentTemplate
) {
    'use strict';

    var TwitterRichMediaView = DynamicHeightRichMediaView.extend({
        // TwitterRichMediaView generates content html from scratch
        // (ignores server html). It then themes the content to match the embed.

        generateContentHtml: function () {
            // Twitter uses two-character ISO 639-1 codes for the language option.
            // See https://dev.twitter.com/docs/api/1.1/get/help/languages.
            var language = window.document.documentElement.lang;
            language = language && language.substring(0, 2);

            var url = this.media.get('url');
            if (this.media.get('resolvedUrl').indexOf('/status') !== -1)
                url = this.media.get('resolvedUrl');

            return postMediaTwitterContentTemplate({
                url: url,
                theme: _.result(TwitterRichMediaView, 'theme'),
                linkColor: _.result(TwitterRichMediaView, 'linkColor'),
                language: language,
            });
        },
    }, {
        theme: 'light', // either 'light' or 'dark'
        linkColor: '#2e9fff', // this is the default used by Disqus Home
    });

    return TwitterRichMediaView;
});

define('core/views/SoundCloudRichMediaView',[
    'core/views/AutoplayRichMediaView',
], function (
    AutoplayRichMediaView
) {
    'use strict';

    return AutoplayRichMediaView.extend({
        // Force full-width media dimensions.

        getMediaDimensions: function () {
            // The SoundCloud player automatically changes its layout for
            // different widths, but the height must be as provided; we should
            // not attempt to scale it to fit the embed.
            return {
                width: null,
                height: this.media.get('htmlHeight'),
            };
        },
    });
});

define('core/views/VineRichMediaView',[
    'core/views/AutoplayRichMediaView',
    'core/utils',
], function (
    AutoplayRichMediaView,
    utils
) {
    'use strict';

    return AutoplayRichMediaView.extend({
        createContentNode: function () {
            // Vine videos have audio disabled by default. If this video is
            // being shown as the result of an expand event, enable the audio.
            var $node = AutoplayRichMediaView.prototype.createContentNode.apply(this, arguments);
            var src = $node.attr('src');
            if (this.shouldAutoplay() && src) {
                src = utils.serialize(src, {
                    audio: 1,
                });
                $node.attr('src', src);
            }
            return $node;
        },
    });
});


define('core/views/IframeGifRichMediaView',[
    'core/views/IframeRichMediaView',
], function (
    IframeRichMediaView
) {
    'use strict';

    return IframeRichMediaView.extend({
        insertContentNode: function ($node) {
            IframeRichMediaView.prototype.insertContentNode.call(this, $node);

            this.loaderNode.width(this.getMediaDimensions().width);
        },

        createContentNode: function () {
            var $node = IframeRichMediaView.prototype.createContentNode.apply(this, arguments);

            $node.attr(this.getMediaDimensions());

            return $node;
        },

        calculateDeferredHeight: function () {
            return this.getMediaDimensions().height;
        },

        displayPlaceholder: function () {
            IframeRichMediaView.prototype.displayPlaceholder.call(this);

            var dimensions = this.getMediaDimensions();
            this.contentNode.height(dimensions.height).width(dimensions.width);
        },
    });
});

define('core/media',[
    'underscore',

    'core/strings',

    'core/models/Media',
    'core/models/RichMediaViewModel',
    'core/views/ImageRichMediaView',
    'core/views/IframeRichMediaView',
    'core/views/FacebookPhotoRichMediaView',
    'core/views/AutoplayRichMediaView',
    'core/views/TwitterRichMediaView',
    'core/views/SoundCloudRichMediaView',
    'core/views/VineRichMediaView',
    'core/views/IframeGifRichMediaView',
], function (
    _,

    strings,

    MediaModel,
    RichMediaViewModel,
    ImageRichMediaView,
    IframeRichMediaView,
    FacebookPhotoRichMediaView,
    AutoplayRichMediaView,
    TwitterRichMediaView,
    SoundCloudRichMediaView,
    VineRichMediaView,
    IframeGifRichMediaView
) {
    'use strict';

    /* Rich Media

     * Each rich media object is associated with a link in the user's post.

     * There is a user setting to hide / show media; this is stored in the settings
     * model below as 'collapsed' (true === hide media). Each RichMediaView then
     * has a 'deferred' attribute which is the inverse (true === show media).

     * When a post is rendered, rich media links are replaced with RichMediaLinkViews.
     * In deferred mode this looks identical to the original link, but in collapsible
     * mode it provides additional information about the media (ex. title) and
     * serves as an expand / collapse button.

     * When deferred, the RichMediaView displays a placeholder and waits for the
     * user to scroll close to the view. This is done by registering with the
     * deferred views system in Lounge and waiting for the viewport:enter event.
     * Until that event happens, a placeholder is displayed; if there is an issue
     * with the deferred views system the user can click the placeholder.

     * When collapsible, the RichMediaView is hidden. When the RichMediaLinkView
     * is clicked it will display its content and autoplay (if possible).

     * Until it is displayed, the RichMediaView sets its size to the expected
     * media size. This is done by measuring the available space and scaling the
     * dimensions returned by getMediaDimensions. Some media types don't define
     * both dimensions (ex. SoundCloud will fill any width but has a height
     * requirement) so the dimensions are optional.
    */

    var gettext = strings.get;

    // Common, easily-translated actions
    var PROVIDER_MESSAGES = {
        PLAY_HIDE: {
            kind: 'html',
            providerExpandMessage: gettext('Play'),
            providerCollapseMessage: gettext('Hide'),
        },
        VIEW_HIDE: {
            kind: 'html',
            providerExpandMessage: gettext('View'),
            providerCollapseMessage: gettext('Hide'),
        },
        VIEW_IMAGE: {
            kind: 'image',
            providerIcon: 'icon-images',
            providerExpandMessage: gettext('View'),
            providerCollapseMessage: gettext('Hide'),
        },
    };

    var getRichMediaViewConfig = function (model) {
        // Create an instance of the correct RichMediaView subclass based on
        // the media model attributes.

        var extendMessage = function (name, icon) {
            return _.defaults({
                providerIcon: icon,
            }, PROVIDER_MESSAGES[name]);
        };

        var providerConstant = null;
        var Cls = null;

        var PROVIDER = MediaModel.MEDIA_TYPES;
        switch (model.get('mediaType')) {
        // Images
        case PROVIDER.IMAGE:
        case PROVIDER.IMAGE_UPLOAD:
            providerConstant = PROVIDER_MESSAGES.VIEW_IMAGE;
            break;
        case PROVIDER.FACEBOOK_PHOTO:
            Cls = FacebookPhotoRichMediaView;
            providerConstant = PROVIDER_MESSAGES.VIEW_IMAGE;
            break;
        // gif videos
        case PROVIDER.GIF_VIDEO:
            Cls = IframeGifRichMediaView;
            providerConstant = PROVIDER_MESSAGES.VIEW_HIDE;
            break;
        // Other
        case PROVIDER.VIMEO_VIDEO:
        case PROVIDER.YOUTUBE_VIDEO:
            Cls = AutoplayRichMediaView;
            providerConstant = extendMessage('PLAY_HIDE', 'icon-video');
            break;
        case PROVIDER.TWITTER_STATUS:
            Cls = TwitterRichMediaView;
            providerConstant = extendMessage('VIEW_HIDE', 'icon-twitter');
            break;
        case PROVIDER.VINE_VIDEO:
            Cls = VineRichMediaView;
            providerConstant = extendMessage('PLAY_HIDE', 'icon-video');
            break;
        case PROVIDER.FACEBOOK_VIDEO:
            providerConstant = extendMessage('VIEW_HIDE', 'icon-video');
            break;
        case PROVIDER.SOUNDCLOUD_SOUND:
            Cls = SoundCloudRichMediaView;
            providerConstant = extendMessage('PLAY_HIDE', 'icon-music');
            break;
        case PROVIDER.GOOGLE_MAP:
            providerConstant = extendMessage('VIEW_HIDE', 'icon-map');
            break;
        // Invalid rich media type
        default:
            return null;
        }

        // Generic views
        if (Cls === null) {
            switch (providerConstant.kind) {
            case 'webpage':
                // Webpage support has been removed
                return null;
            case 'html':
                Cls = IframeRichMediaView;
                break;
            case 'image':
                Cls = ImageRichMediaView;
                break;
            }
        }

        // Initialize model
        var mediaViewModel = new RichMediaViewModel(providerConstant);

        return {
            Cls: Cls,
            mediaViewModel: mediaViewModel,
        };
    };

    var instantiateRichMediaView = function (model) {
        var config = getRichMediaViewConfig(model);

        if (!config)
            return null;

        // Instantiate the view
        return new config.Cls({
            model: config.mediaViewModel,
            media: model,
        });
    };

    var instantiateRichMediaThumbnail = function (model) {
        return new ImageRichMediaView({
            model: new RichMediaViewModel(PROVIDER_MESSAGES.VIEW_IMAGE),
            media: model,
        });
    };

    return {
        instantiateRichMediaView: instantiateRichMediaView,
        instantiateRichMediaThumbnail: instantiateRichMediaThumbnail,
        getRichMediaViewConfig: getRichMediaViewConfig,
    };
});

define('core/mixins/withRichMedia',[
    'underscore',
    'jquery',

    'core/collections/MediaCollection',
    'core/media',
], function (
    _,
    $,

    MediaCollection,
    coreMedia
) {
    'use strict';

    function getLinks($fragment) {
        var links = {};

        if (!$fragment.length)
            return links;

        $fragment.find('a').each(function (__, link) {
            var url = link.href;
            if (!links[url])
                links[url] = $(link);
        });

        return links;
    }

    var RichMediaRenderableView = {
        renderRichMedia: function (media, mediaNode, options) {
            options = options || {};
            media = media instanceof MediaCollection ?
                media :
                new MediaCollection(media);

            return media.chain()
                .map(function (item) {
                    return coreMedia.instantiateRichMediaView(item);
                })
                // Filter out unusable media
                // TODO: There should never be unusable media
                .without(null)
                .map(function (view) {
                    var url = view.media.get('urlRedirect');

                    if (options.normalize)
                        url = options.normalize.call(this, url);

                    var links = getLinks(this.$('[data-role=message]'));
                    var $link = links[url];

                    if (options.beforeRender)
                        options.beforeRender.call(this, view);

                    // Render before putting on the DOM to
                    // minimize DOM updates
                    view.render();

                    if ($link) {
                        if (options.convertLinkToButton) {
                            // Place the media after the link
                            $link.after(view.$el);

                            // Convert link into button which toggles the media when
                            // media is collapsible.
                            view.convertToButton($link);
                        } else {
                            $link.replaceWith(view.$el);
                        }
                    } else {
                        mediaNode = mediaNode || this.$('[data-role=post-media-list]');
                        mediaNode.append($('<li>').append(view.$el));
                    }

                    return view;
                }, this)
                .value();
        },
    };

    function withRichMediaView() {
        _.extend(this, RichMediaRenderableView);
    }

    return withRichMediaView;
});

define('home/templates/postContent',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    return "comment-message-hidden";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"comment-message expanded "
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"isHidden") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":1,"column":37},"end":{"line":1,"column":82}}})) != null ? stack1 : "")
    + "\"\ndata-role=\"message\" dir=\"auto\">\n"
    + ((stack1 = container.lambda((depth0 != null ? lookupProperty(depth0,"message") : depth0), depth0)) != null ? stack1 : "")
    + "\n<div><ul class=\"post-media\" data-role=\"post-media-list\"></ul></div>\n</div>\n<a  href=\"#\" class=\"curtain-truncate hidden\" title=\""
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"see more",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":6,"column":52},"end":{"line":6,"column":74}}}))
    + "\"\ndata-action=\"expand\"\ndata-target=\".comment-message\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"see more",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":8,"column":31},"end":{"line":8,"column":53}}}))
    + "</a>\n";
},"useData":true})

});
define('home/views/PostContentView',[
    'backbone-marionette',

    'core/bus',
    'core/mixins/withRichMedia',

    'home/templates/postContent',
], function (
    Marionette,

    bus,
    withRichMedia,

    postContentTemplate
) {
    'use strict';

    /**
     * A view of a just the content of a post, including rich media.
     */
    var PostContentView = Marionette.ItemView.extend({
        template: postContentTemplate,
        templateHelpers: function () {
            return {
                isHidden: this.model.get('state') !== 'visible',
            };
        },

        events: {
            'click a': 'trackClickLink',
        },

        trackClickLink: function (evt) {
            bus.trigger('uiAction:clickLink', evt, {
                adjective: 'message',
            });
        },

        onRender: function () {
            this.renderRichMedia(this.model.get('media'));
        },
    });

    withRichMedia.call(PostContentView.prototype);

    return PostContentView;
});

define('home/mixins/withCollapsing',[
    'underscore',
    'jquery',
], function (
    _,
    $
) {
    'use strict';

    var getCollapsible = function (options) {
        return options.collapsibleSelector ?
            this.$(options.collapsibleSelector) :
            this.$el;
    };

    var CollapsingMixin = {
        events: {
            'click [data-action=expand]': 'expand',
            'click [data-action=collapse]': 'forceCollapse',
        },

        collapse: function (options) {
            var $collapsible = getCollapsible.call(this, options);

            var imagePromises = $collapsible.find('img').map(function (__, el) {
                var deferred = $.Deferred();
                var $el = $(el);

                if ($el.complete)
                    deferred.resolve();
                else
                    $el.one('load', deferred.resolve);

                return deferred.promise();
            });

            // Wait until all images (if any) are loaded before deciding whether
            // or not to collapse this element. If no images, no need to wait, element
            // is already at its max height. (ex: long post with no images may still
            // exceed maxHeight)
            $.when(imagePromises).then(_.bind(this.forceCollapse, this, null, options));
        },

        expand: function (evt, options) {
            if (evt)
                evt.preventDefault();

            var $collapsible = getCollapsible.call(this, options);
            var $expand = $collapsible.find('[data-action=expand][data-target]');
            var $collapse = $collapsible.find('[data-action=collapse]');
            var selector = $expand.data('target');
            var $element = $collapsible.find(selector);
            var self = this;

            $expand.addClass('hidden');
            $element
                .addClass('expanded')
                .one('transitionend oTransitionEnd webkitTransitionEnd', function () {
                    self.trigger('expandedComplete');
                });

            $collapse.removeClass('hidden');
        },

        forceCollapse: function (evt, options) {
            if (evt)
                evt.preventDefault();

            var $collapsible = getCollapsible.call(this, options);

            var $expand = $collapsible.find('[data-action=expand]');
            var $collapse = $collapsible.find('[data-action=collapse]');

            var selector = evt ?
                $(evt.currentTarget).data('target') :
                '.expanded';
            var $element = $collapsible.find(selector);

            // Don't collapse something if there's no way to re-expand it
            if (!$expand.length)
                return;

            if ($element.height() > options.maxHeight) {
                $element.removeClass('expanded');
                $expand.removeClass('hidden');
            }

            $collapse.addClass('hidden');
        },
    };

    var withCollapsing = function (options) {
        var _initialize = this.initialize;

        this.initialize = function () {
            _initialize.apply(this, arguments);
            this.listenTo(this, 'show', this.collapse);
        };

        this.collapse = function () {
            CollapsingMixin.collapse.call(this, options);
        };

        this.expand = function (evt) {
            CollapsingMixin.expand.call(this, evt, options);
        };

        this.forceCollapse = function (evt) {
            CollapsingMixin.forceCollapse.call(this, evt, options);
        };

        this.events = _.defaults({}, this.events, CollapsingMixin.events);
    };

    return withCollapsing;
});

define('home/views/CollapsingPostContentView',[
    'home/views/PostContentView',

    'home/mixins/withCollapsing',
], function (
    PostContentView,

    withCollapsing
) {
    'use strict';

    /**
     * The standard post content view that hides content beyond a
     * certain height behind a curtain.
     */
    var CollapsingPostContentView = PostContentView.extend({});

    withCollapsing.call(CollapsingPostContentView.prototype, {
        maxHeight: 115, // px
    });

    return CollapsingPostContentView;
});

define('home/templates/post',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<span class=\"label label-danger\">"
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"hiddenExplanation") : depth0), depth0))
    + "</span>\n";
},"3":function(container,depth0,helpers,partials,data) {
    return "hidden";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, alias3=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = container.invokePartial(lookupProperty(partials,"userAvatar"),(depth0 != null ? lookupProperty(depth0,"author") : depth0),{"name":"userAvatar","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "<div class=\"comment-body\">\n<header class=\"comment-header\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"userName"),(depth0 != null ? lookupProperty(depth0,"author") : depth0),{"name":"userName","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "<a class=\"link-gray time\"\nhref=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"discussionRoute") : depth0), depth0))
    + "#comment-"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"id") : depth0), depth0))
    + "\"\ndata-link-name=\"timestamp\"\ndata-thread-id=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + "\">\n\n"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"relativeTime") : depth0), depth0))
    + "\n</a>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias3,(depth0 != null ? lookupProperty(depth0,"isHidden") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":12,"column":0},"end":{"line":14,"column":7}}})) != null ? stack1 : "")
    + "</header>\n<div data-role=\"post-content\"></div>\n<footer class=\"comment-actions "
    + ((stack1 = lookupProperty(helpers,"if").call(alias3,(depth0 != null ? lookupProperty(depth0,"isHidden") : depth0),{"name":"if","hash":{},"fn":container.program(3, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":17,"column":31},"end":{"line":17,"column":60}}})) != null ? stack1 : "")
    + "\" data-role=\"post-actions\">\n</footer>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/PostView',[  // eslint-disable-line requirejs/amd-function-arity
    'backbone-marionette',
    'core/strings',

    'home/mixins/withSubviews',

    'home/views/PostActionsView',
    'home/views/PostContentView',
    'home/views/CollapsingPostContentView',
    'home/utils/datetimeUtils',

    'home/templates/post',

    // imported for side effects
    // TODO: find a better place to put this. required here in order to use imported VotersCard
    'home/utils/cardUtils',
], function (
    Marionette,
    strings,

    withSubviews,

    PostActionsView,
    PostContentView,
    CollapsingPostContentView,
    datetimeUtils,

    postTemplate
) {
    'use strict';

    var gettext = strings.get;

    var parent = Marionette.ItemView;


    /**
     * A view of a post, including the author's details above, the post content including
     * rich media, and standard post actions below.
     */
    var PostView = parent.extend({
        className: 'card-comment',
        template: postTemplate,
        templateHelpers: function () {
            var state = this.model.get('state');

            return {
                isHidden: state !== 'visible',
                hiddenExplanation: {
                    flagged: gettext('Pending'),
                    pending: gettext('Pending'),
                    spam: gettext('Detected as spam'),
                    deleted: gettext('Removed'),
                }[state],
                discussionRoute: this.model.thread.permalink(),
                relativeTime: datetimeUtils.getRelativeDatetime(this.model.get('createdAt')),
            };
        },

        initialize: function (options) {
            options = options || {};

            this.hideActions = options.hideActions;
            this.shouldCollapse = options.shouldCollapse;
        },

        regions: {
            postContentRegion: '[data-role=post-content]',
            postActionsRegion: '[data-role=post-actions]',
        },

        onRender: function () {
            this.activateRegion(this.postContentRegion, this.createPostContentView);

            if (!this.hideActions)
                this.activateRegion(this.postActionsRegion, this.createPostActionsView);
        },

        createPostActionsView: function () {
            return new PostActionsView({
                el: this.postActionsRegion.el,
                model: this.model,
                parentPostView: this,
            });
        },

        createPostContentView: function () {
            var PostContentViewClass = this.shouldCollapse ?
                CollapsingPostContentView :
                PostContentView;

            return new PostContentViewClass({
                el: this.postContentRegion.el,
                model: this.model,
            });
        },
    });


    var proto = PostView.prototype;
    withSubviews.call(proto);

    return PostView;
});

define('home/views/PostCollectionView',[
    'home/views/common/FetchableCollectionView',
    'home/views/PostView',
], function (
    FetchableCollectionView,
    PostView
) {
    'use strict';

    return FetchableCollectionView.extend({
        itemView: PostView,
    });
});

define('home/templates/genericCardCreate',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    return " no-image";
},"3":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"link") : stack1), depth0))
    + "\"\nclass=\"discussion-image\"\ndata-link-name=\"image\"\ndata-link-out=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"signedLink") : stack1), depth0))
    + "\"\ndata-thread-id=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + "\">\n\n<img src=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"image") : depth0)) != null ? lookupProperty(stack1,"src") : stack1), depth0))
    + "\" alt=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"image") : depth0)) != null ? lookupProperty(stack1,"title") : stack1), depth0))
    + "\">\n</a>\n";
},"5":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a class=\"card-avatar\" href=\"/by/"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"username") : depth0), depth0))
    + "/\" data-link-name=\"user_avatar\">\n<img\nsrc=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"avatar") : depth0)) != null ? lookupProperty(stack1,"cache") : stack1), depth0))
    + "\"\nalt=\""
    + ((stack1 = container.invokePartial(lookupProperty(partials,"userNameNoLink"),depth0,{"name":"userNameNoLink","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "\" />\n</a>\n";
},"7":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card-discussion-comments-title\">"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Recent Comments",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":27,"column":44},"end":{"line":27,"column":73}}}))
    + "</div>\n<div class=\"card-discussion-comments\" data-role=\"posts\"></div>\n";
},"9":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card-summary\">\n<div class=\"card-summary-content truncate\" data-truncate-lines=\"3\" dir=\"auto\">\n"
    + ((stack1 = container.lambda((depth0 != null ? lookupProperty(depth0,"threadDescriptionHTML") : depth0), depth0)) != null ? stack1 : "")
    + "\n</div>\n</div>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card-discussion"
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"image") : depth0),{"name":"unless","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":1,"column":27},"end":{"line":1,"column":64}}})) != null ? stack1 : "")
    + "\">\n<div class=\"card-aside\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"image") : depth0),{"name":"if","hash":{},"fn":container.program(3, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":3,"column":0},"end":{"line":12,"column":7}}})) != null ? stack1 : "")
    + "</div>\n<div class=\"card-body\">\n"
    + ((stack1 = lookupProperty(helpers,"with").call(alias1,(depth0 != null ? lookupProperty(depth0,"firstActor") : depth0),{"name":"with","hash":{},"fn":container.program(5, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":15,"column":0},"end":{"line":21,"column":9}}})) != null ? stack1 : "")
    + "<div class=\"card-reason\">\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(alias1,"%(group)s authored",{"name":"gettext","hash":{"group":lookupProperty(helpers,"getPartial").call(alias1,"userGroupNames",{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":23,"column":39},"end":{"line":23,"column":68}}})},"data":data,"loc":{"start":{"line":23,"column":0},"end":{"line":23,"column":70}}}))
    + "\n</div>\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"threadTitle"),depth0,{"name":"threadTitle","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"recentPostCount") : depth0),{"name":"if","hash":{},"fn":container.program(7, data, 0),"inverse":container.program(9, data, 0),"data":data,"loc":{"start":{"line":26,"column":0},"end":{"line":35,"column":7}}})) != null ? stack1 : "")
    + "<footer class=\"card-footer\" data-role=\"footer\"></div>\n</div>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/GenericCardCreateView',[
    'backbone-marionette',

    'home/mixins/asGenericCard',
    'home/mixins/withReason',
    'home/mixins/withSubviews',
    'home/views/PostCollectionView',

    'home/templates/genericCardCreate',
], function (
    Marionette,

    asGenericCard,
    withReason,
    withSubviews,
    PostCollectionView,

    genericCardCreateTemplate
) {
    'use strict';

    var parent = Marionette.ItemView;


    var GenericCardCreateView = parent.extend({
        template: genericCardCreateTemplate,
        templateHelpers: function () {
            return {
                recentPostCount: this.model.thread.recentPosts.length,
            };
        },

        regions: {
            postsRegion: '[data-role=posts]',
        },

        onRender: function () {
            this.activateRegion(this.postsRegion, this.createPostsView);
        },

        createPostsView: function () {
            return new PostCollectionView({
                el: this.postsRegion.el,
                collection: this.model.thread.recentPosts,
            });
        },
    });


    var proto = GenericCardCreateView.prototype;
    asGenericCard.call(proto);
    withReason.call(proto);
    withSubviews.call(proto);

    return GenericCardCreateView;
});

define('home/templates/genericCardFavorite',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    return " no-image";
},"3":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"link") : stack1), depth0))
    + "\"\nclass=\"discussion-image\"\ndata-link-name=\"image\"\ndata-link-out=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"signedLink") : stack1), depth0))
    + "\"\ndata-thread-id=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + "\">\n\n<img src=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"image") : depth0)) != null ? lookupProperty(stack1,"src") : stack1), depth0))
    + "\" alt=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"image") : depth0)) != null ? lookupProperty(stack1,"title") : stack1), depth0))
    + "\">\n</a>\n";
},"5":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a class=\"card-avatar\" href=\"/by/"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"username") : depth0), depth0))
    + "/\" data-link-name=\"user_avatar\">\n<img\nsrc=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"avatar") : depth0)) != null ? lookupProperty(stack1,"cache") : stack1), depth0))
    + "\"\nalt=\""
    + ((stack1 = container.invokePartial(lookupProperty(partials,"userNameNoLink"),depth0,{"name":"userNameNoLink","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "\" />\n</a>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, alias3=container.lambda, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card-discussion"
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"image") : depth0),{"name":"unless","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":1,"column":27},"end":{"line":1,"column":64}}})) != null ? stack1 : "")
    + "\">\n<div class=\"card-aside\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"image") : depth0),{"name":"if","hash":{},"fn":container.program(3, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":3,"column":0},"end":{"line":12,"column":7}}})) != null ? stack1 : "")
    + "</div>\n<div class=\"card-body\">\n"
    + ((stack1 = lookupProperty(helpers,"with").call(alias1,(depth0 != null ? lookupProperty(depth0,"firstActor") : depth0),{"name":"with","hash":{},"fn":container.program(5, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":15,"column":0},"end":{"line":21,"column":9}}})) != null ? stack1 : "")
    + "<div class=\"card-reason\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"%(group)s recommended",{"name":"gettext","hash":{"group":lookupProperty(helpers,"getPartial").call(alias1,"userGroupNames",{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":23,"column":42},"end":{"line":23,"column":71}}})},"data":data,"loc":{"start":{"line":23,"column":0},"end":{"line":23,"column":73}}}))
    + "\non\n<a class=\"name-community\"\nhref=\"/home/forum/"
    + alias2(alias3(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + "/\"\ndata-link-name=\"forum_name\"\ndata-forum-pk=\""
    + alias2(alias3(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1)) != null ? lookupProperty(stack1,"pk") : stack1), depth0))
    + "\">\n\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"forumName"),((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1),{"name":"forumName","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</a>\n</div>\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"threadTitle"),depth0,{"name":"threadTitle","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "<div class=\"card-summary\">\n<div class=\"card-summary-content truncate\" data-truncate-lines=\"3\" dir=\"auto\">\n"
    + ((stack1 = alias3((depth0 != null ? lookupProperty(depth0,"threadDescriptionHTML") : depth0), depth0)) != null ? stack1 : "")
    + "\n</div>\n</div>\n<footer class=\"card-footer\" data-role=\"footer\"></div>\n</div>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/GenericCardFavoriteView',[
    'backbone-marionette',

    'home/mixins/asGenericCard',
    'home/mixins/withReason',

    'home/templates/genericCardFavorite',
], function (
    Marionette,

    asGenericCard,
    withReason,

    genericCardFavoriteTemplate
) {
    'use strict';

    var GenericCardFavoriteView = Marionette.ItemView.extend({
        template: genericCardFavoriteTemplate,
    });

    asGenericCard.call(GenericCardFavoriteView.prototype);
    withReason.call(GenericCardFavoriteView.prototype);

    return GenericCardFavoriteView;
});

define('home/templates/genericCardTrending',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    return " no-image";
},"3":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"link") : stack1), depth0))
    + "\"\nclass=\"discussion-image\"\ndata-link-name=\"image\"\ndata-link-out=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"signedLink") : stack1), depth0))
    + "\"\ndata-thread-id=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + "\">\n\n<img src=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"image") : depth0)) != null ? lookupProperty(stack1,"src") : stack1), depth0))
    + "\" alt=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"image") : depth0)) != null ? lookupProperty(stack1,"title") : stack1), depth0))
    + "\">\n</a>\n";
},"5":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a class=\"card-avatar\"\nhref=\"/home/forum/"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"id") : depth0), depth0))
    + "/\"\ndata-link-name=\"forum_name\"\ndata-forum-pk=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"pk") : depth0), depth0))
    + "\">\n\n<img src=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"faviconImage") : depth0), depth0))
    + "\" alt=\""
    + ((stack1 = container.invokePartial(lookupProperty(partials,"forumName"),depth0,{"name":"forumName","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "\" />\n</a>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card-discussion"
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"image") : depth0),{"name":"unless","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":1,"column":27},"end":{"line":1,"column":64}}})) != null ? stack1 : "")
    + "\">\n<div class=\"card-aside\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"image") : depth0),{"name":"if","hash":{},"fn":container.program(3, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":3,"column":0},"end":{"line":12,"column":7}}})) != null ? stack1 : "")
    + "</div>\n<div class=\"card-body\">\n"
    + ((stack1 = lookupProperty(helpers,"with").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1),{"name":"with","hash":{},"fn":container.program(5, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":15,"column":0},"end":{"line":23,"column":9}}})) != null ? stack1 : "")
    + "<div class=\"card-reason\">\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(alias1,"%(forum)s recently published",{"name":"gettext","hash":{"forum":lookupProperty(helpers,"getPartial").call(alias1,"forumLink",((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1),{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":25,"column":49},"end":{"line":25,"column":86}}})},"data":data,"loc":{"start":{"line":25,"column":0},"end":{"line":25,"column":88}}}))
    + "\n</div>\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"threadTitle"),depth0,{"name":"threadTitle","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "<div class=\"card-summary\">\n<div class=\"card-summary-content truncate\" data-truncate-lines=\"3\" dir=\"auto\">\n"
    + ((stack1 = container.lambda((depth0 != null ? lookupProperty(depth0,"threadDescriptionHTML") : depth0), depth0)) != null ? stack1 : "")
    + "\n</div>\n</div>\n<footer class=\"card-footer\" data-role=\"footer\"></div>\n</div>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/GenericCardTrendingView',[
    'backbone-marionette',

    'home/mixins/asGenericCard',

    'home/templates/genericCardTrending',
], function (
    Marionette,

    asGenericCard,

    genericCardTrendingTemplate
) {
    'use strict';

    var GenericCardTrendingView = Marionette.ItemView.extend({
        template: genericCardTrendingTemplate,
    });

    asGenericCard.call(GenericCardTrendingView.prototype);

    return GenericCardTrendingView;
});

define('home/views/GenericCardCollectionView',[
    'underscore',
    'backbone',

    'home/views/common/FetchableCollectionView',
    'home/views/GenericCardCreateView',
    'home/views/GenericCardFavoriteView',
    'home/views/GenericCardTrendingView',
], function (
    _,
    Backbone,

    FetchableCollectionView,
    GenericCardCreateView,
    GenericCardFavoriteView,
    GenericCardTrendingView
) {
    'use strict';

    var GenericCardCollectionView = FetchableCollectionView.extend({
        itemView: function (options) {
            switch (options.model.get('verb')) {
            case 'favorite':
                return new GenericCardFavoriteView(options);
            case 'create':
                return new GenericCardCreateView(options);
            case 'trending':
                return new GenericCardTrendingView(options);
            case 'share':
                // Until we have a view that handles the share activity,
                // show a Create view for user-generated threads and a
                // Trending view otherwise.
                if (options.model.thread.author) {
                    if (!options.model.actors.length) {
                        // Since the share activity doesn't have actors and
                        // the Create view requires actors, set the actor to
                        // the thread author
                        options.model.actors = [options.model.thread.author];
                        options.model.set({ totalActors: 1 });
                    }

                    return new GenericCardCreateView(options);
                }

                return new GenericCardTrendingView(options);
            default:
                // So that an error isn't thrown by returning null when a view is
                // expected, for activity types not supported by generic feeds
                return new Backbone.View();
            }
        },

        itemViewOptions: function () {
            var existingOptions = FetchableCollectionView.prototype.itemViewOptions;
            if (_.isFunction(existingOptions))
                existingOptions = existingOptions.apply(this, arguments);

            var options = _.defaults({
                channel: this.channel,
                hideImage: this.hideImage,
            }, existingOptions);

            return options;
        },

        initialize: function (options) {
            this.channel = options && options.channel;
            this.hideImage = options && options.hideImage;

            FetchableCollectionView.prototype.initialize.apply(this, arguments);
        },
    });

    return GenericCardCollectionView;
});

define('home/views/common/ActivityCardView',[
    'backbone-marionette',
], function (
    Marionette
) {
    'use strict';

    var parent = Marionette.ItemView;
    var parentProto = parent.prototype;

    /**
     * @classdesc Abstract class for views that present activity data
     * @class
     */
    return parent.extend({
        constructor: function (options) {
            parentProto.constructor.call(this, options);

            // Toggle the unread class on this view's element based on boolean model attribute.
            //
            // Avoid using `className`, `initialize`, or `render` because these methods
            // increase the chance that a consuming developer will accidentally override
            // this feature (className because it can be passed as option to the constructor,
            // initialize and render because they are no-ops in Backbone and Marionette so
            // developers are used to implementing them without calling the parent method).
            //
            // Avoid using `setElement` because it is used by private method _ensureElement
            // (relying on it increases chance of breaking change when Backbone upgrades)
            this.listenTo(this.model, 'change:isFromUnreadQueue', this.updateUnreadClass);

            // Do not sync .unread class with model -- i.e., do not do:
            // this.updateUnreadClass();
            // because currently code in other places sets the initial state for .unread
        },

        /**
         * Toggle the unread class on this view's element based on boolean model attribute.
         */
        updateUnreadClass: function () {
            this.$el.toggleClass('unread', Boolean(this.model.get('isFromUnreadQueue')));
        },
    });
});

define('home/templates/channelCardPost',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<span class=\"label label-danger\">"
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"hiddenExplanation") : depth0), depth0))
    + "</span>\n";
},"3":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"excerpt") : depth0), depth0))
    + "\n";
},"5":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = container.lambda((depth0 != null ? lookupProperty(depth0,"message") : depth0), depth0)) != null ? stack1 : "")
    + "\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, alias3=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"post-comments\">\n<div class=\"post-comments__origin link-inner-gray\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"forumLink"),((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1),{"name":"forumLink","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n<div class=\"post-comments__reason\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"userAvatar"),(depth0 != null ? lookupProperty(depth0,"author") : depth0),{"name":"userAvatar","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + ((stack1 = container.invokePartial(lookupProperty(partials,"userName"),(depth0 != null ? lookupProperty(depth0,"author") : depth0),{"name":"userName","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "<a class=\"time link-gray post-comments__time\"\nhref=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"discussionRoute") : depth0), depth0))
    + "#comment-"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"id") : depth0), depth0))
    + "\"\ndata-link-name=\"timestamp\"\ndata-thread-id=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + "\">\n\n"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"relativeTime") : depth0), depth0))
    + "\n</a>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias3,(depth0 != null ? lookupProperty(depth0,"isHidden") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":15,"column":0},"end":{"line":17,"column":7}}})) != null ? stack1 : "")
    + "</div>\n<div class=\"post-comment__content\">\n<a href=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"discussionRoute") : depth0), depth0))
    + "#comment-"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"id") : depth0), depth0))
    + "\"\nclass=\"truncate link-gray-dark post-comments__lnk\"\ndata-link-name=\"message\"\ndir=\"auto\"\ndata-truncate-lines=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"numLines") : depth0), depth0))
    + "\"\ndata-thread-id=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + "\">"
    + ((stack1 = lookupProperty(helpers,"if").call(alias3,(depth0 != null ? lookupProperty(depth0,"excerpt") : depth0),{"name":"if","hash":{},"fn":container.program(3, data, 0),"inverse":container.program(5, data, 0),"data":data,"loc":{"start":{"line":26,"column":0},"end":{"line":30,"column":7}}})) != null ? stack1 : "")
    + "</a>\n</div>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/ChannelCardPostView',[
    'jquery',
    'underscore',
    'backbone-marionette',
    'core/strings',
    'core/utils/html',

    'home/mixins/withAllstarPopover',
    'home/mixins/withTruncate',
    'home/mixins/withSubviews',
    'home/utils/datetimeUtils',

    'home/templates/channelCardPost',
], function (
    $,
    _,
    Marionette,
    strings,
    html,

    withAllstarPopover,
    withTruncate,
    withSubviews,
    datetimeUtils,

    channelCardPostTemplate
) {
    'use strict';

    var gettext = strings.get;

    var parent = Marionette.ItemView;


    var ChannelCardPostView = parent.extend({
        className: 'post-comments__wrapper',
        template: channelCardPostTemplate,

        templateHelpers: function () {
            var state = this.model.get('state');

            return {
                isHidden: state !== 'visible',
                hiddenExplanation: {
                    flagged: gettext('Pending'),
                    pending: gettext('Pending'),
                    spam: gettext('Detected as spam'),
                    deleted: gettext('Removed'),
                }[state],
                message: this.replaceLinks(this.model.get('message')),
                discussionRoute: this.model.thread.getDiscussionRoute(),
                relativeTime: datetimeUtils.getRelativeDatetime(this.model.get('createdAt')),
                numLines: $(window).width() <= 875 ? 4 : 2,
            };
        },

        /**
         * Replace all anchor tags in the post with their text content, after replacing all text urls with icons.
         *
         * @param {string} message Original message to be decorated with icons
         * @returns {string} Processed HTML
         */
        replaceLinks: function (message) {
            var mediaUrls = _.pluck(this.model.get('media'), 'url');
            var replaceFn = function (link) {
                var iconType = _.contains(mediaUrls, link.href) ? 'images' : 'link';
                // Show an image icon for rich media urls, and an external link icon
                // for all other urls.
                return '<span class="text-smaller icon-' + iconType + '"></span>';
            };
            return html.replaceAnchors(message, replaceFn);
        },
    });

    withAllstarPopover.call(ChannelCardPostView.prototype);
    withTruncate.call(ChannelCardPostView.prototype);
    withSubviews.call(ChannelCardPostView.prototype);

    return ChannelCardPostView;
});

define('home/templates/channelCardFooter',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<li class=\"button__wrapper--recommend -count"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,lookupProperty(helpers,"gt").call(alias1,(depth0 != null ? lookupProperty(depth0,"likes") : depth0),9,{"name":"gt","hash":{},"data":data,"loc":{"start":{"line":3,"column":50},"end":{"line":3,"column":62}}}),{"name":"if","hash":{},"fn":container.program(2, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":3,"column":44},"end":{"line":3,"column":77}}})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"favorited") : depth0),{"name":"if","hash":{},"fn":container.program(4, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":3,"column":77},"end":{"line":3,"column":116}}})) != null ? stack1 : "")
    + "\" data-action=\"favorite\">\n<a class=\"button--recommend button-small\" href=\"#\">\n<span class=\"button__heart icon-heart\"></span>\n<span class=\"button__text hidden-md\">"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(alias1,"Recommend",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":6,"column":37},"end":{"line":6,"column":60}}}))
    + "</span>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"likes") : depth0),{"name":"if","hash":{},"fn":container.program(6, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":7,"column":0},"end":{"line":9,"column":7}}})) != null ? stack1 : "")
    + "</a>\n</li>\n";
},"2":function(container,depth0,helpers,partials,data) {
    return " -wide";
},"4":function(container,depth0,helpers,partials,data) {
    return " is-recommended";
},"6":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<span class=\"button__count\">"
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"likes") : depth0), depth0))
    + "</span>\n";
},"8":function(container,depth0,helpers,partials,data) {
    return "<span class=\"icon icon-lock spacing-right-small\"></span>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.lambda, alias3=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<ul class=\"list--layout\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"authenticated") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":2,"column":0},"end":{"line":12,"column":7}}})) != null ? stack1 : "")
    + "<li>\n<a class=\"button button-lnk spacing-right-small\"\nhref=\""
    + alias3(alias2((depth0 != null ? lookupProperty(depth0,"discussionRoute") : depth0), depth0))
    + "\"\ndata-link-name=\"view_discussion\"\ndata-thread-id=\""
    + alias3(alias2((depth0 != null ? lookupProperty(depth0,"id") : depth0), depth0))
    + "\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"isClosed") : depth0),{"name":"if","hash":{},"fn":container.program(8, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":18,"column":0},"end":{"line":20,"column":7}}})) != null ? stack1 : "")
    + alias3(lookupProperty(helpers,"gettext").call(alias1,"Comments %(count)s",{"name":"gettext","hash":{"count":lookupProperty(helpers,"tag").call(alias1,"span",{"name":"tag","hash":{"text":(depth0 != null ? lookupProperty(depth0,"posts") : depth0),"class":"label--count"},"data":data,"loc":{"start":{"line":22,"column":8},"end":{"line":22,"column":52}}})},"data":data,"loc":{"start":{"line":21,"column":0},"end":{"line":22,"column":54}}}))
    + "\n</a>\n</li>\n<li class=\"dropdown\" data-dropdown=\"enabled\">\n<a class=\"button button-link dropdown-toggle\" data-toggle=\"dropdown\" href=\"#\">\n"
    + alias3(lookupProperty(helpers,"gettext").call(alias1,"Share",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":27,"column":0},"end":{"line":27,"column":19}}}))
    + "\n</a>\n<ul class=\"dropdown-menu dropdown--share-menu\">\n<li>\n<a class=\"link\" data-action=\"share\" data-network=\"twitter\" href=\"#\">\n<span class=\"icon icon-twitter text-smaller icon__position -inline\"></span>\n<strong>"
    + alias3(lookupProperty(helpers,"gettext").call(alias1,"Tweet this",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":33,"column":8},"end":{"line":33,"column":32}}}))
    + "</strong>\n</a>\n</li>\n<li>\n<a class=\"link\" data-action=\"share\" data-network=\"facebook\" href=\"#\">\n<span class=\"icon icon-facebook text-smaller icon__position -inline\"></span>\n<strong>"
    + alias3(lookupProperty(helpers,"gettext").call(alias1,"Post to Facebook",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":39,"column":8},"end":{"line":39,"column":38}}}))
    + "</strong>\n</a>\n</li>\n</ul>\n</li>\n</ul>\n";
},"useData":true})

});
define('home/views/ChannelCardFooterView',[
    'home/views/ThreadCardDefaultFooterView',

    'home/templates/channelCardFooter',
], function (
    ThreadCardDefaultFooterView,

    channelCardFooterTemplate
) {
    'use strict';

    var parent = ThreadCardDefaultFooterView;
    var parentProto = parent.prototype;

    var ChannelCardFooterView = parent.extend({
        template: channelCardFooterTemplate,

        toggleThreadFavorited: function (evt) {
            parentProto.toggleThreadFavorited.call(this, evt);
            this.$('[data-action=favorite]').addClass('animate-recommend');
        },
    });

    return ChannelCardFooterView;
});

define('home/views/TopicTagView',[
    'backbone-marionette',
    'handlebars',
], function (
    Marionette,
    Handlebars
) {
    'use strict';

    var TopicTagView = Marionette.ItemView.extend({
        template: Handlebars.partials.topicTag,
        className: function () {
            return 'tag__item' + (this.model.get('hidden') ? ' hidden-topic' : '');
        },

        events: {
            'click [data-action=remove-tag]': 'removeTag',
        },

        initialize: function (options) {
            // Depending on where the user comes from the topic route
            // might be a global or channel-specific context. This view
            // doesn't need to know what the base is, it just needs to
            // append the topic id.
            this.topicRoute = options && options.baseTopicRoute ?
                options.baseTopicRoute + this.model.id + '/' : null;
        },

        templateHelpers: function () {
            return {
                topicRoute: this.topicRoute,
            };
        },

        removeTag: function (evt) {
            if (evt)
                evt.preventDefault();

            this.trigger('removeTag');
        },
    });

    return TopicTagView;
});

define('home/views/TopicTagCollectionView',[
    'backbone-marionette',

    'home/views/TopicTagView',
], function (
    Marionette,

    TopicTagView
) {
    'use strict';

    var TopicTagCollectionView = Marionette.CollectionView.extend({
        className: 'topic-group__wrapper',

        itemView: TopicTagView,
        itemViewOptions: function () {
            return {
                baseTopicRoute: this.baseTopicRoute,
            };
        },

        initialize: function (options) {
            options = options || {};

            this.baseTopicRoute = options.baseTopicRoute;

            if (!this.baseTopicRoute && options.channel)
                this.baseTopicRoute = '/home/channel/' + options.channel.id + '/topics/';
        },
    });

    return TopicTagCollectionView;
});

define('home/templates/spamAlert',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"alert alert--error -spam align-min-tablet align--between align--middle\">\n<div class=\"spacing-narrow text-medium\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"This discussion might be spam, so it's hidden to other readers.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":3,"column":0},"end":{"line":3,"column":77}}}))
    + "\n</div>\n<div class=\"spacing-narrow\">\n<button class=\"button button-inverted -hover-opaque button-padding-taller button-wide--mobile text-medium\" data-action=\"mark-approved\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"This isn't spam",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":7,"column":0},"end":{"line":7,"column":29}}}))
    + "\n</button>\n</div>\n</div>\n";
},"useData":true})

});
define('home/views/SpamAlertView',[
    'backbone-marionette',

    'home/templates/spamAlert',
], function (
    Marionette,

    spamAlertTemplate
) {
    'use strict';

    return Marionette.ItemView.extend({
        template: spamAlertTemplate,
    });
});

define('home/mixins/asChannelCard',[
    'jquery',
    'underscore',
    'backbone-marionette',
    'handlebars',

    'core/utils/auth',

    'home/models/Session',

    'home/views/ChannelCardPostView',
    'home/views/ChannelCardFooterView',
    'home/views/TopicTagCollectionView',
    'home/views/SpamAlertView',

    'home/mixins/withAllstarPopover',
    'home/mixins/withTruncate',
    'home/mixins/withSubviews',
], function (
    $,
    _,
    Marionette,
    Handlebars,

    auth,

    Session,

    ChannelCardPostView,
    ChannelCardFooterView,
    TopicTagCollectionView,
    SpamAlertView,

    withAllstarPopover,
    withTruncate,
    withSubviews
) {
    'use strict';

    var asChannelCard = {
        regions: {
            postsRegion: '[data-role=posts]',
            footerRegion: '[data-role=footer]',
            topicsRegion: '[data-role=topics]',
            cardAlertRegion: '[data-role=card-alert]',
        },

        events: {
            'click [data-action=menuitem-click]': 'handleMenuItemClick',
            'click [data-action=mark-approved]': 'markApproved',
        },

        className: function (existingClassName) {
            if (_.contains(this.options.filterVerbs, this.model.get('verb')))
                return 'hidden';

            if (_.isFunction(existingClassName))
                existingClassName = existingClassName.apply(this, _.rest(arguments));

            existingClassName = existingClassName || '';

            return [
                'card-wrap',
                'card--channel',
                existingClassName,
            ].join(' ');
        },

        initialize: function (_initialize, options) {
            options = options || {};
            _initialize.call(this, options);

            this.session = Session.get();
            this.channel = options.channel;
            this.hideImage = options.hideImage;
            this.listenTo(this.model.thread, 'change:content', this.render);
            this.numTitleLines = options.numTitleLines || 3;
            this.showTopics = this.model.thread.topics.length &&
                this.channel;
            this.isChannelFeed = options.isChannelFeed;

            var thread = this.model.thread;

            // Ensure computations for values that will be used in this view
            thread.getEditPermissions(this.session);
            thread.isAuthorSessionUser(this.session);
            thread.getModeratePermissions(this.session);

            this.listenTo(thread, {
                'change:userSubscription change:isDeleted change:canModerate change:isSpam': this.renderMenu,
                'change:canEdit': this.render,
                'change:isSpam': this.updateSpamIndicators,
            });
            this.listenTo(this.session, 'change:id', this.render);
        },

        serializeData: function (_serializeData) {
            var data = _serializeData.call(this);
            var thread = this.model.thread;
            var postsPreview = this.model.getPostsPreviewCollection();
            var friendlyUrl = thread.getFriendlySourceUrl() || thread.forum.getFriendlyUrl();
            var channel = this.channel || thread.forum.channel;
            var isAuthor = thread.get('isAuthor');

            // Only allow channel discussions to be edited until the create/edit form supports network discussions.
            var canEdit = thread.forum.channel && thread.get('canEdit');
            var canDelete = canEdit && (
                channel && auth.getFromCookie().staff ||
                _.contains(this.session.moderatedForums, thread.forum.id)
            );

            return _.defaults(data, {
                recentPostCount: postsPreview.length,
                discussionRoute: thread.getDiscussionRoute(this.channel),
                threadDescription: thread.getPlainDescription(),
                image: thread.getImage(),
                numTitleLines: this.numTitleLines,
                threadOverrides: this.model.getThreadOverrides(),
                forumFriendlyUrl: friendlyUrl,
                canEdit: canEdit,
                canDelete: canDelete,
                canModerate: thread.get('canModerate'),
                channel: channel,
                isChannelFeed: this.isChannelFeed,
                isSpam: thread.get('isSpam'),
                isAuthor: isAuthor,
            });
        },

        render: function (_render) {
            _render.call(this);

            if (this.$(this.postsRegion.selector).length)
                this.activateRegion(this.postsRegion, asChannelCard.createPostsView);

            if (this.showTopics)
                this.activateRegion(this.topicsRegion, asChannelCard.createTopicsView);

            this.activateRegion(this.footerRegion, asChannelCard.createFooter);

            this.updateSpamIndicators();

            return this;
        },

        /**
         * Updates the view to indicate that the thread is not spam.
         */
        removeSpamModTools: function () {
            this.cardAlertRegion.close();
            this.$el.removeClass('is-spam');
        },

        /**
         * Updates the view to indicate that the thread is spam.
         */
        showSpamModTools: function () {
            this.activateRegion(this.cardAlertRegion, asChannelCard.createSpamAlertView);
            this.$el.addClass('is-spam');
        },

        /**
         * Determines whether or not isSpam is true and updates the view appropriately.
         */
        updateSpamIndicators: function () {
            if (this.model.thread.get('isSpam')) {
                // Spam items can appear in feeds for moderators and authors. Only show the alert
                // to the moderators, since it contains the ability to approved as not-spam.
                this.model.thread.getModeratePermissions(this.session).then(_.bind(function (canModerate) {
                    if (canModerate)
                        this.showSpamModTools();
                    else
                        this.removeSpamModTools();
                }, this));
            } else {
                this.removeSpamModTools();
            }

            this.renderBadges();
        },

        renderBadges: function () {
            var data = this.serializeData();
            data = this.mixinTemplateHelpers(data);

            // Replace wrapper element because it comes as part of the partial. Done to make it easier
            // for many templates to use this partial without needing to also add the wrapper.
            this.$('[data-role=badges]').replaceWith(Handlebars.partials.badges(data));
        },

        renderMenu: function () {
            var data = this.serializeData();
            data = this.mixinTemplateHelpers(data);

            // Pass to the template whether or not the menu is currently open,
            // so that rerendering will maintain the open/closed state.
            data.menuOpen = this.$('.dropdown').hasClass('open');

            this.$('[data-role=menu]').replaceWith(Handlebars.partials.channelCardMenu(data));
        },

        createSpamAlertView: function () {
            return new SpamAlertView();
        },

        createPostsView: function () {
            var postsPreview = this.model.getPostsPreviewCollection();
            return new Marionette.CollectionView({
                itemView: ChannelCardPostView,
                collection: postsPreview,
            });
        },

        createTopicsView: function () {
            var topics = this.model.thread.topics;

            return new TopicTagCollectionView({
                collection: topics,
                channel: this.channel,
            });
        },

        _createFooter: function (el) {
            return new ChannelCardFooterView({
                el: el,
                model: this.model.thread,
                channel: this.channel,
            });
        },

        createFooter: function () {
            return asChannelCard._createFooter.call(this, this.footerRegion.el);
        },

        handleMenuItemClick: function (evt) {
            if (evt) {
                evt.preventDefault();

                // Prevent dropdown menu from closing when clicking inside
                evt.stopPropagation();

                var menuItem = $(evt.currentTarget).attr('data-menu-item');
                switch (menuItem) {
                case 'toggle-subscription':
                    this.toggleSubscription();
                    break;
                case 'toggle-follow-targetchannel':
                    this.toggleFollowTargetChannel();
                    break;
                case 'delete-thread':
                    this.model.thread.confirmDelete(true);
                    break;
                case 'restore-thread':
                    this.model.thread.restore();
                    break;
                case 'mark-spam':
                    this.model.thread.toggleIsSpam();
                    break;
                }
            }
        },

        markApproved: function () {
            this.model.thread.markAsSpam(false);
        },

        toggleSubscription: function () {
            this.model.thread.toggleSubscription();
        },

        toggleFollowTargetChannel: function () {
            var targetChannel = this.model.activities[0].targetChannel;
            if (targetChannel)
                targetChannel.toggleFollowed();
        },
    };

    return function () {
        withTruncate.apply(this, arguments);
        withSubviews.call(this);
        withAllstarPopover.call(this);

        this.regions = _.extend({}, asChannelCard.regions, this.regions);
        this.events = _.extend({}, asChannelCard.events, this.events);
        this.className = _.wrap(this.className, asChannelCard.className);
        this.initialize = _.wrap(this.initialize, asChannelCard.initialize);
        this.serializeData = _.wrap(this.serializeData, asChannelCard.serializeData);
        this.render = _.wrap(this.render, asChannelCard.render);

        _.extend(this, _.pick(asChannelCard,
            'handleMenuItemClick',
            'toggleSubscription',
            'toggleFollowTargetChannel',
            'renderMenu',
            'markApproved',
            'updateSpamIndicators',
            'showSpamModTools',
            'removeSpamModTools',
            'renderBadges'
        ));
    };
});

define('home/mixins/withChannelAvatar',[
    'underscore',
], function (
    _
) {
    'use strict';

    // Return the mixin properties and functions with a closure around
    // the getChannel function, specified on a per-mixin basis
    function getWithChannelAvatar(getChannel) {
        return {
            templateHelpers: function () {
                var channel = getChannel.call(this);
                var bannerColor = channel && channel.get('bannerColor');
                var channelInitial = channel && channel.get('name') && channel.get('name').charAt(0);

                return {
                    channel: channel && channel.toJSON(),
                    channelAvatar: channel && (channel.get('avatar') || channel.get('options').favicon),
                    bannerColorClass: bannerColor ? '-' + bannerColor : '',
                    channelInitial: channelInitial,
                };
            },
        };
    }

    /**
     * Mixes in the core channel following functionality, and the home-specific
     * follow tooltip.
     */
    function withChannelAvatar(_getChannel) {

        // A function to get the channel model for this view. If a special getter
        // is not given, channel is assumed to be the view's model.
        // This is passed to all the ChannelFollowTooltipWrapper functions that
        // require the channel model.
        var getChannel = _getChannel || function () {
            return this.model;
        };

        var withChannelAvatarMixin = getWithChannelAvatar(getChannel);

        this.templateHelpers = _.wrap(this.templateHelpers, function (_templateHelpers) {
            var data = _.isFunction(_templateHelpers) ? _templateHelpers.call(this) : _templateHelpers;

            return _.extend(withChannelAvatarMixin.templateHelpers.call(this), data);
        });
    }

    return withChannelAvatar;
});

define('home/views/ChannelCardView',[
    'home/views/common/ActivityCardView',
    'home/mixins/asChannelCard',
    'home/mixins/withChannelAvatar',
    'home/mixins/withReason',
], function (
    ActivityCardView,
    asChannelCard,
    withChannelAvatar,
    withReason
) {
    'use strict';

    /**
     * Base class for channel cards, cannot be used on it's own.
     */
    var ChannelCardView = ActivityCardView.extend({
        getChannel: function () {
            return this.channel || this.model.thread.forum.channel;
        },
    });

    asChannelCard.call(ChannelCardView.prototype);
    withReason.call(ChannelCardView.prototype);
    withChannelAvatar.call(
        ChannelCardView.prototype,
        ChannelCardView.prototype.getChannel
    );

    return ChannelCardView;
});


define('home/templates/channelCardFavorite',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div data-role=\"card-alert\"></div>\n<div class=\"card__header -feed is-recommended\">\n<div class=\"card__reason link-inner-gray-dark\">\n<span class=\"icon-heart icon__position -inline text-smaller text-gray-light\"></span>\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"%(group)s recommended",{"name":"gettext","hash":{"group":lookupProperty(helpers,"getPartial").call(alias1,"userGroupNames",{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":6,"column":8},"end":{"line":6,"column":37}}})},"data":data,"loc":{"start":{"line":5,"column":0},"end":{"line":6,"column":39}}}))
    + "\n\n<time class=\"bullet text-gray\">"
    + alias2(container.lambda((depth0 != null ? lookupProperty(depth0,"relativeTime") : depth0), depth0))
    + "</time>\n</div>\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"cardReasonForum"),depth0,{"name":"cardReasonForum","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + ((stack1 = container.invokePartial(lookupProperty(partials,"channelCardMenu"),depth0,{"name":"channelCardMenu","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"channelCardContent"),depth0,{"name":"channelCardContent","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "");
},"usePartial":true,"useData":true})

});
define('home/views/ChannelCardFavoriteView',[
    'underscore',

    'home/views/ChannelCardView',
    'home/templates/channelCardFavorite',
], function (
    _,

    ChannelCardView,
    channelCardFavoriteTemplate
) {
    'use strict';

    var ChannelCardFavoriteView = ChannelCardView.extend({
        template: channelCardFavoriteTemplate,

        templateHelpers: function () {
            var data = ChannelCardView.prototype.templateHelpers.apply(this, arguments);
            return _.extend(data, {
                forumHref: '/home/forum/' + this.model.thread.forum.id + '/',
            });
        },
    });

    return ChannelCardFavoriteView;
});

define('home/templates/channelCardCreate',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a class=\"spacing-right align__item\" href=\"/by/"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"username") : depth0), depth0))
    + "/\" data-link-name=\"user_avatar\">\n<img\nclass=\"img-round-sm block__item\"\nsrc=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"avatar") : depth0)) != null ? lookupProperty(stack1,"cache") : stack1), depth0))
    + "\"\nalt=\""
    + ((stack1 = container.invokePartial(lookupProperty(partials,"userNameNoLink"),depth0,{"name":"userNameNoLink","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "\" />\n</a>\n";
},"3":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = container.invokePartial(lookupProperty(partials,"cardReasonForum"),depth0,{"name":"cardReasonForum","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "");
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div data-role=\"card-alert\"></div>\n<div class=\"card__inner\">\n<div class=\"card__header -feed\">\n<div class=\"card__reason link-inner-gray-dark align align--middle\">\n"
    + ((stack1 = lookupProperty(helpers,"with").call(alias1,(depth0 != null ? lookupProperty(depth0,"firstActor") : depth0),{"name":"with","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":5,"column":0},"end":{"line":12,"column":9}}})) != null ? stack1 : "")
    + "<div class=\"align__item\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"%(user)s started a discussion",{"name":"gettext","hash":{"user":lookupProperty(helpers,"getPartial").call(alias1,"userGroupNames",{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":14,"column":49},"end":{"line":14,"column":78}}})},"data":data,"loc":{"start":{"line":14,"column":0},"end":{"line":14,"column":80}}}))
    + "\n<time class=\"bullet text-gray\">"
    + alias2(container.lambda((depth0 != null ? lookupProperty(depth0,"relativeTime") : depth0), depth0))
    + "</time>\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"badges"),depth0,{"name":"badges","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n</div>\n"
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"isChannelFeed") : depth0),{"name":"unless","hash":{},"fn":container.program(3, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":19,"column":0},"end":{"line":21,"column":11}}})) != null ? stack1 : "")
    + "\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"channelCardMenu"),depth0,{"name":"channelCardMenu","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"channelCardContent"),depth0,{"name":"channelCardContent","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/ChannelCardCreateView',[
    'home/views/ChannelCardView',
    'home/templates/channelCardCreate',
], function (
    ChannelCardView,
    channelCardCreateTemplate
) {
    'use strict';

    var ChannelCardCreateView = ChannelCardView.extend({
        template: channelCardCreateTemplate,
    });

    return ChannelCardCreateView;
});

define('home/templates/channelCardTrending',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    return " is-recommended";
},"3":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a class=\"spacing-right align__item\"\nhref=\"/home/channel/"
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"channel") : depth0)) != null ? lookupProperty(stack1,"slug") : stack1), depth0))
    + "/\"\ndata-link-name=\"forum_avatar\"\ndata-forum-pk=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"pk") : depth0), depth0))
    + "\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"channelAvatar") : depth0),{"name":"if","hash":{},"fn":container.program(4, data, 0),"inverse":container.program(6, data, 0),"data":data,"loc":{"start":{"line":10,"column":0},"end":{"line":16,"column":7}}})) != null ? stack1 : "")
    + "</a>\n";
},"4":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<img class=\"img-round-sm block__item\" src=\""
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"channelAvatar") : depth0), depth0))
    + "\" alt=\""
    + ((stack1 = container.invokePartial(lookupProperty(partials,"forumName"),depth0,{"name":"forumName","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "\">\n";
},"6":function(container,depth0,helpers,partials,data) {
    var alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"channel-avatar "
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"bannerColorClass") : depth0), depth0))
    + "\">\n<p class=\"channel-avatar__name\">"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"channelInitial") : depth0), depth0))
    + "</p>\n</div>\n";
},"8":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"with").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1),{"name":"with","hash":{},"fn":container.program(9, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":19,"column":0},"end":{"line":26,"column":9}}})) != null ? stack1 : "");
},"9":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a class=\"spacing-right align__item\"\nhref=\"/home/forum/"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"id") : depth0), depth0))
    + "/\"\ndata-link-name=\"forum_avatar\"\ndata-forum-pk=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"pk") : depth0), depth0))
    + "\">\n<img src=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"faviconImage") : depth0), depth0))
    + "\" alt=\""
    + ((stack1 = container.invokePartial(lookupProperty(partials,"forumName"),depth0,{"name":"forumName","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "\" class=\"img-round-sm block__item\" />\n</a>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div data-role=\"card-alert\"></div>\n<div class=\"card__header -feed"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"isBestOfDisqus") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":2,"column":30},"end":{"line":2,"column":74}}})) != null ? stack1 : "")
    + "\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"cardReasonDisqusPicks"),depth0,{"name":"cardReasonDisqusPicks","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "<div class=\"card__reason align align--middle\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"channel") : depth0),{"name":"if","hash":{},"fn":container.program(3, data, 0),"inverse":container.program(8, data, 0),"data":data,"loc":{"start":{"line":5,"column":0},"end":{"line":27,"column":7}}})) != null ? stack1 : "")
    + "<div class=\"align__item link-inner-gray-dark\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Trending on %(forumLink)s",{"name":"gettext","hash":{"forumLink":lookupProperty(helpers,"getPartial").call(alias1,"forumLink",((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1),{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":29,"column":50},"end":{"line":29,"column":87}}})},"data":data,"loc":{"start":{"line":29,"column":0},"end":{"line":29,"column":89}}}))
    + "\n<time class=\"bullet text-gray\">"
    + alias2(container.lambda((depth0 != null ? lookupProperty(depth0,"relativeTime") : depth0), depth0))
    + "</time>\n</div>\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"badges"),depth0,{"name":"badges","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"channelCardMenu"),depth0,{"name":"channelCardMenu","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"channelCardContent"),depth0,{"name":"channelCardContent","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "");
},"usePartial":true,"useData":true})

});
define('home/views/ChannelCardTrendingView',[
    'home/views/ChannelCardView',
    'home/templates/channelCardTrending',
], function (
    ChannelCardView,
    channelTrendingTemplate
) {
    'use strict';

    var ChannelCardTrendingView = ChannelCardView.extend({
        template: channelTrendingTemplate,
    });

    return ChannelCardTrendingView;
});

define('home/templates/channelCardShare',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    return " is-recommended";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div data-role=\"card-alert\"></div>\n<div class=\"card__header -feed"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"isBestOfDisqus") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":2,"column":30},"end":{"line":2,"column":74}}})) != null ? stack1 : "")
    + "\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"cardReasonDisqusPicks"),depth0,{"name":"cardReasonDisqusPicks","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + ((stack1 = container.invokePartial(lookupProperty(partials,"cardReasonForum"),depth0,{"name":"cardReasonForum","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + ((stack1 = container.invokePartial(lookupProperty(partials,"channelCardMenu"),depth0,{"name":"channelCardMenu","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"channelCardContent"),depth0,{"name":"channelCardContent","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "");
},"usePartial":true,"useData":true})

});
define('home/views/ChannelCardShareView',[
    'underscore',

    'core/config',

    'home/views/ChannelCardView',
    'home/templates/channelCardShare',
], function (
    _,

    config,

    ChannelCardView,
    channelCardShareTemplate
) {
    'use strict';

    var ChannelCardShareView = ChannelCardView.extend({
        template: channelCardShareTemplate,

        templateHelpers: function () {
            var data = ChannelCardView.prototype.templateHelpers.apply(this, arguments);
            return _.extend(data, {
                guestAvatar: config.urls.avatar.generic,
            });
        },
    });

    return ChannelCardShareView;
});

define('home/templates/channelFeedEmpty',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"empty-message card-wrap\">\n<img class=\"empty-message__img\" src=\""
    + alias2(lookupProperty(helpers,"urlfor").call(alias1,"cdn",{"name":"urlfor","hash":{},"data":data,"loc":{"start":{"line":2,"column":37},"end":{"line":2,"column":53}}}))
    + "/img/empty-states/discussions.png\"/>\n<div class=\"empty-message__content\">\n<h2 class=\"text-larger\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"This channel doesn't have any discussions yet.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":4,"column":24},"end":{"line":4,"column":84}}}))
    + "</h2>\n<p class=\"text-gray text-medium\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Discussions started by people in this channel will appear here.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":5,"column":33},"end":{"line":5,"column":110}}}))
    + "</p>\n<a href=\"/home/discuss/"
    + alias2(container.lambda(((stack1 = (depth0 != null ? lookupProperty(depth0,"primaryForum") : depth0)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + "/\" class=\"button button-outline button-padding-wider text-large\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Start the first discussion",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":7,"column":0},"end":{"line":7,"column":40}}}))
    + "\n</a>\n</div>\n</div>\n";
},"useData":true})

});
define('home/templates/channelOwnerFeedEmpty',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card-wrap\">\n<div class=\"card__header\">\n<div class=\"card__reason -large\">\n<h1 class=\"text-gray-darker\">\n<span class=\"icon-checkmark icon__position spacing-right-small text-success\"></span>\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Your channel's been created!  Let's kick it off.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":6,"column":0},"end":{"line":6,"column":62}}}))
    + "\n</h1>\n</div>\n</div>\n<div class=\"card__content -empty\">\n<div class=\"card-content__body\">\n<ol class=\"list--numbered spacing-narrow text-gray-darker\">\n<li>\n<h2 class=\"text-large spacing-bottom-small\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Check out the %(exampleChannel)s and read the %(modPlaybook)s.",{"name":"gettext","hash":{"modPlaybook":lookupProperty(helpers,"tag").call(alias1,"a",{"name":"tag","hash":{"text":"Mod Playbook","href":"https://media.disquscdn.com/channel-docs/Mod_Playbook.pdf"},"data":data,"loc":{"start":{"line":17,"column":17},"end":{"line":17,"column":111}}}),"exampleChannel":lookupProperty(helpers,"tag").call(alias1,"a",{"name":"tag","hash":{"text":"example channel","href":"https://disqus.com/home/channel/testchannel/"},"data":data,"loc":{"start":{"line":16,"column":17},"end":{"line":16,"column":101}}})},"data":data,"loc":{"start":{"line":15,"column":0},"end":{"line":17,"column":113}}}))
    + "\n</h2>\n<p class=\"text-gray\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"These will explain how to set up your channel for success.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":20,"column":0},"end":{"line":20,"column":72}}}))
    + "</p>\n</li>\n<li>\n<h2 class=\"text-large spacing-bottom-small\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Start your first, introductory discussion. Here's an %(exampleDiscussion)s.",{"name":"gettext","hash":{"exampleDiscussion":lookupProperty(helpers,"tag").call(alias1,"a",{"name":"tag","hash":{"text":"example discussion","href":"https://disqus.com/home/channel/selectstart/discussion/channel-selectstart/welcome/"},"data":data,"loc":{"start":{"line":25,"column":20},"end":{"line":25,"column":146}}})},"data":data,"loc":{"start":{"line":24,"column":0},"end":{"line":25,"column":148}}}))
    + "\n</h2>\n<p class=\"text-gray spacing-bottom-narrow\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Introduce your future audience to what your channel is about. This notice will disappear once you do.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":28,"column":0},"end":{"line":28,"column":115}}}))
    + "</p>\n<p>\n<a class=\"button button-outline\" href=\"/home/discuss/"
    + alias2(container.lambda(((stack1 = (depth0 != null ? lookupProperty(depth0,"primaryForum") : depth0)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + "/\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Start a discussion",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":31,"column":0},"end":{"line":31,"column":32}}}))
    + "\n</a>\n</p>\n</li>\n<li>\n<h2 class=\"text-large spacing-bottom-small\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Need help? Visit %(channelChat)s for tips on getting started.",{"name":"gettext","hash":{"channelChat":lookupProperty(helpers,"tag").call(alias1,"a",{"name":"tag","hash":{"text":"Channel Chat","href":"https://disqus.com/home/channel/channelchat/"},"data":data,"loc":{"start":{"line":38,"column":14},"end":{"line":38,"column":95}}})},"data":data,"loc":{"start":{"line":37,"column":0},"end":{"line":38,"column":97}}}))
    + "\n</h2>\n<p class=\"text-gray\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"We want your channel to thrive just as much as you do.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":41,"column":0},"end":{"line":41,"column":68}}}))
    + "\n</p>\n</li>\n</ol>\n</div>\n</div>\n</div>\n";
},"useData":true})

});
define('home/views/ChannelFeedEmptyView',[
    'backbone-marionette',

    'home/models/Session',
    'home/templates/channelFeedEmpty',
    'home/templates/channelOwnerFeedEmpty',
], function (
    Marionette,

    Session,
    channelFeedEmptyTemplate,
    channelOwnerFeedEmptyTemplate
) {
    'use strict';

    var ChannelFeedEmptyView = Marionette.ItemView.extend({
        getTemplate: function () {
            if (this.model.get('owner_id') === this.session.user.get('id'))
                return channelOwnerFeedEmptyTemplate;

            return channelFeedEmptyTemplate;
        },

        initialize: function () {
            this.session = Session.get();
        },
    });

    return ChannelFeedEmptyView;
});

define('home/mixins/withViewFeedTracking',[
    'underscore',
    'core/bus',
], function (
    _,
    bus
) {
    'use strict';

    /**
     * Adds Disqus activity event tracking for initial feed view and subsequent
     * page loads.
     * Works with a FetchableCollectionView.
     */
    var withViewFeedTracking = function () {
        var _initialize = this.initialize;
        this.initialize = function () {
            _initialize.apply(this, arguments);

            // Track feed once initial fetch is complete (once we know whether the
            // feed is empty, error, or has content)
            this.listenTo(this, 'renderInitialContent', this.trackView);
        };

        /**
         * Tracks the initial feed view. This is done once after the initial fetch
         * is complete and the result is rendered to ensure that the user is currently
         * viewing the feed, and so we can determin if the feed is empty, or showing
         * an error, and add that information to the event.
         */
        this.trackView = function () {
            bus.trigger('viewFeed', this);

            // Listen to future page fetches to track page loads. This must
            // be deferred because a sync event may trigger for this initial
            // view and we don't want to track that as a subsequent page load.
            _.defer(_.bind(function () {
                this.listenTo(this.collection, 'sync', this.trackViewMore);
            }, this));
        };

        /**
         * Tracks loading subsequent pages of this feed.
         */
        this.trackViewMore = function () {
            bus.trigger('viewMoreFeed', this.getNumPages());
        };

        /**
         * Returns the number of pages that have been loaded for this collection.
         *
         * Override this if this view is not backed by a model which stores
         * numPages (such as a Feed model)
         * @returns {int}
         */
        this.getNumPages = function () {
            return this.model && this.model.get('numPages');
        };
    };

    return withViewFeedTracking;
});

define('home/views/ChannelCardCollectionView',[
    'backbone',
    'core/bus',

    'home/views/GenericCardCollectionView',
    'home/views/ChannelCardFavoriteView',
    'home/views/ChannelCardCreateView',
    'home/views/ChannelCardTrendingView',
    'home/views/ChannelCardShareView',
    'home/views/ChannelFeedEmptyView',
    'home/mixins/withViewFeedTracking',
], function (
    Backbone,
    bus,

    GenericCardCollectionView,
    ChannelCardFavoriteView,
    ChannelCardCreateView,
    ChannelCardTrendingView,
    ChannelCardShareView,
    ChannelFeedEmptyView,
    withViewFeedTracking
) {
    'use strict';

    var ChannelCardCollectionView = GenericCardCollectionView.extend({
        itemView: function (options) {
            switch (options.model.get('verb')) {
            case 'favorite':
                return new ChannelCardFavoriteView(options);
            case 'create':
                return new ChannelCardCreateView(options);
            case 'trending':
                return new ChannelCardTrendingView(options);
            case 'share':
                return new ChannelCardShareView(options);
            default:
                // So that an error isn't thrown by returning null when a view is
                // expected, for activity types not supported by channel feeds
                return new Backbone.View();
            }
        },

        itemViewOptions: function (item, index) {
            var options = GenericCardCollectionView.prototype.itemViewOptions.call(this, item, index);
            options.enableBestOfDisqusCallout = this.enableBestOfDisqusCallout;
            options.filterVerbs = this.filterVerbs;
            options.isChannelFeed = this.isChannelFeed;

            return options;
        },

        emptyView: ChannelFeedEmptyView,

        emptyViewOptions: function () {
            return {
                model: this.channel,
            };
        },

        initialize: function (options) {
            GenericCardCollectionView.prototype.initialize.call(this, options);
            options = options || {};
            this.enableBestOfDisqusCallout = options.enableBestOfDisqusCallout;
            this.filterVerbs = options.filterVerbs;
            this.isChannelFeed = options.isChannelFeed;

            this.listenToOnce(this, 'showFirstItem', function () {
                bus.trigger('showFirstCard', 'channel');
            });
        },
    });

    withViewFeedTracking.call(ChannelCardCollectionView.prototype);

    return ChannelCardCollectionView;
});

define('core/mixins/withChannelFollowing',[
    'underscore',
], function (
    _
) {
    'use strict';

    // Return the mixin properties and functions with a closure around
    // the getChannel function, specified on a per-mixin basis
    function getChannelFollowButtonWrapperView(getChannel) {
        return {
            events: {
                'click [data-action=toggle-follow]': 'toggleFollow',
            },

            initialize: function () {
                this.bindToPrimaryForum();
            },

            templateHelpers: function () {
                return {
                    isFollowing: this.getIsFollowing(),
                };
            },

            bindToPrimaryForum: function () {
                var channelModel = getChannel.call(this);
                if (!channelModel)
                    return;

                if (!channelModel.primaryForum)
                    return void this.listenToOnce(channelModel, 'changeRelated:primaryForum', this.bindToPrimaryForum);

                this.listenTo(channelModel.primaryForum, 'change:isFollowing', this.updateFollowedState);
            },

            updateFollowedState: function () {
                this.$('[data-action=toggle-follow]').toggleClass('active', this.getIsFollowing());
            },

            getIsFollowing: function () {
                var channelModel = getChannel.call(this);
                return channelModel && channelModel.primaryForum && channelModel.primaryForum.get('isFollowing');
            },

            toggleFollow: function (evt) {
                if (evt) {
                    evt.preventDefault();
                    evt.stopPropagation();
                }

                var channelModel = getChannel.call(this);

                // Shouldn't ever take so long to fetch the primary forum that the user
                // has time to click on the follow button, but if it happen, don't want
                // to toggle the follow state since the state showing to the user may
                // be incorrect
                if (!channelModel || !channelModel.primaryForum)
                    return;

                // Forum's toggleFollowed will account for channels that should be followed
                // directly
                channelModel.primaryForum.toggleFollowed();

                // Allow project specific callbacks when toggle follow occurs, specifically
                // when it doesn't return early
                this.trigger('toggled:follow', evt);
            },
        };
    }

    function withChannelFollowing(_getChannel) {
        // A function to get the channel model for this view. If a special getter
        // is not given, channel is assumed to be the view's model.
        // This is passed to all the ChannelFollowButtonWrapperView functions that
        // require the channel model.
        var getChannel = _getChannel || function () {
            return this.model;
        };

        var ChannelFollowButtonWrapperView = getChannelFollowButtonWrapperView(getChannel);

        this.initialize = _.wrap(this.initialize, function (_initialize, options) {
            _initialize.call(this, options);
            ChannelFollowButtonWrapperView.initialize.call(this, options);
        });

        this.templateHelpers = _.wrap(this.templateHelpers, function (_templateHelpers) {
            var helpers = _.isFunction(_templateHelpers) ?
                _templateHelpers.call(this) :
                _templateHelpers;

            return _.extend(
                ChannelFollowButtonWrapperView.templateHelpers.call(this),
                helpers);
        });

        this.bindToPrimaryForum = _.wrap(this.bindToPrimaryForum, function (_bindToPrimaryForum) {
            if (_bindToPrimaryForum)
                _bindToPrimaryForum.call(this);

            ChannelFollowButtonWrapperView.bindToPrimaryForum.call(this);
        });

        this.events = _.extend({}, ChannelFollowButtonWrapperView.events, this.events);

        _.extend(this, _.pick(ChannelFollowButtonWrapperView,
            'updateFollowedState',
            'getIsFollowing',
            'toggleFollow'));
    }

    return withChannelFollowing;
});

define('home/templates/channelPromotionDiscussion',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"discussionRoute") : depth0), depth0))
    + "\" class=\"channel-item__link\">\n<div class=\"channel-item__heading spacing-bottom-small\">\n<h2 class=\"truncate\" data-truncate-lines=\"2\">"
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"clean_title") : stack1), depth0))
    + "</h2>\n</div>\n<div class=\"channel-item__footer\">\n<span class=\"channel-item__count\">"
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"posts") : stack1), depth0))
    + "</span>\n<span class=\"channel-item__comment\">"
    + alias2(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Comments",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":7,"column":36},"end":{"line":7,"column":58}}}))
    + "</span>\n</div>\n</a>\n";
},"useData":true})

});
define('home/views/ChannelPromotionDiscussionView',[
    'backbone-marionette',

    'home/mixins/withTruncate',

    'home/templates/channelPromotionDiscussion',
], function (
    Marionette,

    withTruncate,

    channelPromotionDiscussionTemplate
) {
    'use strict';

    /**
     * A single thread shown on a channel promotion card. Shows the title,
     * comment count, and a couple of the first lines of the thread.
     *
     * Expects an Activity model that has a related Thread model.
     */
    var ChannelPromotionDiscussionView = Marionette.ItemView.extend({
        template: channelPromotionDiscussionTemplate,
        templateHelpers: function () {
            return {
                discussionRoute: this.model.thread.getDiscussionRoute(),
            };
        },
    });

    withTruncate.call(ChannelPromotionDiscussionView.prototype);

    return ChannelPromotionDiscussionView;
});

define('home/templates/channelPromotion',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<img src=\""
    + container.escapeExpression(container.lambda(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"channel") : depth0)) != null ? lookupProperty(stack1,"options") : stack1)) != null ? lookupProperty(stack1,"tile") : stack1), depth0))
    + "\" class=\"tile__media\" />\n";
},"3":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"tile__overlay\">\n<h1 class=\"tile__name\">"
    + container.escapeExpression(container.lambda(((stack1 = (depth0 != null ? lookupProperty(depth0,"channel") : depth0)) != null ? lookupProperty(stack1,"name") : stack1), depth0))
    + "</h1>\n</div>\n<img src=\"https://media.disquscdn.com/home/blank_tile.png\"\nclass=\"tile__media\" />\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, alias3=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"channels-module__inner\">\n<a href=\"/home/channel/"
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"channel") : depth0)) != null ? lookupProperty(stack1,"slug") : stack1), depth0))
    + "/\" class=\"tile__wrapper\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias3,((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"channel") : depth0)) != null ? lookupProperty(stack1,"options") : stack1)) != null ? lookupProperty(stack1,"tile") : stack1),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"data":data,"loc":{"start":{"line":3,"column":0},"end":{"line":11,"column":7}}})) != null ? stack1 : "")
    + "</a>\n<div class=\"channels-description\">\n<p>"
    + alias2(alias1(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"channel") : depth0)) != null ? lookupProperty(stack1,"options") : stack1)) != null ? lookupProperty(stack1,"description") : stack1), depth0))
    + "</p>\n</div>\n<div class=\"channels-metadata\">\n<div class=\"padding-gutter align align--middle\" data-role=\"stats\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"channelMetadataStats"),depth0,{"name":"channelMetadataStats","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n</div>\n<div class=\"padding-gutter border-top hidden-lg\">\n<h4 class=\"text-subheading spacing-bottom\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias3,"Recommended Discussions",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":22,"column":43},"end":{"line":22,"column":80}}}))
    + "</h4>\n<section data-role=\"discussions\" class=\"channels-module__discussions\"></section>\n</div>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/ChannelPromotionView',[
    'backbone-marionette',

    'core/mixins/withChannelFollowing',

    'home/views/ChannelPromotionDiscussionView',
    'home/views/FetchingView',

    'home/mixins/withSubviews',

    'home/templates/channelPromotion',
], function (
    Marionette,

    withChannelFollowing,

    ChannelPromotionDiscussionView,
    FetchingView,

    withSubviews,

    channelPromotionTemplate
) {
    'use strict';

    /**
     * A view that shows promotional info about a channel. Shows the tile, description,
     * top discussions, follow button, and stats, in a small card.
     *
     * Expects a ChannelProfile model.
     */
    var ChannelPromotionView = Marionette.ItemView.extend({
        className: 'channels-module__block',
        template: channelPromotionTemplate,

        regions: {
            discussionsRegion: '[data-role=discussions]',
        },

        templateHelpers: function () {
            var primaryForum = this.model.channel.primaryForum;
            var numThreads = primaryForum.get('numThreads');
            var numFollowers = primaryForum.get('numFollowers');
            return {
                // Attributes may be null during fetch
                numThreads: numThreads && numThreads.toLocaleString(),
                numFollowers: numFollowers && numFollowers.toLocaleString(),
            };
        },

        initialize: function () {
            this.bindToPrimaryForum();
        },

        bindToPrimaryForum: function () {
            var channel = this.model.channel;
            if (!channel.primaryForum) {
                this.listenToOnce(channel, 'changeRelated:primaryForum', this.bindToPrimaryForum);
                return;
            }

            this.listenTo(channel.primaryForum, 'change:numThreads change:numFollowers', this.render);
        },

        onRender: function () {
            this.activateRegion(this.discussionsRegion, this.createDiscussionsRegion);
        },

        createDiscussionsRegion: function () {
            return new Marionette.CollectionView({
                itemView: ChannelPromotionDiscussionView,
                itemViewOptions: function (_item, index) {
                    return {
                        className: index > 1 ? 'hidden' : 'channels-module__article',
                    };
                },
                collection: this.model.topActivities.items,
                emptyView: function () {
                    return new FetchingView({
                        className: 'spinner-small',
                    });
                },
            });
        },
    });

    var proto = ChannelPromotionView.prototype;
    withChannelFollowing.call(proto, function () {
        return this.model.channel;
    });
    withSubviews.call(proto);

    return ChannelPromotionView;
});

define('home/views/PromotedChannelsCardView',[
    'backbone-marionette',

    'home/views/ChannelPromotionView',
], function (
    Marionette,

    ChannelPromotionView
) {
    'use strict';

    var PromotedChannelsCardView = Marionette.CollectionView.extend({
        className: 'card--interstitial',
        itemView: ChannelPromotionView,
    });

    return PromotedChannelsCardView;
});

define('home/mixins/withInterstitialChannelCards',[
    'jquery',
    'underscore',
    'backbone',

    'core/UniqueModel',

    'home/models/ChannelProfileFeed',
    'home/models/Session',
    'home/views/PromotedChannelsCardView',
], function (
    $,
    _,
    Backbone,

    UniqueModel,

    ChannelProfileFeed,
    Session,
    PromotedChannelsCardView
) {
    'use strict';

    var CARD_SPACING = 10;
    var CHANNELS_PER_CARD = 2;

    var withInterstitialChannelCards = {
        initialize: function (_initialize, options) {
            _initialize.call(this, options);

            this.lastIntersitialCardIndex = -1;
            var boundInitializeChannelProfiles = _.bind(this.initializeChannelProfiles, this);
            var session = Session.get();

            // Wait until session has loaded, whether the user is logged in or anon
            session.loadPromise().always(function () {
                // If user is logged in (userProfile is not null), wait until following forums have been
                // fetched before initializing the channel profiles, so the channels that are followed
                // are marked as such and can be filtered out.

                var userProfile = session.getUserProfile();
                var followingForumsPromise = userProfile && userProfile.forumsFollowing.ensureFetched();

                $.when(followingForumsPromise).then(boundInitializeChannelProfiles);
            });
        },

        /**
         * Initializes list of channel profiles to show in interstitial cards. Filters out channels that
         * are already followed and randomizes the order.
         */
        initializeChannelProfiles: function () {
            var interstitialChannelProfileFeed = new UniqueModel(ChannelProfileFeed, {
                listName: ChannelProfileFeed.LIST_NAMES.promoted,
            });

            // Once the promoted channel profiles have been fetched from the api, filter and shuffle
            // them and store the finalized list of channels to promote.
            interstitialChannelProfileFeed.ensureFetched().then(_.bind(function () {
                this.interstitialChannelProfiles = interstitialChannelProfileFeed.items
                    .chain()
                    .reject(function (channelProfile) {
                        return channelProfile.channel.primaryForum.get('isFollowing');
                    })
                    .shuffle()
                    .value();
            }, this));
        },

        /**
         * Calculates the adjusted insert index to keep the interstitial cards in their
         * correct indicies. Does this by adding to the given index the number of
         * interstitial cards that have been inserted between the beginning of the
         * children and the point in which the index-th non-interstitial card is.
         */
        getAdjustedIndex: function (index) {
            var numInterstitialCards = 0;
            var numItemViews = 0;

            _.each(this.children._views, function (view) {
                // Don't need to count cards past the point where we've seen <index>
                // non-interstitial cards.
                if (numItemViews > index)
                    return;

                if (view instanceof PromotedChannelsCardView)
                    numInterstitialCards += 1;
                else
                    numItemViews += 1;
            });

            return index + numInterstitialCards;
        },

        addItemView: function (_addItemView, item, ItemView, index) {
            var adjustedIndex = this.getAdjustedIndex(index);

            // If intention is to insert item at the top of the feed, do so. Otherwise disregard
            // the given index, since it doesn't account for the interstitial cards.
            var retval = _addItemView.call(this, item, ItemView, adjustedIndex);
            adjustedIndex += 1;

            // Only add interstitial channels once the channels list has been built and every
            // CARD_SPACING number of cards apart.
            if (this.interstitialChannelProfiles &&
                adjustedIndex - this.lastIntersitialCardIndex > CARD_SPACING) {

                this.insertChannelCard(adjustedIndex);
                this.lastIntersitialCardIndex = adjustedIndex;
            }

            return retval;
        },

        insertChannelCard: function (index) {
            // Show the next CHANNELS_PER_CARD channels on this card, and remove them from the list so they
            // won't be shown on any other interstitial card.
            var channelProfiles = new Backbone.Collection(
                this.interstitialChannelProfiles.splice(0, CHANNELS_PER_CARD));

            // If there aren't enough channels to fill the card, don't show a card
            if (channelProfiles.length < CHANNELS_PER_CARD)
                return;

            // Make sure the latest discussions are fetched for the channels to be shown
            channelProfiles.invoke('ensureFetchedTopActivities');
            var cardView = new PromotedChannelsCardView({
                collection: channelProfiles,
            });

            // Store the child view itself so we can properly
            // remove and/or close it later
            this.children.add(cardView);

            // Render it and show it
            this.renderItemView(cardView, index);
        },
    };

    return function () {
        this.initialize = _.wrap(this.initialize, withInterstitialChannelCards.initialize);
        this.addItemView = _.wrap(this.addItemView, withInterstitialChannelCards.addItemView);

        _.extend(this, _.pick(withInterstitialChannelCards, [
            'insertChannelCard',
            'initializeChannelProfiles',
            'getAdjustedIndex',
        ]));
    };
});

define('home/views/ChannelCardCollectionViewWithChannelPromotion',[
    'home/views/ChannelCardCollectionView',

    'home/mixins/withInterstitialChannelCards',
], function (
    ChannelCardCollectionView,

    withInterstitialChannelCards
) {
    'use strict';

    /**
     * A feed of cards that inserts interstitial channel promotion cards.
     */
    var ChannelCardCollectionViewWithChannelPromotion = ChannelCardCollectionView.extend({});

    withInterstitialChannelCards.call(ChannelCardCollectionViewWithChannelPromotion.prototype);

    return ChannelCardCollectionViewWithChannelPromotion;
});

define('home/templates/spinner',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    return "<div class=\"spinner\"></div>\n";
},"useData":true})

});
define('home/templates/moreButton',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<button class=\"button button-fill button-small button-padding-taller button-wide\" data-action=\"more-feed\">\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"More",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":2,"column":0},"end":{"line":2,"column":18}}}))
    + "\n</button>\n";
},"useData":true})

});
define('home/templates/endOfItems',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"feed-end\" data-role=\"end-message\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"That's the end. ",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":2,"column":0},"end":{"line":2,"column":30}}}))
    + "\n<!--    TODO: @taylangocmen restore this with pages link after improvements (1) -->\n<!--    <a href=\"/home/explore/\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Find more interesting discussions »",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":4,"column":33},"end":{"line":4,"column":82}}}))
    + "</a>-->\n</div>\n";
},"useData":true})

});
define('home/templates/loadError',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"empty-message\">\n<img src=\""
    + alias2(lookupProperty(helpers,"urlfor").call(alias1,"cdn",{"name":"urlfor","hash":{},"data":data,"loc":{"start":{"line":2,"column":10},"end":{"line":2,"column":26}}}))
    + "/img/Pam_Error.png\" class=\"img-responsive\" />\n<h2>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Darn it!",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":3,"column":4},"end":{"line":3,"column":26}}}))
    + "</h2>\n<div class=\"text-small\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Something went wrong while trying to load this feed. Try again in a little while.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":5,"column":0},"end":{"line":5,"column":95}}}))
    + "\n</div>\n<div class=\"text-small\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Please visit %(discussDisqus)s to learn more.",{"name":"gettext","hash":{"discussDisqus":lookupProperty(helpers,"tag").call(alias1,"a",{"name":"tag","hash":{"text":"Discuss Disqus","href":"//disqus.com/home/discussion/channel-discussdisqus/issues_loading_your_feed_send_us_more_details/"},"data":data,"loc":{"start":{"line":9,"column":16},"end":{"line":10,"column":22}}})},"data":data,"loc":{"start":{"line":8,"column":0},"end":{"line":10,"column":24}}}))
    + "\n</div>\n</div>\n";
},"useData":true})

});
define('home/views/common/FetchableCollectionFooterView',[
    'underscore',
    'backbone-marionette',

    'home/templates/spinner',
    'home/templates/moreButton',
    'home/templates/endOfItems',
    'home/templates/loadError',
], function (
    _,
    Marionette,

    spinnerTemplate,
    moreButtonTemplate,
    endOfItemsTemplate,
    loadErrorTemplate
) {
    'use strict';

    /**
     * A footer for a paginated collection. Intended to be used in conjunction with a
     * FetchableCollectionView.
     *
     * Footer shows the more button and end of items message for non-empty collections.
     * It will also show the spinner when fetching items subsequent to the initial fetch.
     * (Initial fetch state is handled by the FetchableCollectionView).
     *
     * Can extend class and override endOfItemsTemplate to change the message shown when
     * the feed runs out. Doing this will still cause the spinner/more buttons to show at
     * the correct times
     */
    var FetchableCollectionFooterView = Marionette.ItemView.extend({
        endOfItemsTemplate: endOfItemsTemplate,
        errorTemplate: loadErrorTemplate,

        template: function (data) {
            // FetchableCollectionView should be showing all (if any) items
            // fetched before the error occurred. Show the error state.
            if (data.error)
                return this.errorTemplate(data);

            // FetchableCollectionView should be showing the fetching state
            // for initial fetch, or the empty view state once fetch is complete.
            // Show nothing.
            if (!this.collection.length)
                return '';

            if (data.fetching)
                return spinnerTemplate(data);

            if (data.hasNext)
                return moreButtonTemplate(data);

            return this.endOfItemsTemplate(data);
        },

        className: 'more-wrapper',

        events: {
            'click [data-action=more-feed]': 'moreClicked',
        },
        modelEvents: {
            'change:fetching': 'render',
        },

        initialize: function () {
            this.template = _.bind(this.template, this);
        },

        moreClicked: function (evt) {
            evt.preventDefault();
            this.model.fetchItems();
        },
    });

    return FetchableCollectionFooterView;
});

define('home/templates/channelFeedEndOfItems',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"feed-end\" data-role=\"end-message\">\n<a href=\"#content-area\">"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Back to Top",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":2,"column":24},"end":{"line":2,"column":49}}}))
    + "</a>\n</div>\n";
},"useData":true})

});
define('home/views/ChannelFeedFooterView',[
    'home/views/common/FetchableCollectionFooterView',

    'home/templates/channelFeedEndOfItems',
], function (
    FetchableCollectionFooterView,

    channelFeedEndOfItemsTemplate
) {
    'use strict';

    var ChannelFeedFooterView = FetchableCollectionFooterView.extend({
        endOfItemsTemplate: channelFeedEndOfItemsTemplate,
    });

    return ChannelFeedFooterView;
});

define('home/templates/unreadCount',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Show One New Item",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":3,"column":0},"end":{"line":3,"column":31}}}))
    + "\n";
},"3":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Show %(x)s New Items",{"name":"gettext","hash":{"x":(depth0 != null ? lookupProperty(depth0,"numUnread") : depth0)},"data":data,"loc":{"start":{"line":5,"column":0},"end":{"line":5,"column":48}}}))
    + "\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<button class=\"button button-padding-taller button-wide button-fill--brand text-medium\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,lookupProperty(helpers,"eq").call(alias1,(depth0 != null ? lookupProperty(depth0,"numUnread") : depth0),1,{"name":"eq","hash":{},"data":data,"loc":{"start":{"line":2,"column":6},"end":{"line":2,"column":22}}}),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"data":data,"loc":{"start":{"line":2,"column":0},"end":{"line":6,"column":7}}})) != null ? stack1 : "")
    + "</button>\n";
},"useData":true})

});
define('home/views/UnreadCountView',[
    'backbone-marionette',
    'home/templates/unreadCount',
], function (
    Marionette,
    unreadCountTemplate
) {
    'use strict';

    var parent = Marionette.ItemView;
    var parentProto = parent.prototype;


    return parent.extend({
        className: 'feed-new',

        events: {
            'click': 'handleAddUnread',
        },

        handleAddUnread: function () {
            this.collection.addUnread();
            this.close();
        },

        template: unreadCountTemplate,

        // Overwrite rather than inherit serializeData because it's
        // unneeded extra work to serialize this.collection
        serializeData: function () {
            return {
                numUnread: this.collection.unreadQueue.length,
            };
        },

        render: function () {
            // Don't display "Show 0 New Items"
            if (this.serializeData().numUnread <= 0)
                return this;

            return parentProto.render.call(this);
        },
    });
});

define('home/templates/fetchableCollectionLayout',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    return "<div data-role=\"header-area\"></div>\n<div data-role=\"content-area\"></div>\n<div data-role=\"footer-area\"></div>\n";
},"useData":true})

});
define('home/views/common/FetchableCollectionLayout',[
    'underscore',
    'backbone-marionette',

    'home/views/common/FetchableCollectionView',
    'home/views/common/FetchableCollectionFooterView',
    'home/views/FetchingView',
    'home/views/UnreadCountView',

    'home/templates/fetchableCollectionLayout',
], function (
    _,
    Marionette,

    FetchableCollectionView,
    FetchableCollectionFooterView,
    FetchingView,
    UnreadCountView,

    fetchableCollectionLayoutTemplate
) {
    'use strict';

    /**
     * Can be used as is, by passing the fetchableCollectionView to the
     * constructor, or can be extended by a view that defines the
     * fetchableCollectionView. Either way may override the template,
     * so long as the expected content region and footer regions exist.
     *
     * Renders a given FetchableCollectionView along with a footer view.
     * Between the two of them they handle all the states for a collection
     * that is fetched initially and supports pagingation.
     *
     * The FetchableCollectionView handles initial collection fetching,
     * and empty collections.
     * The footer handles pagination, the fetch state during subsequent
     * fetches, errors, and when there are no more pages available.
     */
    var FetchableCollectionLayout = Marionette.Layout.extend({
        itemViewEventPrefix: 'collectionview',

        template: fetchableCollectionLayoutTemplate,
        regions: {
            headerRegion: '[data-role=header-area]',
            contentRegion: '[data-role=content-area]',
            footerRegion: '[data-role=footer-area]',
        },

        fetchableCollectionFooterView: FetchableCollectionFooterView,

        initialize: function (options) {
            if (options.fetchableCollectionView)
                this.fetchableCollectionView = options.fetchableCollectionView;

            if (!this.fetchableCollectionView ||
                !(this.fetchableCollectionView === FetchableCollectionView ||
                  this.fetchableCollectionView.prototype instanceof FetchableCollectionView))
                throw new Error('A FetchableCollectionLayout must define a fetchableCollectionView');

            if (options.fetchableCollectionFooterView)
                this.fetchableCollectionFooterView = options.fetchableCollectionFooterView;

            if (!this.contentRegion || !this.footerRegion)
                throw new Error('A template for a FetchableCollectionLayout must define a content region and a footer region');

            this.listenTo(this.collection, 'unreadItemsReady', this.updateHeader);

            this.options = options;
        },

        updateHeader: function () {
            var unreadCountView = new UnreadCountView({
                collection: this.collection,
            });

            this.headerRegion.show(unreadCountView);
        },

        onDomRefresh: function () {
            /* eslint-disable new-cap */
            if (this.contentRegion.currentView)
                this.stopListening(this.contentRegion.currentView);

            var view = new this.fetchableCollectionView(_.clone(this.options));
            var collection = view.collection;

            // Kick off a sequence of events for timeline collections that
            // results in the collection fetching unread items, if any exist. When
            // it is done fetching new items, it will fire 'unreadItemsReady'.
            if (collection.updateUnreadCount)
                collection.updateUnreadCount();

            if (view.listenable.ensureFetched)
                view.listenable.ensureFetched();

            Marionette.CollectionView.prototype.addChildViewEventForwarding.call(this, view);

            this.contentRegion.show(new FetchingView());
            _.defer(_.bind(function () {
                // This view may have been closed since defer was scheduled (ex: by
                // the parent view rerendering). If that is the case, unable to
                // update content.
                if (this.isClosed)
                    return;

                this.contentRegion.show(view);
                this.trigger('showCollection', view);

                this.footerRegion.show(new this.fetchableCollectionFooterView({
                    model: this.model,
                    collection: this.collection,
                }));
            }, this));
            /* eslint-enable new-cap */
        },

        // Called by addChildViewEventForwarding
        getItemEvents: Marionette.CollectionView.prototype.getItemEvents,
    });

    return FetchableCollectionLayout;
});

define('home/mixins/asCollapsibleCard',[
    'underscore',
], function (
    _
) {
    'use strict';

    var asCollapsibleCard = function () {
        this.events = _.extend({
            'click [data-action=toggle-collapsed]': 'toggleCollapsed',
        }, this.events);

        this.toggleCollapsed = function (evt) {
            if (evt)
                evt.preventDefault();

            // Use addBack to ensure this view's el is included in the selector
            this.$('.card-collapsed, .card-expanded')
                .addBack('.card-collapsed, .card-expanded')
                .toggleClass('card-collapsed card-expanded');
        };
    };

    return asCollapsibleCard;
});

// DEPRECATED
define('home/mixins/withReasonOld',[
    'underscore',
    'home/views/ActivityActorsHoverCard',
    'core/utils',
], function (
    _,
    ActivityActorsHoverCard,
    utils
) {
    'use strict';

    var initHoverCard = function () {
        // We don't use voter cards on mobile-like user agents.
        if (utils.isMobileUserAgent())
            return;

        var target = this.$('[data-role=actors]');
        if (!target.length)
            return;

        if (this.hoverCard)
            this.hoverCard.remove();

        this.hoverCard = ActivityActorsHoverCard.create({
            targetElement: target,
            activityFeedItem: this.model,
            activityId: this.model.id,

            numShownActors: getShownActors.call(this).length,
        });
    };

    /*
     * Returns an array of just the actors to show in the reason. If the
     * number of actors is 3 or less, shows all of them. Otherwise it
     * shows 2 of them, plus a count of the remaining actors.
     */
    var getShownActors = function () {
        if (!this.model.actors)
            return [];

        if (this.model.get('totalActors') < 4)
            return this.model.toJSON().actors;

        return this.model.toJSON().actors.slice(0, 2);
    };

    /*
     * Returns the number of times this action occurred.
     * For right now, we only show a count if there was only 1 actor
     * and more than 1 occurrence.
     * ex: Nicole commented 2 times
     */
    var getNumOccurrences = function () {
        if (!this.model.actors || this.model.actors.length !== 1)
            return 0;

        var numOccurrences = this.model.get('totalActivities');
        return numOccurrences > 1 ? numOccurrences : 0;
    };

    var withReason = function () {
        this.initialize = _.wrap(this.initialize, function (_initialize) {
            _initialize.apply(this, _.rest(arguments));

            this.listenTo(this, 'render', initHoverCard);
        });

        var _templateHelpers = this.templateHelpers;
        this.templateHelpers = function () {
            var shownActors = getShownActors.call(this);
            return _.extend({
                relativeTime: this.model.getRelativeTimestamp(),
                shownActors: shownActors,
                numRemainingActors: this.model.get('totalActors') - shownActors.length,
                numOccurrences: getNumOccurrences.call(this),
            },
            _templateHelpers ? _templateHelpers.apply(this, arguments) : {});
        };
    };

    return withReason;
});

// DEPRECATED
// Activity cards are being rewritten to be page-specific cards for v2.5 card redesign
define('home/views/common/ActivityFooterView',[
    'backbone-marionette',
    'home/models/Session',
], function (
    Marionette,
    Session
) {
    'use strict';

    /**
     * Parent class, not intended to be instatiated.
     */
    var ActivityFooterView = Marionette.ItemView.extend({
        templateHelpers: function () {
            var session = Session.get();

            return {
                favorited: this.model.thread.get('userScore') > 0,
                discussionRoute: this.model.thread.getDiscussionRoute(),
                authenticated: !session.isAnonymous(),
            };
        },

        events: {
            'click [data-action=favorite]': 'toggleThreadFavorited',
        },

        initialize: function () {
            this.listenTo(this.model.thread, 'change:userScore', this.render);
        },

        toggleThreadFavorited: function (evt) {
            if (evt)
                evt.preventDefault();

            this.model.thread.toggleFavorited();
        },
    });

    return ActivityFooterView;
});

define('home/templates/activityFooterFavorite',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<ul class=\"actions\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"activityFooterDefaultActions"),depth0,{"name":"activityFooterDefaultActions","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</ul>\n";
},"usePartial":true,"useData":true})

});
define('home/views/ActivityFooterFavoriteView',[
    'home/views/common/ActivityFooterView',

    'home/templates/activityFooterFavorite',
], function (
    ActivityFooterView,

    activityFooterFavoriteTemplate
) {
    'use strict';

    var ActivityFooterFavoriteView = ActivityFooterView.extend({
        template: activityFooterFavoriteTemplate,
    });

    return ActivityFooterFavoriteView;
});

define('home/templates/activityCardFavorite',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(alias1,"%(group)s recommended %(numOccurance)s times",{"name":"gettext","hash":{"numOccurance":(depth0 != null ? lookupProperty(depth0,"numOccurance") : depth0),"group":lookupProperty(helpers,"getPartial").call(alias1,"userGroup",{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":3,"column":65},"end":{"line":3,"column":89}}})},"data":data,"loc":{"start":{"line":3,"column":0},"end":{"line":3,"column":119}}}))
    + "\n";
},"3":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(alias1,"%(group)s recommended",{"name":"gettext","hash":{"group":lookupProperty(helpers,"getPartial").call(alias1,"userGroup",{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":5,"column":42},"end":{"line":5,"column":66}}})},"data":data,"loc":{"start":{"line":5,"column":0},"end":{"line":5,"column":68}}}))
    + "\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card-reason\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"numOccurances") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"data":data,"loc":{"start":{"line":2,"column":0},"end":{"line":6,"column":7}}})) != null ? stack1 : "")
    + "<span class=\"time\">"
    + container.escapeExpression(alias1((depth0 != null ? lookupProperty(depth0,"relativeTime") : depth0), depth0))
    + "</span>\n</div>\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"cardTitle"),depth0,{"name":"cardTitle","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "<div class=\"card-summary\">\n<div class=\"card-summary-content\" dir=\"auto\">\n"
    + ((stack1 = alias1((depth0 != null ? lookupProperty(depth0,"threadDescriptionHTML") : depth0), depth0)) != null ? stack1 : "")
    + "\n</div>\n</div>\n<footer class=\"card-footer\" data-role=\"footer\"></div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/ActivityCardFavoriteView',[
    'backbone-marionette',
    'home/mixins/withReasonOld',
    'home/mixins/withSubviews',

    'home/views/ActivityFooterFavoriteView',

    'home/templates/activityCardFavorite',
], function (
    Marionette,
    withReason,
    withSubviews,

    ActivityFooterFavoriteView,

    activityCardFavoriteTemplate
) {

    'use strict';

    var parent = Marionette.ItemView;


    var ActivityCardFavoriteView = parent.extend({
        template: activityCardFavoriteTemplate,
        templateHelpers: function () {
            return {
                discussionRoute: this.model.thread.getDiscussionRoute(),
                threadDescriptionHTML: this.model.thread.getDefaultDescription(),
            };
        },

        initialize: function () {
            this.listenTo(this.model.thread, 'change:content', this.render);
        },

        regions: {
            footerRegion: '[data-role=footer]',
        },

        onRender: function () {
            this.activateRegion(this.footerRegion, this.createFooterView);
        },

        createFooterView: function () {
            return new ActivityFooterFavoriteView({
                el: this.footerRegion.el,
                model: this.model,
            });
        },
    });


    var proto = ActivityCardFavoriteView.prototype;
    withReason.call(proto);
    withSubviews.call(proto);

    return ActivityCardFavoriteView;
});

define('home/templates/truncatedPost',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<span class=\"label label-danger\">"
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"hiddenExplanation") : depth0), depth0))
    + "</span>\n";
},"3":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"plaintext") : depth0), depth0))
    + "\n";
},"5":function(container,depth0,helpers,partials,data) {
    return "<span class=\"icon-images\"></span>\n";
},"7":function(container,depth0,helpers,partials,data) {
    return "hidden";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, alias3=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = container.invokePartial(lookupProperty(partials,"userAvatar"),(depth0 != null ? lookupProperty(depth0,"author") : depth0),{"name":"userAvatar","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "<div class=\"comment-body\">\n<header class=\"comment-header\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"userName"),(depth0 != null ? lookupProperty(depth0,"author") : depth0),{"name":"userName","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "<a class=\"link-gray time\"\nhref=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"discussionRoute") : depth0), depth0))
    + "#comment-"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"id") : depth0), depth0))
    + "\"\ndata-link-name=\"timestamp\"\ndata-thread-id=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + "\">\n\n"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"relativeTime") : depth0), depth0))
    + "\n</a>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias3,(depth0 != null ? lookupProperty(depth0,"isHidden") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":12,"column":0},"end":{"line":14,"column":7}}})) != null ? stack1 : "")
    + "</header>\n<a href=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"discussionRoute") : depth0), depth0))
    + "#comment-"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"id") : depth0), depth0))
    + "\"\nclass=\"card-comment-truncated truncate-line\"\ndata-link-name=\"message\"\ndir=\"auto\"\ndata-thread-id=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + "\">\n\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias3,(depth0 != null ? lookupProperty(depth0,"plaintext") : depth0),{"name":"if","hash":{},"fn":container.program(3, data, 0),"inverse":container.program(5, data, 0),"data":data,"loc":{"start":{"line":22,"column":0},"end":{"line":26,"column":7}}})) != null ? stack1 : "")
    + "</a>\n\n<footer class=\"comment-actions "
    + ((stack1 = lookupProperty(helpers,"if").call(alias3,(depth0 != null ? lookupProperty(depth0,"isHidden") : depth0),{"name":"if","hash":{},"fn":container.program(7, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":29,"column":31},"end":{"line":29,"column":60}}})) != null ? stack1 : "")
    + "\" data-role=\"post-actions\">\n</footer>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/TruncatedPostView',[
    'home/views/PostView',
    'home/templates/truncatedPost',
], function (
    PostView,
    truncatedPostTemplate
) {
    'use strict';

    var TruncatedPostView = PostView.extend({
        template: truncatedPostTemplate,
    });

    return TruncatedPostView;
});

define('home/templates/replyActivity',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    return "<div data-role=\"parent-post\" class=\"parent\"></div>\n<div data-role=\"child-post\" class=\"child\"></div>\n";
},"useData":true})

});
define('home/views/ReplyActivityView',[
    'backbone-marionette',

    'home/mixins/withSubviews',
    'home/views/PostView',
    'home/views/TruncatedPostView',
    'home/templates/replyActivity',
], function (
    Marionette,

    withSubviews,
    PostView,
    TruncatedPostView,
    replyActivityTemplate
) {
    'use strict';

    var parent = Marionette.ItemView;


    /**
     * A view that shows a reply activity. Shown as the parent post followed by
     * the reply post.
     */
    var ReplyActivityView = parent.extend({
        className: 'card-reply',
        template: replyActivityTemplate,

        regions: {
            inReplyToRegion: '[data-role=parent-post]',
            replyRegion: '[data-role=child-post]',
        },

        initialize: function (options) {
            this.shouldCollapse = options && options.shouldCollapse;
        },

        onRender: function () {
            this.activateRegion(this.inReplyToRegion, this.createParentPostView);
            this.activateRegion(this.replyRegion, this.createChildPostView);
        },

        createParentPostView: function () {
            return new TruncatedPostView({
                model: this.model.target,
            });
        },

        createChildPostView: function () {
            return new PostView({
                model: this.model.object,
                shouldCollapse: this.shouldCollapse,
            });
        },
    });


    withSubviews.call(ReplyActivityView.prototype);

    return ReplyActivityView;
});

define('home/views/PostActivityCollectionView',[
    'underscore',
    'backbone-marionette',

    'home/views/PostView',
    'home/views/ReplyActivityView',
], function (
    _,
    Marionette,

    PostView,
    ReplyActivityView
) {
    'use strict';

    /**
     * A view that shows a collection of activities that are all post or reply activities.
     * Shows the appropriate view per activity depending on the type of activity.
     */
    var PostActivityCollectionView = Marionette.CollectionView.extend({
        initialize: function (options) {
            // Posts should be collapsed by default, collapsePosts should only
            // be false if an option was given explicitly setting it to false
            this.collapsePosts = !options || options.collapsePosts !== false;
        },

        getItemView: function (activity) {
            return activity.get('verb') === 'reply' ? ReplyActivityView : PostView;
        },

        itemViewOptions: function (activity, index) {
            var model = activity;
            if (activity.get('verb') === 'post') {
                // The PostView expects a Post as its model. Pull the Post
                // out of the given activity.
                model = activity.object;
            }

            var existingClassName = this.getItemView(activity).prototype.className;
            existingClassName = _.isFunction(existingClassName) ?
                existingClassName.call({ model: activity }) :
                existingClassName || '';

            var className = existingClassName;
            if (index > 0)
                className += ' collapsible';

            return {
                model: model,
                className: className,
                shouldCollapse: this.collapsePosts,
            };
        },
    });

    return PostActivityCollectionView;
});

define('home/views/common/ActivityCardPostBaseView',[
    'backbone',
    'backbone-marionette',

    'home/mixins/withSubviews',

    'home/views/PostActivityCollectionView',
], function (
    Backbone,
    Marionette,

    withSubviews,

    PostActivityCollectionView
) {

    'use strict';

    /**
     * The base view for a card representing a group of activities that are either
     * posts or replies.
     */
    var ActivityCardPostBaseView = Marionette.ItemView.extend({
        regions: {
            postsRegion: '[data-role=posts]',
            footerRegion: '[data-role=footer]',
        },

        /**
         * Builds and returns a view that shows the group of post and reply activities.
         */
        buildPostsView: function () {
            return new PostActivityCollectionView({
                el: this.postsRegion.el,
                collection: new Backbone.Collection(this.model.activities),
            });
        },

        // Subclasses must override this method
        createFooterView: undefined,

        onRender: function () {
            this.activateRegion(this.postsRegion, this.buildPostsView);
            this.activateRegion(this.footerRegion, this.createFooterView);
        },
    });


    withSubviews.call(ActivityCardPostBaseView.prototype);

    return ActivityCardPostBaseView;
});

define('home/templates/activityFooterPost',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<ul class=\"actions\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"activityFooterDefaultActions"),depth0,{"name":"activityFooterDefaultActions","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</ul>\n";
},"usePartial":true,"useData":true})

});
define('home/views/ActivityFooterPostView',[
    'underscore',

    'home/views/common/ActivityFooterView',

    'home/templates/activityFooterPost',
], function (
    _,

    ActivityFooterView,

    activityFooterPostTemplate
) {
    'use strict';

    var ActivityFooterPostView = ActivityFooterView.extend({
        template: activityFooterPostTemplate,
        templateHelpers: function () {
            return _.defaults({
                hasMultiplePosts: this.model.activities.length > 1,
            },
            ActivityFooterView.prototype.templateHelpers.apply(this, arguments));
        },
    });

    return ActivityFooterPostView;
});

define('home/templates/activityCardPost',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(alias1,"%(group)s commented %(numOccurance)s times",{"name":"gettext","hash":{"numOccurance":(depth0 != null ? lookupProperty(depth0,"numOccurance") : depth0),"group":lookupProperty(helpers,"getPartial").call(alias1,"userGroup",{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":3,"column":63},"end":{"line":3,"column":87}}})},"data":data,"loc":{"start":{"line":3,"column":0},"end":{"line":3,"column":117}}}))
    + "\n";
},"3":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(alias1,"%(group)s commented",{"name":"gettext","hash":{"group":lookupProperty(helpers,"getPartial").call(alias1,"userGroup",{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":5,"column":40},"end":{"line":5,"column":64}}})},"data":data,"loc":{"start":{"line":5,"column":0},"end":{"line":5,"column":66}}}))
    + "\n";
},"5":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"expandable\">\n<div class=\"card-grouped-actions\">\n<a href=\"#\" data-action=\"toggle-collapsed\" class=\"expandable card-expand\">\n<div class=\"icon-more-vert\"></div>\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"See More",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":15,"column":0},"end":{"line":15,"column":22}}}))
    + "\n</a>\n</div>\n</div>\n";
},"7":function(container,depth0,helpers,partials,data) {
    var alias1=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"collapsible\">\n<div class=\"card-grouped-actions\">\n<a class=\"collapsible button button-outline button-small\" href=\""
    + alias1(container.lambda((depth0 != null ? lookupProperty(depth0,"discussionRoute") : depth0), depth0))
    + "\" data-link-name=\"view_comment\">\n"
    + alias1(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"See All Comments",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":24,"column":0},"end":{"line":24,"column":30}}}))
    + "\n</a>\n</div>\n</div>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card-reason\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"numOccurances") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"data":data,"loc":{"start":{"line":2,"column":0},"end":{"line":6,"column":7}}})) != null ? stack1 : "")
    + "<span class=\"time\">"
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"relativeTime") : depth0), depth0))
    + "</span>\n</div>\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"cardTitle"),depth0,{"name":"cardTitle","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "<div data-role=\"posts\"></div>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"shouldCollapse") : depth0),{"name":"if","hash":{},"fn":container.program(5, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":10,"column":0},"end":{"line":19,"column":7}}})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"hasOverflowPosts") : depth0),{"name":"if","hash":{},"fn":container.program(7, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":20,"column":0},"end":{"line":28,"column":7}}})) != null ? stack1 : "")
    + "<footer class=\"card-footer\" data-role=\"footer\"></div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/ActivityCardPostView',[
    'home/mixins/withReasonOld',

    'home/views/common/ActivityCardPostBaseView',
    'home/views/ActivityFooterPostView',

    'home/templates/activityCardPost',
], function (
    withReason,

    ActivityCardPostBaseView,
    ActivityFooterPostView,

    activityCardPostTemplate
) {
    'use strict';

    var parent = ActivityCardPostBaseView;

    var ActivityCardPostView = parent.extend({
        template: activityCardPostTemplate,
        templateHelpers: function () {
            return {
                hasOverflowPosts: this.model.get('totalActivities') > this.model.activities.length,
                shouldCollapse: this.shouldCollapse(),
                discussionRoute: this.model.thread.getDiscussionRoute(),
            };
        },

        createFooterView: function () {
            return new ActivityFooterPostView({
                el: this.footerRegion.el,
                model: this.model,
            });
        },

        shouldCollapse: function () {
            return this.model.activities.length > 1;
        },
    });


    var proto = ActivityCardPostView.prototype;
    withReason.call(proto);

    return ActivityCardPostView;
});

define('home/templates/activityFooterReply',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<ul class=\"actions\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"activityFooterDefaultActions"),depth0,{"name":"activityFooterDefaultActions","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</ul>\n";
},"usePartial":true,"useData":true})

});
define('home/views/ActivityFooterReplyView',[
    'home/views/common/ActivityFooterView',

    'home/templates/activityFooterReply',
], function (
    ActivityFooterView,

    activityFooterReplyTemplate
) {
    'use strict';

    var ActivityFooterReplyView = ActivityFooterView.extend({
        template: activityFooterReplyTemplate,
    });

    return ActivityFooterReplyView;
});

define('home/templates/activityCardReply',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card-reason\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"userGroup"),depth0,{"name":"userGroup","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "<span class=\"icon-forward\"></span>"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"userPreview"),((stack1 = (depth0 != null ? lookupProperty(depth0,"target") : depth0)) != null ? lookupProperty(stack1,"author") : stack1),{"name":"userPreview","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + " <span class=\"time\">"
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"relativeTime") : depth0), depth0))
    + "</span>\n</div>\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"cardTitle"),depth0,{"name":"cardTitle","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "<div class=\"card-reply\" data-role=\"posts\"></div>\n<footer class=\"card-footer\" data-role=\"footer\"></div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/ActivityCardReplyView',[
    'home/mixins/withReasonOld',

    'home/views/common/ActivityCardPostBaseView',
    'home/views/ActivityFooterReplyView',

    'home/templates/activityCardReply',
], function (
    withReason,

    ActivityCardPostBaseView,
    ActivityFooterReplyView,

    activityCardReplyTemplate
) {
    'use strict';

    var parent = ActivityCardPostBaseView;

    /**
     * Reply feed items can only have 1 reply activity. Groups of multiple replies
     * are treated as comments.
     */
    var ActivityCardReplyView = parent.extend({
        template: activityCardReplyTemplate,

        templateHelpers: function () {
            return {
                // Use the target for the 1 activity this item represents
                target: this.model.activities[0].target.toJSON(),
            };
        },

        createFooterView: function () {
            return new ActivityFooterReplyView({
                el: this.footerRegion.el,
                model: this.model,
            });
        },
    });


    var proto = ActivityCardReplyView.prototype;
    withReason.call(proto);

    return ActivityCardReplyView;
});

define('home/templates/activityFooterTrending',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<ul class=\"actions\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"activityFooterDefaultActions"),depth0,{"name":"activityFooterDefaultActions","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</ul>\n";
},"usePartial":true,"useData":true})

});
define('home/views/ActivityFooterTrendingView',[
    'home/views/common/ActivityFooterView',

    'home/templates/activityFooterTrending',
], function (
    ActivityFooterView,

    activityFooterTrendingTemplate
) {
    'use strict';

    var ActivityFooterTrendingView = ActivityFooterView.extend({
        template: activityFooterTrendingTemplate,
    });

    return ActivityFooterTrendingView;
});

define('home/templates/activityCardTrending',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\"/home/forum/"
    + container.escapeExpression(container.lambda(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + "/\" class=\"community link-gray-darker\" data-link-name=\"forum_name\">"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"forumName"),((stack1 = (depth0 != null ? lookupProperty(depth0,"target") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1),{"name":"forumName","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</a>\n";
},"3":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = container.invokePartial(lookupProperty(partials,"forumAvatarLink"),((stack1 = (depth0 != null ? lookupProperty(depth0,"target") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1),{"name":"forumAvatarLink","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + " <a href=\"/home/forum/"
    + container.escapeExpression(container.lambda(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + "/\" class=\"community link-gray-darker\" data-link-name=\"forum_name\">"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"forumName"),((stack1 = (depth0 != null ? lookupProperty(depth0,"target") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1),{"name":"forumName","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</a>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, alias3=container.lambda, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card-reason\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"hideForumFavicon") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"data":data,"loc":{"start":{"line":2,"column":0},"end":{"line":6,"column":7}}})) != null ? stack1 : "")
    + "<span class=\"time\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Recent activity",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":7,"column":19},"end":{"line":7,"column":48}}}))
    + " "
    + alias2(alias3((depth0 != null ? lookupProperty(depth0,"relativeTime") : depth0), depth0))
    + "</span>\n</div>\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"cardTitle"),depth0,{"name":"cardTitle","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "<div class=\"card-summary\">\n<div class=\"card-summary-content\" dir=\"auto\">\n"
    + ((stack1 = alias3((depth0 != null ? lookupProperty(depth0,"threadDescriptionHTML") : depth0), depth0)) != null ? stack1 : "")
    + "\n</div>\n</div>\n<footer class=\"card-footer\" data-role=\"footer\"></div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/ActivityCardTrendingView',[
    'underscore',
    'backbone-marionette',
    'home/mixins/withReasonOld',
    'home/mixins/withSubviews',

    'home/views/ActivityFooterTrendingView',

    'home/templates/activityCardTrending',
], function (
    _,
    Marionette,
    withReason,
    withSubviews,

    ActivityFooterTrendingView,

    activityCardTrendingTemplate
) {
    'use strict';

    var parent = Marionette.ItemView;


    var ActivityCardTrendingView = parent.extend({
        template: activityCardTrendingTemplate,
        templateHelpers: function () {
            var forumFavicon = this.model.thread.forum.get('favicon') &&
                this.model.thread.forum.get('favicon').cache;

            var helpers = {};

            return _.extend(helpers, {
                commenter: this.model.thread.getMostRecentCommenter(),
                target: this.model.activities[0].target.toJSON(),
                discussionRoute: this.model.thread.getDiscussionRoute(),
                threadDescriptionHTML: this.model.thread.getDefaultDescription(),

                // Hide default favicons
                hideForumFavicon: !forumFavicon || /favicon-default/.test(forumFavicon),
            });
        },

        initialize: function () {
            this.listenTo(this.model.thread, 'change:content', this.render);
        },

        regions: {
            footerRegion: '[data-role=footer]',
        },

        onRender: function () {
            this.activateRegion(this.footerRegion, this.createFooterView);
        },

        createFooterView: function () {
            return new ActivityFooterTrendingView({
                el: this.footerRegion.el,
                model: this.model,
            });
        },
    });


    var proto = ActivityCardTrendingView.prototype;
    withReason.call(proto);
    withSubviews.call(proto);

    return ActivityCardTrendingView;
});

define('home/templates/activityFooterCreate',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<ul class=\"actions\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"activityFooterDefaultActions"),depth0,{"name":"activityFooterDefaultActions","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</ul>\n";
},"usePartial":true,"useData":true})

});
define('home/views/ActivityFooterCreateView',[
    'home/views/common/ActivityFooterView',

    'home/templates/activityFooterCreate',
], function (
    ActivityFooterView,

    activityFooterCreateTemplate
) {
    'use strict';

    var ActivityFooterCreateView = ActivityFooterView.extend({
        template: activityFooterCreateTemplate,
    });

    return ActivityFooterCreateView;
});

define('home/templates/activityCardCreate',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card-discussion-comments-title\">"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(alias1,"Recent Comments",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":8,"column":44},"end":{"line":8,"column":73}}}))
    + "</div>\n<div class=\"card-discussion-comments\" data-role=\"posts\"></div>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"shouldCollapse") : depth0),{"name":"if","hash":{},"fn":container.program(2, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":10,"column":0},"end":{"line":19,"column":7}}})) != null ? stack1 : "");
},"2":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"expandable\">\n<div class=\"card-grouped-actions\">\n<a href=\"#\" data-action=\"toggle-collapsed\" class=\"expandable card-expand\">\n<div class=\"icon-more-vert\"></div>\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"See More",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":15,"column":0},"end":{"line":15,"column":22}}}))
    + "\n</a>\n</div>\n</div>\n";
},"4":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card-summary\">\n<div class=\"card-summary-content\" dir=\"auto\">\n"
    + ((stack1 = container.lambda((depth0 != null ? lookupProperty(depth0,"threadDescriptionHTML") : depth0), depth0)) != null ? stack1 : "")
    + "\n</div>\n</div>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card-reason\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"%(group)s authored",{"name":"gettext","hash":{"group":lookupProperty(helpers,"getPartial").call(alias1,"userGroup",{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":2,"column":39},"end":{"line":2,"column":63}}})},"data":data,"loc":{"start":{"line":2,"column":0},"end":{"line":2,"column":65}}}))
    + "\n<span class=\"time\">"
    + alias2(container.lambda((depth0 != null ? lookupProperty(depth0,"relativeTime") : depth0), depth0))
    + "</span>\n</div>\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"cardTitle"),depth0,{"name":"cardTitle","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"recentPostCount") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(4, data, 0),"data":data,"loc":{"start":{"line":7,"column":0},"end":{"line":26,"column":7}}})) != null ? stack1 : "")
    + "\n<footer class=\"card-footer\" data-role=\"footer\"></div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/ActivityCardCreateView',[
    'underscore',
    'backbone-marionette',
    'home/mixins/withReasonOld',
    'home/mixins/withSubviews',

    'home/views/ActivityFooterCreateView',
    'home/views/PostCollectionView',

    'home/templates/activityCardCreate',
], function (
    _,
    Marionette,
    withReason,
    withSubviews,

    ActivityFooterCreateView,
    PostCollectionView,

    activityCardCreateTemplate
) {
    'use strict';

    var parent = Marionette.ItemView;


    var ActivityCardCreateView = parent.extend({
        template: activityCardCreateTemplate,
        templateHelpers: function () {
            var forumFavicon = this.model.thread.forum.get('favicon') &&
                this.model.thread.forum.get('favicon').cache;

            return {
                target: this.model.activities[0].target.toJSON(),
                discussionRoute: this.model.thread.getDiscussionRoute(),
                threadDescriptionHTML: this.model.thread.getDefaultDescription(),
                recentPostCount: this.model.thread.recentPosts.length,
                shouldCollapse: this.shouldCollapse(),

                // Hide default favicons
                hideForumFavicon: !forumFavicon || /favicon-default/.test(forumFavicon),
            };
        },

        initialize: function () {
            this.listenTo(this.model.thread, 'change:content', this.render);
        },

        regions: {
            postsRegion: '[data-role=posts]',
            footerRegion: '[data-role=footer]',
        },

        onRender: function () {
            this.activateRegion(this.postsRegion, this.createPostsView);
            this.activateRegion(this.footerRegion, this.createFooterView);
        },

        createPostsView: function () {
            return new PostCollectionView({
                el: this.postsRegion.el,

                collection: this.model.thread.recentPosts,

                itemViewOptions: function (activity, index) {
                    // Add 'collapsible' class to posts after the first one. Only the first
                    // post shows by default and the rest are collapsed.
                    var existingClassName = this.getItemView(activity).prototype.className;
                    existingClassName = _.isFunction(existingClassName) ?
                        existingClassName.call({ model: activity }) :
                        existingClassName || '';

                    var className = existingClassName;
                    if (index > 0)
                        className += ' collapsible';

                    return {
                        className: className,
                    };
                },
            });
        },

        createFooterView: function () {
            var footerView = new ActivityFooterCreateView({
                el: this.footerRegion.el,
                model: this.model,
            });

            // Propogate event up
            this.listenTo(footerView, 'toggle:collapsed', function () {
                this.trigger('toggle:collapsed');
            });

            return footerView;
        },

        // Card should collapse (and therefore contain an expand link) if there's
        // more than 1 post showing. Posts after the first post are collapsed
        // by default.
        shouldCollapse: function () {
            return this.model.thread.recentPosts.length > 1;
        },
    });


    var proto = ActivityCardCreateView.prototype;
    withReason.call(proto);
    withSubviews.call(proto);

    return ActivityCardCreateView;
});

define('home/templates/activityCard',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = container.invokePartial(lookupProperty(partials,"threadImage"),depth0,{"name":"threadImage","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "");
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card-discussion\">\n<div class=\"card-aside\" data-role=\"thread-image\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"canShowThreadImage") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":3,"column":0},"end":{"line":5,"column":7}}})) != null ? stack1 : "")
    + "</div>\n<div class=\"card-body\">\n<div data-role=\"card-content\"></div>\n</div>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/ActivityCardWrapperView',[
    'handlebars',
    'home/utils/layoutUtils',

    'home/views/common/ActivityCardView',
    'home/mixins/asCollapsibleCard',
    'home/mixins/withSubviews',

    'home/views/ActivityCardFavoriteView',
    'home/views/ActivityCardPostView',
    'home/views/ActivityCardReplyView',
    'home/views/ActivityCardTrendingView',
    'home/views/ActivityCardCreateView',

    'home/templates/activityCard',
], function (
    Handlebars,
    layoutUtils,

    ActivityCardView,
    asCollapsibleCard,
    withSubviews,

    ActivityCardFavoriteView,
    ActivityCardPostView,
    ActivityCardReplyView,
    ActivityCardTrendingView,
    ActivityCardCreateView,

    ActivityCardTemplate
) {
    'use strict';

    var parent = ActivityCardView;

    /**
     * The view for an activity card.
     * Handles rendering the card html structure, and updating the thread image when
     * necessary.
     * Delegates rendering the card content to the card views specific to the types
     * of activities: favorite, trending, post, reply
     */
    var ActivityCardWrapperView = parent.extend({
        className: function () {
            return 'card card-' + this.model.get('verb');
        },

        template: ActivityCardTemplate,

        templateHelpers: function () {
            return {
                canShowThreadImage: !layoutUtils.isNarrowLayout(),
                discussionRoute: this.model.thread.getDiscussionRoute(),
                image: this.model.thread.getImage(),
            };
        },

        initialize: function () {
            if (!layoutUtils.isNarrowLayout())
                this.listenTo(this.model.thread, 'change:content', this.renderThreadImage);

            this.contentRegion = this.addRegion('[data-role=card-content]');
        },

        /**
         * Returns a new view instance for the reason portion of this item's
         * card.
         * @returns {Backbone.View} - A view to show the reason for this item
         */
        getContentView: function () {
            var CardViewClass;

            switch (this.model.get('verb')) {
            case 'favorite':
                CardViewClass = ActivityCardFavoriteView;
                break;
            case 'post':
                CardViewClass = ActivityCardPostView;
                break;
            case 'reply':
                CardViewClass = ActivityCardReplyView;
                break;
            case 'trending':
                CardViewClass = ActivityCardTrendingView;
                break;
            case 'create':
                CardViewClass = ActivityCardCreateView;
                break;
            }

            return new CardViewClass({
                el: this.contentRegion.el,
                model: this.model,
            });
        },

        renderThreadImage: function () {
            if (layoutUtils.isNarrowLayout())
                return;

            var data = this.serializeData();
            data = this.mixinTemplateHelpers(data);
            this.$('[data-role=thread-image]').html(Handlebars.partials.threadImage(data));
        },

        onRender: function () {
            var contentRegion = this.contentRegion;
            this.activateRegion(contentRegion, this.getContentView);
            var contentView = contentRegion.currentView;

            if (contentView.shouldCollapse && contentView.shouldCollapse())
                this.$el.addClass('card-collapsed');
        },
    });


    var proto = ActivityCardWrapperView.prototype;
    asCollapsibleCard.call(proto);
    withSubviews.call(proto);

    return ActivityCardWrapperView;
});

define('home/templates/feedEmpty',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Woops, nothing is happening here.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":1,"column":0},"end":{"line":1,"column":47}}}))
    + "\n";
},"useData":true})

});
define('home/views/FeedEmptyView',[
    'backbone-marionette',

    'home/templates/feedEmpty',
], function (
    Marionette,

    feedEmptyTemplate
) {
    'use strict';

    var FeedEmptyView = Marionette.ItemView.extend({
        template: feedEmptyTemplate,
    });

    return FeedEmptyView;
});

define('home/views/ActivityCardCollectionView',[
    'underscore',

    'home/views/ActivityCardWrapperView',
    'home/views/common/FetchableCollectionView',
    'home/views/FeedEmptyView',

    'home/mixins/withViewFeedTracking',
    'home/mixins/withClickLinkTracking',
], function (
    _,

    ActivityCardWrapperView,
    FetchableCollectionView,
    FeedEmptyView,

    withViewFeedTracking,
    withClickLinkTracking
) {
    'use strict';

    var ActivityCardCollectionView = FetchableCollectionView.extend({
        className: 'cards',
        emptyView: FeedEmptyView,

        itemView: ActivityCardWrapperView,

        events: _.defaults({
            'click a[data-link-name]': function (evt) {
                // Only track click events on the activity cards. Leave tracking on other cards
                // (such as empty view cards) to the subviews
                if (!this.isShowingNonItemView())
                    this.trackClickLink(evt);
            },
        }, FetchableCollectionView.prototype.events),
    });

    withViewFeedTracking.call(ActivityCardCollectionView.prototype);
    withClickLinkTracking.call(ActivityCardCollectionView.prototype);

    return ActivityCardCollectionView;
});

define('home/templates/commentCardPostActions',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\"#\" class=\"vote-up"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"sessionUserHasUpvoted") : depth0),{"name":"if","hash":{},"fn":container.program(2, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":2,"column":26},"end":{"line":2,"column":69}}})) != null ? stack1 : "")
    + "\" data-action=\"vote\" data-vote=\"1\">\n<span class=\"vote__count text-gray text-small\" data-role=\"upvotes\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"likes") : depth0),{"name":"if","hash":{},"fn":container.program(4, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":4,"column":0},"end":{"line":4,"column":29}}})) != null ? stack1 : "")
    + "\n</span>\n<span class=\"icon-arrow-up icon-tiny\"></span>\n</a>\n";
},"2":function(container,depth0,helpers,partials,data) {
    return " active";
},"4":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"likes") : depth0), depth0));
},"6":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\"#\" class=\"vote-down"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"sessionUserHasDownvoted") : depth0),{"name":"if","hash":{},"fn":container.program(2, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":11,"column":28},"end":{"line":11,"column":73}}})) != null ? stack1 : "")
    + "\" data-action=\"vote\" data-vote=\"-1\">\n<span class=\"icon-arrow-down icon-tiny\"></span>\n<span class=\"vote__count text-gray text-small\" data-role=\"downvotes\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"showDownvoteCount") : depth0),{"name":"if","hash":{},"fn":container.program(7, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":14,"column":0},"end":{"line":14,"column":44}}})) != null ? stack1 : "")
    + "\n</span>\n</a>\n";
},"7":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"dislikes") : depth0), depth0));
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.lambda, alias3=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"showUpvote") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":1,"column":0},"end":{"line":8,"column":7}}})) != null ? stack1 : "")
    + "\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"showDownvote") : depth0),{"name":"if","hash":{},"fn":container.program(6, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":10,"column":0},"end":{"line":17,"column":7}}})) != null ? stack1 : "")
    + "\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"replyOrEditLink"),depth0,{"name":"replyOrEditLink","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "\n<a href=\""
    + alias3(alias2((depth0 != null ? lookupProperty(depth0,"discussionRoute") : depth0), depth0))
    + "#comment-"
    + alias3(alias2((depth0 != null ? lookupProperty(depth0,"id") : depth0), depth0))
    + "\"\nclass=\"view-comment link-gray\"\ndata-link-name=\"view_comment\"\ndata-thread-id=\""
    + alias3(alias2(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + "\">\n\n<span class=\"visible-md\">"
    + alias3(lookupProperty(helpers,"gettext").call(alias1,"View",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":26,"column":25},"end":{"line":26,"column":43}}}))
    + "</span>\n<span class=\"hidden-md\">"
    + alias3(lookupProperty(helpers,"gettext").call(alias1,"View in discussion",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":27,"column":24},"end":{"line":27,"column":56}}}))
    + "</span>\n</a>\n";
},"usePartial":true,"useData":true})

});
define('home/views/CommentCardPostActionsView',[
    'jquery',

    'home/views/PostActionsView',
    'home/templates/commentCardPostActions',
], function (
    $,

    PostActionsView,
    commentCardPostActionsTemplate
) {
    'use strict';

    var CommentCardPostActionsView = PostActionsView.extend({
        template: commentCardPostActionsTemplate,

        // TODO support inline replies
        initializeReplyViewManager: $.noop,
        toggleReplyView: $.noop,
    });

    return CommentCardPostActionsView;
});

define('home/templates/commentCard',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.lambda, alias3=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card-comment comment-card__wrap\">\n<div\nclass=\"card-link__wrapper "
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"image") : depth0),{"name":"unless","hash":{},"fn":container.program(2, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":4,"column":26},"end":{"line":4,"column":63}}})) != null ? stack1 : "")
    + " align\"\ndata-role=\"thread-link\"\ndata-link-name=\"thread_preview\"\ndata-thread-id=\""
    + alias3(alias2(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + "\">\n\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"image") : depth0),{"name":"if","hash":{},"fn":container.program(4, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":9,"column":0},"end":{"line":11,"column":7}}})) != null ? stack1 : "")
    + "<div class=\"card-link__body\">\n<div>\n<div class=\"truncate\" data-truncate-lines=\"2\" dir=\"auto\">\n<h3 class=\"text-large\">"
    + alias3(alias2(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"clean_title") : stack1), depth0))
    + "</h3>\n</div>\n</div>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"threadDescription") : depth0),{"name":"if","hash":{},"fn":container.program(6, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":18,"column":0},"end":{"line":27,"column":7}}})) != null ? stack1 : "")
    + "</div>\n</div>\n<div data-role=\"posts\" class=\"card-link__comments\"></div>\n<button class=\"comment-card__more text-small pull-right\">\n<span class=\"visible-md\">"
    + alias3(lookupProperty(helpers,"gettext").call(alias1,"Less",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":32,"column":25},"end":{"line":32,"column":43}}}))
    + "</span>\n<span class=\"hidden-md\">"
    + alias3(lookupProperty(helpers,"gettext").call(alias1,"Less Information",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":33,"column":24},"end":{"line":33,"column":54}}}))
    + "</span>\n</button>\n</div>\n";
},"2":function(container,depth0,helpers,partials,data) {
    return " no-image";
},"4":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<img class=\"card-link__img\" src=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"image") : depth0)) != null ? lookupProperty(stack1,"src") : stack1), depth0))
    + "\" alt=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"image") : depth0)) != null ? lookupProperty(stack1,"title") : stack1), depth0))
    + "\">\n";
},"6":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div>\n<div class=\"card-link__description truncate\" data-truncate-lines=\"2\" dir=\"auto\">\n"
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"threadDescription") : depth0), depth0))
    + "\n</div>\n</div>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"forumFriendlyUrl") : depth0),{"name":"if","hash":{},"fn":container.program(7, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":24,"column":0},"end":{"line":26,"column":7}}})) != null ? stack1 : "");
},"7":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card-link-forum-url\">("
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"forumFriendlyUrl") : depth0), depth0))
    + ")</div>\n";
},"9":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.lambda, alias3=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card-comment comment-card__wrap\">\n<div class=\"comment-body\">\n<div class=\"comment-header comment-card__header text-small text-gray\">\n"
    + ((stack1 = lookupProperty(helpers,"with").call(alias1,(depth0 != null ? lookupProperty(depth0,"postActivity") : depth0),{"name":"with","hash":{},"fn":container.program(10, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":40,"column":0},"end":{"line":46,"column":9}}})) != null ? stack1 : "")
    + "<time class=\"time\">"
    + alias3(alias2((depth0 != null ? lookupProperty(depth0,"relativeTime") : depth0), depth0))
    + "</time>\n</div>\n<div class=\"comment-card__title link-inner-gray text-small\">\n<strong class=\"link-gray-dark\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"channelAwareForumLink"),((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1),{"name":"channelAwareForumLink","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</strong>\n<span class=\"bullet\"></span>\n<span class=\"truncate\" data-truncate-lines=\"2\" dir=\"auto\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"threadLink"),depth0,{"name":"threadLink","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</span>\n</div>\n<div class=\"card-content__summary\">\n<div class=\"truncate\" data-truncate-lines=\"30\" data-role=\"message\">\n"
    + ((stack1 = alias2(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"postActivity") : depth0)) != null ? lookupProperty(stack1,"object") : stack1)) != null ? lookupProperty(stack1,"message") : stack1), depth0)) != null ? stack1 : "")
    + "\n</div>\n</div>\n<div class=\"card-comment-action comment-card__action\" data-role=\"actions\"></div>\n</div>\n<button class=\"comment-card__more text-gray-light text-small pull-right\">\n<span class=\"visible-md\">"
    + alias3(lookupProperty(helpers,"gettext").call(alias1,"More",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":66,"column":25},"end":{"line":66,"column":43}}}))
    + "</span>\n<span class=\"hidden-md\">"
    + alias3(lookupProperty(helpers,"gettext").call(alias1,"More Information",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":67,"column":24},"end":{"line":67,"column":54}}}))
    + "</span>\n</button>\n\n</div>\n";
},"10":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = container.invokePartial(lookupProperty(partials,"userPreview"),(depth0 != null ? lookupProperty(depth0,"actor") : depth0),{"name":"userPreview","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,lookupProperty(helpers,"eq").call(alias1,(depth0 != null ? lookupProperty(depth0,"verb") : depth0),"reply",{"name":"eq","hash":{},"data":data,"loc":{"start":{"line":42,"column":6},"end":{"line":42,"column":23}}}),{"name":"if","hash":{},"fn":container.program(11, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":42,"column":0},"end":{"line":45,"column":7}}})) != null ? stack1 : "");
},"11":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<span class=\"icon-forward\"></span>\n<span class=\"link-inner-gray\">"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"userName"),((stack1 = (depth0 != null ? lookupProperty(depth0,"target") : depth0)) != null ? lookupProperty(stack1,"author") : stack1),{"name":"userName","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</span>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"expanded") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(9, data, 0),"data":data,"loc":{"start":{"line":1,"column":0},"end":{"line":71,"column":7}}})) != null ? stack1 : "");
},"usePartial":true,"useData":true})

});
define('home/views/CommentCardView',[
    'jquery',
    'underscore',
    'backbone',

    'core/mixins/withRichMedia',

    'home/utils/navigationUtils',
    'home/mixins/withAllstarPopover',
    'home/mixins/withSubviews',
    'home/mixins/withTruncate',
    'home/views/common/ActivityCardView',
    'home/views/CommentCardPostActionsView',
    'home/views/PostActivityCollectionView',

    'home/templates/commentCard',
], function (
    $,
    _,
    Backbone,

    withRichMedia,

    navigationUtils,
    withAllstarPopover,
    withSubviews,
    withTruncate,
    ActivityCardView,
    CommentCardPostActionsView,
    PostActivityCollectionView,

    commentCardTemplate
) {
    'use strict';

    var CommentCardView = ActivityCardView.extend({
        className: 'card-wrap is-expandable',

        template: commentCardTemplate,

        templateHelpers: function () {
            var postActivity = this.getPostActivity();

            return {
                expanded: this.expanded,
                discussionRoute: this.model.thread.getDiscussionRoute(),
                postActivity: postActivity.toJSON(),
                relativeTime: postActivity.getRelativeCreatedAt(),
                forumFriendlyUrl: this.model.thread.forum.getFriendlyUrl(),
                threadDescription: this.model.thread.getPlainDescription(),
                image: this.model.thread.getImage(),
            };
        },

        regions: {
            actionsRegion: '[data-role=actions]',
            postsRegion: '[data-role=posts]',
        },

        events: {
            'click': 'handleClick',
            'mouseover': 'beginHover',
            'mouseout': 'endHover',
            'mouseover a': 'endHover',
            'mouseout a': 'beginHover',
            'mouseover [data-role=thread-link]': 'endHover',
            'mouseout [data-role=thread-link]': 'beginHover',
        },

        initialize: function () {
            this.boundRenderPostMedia = _.bind(this.renderPostMedia, this);
        },

        onRender: function () {
            this.activateRegion(this.actionsRegion, this.createDefaultActionsView);

            // Comments are rendered by the postCollectionView in the expanded
            // version of this view. Rich media is handled by the item views.
            if (this.expanded)
                this.activateRegion(this.postsRegion, this.createPostCollectionView);
            // Rendering rich media must wait for truncation to complete because
            // of an incompatibility between IFrameRichMedia and the trunk8
            // plugin. The IFrameRichMediaView shows loading spinners that are
            // removed when the iframe is loaded, but trunk8 removes the iframe
            // from the DOM and reinserts it, losing the load event handler
            // that removes that loading spinners.
            // If this view was previously shown, truncation (which happens in
            // onDomRefresh) will have completed before onRender is called.
            else if (this._isShown)
                this.boundRenderPostMedia();
            // If this render is happening before the view is shown, truncation
            // will occur once the view is shown. Wait until it completes
            // before rendering rich media.
            else
                this.listenToOnce(this, 'truncate:complete', this.boundRenderPostMedia);
        },

        renderPostMedia: function () {
            var post = this.getPostActivity().object;
            this.renderRichMedia(post.get('media'));
        },

        // The backend does not group activities for this feed,
        // so there should only be 1 activity to display
        getPostActivity: function () {
            return this.model.activities[0];
        },

        createDefaultActionsView: function () {
            return new CommentCardPostActionsView({
                model: this.getPostActivity().object,
            });
        },

        createPostCollectionView: function () {
            return new PostActivityCollectionView({
                el: this.postsRegion.el,
                collection: new Backbone.Collection(this.model.activities),
                collapsePosts: false,
            });
        },

        handleClick: function (evt) {
            if ($(evt.target).closest('[data-role=thread-link]').length) {
                navigationUtils.navigate(this.model.thread.getDiscussionRoute(), { trigger: true });
                return false;
            }

            this.toggleExpanded(evt);
        },

        toggleExpanded: function (evt) {
            // Don't toggle expanded state if user clicked on a link or in a form.
            if ($(evt.target).closest('a, form', this.$el).length)
                return;

            this.expanded = !this.expanded;
            this.render();

            // After render has completed, check if the card is still hovered
            _.delay(_.bind(this.checkHovered, this));
        },

        checkHovered: function () {
            // After card has (un)expanded, checks if the card is still hovered.
            // If the cursor is over this card but not any of the links in the card,
            // show the hover state.
            var cardIsHovered = this.$el.is(':hover') &&
                !this.$el.find('a:hover').length &&
                !this.$el.find('[data-role=thread-link]:hover').length;

            this.$el.toggleClass('is-hovered', cardIsHovered);
        },

        beginHover: function (evt) {
            // Don't show the hover state when user is hovering over a link
            // ([data-role=thread-link] acts as a link so treat it as such)
            var $target = $(evt.target);
            if (!$target.closest('a', this.$el).length &&
                !$target.closest('[data-role=thread-link]', this.$el).length)

                this.$el.addClass('is-hovered');
        },

        endHover: function () {
            this.$el.removeClass('is-hovered');
        },
    });

    withAllstarPopover.call(CommentCardView.prototype);
    withTruncate.call(CommentCardView.prototype);
    withSubviews.call(CommentCardView.prototype);
    withRichMedia.call(CommentCardView.prototype);

    return CommentCardView;
});

define('home/views/CommentCardCollectionView',[
    'home/views/ActivityCardCollectionView',
    'home/views/CommentCardView',
], function (
    ActivityCardCollectionView,
    CommentCardView
) {
    'use strict';

    var CommentCardCollectionView = ActivityCardCollectionView.extend({
        itemView: CommentCardView,
    });

    return CommentCardCollectionView;
});

define('home/templates/homepageUserModule',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    return " is-allstar";
},"3":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = container.invokePartial(lookupProperty(partials,"userAvatar"),depth0,{"name":"userAvatar","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "");
},"5":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\"/home/settings/profile/\" class=\"avatar avatar__add button-outline text-semibold\">\n<span class=\"icon-plus\"></span>"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Avatar",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":18,"column":31},"end":{"line":18,"column":51}}}))
    + "\n</a>\n";
},"7":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\"/home/settings/profile/\" class=\"button button-small button-wide button-outline spacing-left spacing-right\">\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Complete your profile",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":28,"column":0},"end":{"line":28,"column":35}}}))
    + "\n</a>\n";
},"9":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, alias3=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"align__item\">\n<a href=\"/by/"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"username") : depth0), depth0))
    + "/\" class=\"link-gray-darker\" data-link-name=\"comment_count\">\n"
    + ((stack1 = lookupProperty(helpers,"unless").call(alias3,lookupProperty(helpers,"eq").call(alias3,(depth0 != null ? lookupProperty(depth0,"numPosts") : depth0),1,{"name":"eq","hash":{},"data":data,"loc":{"start":{"line":33,"column":10},"end":{"line":33,"column":25}}}),{"name":"unless","hash":{},"fn":container.program(10, data, 0),"inverse":container.program(12, data, 0),"data":data,"loc":{"start":{"line":33,"column":0},"end":{"line":39,"column":11}}})) != null ? stack1 : "")
    + "</a>\n</div>\n<div class=\"align__item\">\n<a href=\"/by/"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"username") : depth0), depth0))
    + "/following/\" class=\"link-gray-darker\" data-link-name=\"following_count\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias3,"%(num)s Following",{"name":"gettext","hash":{"num":lookupProperty(helpers,"tag").call(alias3,"h3",{"name":"tag","hash":{"text":(depth0 != null ? lookupProperty(depth0,"numTotalFollowing") : depth0),"class":"text-medium"},"data":data,"loc":{"start":{"line":45,"column":6},"end":{"line":45,"column":59}}})},"data":data,"loc":{"start":{"line":44,"column":0},"end":{"line":45,"column":61}}}))
    + "\n</a>\n</div>\n<div class=\"align__item\">\n<a href=\"/by/"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"username") : depth0), depth0))
    + "/followers/\" class=\"link-gray-darker\" data-link-name=\"followers_count\">\n"
    + ((stack1 = lookupProperty(helpers,"unless").call(alias3,lookupProperty(helpers,"eq").call(alias3,(depth0 != null ? lookupProperty(depth0,"numFollowers") : depth0),1,{"name":"eq","hash":{},"data":data,"loc":{"start":{"line":50,"column":10},"end":{"line":50,"column":29}}}),{"name":"unless","hash":{},"fn":container.program(14, data, 0),"inverse":container.program(16, data, 0),"data":data,"loc":{"start":{"line":50,"column":0},"end":{"line":56,"column":11}}})) != null ? stack1 : "")
    + "</a>\n</div>\n";
},"10":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(alias1,"%(num)s Comments",{"name":"gettext","hash":{"num":lookupProperty(helpers,"tag").call(alias1,"h3",{"name":"tag","hash":{"text":(depth0 != null ? lookupProperty(depth0,"numPosts") : depth0),"class":"text-medium"},"data":data,"loc":{"start":{"line":35,"column":6},"end":{"line":35,"column":50}}})},"data":data,"loc":{"start":{"line":34,"column":0},"end":{"line":35,"column":52}}}))
    + "\n";
},"12":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(alias1,"%(num)s Comment",{"name":"gettext","hash":{"num":lookupProperty(helpers,"tag").call(alias1,"h3",{"name":"tag","hash":{"text":"1","class":"text-medium"},"data":data,"loc":{"start":{"line":38,"column":6},"end":{"line":38,"column":45}}})},"data":data,"loc":{"start":{"line":37,"column":0},"end":{"line":38,"column":47}}}))
    + "\n";
},"14":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(alias1,"%(num)s Followers",{"name":"gettext","hash":{"num":lookupProperty(helpers,"tag").call(alias1,"h3",{"name":"tag","hash":{"text":(depth0 != null ? lookupProperty(depth0,"numFollowers") : depth0),"class":"text-medium"},"data":data,"loc":{"start":{"line":52,"column":6},"end":{"line":52,"column":54}}})},"data":data,"loc":{"start":{"line":51,"column":0},"end":{"line":52,"column":56}}}))
    + "\n";
},"16":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(alias1,"%(num)s Follower",{"name":"gettext","hash":{"num":lookupProperty(helpers,"tag").call(alias1,"h3",{"name":"tag","hash":{"text":"1","class":"text-medium"},"data":data,"loc":{"start":{"line":55,"column":6},"end":{"line":55,"column":45}}})},"data":data,"loc":{"start":{"line":54,"column":0},"end":{"line":55,"column":47}}}))
    + "\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"aside-user__header"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"isPowerContributor") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":1,"column":30},"end":{"line":1,"column":74}}})) != null ? stack1 : "")
    + "\">\n<div class=\"avatar-circle-bg__wrapper\">\n<div class=\"avatar-circle-bg\">\n<div class=\"avatar-circle-bg\">\n<div class=\"avatar-circle-bg\">\n<div class=\"avatar-circle-bg\">\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n<div class=\"aside-user__avatar align align--column\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"avatar") : depth0)) != null ? lookupProperty(stack1,"isCustom") : stack1),{"name":"if","hash":{},"fn":container.program(3, data, 0),"inverse":container.program(5, data, 0),"data":data,"loc":{"start":{"line":14,"column":0},"end":{"line":20,"column":7}}})) != null ? stack1 : "")
    + "</div>\n<div class=\"aside-user__name\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"userName"),depth0,{"name":"userName","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n<div class=\"aside-user__body align\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"promptForProfileCompletion") : depth0),{"name":"if","hash":{},"fn":container.program(7, data, 0),"inverse":container.program(9, data, 0),"data":data,"loc":{"start":{"line":26,"column":0},"end":{"line":59,"column":7}}})) != null ? stack1 : "")
    + "</div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/HomepageUserModuleView',[
    'underscore',
    'backbone-marionette',

    'home/mixins/withAllstarPopover',
    'home/templates/homepageUserModule',
], function (
    _,
    Marionette,

    withAllstarPopover,
    homepageUserModuleTemplate
) {
    'use strict';

    var HomepageUserModuleView = Marionette.ItemView.extend({
        template: homepageUserModuleTemplate,
        className: 'aside__wrap',

        templateHelpers: function () {
            return {
                numTotalFollowing: this.model.getNumTotalFollowing(),
                promptForProfileCompletion: this.shouldPromptForProfileCompletion(),
            };
        },

        /**
         * We prompt the user to complete their profile for 24 hours after they
         * created their account, and if their profile is not already complete.
         */
        shouldPromptForProfileCompletion: function () {
            var profileIsComplete = this.model.get('avatar').isCustom &&
                _.chain(this.model.attributes)
                    .pick(['name', 'about', 'url', 'location'])
                    .every()
                    .value();

            return this.model.registeredToday() && !profileIsComplete;
        },

        // Initial render waits until User details are fetched, but
        // after user's following channels are fetched the total number
        // of things he/she is following may have changed.
        modelEvents: {
            'change:numChannelsFollowing': 'render',
        },
    });

    withAllstarPopover.call(HomepageUserModuleView.prototype);

    return HomepageUserModuleView;
});

define('home/templates/homepageCommentsModuleEmptyView',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<p><a href=\"/home/explore/people/\">"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Find interesting users to follow",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":6,"column":35},"end":{"line":6,"column":81}}}))
    + "</a></p>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"post-comments__wrapper\">\n<div class=\"empty-message post-comments\">\n<span class=\"icon-empty-comment text-gray-light icon-huge\"></span>\n<p>"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(alias1,"Follow other %(disqus)s users to see their latest comments appear here.",{"name":"gettext","hash":{"disqus":"Disqus"},"data":data,"loc":{"start":{"line":4,"column":3},"end":{"line":4,"column":106}}}))
    + "</p>\n"
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"onboardingWithoutChannels") : depth0),{"name":"unless","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":5,"column":0},"end":{"line":7,"column":11}}})) != null ? stack1 : "")
    + "</div>\n</div>\n";
},"useData":true})

});
define('home/views/HomepageCommentsModuleEmptyView',[
    'backbone-marionette',
    'home/templates/homepageCommentsModuleEmptyView',
    'core/switches',
], function (
    Marionette,
    homepageCommentsModuleEmptyView,
    switches
) {
    'use strict';

    var HomepageCommentsModuleEmptyView = Marionette.ItemView.extend({
        template: homepageCommentsModuleEmptyView,
        templateHelpers: {
            onboardingWithoutChannels: switches.isFeatureActive('onboarding_without_channels'),
        },
    });

    return HomepageCommentsModuleEmptyView;
});

define('home/templates/homepageCommentsModule',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<header class=\"module-header text-center\">\n<div class=\"module-header__icon\">\n<span class=\"icon icon-latest-comments text-brand\"></span>\n</div>\n<div class=\"module-header__title\">\n<h2 class=\"module-header__heading\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Latest Comments",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":6,"column":35},"end":{"line":6,"column":64}}}))
    + "</h2>\n<p class=\"module-header__subheading\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Comments by people you follow and replies to you.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":7,"column":37},"end":{"line":7,"column":100}}}))
    + "</p>\n</div>\n</header>\n\n<div data-role=\"posts\" class=\"module-body\"></div>\n\n<footer data-action=\"switch-tab\" data-tab=\"comments\" class=\"module-footer\">\n<a href=\"/home/comments/\" class=\"nav-lnk -color-muted -flushed\">\n<div class=\"nav-lnk__blk\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"See All Comments",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":15,"column":26},"end":{"line":15,"column":56}}}))
    + "</div>\n<div class=\"nav-lnk__pointer\">\n<span class=\"icon icon-right-bracket\"></span>\n</div>\n</a>\n</footer>\n";
},"useData":true})

});
define('home/views/HomepageCommentsModuleView',[
    'backbone-marionette',

    'home/views/ChannelCardPostView',
    'home/views/FetchingView',
    'home/views/HomepageCommentsModuleEmptyView',

    'home/templates/homepageCommentsModule',
], function (
    Marionette,

    ChannelCardPostView,
    FetchingView,
    HomepageCommentsModuleEmptyView,

    homepageCommentsModuleTemplate
) {
    'use strict';

    var HomepageCommentsModuleView = Marionette.CompositeView.extend({
        template: homepageCommentsModuleTemplate,
        className: 'aside__wrap -padded',
        emptyView: function () {
            return new FetchingView({
                className: 'spinner-small',
            });
        },

        itemView: ChannelCardPostView,
        itemViewContainer: '[data-role=posts]',

        initialize: function (options) {
            options = options || {};
            this.commentsPromise = options.commentsPromise;
        },

        itemViewOptions: function (_item, index) {
            // Only show the first 3 items
            if (index > 2)
                return { className: 'hidden' };
        },

        onDomRefresh: function () {
            // This module supports a promise when the comments are fetched from
            // an external source. We listen to it to know when to replace the
            // fetching state with an empty state, if needed.
            if (this.commentsPromise) {
                var self = this;
                this.commentsPromise.then(function () {
                    if (self.collection.length === 0)
                        self.createEmptyView();
                });
            }
        },

        createEmptyView: function () {
            if (!this._emptyViewCreated) {
                this.emptyView = HomepageCommentsModuleEmptyView;
                this.render();
                this._emptyViewCreated = true;
            }
        },
    });

    return HomepageCommentsModuleView;
});

define('home/templates/channelsModuleItem',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<img src=\""
    + container.escapeExpression(container.lambda(((stack1 = (depth0 != null ? lookupProperty(depth0,"options") : depth0)) != null ? lookupProperty(stack1,"tile") : stack1), depth0))
    + "\" class=\"tile__media border-radius-sm\" />\n";
},"3":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"tile__overlay\">\n<h1 class=\"tile__name\">"
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"name") : depth0), depth0))
    + "</h1>\n</div>\n<img src=\"https://media.disquscdn.com/home/blank_tile.png\"\nclass=\"tile__media border-radius-sm\" />\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, alias3=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"spacing-bottom-large\">\n<a href=\"/home/channel/"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"slug") : depth0), depth0))
    + "/\" class=\"tile__wrapper -plain link-gray-dark\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias3,((stack1 = (depth0 != null ? lookupProperty(depth0,"options") : depth0)) != null ? lookupProperty(stack1,"tile") : stack1),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"data":data,"loc":{"start":{"line":3,"column":0},"end":{"line":11,"column":7}}})) != null ? stack1 : "")
    + "</a>\n<div class=\"channels-description -with-button align\">\n<p class=\"align__item spacing-right\">"
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"options") : depth0)) != null ? lookupProperty(stack1,"description") : stack1), depth0))
    + "</p>\n<div class=\"channels-description__button align__item\">\n<a class=\"button button-outline text-medium\"\nhref=\"/home/channel/"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"slug") : depth0), depth0))
    + "/\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias3,"Visit",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":18,"column":0},"end":{"line":18,"column":19}}}))
    + "\n</a>\n</div>\n</div>\n</div>\n";
},"useData":true})

});
define('home/views/ChannelsModuleItemView',[
    'backbone-marionette',

    'home/templates/channelsModuleItem',
], function (
    Marionette,

    channelsModuleItemTemplate
) {
    'use strict';

    /**
     * Shows a single channel in a module.
     * Expects a Channel model.
     */
    var ChannelsModuleItemView = Marionette.ItemView.extend({
        template: channelsModuleItemTemplate,
    });

    return ChannelsModuleItemView;
});

define('home/templates/channelsModule',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"module--plain\">\n<header class=\"module-header -no-border\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"channelsModuleHeader"),depth0,{"name":"channelsModuleHeader","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</header>\n<div data-role=\"channels\" class=\"module-body\"></div>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/ChannelsModuleView',[
    'backbone-marionette',

    'home/views/FetchingView',
    'home/views/ChannelsModuleItemView',

    'home/templates/channelsModule',
], function (
    Marionette,

    FetchingView,
    ChannelsModuleItemView,

    channelsModuleTemplate
) {
    'use strict';

    /**
     * Shows a randomized subset of given channels listed in a module view.
     * Expects a Collection of ChannelProfiles or Channels
     */
    var ChannelsModuleView = Marionette.CompositeView.extend({
        template: channelsModuleTemplate,

        itemView: ChannelsModuleItemView,
        itemViewContainer: '[data-role=channels]',
        itemViewOptions: function (item) {
            return {
                model: item.channel || item,
            };
        },

        addItemView: function (item, ItemView, index) {
            if (index > this.constructor.CHANNELS_MAX - 1)
                return;

            return Marionette.CompositeView.prototype.addItemView.call(this, item, ItemView, index);
        },

        emptyView: function () {
            return new FetchingView({
                className: 'spinner-small',
            });
        },
    }, {
        CHANNELS_MAX: 3,
    });

    return ChannelsModuleView;
});

define('home/templates/channelSuggestion',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = container.invokePartial(lookupProperty(partials,"channelAvatarWithDefault"),depth0,{"name":"channelAvatarWithDefault","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "");
},"3":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<img class=\"forum-favicon\" src=\""
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"favicon") : depth0), depth0))
    + "\" alt=\""
    + ((stack1 = container.invokePartial(lookupProperty(partials,"forumName"),depth0,{"name":"forumName","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "\">\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"recommended__item\">\n<a href=\"/home/channel/"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"slug") : depth0), depth0))
    + "/\"\nclass=\"avatar\"\ndata-link-name=\"channel_avatar\"\ndata-channel-slug=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"slug") : depth0), depth0))
    + "\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"channel") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"data":data,"loc":{"start":{"line":6,"column":0},"end":{"line":10,"column":7}}})) != null ? stack1 : "")
    + "</a>\n<h3 class=\"recommended__name truncate-line\">\n<a href=\"/home/channel/"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"slug") : depth0), depth0))
    + "/\"\ndata-link-name=\"channel_name\"\ndata-channel-slug=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"slug") : depth0), depth0))
    + "\">\n\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"forumName"),depth0,{"name":"forumName","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</a>\n</h3>\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"genericFollowButton"),(depth0 != null ? lookupProperty(depth0,"primaryForum") : depth0),{"name":"genericFollowButton","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n<div class=\"recommended__reason\"><em>"
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"options") : depth0)) != null ? lookupProperty(stack1,"description") : stack1), depth0))
    + "</em></div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/ChannelSuggestionView',[
    'backbone-marionette',

    'home/mixins/withChannelAvatar',
    'core/mixins/withChannelFollowing',
    'home/templates/channelSuggestion',
], function (
    Marionette,

    withChannelAvatar,
    withChannelFollowing,
    channelSuggestionTemplate
) {
    'use strict';

    /**
     * A view showing a single forum's avatar, name, and follow button.
     */
    var ChannelSuggestionView = Marionette.ItemView.extend({
        template: channelSuggestionTemplate,
        className: 'recommended__item',

        templateHelpers: function () {
            return {
                favicon: this.model.get('options').favicon || this.model.primaryForum.get('favicon').cache,
            };
        },
    });

    withChannelFollowing.call(ChannelSuggestionView.prototype, function () {
        return this.model;
    });

    withChannelAvatar.call(ChannelSuggestionView.prototype);

    return ChannelSuggestionView;
});

define('home/templates/homepageChannelsModule',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div>\n<header class=\"module-header\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"channelsModuleHeader"),depth0,{"name":"channelsModuleHeader","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</header>\n<div data-role=\"channels\" class=\"module-body\"></div>\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"channelsModuleMoreFooter"),depth0,{"name":"channelsModuleMoreFooter","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/HomepageChannelsModuleView',[
    'underscore',

    'core/strings',

    'home/views/ChannelsModuleView',
    'home/views/ChannelSuggestionView',
    'home/templates/homepageChannelsModule',
], function (
    _,

    strings,

    ChannelsModuleView,
    ChannelSuggestionView,
    homepageChannelsModuleTemplate
) {
    'use strict';

    var gettext = strings.get;

    /**
     * An enclosed module that shows a list of channels.
     * Expects a collection of ChannelProfiles or Channels
     */
    var HomepageChannelsModuleView = ChannelsModuleView.extend({
        className: 'aside__wrap -padded',

        template: homepageChannelsModuleTemplate,
        templateHelpers: {
            moduleTitle: gettext('Lively Channels'),
        },

        itemView: ChannelSuggestionView,
        itemViewOptions: function (item, index) {
            var existing = ChannelsModuleView.prototype.itemViewOptions;
            if (_.isFunction(existing))
                existing = existing.call(this, item, index);

            return _.defaults({
                className: 'recommended-wrap',
            }, existing);
        },
    });

    return HomepageChannelsModuleView;
});

define('home/templates/homepageOnboardingModule',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Discussions from communities and people you follow will appear here in your feed.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":5,"column":0},"end":{"line":5,"column":95}}}))
    + "\n";
},"3":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(alias1,lookupProperty(helpers,"eq").call(alias1,(depth0 != null ? lookupProperty(depth0,"numShown") : depth0),0,{"name":"eq","hash":{},"data":data,"loc":{"start":{"line":6,"column":14},"end":{"line":6,"column":29}}}),{"name":"if","hash":{},"fn":container.program(4, data, 0),"inverse":container.program(6, data, 0),"data":data,"loc":{"start":{"line":6,"column":8},"end":{"line":35,"column":28}}})) != null ? stack1 : "");
},"4":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Discussions from channels and people you follow will appear here in your feed.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":7,"column":0},"end":{"line":7,"column":92}}}))
    + "\n";
},"6":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(alias1,lookupProperty(helpers,"eq").call(alias1,(depth0 != null ? lookupProperty(depth0,"numShown") : depth0),1,{"name":"eq","hash":{},"data":data,"loc":{"start":{"line":8,"column":14},"end":{"line":8,"column":29}}}),{"name":"if","hash":{},"fn":container.program(7, data, 0),"inverse":container.program(9, data, 0),"data":data,"loc":{"start":{"line":8,"column":8},"end":{"line":35,"column":21}}})) != null ? stack1 : "");
},"7":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(alias1,"Voila, discussions from %(channel0)s now appear here in your feed.",{"name":"gettext","hash":{"channel0":lookupProperty(helpers,"getPartial").call(alias1,"strongTag",(depth0 != null ? lookupProperty(depth0,"channel0") : depth0),{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":10,"column":11},"end":{"line":10,"column":44}}})},"data":data,"loc":{"start":{"line":9,"column":0},"end":{"line":11,"column":2}}}))
    + "\n";
},"9":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(alias1,lookupProperty(helpers,"eq").call(alias1,(depth0 != null ? lookupProperty(depth0,"numShown") : depth0),2,{"name":"eq","hash":{},"data":data,"loc":{"start":{"line":12,"column":14},"end":{"line":12,"column":29}}}),{"name":"if","hash":{},"fn":container.program(10, data, 0),"inverse":container.program(15, data, 0),"data":data,"loc":{"start":{"line":12,"column":8},"end":{"line":35,"column":14}}})) != null ? stack1 : "");
},"10":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "\n"
    + ((stack1 = lookupProperty(helpers,"unless").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"overflowCount") : depth0),{"name":"unless","hash":{},"fn":container.program(11, data, 0),"inverse":container.program(13, data, 0),"data":data,"loc":{"start":{"line":13,"column":0},"end":{"line":28,"column":11}}})) != null ? stack1 : "");
},"11":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(alias1,"Voila, discussions from %(channel0)s and %(channel1)s now appear here in your feed",{"name":"gettext","hash":{"channel1":lookupProperty(helpers,"getPartial").call(alias1,"strongTag",(depth0 != null ? lookupProperty(depth0,"channel1") : depth0),{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":16,"column":21},"end":{"line":16,"column":54}}}),"channel0":lookupProperty(helpers,"getPartial").call(alias1,"strongTag",(depth0 != null ? lookupProperty(depth0,"channel0") : depth0),{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":15,"column":11},"end":{"line":16,"column":9}}})},"data":data,"loc":{"start":{"line":14,"column":0},"end":{"line":17,"column":2}}}))
    + "\n";
},"13":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(alias1,"Voila, discussions from %(channel0)s, %(channel1)s, and %(overflowText)s now appear here in your feed",{"name":"gettext","hash":{"overflowText":lookupProperty(helpers,"getPartial").call(alias1,"strongTag",lookupProperty(helpers,"gettext").call(alias1,"%(overflowCount)s more channels",{"name":"gettext","hash":{"overflowCount":(depth0 != null ? lookupProperty(depth0,"overflowCount") : depth0)},"data":data,"loc":{"start":{"line":26,"column":39},"end":{"line":26,"column":110}}}),{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":26,"column":15},"end":{"line":26,"column":111}}}),"channel1":lookupProperty(helpers,"getPartial").call(alias1,"strongTag",(depth0 != null ? lookupProperty(depth0,"channel1") : depth0),{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":25,"column":11},"end":{"line":25,"column":44}}}),"channel0":lookupProperty(helpers,"getPartial").call(alias1,"strongTag",(depth0 != null ? lookupProperty(depth0,"channel0") : depth0),{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":24,"column":11},"end":{"line":24,"column":44}}})},"data":data,"loc":{"start":{"line":23,"column":0},"end":{"line":27,"column":2}}}))
    + "\n";
},"15":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(alias1,lookupProperty(helpers,"eq").call(alias1,(depth0 != null ? lookupProperty(depth0,"numShown") : depth0),3,{"name":"eq","hash":{},"data":data,"loc":{"start":{"line":29,"column":14},"end":{"line":29,"column":29}}}),{"name":"if","hash":{},"fn":container.program(16, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":29,"column":8},"end":{"line":35,"column":7}}})) != null ? stack1 : "");
},"16":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(alias1,"Voila, discussions from %(channel0)s, %(channel1)s, and %(channel2)s now appear here in your feed",{"name":"gettext","hash":{"channel2":lookupProperty(helpers,"getPartial").call(alias1,"strongTag",(depth0 != null ? lookupProperty(depth0,"channel2") : depth0),{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":33,"column":11},"end":{"line":33,"column":44}}}),"channel1":lookupProperty(helpers,"getPartial").call(alias1,"strongTag",(depth0 != null ? lookupProperty(depth0,"channel1") : depth0),{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":32,"column":11},"end":{"line":32,"column":44}}}),"channel0":lookupProperty(helpers,"getPartial").call(alias1,"strongTag",(depth0 != null ? lookupProperty(depth0,"channel0") : depth0),{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":31,"column":11},"end":{"line":31,"column":44}}})},"data":data,"loc":{"start":{"line":30,"column":0},"end":{"line":34,"column":2}}}))
    + "\n";
},"18":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a data-role=\"complete-onboarding\" href=\"/home/explore/\" class=\"button button-inverted text-medium link-inverted\"><span class=\"hidden-md\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Explore more channels and discussions",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":42,"column":138},"end":{"line":42,"column":189}}}))
    + "</span><span class=\"visible-md\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Explore more discussions",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":42,"column":221},"end":{"line":42,"column":259}}}))
    + "</span></a>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"alert alert--brand padding-double align align--column align--center\">\n<p class=\"spacing-bottom text-center\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"onboardingWithoutChannels") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"data":data,"loc":{"start":{"line":4,"column":0},"end":{"line":35,"column":35}}})) != null ? stack1 : "")
    + "\n</p>\n\n<div class=\"align align--center\">\n<button data-role=\"hide-onboarding\" class=\"button button-outline -border-light text-medium spacing-right-small\">"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(alias1,"Got it!",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":39,"column":112},"end":{"line":39,"column":133}}}))
    + "</button>\n\n"
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"onboardingWithoutChannels") : depth0),{"name":"unless","hash":{},"fn":container.program(18, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":41,"column":0},"end":{"line":43,"column":11}}})) != null ? stack1 : "")
    + "</div>\n</div>\n";
},"useData":true})

});
define('home/views/HomepageOnboardingModuleView',[
    'underscore',
    'backbone-marionette',

    'home/models/Session',
    'home/mixins/withOnboarding',
    'home/templates/homepageOnboardingModule',
], function (
    _,
    Marionette,

    Session,
    withOnboarding,
    homepageOnboardingModuleTemplate
) {
    'use strict';

    var HomepageOnboardingModuleView = Marionette.ItemView.extend({
        template: homepageOnboardingModuleTemplate,
        templateHelpers: function () {
            var channelsFollowing = this.getChannelsFollowing();

            // If showing an overcount count, show 1 fewer channel so there's always 3 items shown.
            // ex: x, y, and z OR z, y, and 2 more
            var numShown = channelsFollowing.length <= this.constructor.MAX_CHANNELS_SHOWN ?
                channelsFollowing.length :
                this.constructor.MAX_CHANNELS_SHOWN - 1;

            var overflowCount = Math.max(channelsFollowing.length - numShown, 0);

            var channels = _.chain(channelsFollowing)
                .first(numShown)
                .map(function (channel, index) {
                    return ['channel' + index, channel.get('name')];
                })
                .object()
                .value();

            var data = _.extend({
                numShown: numShown,
                overflowCount: overflowCount,
                onboardingWithoutChannels: this.onboardingWithoutChannels,
            }, channels);

            return data;
        },

        events: {
            'click [data-role=complete-onboarding]': 'markOnboardingComplete',
            'click [data-role=hide-onboarding]': 'hideOnboarding',
        },

        initialize: function (options) {
            this.onboardingWithoutChannels = options.onboardingWithoutChannels;
            this.session = Session.get();
            this.session.loadPromise().then(_.bind(function () {
                var forumsFollowing = this.session.getUserProfile().forumsFollowing;
                this.listenTo(forumsFollowing.items, 'add remove reset', this.render);
            }, this));
        },

        markOnboardingComplete: function () {
            var sessionUser = this.session.user;
            sessionUser.updateFlags({
                homeFeedOnboardingComplete: true,
            });
        },

        hideOnboarding: function () {
            this.markOnboardingComplete();
            this.trigger('hideOnboarding');
        },
    }, {

        // WARNING: Do not change without updating template for proper translations
        MAX_CHANNELS_SHOWN: 3,
    });

    withOnboarding.call(HomepageOnboardingModuleView.prototype);

    return HomepageOnboardingModuleView;
});

define('home/templates/moderatedForumsModuleItem',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"recommended-wrap\">\n<div data-role=\"recommended-object\">\n<div class=\"recommended__item\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"forumAvatarLink"),depth0,{"name":"forumAvatarLink","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "<h3 class=\"recommended__name truncate-line spacing-top-narrow\">\n<a href=\"/home/forums/"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"id") : depth0), depth0))
    + "\">"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"name") : depth0), depth0))
    + "</a>\n</h3>\n<a href=\"https://"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"id") : depth0), depth0))
    + ".disqus.com/admin/\" class=\"button button-outline button-small pull-right\">"
    + alias2(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Manage",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":10,"column":97},"end":{"line":10,"column":117}}}))
    + "</a>\n</div>\n</div>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/ModeratedForumsModuleItemView',[
    'backbone-marionette',

    'home/templates/moderatedForumsModuleItem',
], function (
    Marionette,

    moderatedForumsModuleItemTemplate
) {
    'use strict';

    /**
     * Shows a single forum in a module.
     *
     * Expects a Forum model.
     */
    var ModeratedForumsModuleItemView = Marionette.ItemView.extend({
        template: moderatedForumsModuleItemTemplate,
        initialize: function () {
            if (this.model.shouldFetch())
                this.model.fetch();

            this.listenTo(this.model, 'sync', this.render);
        },
    });

    return ModeratedForumsModuleItemView;
});

define('home/templates/moderatedForumsModule',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<footer class=\"module-footer\">\n<a href=\"/admin/\" class=\"nav-lnk -color-muted -flushed\">\n<div class=\"nav-lnk__blk\">"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Manage All",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":16,"column":26},"end":{"line":16,"column":50}}}))
    + "</div>\n<div class=\"nav-lnk__pointer\">\n<span class=\"icon icon-right-bracket\"></span>\n</div>\n</a>\n</footer>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"module--aside\">\n<div class=\"aside__wrap -padded\">\n<header class=\"module-header -has-button\">\n<div class=\"module-header__title\">\n<h2 class=\"module-header__heading pull-left spacing-top-narrow\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Your Sites",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":6,"column":0},"end":{"line":6,"column":24}}}))
    + "\n<span class=\"text-gray\">("
    + alias2(container.lambda((depth0 != null ? lookupProperty(depth0,"moderatedForumsCount") : depth0), depth0))
    + ")</span>\n</h2>\n<a href=\"/admin/\" class=\"button button-fill--brand button-small pull-right module-header__button\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"View Admin",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":9,"column":98},"end":{"line":9,"column":122}}}))
    + "</a>\n</div>\n</header>\n<div data-role=\"moderated-forums\" class=\"module-body\"></div>\n"
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,lookupProperty(helpers,"eq").call(alias1,(depth0 != null ? lookupProperty(depth0,"moderatedForumsCount") : depth0),1,{"name":"eq","hash":{},"data":data,"loc":{"start":{"line":13,"column":10},"end":{"line":13,"column":37}}}),{"name":"unless","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":13,"column":0},"end":{"line":22,"column":11}}})) != null ? stack1 : "")
    + "</div>\n</div>\n";
},"useData":true})

});
define('home/views/ModeratedForumsModuleView',[
    'backbone-marionette',

    'home/views/FetchingView',
    'home/views/ModeratedForumsModuleItemView',

    'home/templates/moderatedForumsModule',
], function (
    Marionette,

    FetchingView,
    ModeratedForumsModuleItemView,

    moderatedForumsModuleTemplate
) {
    'use strict';

    /**
     * Shows the first 3 forums a user is moderating and
     * links to the moderation page.
     *
     * Expects a ForumCollection
     */
    var ModeratedForumsModuleView = Marionette.CompositeView.extend({
        template: moderatedForumsModuleTemplate,
        itemView: ModeratedForumsModuleItemView,
        itemViewContainer: '[data-role=moderated-forums]',

        templateHelpers: function () {
            return {
                moderatedForumsCount: this.collection.length,
            };
        },

        addItemView: function (item, ItemView, index) {
            if (index > this.constructor.FORUMS_MAX - 1)
                return;

            return Marionette.CompositeView.prototype.addItemView.call(this, item, ItemView, index);
        },

        emptyView: function () {
            return new FetchingView({
                className: 'spinner-small',
            });
        },
    }, {
        FORUMS_MAX: 3,
    });

    return ModeratedForumsModuleView;
});

define('home/templates/followingCard',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a class=\"aside-list__blk align text-gray\"\nhref=\"/home/channel/"
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"channelInfo") : depth0)) != null ? lookupProperty(stack1,"slug") : stack1), depth0))
    + "/\"\ndata-link-name=\"channel-name\"\ndata-channel-slug=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"channelInfo") : depth0)) != null ? lookupProperty(stack1,"slug") : stack1), depth0))
    + "\">\n";
},"3":function(container,depth0,helpers,partials,data) {
    var alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a class=\"aside-list__blk align text-gray\"\nhref=\"/home/forum/"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"id") : depth0), depth0))
    + "/\"\ndata-link-name=\"forum_name\"\ndata-forum-pk=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"pk") : depth0), depth0))
    + "\">\n";
},"5":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = container.invokePartial(lookupProperty(partials,"channelAvatarWithDefault"),depth0,{"name":"channelAvatarWithDefault","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "");
},"7":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = container.invokePartial(lookupProperty(partials,"forumAvatar"),depth0,{"name":"forumAvatar","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "");
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"channelInfo") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"data":data,"loc":{"start":{"line":1,"column":0},"end":{"line":11,"column":7}}})) != null ? stack1 : "")
    + "\n<div class=\"align__item avatar\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"channel") : depth0),{"name":"if","hash":{},"fn":container.program(5, data, 0),"inverse":container.program(7, data, 0),"data":data,"loc":{"start":{"line":14,"column":0},"end":{"line":18,"column":7}}})) != null ? stack1 : "")
    + "</div>\n<div class=\"align__item aside-list__name\">\n<strong>"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"forumName"),depth0,{"name":"forumName","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</strong>\n</div>\n</a>\n";
},"usePartial":true,"useData":true})

});
define('home/views/FollowingCardView',[
    'backbone-marionette',

    'home/mixins/withChannelAvatar',
    'home/templates/followingCard',
], function (
    Marionette,

    withChannelAvatar,
    followingCardTemplate
) {
    'use strict';

    var FollowingCardView = Marionette.ItemView.extend({
        template: followingCardTemplate,
        className: 'aside-list__item',
    });

    withChannelAvatar.call(FollowingCardView.prototype, function () {
        return this.model.channel;
    });

    return FollowingCardView;
});

define('home/templates/homepageFollowingModule',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"aside__subheadings\">\n<h2 class=\"text-subheading\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Following",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":2,"column":28},"end":{"line":2,"column":51}}}))
    + "</h2>\n</div>\n<div class=\"aside__wrap\">\n<div data-role=\"forums\"></div>\n<a href=\"/home/channels/\" class=\"nav-lnk -color-muted\">\n<div class=\"nav-lnk__blk\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"See All Following",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":7,"column":26},"end":{"line":7,"column":57}}}))
    + "</div>\n<div class=\"nav-lnk__pointer\">\n<span class=\"icon icon-right-bracket\"></span>\n</div>\n</a>\n</div>\n";
},"useData":true})

});
define('home/views/HomepageFollowingModuleView',[
    'backbone-marionette',

    'home/models/Session',
    'home/views/FollowingCardView',
    'home/templates/homepageFollowingModule',
], function (
    Marionette,

    Session,
    FollowingCardView,
    homepageFollowingModuleTemplate
) {
    'use strict';

    var HomepageFollowingModuleView = Marionette.CompositeView.extend({
        template: homepageFollowingModuleTemplate,
        templateHelpers: function () {
            return {
                sessionUsername: Session.fromCookie().username,
            };
        },

        itemViewContainer: '[data-role=forums]',
        itemView: FollowingCardView,

        addItemView: function (item, ItemView, index) {
            if (index > 4)
                return;

            return Marionette.CompositeView.prototype.addItemView.call(this, item, ItemView, index);
        },

        initialize: function () {
            this.session = Session.get();
        },
    });

    return HomepageFollowingModuleView;
});

define('home/templates/homepageFeedEmpty',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var alias1=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card--empty text-center\">\n<h2>"
    + alias1(container.lambda((depth0 != null ? lookupProperty(depth0,"feedMessage") : depth0), depth0))
    + "</h2>\n<p class=\"text-gray spacing-top-small\">"
    + alias1(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Until you do that, here are the latest %(number)s trending discussions on %(disqus)s.",{"name":"gettext","hash":{"disqus":"Disqus","number":(depth0 != null ? lookupProperty(depth0,"numItemsShown") : depth0)},"data":data,"loc":{"start":{"line":4,"column":39},"end":{"line":4,"column":175}}}))
    + "\n</div>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"isLoggedIn") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":1,"column":0},"end":{"line":6,"column":7}}})) != null ? stack1 : "")
    + "<div data-role=\"items\"></div>\n<div class=\"spacing-bottom spacing-top\">\n<a href=\"/home/explore/\" class=\"button button-fill--brand button-padding-taller button-wide text-medium\">\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(alias1,"Explore channels to follow",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":10,"column":0},"end":{"line":10,"column":40}}}))
    + "\n</a>\n</div>\n";
},"useData":true})

});
define('home/templates/homepageNoChannelsFeedEmpty',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var alias1=container.escapeExpression, alias2=container.lambda, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card--empty text-center\">\n<div class=\"empty-message\">\n\n<img class=\"empty-message__img\" src=\""
    + alias1(lookupProperty(helpers,"urlfor").call(depth0 != null ? depth0 : (container.nullContext || {}),"cdn",{"name":"urlfor","hash":{},"data":data,"loc":{"start":{"line":5,"column":37},"end":{"line":5,"column":53}}}))
    + "/img/empty-states/"
    + alias1(alias2((depth0 != null ? lookupProperty(depth0,"emptyImage") : depth0), depth0))
    + "\"/>\n\n<div class=\"empty-message__content\">\n<h2 class=\"text-larger\">\n"
    + alias1(alias2((depth0 != null ? lookupProperty(depth0,"mainText") : depth0), depth0))
    + "\n</h2>\n<p class=\"text-gray text-medium\">\n"
    + alias1(alias2((depth0 != null ? lookupProperty(depth0,"subText") : depth0), depth0))
    + "\n</p>\n<a href=\""
    + alias1(alias2((depth0 != null ? lookupProperty(depth0,"followButtonUrl") : depth0), depth0))
    + "\" class=\"button button-outline button-padding-wider text-large\">\n"
    + alias1(alias2((depth0 != null ? lookupProperty(depth0,"followText") : depth0), depth0))
    + "\n</a>\n</div>\n</div>\n</div>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"isLoggedIn") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":1,"column":0},"end":{"line":20,"column":7}}})) != null ? stack1 : "");
},"useData":true})

});
define('home/views/HomepageFeedEmptyView',[
    'underscore',
    'backbone-marionette',

    'home/mixins/withSubviews',
    'home/models/Session',
    'home/views/ChannelCardCollectionView',
    'home/templates/homepageFeedEmpty',
    'home/templates/homepageNoChannelsFeedEmpty',
    'home/templates/spinner',
], function (
    _,
    Marionette,

    withSubviews,
    Session,
    ChannelCardCollectionView,
    homepageFeedEmptyTemplate,
    homepageNoChannelsFeedEmptyTemplate,
    spinnerTemplate
) {
    'use strict';

    /**
     * An empty state view for homepage feeds that shows a message about the purpose
     * of the current feed and a feed of the top activities from the spotlight channel.
     *
     * Expects to be backed by a feed model and a collection.
     * Expects feed specific message assigned to this.feedMessage
     */
    var HomepageFeedEmptyView = Marionette.ItemView.extend({
        initialize: function (options) {
            this.session = Session.get();
            this.maxItemsText = options.maxItemsText;
            this.onboardingWithoutChannels = options.onboardingWithoutChannels;
            this.model.ensureFetched().then(this.render);
        },

        getTemplate: function () {
            var emptyTemplate = this.onboardingWithoutChannels ?
                homepageNoChannelsFeedEmptyTemplate :
                homepageFeedEmptyTemplate;
            return this.model.get('fetched') ? emptyTemplate : spinnerTemplate;
        },

        templateHelpers: function () {
            return _.defaults(this.noChannelEmptyViewTexts, {
                numItemsShown: this.maxItemsText,
                feedMessage: this.feedMessage,
                isLoggedIn: this.session.isLoggedIn(),
            });
        },

        regions: {
            feedRegion: '[data-role=items]',
        },

        onRender: function () {
            this.activateRegion(this.feedRegion, this.createFeedView);
        },

        createFeedView: function () {
            return new ChannelCardCollectionView({
                model: this.model,
                collection: this.collection,
                emptyView: null,
            });
        },
    });

    withSubviews.call(HomepageFeedEmptyView.prototype);

    return HomepageFeedEmptyView;
});

define('home/views/HomepageRecommendedFeedEmptyView',[
    'core/strings',

    'home/views/HomepageFeedEmptyView',
], function (
    strings,

    HomepageFeedEmptyView
) {
    'use strict';

    var gettext = strings.get;

    var HomepageRecommendedFeedEmptyView = HomepageFeedEmptyView.extend({
        feedMessage: gettext('Follow channels and people to see their recommended discussions here.'),
        noChannelEmptyViewTexts: {
            mainText: 'See recent discussions by following communities.',
            subText: 'Following communities helps you keep up with what their latest discussions.',
            followText: 'Find interesting communities to follow »',
            followButtonUrl: 'https://help.disqus.com/community-tips/building-identity-and-audience/site-profiles',
            emptyImage: 'following-communities.png',
        },
    });

    return HomepageRecommendedFeedEmptyView;
});

define('home/views/HomepageCommentsFeedEmptyView',[
    'core/strings',

    'home/views/HomepageFeedEmptyView',
], function (
    strings,

    HomepageFeedEmptyView
) {
    'use strict';

    var gettext = strings.get;

    var HomepageCommentsFeedEmptyView = HomepageFeedEmptyView.extend({
        feedMessage: gettext('Follow people to see their latest comments here.'),
        noChannelEmptyViewTexts: {
            mainText: 'See recent discussions by following people.',
            subText: 'Following people helps you keep up with what their latest discussions.',
            followText: 'Find interesting people to follow »',
            followButtonUrl: 'https://help.disqus.com/commenting/following-other-users',
            emptyImage: 'following-people.png',
        },
    });

    return HomepageCommentsFeedEmptyView;
});

define('home/views/HomepageDiscussionsFeedEmptyView',[
    'core/strings',

    'home/views/HomepageFeedEmptyView',
], function (
    strings,

    HomepageFeedEmptyView
) {
    'use strict';

    var gettext = strings.get;

    var HomepageDiscussionsFeedEmptyView = HomepageFeedEmptyView.extend({
        feedMessage: gettext('Follow channels and people to see their latest discussions here.'),
        noChannelEmptyViewTexts: {
            mainText: 'See recent discussions by following communities and people.',
            subText: 'Following communities and people helps you keep up with what their latest discussions.',
            followText: 'Find interesting communities to follow »',
            followButtonUrl: 'https://help.disqus.com/community-tips/building-identity-and-audience/site-profiles',
            emptyImage: 'following-communities.png',
        },
    });

    return HomepageDiscussionsFeedEmptyView;
});

define('home/templates/motdAlert',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"persistentAlert") : depth0),{"name":"if","hash":{},"fn":container.program(2, data, 0),"inverse":container.program(4, data, 0),"data":data,"loc":{"start":{"line":2,"column":0},"end":{"line":30,"column":7}}})) != null ? stack1 : "");
},"2":function(container,depth0,helpers,partials,data) {
    var alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"alert--success\">\n<div class=\"padding-default\">\n<div class=\"text-center spacing-narrow\">\n<span class=\"icon icon-megaphone icon__position spacing-right-small\"></span>\n<strong class=\"spacing-right\">"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"motdTitle") : depth0), depth0))
    + "</strong>\n<a\nhref=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"motdLink") : depth0), depth0))
    + "\"\nclass=\"button button-inverted -hover-opaque text-medium\"\ntarget=\"_blank\"\nrel=\"noopener noreferrer\"\n>Learn more &raquo;</a>\n</div>\n</div>\n</div>\n";
},"4":function(container,depth0,helpers,partials,data) {
    var alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"alert--brand\">\n<div class=\"padding-default\">\n<div class=\"text-center spacing-narrow\">\n<span class=\"icon icon-megaphone icon__position spacing-right-small\"></span>\n<strong class=\"spacing-right\">"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"motdTitle") : depth0), depth0))
    + "</strong>\n<a href=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"motdLink") : depth0), depth0))
    + "\" class=\"button button-inverted -hover-opaque text-medium\">Learn more &raquo;</a>\n<button class=\"link-inverted spacing-left\" data-action=\"close-alert\">\n<span class=\"icon-cancel\"></span>\n</button>\n</div>\n</div>\n</div>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"unless").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"hideAlert") : depth0),{"name":"unless","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":1,"column":0},"end":{"line":31,"column":11}}})) != null ? stack1 : "");
},"useData":true})

});
define('home/views/MotdAlertView',[
    'backbone-marionette',

    'core/utils/storage',
    'remote/config',

    'home/templates/motdAlert',
], function (
    Marionette,

    storage,
    remoteConfig,

    motdAlertTemplate
) {
    'use strict';

    var MOTD_KEY = 'motd';
    var lounge = remoteConfig.lounge || {};
    var motdTitle = lounge.motd_home_title;
    var motdUrl = lounge.motd_home_url;
    var motdObj = storage.get(MOTD_KEY) || {};

    var MotdAlertView = Marionette.ItemView.extend({
        template: motdAlertTemplate,
        className: 'motd-alert__wrapper',

        templateHelpers: function () {
            var dismissed = motdObj[motdUrl];

            return {
                motdTitle: motdTitle,
                motdLink: motdUrl,
                hideAlert: dismissed && !this.persistent ? dismissed : false,
                persistentAlert: this.persistent,
            };
        },

        events: {
            'click [data-action=close-alert]': 'closeAlert',
        },

        initialize: function (options) {
            this.persistent = options && options.persistent;
        },

        closeAlert: function () {
            motdObj[motdUrl] = true;
            storage.set(MOTD_KEY, motdObj);
            this.$el.remove();
        },
    });

    return MotdAlertView;
});

define('core/mixins/withEmailVerifyLink',[
    'jquery',
    'underscore',

    'core/config',
    'core/utils',
], function (
    $,
    _,

    config,
    coreUtils
) {
    'use strict';

    var handler = coreUtils.preventDefaultHandler;

    var EmailVerifyLinkMixin = {
        events: {
            'click [data-action=verify-email]': 'showVerifyEmailPopup',
        },

        showVerifyEmailPopup: handler(function (evt) {
            var forumId = $(evt.target).attr('data-forum');
            var url = config.urls.verifyEmail;

            if (forumId)
                url = url + '?f=' + forumId;

            return coreUtils.openWindow(url, '_blank', {
                width: 460,
                height: 355,
            });
        }),
    };

    return function withEmailVerifyLink() {
        this.events = _.defaults({}, this.events, EmailVerifyLinkMixin.events);

        _.extend(this, _.pick(EmailVerifyLinkMixin, 'showVerifyEmailPopup'));

    };
});

define('home/templates/emailVerificationAlert',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"alert alert--warning text-medium\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"The email address for your account %(email)s still needs to be verified.",{"name":"gettext","hash":{"email":lookupProperty(helpers,"tag").call(alias1,"strong",{"name":"tag","hash":{"text":((stack1 = (depth0 != null ? lookupProperty(depth0,"user") : depth0)) != null ? lookupProperty(stack1,"email") : stack1)},"data":data,"loc":{"start":{"line":3,"column":93},"end":{"line":3,"column":125}}})},"data":data,"loc":{"start":{"line":3,"column":0},"end":{"line":3,"column":128}}}))
    + "\n<a href=\"/verify\" data-action=\"verify-email\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Resend confirmation email »",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":4,"column":45},"end":{"line":4,"column":86}}}))
    + "</a>\n</div>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"shouldShowEmailVerificationAlert") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":1,"column":0},"end":{"line":6,"column":7}}})) != null ? stack1 : "");
},"useData":true})

});
define('home/views/EmailVerificationAlertView',[
    'underscore',
    'backbone-marionette',

    'core/mixins/withEmailVerifyLink',

    'home/models/Session',

    'home/templates/emailVerificationAlert',
], function (
    _,
    Marionette,

    withEmailVerifyLink,

    Session,

    emailVerificationAlertTemplate
) {
    'use strict';

    var EmailVerificationAlertView = Marionette.ItemView.extend({
        template: emailVerificationAlertTemplate,

        templateHelpers: function () {
            return {
                user: this.session.user.toJSON(),
                shouldShowEmailVerificationAlert: this.shouldShowEmailVerificationAlert(),
            };
        },

        initialize: function () {
            this.session = Session.get();
            this.session.loadPromise().then(_.bind(this.render, this));
        },

        /**
         * Determines to whom to show the email verification alert.
         */
        shouldShowEmailVerificationAlert: function () {
            return this.session.isLoggedIn() &&
              !this.session.user.get('isVerified') &&
              this.session.user.get('homeFeedOnboardingComplete');
        },

    });

    withEmailVerifyLink.call(EmailVerificationAlertView.prototype);

    return EmailVerificationAlertView;
});

define('home/mixins/withEmailVerificationAlert',[
    'underscore',

    'core/advice',

    'home/views/EmailVerificationAlertView',
], function (
    _,

    advice,

    EmailVerificationAlertView
) {
    'use strict';

    return function withEmailVerificationAlert() {
        advice.withAdvice.call(this);

        this.before('onDomRefresh', function () {
            // Support both Marionette Layouts and Views using withSubviews
            if (this.activateRegion) {
                this.activateRegion(this.emailVerificationAlertRegion, function () {
                    return new EmailVerificationAlertView();
                });
            } else {
                this.emailVerificationAlertRegion.show(new EmailVerificationAlertView());
            }
        });

        this.regions = _.defaults({
            emailVerificationAlertRegion: '[data-role=email-verification-alert]',
        }, this.regions);
    };
});

define('home/models/common/BaseSettings',[
    'underscore',
    'backbone',

    'home/models/Session',
], function (
    _,
    Backbone,

    Session
) {
    'use strict';

    var BaseSettings = Backbone.Model.extend({
        shouldFetch: function () {
            return !this.fetched && !this.fetching;
        },

        ensureFetched: function () {
            if (!this.shouldFetch())
                return;

            var self = this;
            self.fetching = true;
            self.fetch({
                success: function () {
                    self.fetched = true;
                    self.fetching = false;
                },
                error: function () {
                    self.fetched = false;
                    self.fetching = false;
                },
            });
        },

        toFormData: function (attrs) {
            attrs = attrs || this.toJSON();
            return _.reduce(attrs, function (formData, value, key) {
                formData.append(key, _.isString(value) ? value.trim() : value);
                return formData;
            }, new window.FormData());
        },

        // set to true if form has a file upload input field
        useMultiPartForm: false,

        save: function (attrs, options) {
            attrs = attrs || this.toJSON();
            options = options || {};
            if (this.useMultiPartForm) {
                options.data = this.toFormData(attrs);
                options.contentType = false;
            }
            options.beforeSend = this.setCSRFHeader;
            return Backbone.Model.prototype.save.call(this, attrs, options);
        },

        setCSRFHeader: function (xhr, settings) {
            var csrftoken = Session.get().getCsrfToken();
            if (!/^(GET|HEAD|OPTIONS|TRACE)$/.test(settings.type))
                xhr.setRequestHeader('X-CSRFToken', csrftoken);
        },

        destroy: function (options) {
            options = options || {};
            options.beforeSend = this.setCSRFHeader;
            return Backbone.Model.prototype.destroy.call(this, options);
        },
    });

    return BaseSettings;
});


define('home/models/SettingsSocialAccount',[
    'core/config',

    'home/models/common/BaseSettings',
], function (
    config,

    BaseSettings
) {
    'use strict';

    var SettingsSocialAccount = BaseSettings.extend({
        url: function () {
            return config.urls.oauthStatus(this.id);
        },

        destroyUrl: function () {
            return config.urls.oauthDestroy(this.id);
        },

        destroy: function (options) {
            options = options || {};
            options.method = 'POST';
            options.url = this.destroyUrl();
            return BaseSettings.prototype.destroy.call(this, options);
        },

        toJSON: function () {
            return {
                'display_name': this.get('display_name'),
                'url': this.get('url'),
            };
        },
    });

    return SettingsSocialAccount;
});


define('home/collections/SettingsSocialAccountCollection',[
    'backbone',
    'underscore',

    'home/models/SettingsSocialAccount',
], function (
    Backbone,
    _,

    SettingsSocialAccount
) {
    'use strict';

    var SettingsSocialAccountCollection = Backbone.Collection.extend({
        model: SettingsSocialAccount,

        toJSON: function () {
            return _.reduce(this.models, function (data, model) {
                data[model.id] = model.toJSON();
                return data;
            }, {});
        },
    });

    return SettingsSocialAccountCollection;
});


define('home/models/SettingsAccount',[
    'underscore',

    'core/config',

    'home/collections/SettingsSocialAccountCollection',
    'home/models/common/BaseSettings',
    'core/UniqueModel',
], function (
    _,

    config,

    SettingsSocialAccountCollection,
    BaseSettings,
    UniqueModel
) {
    'use strict';

    var SettingsAccount = BaseSettings.extend({
        url: config.urls.apiSettings + 'account/',

        initialize: function () {
            this.socialAccounts = new SettingsSocialAccountCollection();
        },

        parse: function (response) {
            var socialAccountModels = _.map(response.social_accounts, function (socialAccount, accountType) {
                socialAccount.id = accountType;
                return socialAccount;
            });

            // Add all models with a reset so that only one 'reset' event is triggered on the collection
            this.socialAccounts.reset(socialAccountModels);

            delete response.social_accounts;
            return BaseSettings.prototype.parse.call(this, response);
        },

        toJSON: function () {
            return {
                'username': this.get('username'),
                'email': this.get('email'),
                'password': this.get('password'),
                'old_password': this.get('old_password'),
                'email_verified': this.get('email_verified'),
            };
        },
    });

    UniqueModel.addType('SettingsAccount', SettingsAccount);

    return SettingsAccount;
});

define('home/mixins/asModal',[
    'underscore',

    'home/utils/confirmModal',
], function (
    _,

    confirmModal
) {
    'use strict';

    var asModalView = {

        initialize: function (_initialize, options) {
            _initialize.apply(this, _.rest(arguments));
            this.modal = this.getModal(options);
        },

        onRender: function (_onRender) {
            if (_onRender)
                _onRender.apply(this, _.rest(arguments));
            this.modal.find('[data-role=content]').append(this.$el);
        },

        showModal: function (modalOptions) {
            if (modalOptions)
                this.modal.modal(modalOptions);

            this.modal.modal('show');
        },

        closeModal: function () {
            this.remove();
            this.modal.modal('hide');
        },
    };

    var asModal = function (modalOptions) {
        this.initialize = _.wrap(this.initialize, asModalView.initialize);
        this.onRender = _.wrap(this.onRender, asModalView.onRender);
        this.getModal = confirmModal.getModal;
        this.showModal = _.partial(asModalView.showModal, modalOptions);
        this.closeModal = asModalView.closeModal;
    };

    return asModal;
});


define('home/templates/emailConfirmedModalContent',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, alias3=container.lambda, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<form>\n<div class=\"form__header\">\n<h1 class=\"form-heading\">\n<span class=\"icon-checkmark text-success icon__position spacing-right-small\"></span>\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Email Verified",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":5,"column":0},"end":{"line":5,"column":28}}}))
    + "\n</h1>\n<p class=\"form-description text-gray text-medium\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Now choose a unique username before someone else grabs it!",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":7,"column":50},"end":{"line":7,"column":122}}}))
    + "</p>\n</div>\n<div class=\"form__content\">\n<div class=\"fieldset\" role=\"group\">\n<label for=\"settings-username\" class=\"fieldset__label padding-left-right align__item text-gray\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Username",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":11,"column":96},"end":{"line":11,"column":118}}}))
    + "</label>\n<div class=\"fieldset__block align__item\">\n<div class=\"fieldset__block--text\">\n"
    + alias2(alias3((depth0 != null ? lookupProperty(depth0,"username") : depth0), depth0))
    + "\n</div>\n<p class=\"fieldset__description text-gray text-small\">\nhttp://disqus.com/by/<strong data-role=\"username-placeholder\">"
    + alias2(alias3((depth0 != null ? lookupProperty(depth0,"username") : depth0), depth0))
    + "</strong>\n<br/>\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"This will be used as your profile address and for logging in.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":19,"column":0},"end":{"line":19,"column":75}}}))
    + "\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"You can change your username by going to %(profileSettings)s",{"name":"gettext","hash":{"profileSettings":lookupProperty(helpers,"tag").call(alias1,"a",{"name":"tag","hash":{"text":lookupProperty(helpers,"gettext").call(alias1,"Profile settings",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":21,"column":108},"end":{"line":21,"column":136}}}),"data-action":"dismiss-form","href":"https://disqus.com/home/settings/profile/"},"data":data,"loc":{"start":{"line":21,"column":18},"end":{"line":21,"column":137}}})},"data":data,"loc":{"start":{"line":20,"column":0},"end":{"line":22,"column":2}}}))
    + ".\n</p>\n</div>\n</div>\n</div>\n<div class=\"form__footer\">\n<div class=\"fieldset\" role=\"group\">\n<div class=\"fieldset__label\" data-role=\"save-status\"><div class=\"spinner-small\"></div><div class=\"icon-checkmark\"></div></div>\n<div class=\"fieldset__block\"><button class=\"button button-fill--brand button-padding-wider text-medium\" data-role=\"save-btn\" data-tag=\"dismiss\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Done",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":30,"column":144},"end":{"line":30,"column":162}}}))
    + "</button></div>\n</div>\n</div>\n</form>\n";
},"useData":true})

});
define('home/templates/settingsAccountForm',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    return "is-error";
},"3":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"each").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = (depth0 != null ? lookupProperty(depth0,"errors") : depth0)) != null ? lookupProperty(stack1,"username") : stack1),{"name":"each","hash":{},"fn":container.program(4, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":19,"column":0},"end":{"line":21,"column":9}}})) != null ? stack1 : "");
},"4":function(container,depth0,helpers,partials,data) {
    return "<p class=\"fieldset__description fieldset__description--error text-small\">"
    + container.escapeExpression(container.lambda(depth0, depth0))
    + "</p>\n";
},"6":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"each").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = (depth0 != null ? lookupProperty(depth0,"errors") : depth0)) != null ? lookupProperty(stack1,"email") : stack1),{"name":"each","hash":{},"fn":container.program(4, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":37,"column":0},"end":{"line":39,"column":9}}})) != null ? stack1 : "");
},"8":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<p class=\"fieldset__description fieldset__description--pending text-small\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Your email address hasn't been verified yet. Please request a new verification email, if you haven't yet received one.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":43,"column":0},"end":{"line":43,"column":133}}}))
    + "\n<a href=\"/verify\" data-action=\"verify-email\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Request »",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":44,"column":45},"end":{"line":44,"column":68}}}))
    + "</a>\n</p>\n";
},"10":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<p class=\"fieldset__description text-gray text-small\">\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Changing your email requires you to verify it. Just click on the big button in the email we send to the new email address.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":48,"column":0},"end":{"line":48,"column":136}}}))
    + "\n</p>\n";
},"12":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"each").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = (depth0 != null ? lookupProperty(depth0,"errors") : depth0)) != null ? lookupProperty(stack1,"__all__") : stack1),{"name":"each","hash":{},"fn":container.program(4, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":66,"column":0},"end":{"line":68,"column":9}}})) != null ? stack1 : "");
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, alias3=container.lambda, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<form class=\"form\">\n<div class=\"form__header--mobile visible-md\">\n<a href=\"/home/settings/\" class=\"form__header--mobile-back\"><span class=\"icon-left-bracket\"></span></a>\n<h2>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Account",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":4,"column":4},"end":{"line":4,"column":25}}}))
    + "</h2>\n</div>\n<div class=\"form__header\">\n<h1 class=\"form-heading hidden-md\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Account",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":7,"column":35},"end":{"line":7,"column":56}}}))
    + "</h1>\n<p class=\"form-description text-gray text-medium\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Change your basic account information.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":8,"column":50},"end":{"line":8,"column":102}}}))
    + "</p>\n</div>\n<div class=\"form__content\">\n<div class=\"fieldset\" role=\"group\">\n<label for=\"settings-username\" class=\"fieldset__label align__item text-gray\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Username",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":13,"column":77},"end":{"line":13,"column":99}}}))
    + "</label>\n<div class=\"fieldset__block align__item "
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"errors") : depth0)) != null ? lookupProperty(stack1,"username") : stack1),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":14,"column":40},"end":{"line":14,"column":78}}})) != null ? stack1 : "")
    + "\">\n<div class=\"fieldset__block--text\">\n<input type=\"text\" id=\"settings-username\" class=\"input--textbox\" name=\"username\" value=\""
    + alias2(alias3((depth0 != null ? lookupProperty(depth0,"username") : depth0), depth0))
    + "\">\n</div>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"errors") : depth0)) != null ? lookupProperty(stack1,"username") : stack1),{"name":"if","hash":{},"fn":container.program(3, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":18,"column":0},"end":{"line":22,"column":7}}})) != null ? stack1 : "")
    + "<p class=\"fieldset__description text-gray text-small\">\nhttp://disqus.com/by/<strong data-role=\"username-placeholder\">"
    + alias2(alias3((depth0 != null ? lookupProperty(depth0,"username") : depth0), depth0))
    + "</strong>\n<br/>\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"This will be used as your profile address and for logging in.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":26,"column":0},"end":{"line":26,"column":75}}}))
    + "\n</p>\n</div>\n</div>\n<div class=\"fieldset\" role=\"group\">\n<label for=\"settings-email\" class=\"fieldset__label align__item text-gray\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Email",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":31,"column":74},"end":{"line":31,"column":93}}}))
    + "</label>\n<div class=\"fieldset__block align__item "
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"errors") : depth0)) != null ? lookupProperty(stack1,"email") : stack1),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":32,"column":40},"end":{"line":32,"column":75}}})) != null ? stack1 : "")
    + "\">\n<div class=\"fieldset__block--text\">\n<input type=\"text\" id=\"settings-email\" class=\"input--textbox\" name=\"email\" value=\""
    + alias2(alias3((depth0 != null ? lookupProperty(depth0,"email") : depth0), depth0))
    + "\">\n</div>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"errors") : depth0)) != null ? lookupProperty(stack1,"email") : stack1),{"name":"if","hash":{},"fn":container.program(6, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":36,"column":0},"end":{"line":40,"column":7}}})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"email_verified") : depth0),{"name":"unless","hash":{},"fn":container.program(8, data, 0),"inverse":container.program(10, data, 0),"data":data,"loc":{"start":{"line":41,"column":0},"end":{"line":50,"column":11}}})) != null ? stack1 : "")
    + "</div>\n</div>\n<div class=\"fieldset\" role=\"group\">\n<label for=\"settings-password\" class=\"fieldset__label align__item text-gray\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Password",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":54,"column":77},"end":{"line":54,"column":99}}}))
    + "</label>\n<div class=\"fieldset__block align__item\">\n<div class=\"fieldset__block--text\">\n<input type=\"password\" placeholder=\""
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Current password",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":57,"column":36},"end":{"line":57,"column":66}}}))
    + "\" id=\"settings-password\" name=\"old_password\" class=\"input--textbox\">\n</div>\n<p class=\"fieldset__description text-gray text-small\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Forgot your password?",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":60,"column":0},"end":{"line":60,"column":35}}}))
    + " <a href=\"/forgot\" target=\"_blank\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Request a password recovery email.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":60,"column":70},"end":{"line":60,"column":118}}}))
    + "</a>\n</p>\n<div class=\"fieldset__block--text\">\n<input type=\"password\" placeholder=\""
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"New password",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":63,"column":36},"end":{"line":63,"column":62}}}))
    + "\" name=\"password\" class=\"input--textbox\">\n</div>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"errors") : depth0)) != null ? lookupProperty(stack1,"__all__") : stack1),{"name":"if","hash":{},"fn":container.program(12, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":65,"column":0},"end":{"line":69,"column":7}}})) != null ? stack1 : "")
    + "</div>\n</div>\n</div>\n<div class=\"form__footer\">\n<div class=\"fieldset\" role=\"group\">\n<div class=\"fieldset__label\" data-role=\"save-status\"><div class=\"spinner-small\"></div><div class=\"icon-checkmark\"></div></div>\n<div class=\"fieldset__block\"><button class=\"button button-fill--brand button-padding-wider text-medium\" data-role=\"save-btn\" disabled>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Save",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":76,"column":134},"end":{"line":76,"column":152}}}))
    + "</button></div>\n</div>\n</div>\n</form>\n";
},"useData":true})

});
define('home/mixins/withFetchingView',[
    'underscore',

    'home/views/FetchingView',
], function (
    _,

    FetchingView
) {
    'use strict';

    var withFetchingView = function () {
        this.render = _.wrap(this.render, function (_render) {
            if (this.isDoneFetching())
                return _render.apply(this, _.rest(arguments));

            var fetchingView = new FetchingView();
            this.$el.html(fetchingView.render().el);
            return this;
        });
    };

    return withFetchingView;
});



define('home/views/common/BaseSettingsView',[
    'underscore',
    'backbone-marionette',

    'core/utils/html/nodeTypes',

    'home/mixins/withFetchingView',
    'home/models/Session',
], function (
    _,
    Marionette,

    nodeTypes,

    withFetchingView,
    Session
) {
    'use strict';

    var BaseSettingsView = Marionette.ItemView.extend({
        events: {
            'submit form': 'submitHandler',
            'change input[type=checkbox], input[type=radio], select': 'changeHandler',
            'keyup input[type=text], input[type=password]': 'changeHandler',
        },

        initialize: function () {
            this.model.ensureFetched();
            this.session = Session.get();
            this.listenTo(this.model, 'invalid sync', this.render);
            this.listenTo(this.model, 'error', this.handleValidationError);
        },

        onRender: function () {
            this.$form = this.$('form');
            this.$saveStatus = this.$('[data-role=save-status]');
            this.saveBtn = this.$('[data-role=save-btn]')[0];

            // get form data and set it on the model on render so
            // we can detect changes when a user is updating the form.
            this.model.set(this.getFormData());
        },

        handleValidationError: function (model, response) {
            model.validationError = response.responseJSON;
            this.render();
        },

        isDoneFetching: function () {
            return this.model.fetched;
        },

        serializeData: function () {
            var data = Marionette.ItemView.prototype.serializeData.call(this, arguments);
            data.errors = this.model.validationError || {};
            return data;
        },

        changeHandler: _.debounce(function () {
            this.updateButtonState(this.model.changedAttributes(this.getFormData()));
        }, 100),

        updateButtonState: function (isEnabled) {
            this.saveBtn.disabled = !isEnabled;
        },

        saveFormData: function () {
            // also used in dismiss handler in withEmailConfirmedModal
            var formData = this.getFormData();
            this.model.set(formData);
        },

        submitHandler: function (evt) {
            evt.preventDefault();

            this.$saveStatus.addClass('is-saving');
            this.clearErrors();
            this.updateStatus('is-saving');

            this.saveFormData(evt);

            if (evt.currentTarget && evt.currentTarget[0] && nodeTypes.isButton(evt.currentTarget[0]) && evt.currentTarget[0].getAttribute('data-tag') === 'dismiss')
                return this.updateStatus('is-saved');

            var options = {};
            options.success = _.bind(function () {
                this.session.user.set('username', this.model.get('username'));
            }, this);

            this.model.save(null, options)
                      .done(_.bind(this.updateStatus, this, 'is-saved'));
        },

        updateStatus: function (status) {
            this.$saveStatus.removeClass('is-saving is-saved')
                            .addClass(status);
        },

        getFormData: function () {
            return _.reduce(this.$form.serializeArray(), function (data, elem) {
                data[elem.name] = elem.value;
                return data;
            }, {});
        },

        clearErrors: function () {
            this.$el.find('.is-error').removeClass('is-error');
            this.$el.find('.fieldset__description--error').hide();
            this.model.validationError = null;
        },
    });

    withFetchingView.call(BaseSettingsView.prototype);

    return BaseSettingsView;
});

define('home/views/SettingsAccountFormView',[
    'underscore',

    'core/mixins/withEmailVerifyLink',

    'home/templates/settingsAccountForm',
    'home/views/common/BaseSettingsView',
], function (
    _,

    withEmailVerifyLink,

    settingsAccountFormTemplate,
    BaseSettingsView
) {
    'use strict';

    var SettingsAccountFormView = BaseSettingsView.extend({
        template: settingsAccountFormTemplate,

        events: _.defaults({
            'keyup input[name=username]': 'handleKeyup',
        }, BaseSettingsView.prototype.events),

        onRender: function () {
            this.$usernamePlaceholder = this.$('[data-role=username-placeholder]');
            BaseSettingsView.prototype.onRender.apply(this, arguments);
        },

        handleKeyup: _.debounce(function (ev) {
            this.$usernamePlaceholder.text(ev.currentTarget.value || this.model.get('username'));
        }, 300),

    });

    withEmailVerifyLink.call(SettingsAccountFormView.prototype);

    return SettingsAccountFormView;
});

define('home/views/EmailConfirmedModalContentView',[
    'underscore',

    'core/utils',

    'home/mixins/asModal',

    'home/templates/emailConfirmedModalContent',

    'home/views/SettingsAccountFormView',
], function (
    _,

    coreUtils,

    asModal,

    emailConfirmedModalContentTemplate,

    SettingsAccountFormView
) {
    'use strict';

    var EmailConfirmedModalContentView = SettingsAccountFormView.extend({
        template: emailConfirmedModalContentTemplate,

        events: {
            'click [data-action=dismiss-form]': 'dismissHandler',
        },

        dismissHandler: function () {
            this.saveFormData();
            this.closeModal();
        },

        updateStatus: function (status) {
            SettingsAccountFormView.prototype.updateStatus.apply(this, arguments);

            // close modal on successful save
            if (status === 'is-saved') {
                var animationEndEvent = coreUtils.animationEndEvent;
                var closeModal = _.bind(this.closeModal, this);

                if (animationEndEvent)
                    this.$saveStatus.one(animationEndEvent, '.icon-checkmark', closeModal);
                else
                    _.delay(closeModal, 1500);
            }
        },

        getFormData: function () {
            var formData = SettingsAccountFormView.prototype.getFormData.call(this);

            // merge in password and old_password with blank values as the settings api
            // endpoint requires it
            return _.defaults(formData, {
                password: '',
                old_password: '',
            });
        },
    });

    asModal.call(EmailConfirmedModalContentView.prototype);

    return EmailConfirmedModalContentView;
});

define('home/mixins/withEmailConfirmedModal',[
    'underscore',

    'core/advice',
    'core/UniqueModel',
    'core/utils/url/parseQueryString',

    'home/models/Session',
    'home/models/SettingsAccount',

    'home/views/EmailConfirmedModalContentView',
], function (
    _,

    advice,
    UniqueModel,
    parseQueryString,

    Session,
    SettingsAccount,

    EmailConfirmedModalContentView
) {
    'use strict';

    var EmailVerifiedModal = {

        showEmailVerifiedModal: function () {
            if (!this.shouldShowEmailVerifiedModal())
                return;

            var session = Session.get();
            session.loadPromise().then(_.bind(function () {
                if (session.isLoggedOut())
                    return;

                var settingsAccountModel = new UniqueModel(
                    SettingsAccount,
                    { id: session.user.id }
                );
                var modal = new EmailConfirmedModalContentView({
                    model: settingsAccountModel,
                });
                modal.showModal();
            }, this));
        },

        /**
         * Users are redirected to /home/channels/?email_verified=1 after verifying their email.
         * This method returns true if location.search contains email_verified=1.
         */
        shouldShowEmailVerifiedModal: function () {
            // TODO: use URI lib when we have it
            return Boolean(parseQueryString().email_verified);
        },

    };

    return function withEmailConfirmedModal() {
        advice.withAdvice.call(this);

        this.showEmailVerifiedModal = EmailVerifiedModal.showEmailVerifiedModal;
        this.shouldShowEmailVerifiedModal = EmailVerifiedModal.shouldShowEmailVerifiedModal;

        this.after('initialize', function () {
            this.showEmailVerifiedModal();
        });
    };
});


define('home/templates/homepage',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    return "<div data-role=\"recommend-module\" data-recommend-type=\"channel\" data-jester-area=\"recommended-channels\"\nclass=\"module--aside\"></div>\n<div data-role=\"recommend-module\" data-recommend-type=\"user\" data-jester-area=\"recommended-users\"\nclass=\"module--aside\"></div>\n<div data-role=\"recommend-module\" data-recommend-type=\"forum\" data-jester-area=\"recommended-forums\"\nclass=\"module--aside\"></div>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div data-role=\"motd-alert\"></div>\n<div class=\"section-contained\">\n<div class=\"layout\">\n<div class=\"layout__main-with-aside\">\n<nav class=\"layout__nav module__wrapper\" data-role=\"left-rail\">\n<div data-role=\"user-card\" class=\"hidden-lg\" data-jester-area=\"profile_module\"></div>\n<div data-role=\"homepage-nav\"></div>\n<div data-role=\"following-module\" class=\"hidden-lg module__wrapper\" data-jester-area=\"following_module\"></div>\n</nav>\n<section class=\"layout__content homepage-feed\">\n<div data-role=\"onboarding-module\" class=\"homepage-onboard__note\"></div>\n<div data-role=\"email-verification-alert\"></div>\n<div data-role=\"content-area\" data-jester-area=\"feed\"></div>\n</section>\n</div>\n<aside data-role=\"right-rail\" class=\"layout__aside hidden-md module__wrapper\">\n<div data-role=\"create-channel-module\" data-jester-area=\"create-channel-module\"></div>\n<div data-role=\"moderated-forums-module\" data-jester-area=\"moderated-forums-module\"></div>\n<div data-role=\"comments-module\" data-jester-area=\"comments-module\" class=\"module--aside\"></div>\n"
    + ((stack1 = lookupProperty(helpers,"unless").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"onboardingWithoutChannels") : depth0),{"name":"unless","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":20,"column":0},"end":{"line":27,"column":11}}})) != null ? stack1 : "")
    + "<div class=\"text-smaller text-gray\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"homeFooter"),depth0,{"name":"homeFooter","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n\n</aside>\n</div>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/templates/homepageTabs',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"aside__subheadings hidden-lg\">\n<h2 class=\"text-subheading\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Your Feed",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":2,"column":28},"end":{"line":2,"column":51}}}))
    + "</h2>\n</div>\n<ul class=\"nav--aside\">\n<li data-action=\"switch-tab\" data-tab=\"popular\" class=\"nav__item\">\n<a href=\"/home/\" class=\"nav-lnk -color-muted\">\n<div class=\"nav-lnk__blk\">\n<span class=\"nav-lnk__icon icon icon-popular\"></span>\n<span class=\"button__text\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Recommended",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":9,"column":27},"end":{"line":9,"column":52}}}))
    + "</span>\n</div>\n<div class=\"nav-lnk__pointer\">\n<span class=\"icon icon-right-bracket\"></span>\n</div>\n</a>\n</li>\n<li data-action=\"switch-tab\" data-tab=\"comments\" class=\"nav__item\">\n<a href=\"/home/comments/\" class=\"nav-lnk -color-muted\">\n<div class=\"nav-lnk__blk\">\n<span class=\"nav-lnk__icon icon icon-comments\"></span>\n<span class=\"button__text\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Latest Comments",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":20,"column":27},"end":{"line":20,"column":56}}}))
    + "</span>\n</div>\n<div class=\"nav-lnk__pointer\">\n<span class=\"icon icon-right-bracket\"></span>\n</div>\n</a>\n</li>\n<li data-action=\"switch-tab\" data-tab=\"discussions\" class=\"nav__item\">\n<a href=\"/home/discussions/\" class=\"nav-lnk -color-muted\">\n<div class=\"nav-lnk__blk\">\n<span class=\"nav-lnk__icon icon icon-discussions\"></span>\n<span class=\"button__text\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Latest Discussions",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":31,"column":27},"end":{"line":31,"column":59}}}))
    + "</span>\n</div>\n<div class=\"nav-lnk__pointer\">\n<span class=\"icon icon-right-bracket\"></span>\n</div>\n</a>\n</li>\n<li class=\"nav__item visible-md\">\n<a href=\"/about/\" class=\"nav-lnk -color-muted\">\n<div class=\"nav-lnk__blk\">\n<span class=\"nav-lnk__icon icon icon-brand-square\"></span>\n<span class=\"button__text\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"About %(disqus)s",{"name":"gettext","hash":{"disqus":"Disqus"},"data":data,"loc":{"start":{"line":42,"column":27},"end":{"line":42,"column":75}}}))
    + "</span>\n</div>\n</a>\n</li>\n</ul>\n";
},"useData":true})

});
define('home/views/HomepageView',[
    'jquery',
    'underscore',
    'backbone',
    'backbone-marionette',

    'core/strings',

    'home/models/Session',
    'home/collections/ForumCollection',
    'home/views/common/TabbedView',
    'home/views/RecommendationsModuleView',
    'home/views/ChannelCardCollectionViewWithChannelPromotion',
    'home/views/ChannelFeedFooterView',
    'home/views/common/FetchableCollectionLayout',
    'home/views/CommentCardCollectionView',
    'home/views/HomepageUserModuleView',
    'home/views/HomepageCommentsModuleView',
    'home/views/HomepageChannelsModuleView',
    'home/views/HomepageOnboardingModuleView',
    'home/views/ModeratedForumsModuleView',
    'home/views/HomepageFollowingModuleView',
    'home/views/HomepageRecommendedFeedEmptyView',
    'home/views/HomepageCommentsFeedEmptyView',
    'home/views/HomepageDiscussionsFeedEmptyView',
    'home/views/MotdAlertView',
    'home/mixins/withClickLinkTracking',
    'home/mixins/withEmailVerificationAlert',
    'home/mixins/withEmailConfirmedModal',

    'home/templates/homepage',
    'home/templates/homepageTabs',
], function (
    $,
    _,
    Backbone,
    Marionette,

    strings,

    Session,
    ForumCollection,
    TabbedView,
    RecommendationsModuleView,
    ChannelCardCollectionViewWithChannelPromotion,
    ChannelFeedFooterView,
    FetchableCollectionLayout,
    CommentCardCollectionView,
    HomepageUserModuleView,
    HomepageCommentsModuleView,
    HomepageChannelsModuleView,
    HomepageOnboardingModuleView,
    ModeratedForumsModuleView,
    HomepageFollowingModuleView,
    HomepageRecommendedFeedEmptyView,
    HomepageCommentsFeedEmptyView,
    HomepageDiscussionsFeedEmptyView,
    MotdAlertView,
    withClickLinkTracking,
    withEmailVerificationAlert,
    withEmailConfirmedModal,

    homepageTemplate,
    homepageTabsTemplate
) {
    'use strict';

    var gettext = strings.get;

    var HomepageView = TabbedView.extend({
        defaultTab: 'popular',
        template: homepageTemplate,
        templateHelpers: function () {
            return {
                onboardingWithoutChannels: this.onboardingWithoutChannels,
            };
        },


        events: _.defaults({
            'click a[data-link-name]': 'trackClickLink',
        }, TabbedView.prototype.events),

        regions: _.defaults({
            userCardRegion: '[data-role=user-card]',
            commentsModuleRegion: '[data-role=comments-module]',
            followingModuleRegion: '[data-role=following-module]',
            recommendedChannelsModuleRegion: '[data-role=recommend-module][data-recommend-type=channel]',
            recommendedUsersModuleRegion: '[data-role=recommend-module][data-recommend-type=user]',
            recommendedForumsModuleRegion: '[data-role=recommend-module][data-recommend-type=forum]',
            rightRailRegion: '[data-role=right-rail]',
            leftRailRegion: '[data-role=left-rail]',
            onboardingModuleRegion: '[data-role=onboarding-module]',
            homepageTabsRegion: '[data-role=homepage-nav]',
            moderatedForumsRegion: '[data-role=moderated-forums-module]',
            motdAlertRegion: '[data-role=motd-alert]',
        }, TabbedView.prototype.regions),

        initialize: function (options) {
            TabbedView.prototype.initialize.call(this, options);

            this.session = Session.get();

            this.showOnboarding = false;

            this.onboardingWithoutChannels = options.onboardingWithoutChannels;

            this.session.loadPromise().then(_.bind(function () {
                this.showOnboarding = this.session.isLoggedIn() && !this.session.user.get('homeFeedOnboardingComplete');
                if (this.showOnboarding)
                    this.toggleOnboardingModules();

            }, this));

            this.listenTo(this, 'change:activeTab', this.updateTabSpecificModules);
        },

        onDomRefresh: function () {
            TabbedView.prototype.onDomRefresh.call(this);

            // Keep these, don't un-render based on onboardingWithoutChannels, this would show the channels users
            // are already following which we don't want to get rid of at least for now
            var interestingChannelsFetchPromise = this.model.interestingChannels.ensureFetched();
            var boundShowChannelsModule = _.bind(this.showChannelsModule, this);
            var forumsFollowingFetchPromise;

            // Listen for unfollow curation channel events so we can refresh
            // the recommended feed.
            this.listenTo(this.session.user, 'unfollowed:curationchannel', this.refreshRecommendedFeed);

            // Show logged in modules
            this.session.loadPromise().then(_.bind(this.showLoggedInModules, this));

            forumsFollowingFetchPromise = this.session.userProfile.forumsFollowing.ensureFetched();
            forumsFollowingFetchPromise.done(_.bind(this.showFollowingModule, this));

            // when user is logged in, also wait for forumsFollowing fetch to complete so that
            // we can remove channels that a user has followed.
            $.when(forumsFollowingFetchPromise, interestingChannelsFetchPromise).done(
                boundShowChannelsModule
            );

            this.toggleOnboardingModules();
        },

        showFollowingModule: function () {
            var forumsFollowingFeed = this.session.userProfile.forumsFollowing;
            if (!forumsFollowingFeed.items.length)
                return;

            this.followingModuleRegion.show(new HomepageFollowingModuleView({
                collection: forumsFollowingFeed.items,
            }));
        },

        showMotdAlertView: function () {
            this.motdAlertRegion.show(new MotdAlertView());
        },

        showLoggedInModules: function () {
            this.recommendedUsersModuleRegion.show(
                RecommendationsModuleView.createUserRecommendedModuleView({
                    model: this.model.interestingUsers,
                })
            );

            this.userCardRegion.show(new HomepageUserModuleView({
                model: this.session.user,
            }));

            this.homepageTabsRegion.show(new Marionette.ItemView({
                template: homepageTabsTemplate,
            }));

            // update tab classes as there's a chance that the first update ran
            // before homepage tabs are rendered on the page (if session fetch returns after
            // initial render happens)
            this.updateTabClasses();

            this.showModeratedForums();
        },

        showModeratedForums: function () {
            this.session.loadModeratedForums().then(_.bind(function () {
                var models = _.chain(this.session.moderatedForums)
                    .reject(function (id) {
                        // TODO - this is a super hacky way of filtering
                        // out channels and should be fixed ASAP once we have
                        // an endpoint that returns a list of forums that a user
                        // moderates.
                        //
                        // https://trello.com/c/UoOrovOm/360-create-listmoderatedforums-endpoint-to-return-the-list-of-forums-that-a-user-moderates
                        return id.indexOf('channel-') === 0;
                    })
                    .sortBy() // alphabetically
                    .map(function (id) {
                        // Convert array of forum ids to an array
                        // of forum model attributes to be passed
                        // into ForumCollection
                        return { id: id };
                    })
                    .value();

                if (_.isEmpty(models))
                    return;

                this.moderatedForumsRegion.show(new ModeratedForumsModuleView({
                    collection: new ForumCollection(models),
                }));

                // If we display the moderationForums, also display the MOTD at the top.
                this.showMotdAlertView();
            }, this));
        },

        /*
         * Shows the Recommended Channels module except in the case that
         * you're following all of them from the given list. Then falls
         * back to the older Recommended Forums module.
         */
        showChannelsModule: function () {
            var filteredChannels = this.model.interestingChannels.items
                .chain()
                .reject(function (channelProfile) {
                    return channelProfile.channel.primaryForum.get('isFollowing');
                })
                .pluck('channel')
                .shuffle()
                .value();

            if (filteredChannels.length) {
                // Only show channels module if there are some Channels
                // the user hasn't followed yet.
                this.recommendedChannelsModuleRegion.show(new HomepageChannelsModuleView({
                    collection: new Backbone.Collection(filteredChannels),
                }));
            } else {
                // User has followed all channels, so show the recommended
                // forums module instead.
                this.model.initializeAndFetchInterestingForums();
                this.recommendedForumsModuleRegion.show(RecommendationsModuleView.createForumRecommendedModuleView({
                    model: this.model.interestingForums,
                }));
            }
        },

        refreshRecommendedFeed: function () {
            this.model.popular.fetchItems({
                reset: true,
            });
        },

        /*
         * Shows and hides modules that are specific to a particular tab based on what
         * the current active tab is.
         */
        updateTabSpecificModules: function (activeTab) {
            if (activeTab === 'comments') {
                this.hideRegion(this.commentsModuleRegion);
            } else if (!Session.isKnownToBeLoggedOut()) {
                if (!this.commentsModuleRegion.currentView)
                    this.commentsModuleRegion.show(this.createHomepageCommentsModuleView());

                this.showRegion(this.commentsModuleRegion);
            }
        },

        toggleOnboardingModules: function () {
            var regionsToDisable = ['leftRailRegion', 'rightRailRegion'];

            _.each(regionsToDisable, function (regionName) {
                this[regionName].ensureEl();
                this[regionName].$el.toggleClass('is-disabled', this.showOnboarding);
            }, this);

            if (this.showOnboarding) {
                var onboardingModuleView = new HomepageOnboardingModuleView({
                    onboardingWithoutChannels: this.onboardingWithoutChannels,
                });
                this.listenTo(onboardingModuleView, 'hideOnboarding', function () {
                    this.showOnboarding = false;
                    this.toggleOnboardingModules();
                });

                this.onboardingModuleRegion.show(onboardingModuleView);

                this.hideRegion(this.emailVerificationAlertRegion);
            } else if (this.onboardingModuleRegion.$el) {
                this.hideRegion(this.onboardingModuleRegion);
            }
        },


        createHomepageCommentsModuleView: function () {
            // Create an empty collection of posts to back the comments module.
            var postCollection = new Backbone.Collection([]);
            var self = this;

            // Once the recent comments feed has fetched, fill the collection with
            // the posts from the feed. The view will update itself.
            this.model.commentsPromise.then(function () {
                postCollection.reset(self.model.comments.items.map(function (feedItem) {
                    // The comments feed doesn't support grouped activities, so
                    // we only care about the first activity. Return the post
                    // from that activity.
                    return feedItem.activities[0].object;
                }));
            });

            return new HomepageCommentsModuleView({
                collection: postCollection,
                commentsPromise: this.model.commentsPromise,
            });
        },

        hideRegion: function (region) {
            if (region.$el)
                region.$el.addClass('is-hidden');
        },

        showRegion: function (region) {
            if (region.$el)
                region.$el.removeClass('is-hidden');
        },

        getTrackingSection: function (activeTab) {
            // Return the tab name for tracking
            return activeTab;
        },

        getTabView: function (activeTab) {
            var emptyViewOptions = {
                model: this.model.spotlightProfile.topActivities,
                collection: this.model.spotlightProfile.topActivities.items,
                maxItemsText: this.model.constructor.MAX_SPOTLIGHT_ITEMS.TEXT,
                onboardingWithoutChannels: this.onboardingWithoutChannels,
            };

            switch (activeTab) {
            case 'popular':
                return new FetchableCollectionLayout({
                    model: this.model.popular,
                    collection: this.model.popular.items,
                    fetchableCollectionView: ChannelCardCollectionViewWithChannelPromotion,
                    fetchableCollectionFooterView: ChannelFeedFooterView,
                    infiniteScroll: true,
                    enableBestOfDisqusCallout: true,
                    emptyView: HomepageRecommendedFeedEmptyView,
                    emptyViewOptions: emptyViewOptions,
                });
            case 'comments':
                return new FetchableCollectionLayout({
                    model: this.model.comments,
                    collection: this.model.comments.items,
                    fetchableCollectionView: CommentCardCollectionView,
                    infiniteScroll: true,
                    emptyView: HomepageCommentsFeedEmptyView,
                    emptyViewOptions: emptyViewOptions,
                });
            case 'discussions':
                return new FetchableCollectionLayout({
                    model: this.model.discussions,
                    collection: this.model.discussions.items,
                    fetchableCollectionView: ChannelCardCollectionViewWithChannelPromotion,
                    infiniteScroll: true,
                    emptyView: HomepageDiscussionsFeedEmptyView,
                    emptyViewOptions: emptyViewOptions,
                });
            }
        },

        getMetaAttrs: function () {
            switch (this.activeTab) {
            case 'popular':
                return gettext('Recommended Discussions');
            case 'comments':
                return gettext('Latest Comments');
            case 'discussions':
                return gettext('Latest Discussions');
            }
        },
    });

    withClickLinkTracking.call(HomepageView.prototype);
    withEmailVerificationAlert.call(HomepageView.prototype);
    withEmailConfirmedModal.call(HomepageView.prototype);

    return HomepageView;
});

define('home/templates/activityFeed',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    return "<div class=\"section-contained\">\n<div class=\"cover\" data-role=\"cover-area\"></div>\n</div>\n<div class=\"section-contained\" data-role=\"header-area\"></div>\n<div class=\"section-contained\" id=\"container-content\" data-role=\"content-area\"></div>\n<div class=\"section-contained\" data-role=\"footer-area\"></div>\n";
},"useData":true})

});
define('home/views/ActivityFeedView',[
    'underscore',

    'home/views/ActivityCardCollectionView',
    'home/views/common/FetchableCollectionLayout',

    'home/templates/activityFeed',
], function (
    _,

    ActivityCardCollectionView,
    FetchableCollectionLayout,

    activityFeedTemplate
) {
    'use strict';

    /**
      * A view that shows a feed of activity items and a footer that handles pagination.
      */
    var ActivityFeedView = FetchableCollectionLayout.extend({
        template: activityFeedTemplate,

        regions: _.defaults({
            coverRegion: '[data-role=cover-area]',
        }, FetchableCollectionLayout.prototype.regions),

        fetchableCollectionView: ActivityCardCollectionView,

        initialize: function (options) {
            FetchableCollectionLayout.prototype.initialize.apply(this, arguments);

            if (options.coverView)
                this.coverView = options.coverView;
        },

        onDomRefresh: function () {
            /* eslint-disable new-cap */
            FetchableCollectionLayout.prototype.onDomRefresh.apply(this, arguments);

            if (this.coverView) {
                // If the cover view has a class function for selecting the model it expects
                // to receive, use it.
                var coverModel = this.coverView.getModel ?
                    this.coverView.getModel(this.model) :
                    this.model;
                this.coverRegion.show(new this.coverView({ model: coverModel }));
            }
            /* eslint-enable new-cap */
        },

        getMetaAttrs: function () {
            var cover = this.coverRegion.currentView;
            return cover && cover.getMetaAttrs && cover.getMetaAttrs() || '';
        },
    });

    return ActivityFeedView;
});

define('home/mixins/asNotificationCard',[
    'jquery',
    'underscore',

    'core/utils',
    'core/analytics/jester',

    'home/utils/navigationUtils',
    'home/mixins/withAllstarPopover',
], function (
    $,
    _,

    utils,
    jester,

    NavigationUtils,
    withAllstarPopover
) {
    'use strict';

    var urlFragmentReg = /#.*$/;

    var asNotificationCard = {
        className: 'card-wrap card--notification',

        initialize: function (_initialize, options) {
            _initialize.call(this, options);

            this.listenTo(this.model, 'change:isUnread', this.updateUnreadClass);
            this.updateUnreadClass();
        },

        updateUnreadClass: function () {
            this.$el.toggleClass('unread', Boolean(this.model.get('isUnread')));
        },

        serializeData: function (_serializeData) {
            var data = _serializeData.apply(this, arguments);

            return _.defaults(data, {
                discussionRoute: this.model.thread && this.model.thread.getDiscussionRoute(),
            });
        },

        // Tracking functionality
        trackView: function () {
            if (this.model.get('isUnread'))
                jester.client.emit(this.getAnalyticsPayload('view'));
        },

        trackClick: function (evt) {
            var $elem = $(evt.currentTarget);

            // First check if we should handle this event at all.
            if (!this.shouldTrackClick(evt, $elem))
                return;

            var trackXhr = jester.client.emit(this.getAnalyticsPayload('click'));

            // If an event is going to open a new tab or window, we don't need to
            // do anything else at this point. Otherwise we need to make sure all the
            // handlers' deferred objects have a chance to resolve before we allow
            // navigation.
            // TODO: Look into [sendBeacon](https://developer.mozilla.org/en-US/docs/Web/API/Navigator/sendBeacon)
            if (trackXhr && this.shouldDelayNavigation(evt, $elem)) {
                evt.preventDefault();
                evt.stopPropagation();

                var navigate = _.once(function () {
                    // Make sure to set the 'top' location in case we are iFramed
                    window.top.location = $elem[0].href;
                });

                // navigate if deferreds don't complete within timeout
                _.delay(navigate, 1000);
                trackXhr.always(navigate);
            }
        },

        shouldTrackClick: function (evt, $elem) {
            // We don't do anything if we're already handling this event elsewhere.
            if (evt.isDefaultPrevented())
                return false;

            // We don't bother if the clicked link doesn't have an href attribute,
            // or if the clicked link's href attribute is just a hash.
            var href = ($elem.attr('href') || '').replace(urlFragmentReg, '');

            return Boolean(href);
        },

        shouldDelayNavigation: function (evt, $elem) {
            // If Home's navigation utils will capture the link click or
            // the link is being opened in a new window, we don't need to
            // delay the click.
            return !(NavigationUtils.isInbound(evt.target) || utils.willOpenNewWindow(evt, $elem));
        },
    };

    return function () {
        withAllstarPopover.call(this);

        this.className = _.wrap(this.className, function (_className) {
            if (_.isFunction(_className))
                _className = _className.call(this);
            _className = _className || '';

            return asNotificationCard.className + ' ' + _className;
        });

        this.initialize = _.wrap(this.initialize, asNotificationCard.initialize);

        this.serializeData = _.wrap(this.serializeData, asNotificationCard.serializeData);

        // Iff this view has defined getAnalyticsPayload then mix in tracking functionality
        if (this.getAnalyticsPayload) {
            _.extend(this, _.pick(asNotificationCard, [
                'trackView',
                'trackClick',
                'shouldTrackClick',
                'shouldDelayNavigation',
            ]));

            this.events = _.extend({
                'click a': 'trackClick',
            }, this.events);

            this.onRender = _.wrap(this.onRender, function (_onRender) {
                if (_onRender)
                    _onRender.call(this);

                this.trackView();
            });
        }

        _.extend(this, _.pick(asNotificationCard, [
            'updateUnreadClass',
        ]));
    };
});

define('home/views/common/NotificationCardPostView',[
    'home/views/common/ActivityCardView',
    'home/mixins/withReason',
    'home/mixins/asNotificationCard',
    'home/mixins/withSubviews',

    'home/views/TruncatedPostView',
], function (
    ActivityCardView,
    withReason,
    asNotificationCard,
    withSubviews,

    TruncatedPostView
) {
    'use strict';

    var parent = ActivityCardView;

    /**
     * Abstract parent class for notification card views that show a single
     * post in the card.
     *
     * Child classes should define:
     *      - {function} getPost - fn that returns a post given an Activity of the
     *                            child-specific type (ex: ChannelPostActivity)
     *     - {function} template - fn that returns html to show for this view
     *     - {string} childClassName - the child-specific class name to be added
     *                                 to general notification card classes

     * IMPORTANT: Child classes should not define className, or they will overwrite
     *            the classes mixed into this parent. Use childClassName.
     *
     * Expects an ActivityFeedItem model. All Activity models rolled up in the
     * ActivityFeedItem model must have the same Post model as the target.
     */
    var NotificationCardPostView = parent.extend({

        /**
         * Returns the child-specific class name. This is necessary because this
         * parent class uses mixins that add notification card classes to whatever
         * is returned from this parent className function. If the child class
         * defines className it will overwrite this className and won't get the
         * mixed in values.
         *
         * @returns {string} - The class name specified by the child class.
         */
        className: function () {
            return this.childClassName;
        },

        regions: {
            postRegion: '[data-role=post]',
        },

        onRender: function () {
            this.activateRegion(this.postRegion, this.createPostView);
        },

        createPostView: function () {
            // Grouped activities should all have the same target post. Just
            // get the post from the first one.
            var post = this.getPost(this.model.activities[0]);
            return new TruncatedPostView({
                model: post,
            });
        },
    });

    var proto = NotificationCardPostView.prototype;
    withReason.call(proto);
    asNotificationCard.call(proto);
    withSubviews.call(proto);

    return NotificationCardPostView;
});

define('home/templates/notificationCardChannelPost',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card__reason\">\n<div class=\"notification__icon -reply\">\n<span class=\"icon-notification-response text-brand icon__position text-smaller\"></span>\n</div>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"%(userName)s responded to your discussion %(thread)s",{"name":"gettext","hash":{"thread":lookupProperty(helpers,"getPartial").call(alias1,"threadLink",{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":5,"column":122},"end":{"line":5,"column":147}}}),"userName":lookupProperty(helpers,"getPartial").call(alias1,"userName",(depth0 != null ? lookupProperty(depth0,"firstActor") : depth0),{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":5,"column":78},"end":{"line":5,"column":112}}})},"data":data,"loc":{"start":{"line":5,"column":0},"end":{"line":5,"column":149}}}))
    + "\n\n<span class=\"time text-gray\">"
    + alias2(container.lambda((depth0 != null ? lookupProperty(depth0,"relativeTime") : depth0), depth0))
    + "</span>\n</div>\n<div class=\"card__content -notification\">\n<div class=\"card-comment\" data-role=\"post\"></div>\n</div>\n";
},"useData":true})

});
define('home/views/NotificationCardChannelPostView',[
    'home/views/common/NotificationCardPostView',
    'home/templates/notificationCardChannelPost',
], function (
    NotificationCardPostView,
    notificationCardChannelPostTemplate
) {
    'use strict';

    var parent = NotificationCardPostView;

    var NotificationCardChannelPostView = parent.extend({
        // See NotificationCardHighlightPostView.className for documentation
        childClassName: 'card-notif-channel-post',

        template: notificationCardChannelPostTemplate,

        getPost: function (activity) {
            return activity.object;
        },
    });

    return NotificationCardChannelPostView;
});

define('home/templates/notificationCardUpvote',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card__reason\">\n<div class=\"notification__icon -upvote text-brand\">\n<span class=\"icon-arrow-up text-smaller\"></span>\n</div>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"%(userNames)s upvoted you on %(thread)s",{"name":"gettext","hash":{"thread":lookupProperty(helpers,"getPartial").call(alias1,"threadLink",{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":6,"column":105},"end":{"line":6,"column":130}}}),"userNames":lookupProperty(helpers,"getPartial").call(alias1,"userGroupNames",{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":6,"column":66},"end":{"line":6,"column":95}}})},"data":data,"loc":{"start":{"line":6,"column":0},"end":{"line":6,"column":132}}}))
    + "\n\n<span class=\"time text-gray\">"
    + alias2(container.lambda((depth0 != null ? lookupProperty(depth0,"relativeTime") : depth0), depth0))
    + "</span>\n</div>\n<div class=\"card__content -notification\">\n<div data-role=\"post\"></div>\n</div>\n";
},"useData":true})

});
define('home/views/NotificationCardUpvoteView',[
    'home/views/common/NotificationCardPostView',
    'home/templates/notificationCardUpvote',
], function (
    NotificationCardPostView,
    notificationCardUpvoteTemplate
) {
    'use strict';

    var parentView = NotificationCardPostView;

    var NotificationCardUpvoteView = parentView.extend({
        // See NotificationCardHighlightPostView.className for documentation
        childClassName: ' card-notif-upvote',

        template: notificationCardUpvoteTemplate,

        getPost: function (activity) {
            return activity.target;
        },
    });

    return NotificationCardUpvoteView;
});

define('home/templates/notificationCardChannelRecommend',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card__reason  -recommendation\">\n<div class=\"notification__icon\">\n<span class=\"icon-heart text-error text-smaller icon__position\"></span>\n</div>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"%(userNames)s recommended your discussion %(thread)s",{"name":"gettext","hash":{"thread":lookupProperty(helpers,"getPartial").call(alias1,"threadLink",{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":5,"column":118},"end":{"line":5,"column":143}}}),"userNames":lookupProperty(helpers,"getPartial").call(alias1,"userGroupNames",{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":5,"column":79},"end":{"line":5,"column":108}}})},"data":data,"loc":{"start":{"line":5,"column":0},"end":{"line":5,"column":145}}}))
    + "\n\n<span class=\"time text-gray\">"
    + alias2(container.lambda((depth0 != null ? lookupProperty(depth0,"relativeTime") : depth0), depth0))
    + "</span>\n</div>\n";
},"useData":true})

});
define('home/views/NotificationCardChannelRecommendView',[
    'home/views/common/ActivityCardView',
    'home/mixins/withReason',
    'home/mixins/asNotificationCard',

    'home/templates/notificationCardChannelRecommend',
], function (
    ActivityCardView,
    withReason,
    asNotificationCard,

    notificationCardChannelRecommendTemplate
) {
    'use strict';

    var parent = ActivityCardView;

    var NotificationCardChannelRecommendView = parent.extend({
        className: 'card-notif-recommend',

        template: notificationCardChannelRecommendTemplate,
    });


    var proto = NotificationCardChannelRecommendView.prototype;
    withReason.call(proto);
    asNotificationCard.call(proto);

    return NotificationCardChannelRecommendView;
});

define('home/templates/notificationCardReply',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card__reason\">\n<div class=\"notification__icon -reply\">\n<span class=\"icon-notification-reply text-success icon-small\"></span>\n</div>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"%(userName)s replied to you on %(thread)s",{"name":"gettext","hash":{"thread":lookupProperty(helpers,"getPartial").call(alias1,"threadLink",{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":5,"column":111},"end":{"line":5,"column":136}}}),"userName":lookupProperty(helpers,"getPartial").call(alias1,"userName",(depth0 != null ? lookupProperty(depth0,"firstActor") : depth0),{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":5,"column":67},"end":{"line":5,"column":101}}})},"data":data,"loc":{"start":{"line":5,"column":0},"end":{"line":5,"column":138}}}))
    + "\n\n<span class=\"time text-gray\">"
    + alias2(container.lambda((depth0 != null ? lookupProperty(depth0,"relativeTime") : depth0), depth0))
    + "</span>\n</div>\n<div class=\"card__content -notification\">\n<div class=\"card-comment\" data-role=\"post\"></div>\n</div>\n";
},"useData":true})

});
define('home/views/NotificationCardReplyView',[
    'backbone',

    'home/views/common/ActivityCardView',
    'home/mixins/withReason',
    'home/mixins/asNotificationCard',
    'home/mixins/withSubviews',

    'home/views/PostActivityCollectionView',

    'home/templates/notificationCardReply',
], function (
    Backbone,

    ActivityCardView,
    withReason,
    asNotificationCard,
    withSubviews,

    PostActivityCollectionView,

    notificationCardReplyTemplate
) {
    'use strict';


    var NotificationCardReplyView = ActivityCardView.extend({
        className: 'card-notif-reply',

        template: notificationCardReplyTemplate,

        regions: {
            postsRegion: '[data-role=post]',
        },

        onRender: function () {
            this.activateRegion(this.postsRegion, this.createPostCollectionView);
        },

        createPostCollectionView: function () {
            return new PostActivityCollectionView({
                collection: new Backbone.Collection(this.model.activities),
            });
        },
    });


    var proto = NotificationCardReplyView.prototype;
    withReason.call(proto);
    asNotificationCard.call(proto);
    withSubviews.call(proto);

    return NotificationCardReplyView;
});

define('home/templates/userCard',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card--user\">\n<div class=\"user-card__block\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"userCardBody"),depth0,{"name":"userCardBody","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n<div class=\"user-card__button\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"userFollowButton"),depth0,{"name":"userFollowButton","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/UserCardView',[
    'backbone-marionette',
    'home/mixins/withAllstarPopover',

    'home/templates/userCard',

    'core/bus',
], function (
    Marionette,
    withAllstarPopover,

    userCardTemplate,

    bus
) {
    'use strict';

    var UserCardView = Marionette.ItemView.extend({
        template: userCardTemplate,
        templateHelpers: function () {
            return {
                isSessionUser: this.model.isSessionUser(),
            };
        },
        className: 'card',

        events: {
            'click [data-action=toggle-follow]': 'toggleFollow',
        },
        modelEvents: {
            'change:isFollowing': 'handleFollowedClass',
        },

        handleFollowedClass: function () {
            this.$('[data-action=toggle-follow]').toggleClass('active', this.model.get('isFollowing'));
        },

        toggleFollow: function (evt) {
            if (evt)
                evt.preventDefault();

            // Because we haven't toggled the following state on the
            // user model yet, the expected state is the inverse of the current.
            if (this.model.get('isFollowing'))
                bus.trigger('uiAction:unfollowUser', this.model, evt);
            else
                bus.trigger('uiAction:followUser', this.model, evt);

            this.model.toggleFollowed();
        },
    });

    withAllstarPopover.call(UserCardView.prototype);

    return UserCardView;
});

define('home/templates/followerCard',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var alias1=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<button class=\"button button-outline -border-muted text-error spacing-right-small\"\ntitle=\""
    + alias1(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Remove Follower",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":11,"column":7},"end":{"line":11,"column":36}}}))
    + "\"\ndata-action=\"remove-follower\"\ndata-user=\""
    + alias1(container.lambda((depth0 != null ? lookupProperty(depth0,"id") : depth0), depth0))
    + "\">\n<span class=\"icon-cancel icon__position\"></span>\n</button>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card--user\">\n<div class=\"user-card__block\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"userAvatar"),depth0,{"name":"userAvatar","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "<div class=\"user-info\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"userName"),depth0,{"name":"userName","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n</div>\n<div class=\"user-card__button\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"showRemoveButton") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":9,"column":0},"end":{"line":16,"column":7}}})) != null ? stack1 : "")
    + ((stack1 = container.invokePartial(lookupProperty(partials,"userFollowButton"),depth0,{"name":"userFollowButton","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/FollowerCardView',[
    'home/views/UserCardView',
    'home/templates/followerCard',

], function (
    UserCardView,
    followerCardTemplate
) {
    'use strict';

    return UserCardView.extend({
        initialize: function (options) {
            UserCardView.prototype.initialize.call(this, options);
            this.showRemoveButton = options.showRemoveButton;
        },

        template: followerCardTemplate,

        templateHelpers: function () {
            var helpers = UserCardView.prototype.templateHelpers.call(this);
            helpers.showRemoveButton = this.showRemoveButton;
            return helpers;
        },
    });
});

define('home/views/FollowerCollectionView',[
    'underscore',
    'jquery',

    'core/strings',
    'core/bus',

    'home/views/FollowerCardView',
    'home/views/common/FetchableCollectionView',
], function (
    _,
    $,

    strings,
    bus,

    FollowerCardView,
    FetchableCollectionView
) {
    'use strict';

    var gettext = strings.get;

    /**
     * A user's followers
     * NOTE: does not inherit from UserCollectionView because that class contains
     * behavior (like not removing an item from the view when removed from the
     * collection) that does not apply here.
     */
    return FetchableCollectionView.extend({
        initialize: function (options) {
            FetchableCollectionView.prototype.initialize.call(this, options);

            // The user to whom this collection of followers belongs
            this.user = options.user;
        },

        events: _.defaults({
            'click [data-action=remove-follower]': 'removeFollower',
        }, FetchableCollectionView.prototype.events),

        itemView: FollowerCardView,

        itemViewOptions: function () {
            return {
                showRemoveButton: this.user.isSessionUser(),
            };
        },

        removeFollower: function (evt) {
            if (!this.user.isSessionUser())
                return;

            evt.preventDefault();

            var $removeButton = $(evt.currentTarget);
            var whom = $removeButton.attr('data-user');
            var follower = this.collection.findWhere({ id: whom });

            var confirm = window.confirm(strings.interpolate(
                gettext('Remove %(follower)s as a follower?'), {
                    follower: follower.getDisplayName(),
                }
            ));

            if (!confirm)
                return;

            this.collection.remove(follower);

            bus.trigger('removeFollower', follower);

            return this.user.removeFollower(follower);
        },
    });
});

define('home/templates/notificationCardFollow',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"expandable\">\n<div class=\"followers__expand\">\n<a href=\"#\" data-action=\"toggle-collapsed\" class=\"expandable card-expand\">\n<div class=\"icon-more-vert\"></div>\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"See More",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":15,"column":0},"end":{"line":15,"column":22}}}))
    + "\n</a>\n</div>\n</div>\n";
},"3":function(container,depth0,helpers,partials,data) {
    var alias1=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"collapsible\">\n<div class=\"followers__collapse\">\n<a class=\"button button-outline\" href=\"/by/"
    + alias1(container.lambda((depth0 != null ? lookupProperty(depth0,"sessionUsername") : depth0), depth0))
    + "/followers/\">\n"
    + alias1(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"See All Followers",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":24,"column":0},"end":{"line":24,"column":31}}}))
    + "\n</a>\n</div>\n</div>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card__reason\">\n<div class=\"notification__icon\">\n<span class=\"icon-notification-follow icon__position text-small\"></span>\n</div>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"%(userNames)s followed you",{"name":"gettext","hash":{"userNames":lookupProperty(helpers,"getPartial").call(alias1,"userGroupNames",{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":5,"column":53},"end":{"line":5,"column":82}}})},"data":data,"loc":{"start":{"line":5,"column":0},"end":{"line":5,"column":84}}}))
    + "\n<span class=\"time text-gray\">"
    + alias2(container.lambda((depth0 != null ? lookupProperty(depth0,"relativeTime") : depth0), depth0))
    + "</span>\n</div>\n<div data-role=\"users\"></div>\n\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"shouldCollapse") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":10,"column":0},"end":{"line":19,"column":7}}})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"hasOverflowActors") : depth0),{"name":"if","hash":{},"fn":container.program(3, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":20,"column":0},"end":{"line":28,"column":7}}})) != null ? stack1 : "");
},"useData":true})

});
define('home/views/NotificationCardFollowView',[
    'underscore',
    'backbone',

    'home/views/common/ActivityCardView',
    'home/mixins/withReason',
    'home/mixins/asNotificationCard',
    'home/mixins/asCollapsibleCard',
    'home/mixins/withSubviews',

    'home/models/Session',

    'home/views/FollowerCollectionView',

    'home/templates/notificationCardFollow',
], function (
    _,
    Backbone,

    ActivityCardView,
    withReason,
    asNotificationCard,
    asCollapsibleCard,
    withSubviews,

    Session,

    FollowerCollectionView,

    notificationCardFollowTemplate
) {
    'use strict';

    var parent = ActivityCardView;

    var NotificationCardFollowView = parent.extend({
        className: function () {
            return 'card-notif-follow' +
                (this.shouldCollapse() ? ' card-collapsed' : '');
        },

        initialize: function () {
            this.session = Session.get();
            this.initializeShownActors();
        },

        initializeShownActors: function () {
            if (!this.shownActors)
                this.shownActors = _.pluck(this.model.activities, 'actor');
        },

        /**
         * Card collapses to hide more than 3 actors
         */
        shouldCollapse: function () {
            this.initializeShownActors();
            return this.shownActors.length > 3;
        },

        template: notificationCardFollowTemplate,
        templateHelpers: function () {
            return {
                hasOverflowActors: this.model.get('totalActors') > this.model.actors.length,
                sessionUsername: this.session.user.get('username'),
                shouldCollapse: this.shouldCollapse(),
            };
        },

        regions: {
            usersRegion: '[data-role=users]',
        },

        onRender: function () {
            this.activateRegion(this.usersRegion, this.createUsersView);
        },

        createUsersView: function () {
            return new FollowerCollectionView({
                user: this.session.user,
                el: this.usersRegion.el,
                itemViewOptions: function (_item, index) {
                    // Overwrite the FollowerCardView className which assumes the view is
                    // its own card
                    return {
                        className: 'followers__wrap' + (index > 2 ? ' collapsible' : ''),
                        showRemoveButton: true,
                    };
                },
                collection: new Backbone.Collection(this.shownActors),
            });
        },
    });


    var proto = NotificationCardFollowView.prototype;
    withReason.call(proto);
    asNotificationCard.call(proto);
    asCollapsibleCard.call(proto);
    withSubviews.call(proto);

    return NotificationCardFollowView;
});

define('home/templates/notificationCardAnnouncement',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    return " has-image";
},"3":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<span class=\"card-content__media\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"announcement") : depth0)) != null ? lookupProperty(stack1,"link") : stack1),{"name":"if","hash":{},"fn":container.program(4, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":11,"column":0},"end":{"line":14,"column":7}}})) != null ? stack1 : "")
    + "<div style=\"background-image: url("
    + container.escapeExpression(container.lambda(((stack1 = (depth0 != null ? lookupProperty(depth0,"announcement") : depth0)) != null ? lookupProperty(stack1,"image") : stack1), depth0))
    + ")\" class=\"img-cards\"></div>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"announcement") : depth0)) != null ? lookupProperty(stack1,"link") : stack1),{"name":"if","hash":{},"fn":container.program(6, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":16,"column":0},"end":{"line":18,"column":7}}})) != null ? stack1 : "")
    + "</span>\n";
},"4":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"announcement") : depth0)) != null ? lookupProperty(stack1,"link") : stack1), depth0))
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"linkArgDelimiter") : depth0), depth0))
    + "utm_campaign="
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"activityId") : depth0), depth0))
    + "&utm_content=img&utm_source=note\"\ndata-link-name=\"image\">\n";
},"6":function(container,depth0,helpers,partials,data) {
    return "</a>\n";
},"8":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"announcement") : depth0)) != null ? lookupProperty(stack1,"link") : stack1), depth0))
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"linkArgDelimiter") : depth0), depth0))
    + "utm_campaign="
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"activityId") : depth0), depth0))
    + "&utm_content=title&utm_source=note\"\nclass=\"link-gray-darker truncate\"\ndata-truncate-lines=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"numTitleLines") : depth0), depth0))
    + "\"\ndata-link-name=\"title\">\n";
},"10":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<p class=\"spacing-narrow spacing-top \">\n<a href=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"announcement") : depth0)) != null ? lookupProperty(stack1,"link") : stack1), depth0))
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"linkArgDelimiter") : depth0), depth0))
    + "utm_campaign="
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"activityId") : depth0), depth0))
    + "&utm_content=btn&utm_source=note\"\nclass=\"button button-outline text-medium\">\n"
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"announcement") : depth0)) != null ? lookupProperty(stack1,"callToAction") : stack1), depth0))
    + "\n</a>\n</p>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, alias3=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card__reason\">\n<div class=\"notification__icon -invite\">\n<span class=\"icon-notification-invite text-brand icon-small\"></span>\n</div>\n"
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"announcement") : depth0)) != null ? lookupProperty(stack1,"subject") : stack1), depth0))
    + "\n<span class=\"time text-gray\">"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"relativeTime") : depth0), depth0))
    + "</span>\n</div>\n<div class=\"card__content -notification"
    + ((stack1 = lookupProperty(helpers,"if").call(alias3,((stack1 = (depth0 != null ? lookupProperty(depth0,"announcement") : depth0)) != null ? lookupProperty(stack1,"image") : stack1),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":8,"column":39},"end":{"line":8,"column":82}}})) != null ? stack1 : "")
    + "\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias3,((stack1 = (depth0 != null ? lookupProperty(depth0,"announcement") : depth0)) != null ? lookupProperty(stack1,"image") : stack1),{"name":"if","hash":{},"fn":container.program(3, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":9,"column":0},"end":{"line":20,"column":7}}})) != null ? stack1 : "")
    + "\n<div class=\"card-content__body\">\n<h2 class=\"discussion-title\" dir=\"auto\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias3,((stack1 = (depth0 != null ? lookupProperty(depth0,"announcement") : depth0)) != null ? lookupProperty(stack1,"link") : stack1),{"name":"if","hash":{},"fn":container.program(8, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":24,"column":0},"end":{"line":29,"column":7}}})) != null ? stack1 : "")
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"announcement") : depth0)) != null ? lookupProperty(stack1,"title") : stack1), depth0))
    + "\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias3,((stack1 = (depth0 != null ? lookupProperty(depth0,"announcement") : depth0)) != null ? lookupProperty(stack1,"link") : stack1),{"name":"if","hash":{},"fn":container.program(6, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":31,"column":0},"end":{"line":33,"column":7}}})) != null ? stack1 : "")
    + "</h2>\n\n<div class=\"card-content__summary text-medium\">\n<div class=\"truncate\" data-truncate-lines=\"3\" dir=\"auto\">\n"
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"announcement") : depth0)) != null ? lookupProperty(stack1,"body") : stack1), depth0))
    + "\n</div>\n</div>\n\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias3,((stack1 = (depth0 != null ? lookupProperty(depth0,"announcement") : depth0)) != null ? lookupProperty(stack1,"callToAction") : stack1),{"name":"if","hash":{},"fn":container.program(10, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":42,"column":0},"end":{"line":49,"column":7}}})) != null ? stack1 : "")
    + "</div>\n</div>\n";
},"useData":true})

});
define('home/views/NotificationCardAnnouncementView',[
    'home/views/common/ActivityCardView',
    'home/mixins/withReason',
    'home/mixins/asNotificationCard',

    'home/templates/notificationCardAnnouncement',
], function (
    ActivityCardView,
    withReason,
    asNotificationCard,

    notificationCardAnnouncementTemplate
) {
    'use strict';

    var parent = ActivityCardView;

    /**
     * A notification card showing a custom announcement.
     *
     * Expects an ActivityFeedItem model with at least 1 AnnouncementActivity
     * rolled up.
     */
    var NotificationCardAnnouncementView = parent.extend({
        template: notificationCardAnnouncementTemplate,
        templateHelpers: function () {
            var announcement = this.getAnnouncement();
            var linkArgDelimiter = announcement.get('link') && announcement.get('link').indexOf('?') > 0 ? '&' : '?';

            return {
                announcement: announcement.toJSON(),
                linkArgDelimiter: linkArgDelimiter,
                activityId: this.model.activities[0].get('backendId'),
            };
        },

        className: 'card-notif-announcement',

        getAnnouncement: function () {
            return this.model.activities[0].object;
        },

        // By defining this, the asNotificationCard mixin will add in the view/click
        // tracking calls.
        getAnalyticsPayload: function (verb) {
            var announcement = this.getAnnouncement();
            return {
                verb: verb,
                object_type: 'note',
                object_id: this.model.activities[0].get('backendId'),
                note_template_id: announcement.get('templateId'),
                note_template_name: announcement.get('templateName'),
            };
        },
    });

    withReason.call(NotificationCardAnnouncementView.prototype);
    asNotificationCard.call(NotificationCardAnnouncementView.prototype);

    return NotificationCardAnnouncementView;
});

define('home/templates/notificationCardThreadInvite',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    return " has-image";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, alias3=container.lambda, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card__reason\">\n<div class=\"notification__icon -invite\">\n<span class=\"icon-notification-invite text-brand icon-small\"></span>\n</div>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"%(userName)s invited you to a new discussion on %(parent)s",{"name":"gettext","hash":{"parent":lookupProperty(helpers,"getPartial").call(alias1,"channelAwareForumLink",((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1),{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":5,"column":128},"end":{"line":5,"column":177}}}),"userName":lookupProperty(helpers,"getPartial").call(alias1,"userName",(depth0 != null ? lookupProperty(depth0,"firstActor") : depth0),{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":5,"column":84},"end":{"line":5,"column":118}}})},"data":data,"loc":{"start":{"line":5,"column":0},"end":{"line":5,"column":179}}}))
    + "\n<span class=\"time text-gray\">"
    + alias2(alias3((depth0 != null ? lookupProperty(depth0,"relativeTime") : depth0), depth0))
    + "</span>\n</div>\n<div class=\"card__content -notification"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"image") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":8,"column":39},"end":{"line":8,"column":69}}})) != null ? stack1 : "")
    + "\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"cardContentImage"),depth0,{"name":"cardContentImage","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "<div class=\"card-content__body\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"threadTitle"),depth0,{"name":"threadTitle","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "<div class=\"card-content__summary text-medium\">\n<div class=\"truncate\" data-truncate-lines=\"3\" dir=\"auto\">\n"
    + alias2(alias3((depth0 != null ? lookupProperty(depth0,"threadDescription") : depth0), depth0))
    + "\n</div>\n</div>\n<p class=\"spacing-narrow spacing-top \">\n<a href=\""
    + alias2(alias3((depth0 != null ? lookupProperty(depth0,"discussionRoute") : depth0), depth0))
    + "\"\nclass=\"button button-outline text-medium\"\ndata-thread-id=\""
    + alias2(alias3(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + "\">\nJoin Discussion\n</a>\n</p>\n</div>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/NotificationCardThreadInviteView',[
    'home/views/common/ActivityCardView',
    'home/mixins/withReason',
    'home/mixins/asNotificationCard',

    'home/mixins/withTruncate',

    'home/templates/notificationCardThreadInvite',
], function (
    ActivityCardView,
    withReason,
    asNotificationCard,

    withTruncate,

    notificationCardInviteThreadTemplate
) {
    'use strict';

    var parent = ActivityCardView;

    var NotificationCardThreadInviteView = parent.extend({
        className: 'card-notif-invite card-notif-note',

        template: notificationCardInviteThreadTemplate,

        templateHelpers: function () {
            return {
                threadDescription: this.model.thread.getPlainDescription(),
                image: this.model.thread.getImage(),
                numTitleLines: 3,
            };
        },

        initialize: function () {
            this.listenTo(this.model.thread, 'change:content', this.render);
        },

        // By defining this, the asNotificationCard mixin will add in the view/click
        // tracking calls.
        getAnalyticsPayload: function (verb) {
            var thread = this.model.thread;
            var backendId = this.model.activities[0].get('backendId');
            return {
                verb: verb,
                object_type: 'note',
                object_id: backendId,
                note_template_id: backendId,
                note_template_name: ['thread', 'invite', thread.forum.id, thread.get('slug')].join(' '),
            };
        },
    });

    withReason.call(NotificationCardThreadInviteView.prototype);
    asNotificationCard.call(NotificationCardThreadInviteView.prototype);
    withTruncate.call(NotificationCardThreadInviteView.prototype);

    return NotificationCardThreadInviteView;
});

define('home/templates/forumCard',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\"/home/channel/"
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"channel") : depth0)) != null ? lookupProperty(stack1,"slug") : stack1), depth0))
    + "/\"\nclass=\"avatar\"\ndata-link-name=\"forum_avatar\"\ndata-forum-pk=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"pk") : depth0), depth0))
    + "\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"channelAvatarWithDefault"),depth0,{"name":"channelAvatarWithDefault","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</a>\n";
},"3":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = container.invokePartial(lookupProperty(partials,"forumAvatarLink"),depth0,{"name":"forumAvatarLink","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "");
},"5":function(container,depth0,helpers,partials,data) {
    return "<span class=\"label--default -inline\">Creator</span>\n";
},"7":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"sessionUserIsModerator") : depth0),{"name":"if","hash":{},"fn":container.program(8, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":20,"column":0},"end":{"line":23,"column":7}}})) != null ? stack1 : "");
},"8":function(container,depth0,helpers,partials,data) {
    return "<span class=\"label--default -inline\">Moderator</span>\n";
},"10":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"channelDescription") : depth0), depth0))
    + "\n";
},"12":function(container,depth0,helpers,partials,data) {
    var alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"url") : depth0), depth0))
    + "\"\ndata-link-out=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"signedUrl") : depth0), depth0))
    + "\"\nclass=\"link-gray\"\ndata-link-name=\"forum_description\"\ndata-forum-pk=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"pk") : depth0), depth0))
    + "\">"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"url") : depth0), depth0))
    + "</a>\n";
},"14":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if_all").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"sessionUserIsModerator") : depth0),(depth0 != null ? lookupProperty(depth0,"channel") : depth0),{"name":"if_all","hash":{},"fn":container.program(15, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":45,"column":0},"end":{"line":51,"column":11}}})) != null ? stack1 : "");
},"15":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<button class=\"button button-outline -border-muted text-error button-small spacing-right-small\"\ntitle=\""
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Remove Moderator",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":47,"column":7},"end":{"line":47,"column":37}}}))
    + "\"\ndata-action=\"remove-moderator\">\n<span class=\"icon-tiny icon-cancel spacing-right-small\"></span>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Resign",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":49,"column":63},"end":{"line":49,"column":83}}}))
    + "\n</button>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card--user\">\n<div class=\"user-card__block\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"channel") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"data":data,"loc":{"start":{"line":3,"column":0},"end":{"line":12,"column":7}}})) != null ? stack1 : "")
    + "<div class=\"forum-info\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"channelAwareForumLink"),depth0,{"name":"channelAwareForumLink","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"sessionUserIsOwner") : depth0),{"name":"if","hash":{},"fn":container.program(5, data, 0),"inverse":container.program(7, data, 0),"data":data,"loc":{"start":{"line":16,"column":0},"end":{"line":24,"column":7}}})) != null ? stack1 : "")
    + "<p class=\"description truncate-line text-medium\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"channelDescription") : depth0),{"name":"if","hash":{},"fn":container.program(10, data, 0),"inverse":container.program(12, data, 0),"data":data,"loc":{"start":{"line":26,"column":0},"end":{"line":37,"column":7}}})) != null ? stack1 : "")
    + "</p>\n</div>\n</div>\n<div class=\"user-card__button btn-follow--mobile\">\n"
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"sessionUserIsOwner") : depth0),{"name":"unless","hash":{},"fn":container.program(14, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":44,"column":0},"end":{"line":52,"column":11}}})) != null ? stack1 : "")
    + ((stack1 = container.invokePartial(lookupProperty(partials,"genericFollowButton"),depth0,{"name":"genericFollowButton","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/templates/confirmResignModerator',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"modal-header\">\n<h4 class=\"modal-title\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Resign as moderator of %(name)s",{"name":"gettext","hash":{"name":(depth0 != null ? lookupProperty(depth0,"name") : depth0)},"data":data,"loc":{"start":{"line":2,"column":24},"end":{"line":2,"column":81}}}))
    + "</h4>\n</div>\n<div class=\"modal-body\">\n<p>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"You will no longer have moderator priveleges on %(name)s.",{"name":"gettext","hash":{"name":(depth0 != null ? lookupProperty(depth0,"name") : depth0)},"data":data,"loc":{"start":{"line":5,"column":3},"end":{"line":5,"column":86}}}))
    + "</p>\n</div>\n";
},"useData":true})

});
define('home/views/ForumCardView',[
    'underscore',
    'backbone-marionette',
    'home/utils/confirmModal',

    'home/mixins/withChannelAvatar',
    'home/models/Session',
    'home/templates/forumCard',
    'home/templates/confirmResignModerator',
], function (
    _,
    Marionette,
    confirmModal,

    withChannelAvatar,
    Session,
    forumCardTemplate,
    confirmResignModeratorTemplate
) {
    'use strict';

    /**
     * A card that shows a forum or channel. Shows the avatar, title, description,
     * following status, and follow action.
     *
     * Expects a forum model.
     */
    var ForumCardView = Marionette.ItemView.extend({
        template: forumCardTemplate,
        templateHelpers: function () {
            var channel = this.model.channel;

            return {
                sessionUserIsOwner: this.sessionUserIsOwner,
                sessionUserIsModerator: this.sessionUserIsModerator,
                channelDescription: channel && channel.get('options').description,
            };
        },
        className: 'card',

        events: {
            'click [data-action=toggle-follow]': 'toggleFollow',
            'click [data-action=remove-moderator]': 'confirmRemoveModerator',
        },
        modelEvents: {
            'change:isFollowing': 'handleFollowedClass',
        },

        initialize: function () {
            this.session = Session.get();

            // Once session has loaded, show a creator badge if session user is the owner
            // of this forum/channel
            this.session.loadPromise().then(_.bind(this.renderIfOwner, this));

            // Once session has loaded the forums the user moderates, show a mod badge if session
            // user moderates this forum/channel
            this.session.loadModeratedForums().then(_.bind(this.renderModeratorStatus, this));
        },

        renderIfOwner: function () {
            var ownerId = this.model.channel && this.model.channel.get('owner_id');
            var sessionUserId = this.session.user.get('id');
            this.sessionUserIsOwner = ownerId === sessionUserId;

            if (this.sessionUserIsOwner)
                this.render();
        },

        /**
         * Determines if the session user is a moderator. Rerenders this card if the moderator
         * status has changed.
         * ex: rendered before fetch completed to determine user is a moderator.
         * ex: user resigned as a moderator.
         */
        renderModeratorStatus: function () {
            var wasSessionUserModerator = Boolean(this.sessionUserIsModerator);
            var sessionUserModeratedForums = this.session.user.get('moderatedForums');
            this.sessionUserIsModerator = _.contains(sessionUserModeratedForums, this.model.get('id'));

            if (wasSessionUserModerator !== this.sessionUserIsModerator)
                this.render();
        },

        handleFollowedClass: function () {
            this.$('[data-action=toggle-follow]').toggleClass('active', this.model.get('isFollowing'));
        },

        toggleFollow: function (evt) {
            if (evt)
                evt.preventDefault();

            this.model.toggleFollowed();
        },

        confirmRemoveModerator: function (evt) {
            if (evt)
                evt.preventDefault();

            var channel = this.model.channel;

            confirmModal.confirmationPromise(
                confirmModal.TYPES.CONFIRM_CANCEL,
                confirmResignModeratorTemplate(channel.toJSON())
            ).then(_.bind(function (isConfirmed) {
                if (!isConfirmed)
                    return;

                // After user has resigned as moderator, rerender card to remove
                // the moderator tag and the resign button
                this.session.user.moderateChannel(channel, false)
                    .then(_.bind(this.renderModeratorStatus, this));
            }, this));
        },
    });

    withChannelAvatar.call(ForumCardView.prototype, function () {
        return this.model.channel;
    });

    return ForumCardView;
});

define('home/templates/notificationCardChannelInvite',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card__reason\">\n<div class=\"notification__icon -invite\">\n<span class=\"icon-notification-invite text-brand icon-small\"></span>\n</div>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"%(userName)s invited you to check out the channel %(channel)s",{"name":"gettext","hash":{"channel":lookupProperty(helpers,"getPartial").call(alias1,"channelLink",(depth0 != null ? lookupProperty(depth0,"channel") : depth0),{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":5,"column":132},"end":{"line":5,"column":166}}}),"userName":lookupProperty(helpers,"getPartial").call(alias1,"userName",(depth0 != null ? lookupProperty(depth0,"firstActor") : depth0),{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":5,"column":87},"end":{"line":5,"column":121}}})},"data":data,"loc":{"start":{"line":5,"column":0},"end":{"line":5,"column":168}}}))
    + "\n<span class=\"time text-gray\">"
    + alias2(container.lambda((depth0 != null ? lookupProperty(depth0,"relativeTime") : depth0), depth0))
    + "</span>\n</div>\n<div class=\"card__content -notification\" data-role=\"content\">\n</div>\n";
},"useData":true})

});
define('home/views/NotificationCardChannelInviteView',[
    'home/views/ForumCardView',
    'home/views/common/ActivityCardView',

    'home/mixins/withReason',
    'home/mixins/withSubviews',
    'home/mixins/asNotificationCard',
    'home/mixins/withTruncate',
    'home/mixins/withChannelAvatar',

    'home/templates/notificationCardChannelInvite',
], function (
    ForumCardView,
    ActivityCardView,

    withReason,
    withSubviews,
    asNotificationCard,
    withTruncate,
    withChannelAvatar,

    notificationCardChannelInviteTemplate
) {
    'use strict';

    var parent = ActivityCardView;

    /**
     * Returns the channel from the first ChannelInviteActivity rolled
     * up in the ActivityFeedItem model.
     */
    var getChannel = function () {
        return this.model.activities[0].channel;
    };

    /**
     * A notification card showing an invitation to a channel.
     *
     * Expects an ActivityFeedItem model with at least 1 ChannelInviteActivity
     * rolled up.
     */
    var NotificationCardChannelInviteView = parent.extend({
        className: 'card-notif-channel-invite card-notif-note',

        regions: {
            contentRegion: '[data-role=content]',
        },

        template: notificationCardChannelInviteTemplate,
        templateHelpers: function () {
            return {
                channel: getChannel.call(this).toJSON(),
            };
        },

        onRender: function () {
            this.activateRegion(this.contentRegion, this.createContentView);
        },

        createContentView: function () {
            return new ForumCardView({
                model: getChannel.call(this).primaryForum,

                // Override className on ForumCardView (which styles view as a
                // standalone card) since here it's used as a subview
                className: '',
            });
        },

        // By defining this, the asNotificationCard mixin will add in the view/click
        // tracking calls.
        getAnalyticsPayload: function (verb) {
            var channel = getChannel.call(this);
            var backendId = this.model.activities[0].get('backendId');
            return {
                verb: verb,
                object_type: 'note',
                object_id: backendId,
                note_template_id: backendId,
                note_template_name: ['channel', 'invite', channel.id].join(' '),
            };
        },
    });

    withReason.call(NotificationCardChannelInviteView.prototype);
    asNotificationCard.call(NotificationCardChannelInviteView.prototype);
    withTruncate.call(NotificationCardChannelInviteView.prototype);
    withChannelAvatar.call(NotificationCardChannelInviteView.prototype, getChannel);
    withSubviews.call(NotificationCardChannelInviteView.prototype);

    return NotificationCardChannelInviteView;
});

define('home/templates/notificationCardCreate',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    return " has-image";
},"3":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<button\nclass=\"button button-outline -border-muted text-error text-medium spacing-right-small\"\ndata-action=\"delete\">\n<span class=\"icon-tiny icon-cancel spacing-right-small\"></span>\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Delete",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":26,"column":0},"end":{"line":26,"column":20}}}))
    + "\n</button>\n";
},"5":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<span class=\"text-small text-gray\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"This discussion was deleted.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":30,"column":0},"end":{"line":30,"column":42}}}))
    + "\n<a href=\"#\" data-action=\"restore\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Undo",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":31,"column":34},"end":{"line":31,"column":52}}}))
    + "</a>\n</span>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, alias3=container.lambda, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card__reason\">\n<div class=\"notification__icon -new-discussion\">\n<span class=\"icon-create-discussion text-smaller\"></span>\n</div>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"%(userName)s started a discussion on %(parent)s",{"name":"gettext","hash":{"parent":lookupProperty(helpers,"getPartial").call(alias1,"channelAwareForumLink",((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1),{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":6,"column":55},"end":{"line":6,"column":104}}}),"userName":lookupProperty(helpers,"getPartial").call(alias1,"userName",(depth0 != null ? lookupProperty(depth0,"firstActor") : depth0),{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":6,"column":11},"end":{"line":6,"column":45}}})},"data":data,"loc":{"start":{"line":5,"column":0},"end":{"line":6,"column":106}}}))
    + "\n\n<span class=\"time text-gray\">"
    + alias2(alias3((depth0 != null ? lookupProperty(depth0,"relativeTime") : depth0), depth0))
    + "</span>\n</div>\n\n<div class=\"card__content -notification"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"image") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":11,"column":39},"end":{"line":11,"column":69}}})) != null ? stack1 : "")
    + "\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"cardContentImage"),depth0,{"name":"cardContentImage","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "<div class=\"card-content__body\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"threadTitle"),depth0,{"name":"threadTitle","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "<div class=\"card-content__summary text-medium\">\n<div class=\"truncate\" data-truncate-lines=\"3\" dir=\"auto\">\n"
    + alias2(alias3((depth0 != null ? lookupProperty(depth0,"threadDescription") : depth0), depth0))
    + "\n</div>\n</div>\n<div class=\"spacing-top spacing-narrow align\">\n"
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"isDeleted") : stack1),{"name":"unless","hash":{},"fn":container.program(3, data, 0),"inverse":container.program(5, data, 0),"data":data,"loc":{"start":{"line":21,"column":0},"end":{"line":33,"column":11}}})) != null ? stack1 : "")
    + "</div>\n</div>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/NotificationCardCreateView',[
    'home/models/Session',
    'home/views/common/ActivityCardView',
    'home/mixins/withReason',
    'home/mixins/asNotificationCard',
    'home/mixins/withTruncate',

    'home/templates/notificationCardCreate',
], function (
    Session,
    ActivityCardView,
    withReason,
    asNotificationCard,
    withTruncate,

    notificationCardCreateTemplate
) {
    'use strict';

    var parent = ActivityCardView;

    var NotificationCardCreateView = parent.extend({
        className: 'card-notif-create card-notif-invite card-notif-note',

        template: notificationCardCreateTemplate,

        templateHelpers: function () {
            return {
                threadDescription: this.model.thread.getPlainDescription(),
                image: this.model.thread.getImage(),
                numTitleLines: 3,
            };
        },

        events: {
            'click [data-action=delete]': 'deleteThread',
            'click [data-action=restore]': 'restoreThread',
        },

        initialize: function () {
            this.session = Session.get();

            this.listenTo(this.model.thread, 'change:content', this.render);
            this.listenTo(this.model.thread, 'change:isDeleted', this.render);
        },

        deleteThread: function () {
            this.model.thread.confirmDelete(true);
        },

        restoreThread: function () {
            this.model.thread.restore();
        },
    });


    var proto = NotificationCardCreateView.prototype;
    withReason.call(proto);
    asNotificationCard.call(proto);
    withTruncate.call(proto);

    return NotificationCardCreateView;
});

define('core/mixins/withForumFollowing',[
    'underscore',
], function (
    _
) {
    'use strict';

    // Return the mixin properties and functions with a closure around
    // the getForum function, specified on a per-mixin basis
    function getForumFollowButtonWrapperView(getForum) {
        return {
            events: {
                'click [data-action=toggle-follow]': 'toggleFollow',
            },

            initialize: function () {
                this.bindToForum();
            },

            templateHelpers: function () {
                return {
                    isFollowing: this.getIsFollowing(),
                };
            },

            bindToForum: function () {
                var forumModel = getForum.call(this);

                if (!forumModel)
                    return;

                this.listenTo(forumModel, 'change:isFollowing', this.updateFollowedState);
            },

            getIsFollowing: function () {
                var forumModel = getForum.call(this);
                return forumModel && forumModel.get('isFollowing');
            },

            updateFollowedState: function () {
                this.$('[data-action=toggle-follow]').toggleClass('active', this.getIsFollowing());
            },

            toggleFollow: function (evt) {
                if (evt) {
                    evt.preventDefault();
                    evt.stopPropagation();
                }

                var forumModel = getForum.call(this);

                if (!forumModel)
                    return;

                forumModel.toggleFollowed();
                this.trigger('toggled:follow', evt);

            },
        };
    }

    function withForumFollowing(_getForum) {
        // A function to get the forum model for this view. If a special getter
        // is not given, forum is assumed to be the view's model.
        // This is passed to all the ForumFollowButtonWrapperView functions that
        // require the forum model.
        var getForum = _getForum || function () {
            return this.model;
        };

        var ForumFollowButtonWrapperView = getForumFollowButtonWrapperView(getForum);

        this.bindToForum = _.wrap(this.bindToForum, function (_bindToForum) {
            if (_bindToForum)
                _bindToForum.call(this);

            ForumFollowButtonWrapperView.bindToForum.call(this);
        });

        this.initialize = _.wrap(this.initialize, function (_initialize, options) {
            _initialize.call(this, options);
            ForumFollowButtonWrapperView.initialize.call(this, options);
        });

        this.templateHelpers = _.wrap(this.templateHelpers, function (_templateHelpers) {
            var helpers = _.isFunction(_templateHelpers) ?
                _templateHelpers.call(this) :
                _templateHelpers;

            return _.extend(
                ForumFollowButtonWrapperView.templateHelpers.call(this),
                helpers);
        });

        this.events = _.extend({}, ForumFollowButtonWrapperView.events, this.events);

        _.extend(this, _.pick(ForumFollowButtonWrapperView, 'toggleFollow', 'updateFollowedState', 'getIsFollowing'));
    }

    return withForumFollowing;
});

define('home/templates/notificationCardAddMod',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\"/home/channel/"
    + alias2(alias1(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"forum") : depth0)) != null ? lookupProperty(stack1,"channelInfo") : stack1)) != null ? lookupProperty(stack1,"slug") : stack1), depth0))
    + "/\"\nclass=\"avatar\"\ndata-link-name=\"channel_avatar\"\ndata-channel-slug=\""
    + alias2(alias1(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"forum") : depth0)) != null ? lookupProperty(stack1,"channelInfo") : stack1)) != null ? lookupProperty(stack1,"slug") : stack1), depth0))
    + "\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"channelAvatarWithDefault"),depth0,{"name":"channelAvatarWithDefault","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</a>\n<div class=\"forum-info truncate-line\">\n<a class=\"name\"\nhref=\"/home/channel/"
    + alias2(alias1(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"forum") : depth0)) != null ? lookupProperty(stack1,"channelInfo") : stack1)) != null ? lookupProperty(stack1,"slug") : stack1), depth0))
    + "/\"\ndata-link-name=\"channel_name\"\ndata-channel-slug=\""
    + alias2(alias1(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"forum") : depth0)) != null ? lookupProperty(stack1,"channelInfo") : stack1)) != null ? lookupProperty(stack1,"slug") : stack1), depth0))
    + "\">\n\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"channelAwareForumName"),(depth0 != null ? lookupProperty(depth0,"forum") : depth0),{"name":"channelAwareForumName","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</a>\n<p class=\"description truncate-line\">\n"
    + alias2(alias1(((stack1 = ((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"forum") : depth0)) != null ? lookupProperty(stack1,"channelInfo") : stack1)) != null ? lookupProperty(stack1,"options") : stack1)) != null ? lookupProperty(stack1,"description") : stack1), depth0))
    + "\n</p>\n</div>\n";
},"3":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = container.invokePartial(lookupProperty(partials,"forumAvatarLink"),(depth0 != null ? lookupProperty(depth0,"forum") : depth0),{"name":"forumAvatarLink","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "<div class=\"forum-info truncate-line\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"forumLink"),(depth0 != null ? lookupProperty(depth0,"forum") : depth0),{"name":"forumLink","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n";
},"5":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<span class=\"button button-small text-gray-dark\">\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"You've been removed.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":40,"column":0},"end":{"line":40,"column":34}}}))
    + "\n</span>\n";
},"7":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<button class=\"button button-outline -border-muted text-error button-small spacing-right-small\"\ntitle=\""
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Resign as moderator",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":44,"column":7},"end":{"line":44,"column":40}}}))
    + "\"\ndata-action=\"remove-moderator\">\n<span class=\"icon-tiny icon-cancel spacing-right-small\"></span>\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Resign",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":47,"column":0},"end":{"line":47,"column":20}}}))
    + "\n</button>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card__reason\">\n<div class=\"notification__icon\">\n<span class=\"icon-checkmark icon__position text-small text-success\"></span>\n</div>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"%(userNames)s added you as a moderator to %(forum)s",{"name":"gettext","hash":{"forum":lookupProperty(helpers,"getPartial").call(alias1,"channelAwareForumLink",(depth0 != null ? lookupProperty(depth0,"forum") : depth0),{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":5,"column":116},"end":{"line":5,"column":158}}}),"userNames":lookupProperty(helpers,"getPartial").call(alias1,"userGroupNames",{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":5,"column":78},"end":{"line":5,"column":107}}})},"data":data,"loc":{"start":{"line":5,"column":0},"end":{"line":5,"column":160}}}))
    + "\n<span class=\"time text-gray\">"
    + alias2(container.lambda((depth0 != null ? lookupProperty(depth0,"relativeTime") : depth0), depth0))
    + "</span>\n</div>\n<div class=\"card__content -notification\">\n<div class=\"card--user\">\n<div class=\"user-card__block -add-mod\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"forum") : depth0)) != null ? lookupProperty(stack1,"channelInfo") : stack1),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"data":data,"loc":{"start":{"line":11,"column":0},"end":{"line":35,"column":7}}})) != null ? stack1 : "")
    + "</div>\n<div data-role=\"channel-actions\" class=\"user-card__button btn-follow--mobile\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"resigned") : depth0),{"name":"if","hash":{},"fn":container.program(5, data, 0),"inverse":container.program(7, data, 0),"data":data,"loc":{"start":{"line":38,"column":0},"end":{"line":49,"column":7}}})) != null ? stack1 : "")
    + ((stack1 = container.invokePartial(lookupProperty(partials,"genericFollowButton"),depth0,{"name":"genericFollowButton","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n</div>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/NotificationCardAddModView',[
    'underscore',

    'home/models/Session',
    'home/views/common/ActivityCardView',
    'home/mixins/withReason',
    'home/mixins/asNotificationCard',
    'home/mixins/withChannelAvatar',
    'core/mixins/withForumFollowing',
    'home/utils/confirmModal',
    'home/templates/notificationCardAddMod',
    'home/templates/confirmResignModerator',
], function (
    _,

    Session,
    ActivityCardView,
    withReason,
    asNotificationCard,
    withChannelAvatar,
    withForumFollowing,
    confirmModal,
    notificationCardAddModTemplate,
    confirmResignModeratorTemplate
) {
    'use strict';

    var parent = ActivityCardView;


    /**
     * A notification card when the session user has been added as a moderator to a channel or forum.
     * Shows the channels/forums and appropriate actions (ex: (un)follow channel/forum, (un)moderate channel/forum).
     *
     * Expects an ActivityFeedItem as a model. Only displays the first activity, which should have
     * a Forum as the target.
     */
    var NotificationCardAddModView = parent.extend({
        className: 'card-notif-add-mod',

        events: {
            'click [data-action=remove-moderator]': 'confirmRemoveModerator',
        },

        initialize: function () {
            this.session = Session.get();
            this.forum = this.getForum();
            this.channel = this.forum.channel;

            // Re render after fetching user's moderated forums so we can show
            // whether or not the user is still a moderator for this channel or forum
            this.session.loadModeratedForums().then(_.bind(this.render, this));
        },

        template: notificationCardAddModTemplate,
        templateHelpers: function () {
            return {
                forum: this.forum.toJSON(),
                resigned: !this.sessionUserIsModerator(),
            };
        },

        sessionUserIsModerator: function () {
            return _.contains(this.session.user.get('moderatedForums'), this.forum.id);
        },

        confirmRemoveModerator: function (evt) {
            if (evt)
                evt.preventDefault();

            var channelOrForumName = this.channel && this.channel.attributes.name || this.forum.attributes.name;

            confirmModal.confirmationPromise(
                confirmModal.TYPES.CONFIRM_CANCEL,
                confirmResignModeratorTemplate({ name: channelOrForumName })
            ).then(_.bind(this.removeModerator, this));
        },

        removeModerator: function (isConfirmed) {
            if (!isConfirmed)
                return;

            if (this.channel) {
                this.session.user.moderateChannel(this.channel, false)
                    .then(_.bind(this.render, this));
            }
            else {
                this.session.user.moderateForum(this.forum, false)
                    .then(_.bind(this.render, this));
            }
        },

        getForum: function () {
            // Add Mod activities shouldn't be grouped, so just use the forum
            // from the first activity
            return this.model.activities[0].target;
        },
    });


    var proto = NotificationCardAddModView.prototype;
    withReason.call(proto);
    asNotificationCard.call(proto);

    var getChannel = function () {
        return this.forum && this.forum.channel;
    };

    var getForum = function () {
        return this.forum;
    };

    withChannelAvatar.call(proto, getChannel);

    withForumFollowing.call(proto, getForum);

    return NotificationCardAddModView;
});

define('home/templates/notificationCardHighlightPost',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card__reason\">\n<div class=\"notification__icon text-brand\">\n<span class=\"icon-trophy text-smaller text-warning\"></span>\n</div>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"%(name)s featured your comment on %(thread)s",{"name":"gettext","hash":{"thread":lookupProperty(helpers,"getPartial").call(alias1,"threadLink",{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":6,"column":110},"end":{"line":6,"column":135}}}),"name":lookupProperty(helpers,"getPartial").call(alias1,"cardTitleInlineName",{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":6,"column":66},"end":{"line":6,"column":100}}})},"data":data,"loc":{"start":{"line":6,"column":0},"end":{"line":6,"column":137}}}))
    + "\n\n<span class=\"time text-gray\">"
    + alias2(container.lambda((depth0 != null ? lookupProperty(depth0,"relativeTime") : depth0), depth0))
    + "</span>\n</div>\n<div class=\"card__content -notification\">\n<div data-role=\"post\"></div>\n</div>\n";
},"useData":true})

});
define('home/views/NotificationCardHighlightPostView',[
    'home/views/common/NotificationCardPostView',
    'home/templates/notificationCardHighlightPost',
], function (
    NotificationCardPostView,
    notificationCardHighlightPostTemplate
) {
    'use strict';

    var parent = NotificationCardPostView;

    var NotificationCardHighlightPostView = parent.extend({
        // See NotificationCardHighlightPostView.className for documentation
        childClassName: 'card-notif-highlight',

        template: notificationCardHighlightPostTemplate,

        getPost: function (activity) {
            return activity.target;
        },
    });

    return NotificationCardHighlightPostView;
});

define('home/templates/notificationCardMention',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card__reason\">\n<div class=\"notification__icon -reply\">\n<span class=\"icon-mention text-brand icon-small\"></span>\n</div>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"%(userName)s mentioned you on %(thread)s",{"name":"gettext","hash":{"thread":lookupProperty(helpers,"getPartial").call(alias1,"threadLink",{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":5,"column":110},"end":{"line":5,"column":135}}}),"userName":lookupProperty(helpers,"getPartial").call(alias1,"userName",(depth0 != null ? lookupProperty(depth0,"firstActor") : depth0),{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":5,"column":66},"end":{"line":5,"column":100}}})},"data":data,"loc":{"start":{"line":5,"column":0},"end":{"line":5,"column":137}}}))
    + "\n\n<span class=\"time text-gray\">"
    + alias2(container.lambda((depth0 != null ? lookupProperty(depth0,"relativeTime") : depth0), depth0))
    + "</span>\n</div>\n<div class=\"card__content -notification\">\n<div class=\"card-comment\" data-role=\"post\"></div>\n</div>\n";
},"useData":true})

});
define('home/views/NotificationCardMentionView',[
    'home/views/common/NotificationCardPostView',
    'home/templates/notificationCardMention',
], function (
    NotificationCardPostView,
    notificationCardMentionTemplate
) {
    'use strict';

    var parent = NotificationCardPostView;

    /**
     * @augments NotificationCardPostView
     */
    var NotificationCardMentionView = parent.extend({
        childClassName: 'card-notif-channel-post',

        template: notificationCardMentionTemplate,

        getPost: function (activity) {
            return activity.target;
        },
    });

    return NotificationCardMentionView;
});

define('home/templates/notificationFeedEmpty',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"empty-message\">\n\n<svg class=\"art-empty-notifications\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" version=\"1.1\" x=\"0px\" y=\"0px\" viewBox=\"0 0 164.8 50\" enable-background=\"new 0 0 164.8 50\" xml:space=\"preserve\"><path d=\"M0 11h13.7v3.6H0V11z\" class=\"arm\"/><path d=\"M15.4 11h4.2l18.1 37h-4.2L15.4 11z\" class=\"arm\"/><path d=\"M39 44.2h24.2V48H39V44.2z\" class=\"arm\"/><path d=\"M101.6 44.2h24.2V48h-24.2V44.2z\" class=\"arm\"/><path d=\"M145 11h4.2l-18.1 37h-4.2L145 11z\" class=\"arm\"/><path d=\"M151.1 11h13.7v3.6h-13.7V11z\" class=\"arm\"/><path d=\"M57.9 25c0-13.8 11.2-25 25-25s25 11.2 25 25s-11.2 25-25 25 S57.9 38.8 57.9 25z\" class=\"body\"/><path d=\"M71.1 20.7C71.8 26.5 76.8 31 82.9 31s11-4.5 11.8-10.3c-2.3 2.2-6.7 3-11.8 3S73.4 22.9 71.1 20.7z\" class=\"mouth\"/><path d=\"M63.3 16c0-2.1 1.8-3.9 4-3.9c2.2 0 4 1.7 4 3.9s-1.8 3.9-4 3.9 C65.1 19.9 63.3 18.1 63.3 16z\" class=\"eye\"/><path d=\"M94.4 15.6c0-2.1 1.8-3.8 4-3.8c2.2 0 4 1.7 4 3.8 c0 2.1-1.8 3.8-4 3.8C96.2 19.5 94.4 17.8 94.4 15.6z\" class=\"eye\"/></svg>\n\n<div class=\"notifications-empty-headline\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"No Notifications",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":7,"column":42},"end":{"line":7,"column":72}}}))
    + "</div>\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"You must be new. Or quiet.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":8,"column":0},"end":{"line":8,"column":40}}}))
    + "\n</div>\n";
},"useData":true})

});
define('home/views/NotificationFeedEmptyView',[
    'backbone-marionette',
    'home/templates/notificationFeedEmpty',
], function (
    Marionette,
    notificationFeedEmptyTemplate
) {
    'use strict';

    var NotificationFeedEmptyView = Marionette.ItemView.extend({
        template: notificationFeedEmptyTemplate,
    });

    return NotificationFeedEmptyView;
});

define('home/views/NotificationCardCollectionView',[
    'underscore',

    'core/bus',

    'home/views/ActivityCardCollectionView',
    'home/views/NotificationCardChannelPostView',
    'home/views/NotificationCardUpvoteView',
    'home/views/NotificationCardChannelRecommendView',
    'home/views/NotificationCardReplyView',
    'home/views/NotificationCardFollowView',
    'home/views/NotificationCardAnnouncementView',
    'home/views/NotificationCardThreadInviteView',
    'home/views/NotificationCardChannelInviteView',
    'home/views/NotificationCardCreateView',
    'home/views/NotificationCardAddModView',
    'home/views/NotificationCardHighlightPostView',
    'home/views/NotificationCardMentionView',
    'home/views/NotificationFeedEmptyView',
], function (
    _,

    coreBus,

    ActivityCardCollectionView,
    NotificationCardChannelPostView,
    NotificationCardUpvoteView,
    NotificationCardChannelRecommendView,
    NotificationCardReplyView,
    NotificationCardFollowView,
    NotificationCardAnnouncementView,
    NotificationCardThreadInviteView,
    NotificationCardChannelInviteView,
    NotificationCardCreateView,
    NotificationCardAddModView,
    NotificationCardHighlightPostView,
    NotificationCardMentionView,
    NotificationFeedEmptyView
) {
    'use strict';

    var NotificationCardCollectionView = ActivityCardCollectionView.extend({
        itemView: function (options) {
            var ItemView = NotificationCardCollectionView.ITEM_VIEWS[options.model.get('verb')];

            if (ItemView)
                return new ItemView({ model: options.model });
        },

        emptyView: NotificationFeedEmptyView,

        initialize: function () {
            ActivityCardCollectionView.prototype.initialize.apply(this, arguments);
            this.listenTo(this, 'after:item:added', this.onShowNotification);

            // TODO: Marionette _should_ have an event that occurs after all rendering is done,
            // but couldn't figure out how to get working atm
            var debouncedMessage = _.debounce(_.bind(coreBus.trigger, coreBus, 'after:render'), 100);
            this.listenTo(this, 'after:item:added', debouncedMessage);

            this.listenToOnce(this, 'showFirstItem', function () {
                coreBus.trigger('showFirstCard', 'notifications');
            });
        },

        /*
         * When the first notification is shown, clears the count of unread
         * notifications.
         */
        onShowNotification: function (view) {
            // Only clear for the first view
            // This covers the case where items are added later into the
            // collection view via the Show N New Items button
            if (!view.model ||
                view.model !== this.collection.at(0))
                return;

            this.model.trigger('clearUnreadCount');
        },
    }, {
        ITEM_VIEWS: {
            'favorite': NotificationCardUpvoteView,
            'reply': NotificationCardReplyView,
            'follow': NotificationCardFollowView,
            'send': NotificationCardAnnouncementView,
            'threadInvite': NotificationCardThreadInviteView,
            'channelInvite': NotificationCardChannelInviteView,
            'create': NotificationCardCreateView,
            'recommend': NotificationCardChannelRecommendView,
            'channel-post': NotificationCardChannelPostView,
            'add-mod': NotificationCardAddModView,
            'highlight': NotificationCardHighlightPostView,
            'mention': NotificationCardMentionView,
        },
    });

    return NotificationCardCollectionView;
});

define('home/templates/notifications',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"nav-notifs-settings dropdown\" data-action=\"toggle-dropdown\" data-dropdown=\"notif-settings\">\n<a href=\"/home/settings/web/\" title=\""
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Control what notifications you see from %(Disqus)s.",{"name":"gettext","hash":{"Disqus":"Disqus"},"data":data,"loc":{"start":{"line":50,"column":37},"end":{"line":50,"column":120}}}))
    + "\">\n<span class=\"icon-cog\"></span>\n</a>\n<div class=\"dropdown-menu dropdown-notifs-settings\">\n<header class=\"dropdown-notifs-settings-header\">\n<h6>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Control Your Inbox",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":55,"column":4},"end":{"line":55,"column":36}}}))
    + "</h6>\n<p>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Use these settings to control what notifications you see from %(disqus)s. To change email notifications click %(here)s.",{"name":"gettext","hash":{"here":lookupProperty(helpers,"tag").call(alias1,"a",{"name":"tag","hash":{"text":lookupProperty(helpers,"gettext").call(alias1,"here",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":56,"column":219},"end":{"line":56,"column":235}}}),"data-action":"notification-settings","href":"#"},"data":data,"loc":{"start":{"line":56,"column":160},"end":{"line":56,"column":236}}}),"disqus":"Disqus"},"data":data,"loc":{"start":{"line":56,"column":3},"end":{"line":56,"column":238}}}))
    + "</a></p>\n</header>\n<ul class=\"dropdown-notifs-settings-options\">\n<li class=\"dropdown-notifs-settings-option\">\n<label><input data-action=\"filter-toggle\" data-filter=\"likepost\" type=\"checkbox\" name=\"upvotes\" value=\"upvotes\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Hide upvotes",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":60,"column":112},"end":{"line":60,"column":138}}}))
    + "</label>\n</li>\n<li class=\"dropdown-notifs-settings-option\">\n<label><input data-action=\"filter-toggle\" data-filter=\"invite\" type=\"checkbox\" name=\"invite\" value=\"invite\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Hide invitations",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":63,"column":108},"end":{"line":63,"column":138}}}))
    + "</label>\n</li>\n</ul>\n</div>\n</div>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div data-role=\"motd-alert\"></div>\n<div class=\"section-contained\">\n<div class=\"layout layout--tablet-no-aside\">\n<div class=\"layout__main-with-aside\">\n<div class=\"layout__nav\">\n<ul class=\"nav--no-aside\">\n<li data-action=\"switch-tab\" data-tab=\"all\" class=\"nav__item active\">\n<a href=\"/home/inbox/\" class=\"nav-lnk -color-muted truncate-line\">\n<div class=\"nav-lnk__blk\">\n<span class=\"nav-lnk__icon icon icon-recent\"></span>\n<span class=\"button__text\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Most Recent",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":11,"column":27},"end":{"line":11,"column":52}}}))
    + "</span>\n</div>\n<div class=\"nav-lnk__pointer\">\n<span class=\"icon icon-right-bracket\"></span>\n</div>\n</a>\n</li>\n<li data-action=\"switch-tab\" data-tab=\"replies\" class=\"nav__item\">\n<a href=\"/home/inbox/replies/\" class=\"nav-lnk -color-muted truncate-line\">\n<div class=\"nav-lnk__blk\">\n<span class=\"nav-lnk__icon icon icon-replies\"></span>\n<span class=\"button__text\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Replies",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":22,"column":27},"end":{"line":22,"column":48}}}))
    + "</span>\n</div>\n<div class=\"nav-lnk__pointer\">\n<span class=\"icon icon-right-bracket\"></span>\n</div>\n</a>\n</li>\n<li class=\"nav__spacing hidden-md\"></li>\n<li class=\"nav__item\">\n<a href=\"/home/settings/web/\" class=\"nav-lnk -color-muted truncate-line\">\n<div class=\"nav-lnk__blk\">\n<span class=\"nav-lnk__icon icon icon-settings\"></span>\n<span class=\"button__text\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Settings",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":34,"column":27},"end":{"line":34,"column":49}}}))
    + "</span>\n</div>\n<div class=\"nav-lnk__pointer\">\n<span class=\"icon icon-right-bracket\"></span>\n</div>\n</a>\n</li>\n</ul>\n</div>\n<div class=\"layout__content\">\n<div data-role=\"email-verification-alert\"></div>\n<div class=\"nav-notifs sidebar-fixed notifs-fixed visible-sidebar\">\n<div class=\"nav-notifs-body\">\n<h2 class=\"nav-notifs-title\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Notifications",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":47,"column":29},"end":{"line":47,"column":56}}}))
    + "</h2>\n"
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"isLoggedOut") : depth0),{"name":"unless","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":48,"column":0},"end":{"line":68,"column":11}}})) != null ? stack1 : "")
    + "<div class=\"nav-notifs-refresh\">\n<a class=\"nav-refresh\" data-action=\"refresh-drawer\" href=\"#\">\n<svg class=\"icon-refresh\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" version=\"1.1\" x=\"0px\" y=\"0px\" viewBox=\"338.2 -95.3 790.6 790.6\" enable-background=\"new 338.2 -95.3 790.6 790.6\" xml:space=\"preserve\"><path d=\"M976.8 454.2l152-172.8h-98.9c-4.7-74.4-35.9-143.6-88.7-195.9C885.7 30.3 812.4 0 734.8 0 C571.7 0 439.1 134.5 439.1 300s132.6 300 295.7 300c66.2 0 131-22.5 182.5-63.4l9.3-7.4l-63.9-69.6l-8 6.1 c-34.7 26.3-76.1 40.2-119.8 40.2c-111.8 0-202.6-92.4-202.6-206S623 94.2 734.8 94.2c52.5 0 102.3 20.6 140.3 57.8 c35.3 34.7 56.6 80.3 60.6 129.4H823.5L976.8 454.2z\"/></svg>\n</a>\n</div>\n</div>\n<ul class=\"nav-tabs\">\n<li class=\"active\" data-action=\"switch-tab\" data-tab=\"all\">\n<a class=\"truncate-line\" href=\"/home/inbox/\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Most Recent",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":78,"column":0},"end":{"line":78,"column":25}}}))
    + "\n</a>\n</li>\n<li data-action=\"switch-tab\" data-tab=\"replies\">\n<a class=\"truncate-line\" href=\"/home/inbox/replies/\"><span class=\"icon-forward\"></span>\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Replies",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":83,"column":0},"end":{"line":83,"column":21}}}))
    + "\n</a>\n</li>\n</ul>\n</div>\n<div class=\"sidebar-scrollable notifs-scrollable scrollable-measure-selector\"\ndata-role=\"content-area\"></div>\n</div>\n</div>\n<aside class=\"layout__aside hidden-lg\">\n<div data-role=\"recommend-module\" data-recommend-type=\"user\" data-jester-area=\"recommended-users\" class=\"module--aside\"></div>\n<div data-role=\"recommend-module\" data-recommend-type=\"forum\" data-jester-area=\"recommended-forums\" class=\"module--aside\"></div>\n<div class=\"text-smaller text-gray\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"homeFooter"),depth0,{"name":"homeFooter","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n</aside>\n</div>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/NotificationsView',[
    'underscore',

    'home/utils/sidebarUtils',

    'home/views/common/TabbedView',
    'home/views/common/FetchableCollectionLayout',
    'home/views/NotificationCardCollectionView',
    'home/views/MotdAlertView',
    'home/views/RecommendationsModuleView',

    'home/templates/notifications',
    'home/mixins/withClickLinkTracking',
    'home/mixins/withEmailVerificationAlert',
], function (
    _,

    sidebarUtils,

    TabbedView,
    FetchableCollectionLayout,
    NotificationCardCollectionView,
    MotdAlertView,
    RecommendationsModuleView,

    notificationsTemplate,
    withClickLinkTracking,
    withEmailVerificationAlert
) {
    'use strict';

    var NotificationsView = TabbedView.extend({
        defaultTab: 'all',
        template: notificationsTemplate,

        events: _.defaults({
            'click a[data-link-name]': 'trackClickLink',
        }, TabbedView.prototype.events),

        regions: _.defaults({
            recommendedUsersModuleRegion: '[data-role=recommend-module][data-recommend-type=user]',
            recommendedForumsModuleRegion: '[data-role=recommend-module][data-recommend-type=forum]',
            motdAlertRegion: '[data-role=motd-alert]',
        }, TabbedView.prototype.regions),

        onDomRefresh: function () {
            TabbedView.prototype.onDomRefresh.call(this);

            if (!this.options.onboardingWithoutChannels) {
                this.recommendedUsersModuleRegion.show(
                    RecommendationsModuleView.createUserRecommendedModuleView({ model: this.model.interestingUsers })
                );
                this.recommendedForumsModuleRegion.show(
                    RecommendationsModuleView.createForumRecommendedModuleView({ model: this.model.interestingForums })
                );
            }

            if (!this.options.disableMOTD)
                this.motdAlertRegion.show(new MotdAlertView());
        },

        getTrackingSection: function (activeTab) {
            // Return nothing for default tab
            return activeTab === 'replies' && activeTab;
        },

        getMetaAttrs: function () {
            return 'Notifications';
        },

        getTabView: function (activeTab) {
            var feed = this.model[activeTab];

            if (!feed)
                return;

            return new FetchableCollectionLayout({
                model: feed,
                collection: feed.get('items'),
                fetchableCollectionView: NotificationCardCollectionView,
                infiniteScroll: true,
            });
        },
    });

    withClickLinkTracking.call(NotificationsView.prototype);

    // don't show email verification if in sidebar
    if (!sidebarUtils.isSidebar())
        withEmailVerificationAlert.call(NotificationsView.prototype);

    return NotificationsView;
});

define('home/templates/notificationCardLogin',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card-wrap card--notification\">\n<div class=\"card__reason\">\n<div class=\"notification__icon\">\n<span class=\"icon icon-megaphone icon__position\"></span>\n</div>\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"%(disqus)s Announcement",{"name":"gettext","hash":{"disqus":"Disqus"},"data":data,"loc":{"start":{"line":6,"column":0},"end":{"line":6,"column":55}}}))
    + "\n</div>\n\n<div class=\"card__content -notification has-image\">\n<a href=\"#\" class=\"card-content__media\" data-action=\"login\">\n<div style=\"background-image: url("
    + alias2(lookupProperty(helpers,"urlfor").call(alias1,"cdn",{"name":"urlfor","hash":{},"data":data,"loc":{"start":{"line":11,"column":34},"end":{"line":11,"column":50}}}))
    + "/img/notifications_logged_out.png)\" class=\"img-cards\"></div>\n</a>\n\n<div class=\"card-content__body\">\n<h2 class=\"discussion-title\" dir=\"auto\">\n<a href=\"#\" data-action=\"login\" class=\"link-gray-darker truncate\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Get more with a %(disqus)s account!",{"name":"gettext","hash":{"disqus":"Disqus"},"data":data,"loc":{"start":{"line":17,"column":0},"end":{"line":17,"column":67}}}))
    + "\n</a>\n</h2>\n<div class=\"card-content__summary\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Signing up means that you'll now be able to find old comments, discover new discussions, and get notified when someone replies to you.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":21,"column":0},"end":{"line":21,"column":148}}}))
    + "\n</div>\n<div class=\"spacing-top spacing-bottom\">\n<button data-action=\"login\" class=\"button button-fill--brand text-medium\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Log In or Sign Up",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":25,"column":0},"end":{"line":25,"column":31}}}))
    + "\n</button>\n</div>\n</div>\n</div>\n</div>\n";
},"useData":true})

});
define('home/views/NotificationCardLoginView',[
    'backbone-marionette',
    'home/templates/notificationCardLogin',
    'home/utils/navigationUtils',
], function (
    Marionette,
    notificationCardLoginTemplate,
    NavigationUtils
) {
    'use strict';

    var NotificationCardLoginView = Marionette.ItemView.extend({
        className: 'card-notif-invite card-notif-note',

        events: {
            'click [data-action=login]': 'navigateToLogin',
        },

        template: notificationCardLoginTemplate,

        navigateToLogin: function (evt) {
            if (evt)
                evt.preventDefault();

            NavigationUtils.navigateToLogin();
        },
    });

    return NotificationCardLoginView;
});

define('home/views/NotificationsLoggedOutView',[
    'underscore',

    'home/views/NotificationsView',
    'home/views/NotificationCardLoginView',

], function (
    _,

    NotificationsView,
    NotificationCardLoginView
) {
    'use strict';

    var NotificationsLoggedOutView = NotificationsView.extend({
        templateHelpers: function () {
            var templateHelpers = NotificationsView.prototype.templateHelpers;
            return _.defaults({
                isLoggedOut: true,
            }, _.isFunction(templateHelpers) ? templateHelpers.call(this) : templateHelpers);
        },

        getTabView: function () {
            return new NotificationCardLoginView();
        },
    });

    return NotificationsLoggedOutView;
});

define('home/templates/forumView',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, alias3=container.lambda, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"section-expanded sidebar-fixed\">\n<div class=\"cover cover-forum\" data-role=\"cover-area\"></div>\n</div>\n<div class=\"section-contained\">\n<div class=\"layout\">\n<div class=\"layout__main-with-aside\">\n<div class=\"layout__nav hidden-sidebar\">\n<ul class=\"nav--aside\">\n<li data-action=\"switch-tab\" data-tab=\"recent\" class=\"nav__item\">\n<a title=\""
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Latest Discussions",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":10,"column":10},"end":{"line":10,"column":42}}}))
    + "\" class=\"truncate-line nav-lnk -color-muted\"\nhref=\"/home/forum/"
    + alias2(alias3((depth0 != null ? lookupProperty(depth0,"id") : depth0), depth0))
    + "/\">\n<div class=\"nav-lnk__blk\">\n<span class=\"button__text\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Latest Discussions",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":13,"column":27},"end":{"line":13,"column":59}}}))
    + "</span>\n</div>\n<div class=\"nav-lnk__pointer\">\n<span class=\"icon icon-right-bracket\"></span>\n</div>\n\n</a>\n</li>\n<li data-action=\"switch-tab\" data-tab=\"commenters\" class=\"nav__item\">\n<a title=\""
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Top Commenters",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":22,"column":10},"end":{"line":22,"column":38}}}))
    + "\" class=\"truncate-line nav-lnk -color-muted\"\nhref=\"/home/forum/"
    + alias2(alias3((depth0 != null ? lookupProperty(depth0,"id") : depth0), depth0))
    + "/commenters/\">\n<div class=\"nav-lnk__blk\">\n<span class=\"button__text\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Top Commenters",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":25,"column":27},"end":{"line":25,"column":55}}}))
    + "</span>\n</div>\n<div class=\"nav-lnk__pointer\">\n<span class=\"icon icon-right-bracket\"></span>\n</div>\n</a>\n</li>\n</ul>\n</div>\n<div class=\"layout__content\">\n<div class=\"sidebar-scrollable forum-scrollable scrollable-measure-selector\"\ndata-role=\"content-area\"></div>\n</div>\n</div>\n<aside class=\"layout__aside hidden-md\">\n<div data-role=\"sign-up-module\"></div>\n<div data-role=\"recommend-module\" data-recommend-type=\"forum\" data-jester-area=\"recommended-forums\" class=\"module--aside\"></div>\n<div data-role=\"recommend-module\" data-recommend-type=\"user\" data-jester-area=\"recommended-users\" class=\"module--aside\"></div>\n<div class=\"text-smaller text-gray\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"homeFooter"),depth0,{"name":"homeFooter","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n</aside>\n</div>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/mixins/asForumProfileCard',[
    'underscore',

    'home/utils/layoutUtils',
    'home/mixins/withTruncate',
    'home/mixins/withThreadCardDefaultFooter',
], function (
    _,

    layoutUtils,
    withTruncate,
    withThreadCardDefaultFooter
) {
    'use strict';

    var asForumProfileCard = function () {
        withTruncate.apply(this, arguments);
        withThreadCardDefaultFooter.apply(this, arguments);

        this.initialize = _.wrap(this.initialize, function (_initialize) {
            _initialize.apply(this, _.rest(arguments));

            var listenable = this.model.thread || this.model;
            this.listenTo(listenable, 'change:content', this.render);

            this.numTitleLines = 3;
        });

        this.serializeData = _.wrap(this.serializeData, function (_serializeData) {
            var data = _serializeData.apply(this, _.rest(arguments));
            var thread = this.model.thread || this.model;

            return _.defaults(data, {
                image: thread.getImage(),
                canShowThreadImage: !layoutUtils.isNarrowLayout(),
                thread: thread.toJSON(),
                numTitleLines: this.numTitleLines,
            });
        });
    };

    return asForumProfileCard;
});

define('home/templates/forumProfileCardRecent',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    return " no-image";
},"3":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"image") : depth0),{"name":"if","hash":{},"fn":container.program(4, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":4,"column":0},"end":{"line":13,"column":7}}})) != null ? stack1 : "");
},"4":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"link") : stack1), depth0))
    + "\"\nclass=\"discussion-image\"\ndata-link-name=\"image\"\ndata-link-out=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"signedLink") : stack1), depth0))
    + "\"\ndata-thread-id=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + "\">\n\n<img src=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"image") : depth0)) != null ? lookupProperty(stack1,"src") : stack1), depth0))
    + "\" alt=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"image") : depth0)) != null ? lookupProperty(stack1,"title") : stack1), depth0))
    + "\">\n</a>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, alias3=container.lambda, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card-discussion"
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"image") : depth0),{"name":"unless","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":1,"column":27},"end":{"line":1,"column":64}}})) != null ? stack1 : "")
    + "\">\n<div class=\"card-aside\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"canShowThreadImage") : depth0),{"name":"if","hash":{},"fn":container.program(3, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":3,"column":0},"end":{"line":14,"column":7}}})) != null ? stack1 : "")
    + "</div>\n<div class=\"card-body\">\n<div class=\"card-reason\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Recent activity",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":18,"column":0},"end":{"line":18,"column":29}}}))
    + " "
    + alias2(alias3((depth0 != null ? lookupProperty(depth0,"relativeTime") : depth0), depth0))
    + "\n</div>\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"threadTitle"),depth0,{"name":"threadTitle","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "<div class=\"card-summary\">\n<div class=\"card-summary-content truncate\" data-truncate-lines=\"2\" dir=\"auto\">\n"
    + ((stack1 = alias3((depth0 != null ? lookupProperty(depth0,"threadDescriptionHTML") : depth0), depth0)) != null ? stack1 : "")
    + "\n</div>\n</div>\n<footer class=\"card-footer\" data-role=\"footer\"></div>\n</div>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/ForumProfileCardRecentView',[
    'underscore',

    'home/views/common/ActivityCardView',
    'home/mixins/asForumProfileCard',

    'home/templates/forumProfileCardRecent',
], function (
    _,

    ActivityCardView,
    asForumProfileCard,

    forumProfileCardRecentTemplate
) {
    'use strict';

    var parent = ActivityCardView;
    var parentProto = parent.prototype;


    var ForumProfileCardRecentView = parent.extend({
        className: 'card card-profile card-profile-forum',
        template: forumProfileCardRecentTemplate,

        serializeData: function () {
            var data = parentProto.serializeData.apply(this, arguments);
            var thread = this.model.thread;

            return _.defaults(data, {
                relativeTime: this.model.getRelativeTimestamp(),
                target: this.model.activities[0].target.toJSON(),
                threadDescriptionHTML: thread.getDefaultDescription(),
            });
        },
    });

    asForumProfileCard.call(ForumProfileCardRecentView.prototype);

    return ForumProfileCardRecentView;
});

define('home/views/ForumProfileCardCollectionView',[
    'home/views/common/FetchableCollectionView',
    'home/views/ForumProfileCardRecentView',

    'home/mixins/withViewFeedTracking',
], function (
    FetchableCollectionView,
    ForumProfileCardRecentView,

    withViewFeedTracking
) {
    'use strict';

    var ForumProfileCardCollectionView = FetchableCollectionView.extend({
        className: 'cards',

        itemView: ForumProfileCardRecentView,
    });

    withViewFeedTracking.call(ForumProfileCardCollectionView.prototype);

    return ForumProfileCardCollectionView;
});

define('home/templates/forumCover',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<p class=\"cover-description\">\n"
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"plainDescription") : depth0), depth0))
    + "\n</p>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, alias3=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"section-contained\">\n<div class=\"cover-body\">\n<div class=\"cover-body-left\">\n<div class=\"cover-profile-content\" dir=\"auto\">\n<div class=\"cover-profile-name-wrapper\">\n<a href=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"url") : depth0), depth0))
    + "\" data-link-out=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"signedUrl") : depth0), depth0))
    + "\"><img class=\"cover-favicon\" src=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"faviconImage") : depth0), depth0))
    + "\" alt=\""
    + ((stack1 = container.invokePartial(lookupProperty(partials,"forumName"),depth0,{"name":"forumName","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "\"></a>\n<a href=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"url") : depth0), depth0))
    + "\" data-link-out=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"signedUrl") : depth0), depth0))
    + "\"><h1 class=\"cover-profile-name truncate-line\">"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"forumName"),depth0,{"name":"forumName","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</h1></a>\n<div class=\"cover-profile-action\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"genericFollowButton"),depth0,{"name":"genericFollowButton","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n</div>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias3,(depth0 != null ? lookupProperty(depth0,"plainDescription") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":12,"column":0},"end":{"line":16,"column":7}}})) != null ? stack1 : "")
    + "<ul class=\"cover-attributes\">\n<li class=\"cover-attribute\">\n<a href=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"url") : depth0), depth0))
    + "\" data-link-out=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"signedUrl") : depth0), depth0))
    + "\">"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"friendlyUrl") : depth0), depth0))
    + "</a>\n</li>\n</ul>\n<div class=\"cover-profile-action-mobile\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"genericFollowButton"),depth0,{"name":"genericFollowButton","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n</div>\n</div>\n</div>\n</div>\n<div class=\"cover-nav-wrapper visible-sidebar\">\n<div class=\"section-contained\">\n<nav class=\"cover-nav cover-nav-profile-user\">\n<ul class=\"cover-nav-options\">\n<li class=\"cover-nav-option active\" data-action=\"switch-tab\" data-tab=\"recent\">\n<a title=\""
    + alias2(lookupProperty(helpers,"gettext").call(alias3,"Latest Discussions",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":34,"column":10},"end":{"line":34,"column":42}}}))
    + "\" class=\"truncate-line\" href=\"/home/forum/"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"id") : depth0), depth0))
    + "/\">\n<span class=\"hidden-md\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias3,"Latest Discussions",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":35,"column":24},"end":{"line":35,"column":56}}}))
    + "</span>\n<span class=\"visible-md\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias3,"Latest",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":36,"column":25},"end":{"line":36,"column":45}}}))
    + "</span>\n</a>\n</li>\n<li class=\"cover-nav-option\" data-action=\"switch-tab\" data-tab=\"commenters\">\n<a title=\""
    + alias2(lookupProperty(helpers,"gettext").call(alias3,"Top Commenters",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":40,"column":10},"end":{"line":40,"column":38}}}))
    + "\" class=\"truncate-line\" href=\"/home/forum/"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"id") : depth0), depth0))
    + "/commenters/\">\n<span class=\"hidden-md\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias3,"Top Commenters",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":41,"column":24},"end":{"line":41,"column":52}}}))
    + "</span>\n<span class=\"visible-md\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias3,"Commenters",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":42,"column":25},"end":{"line":42,"column":49}}}))
    + "</span>\n</a>\n</li>\n</ul>\n</nav>\n</div>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/ForumCoverView',[
    'backbone-marionette',
    'home/models/Session',

    'home/templates/forumCover',
], function (
    Marionette,
    Session,

    forumCoverTemplate
) {
    'use strict';

    /**
     * The cover portion of a forum feed page. Shows forum details
     * and supports forum actions, such as (un)follow.
     */
    var ForumCoverView = Marionette.ItemView.extend({
        template: forumCoverTemplate,
        templateHelpers: function () {
            return {
                friendlyUrl: this.model.getFriendlyUrl(),
                plainDescription: this.model.getPlainDescription(),
            };
        },

        events: {
            'click [data-action=toggle-follow]': 'toggleFollow',
        },
        modelEvents: {
            'change:name': 'render',
            'change:isFollowing': 'handleFollowedClass',
        },

        initialize: function () {
            this.session = Session.get();
            this.listenTo(this.session, 'setModeratedForums', this.render);
        },

        handleFollowedClass: function () {
            this.$('[data-action=toggle-follow]').toggleClass('active', this.model.get('isFollowing'));
        },

        toggleFollow: function (evt) {
            if (evt)
                evt.preventDefault();

            this.model.toggleFollowed();
        },
    }, {
        /**
         * Used to chose the correct model for this view.
         * If the given model has a related forum, returns
         * that forum. Otherwise assumes that the given model
         * is a forum and passes it through.
         *
         * @param  {Model} model - A model that is a forum or has
         *                         a related forum.
         * @returns {Forum}       - A forum model, as this view expects
         *                         to be initialized with.
         */
        getModel: function (model) {
            return model.forum || model;
        },
    });

    return ForumCoverView;
});

define('home/templates/forumProfileRecentEmpty',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"empty-message\">\n\n<svg class=\"art-empty-community\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" version=\"1.1\" x=\"0px\" y=\"0px\" viewBox=\"0 0 94 128\" enable-background=\"new 0 0 94 128\" xml:space=\"preserve\"><path class=\"house\" d=\"M61 118.4l-9.8-10c-0.5-0.5-1.3-0.5-1.8 0l-9.8 10c-0.5 0.5-0.3 1 0.4 1h2v7.7c0 0.6 0 1 1 1h4.8v-7.7h5 v7.7h5c0.8 0 0.8-0.4 0.8-1v-7.7h2C61.3 119.3 61.5 118.9 61 118.4z\" /><path class=\"bubble-top\" d=\"M75.2 21C75.2 9.4 66.2 0 55 0C43.8 0 34.8 9.4 34.8 21c0 3.1 0.7 6.1 1.8 8.7l-3.4 8.5l8.7-1.2 c3.5 3.1 8.1 5 13.1 5C66.2 42 75.2 32.6 75.2 21z M56.4 26.6h-1.9V22h-5.1v4.5h-1.9V15.8h1.9v4.5h5.1v-4.5h1.9V26.6z M60.9 26.6 h-1.9v-8.1h1.9V26.6z M61 17.2h-2v-1.8h2V17.2z\"/><path class=\"bubble-left\" d=\"M79.3 47c-8 0-14.5 6.7-14.5 15c0 2.2 0.5 4.3 1.3 6.2l-2.4 6.1l6.2-0.9c2.5 2.2 5.8 3.6 9.3 3.6 c8 0 14.5-6.7 14.5-15S87.3 47 79.3 47z M80.5 66.6H79v-3.7h-4.2v3.7h-1.6v-8.9h1.6v3.7H79v-3.7h1.6V66.6z M84.3 66.6h-1.5v-6.7h1.5 V66.6z M84.3 58.9h-1.6v-1.5h1.6V58.9z\" /><path class=\"bubble-right\" d=\"M48.4 72c0-13.8-10.8-25-24.1-25C11 47 0.2 58.2 0.2 72S11 97 24.3 97c5.9 0 11.4-2.2 15.6-5.9l10.3 1.5 l-4-10.2C47.7 79.2 48.4 75.7 48.4 72z M26.4 78.6h-2.2v-5.3h-6v5.3H16V66h2.2v5.3h6V66h2.2V78.6z M31.7 78.6h-2.2v-9.5h2.2V78.6z M31.8 67.6h-2.3v-2.1h2.3V67.6z\"/></svg>\n\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"This community hasn't been busy recently.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":6,"column":0},"end":{"line":6,"column":55}}}))
    + "</br><a href=\"/\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Head back home to find interesting discussions »",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":6,"column":72},"end":{"line":6,"column":134}}}))
    + "</a>\n</div>\n";
},"useData":true})

});
define('home/views/ForumProfileRecentEmptyView',[
    'backbone-marionette',
    'home/templates/forumProfileRecentEmpty',
], function (
    Marionette,
    forumProfileRecentEmptyTemplate
) {
    'use strict';

    var ForumProfileRecentEmptyView = Marionette.ItemView.extend({
        template: forumProfileRecentEmptyTemplate,
    });

    return ForumProfileRecentEmptyView;
});

define('home/templates/forumProfileTopCommentersEmpty',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"empty-message\">\n\n<svg class=\"art-empty-community\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" version=\"1.1\" x=\"0px\" y=\"0px\" viewBox=\"0 0 94 128\" enable-background=\"new 0 0 94 128\" xml:space=\"preserve\"><path class=\"house\" d=\"M61 118.4l-9.8-10c-0.5-0.5-1.3-0.5-1.8 0l-9.8 10c-0.5 0.5-0.3 1 0.4 1h2v7.7c0 0.6 0 1 1 1h4.8v-7.7h5 v7.7h5c0.8 0 0.8-0.4 0.8-1v-7.7h2C61.3 119.3 61.5 118.9 61 118.4z\" /><path class=\"bubble-top\" d=\"M75.2 21C75.2 9.4 66.2 0 55 0C43.8 0 34.8 9.4 34.8 21c0 3.1 0.7 6.1 1.8 8.7l-3.4 8.5l8.7-1.2 c3.5 3.1 8.1 5 13.1 5C66.2 42 75.2 32.6 75.2 21z M56.4 26.6h-1.9V22h-5.1v4.5h-1.9V15.8h1.9v4.5h5.1v-4.5h1.9V26.6z M60.9 26.6 h-1.9v-8.1h1.9V26.6z M61 17.2h-2v-1.8h2V17.2z\"/><path class=\"bubble-left\" d=\"M79.3 47c-8 0-14.5 6.7-14.5 15c0 2.2 0.5 4.3 1.3 6.2l-2.4 6.1l6.2-0.9c2.5 2.2 5.8 3.6 9.3 3.6 c8 0 14.5-6.7 14.5-15S87.3 47 79.3 47z M80.5 66.6H79v-3.7h-4.2v3.7h-1.6v-8.9h1.6v3.7H79v-3.7h1.6V66.6z M84.3 66.6h-1.5v-6.7h1.5 V66.6z M84.3 58.9h-1.6v-1.5h1.6V58.9z\" /><path class=\"bubble-right\" d=\"M48.4 72c0-13.8-10.8-25-24.1-25C11 47 0.2 58.2 0.2 72S11 97 24.3 97c5.9 0 11.4-2.2 15.6-5.9l10.3 1.5 l-4-10.2C47.7 79.2 48.4 75.7 48.4 72z M26.4 78.6h-2.2v-5.3h-6v5.3H16V66h2.2v5.3h6V66h2.2V78.6z M31.7 78.6h-2.2v-9.5h2.2V78.6z M31.8 67.6h-2.3v-2.1h2.3V67.6z\"/></svg>\n\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Darn. No one comments in this community.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":6,"column":0},"end":{"line":6,"column":54}}}))
    + "</br><a href=\"/\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Head back home to find interesting discussions »",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":6,"column":71},"end":{"line":6,"column":133}}}))
    + "</a>\n</div>\n";
},"useData":true})

});
define('home/views/ForumProfileTopCommentersEmptyView',[
    'backbone-marionette',
    'home/templates/forumProfileTopCommentersEmpty',
], function (
    Marionette,
    forumProfileTopCommentersEmptyTemplate
) {
    'use strict';

    var ForumProfileTopCommentersEmptyView = Marionette.ItemView.extend({
        template: forumProfileTopCommentersEmptyTemplate,
    });

    return ForumProfileTopCommentersEmptyView;
});

define('home/mixins/withItemRemovalSkipped',[
], function (
) {
    'use strict';

    /**
     * A mixin for a Marionette Collection View (also works with a FetchableCollectionView)
     * that prevents collection item views from being removed when the corresponding model
     * is removed from the collection.
     * Used primarily for views where the item view can toggle the included state of the
     * model in the collection. It's jarring to click a button and have a view removed.
     */
    var withItemRemovalSkipped = function () {
        var _addItemView = this.addItemView;
        this.addItemView = function (item) {
            if (this.children.findByModel(item))
                // Don't add duplicate views. This isn't a problem in the default
                // collection view implementation because the item views directly
                // represent the collection, and the collection does not contain
                // duplicates.
                return;

            return _addItemView.apply(this, arguments);
        };

        var _removeItemView = this.removeItemView;
        this.removeItemView = function () {
            // Kill the default handling that removes a card when the forum is
            // no longer followed.
            if (this.isShowingNonItemView && this.isShowingNonItemView())
                return _removeItemView.apply(this, arguments);
        };
    };

    return withItemRemovalSkipped;
});

define('home/views/UserCollectionView',[
    'home/mixins/withItemRemovalSkipped',

    'home/views/UserCardView',
    'home/views/common/FetchableCollectionView',

    'home/mixins/withViewFeedTracking',
], function (
    withItemRemovalSkipped,

    UserCardView,
    FetchableCollectionView,

    withViewFeedTracking
) {
    'use strict';

    var UserCollectionView = FetchableCollectionView.extend({
        itemView: UserCardView,
        className: 'cards',

        emptyViewOptions: function () {
            return {
                model: this.options.user,
            };
        },

    });

    withItemRemovalSkipped.call(UserCollectionView.prototype);
    withViewFeedTracking.call(UserCollectionView.prototype);

    return UserCollectionView;
});

define('core/views/common/LoginFormView',[
    'underscore',
    'backbone',

    'core/strings',
], function (
    _,
    Backbone,

    strings
) {
    'use strict';

    var gettext = strings.get;

    /**
     * A parent class for LoginFormViews. Contains common functionality.
     * Intented to be extended, not instantiated.
     *
     * Requires children to define the following:
     *     handleRegistrationError: function (errors)
     *         given an mapping from attribute name to list of errors
     *     handleRegistrationSuccess: function ()
     *         called upon sync success
     *     render: function ()
     *         renders the template
     *     User: Model
     *         the project-specific User model
     */
    var LoginFormView = Backbone.View.extend({
        initialize: function () {
            this.model = new this.User();
        },

        /**
         * Make the API response look like a validation error.
         *
         * Validation errors are {<attribute name>: [Array of errors]}.
         *
         * @param  {Object} response Registration error response from API.
         * @returns {Object}          Validation error object.
         */
        parseRegistrationErrorResponse: function (response) {

            if (!response.responseJSON)
                return;

            var errorText = response.responseJSON.response;

            if (window.grecaptcha)
                window.grecaptcha.reset();

            if (/Unable to create user/i.test(errorText)) {
                return {
                    email: [gettext(
                        'That email address is already registered with a Disqus account. Log in or enter another email.'
                    )],
                };
            }

            if (/The e-mail address you specified is already in use./i.test(errorText)) {
                return {
                    email: [
                        gettext('The e-mail address you specified is already in use.') +
                            '<br><a class="link" href="#" data-action="auth:disqus">' +
                            gettext('Try logging in.') + '</a>',
                    ],
                };
            }

            if (/You must re-submit this request with a response to the captcha challenge/i.test(errorText) && this.showCaptcha)
                this.showCaptcha(null, true);

            return {
                all: [errorText],
            };
        },

        getPassword: function () {
            // normalize password
            var password = this.$el.find('input[name=password]');
            if (password.length)
                return password.val();

            return null;
        },

        getDisplayName: function () {
            return this.$el.find('input[name=display_name]').val();
        },

        getEmail: function () {
            return this.$el.find('input[name=email]').val();
        },

        disableForm: function () {
            this.$('[data-role=submit-btn-container]').addClass('is-submitting');
        },

        enableForm: function () {
            this.$('[data-role=submit-btn-container]').removeClass('is-submitting');
        },

        handleRegistrationErrorResponse: function (response) {
            this.handleRegistrationError(this.parseRegistrationErrorResponse(response));
        },

        registerUser: function () {
            this.model.set({
                display_name: this.$el.find('input[name=display_name]').val(),
                email: this.$el.find('input[name=email]').val(),
                password: this.getPassword(),
            });

            // Client-side validation first
            if (!this.model.isValid())
                return void this.handleRegistrationError(this.model.validationError);

            this.disableForm();

            this.model.register({
                gRecaptchaResponse: this.captchaShown && window.grecaptcha && window.grecaptcha.getResponse(),
                error: _.bind(this.handleRegistrationErrorResponse, this),
                success: _.bind(this.handleRegistrationSuccess, this),
            }).always(_.bind(this.enableForm, this));
        },
    });

    return LoginFormView;
});

define('home/views/common/LoginFormView',[
    'jquery',
    'underscore',

    'core/bus',
    'core/utils',
    'core/views/common/LoginFormView',

    'home/models/Session',
    'home/models/User',
], function (
    $,
    _,

    bus,
    coreUtils,
    CoreLoginFormView,

    Session,
    User
) {
    'use strict';

    var handler = coreUtils.preventDefaultHandler;

    /**
     * A parent view containing common functionality for authentication.
     * Handles validating sign up forms, showing and hiding errors,
     * and authenticating through other networks as well as disqus (ex:
     * fb, twitter)
     *
     * Not intended to be instantiated, should be extended.
     *
     * Since this view extends core/LoginFormView, it is a Backbone view, not a
     * Marionette view.
     */
    var LoginFormView = CoreLoginFormView.extend({
        events: {
            'click [data-action~=change-step]': 'changeStep',
            'click [data-action~=auth]': 'handleAuth',
            'submit [data-role=disqus-signup]': 'attemptSignup',
        },

        // Needed by LoginFormView parent class
        User: User,

        initialize: function (options) {
            CoreLoginFormView.prototype.initialize.call(this, options);

            // This event is triggered when user signs/logs in via a network
            // (ex: fb, twitter), which occurs in a separate window.
            this.listenTo(bus.frame, '!auth:success', this.handleRegistrationSuccess);

            this.session = Session.get();
        },

        close: function () {
            this.stopListening(bus.frame, '!auth:success');
            this.remove();
        },

        handleAuth: handler(function (evt) {
            var network = $(evt.target).attr('data-network');
            this.session.authenticate(network);
        }),

        attemptSignup: handler(function () {
            this.clearRegistrationErrors();
            this.registerUser();
        }),

        clearRegistrationErrors: function () {
            this.$('.form-attribute-input.is-error').removeClass('is-error');
        },

        handleRegistrationError: function (errs) {
            this.enableForm();

            _.each(errs, function (attrErrs, attrName) {
                // Show one eror message per attribute at a time.
                this.$('.form-attribute-input[data-attribute*=' + attrName + ']')
                    .addClass('is-error')
                    .find('[data-role=attribute-error]')
                    .text(attrErrs[0]);
            }, this);
        },

        handleRegistrationSuccess: function () {
            // Home does not support changing the logged in status without reloading
            window.location.reload();
        },

        changeStep: function (evt) {
            var step = $(evt.target).attr('data-target');
            this.$('[data-step]')
                .addClass('is-hidden')
                .filter('[data-step=' + step + ']')
                .removeClass('is-hidden')
                .find('input')
                .first()
                .focus();
        },

        render: function () {
            var templateHelpers = this.templateHelpers;
            if (_.isFunction(templateHelpers))
                templateHelpers = templateHelpers.call(this);

            var data = _.extend({},
                this.model && this.model.toJSON(),
                templateHelpers);

            this.$el.html(this.template(data));
            return this;
        },
    });

    return LoginFormView;
});

define('home/templates/loginOverlay',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"prompt") : depth0), depth0))
    + "\n";
},"3":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Sign up to join great discussions or start your own.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":6,"column":0},"end":{"line":6,"column":66}}}))
    + "\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"login-overlay__content text-center text-light\" id=\"explore-overlay\">\n<h2 class=\"text-large text-bold\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"prompt") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"data":data,"loc":{"start":{"line":3,"column":0},"end":{"line":7,"column":7}}})) != null ? stack1 : "")
    + "</h2>\n<section data-step=\"networks\" class=\"spacing-bottom login-overlay__container\">\n<div class=\"spacing-top spacing-bottom-narrow align\">\n<button class=\"button button-fill -dark-hover -facebook text-medium align__item--grow spacing-right\" data-action=\"auth\" data-network=\"facebook\">Facebook</button>\n<button class=\"button button-fill -dark-hover -twitter text-medium align__item--grow spacing-right\" data-action=\"auth\" data-network=\"twitter\">Twitter</button>\n<button class=\"button button-fill -dark-hover -email text-medium align__item--grow\" data-action=\"change-step show-login-overlay\" data-target=\"disqus-signup\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Email",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":13,"column":157},"end":{"line":13,"column":176}}}))
    + "</button>\n</div>\n<div>\n<button data-action=\"auth\" data-network=\"disqus\" class=\"button button-inline text-medium\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Have an account? Log in.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":16,"column":90},"end":{"line":16,"column":128}}}))
    + "</button>\n</div>\n</section>\n\n<section data-step=\"disqus-signup\" class=\"is-hidden spacing-top-double login-overlay__container\">\n<form data-role=\"disqus-signup\">\n<div class=\"spacing-top spacing-bottom form-attribute-input\" data-attribute=\"display_name\">\n<input type=\"text\" class=\"input--textbox -padded\" placeholder=\""
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Name",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":23,"column":63},"end":{"line":23,"column":81}}}))
    + "\" name=\"display_name\">\n<p class=\"form-message-error spacing-narrow text-small text-left\" data-role=\"attribute-error\"></p>\n</div>\n<div class=\"spacing-bottom form-attribute-input\" data-attribute=\"email\">\n<input type=\"text\" class=\"input--textbox -padded\" placeholder=\""
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Email",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":27,"column":63},"end":{"line":27,"column":82}}}))
    + "\" name=\"email\">\n<p class=\"form-message-error spacing-narrow text-small text-left\" data-role=\"attribute-error\"></p>\n</div>\n<div class=\"spacing-bottom form-attribute-input\" data-attribute=\"password\">\n<input type=\"password\" class=\"input--textbox -padded\" placeholder=\""
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Password",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":31,"column":67},"end":{"line":31,"column":89}}}))
    + "\" name=\"password\">\n<p class=\"form-message-error spacing-narrow text-small text-left\" data-role=\"attribute-error\"></p>\n</div>\n<p class=\"spacing-bottom text-small\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"By signing up you agree to the %(disqus)s %(rules)s, %(tos)s, and %(privacyPolicy)s.",{"name":"gettext","hash":{"privacyPolicy":lookupProperty(helpers,"tag").call(alias1,"a",{"name":"tag","hash":{"class":"text-semibold link-inverted","target":"_blank","href":"https://help.disqus.com/customer/portal/articles/466259-privacy-policy","text":lookupProperty(helpers,"gettext").call(alias1,"Privacy Policy",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":39,"column":30},"end":{"line":39,"column":56}}})},"data":data,"loc":{"start":{"line":39,"column":16},"end":{"line":39,"column":187}}}),"tos":lookupProperty(helpers,"tag").call(alias1,"a",{"name":"tag","hash":{"class":"text-semibold link-inverted","target":"_blank","href":"https://help.disqus.com/customer/portal/articles/466260-terms-of-service","text":lookupProperty(helpers,"gettext").call(alias1,"Terms of Service",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":38,"column":20},"end":{"line":38,"column":48}}})},"data":data,"loc":{"start":{"line":38,"column":6},"end":{"line":38,"column":181}}}),"rules":lookupProperty(helpers,"tag").call(alias1,"a",{"name":"tag","hash":{"class":"text-semibold link-inverted","target":"_blank","href":"https://help.disqus.com/customer/portal/articles/1753105-basic-rules-for-disqus-powered-profiles-and-discussions","text":lookupProperty(helpers,"gettext").call(alias1,"Basic Rules",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":37,"column":22},"end":{"line":37,"column":45}}})},"data":data,"loc":{"start":{"line":37,"column":8},"end":{"line":37,"column":218}}}),"disqus":"Disqus"},"data":data,"loc":{"start":{"line":35,"column":0},"end":{"line":40,"column":2}}}))
    + "\n</p>\n<div class=\"form-submit spacing-bottom\" data-role=\"submit-btn-container\">\n<button class=\"button button-fill -dark-gray button-wide button-large text-bold\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Sign up",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":43,"column":81},"end":{"line":43,"column":102}}}))
    + "</button>\n<div class=\"spinner-small spinner--centered\"></div>\n</div>\n</form>\n<div>\n<button data-action=\"auth\" data-network=\"disqus\" class=\"link-inverted text-medium\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Have an account? Log in.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":48,"column":83},"end":{"line":48,"column":121}}}))
    + "</button>\n</div>\n</section>\n</div>\n<div class=\"login-overlay__transparency\"></div>";
},"useData":true})

});
define('home/views/LoginOverlayView',[
    'underscore',

    'home/views/common/LoginFormView',
    'home/templates/loginOverlay',
], function (
    _,

    LoginFormView,
    loginOverlayTemplate
) {
    'use strict';

    /**
     * A view that shows as either a sticky footer or as an overlay that
     * prompts the user to log in, and contains the form to do so.
     *
     * Does not require a model.
     * Initialize can optionally take in prompt, which is the message to
     * show to the user above the sign in options.
     */
    var LoginOverlayView = LoginFormView.extend({
        events: _.defaults({
            'click [data-action~=show-login-overlay]': 'showAsOverlay',
        }, LoginFormView.prototype.events),

        template: loginOverlayTemplate,
        templateHelpers: function () {
            return {
                prompt: this.prompt,
            };
        },

        className: 'login-overlay__wrapper hidden-sidebar',

        initialize: function (options) {
            LoginFormView.prototype.initialize.call(this, options);

            this.prompt = options && options.prompt;
        },

        showAsOverlay: function () {
            this.$el
                .removeClass('is-footer')
                .addClass('is-overlay');

            this.trigger('shown:overlay');
        },

        showAsFooter: function (shouldShow) {
            this.$el
                .removeClass('is-overlay')
                .toggleClass('is-footer', Boolean(shouldShow));
        },
    });

    return LoginOverlayView;
});

define('home/templates/signUpAsideModule',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"aside__wrap -brand text-center\" data-role=\"login-prompt-module\">\n<h2 class=\"text-large text-bold\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"There's more to talk about...",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":2,"column":33},"end":{"line":2,"column":76}}}))
    + "</h2>\n<p>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Great discussions are happening here on %(disqus)s. You'll never be bored.",{"name":"gettext","hash":{"disqus":"Disqus"},"data":data,"loc":{"start":{"line":3,"column":3},"end":{"line":3,"column":109}}}))
    + "</p>\n<p>\n<button class=\"button button-outline -border-light text-medium button-wide\" data-action=\"show-login-overlay\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Join %(disqus)s",{"name":"gettext","hash":{"disqus":"Disqus"},"data":data,"loc":{"start":{"line":6,"column":0},"end":{"line":6,"column":47}}}))
    + "\n</button>\n</p>\n</div>\n";
},"useData":true})

});
define('home/mixins/withLoginOverlay',[
    'jquery',
    'underscore',
    'backbone-marionette',

    'home/models/Session',
    'home/views/LoginOverlayView',
    'home/templates/signUpAsideModule',
    'home/utils/layoutUtils',
], function (
    $,
    _,
    Marionette,

    Session,
    LoginOverlayView,
    signUpAsideModuleTemplate,
    layoutUtils
) {
    'use strict';

    /**
     * Adds login overlay support to the view to which the mixin is applied.
     *
     * If View's template has defined a region for it, renders the log in module
     * in the region which has the ability to expand the login overlay.
     *
     * Adds a login footer which shows if the signUpAsideModule is not in
     * the viewport.
     *
     * Handles all the click events for the footer and signUpAsideModule
     * to show the overlay when appropriate.
     *
     * Overlay itself is a view which handles authentication.
     *
     *
     * Expects to be applied to a Marionette View using the withSubviews mixin,
     * or a Marionette Layout.
     * Can be passed a prompt, which is the message shown to the user above the
     * log in options. If not given, will use a default message.
     */
    var LoginOverlayMixin = {
        regions: {
            loginModuleRegion: '[data-role=sign-up-module]',
        },

        events: {
            'click [data-action~=show-login-overlay]': 'showLoginOverlay',
        },

        initialize: function (_initialize, options) {
            _initialize.call(this, options);
            this.boundEnsureLoginPromptInViewport = _.bind(this.ensureLoginPromptInViewport, this);
            $(window).scroll(this.boundEnsureLoginPromptInViewport);
        },

        onClose: function () {
            this.unbindScrollHandler();
            if (this.loginOverlayView)
                this.loginOverlayView.close();
        },

        onRender: function (_onRender) {
            if (_.isFunction(_onRender))
                _onRender.call(this);

            var createLoginModuleView = function () {
                return new Marionette.ItemView({
                    template: signUpAsideModuleTemplate,
                });
            };

            // Allow mixin to work with either Marionette Layouts or with a View
            // with the withSubviews mixin.
            if (this.activateRegion)
                this.activateRegion(this.loginModuleRegion, createLoginModuleView);
            else
                this.loginModuleRegion.show(createLoginModuleView());
        },

        /**
         * Ensures there is a login prompt in the viewport. Shows the footer
         * prompt iff the module is not in the viewport.
         */
        ensureLoginPromptInViewport: _.debounce(function () {
            var loginPromptModule = this.$('[data-role=login-prompt-module]');
            var showFooter = !loginPromptModule.length || !layoutUtils.isElementInViewport(loginPromptModule);
            this.showLoginFooter(showFooter);
        }, 200),

        unbindScrollHandler: function () {
            $(window).off('scroll', this.boundEnsureLoginPromptInViewport);
        },

        showLoginOverlay: function () {
            this.loginOverlayView.showAsOverlay();
        },

        showLoginFooter: function (shouldShow) {
            this.loginOverlayView.showAsFooter(shouldShow);
        },

        onDomRefresh: function (overlayViewOptions, _onDomRefresh) {
            if (_.isFunction(_onDomRefresh))
                _onDomRefresh.call(this);

            // Since the LoginOverlayView is inserted after this view's element,
            // don't need to readd/rerender it when this view is rerendered, as
            // it won't be removed. One initialization is enough.
            if (this.loginOverlayView)
                return;

            // Add the overlay view to the DOM. It'll be hidden by default
            // and shown later by scroll or click events.
            this.loginOverlayView = new LoginOverlayView(overlayViewOptions);
            this.listenTo(this.loginOverlayView, 'shown:overlay', this.unbindScrollHandler);
            this.$el.after(this.loginOverlayView.render().$el);
        },
    };

    /**
     * @param  {string} prompt - (optional) The message shown to the user above the log in prompt.
     */
    return function (prompt) {
        // Mixin only applies on logged out pages
        if (!Session.isKnownToBeLoggedOut())
            return;

        this.regions = _.extend({}, LoginOverlayMixin.regions, this.regions);

        this.events = _.extend({}, LoginOverlayMixin.events, this.events);

        this.initialize = _.wrap(this.initialize, LoginOverlayMixin.initialize);

        this.onRender = _.wrap(this.onRender, LoginOverlayMixin.onRender);

        this.onDomRefresh = _.wrap(this.onDomRefresh, _.partial(LoginOverlayMixin.onDomRefresh, { prompt: prompt }));

        _.extend(this, _.pick(LoginOverlayMixin, [
            'showLoginFooter',
            'showLoginOverlay',
            'ensureLoginPromptInViewport',
            'unbindScrollHandler',
        ]));
    };
});

define('home/views/ForumProfileView',[
    'underscore',

    'core/strings',

    'home/templates/forumView',

    'home/views/common/FetchableCollectionLayout',
    'home/views/common/TabbedView',

    'home/models/Session',

    'home/utils/backboneUtils',

    'home/views/RecommendationsModuleView',


    'home/views/ForumProfileCardCollectionView',
    'home/views/ForumCoverView',
    'home/views/ForumProfileRecentEmptyView',
    'home/views/ForumProfileTopCommentersEmptyView',
    'home/views/UserCollectionView',

    'home/mixins/withClickLinkTracking',
    'home/mixins/withLoginOverlay',
], function (
    _,

    strings,

    forumViewTemplate,

    FetchableCollectionLayout,
    TabbedView,

    Session,

    backboneUtils,

    RecommendationsModuleView,

    ForumProfileCardCollectionView,
    ForumCoverView,
    ForumProfileRecentEmptyView,
    ForumProfileTopCommentersEmptyView,
    UserCollectionView,

    withClickLinkTracking,
    withLoginOverlay
) {
    'use strict';

    var gettext = strings.get;

    var ForumProfileView = TabbedView.extend({
        defaultTab: 'recent',
        template: forumViewTemplate,

        regions: _.defaults({
            coverRegion: '[data-role=cover-area]',
            recommendedUsersModuleRegion: '[data-role=recommend-module][data-recommend-type=user]',
            recommendedForumsModuleRegion: '[data-role=recommend-module][data-recommend-type=forum]',
        }, TabbedView.prototype.regions),

        events: _.defaults({
            'click a[data-link-name]': 'trackClickLink',
        }, TabbedView.prototype.events),

        initialize: function (options) {
            TabbedView.prototype.initialize.apply(this, arguments);

            // ensure session user's following forums are fetched so that
            // following/followed forum button in ForumCoverView is displayed correctly
            var session = Session.get();
            session.loadPromise().then(function () {
                session.userProfile.forumsFollowing.ensureFetched();
            });

            this.onboardingWithoutChannels = options.onboardingWithoutChannels;
        },

        getTabView: function (activeTab) {
            var view;
            switch (activeTab) {
            case 'recent':
                view = new FetchableCollectionLayout({
                    model: this.model.recent,
                    collection: this.model.recent.get('items'),
                    fetchableCollectionView: ForumProfileCardCollectionView,
                    emptyView: ForumProfileRecentEmptyView,
                    infiniteScroll: true,
                });

                return view;
            case 'commenters':
                view = new FetchableCollectionLayout({
                    user: this.model.user,
                    model: this.model.mostLikedUsers,
                    collection: this.model.mostLikedUsers.get('items'),
                    fetchableCollectionView: UserCollectionView,
                    emptyView: ForumProfileTopCommentersEmptyView,
                    infiniteScroll: true,
                });
                view.$el.attr({
                    'class': 'card-wrap',
                });

                return view;
            }
        },

        getTrackingSection: function (activeTab) {
            switch (activeTab) {
            case 'recent':
                return 'recent_threads';
            case 'commenters':
                return 'top_commenters';
            }
        },

        renderCover: function () {
            var coverView = new ForumCoverView({ model: this.model.forum });

            // if cover re-renders, we need to show the correct tab as active
            coverView.listenTo(coverView, 'dom:refresh', _.bind(this.updateTabClasses, this));

            this.coverRegion.show(coverView);
        },

        onDomRefresh: function () {
            if (this.$(this.coverRegion.el).length)
                this.renderCover();

            if (!this.onboardingWithoutChannels) {
                this.recommendedUsersModuleRegion.show(
                    RecommendationsModuleView.createUserRecommendedModuleView({ model: this.model.interestingUsers })
                );
                this.recommendedForumsModuleRegion.show(
                    RecommendationsModuleView.createForumRecommendedModuleView({ model: this.model.interestingForums })
                );
            }

            return TabbedView.prototype.onDomRefresh.apply(this, arguments);
        },

        getPageTitle: function () {
            var forum = this.model.forum;
            return backboneUtils.getPromiseFor(forum, 'name')
                .then(function (forumName) {
                    return strings.interpolate(gettext('%(forum)s · Conversations'), { forum: forumName });
                });
        },

        getMetaAttrs: function () {
            var forum = this.model.forum;
            return this.getPageTitle()
                .then(function (pageTitle) {
                    return {
                        title: pageTitle,
                        description: forum.get('description'),
                        image: forum.has('favicon') && forum.get('favicon').cache,
                        type: 'article',
                    };
                });
        },

        getPageTrackingParams: function () {
            var forum = this.model.forum;
            return this.getPageTitle().then(function (pageTitle) {
                return {
                    forum: forum.id,
                    title: pageTitle,
                };
            });
        },

        // TODO: Move Refresh functionality to RecommendationsModuleView for reusability!
        refreshRecommendedFeed: function () {
            this.model.popular.fetchItems({
                reset: true,
            });
        },
    });

    withClickLinkTracking.call(ForumProfileView.prototype);
    withLoginOverlay.call(ForumProfileView.prototype);

    return ForumProfileView;
});

define('home/templates/profileCover',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"hidden-sidebar cover-profile-reputation\">\n<span class=\"badge -reputation\">"
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"userReputationLabel") : depth0), depth0))
    + "</span>\n</div>\n";
},"3":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<img src=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"avatar") : depth0)) != null ? lookupProperty(stack1,"cache") : stack1), depth0))
    + "\" alt=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"username") : depth0), depth0))
    + "\" />\n";
},"5":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<img src=\""
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"CDN_ROOT") : depth0), depth0))
    + "/img/avatar-default.png\" />\n";
},"7":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"cover-profile-action\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"userFollowButton"),depth0,{"name":"userFollowButton","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"isSessionUser") : depth0),{"name":"if","hash":{},"fn":container.program(8, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":26,"column":0},"end":{"line":30,"column":7}}})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"isSessionUser") : depth0),{"name":"unless","hash":{},"fn":container.program(10, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":31,"column":0},"end":{"line":33,"column":11}}})) != null ? stack1 : "")
    + "</div>\n";
},"8":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\"/home/settings/profile/\" class=\"button button-fill button-small cover-profile-action-edit\">\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Edit Profile",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":28,"column":0},"end":{"line":28,"column":26}}}))
    + "\n</a>\n";
},"10":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = container.invokePartial(lookupProperty(partials,"profileCoverDropdown"),depth0,{"name":"profileCoverDropdown","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "");
},"12":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"cover-profile-action-mobile\">"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"userFollowButton"),depth0,{"name":"userFollowButton","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"unless").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"isSessionUser") : depth0),{"name":"unless","hash":{},"fn":container.program(10, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":45,"column":0},"end":{"line":47,"column":11}}})) != null ? stack1 : "")
    + "</div>\n";
},"14":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, alias3=container.lambda, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"cover-nav-wrapper\">\n<div class=\"section-contained\">\n<nav class=\"cover-nav cover-nav-profile-user\">\n<ul class=\"cover-nav-options\">\n<li class=\"cover-nav-option\" data-action=\"switch-tab\" data-tab=\"comments\">\n<a title=\""
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Comments",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":60,"column":10},"end":{"line":60,"column":32}}}))
    + "\" class=\"truncate-line\" href=\"/by/"
    + alias2(alias3((depth0 != null ? lookupProperty(depth0,"username") : depth0), depth0))
    + "/comments/\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Comments",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":61,"column":0},"end":{"line":61,"column":22}}}))
    + "\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"showNumPosts") : depth0),{"name":"if","hash":{},"fn":container.program(15, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":62,"column":0},"end":{"line":64,"column":7}}})) != null ? stack1 : "")
    + "</a>\n</li>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"badgesFeatureActive") : depth0),{"name":"if","hash":{},"fn":container.program(17, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":67,"column":0},"end":{"line":76,"column":7}}})) != null ? stack1 : "")
    + "<li class=\"cover-nav-option hidden-sidebar\" data-action=\"switch-tab\" data-tab=\"discussions\">\n<a title=\""
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Discussions",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":78,"column":10},"end":{"line":78,"column":35}}}))
    + "\" class=\"truncate-line\" href=\"/by/"
    + alias2(alias3((depth0 != null ? lookupProperty(depth0,"username") : depth0), depth0))
    + "/discussions/\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Discussions",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":79,"column":0},"end":{"line":79,"column":25}}}))
    + "\n</a>\n</li>\n<li class=\"cover-nav-option\" data-action=\"switch-tab\" data-tab=\"favorites\">\n<a title=\""
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Recommends",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":83,"column":10},"end":{"line":83,"column":34}}}))
    + "\" class=\"truncate-line\" href=\"/by/"
    + alias2(alias3((depth0 != null ? lookupProperty(depth0,"username") : depth0), depth0))
    + "/favorites/\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Recommends",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":84,"column":0},"end":{"line":84,"column":24}}}))
    + "\n</a>\n</li>\n<li class=\"cover-nav-option hidden-md\" data-action=\"switch-tab\" data-tab=\"followers\">\n<a title=\""
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Followers",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":88,"column":10},"end":{"line":88,"column":33}}}))
    + "\" class=\"truncate-line\" href=\"/by/"
    + alias2(alias3((depth0 != null ? lookupProperty(depth0,"username") : depth0), depth0))
    + "/followers/\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Followers",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":89,"column":0},"end":{"line":89,"column":23}}}))
    + "\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"showNumFollowers") : depth0),{"name":"if","hash":{},"fn":container.program(20, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":90,"column":0},"end":{"line":92,"column":7}}})) != null ? stack1 : "")
    + "</a>\n</li>\n<li class=\"cover-nav-option visible-sidebar-md\" data-action=\"switch-tab\" data-tab=\"following\">\n<a title=\""
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Following",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":96,"column":10},"end":{"line":96,"column":33}}}))
    + "\" class=\"truncate-line\" href=\"/by/"
    + alias2(alias3((depth0 != null ? lookupProperty(depth0,"username") : depth0), depth0))
    + "/following/\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Following",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":97,"column":0},"end":{"line":97,"column":23}}}))
    + "\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"showNumTotalFollowing") : depth0),{"name":"if","hash":{},"fn":container.program(22, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":98,"column":0},"end":{"line":100,"column":7}}})) != null ? stack1 : "")
    + "</a>\n</li>\n</ul>\n</nav>\n</div>\n</div>\n";
},"15":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<span class=\"cover-nav-option-count\">"
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"numPosts") : depth0), depth0))
    + "</span>\n";
},"17":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.escapeExpression, alias2=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<li class=\"cover-nav-option\" data-action=\"switch-tab\" data-tab=\"badges\">\n<a title=\"Badges\" class=\"truncate-line\" href=\"/by/"
    + alias1(container.lambda((depth0 != null ? lookupProperty(depth0,"username") : depth0), depth0))
    + "/badges/\">\n"
    + alias1(lookupProperty(helpers,"gettext").call(alias2,"Badges",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":70,"column":0},"end":{"line":70,"column":20}}}))
    + "\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias2,(depth0 != null ? lookupProperty(depth0,"numBadges") : depth0),{"name":"if","hash":{},"fn":container.program(18, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":71,"column":0},"end":{"line":73,"column":7}}})) != null ? stack1 : "")
    + "</a>\n</li>\n";
},"18":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<span class=\"cover-nav-option-count\">"
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"numBadges") : depth0), depth0))
    + "</span>\n";
},"20":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<span class=\"cover-nav-option-count hidden-md\" data-role=\"num-followers\">"
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"numFollowers") : depth0), depth0))
    + "</span>\n";
},"22":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<span class=\"cover-nav-option-count hidden-md\" data-role=\"num-following\">"
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"numTotalFollowing") : depth0), depth0))
    + "</span>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.lambda, alias3=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"section-contained\">\n<div class=\"cover-body\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"isGlobalAdmin") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":3,"column":0},"end":{"line":7,"column":7}}})) != null ? stack1 : "")
    + "\n<div class=\"cover-body-left\">\n<div class=\"cover-profile-avatar-wrapper\">\n<a href=\"/by/"
    + alias3(alias2((depth0 != null ? lookupProperty(depth0,"username") : depth0), depth0))
    + "/\" class=\"cover-profile-avatar\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"avatar") : depth0)) != null ? lookupProperty(stack1,"cache") : stack1),{"name":"if","hash":{},"fn":container.program(3, data, 0),"inverse":container.program(5, data, 0),"data":data,"loc":{"start":{"line":13,"column":0},"end":{"line":17,"column":7}}})) != null ? stack1 : "")
    + "</a>\n</div>\n<div class=\"cover-profile-content\" dir=\"auto\">\n<div class=\"cover-profile-name-wrapper\">\n<h1 class=\"cover-profile-name text-largest truncate-line\">"
    + alias3(alias2((depth0 != null ? lookupProperty(depth0,"name") : depth0), depth0))
    + "</h1>\n"
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"isBlocked") : depth0),{"name":"unless","hash":{},"fn":container.program(7, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":23,"column":0},"end":{"line":35,"column":11}}})) != null ? stack1 : "")
    + "</div>\n<div class=\"cover-attribute-details\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"profileCoverAttributes"),depth0,{"name":"profileCoverAttributes","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n\n"
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"isBlocked") : depth0),{"name":"unless","hash":{},"fn":container.program(12, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":42,"column":0},"end":{"line":49,"column":11}}})) != null ? stack1 : "")
    + "</div>\n</div>\n</div>\n</div>\n"
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"isBlocked") : depth0),{"name":"unless","hash":{},"fn":container.program(14, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":54,"column":0},"end":{"line":107,"column":11}}})) != null ? stack1 : "");
},"usePartial":true,"useData":true})

});
define('home/templates/spinnerTall',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    return "<div class=\"spinner-wrapper tall\">\n<div class=\"spinner tall\"></div>\n</div>\n";
},"useData":true})

});
define('home/templates/reportUser',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"modal-header\">\n<h4 class=\"modal-title\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Report %(user)s?",{"name":"gettext","hash":{"user":(depth0 != null ? lookupProperty(depth0,"user") : depth0)},"data":data,"loc":{"start":{"line":2,"column":24},"end":{"line":2,"column":66}}}))
    + "</h4>\n</div>\n<div class=\"modal-body\">\n<h2 class=\"text-gray\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Choose why you're reporting this user",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":5,"column":22},"end":{"line":5,"column":73}}}))
    + "</h2>\n<form class=\"fieldset\" role=\"group\">\n<div class=\"fieldset__block align__item\">\n<label class=\"fieldset__block--radio text-medium\">\n<input type=\"radio\" class=\"input--radio\" name=\"reason\" value=\"6\" checked>\n<strong>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"I disagree with this user",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":10,"column":8},"end":{"line":10,"column":47}}}))
    + "</strong>\n</label>\n<label class=\"fieldset__block--radio text-medium\">\n<input type=\"radio\" class=\"input--radio\" name=\"reason\" value=\"0\">\n<strong>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Harassment",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":14,"column":8},"end":{"line":14,"column":32}}}))
    + "</strong> &mdash; "
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"posted or encouraged others to post harassing comments or hate speech targeting me, other individuals, or groups",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":14,"column":50},"end":{"line":14,"column":176}}}))
    + "\n</label>\n<label class=\"fieldset__block--radio text-medium\">\n<input type=\"radio\" class=\"input--radio\" name=\"reason\" value=\"1\">\n<strong>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Spam",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":18,"column":8},"end":{"line":18,"column":26}}}))
    + "</strong> &mdash; "
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"posted spam comments or discussions",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":18,"column":44},"end":{"line":18,"column":93}}}))
    + "\n</label>\n<label class=\"fieldset__block--radio text-medium\">\n<input type=\"radio\" class=\"input--radio\" name=\"reason\" value=\"2\">\n<strong>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Inappropriate profile",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":22,"column":8},"end":{"line":22,"column":43}}}))
    + "</strong> &mdash; "
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"profile contains inappropriate images or text",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":22,"column":61},"end":{"line":22,"column":120}}}))
    + "\n</label>\n<label class=\"fieldset__block--radio text-medium\">\n<input type=\"radio\" class=\"input--radio\" name=\"reason\" value=\"3\">\n<strong>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Threatening content",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":26,"column":8},"end":{"line":26,"column":41}}}))
    + "</strong> &mdash; "
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"posted directly threatening content",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":26,"column":59},"end":{"line":26,"column":108}}}))
    + "\n</label>\n<label class=\"fieldset__block--radio text-medium\">\n<input type=\"radio\" class=\"input--radio\" name=\"reason\" value=\"4\">\n<strong>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Impersonation",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":30,"column":8},"end":{"line":30,"column":35}}}))
    + "</strong> &mdash; "
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"misrepresents themselves as yourself",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":30,"column":53},"end":{"line":30,"column":103}}}))
    + "\n</label>\n<label class=\"fieldset__block--radio text-medium\">\n<input type=\"radio\" class=\"input--radio\" name=\"reason\" value=\"5\">\n<strong>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Private information",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":34,"column":8},"end":{"line":34,"column":41}}}))
    + "</strong> &mdash; "
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"posted your personally identifiable information",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":34,"column":59},"end":{"line":34,"column":120}}}))
    + "\n</label>\n</div>\n</form>\n<p class=\"form-description text-gray text-small spacing-top\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Before reporting, review the %(basicRules)s that apply to all %(disqus)s users. Keep in mind that %(disqus)s does not moderate communities. If you see something, report it first to the moderators or block the user.",{"name":"gettext","hash":{"basicRules":lookupProperty(helpers,"tag").call(alias1,"a",{"name":"tag","hash":{"text":lookupProperty(helpers,"gettext").call(alias1,"Basic Rules",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":41,"column":127},"end":{"line":41,"column":150}}}),"target":"_blank","href":"//help.disqus.com/customer/en/portal/articles/1753105-basic-rules-for-disqus"},"data":data,"loc":{"start":{"line":41,"column":13},"end":{"line":41,"column":151}}}),"disqus":"Disqus"},"data":data,"loc":{"start":{"line":39,"column":0},"end":{"line":42,"column":2}}}))
    + "\n</p>\n</div>\n";
},"useData":true})

});
define('home/templates/completeReportUser',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"modal-header\">\n<h4 class=\"modal-title\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Report sent",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":2,"column":24},"end":{"line":2,"column":49}}}))
    + "</h4>\n</div>\n<div class=\"modal-body\">\n<p>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Thank you for reporting this user. This helps moderators remove inappropriate comments and profiles. Disqus will take action against their account if they have violated our policies.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":5,"column":3},"end":{"line":5,"column":199}}}))
    + "</p>\n</div>\n";
},"useData":true})

});
define('home/views/ProfileCoverView',[
    'jquery',
    'backbone-marionette',

    'core/frameBus',
    'core/switches',

    'home/utils/confirmModal',
    'home/mixins/withAllstarPopover',
    'home/mixins/withTruncate',
    'home/models/Session',
    'home/templates/profileCover',
    'home/templates/spinnerTall',
    'home/templates/reportUser',
    'home/templates/completeReportUser',
], function (
    $,
    Marionette,

    FrameBus,
    switches,

    confirmModal,
    withAllstarPopover,
    withTruncate,
    Session,
    profileCoverTemplate,
    spinnerTallTemplate,
    reportUserModalTemplate,
    completeReportUserModalTemplate
) {
    'use strict';

    var ProfileCoverView = Marionette.ItemView.extend({
        template: function (data) {
            // Fetching
            if (!data.name) {
                return spinnerTallTemplate(data);
            }

            return profileCoverTemplate(data);
        },
        templateHelpers: function () {
            var sessionUser = Session.get().user;

            var helpers = {
                sessionUserName: sessionUser.get('username'),
                isSessionUser: this.model.isSessionUser(),
                isGlobalAdmin: sessionUser.isGlobalAdmin(),
                numTotalFollowing: this.model.getNumTotalFollowing(),
                // TODO: @brett Remove switch condition on release
                badgesFeatureActive: switches.isFeatureActive('badges_feature') || this.model.getNumBadges() > 0,
                numBadges: this.model.getNumBadges(),
                showNumPosts: this.model.has('numPosts'),
                showNumFollowers: this.model.has('numFollowers'),
                userReputationLabel: this.model.getUserReputationLabel(),
                numLines: 3,
                showNumTotalFollowing: this.model.has('numFollowing') && this.model.has('numForumsFollowing'),
            };

            if (this.model.get('isBlocked')) {
                helpers.avatar = this.model.defaults.avatar;
            }

            return helpers;
        },

        events: {
            'click [data-action=toggle-follow]': 'toggleFollow',
            'click [data-action=block-user]': 'blockUser',
            'click [data-action=prompt-report-user]': 'promptReportUser',
        },
        modelEvents: {
            'change:name': 'render',
            'change:isBlocked': 'render',
            'change:isFlagged': 'render',
            'change:isFollowing': 'handleFollowedClass',
            'change:numFollowers': 'updateNumFollowers',
            'change:numFollowing': 'updateNumFollowing',
            'change:numForumsFollowing': 'updateNumFollowing',
            'change:numChannelsFollowing': 'updateNumFollowing',
        },

        handleFollowedClass: function () {
            this.$('[data-action=toggle-follow]').toggleClass('active', this.model.get('isFollowing'));
        },

        updateNumFollowers: function () {
            this.$('[data-role=num-followers]').text(this.model.get('numFollowers'));
        },

        updateNumFollowing: function () {
            this.$('[data-role=num-following]').text(this.model.getNumTotalFollowing());
        },

        toggleFollow: function (evt) {
            if (evt) {
                evt.preventDefault();
            }

            this.model.toggleFollowed();
        },

        promptReportUser: function (evt) {
            if (evt) {
                evt.preventDefault();
            }

            confirmModal.confirmationPromise(
                confirmModal.TYPES.CONFIRM_CANCEL,
                reportUserModalTemplate({ user: this.model.get('username') })
            ).then(function (shouldReport, $modal) {
                if (shouldReport) {
                    this.reportUser($modal.find('input[name=reason]:checked').val());
                }
            }.bind(this));
        },

        reportUser: function (reason) {
            this.model.report(reason)
                .success(confirmModal.confirmationPromise.bind(
                    this,
                    confirmModal.TYPES.CLOSE,
                    completeReportUserModalTemplate()
                ))
                .fail(this.model.trigger.bind(this.model, 'reportError'));
        },

        blockUser: function (evt) {
            if (evt) {
                evt.preventDefault();
            }

            var model = this.model;
            model.block().fail(model.trigger.bind(model, 'blockError'));
        },

        onDomRefresh: function () {
            $('.tooltipped').tooltip();
        },
    });

    withTruncate.call(ProfileCoverView.prototype);
    withAllstarPopover.call(ProfileCoverView.prototype);

    return ProfileCoverView;
});

define('home/mixins/asProfileCard',[
    'underscore',

    'home/models/Session',

    'home/utils/layoutUtils',
    'home/mixins/withAllstarPopover',
    'home/mixins/withTruncate',
], function (
    _,

    Session,

    layoutUtils,
    withAllstarPopover,
    withTruncate
) {
    'use strict';

    var asProfileCard = function () {
        withTruncate.apply(this, arguments);
        withAllstarPopover.call(this);

        this.initialize = _.wrap(this.initialize, function (_initialize) {
            _initialize.apply(this, _.rest(arguments));
            this.session = Session.get();

            // Ensure computations for values that will be used in this view
            this.model.thread.isAuthorSessionUser(this.session);

            this.listenTo(this.model.thread, 'change:content change:isAuthor', this.render);
            this.listenTo(this.session, 'change:id', this.render);

            this.numTitleLines = 3;
        });

        this.serializeData = _.wrap(this.serializeData, function (_serializeData) {
            var data = _serializeData.apply(this, _.rest(arguments));
            var thread = this.model.thread;

            return _.defaults(data, {
                discussionRoute: thread && thread.getDiscussionRoute(),
                canShowThreadImage: !layoutUtils.isNarrowLayout(),
                image: thread && thread.getImage(),
                numTitleLines: this.numTitleLines,
                relativeTime: this.model.getRelativeTimestamp(),
                firstActor: this.model.actors[0] && this.model.actors[0].toJSON(),
                isSpam: thread.get('isSpam'),
                isAuthor: thread.get('isAuthor'),
            });
        });
    };

    return asProfileCard;
});

define('home/templates/profileCardPost',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<span class=\"icon-forward\"></span>\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"userName"),(depth0 != null ? lookupProperty(depth0,"replyAuthor") : depth0),{"name":"userName","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "");
},"3":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"spacing-bottom-small\">\n<span class=\"label label-danger\">"
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"hiddenExplanation") : depth0), depth0))
    + "</span>\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"spamActions"),depth0,{"name":"spamActions","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n";
},"5":function(container,depth0,helpers,partials,data) {
    return "hidden";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.lambda, alias3=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = container.invokePartial(lookupProperty(partials,"userAvatar"),(depth0 != null ? lookupProperty(depth0,"author") : depth0),{"name":"userAvatar","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "<div class=\"comment-body\">\n<header class=\"comment-header\">\n<div class=\"align-min-tablet\">\n<div class=\"spacing-right\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"userName"),(depth0 != null ? lookupProperty(depth0,"author") : depth0),{"name":"userName","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"replyAuthor") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":7,"column":0},"end":{"line":10,"column":7}}})) != null ? stack1 : "")
    + "<a class=\"link-gray time\"\nhref=\""
    + alias3(alias2((depth0 != null ? lookupProperty(depth0,"discussionRoute") : depth0), depth0))
    + "#comment-"
    + alias3(alias2((depth0 != null ? lookupProperty(depth0,"id") : depth0), depth0))
    + "\"\ndata-link-name=\"timestamp\"\ndata-thread-id=\""
    + alias3(alias2(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + "\">\n"
    + alias3(alias2((depth0 != null ? lookupProperty(depth0,"relativeTime") : depth0), depth0))
    + "\n</a>\n</div>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"isHidden") : depth0),{"name":"if","hash":{},"fn":container.program(3, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":18,"column":0},"end":{"line":23,"column":7}}})) != null ? stack1 : "")
    + "</div>\n</header>\n<div data-role=\"post-content\"></div>\n<footer class=\"comment-actions "
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"isHidden") : depth0),{"name":"if","hash":{},"fn":container.program(5, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":27,"column":31},"end":{"line":27,"column":60}}})) != null ? stack1 : "")
    + "\" data-role=\"post-actions\">\n</footer>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/ProfilePostView',[
    'underscore',
    'handlebars',

    'home/views/PostView',
    'home/templates/profileCardPost',
], function (
    _,
    Handlebars,

    PostView,
    profileCardPostTemplate
) {
    'use strict';

    var ProfilePostView = PostView.extend({
        template: profileCardPostTemplate,

        events: {
            'click [data-action=request-spam-review]': 'requestSpamReview',
        },

        ui: {
            spamActions: '[data-role=spam-actions]',
        },

        initialize: function (options) {
            options = options || {};
            options.shouldCollapse = false;
            PostView.prototype.initialize.apply(this, arguments);
            this.replyAuthor = options.replyAuthor;

            this.bindToAuthor();
        },

        bindToAuthor: function () {
            if (!this.model.author) {
                this.listenToOnce(this.model, 'changeRelated:author', this.bindToAuthor);
                return;
            }

            this.listenTo(this.model.author, 'change:flaggedForSpamReview', this.renderSpamAlert);
        },

        renderSpamAlert: function () {
            var data = this.serializeData();
            data = this.mixinTemplateHelpers(data);

            this.ui.spamActions.html(Handlebars.partials.spamActions(data));
        },

        templateHelpers: function () {
            var helpers = PostView.prototype.templateHelpers.apply(this, arguments);
            helpers = _.defaults({
                isAuthor: this.model.author.isSessionUser(),
                authorPendingSpamReview: this.model.author.get('flaggedForSpamReview'),
                replyAuthor: this.replyAuthor && this.replyAuthor.toJSON(),
            }, helpers);
            return helpers;
        },

        requestSpamReview: function () {
            this.model.author.requestSpamReview();
        },
    });

    return ProfilePostView;
});

define('home/views/ProfilePostCollectionView',[
    'backbone-marionette',

    'home/views/ProfilePostView',
], function (
    Marionette,

    ProfilePostView
) {
    'use strict';

    /**
     * A view that shows a collection of posts that are all by the same author.
     * If the post is a reply, it shows the parent comment's author in the header.
     */
    var ProfilePostCollectionView = Marionette.CollectionView.extend({
        getItemView: function () {
            return ProfilePostView;
        },

        itemViewOptions: function (activity) {
            var model = activity.object;

            var itemOptions = {
                model: model,
            };

            if (activity.get('verb') === 'reply')
                itemOptions.replyAuthor = activity.target.author;

            return itemOptions;
        },
    });

    return ProfilePostCollectionView;
});

define('home/templates/profileCardComments',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card-discussion no-image\">\n<div class=\"card-body\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"profileCardReason"),depth0,{"name":"profileCardReason","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + ((stack1 = container.invokePartial(lookupProperty(partials,"threadTitle"),depth0,{"name":"threadTitle","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "<div class=\"card-comment\" data-role=\"post\"></div>\n</div>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/ProfileCardCommentsView',[
    'backbone',

    'home/views/common/ActivityCardView',
    'home/mixins/asProfileCard',
    'home/mixins/asCollapsibleCard',
    'home/mixins/withSubviews',

    'home/views/ProfilePostCollectionView',
    'home/templates/profileCardComments',
], function (
    Backbone,

    ActivityCardView,
    asProfileCard,
    asCollapsibleCard,
    withSubviews,

    ProfilePostCollectionView,
    profileCardCommentsTemplate
) {
    'use strict';

    var parent = ActivityCardView;

    var ProfileCardPostView = parent.extend({
        className: 'card card-profile card-profile-post',

        template: profileCardCommentsTemplate,

        regions: {
            postsRegion: '[data-role=post]',
        },

        onRender: function () {
            this.activateRegion(this.postsRegion, this.createPostCollectionView);
        },

        createPostCollectionView: function () {
            return new ProfilePostCollectionView({
                el: this.postsRegion.el,
                collection: new Backbone.Collection(this.model.activities),
            });
        },
    });


    var proto = ProfileCardPostView.prototype;
    asCollapsibleCard.call(proto);
    asProfileCard.call(proto);
    withSubviews.call(proto);

    return ProfileCardPostView;
});

define('home/templates/profileCardFavorite',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    return " no-image";
},"3":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"image") : depth0),{"name":"if","hash":{},"fn":container.program(4, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":4,"column":0},"end":{"line":13,"column":7}}})) != null ? stack1 : "");
},"4":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"link") : stack1), depth0))
    + "\"\nclass=\"discussion-image\"\ndata-link-name=\"image\"\ndata-link-out=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"signedLink") : stack1), depth0))
    + "\"\ndata-thread-id=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + "\">\n\n<img src=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"image") : depth0)) != null ? lookupProperty(stack1,"src") : stack1), depth0))
    + "\" alt=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"image") : depth0)) != null ? lookupProperty(stack1,"title") : stack1), depth0))
    + "\">\n</a>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card-discussion"
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"image") : depth0),{"name":"unless","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":1,"column":27},"end":{"line":1,"column":64}}})) != null ? stack1 : "")
    + "\">\n<div class=\"card-aside\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"canShowThreadImage") : depth0),{"name":"if","hash":{},"fn":container.program(3, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":3,"column":0},"end":{"line":14,"column":7}}})) != null ? stack1 : "")
    + "</div>\n<div class=\"card-body\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"profileCardReason"),depth0,{"name":"profileCardReason","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + ((stack1 = container.invokePartial(lookupProperty(partials,"threadTitle"),depth0,{"name":"threadTitle","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "<div class=\"card-profile-activity\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"userAvatar"),(depth0 != null ? lookupProperty(depth0,"firstActor") : depth0),{"name":"userAvatar","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"%(userName)s recommended",{"name":"gettext","hash":{"userName":lookupProperty(helpers,"getPartial").call(alias1,"userName",(depth0 != null ? lookupProperty(depth0,"firstActor") : depth0),{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":21,"column":48},"end":{"line":21,"column":82}}})},"data":data,"loc":{"start":{"line":21,"column":0},"end":{"line":21,"column":84}}}))
    + " <span class=\"bullet\">"
    + alias2(container.lambda((depth0 != null ? lookupProperty(depth0,"relativeTime") : depth0), depth0))
    + "</span>\n</div>\n</div>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/ProfileCardFavoriteView',[
    'home/views/common/ActivityCardView',
    'home/mixins/asProfileCard',

    'home/templates/profileCardFavorite',
], function (
    ActivityCardView,
    asProfileCard,

    profileCardFavoriteTemplate
) {
    'use strict';

    var parent = ActivityCardView;


    var ProfileCardFavoriteView = parent.extend({
        className: 'card card-profile card-profile-favorite',

        template: profileCardFavoriteTemplate,
    });

    asProfileCard.call(ProfileCardFavoriteView.prototype);
    return ProfileCardFavoriteView;
});

define('home/templates/profileCardCreateDiscussion',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card-discussion no-image\">\n<div class=\"card-body\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"profileCardReason"),depth0,{"name":"profileCardReason","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + ((stack1 = container.invokePartial(lookupProperty(partials,"threadTitle"),depth0,{"name":"threadTitle","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "<div class=\"card-profile-activity\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"userAvatar"),(depth0 != null ? lookupProperty(depth0,"firstActor") : depth0),{"name":"userAvatar","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"%(userName)s started a discussion",{"name":"gettext","hash":{"userName":lookupProperty(helpers,"getPartial").call(alias1,"userName",(depth0 != null ? lookupProperty(depth0,"firstActor") : depth0),{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":7,"column":57},"end":{"line":7,"column":91}}})},"data":data,"loc":{"start":{"line":7,"column":0},"end":{"line":7,"column":93}}}))
    + " <span class=\"bullet\">"
    + alias2(container.lambda((depth0 != null ? lookupProperty(depth0,"relativeTime") : depth0), depth0))
    + "</span>\n</div>\n</div>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/ProfileCardCreateDiscussionView',[
    'home/views/common/ActivityCardView',
    'home/mixins/asProfileCard',

    'home/templates/profileCardCreateDiscussion',
], function (
    ActivityCardView,
    asProfileCard,

    profileCardCreateDiscussionTemplate
) {
    'use strict';

    var parent = ActivityCardView;


    var ProfileCardCreateDiscussionView = parent.extend({
        className: 'card card-profile card-profile-discussion',

        template: profileCardCreateDiscussionTemplate,
    });

    asProfileCard.call(ProfileCardCreateDiscussionView.prototype);
    return ProfileCardCreateDiscussionView;
});

define('home/views/ProfileCardCollectionView',[
    'backbone',

    'core/bus',

    'home/views/common/FetchableCollectionView',
    'home/views/ProfileCardCommentsView',
    'home/views/ProfileCardFavoriteView',
    'home/views/ProfileCardCreateDiscussionView',

    'home/mixins/withViewFeedTracking',
], function (
    Backbone,

    bus,

    FetchableCollectionView,
    ProfileCardCommentsView,
    ProfileCardFavoriteView,
    ProfileCardCreateDiscussionView,

    withViewFeedTracking
) {
    'use strict';

    var ProfileCardCollectionView = FetchableCollectionView.extend({
        initialize: function () {
            FetchableCollectionView.prototype.initialize.apply(this, arguments);
            this.listenToOnce(this, 'showFirstItem', function () {
                bus.trigger('showFirstCard', 'profile');
            });
        },

        itemView: function (options) {
            switch (options.model.get('verb')) {
            case 'reply':
            case 'post':
                return new ProfileCardCommentsView(options);
            case 'favorite':
                return new ProfileCardFavoriteView(options);
            case 'create':
                return new ProfileCardCreateDiscussionView(options);
            default:
                return new Backbone.View();
            }
        },

        emptyViewOptions: function () {
            return {
                model: this.options.user,
            };
        },
    });

    withViewFeedTracking.call(ProfileCardCollectionView.prototype);

    return ProfileCardCollectionView;
});

define('home/templates/profileBadgesEmpty',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class='empty-message card-wrap'>\n\n<img class='empty-message__img' src='"
    + alias2(lookupProperty(helpers,"urlfor").call(alias1,"cdn",{"name":"urlfor","hash":{},"data":data,"loc":{"start":{"line":4,"column":37},"end":{"line":4,"column":53}}}))
    + "/img/empty-states/badges.png'/>\n\n<div class='empty-message__content'>\n<h2 class='text-larger'>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"%(name)s hasn't been awarded any badges yet",{"name":"gettext","hash":{"name":(depth0 != null ? lookupProperty(depth0,"name") : depth0)},"data":data,"loc":{"start":{"line":7,"column":24},"end":{"line":7,"column":94}}}))
    + "</h2>\n<p class='text-gray text-medium'>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Badges are awarded for commenting and engaging in discussions across Disqus!",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":8,"column":33},"end":{"line":8,"column":123}}}))
    + "</p>\n<a href='/pages' class='button button-outline button-padding-wider text-large'>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Find interesting discussions »",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":9,"column":79},"end":{"line":9,"column":123}}}))
    + "</a>\n</div>\n</div>\n";
},"useData":true})

});
define('home/views/ProfileBadgesEmptyView',[
    'backbone-marionette',
    'home/templates/profileBadgesEmpty',
], function (
    Marionette,
    profileBadgesEmptyTemplate
) {
    'use strict';

    var ProfileBadgesEmptyView = Marionette.ItemView.extend({
        template: profileBadgesEmptyTemplate,
    });

    return ProfileBadgesEmptyView;
});

define('home/templates/profileCommentsEmpty',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"empty-message card-wrap\">\n\n<img class=\"empty-message__img\" src=\""
    + alias2(lookupProperty(helpers,"urlfor").call(alias1,"cdn",{"name":"urlfor","hash":{},"data":data,"loc":{"start":{"line":4,"column":37},"end":{"line":4,"column":53}}}))
    + "/img/empty-states/comments.png\"/>\n\n<div class=\"empty-message__content\">\n<h2 class=\"text-larger\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"%(name)s hasn't commented yet",{"name":"gettext","hash":{"name":(depth0 != null ? lookupProperty(depth0,"name") : depth0)},"data":data,"loc":{"start":{"line":7,"column":24},"end":{"line":7,"column":79}}}))
    + "</h2>\n<p class=\"text-gray text-medium\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Comments %(name)s leaves on discussions will appear here.",{"name":"gettext","hash":{"name":(depth0 != null ? lookupProperty(depth0,"name") : depth0)},"data":data,"loc":{"start":{"line":8,"column":33},"end":{"line":8,"column":116}}}))
    + "</p>\n<a href=\"/home/explore/discussions/\" class=\"button button-outline button-padding-wider text-large\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Find interesting discussions to join »",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":9,"column":99},"end":{"line":9,"column":151}}}))
    + "</a>\n</div>\n</div>\n";
},"useData":true})

});
define('home/views/ProfileCommentsEmptyView',[
    'backbone-marionette',
    'home/templates/profileCommentsEmpty',
], function (
    Marionette,
    profileCommentsEmptyTemplate
) {
    'use strict';

    var ProfileCommentsEmptyView = Marionette.ItemView.extend({
        template: profileCommentsEmptyTemplate,
    });

    return ProfileCommentsEmptyView;
});

define('home/templates/profileFavoritesEmpty',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"empty-message card-wrap\">\n\n<img class=\"empty-message__img\" src=\""
    + alias2(lookupProperty(helpers,"urlfor").call(alias1,"cdn",{"name":"urlfor","hash":{},"data":data,"loc":{"start":{"line":4,"column":37},"end":{"line":4,"column":53}}}))
    + "/img/empty-states/recommends.png\"/>\n\n<div class=\"empty-message__content\">\n<h2 class=\"text-larger\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"%(name)s hasn't recommended a discussion yet",{"name":"gettext","hash":{"name":(depth0 != null ? lookupProperty(depth0,"name") : depth0)},"data":data,"loc":{"start":{"line":7,"column":24},"end":{"line":7,"column":94}}}))
    + "</h2>\n<p class=\"text-gray text-medium\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Recommending a discussion shares it with people that follow you. Just click the heart!",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":8,"column":33},"end":{"line":8,"column":133}}}))
    + "</p>\n<a href=\"/home/explore/discussions/\" class=\"button button-outline button-padding-wider text-large\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Find interesting discussions »",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":9,"column":99},"end":{"line":9,"column":143}}}))
    + "</a>\n</div>\n</div>\n";
},"useData":true})

});
define('home/views/ProfileFavoritesEmptyView',[
    'backbone-marionette',
    'home/templates/profileFavoritesEmpty',
], function (
    Marionette,
    profileFavoritesEmptyTemplate
) {
    'use strict';

    var ProfileFavoritesEmptyView = Marionette.ItemView.extend({
        template: profileFavoritesEmptyTemplate,
    });

    return ProfileFavoritesEmptyView;
});

define('home/templates/profileFollowersEmpty',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"empty-message\">\n\n<img class=\"empty-message__img\" src=\""
    + alias2(lookupProperty(helpers,"urlfor").call(alias1,"cdn",{"name":"urlfor","hash":{},"data":data,"loc":{"start":{"line":4,"column":37},"end":{"line":4,"column":53}}}))
    + "/img/empty-states/followers.png\"/>\n\n<div class=\"empty-message__content\">\n<h2 class=\"text-larger\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Nobody is following",{"name":"gettext","hash":{"name":(depth0 != null ? lookupProperty(depth0,"name") : depth0)},"data":data,"loc":{"start":{"line":7,"column":24},"end":{"line":7,"column":69}}}))
    + "</h2>\n<p class=\"text-gray text-medium\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Following people helps you keep up with what they’re saying and recommending.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":8,"column":33},"end":{"line":8,"column":124}}}))
    + "</p>\n<a href=\"/home/explore/people/\" class=\"button button-outline button-padding-wider text-large\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Find interesting people to follow »",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":9,"column":94},"end":{"line":9,"column":143}}}))
    + "</a>\n</div>\n</div>\n";
},"useData":true})

});
define('home/views/ProfileFollowersEmptyView',[
    'backbone-marionette',
    'home/templates/profileFollowersEmpty',
], function (
    Marionette,
    profileFollowersEmptyTemplate
) {
    'use strict';

    var ProfileFollowersEmptyView = Marionette.ItemView.extend({
        template: profileFollowersEmptyTemplate,
    });

    return ProfileFollowersEmptyView;
});

define('home/templates/profileRecentEmpty',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"empty-message card-wrap\">\n\n<img class=\"empty-message__img\" src=\""
    + alias2(lookupProperty(helpers,"urlfor").call(alias1,"cdn",{"name":"urlfor","hash":{},"data":data,"loc":{"start":{"line":4,"column":37},"end":{"line":4,"column":53}}}))
    + "/img/empty-states/discussions.png\"/>\n\n<div class=\"empty-message__content\">\n<h2 class=\"text-larger\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"%(name)s hasn't started any discussions yet",{"name":"gettext","hash":{"name":(depth0 != null ? lookupProperty(depth0,"name") : depth0)},"data":data,"loc":{"start":{"line":7,"column":24},"end":{"line":7,"column":93}}}))
    + "</h2>\n<p class=\"text-gray text-medium\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Discussions started by %(name)s will appear here. Anyone can start one on channels!",{"name":"gettext","hash":{"name":(depth0 != null ? lookupProperty(depth0,"name") : depth0)},"data":data,"loc":{"start":{"line":8,"column":33},"end":{"line":8,"column":143}}}))
    + "</p>\n<a href=\"/home/explore/\" class=\"button button-outline button-padding-wider text-large\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Find a channel to start discussions on »",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":9,"column":87},"end":{"line":9,"column":141}}}))
    + "</a>\n</div>\n</div>\n";
},"useData":true})

});
define('home/views/ProfileRecentEmptyView',[
    'backbone-marionette',
    'home/templates/profileRecentEmpty',
], function (
    Marionette,
    profileRecentEmptyTemplate
) {
    'use strict';

    var ProfileRecentEmptyView = Marionette.ItemView.extend({
        template: profileRecentEmptyTemplate,
    });

    return ProfileRecentEmptyView;
});

define('home/templates/profileUserModule',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"aside__subheadings\">\n<h2 class=\"text-subheading\">Moderation Links</h2>\n</div>\n<ul class=\"nav--aside\">\n<li class=\"nav__item\">\n<a href=\"https://disqus.com/admin/moderate/all/search/user:"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"username") : depth0), depth0))
    + "\" class=\"nav-lnk -color-muted text-small\" target=\"_blank\">\nView User in Mod Panel\n</a>\n</li>\n<li class=\"nav__item\">\n<a href=\"https://disqus.com/disqus-admin/?action=user_lookup&username="
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"username") : depth0), depth0))
    + "\" class=\"nav-lnk -color-muted text-small\" target=\"_blank\">\nLookup User in Admin Panel\n</a>\n</li>\n<li class=\"nav__spacing hidden-md\"></li>\n<li class=\"nav__item\">\n<a href=\"#\" data-action=\"toggle-blacklist\" class=\"nav-lnk -color-muted text-small\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"isOnGlobalBlacklist") : depth0),{"name":"if","hash":{},"fn":container.program(2, data, 0),"inverse":container.program(4, data, 0),"data":data,"loc":{"start":{"line":25,"column":0},"end":{"line":29,"column":7}}})) != null ? stack1 : "")
    + "</a>\n</li>\n<li class=\"nav__item\">\n<a href=\"https://disqus.com/disqus-admin/blacklists/\" class=\"nav-lnk -color-muted text-small\">\nView Global Blacklist\n</a>\n</li>\n</ul>\n";
},"2":function(container,depth0,helpers,partials,data) {
    return "Remove from Global Blacklist\n";
},"4":function(container,depth0,helpers,partials,data) {
    return "Add to Global Blacklist\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"aside__wrap\">\n<div class=\"aside__content text-gray-dark\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"profileCoverAttributes"),depth0,{"name":"profileCoverAttributes","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n</div>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"isGlobalAdmin") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":6,"column":0},"end":{"line":38,"column":7}}})) != null ? stack1 : "");
},"usePartial":true,"useData":true})

});
define('home/views/ProfileUserModuleView',[
    'backbone-marionette',
    'moment',

    'home/mixins/withTruncate',
    'home/templates/profileUserModule',
    'home/models/Session',
], function (
    Marionette,
    moment,

    withTruncate,
    profileUserModuleTemplate,
    Session
) {
    'use strict';

    var ProfileUserModuleView = Marionette.ItemView.extend({
        template: profileUserModuleTemplate,

        events: {
            'click [data-action=toggle-blacklist]': 'toggleBlacklist',
        },

        templateHelpers: function () {
            return {
                joinDate: moment(this.model.get('joinedAt')).format('ll'),
                numLines: 9,
                isGlobalAdmin: Session.get().user.isGlobalAdmin(),
            };
        },

        toggleBlacklist: function () {
            if (this.model.get('isOnGlobalBlacklist')) {
                this.model.removeFromBlacklist();
            } else {
                this.model.confirmBlacklist({
                    notes: 'Added via user profile',
                    retroactive: true,
                });
            }
        },
    });

    withTruncate.call(ProfileUserModuleView.prototype);

    return ProfileUserModuleView;
});

define('home/templates/profileModerationDetailsModule',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"aside__subheadings\">\n<h2 class=\"text-subheading\">Comment Moderation</h2>\n</div>\n<div class=\"aside__wrap\">\n<div class=\"aside-user__body align text-small text-center padding-default\">\n<div class=\"align__item truncate-line\">\n<h3 class=\"text-large text-gray-darker\">"
    + alias2(alias1(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"counts") : depth0)) != null ? lookupProperty(stack1,"global") : stack1)) != null ? lookupProperty(stack1,"approved") : stack1), depth0))
    + "</h3>\nApproved\n</div>\n<div class=\"align__item truncate-line\">\n<h3 class=\"text-large text-gray-darker\">"
    + alias2(alias1(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"counts") : depth0)) != null ? lookupProperty(stack1,"global") : stack1)) != null ? lookupProperty(stack1,"spam") : stack1), depth0))
    + "</h3>\nSpam\n</div>\n<div class=\"align__item truncate-line\">\n<h3 class=\"text-large text-gray-darker\">"
    + alias2(alias1(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"counts") : depth0)) != null ? lookupProperty(stack1,"global") : stack1)) != null ? lookupProperty(stack1,"flagged") : stack1), depth0))
    + "</h3>\nFlagged\n</div>\n</div>\n</div>\n";
},"useData":true})

});
define('home/views/ProfileModerationDetailsModuleView',[
    'backbone-marionette',

    'home/templates/profileModerationDetailsModule',
], function (
    Marionette,

    profileModerationDetailsModuleTemplate
) {
    'use strict';

    var ProfileModerationDetailsModuleView = Marionette.ItemView.extend({
        template: profileModerationDetailsModuleTemplate,
    });

    return ProfileModerationDetailsModuleView;
});

define('home/views/ForumCardCollectionView',[
    'home/mixins/withItemRemovalSkipped',
    'home/mixins/withViewFeedTracking',

    'home/models/Session',

    'home/views/ForumCardView',
    'home/views/common/FetchableCollectionView',
], function (
    withItemRemovalSkipped,
    withViewFeedTracking,

    Session,

    ForumCardView,
    FetchableCollectionView
) {
    'use strict';

    /**
     * Shows a list of forum cards.
     * If list is empty, shows an empty state that includes the name of the user who
     * owns this list.
     *
     * Expects a collection of Forums or Channels with a link to their primaryForums.
     * Also expects a user option for the owner of this list.
     */
    var ForumCardCollectionView = FetchableCollectionView.extend({
        itemView: ForumCardView,
        className: 'cards',

        initialize: function () {
            FetchableCollectionView.prototype.initialize.apply(this, arguments);

            // ensure session user's following forums are fetched so that
            // following/followed buttons are displayed correctly
            var session = Session.get();
            session.loadPromise().then(function () {
                session.userProfile.forumsFollowing.ensureFetched();
            });
        },

        itemViewOptions: function (model) {
            // Collection may contain channels. Need to pass channel's
            // primary forum as the model of the ForumCardView
            if (model.primaryForum)
                return { model: model.primaryForum };
        },

        emptyViewOptions: function () {
            return { model: this.options.user };
        },
    });

    withItemRemovalSkipped.call(ForumCardCollectionView.prototype);
    withViewFeedTracking.call(ForumCardCollectionView.prototype);

    return ForumCardCollectionView;
});

define('home/templates/profileFollowingPeopleEmpty',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"empty-message\">\n\n<img class=\"empty-message__img\" src=\""
    + alias2(lookupProperty(helpers,"urlfor").call(alias1,"cdn",{"name":"urlfor","hash":{},"data":data,"loc":{"start":{"line":4,"column":37},"end":{"line":4,"column":53}}}))
    + "/img/empty-states/following-people.png\"/>\n\n<div class=\"empty-message__content\">\n<h2 class=\"text-larger\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"%(name)s isn't following anyone",{"name":"gettext","hash":{"name":(depth0 != null ? lookupProperty(depth0,"name") : depth0)},"data":data,"loc":{"start":{"line":7,"column":24},"end":{"line":7,"column":81}}}))
    + "</h2>\n<p class=\"text-gray text-medium\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Following people helps you keep up with what they’re saying and recommending.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":8,"column":33},"end":{"line":8,"column":124}}}))
    + "</p>\n<a href=\"/home/explore/people/\" class=\"button button-outline button-padding-wider text-large\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Find interesting people to follow »",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":9,"column":94},"end":{"line":9,"column":143}}}))
    + "</a>\n</div>\n</div>\n";
},"useData":true})

});
define('home/views/ProfileFollowingPeopleEmptyView',[
    'backbone-marionette',
    'home/templates/profileFollowingPeopleEmpty',
], function (
    Marionette,
    profileFollowingPeopleEmptyTemplate
) {
    'use strict';

    var ProfileFollowingPeopleEmptyView = Marionette.ItemView.extend({
        template: profileFollowingPeopleEmptyTemplate,
    });

    return ProfileFollowingPeopleEmptyView;
});

define('home/templates/profileFollowingCommunitiesEmpty',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"You aren't following any communities",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":9,"column":0},"end":{"line":9,"column":50}}}));
},"3":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"%(name)s isn't following any communities",{"name":"gettext","hash":{"name":(depth0 != null ? lookupProperty(depth0,"name") : depth0)},"data":data,"loc":{"start":{"line":11,"column":0},"end":{"line":11,"column":66}}}));
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"empty-message\">\n\n<img class=\"empty-message__img\" src=\""
    + alias2(lookupProperty(helpers,"urlfor").call(alias1,"cdn",{"name":"urlfor","hash":{},"data":data,"loc":{"start":{"line":4,"column":37},"end":{"line":4,"column":53}}}))
    + "/img/empty-states/following-communities.png\"/>\n\n<div class=\"empty-message__content\">\n<h2 class=\"text-larger\">"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"isSessionUser") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"data":data,"loc":{"start":{"line":8,"column":0},"end":{"line":12,"column":9}}})) != null ? stack1 : "")
    + "</h2>\n<p class=\"text-gray text-medium\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Following communities and channels helps you keep up with what their latest discussions.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":14,"column":33},"end":{"line":14,"column":135}}}))
    + "</p>\n<a href=\"/home/explore/\" class=\"button button-outline button-padding-wider text-large\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Find interesting communities to follow »",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":15,"column":87},"end":{"line":15,"column":141}}}))
    + "</a>\n</div>\n</div>\n";
},"useData":true})

});
define('home/views/ProfileFollowingCommunitiesEmptyView',[
    'backbone-marionette',
    'home/templates/profileFollowingCommunitiesEmpty',
], function (
    Marionette,
    profileFollowingCommunitiesEmptyTemplate
) {
    'use strict';

    /**
     * Shows a message that the backing user model doesn't follow any communities.
     * Expects a user model.
     */
    var ProfileFollowingCommunitiesEmptyView = Marionette.ItemView.extend({
        template: profileFollowingCommunitiesEmptyTemplate,
        templateHelpers: function () {
            return {
                isSessionUser: this.model.isSessionUser(),
            };
        },
    });

    return ProfileFollowingCommunitiesEmptyView;
});

define('home/templates/profileFollowing',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=container.lambda, alias2=container.escapeExpression, alias3=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<ul class=\"nav-tabs\">\n<li class=\"active\" data-action=\"switch-tab\" data-tab=\"people\">\n<a href=\"/by/"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"username") : depth0), depth0))
    + "/following/\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias3,"People %(numberFollowing)s",{"name":"gettext","hash":{"numberFollowing":lookupProperty(helpers,"tag").call(alias3,"span",{"name":"tag","hash":{"text":(depth0 != null ? lookupProperty(depth0,"numFollowing") : depth0),"data-role":"num-following","class":"nav-tab-stat"},"data":data,"loc":{"start":{"line":4,"column":57},"end":{"line":4,"column":134}}})},"data":data,"loc":{"start":{"line":4,"column":0},"end":{"line":4,"column":136}}}))
    + "\n</a>\n</li>\n<li data-action=\"switch-tab\" data-tab=\"sites\">\n<a href=\"/by/"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"username") : depth0), depth0))
    + "/following/sites/\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias3,"Communities %(numberFollowing)s",{"name":"gettext","hash":{"numberFollowing":lookupProperty(helpers,"tag").call(alias3,"span",{"name":"tag","hash":{"text":(depth0 != null ? lookupProperty(depth0,"numCommunitiesFollowing") : depth0),"data-role":"num-forums-following","class":"nav-tab-stat"},"data":data,"loc":{"start":{"line":9,"column":62},"end":{"line":9,"column":157}}})},"data":data,"loc":{"start":{"line":9,"column":0},"end":{"line":9,"column":159}}}))
    + "\n</a>\n</li>\n</ul>\n<div data-role=\"content-area\"></div>\n<div data-role=\"footer-area\"></div>\n";
},"useData":true})

});
define('home/views/ProfileFollowingView',[
    'underscore',

    'home/views/common/TabbedView',
    'home/views/UserCollectionView',
    'home/views/ForumCardCollectionView',
    'home/views/common/FetchableCollectionFooterView',
    'home/views/ProfileFollowingPeopleEmptyView',
    'home/views/ProfileFollowingCommunitiesEmptyView',

    'home/templates/profileFollowing',
], function (
    _,

    TabbedView,
    UserCollectionView,
    ForumCardCollectionView,
    FetchableCollectionFooterView,
    ProfileFollowingPeopleEmptyView,
    ProfileFollowingCommunitiesEmptyView,

    profileFollowingTemplate
) {
    'use strict';

    /**
     * The view that appears in a user profile following tab. Handles switching between
     * the following feeds for users and forums.
     */
    var ProfileFollowingView = TabbedView.extend({
        defaultTab: 'people',

        template: profileFollowingTemplate,
        templateHelpers: function () {
            return {
                numCommunitiesFollowing: this.model.getNumCommunitiesFollowing(),
            };
        },

        regions: _.defaults({
            footerRegion: '[data-role=footer-area]',
        }, TabbedView.prototype.regions),

        modelEvents: {
            'change:numFollowing': 'updateNumFollowing',
            'change:numForumsFollowing': 'updateNumForumsFollowing',
            'change:numChannelsFollowing': 'updateNumForumsFollowing',
        },

        initialize: function (options) {
            TabbedView.prototype.initialize.apply(this, arguments);

            this.userProfile = options.userProfile;
        },

        getDefaultOptions: function (activeTab) {
            var feed = activeTab === 'sites' ?
                this.userProfile.forumsFollowing :
                this.userProfile.following;
            return {
                user: this.model,
                model: feed,
                collection: feed.items,
                emptyView: activeTab === 'people' ?
                    ProfileFollowingPeopleEmptyView : ProfileFollowingCommunitiesEmptyView,
                infiniteScroll: true,
            };
        },

        updateTabContent: function (newView) {
            TabbedView.prototype.updateTabContent.call(this, newView);

            this.footerRegion.show(new FetchableCollectionFooterView(this.getDefaultOptions(this.activeTab)));
        },

        updateNumFollowing: function () {
            this.$('[data-role=num-following]').text(this.model.get('numFollowing'));
        },

        updateNumForumsFollowing: function () {
            this.$('[data-role=num-forums-following]').text(this.model.getNumCommunitiesFollowing());
        },

        getTrackingSection: function (activeTab) {
            return activeTab === 'sites' ?
                'following-communities' :
                'following-default';
        },

        getTabView: function (activeTab) {
            var defaultOptions = this.getDefaultOptions(activeTab);
            var view;

            switch (activeTab) {
            case 'people':
                view = new UserCollectionView(defaultOptions);
                break;

            case 'sites':
                view = new ForumCardCollectionView(defaultOptions);
                break;
            default:
                return;
            }

            view.model.ensureFetched();
            return view;
        },
    });

    return ProfileFollowingView;
});

define('home/templates/forumBadgesItem',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<span class='badge-image-wrapper'>\n<img class='user-badge-image' src="
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"badge") : depth0)) != null ? lookupProperty(stack1,"image") : stack1), depth0))
    + " alt="
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"badge") : depth0)) != null ? lookupProperty(stack1,"name") : stack1), depth0))
    + " />\n<div class='badge-tooltip__container'>\n<div class='tooltip show badge-tooltip'>\n<span class='badge-tooltip__content'>\n<span class='badge-tooltip__name'>\n"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"badgeCriteriaText") : depth0), depth0))
    + "\n</span>\n</span>\n</div>\n</div>\n</span>\n<span class='user-badge-title'>"
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"badge") : depth0)) != null ? lookupProperty(stack1,"name") : stack1), depth0))
    + "</span>";
},"useData":true})

});
define('home/views/ForumBadgesItemView',[
    'backbone-marionette',

    'home/templates/forumBadgesItem',
], function (
    Marionette,

    ForumBadgesItemTemplate
) {
    'use strict';

    /**
     * A single item in a forum badges profile tab.
     */
    var ForumBadgesItemView = Marionette.ItemView.extend({
        className: 'user-badge show-title badge-tooltip__wrapper',
        template: ForumBadgesItemTemplate,

        initialize: function (options) {
            this.index = options.index;
        },

        templateHelpers: function () {
            return {
                badge: this.model.toJSON(),
                badgeCriteriaText: this.model.getCriteriaText(),
            };
        },
    });

    return ForumBadgesItemView;
});

define('home/templates/forumBadgesCard',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var alias1=container.escapeExpression, alias2=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<span class='text-base text-semibold'>"
    + alias1(container.lambda((depth0 != null ? lookupProperty(depth0,"forumBadgeCount") : depth0), depth0))
    + "</span>&nbsp;\n"
    + alias1(lookupProperty(helpers,"gettext").call(alias2,"Badges on %(forumLink)s",{"name":"gettext","hash":{"forumLink":lookupProperty(helpers,"getPartial").call(alias2,"forumLink",(depth0 != null ? lookupProperty(depth0,"forum") : depth0),{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":5,"column":48},"end":{"line":5,"column":78}}})},"data":data,"loc":{"start":{"line":5,"column":0},"end":{"line":5,"column":80}}}))
    + "\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class='card-discussion card-badges'>\n<div class='card-reason card-forum'>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"forum") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":3,"column":0},"end":{"line":6,"column":7}}})) != null ? stack1 : "")
    + "</div>\n<div class='forum-badges-wrapper' data-role='forum-badges' />\n</div>";
},"useData":true})

});
define('home/views/ForumBadgesCardView',[
    'backbone-marionette',

    'home/views/ForumBadgesItemView',
    'home/templates/forumBadgesCard',
], function (
    Marionette,

    ForumBadgesItemView,
    ForumBadgesCardTemplate
) {
    'use strict';

    var ForumBadgesCardView = Marionette.CompositeView.extend({
        template: ForumBadgesCardTemplate,
        itemView: ForumBadgesItemView,
        itemViewContainer: '[data-role=forum-badges]',
        className: 'card card-profile card-profile-badges',

        initialize: function () {
            this.collection = this.model && this.model.get('badges');
        },

        itemViewOptions: function (item) {
            return {
                index: this.collection.indexOf(item),
                badgesPerRow: this.badgesPerRow || this.collection.length,
            };
        },

        templateHelpers: function () {
            return {
                forum: this.model.forum.toJSON(),
                forumBadgeCount: this.model.get('badges').length,
            };
        },
    });

    return ForumBadgesCardView;
});

define('home/views/ForumBadgesCollectionView',[
    'underscore',

    'home/views/ForumBadgesCardView',
    'home/views/common/FetchableCollectionView',
], function (
    _,

    ForumBadgesCardView,
    FetchableCollectionView
) {
    'use strict';

    /**
     * A collection of a user's badges on each forum
     */
    var ForumBadgesCollectionView = FetchableCollectionView.extend({

        itemView: ForumBadgesCardView,

        events: _.defaults({}, FetchableCollectionView.prototype.events),

        initialize: function (options) {
            FetchableCollectionView.prototype.initialize.call(this, options);

            // The user to whom this collection of forum-badges belongs
            this.user = options.user;
        },

        emptyViewOptions: function () {
            return {
                model: this.options.user,
            };
        },
    });

    return ForumBadgesCollectionView;
});

define('home/views/common/EnclosedModuleView',[
    'backbone-marionette',
], function (
    Marionette
) {
    'use strict';

    /**
     * Parent class for an enclosed module that shows a list of items.
     * Can specify a max number to show, as a class variable called ITEMS_MAX.
     *
     * Child classes must define:
     *   - itemView: A view for each item in the list
     *   - itemViewContainer: The container where the list of items will be inserted
     *  - template: A template containing the specified itemViewContainer
     *
     * Expects to be backed by a collection of ActivityFeedItems that have
     * related threads.
     */
    var EnclosedModuleView = Marionette.CompositeView.extend({
        // Must define itemView,itemViewContainer, and template

        className: 'aside__wrap -padded',

        addItemView: function (item, ItemView, index) {
            if (this.constructor.ITEMS_MAX && index > this.constructor.ITEMS_MAX - 1) {
                return;
            }
            return Marionette.CompositeView.prototype.addItemView.call(this, item, ItemView, index);
        },
    });

    return EnclosedModuleView;
});

define('home/templates/discussionsModuleItem',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    return " no-image";
},"3":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"image") : depth0),{"name":"if","hash":{},"fn":container.program(4, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":4,"column":0},"end":{"line":12,"column":7}}})) != null ? stack1 : "");
},"4":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"link") : stack1), depth0))
    + "\"\ndata-link-name=\"image\"\ndata-link-out=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"signedLink") : stack1), depth0))
    + "\"\ndata-thread-id=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + "\">\n\n<img src=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"image") : depth0)) != null ? lookupProperty(stack1,"src") : stack1), depth0))
    + "\" alt=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"image") : depth0)) != null ? lookupProperty(stack1,"title") : stack1), depth0))
    + "\" class=\"img-fit-sm\" />\n</a>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"post-comments clearfix"
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"image") : depth0),{"name":"unless","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":1,"column":34},"end":{"line":1,"column":71}}})) != null ? stack1 : "")
    + "\">\n<div class=\"pull-right spacing-left-small\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"canShowThreadImage") : depth0),{"name":"if","hash":{},"fn":container.program(3, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":3,"column":0},"end":{"line":13,"column":7}}})) != null ? stack1 : "")
    + "</div>\n<div class=\"card-body\">\n<div class=\"text-medium spacing-bottom-narrow\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"threadTitle"),depth0,{"name":"threadTitle","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n<div class=\"text-small text-gray link-inner-gray\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"channelAwareForumLink"),((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1),{"name":"channelAwareForumLink","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "<time class=\"time\">"
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"relativeTime") : depth0), depth0))
    + "</time>\n</div>\n</div>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/DiscussionsModuleItemView',[
    'backbone-marionette',
    'home/utils/layoutUtils',

    'home/templates/discussionsModuleItem',
], function (
    Marionette,
    layoutUtils,

    discussionsModuleItemTemplate
) {
    'use strict';

    /**
     * A single item in a discussions module.
     *
     * Expects an ActivityFeedItem model that has a related thread model.
     */
    var DiscussionsModuleItemView = Marionette.ItemView.extend({
        className: 'post-comments__wrapper',

        template: discussionsModuleItemTemplate,
        templateHelpers: function () {
            var thread = this.model.thread;
            return {
                image: thread && thread.getImage(),
                numTitleLines: 3,
                canShowThreadImage: !layoutUtils.isNarrowLayout(),
            };
        },
    });

    return DiscussionsModuleItemView;
});

define('home/templates/profileRecommendedModule',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<header class=\"module-header text-center\">\n<div class=\"module-header__icon\">\n<span class=\"icon icon-latest-recommendation text-brand\"></span>\n</div>\n<div class=\"module-header__title\">\n<h2 class=\"module-header__heading\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Latest Recommendations",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":6,"column":35},"end":{"line":6,"column":71}}}))
    + "</h2>\n</div>\n</header>\n\n<div data-role=\"posts\" class=\"module-body\"></div>\n\n<footer data-action=\"switch-tab\" data-tab=\"favorites\" class=\"module-footer\">\n<a href=\"/by/"
    + alias2(container.lambda((depth0 != null ? lookupProperty(depth0,"username") : depth0), depth0))
    + "/favorites/\" class=\"nav-lnk -color-muted -flushed\">\n<div class=\"nav-lnk__blk\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"See All Recommendations",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":14,"column":26},"end":{"line":14,"column":63}}}))
    + "</div>\n<div class=\"nav-lnk__pointer\">\n<span class=\"icon icon-right-bracket\"></span>\n</div>\n</a>\n</footer>\n";
},"useData":true})

});
define('home/views/ProfileRecommendedModuleView',[
    'home/views/common/EnclosedModuleView',
    'home/views/DiscussionsModuleItemView',
    'home/templates/profileRecommendedModule',
], function (
    EnclosedModuleView,
    DiscussionsModuleItemView,
    profileRecommendedModuleTemplate
) {
    'use strict';

    var ProfileRecommendedModuleView = EnclosedModuleView.extend({
        itemView: DiscussionsModuleItemView,
        itemViewContainer: '[data-role=posts]',
        template: profileRecommendedModuleTemplate,
    }, {
        ITEMS_MAX: 3,
    });

    return ProfileRecommendedModuleView;
});

define('home/templates/badgesModuleItem',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, alias3=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<span class='user-badge badge-tooltip__wrapper'>\n<a href='"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"badgesLink") : depth0), depth0))
    + "'>\n<img class='user-badge-image' src='"
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"badge") : depth0)) != null ? lookupProperty(stack1,"image") : stack1), depth0))
    + "' alt='"
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"badge") : depth0)) != null ? lookupProperty(stack1,"name") : stack1), depth0))
    + "' />\n</a>\n<div class='badge-tooltip__container'>\n<div class='tooltip show badge-tooltip "
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"tooltipPosition") : depth0), depth0))
    + "'>\n<span class='badge-tooltip__content'>\n<span class='text-semibold'>"
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"badge") : depth0)) != null ? lookupProperty(stack1,"name") : stack1), depth0))
    + "</span> "
    + alias2(lookupProperty(helpers,"gettext").call(alias3,"on %(forumLink)s",{"name":"gettext","hash":{"forumLink":lookupProperty(helpers,"getPartial").call(alias3,"forumLink",(depth0 != null ? lookupProperty(depth0,"forum") : depth0),{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":8,"column":91},"end":{"line":8,"column":121}}})},"data":data,"loc":{"start":{"line":8,"column":50},"end":{"line":8,"column":123}}}))
    + "\n</span>\n</div>\n</div>\n</span>\n";
},"useData":true})

});
define('home/views/BadgesModuleItemView',[
    'backbone-marionette',

    'home/templates/badgesModuleItem',
], function (
    Marionette,

    BadgesModuleItemTemplate
) {
    'use strict';

    /**
     * A single item in a badges profile module.
     */
    var BadgesModuleItemView = Marionette.ItemView.extend({
        className: 'user-badge__wrapper',
        template: BadgesModuleItemTemplate,

        initialize: function (options) {
            this.index = options.index;
            this.username = options.username;
        },

        calcTooltipPosition: function () {
            var rowCount = 5;
            var rowOffset = this.index % rowCount;
            if (rowOffset > 1) {
                return 'tooltip-right';
            }
            return 'tooltip-left';
        },

        templateHelpers: function () {
            var badgesLink = this.username ? '/by/' + this.username + '/badges/' : '#';
            return {
                index: this.index,
                badge: this.model.toJSON(),
                badgesLink: badgesLink,
                forum: this.model.forum && this.model.forum.toJSON(),
                tooltipPosition: this.calcTooltipPosition(),
            };
        },
    });

    return BadgesModuleItemView;
});

define('home/templates/profileBadgesModule',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<header class='module-header text-center'>\n<div class='module-header__icon'>\n<span class='icon icon-badges text-brand'></span>\n</div>\n<div class='module-header__title'>\n<h2 class='module-header__heading'>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Badges",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":6,"column":35},"end":{"line":6,"column":55}}}))
    + "</h2>\n</div>\n</header>\n\n<div data-role='user-badges' class='module-body user-badges-profile-collection'></div>\n\n<footer data-action='switch-tab' data-tab='badges' class='module-footer'>\n<a href='/by/"
    + alias2(container.lambda((depth0 != null ? lookupProperty(depth0,"username") : depth0), depth0))
    + "/badges/' class='nav-lnk -color-muted -flushed'>\n<div class='nav-lnk__blk'>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"See All Badges",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":14,"column":26},"end":{"line":14,"column":54}}}))
    + "</div>\n<div class='nav-lnk__pointer'>\n<span class='icon icon-right-bracket'></span>\n</div>\n</a>\n</footer>";
},"useData":true})

});
define('home/views/ProfileBadgesModuleView',[
    'home/views/common/EnclosedModuleView',
    'home/views/BadgesModuleItemView',
    'home/templates/profileBadgesModule',
], function (
    EnclosedModuleView,
    BadgesModuleItemView,
    ProfileBadgesModuleTemplate
) {
    'use strict';

    /**
     * Parent class for an enclosed module that shows a list of badges.
     * Can specify a max number to show, as a class variable called ITEMS_MAX.
     *
     * Child classes must define template which should define the content
     * region with data-role=user-badges.
     */
    var ProfileBadgesModuleView = EnclosedModuleView.extend({
        template: ProfileBadgesModuleTemplate,
        itemView: BadgesModuleItemView,
        itemViewContainer: '[data-role=user-badges]',

        itemViewOptions: function (item) {
            // Pass the index to the itemView for positioning the tooltip
            return {
                index: this.collection.indexOf(item),
                username: this.model.get('username'),
            };
        },
    }, {
        ITEMS_MAX: 10,
    });

    return ProfileBadgesModuleView;
});

define('home/templates/profileCommentsModulePost',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"post-comments\">\n<div class=\"spacing-bottom-narrow\">\n<a href=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"discussionRoute") : depth0), depth0))
    + "#comment-"
    + alias2(alias1(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"postActivity") : depth0)) != null ? lookupProperty(stack1,"object") : stack1)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + "\" class=\"link-gray-dark truncate\" data-truncate-lines=\"2\">\n"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"message") : depth0), depth0))
    + "\n</a>\n</div>\n<div class=\"link-gray text-gray text-small\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"channelAwareForumLink"),((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1),{"name":"channelAwareForumLink","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "<time class=\"time\">"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"relativeTime") : depth0), depth0))
    + "</time>\n</div>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/ProfileCommentsModulePostView',[
    'backbone-marionette',
    'core/utils/html',

    'home/templates/profileCommentsModulePost',
    'home/mixins/withTruncate',
], function (
    Marionette,
    html,

    profileCommentsModulePostTemplate,
    withTruncate
) {
    'use strict';

    var ProfileCommentsModulePostView = Marionette.ItemView.extend({
        template: profileCommentsModulePostTemplate,
        className: 'post-comments__wrapper',

        templateHelpers: function () {
            var postActivity = this.getPostActivity();

            return {
                discussionRoute: this.model.thread.getDiscussionRoute(),
                postActivity: postActivity.toJSON(),
                relativeTime: postActivity.getRelativeCreatedAt(),
                message: html.stripTags(postActivity.object.get('message')),
            };
        },

        // The backend does not group activities for this feed,
        // so there should only be 1 activity to display
        getPostActivity: function () {
            return this.model.activities[0];
        },
    });

    withTruncate.call(ProfileCommentsModulePostView.prototype);

    return ProfileCommentsModulePostView;
});

define('home/templates/profileCommentsModule',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<header class=\"module-header text-center\">\n<div class=\"module-header__icon\">\n<span class=\"icon icon-latest-comments text-brand\"></span>\n</div>\n<div class=\"module-header__title\">\n<h2 class=\"module-header__heading\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Latest Comments",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":6,"column":35},"end":{"line":6,"column":64}}}))
    + "</h2>\n</div>\n</header>\n\n<div data-role=\"posts\" class=\"module-body\"></div>\n\n<footer data-action=\"switch-tab\" data-tab=\"comments\" class=\"module-footer\">\n<a href=\"/by/"
    + alias2(container.lambda((depth0 != null ? lookupProperty(depth0,"username") : depth0), depth0))
    + "/comments/\" class=\"nav-lnk -color-muted -flushed\">\n<div class=\"nav-lnk__blk\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"See All Comments",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":14,"column":26},"end":{"line":14,"column":56}}}))
    + "</div>\n<div class=\"nav-lnk__pointer\">\n<span class=\"icon icon-right-bracket\"></span>\n</div>\n</a>\n</footer>\n";
},"useData":true})

});
define('home/views/ProfileCommentsModuleView',[
    'backbone-marionette',

    'home/views/ProfileCommentsModulePostView',
    'home/templates/profileCommentsModule',
], function (
    Marionette,

    ProfileCommentsModulePostView,
    profileCommentsModuleTemplate
) {
    'use strict';

    var ProfileCommentsModuleView = Marionette.CompositeView.extend({
        template: profileCommentsModuleTemplate,
        className: 'aside__wrap -padded',

        itemView: ProfileCommentsModulePostView,
        itemViewContainer: '[data-role=posts]',

        itemViewOptions: function (_item, index) {
            // Only show the first 3 items
            if (index > 2)
                return { className: 'hidden' };
        },
    });

    return ProfileCommentsModuleView;
});

define('home/templates/profileModuleActiveForums',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"aside__subheadings\">\n<h2 class=\"text-subheading\">"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Frequented Communities",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":2,"column":28},"end":{"line":2,"column":64}}}))
    + "</h2>\n</div>\n<div class=\"aside__wrap\">\n<div data-role=\"forums\"></div>\n</div>\n";
},"useData":true})

});
define('home/views/UserActiveForumsModuleView',[
    'backbone-marionette',

    'home/views/FollowingCardView',

    'home/templates/profileModuleActiveForums',
], function (
    Marionette,

    FollowingCardView,

    profileModuleActiveForumsTemplate
) {
    'use strict';

    var UserActiveForumsModuleView = Marionette.CompositeView.extend({
        template: profileModuleActiveForumsTemplate,

        itemView: FollowingCardView,
        itemViewContainer: '[data-role=forums]',
    });

    return UserActiveForumsModuleView;
});

define('home/templates/blockedProfile',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"empty-message empty-message-private\">\n<div class=\"empty-message-private-face-wrapper\">\n<svg width=\"123\" height=\"122\" viewBox=\"0 0 123 122\" xmlns=\"http://www.w3.org/2000/svg\">\n<g fill=\"none\" fill-rule=\"evenodd\">\n<path d=\"M0 61C0 27.312 27.543 0 61.5 0S123 27.312 123 61s-27.543 61-61.5 61S0 94.688 0 61\" fill=\"#FFF\"/>\n<path d=\"M39 28.507C39 26.017 41.015 24 43.493 24 45.983 24 48 26.017 48 28.507 48 30.982 45.984 33 43.493 33 41.015 33 39 30.982 39 28.507M75 28.5c0-2.485 2.015-4.5 4.507-4.5C81.984 24 84 26.015 84 28.5S81.984 33 79.507 33C77.015 33 75 30.985 75 28.5\" fill=\"#164B78\"/>\n<path d=\"M83 40c0-6.62 5.38-12 12-12s12 5.38 12 12c0 6.622-5.38 12-12 12s-12-5.378-12-12M15 40c0-6.62 5.38-12 12-12s12 5.38 12 12c0 6.622-5.38 12-12 12s-12-5.378-12-12\" fill=\"#CCE9FF\"/>\n<path d=\"M93 38c0-1.107.893-2 2-2s2 .893 2 2-.893 2-2 2-2-.893-2-2M87 30c0-1.107.893-2 2-2s2 .893 2 2-.893 2-2 2-2-.893-2-2M97 30c0-1.107.893-2 2-2s2 .893 2 2-.893 2-2 2-2-.893-2-2M21 38c0-1.107.893-2 2-2s2 .893 2 2-.893 2-2 2-2-.893-2-2M15 30c0-1.107.893-2 2-2s2 .893 2 2-.893 2-2 2-2-.893-2-2M25 30c0-1.107.893-2 2-2s2 .893 2 2-.893 2-2 2-2-.893-2-2\" fill=\"#2E9FFF\"/>\n<g opacity=\".5\" stroke=\"#EF675D\" stroke-width=\"3\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\n<path d=\"M54.333 37.333L69.57 52.57M54.333 52.667L69.57 37.43\"/>\n</g>\n</g>\n</svg>\n</div>\n<div class=\"empty-message__content\">\n<p class=\"text-red text-large\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"You've blocked this user.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":16,"column":31},"end":{"line":16,"column":70}}}))
    + "</p>\n<p class=\"text-gray text-medium\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"You won't see any comments from this user on Disqus in discussions, notifications, and more.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":17,"column":33},"end":{"line":17,"column":139}}}))
    + "</p>\n<a href=\"/home/settings/blocking\" class=\"button button-fill--brand button-medium\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Manage blocked users",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":18,"column":82},"end":{"line":18,"column":116}}}))
    + "</a>\n</div>\n</div>\n";
},"useData":true})

});
define('home/templates/profileView',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    return "<div data-role=\"email-verification-alert\"></div>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"section-expanded sidebar-fixed\">\n<div class=\"cover cover-profile\" data-role=\"cover-area\"></div>\n</div>\n<div class=\"section-contained\">\n<div class=\"layout -top-narrow\">\n<div class=\"layout__main-with-aside\">\n<div class=\"layout__nav hidden-lg\">\n<div data-role=\"user-module\"></div>\n<div data-role=\"moderation-module\"></div>\n<div data-role=\"active-forums-module\" data-jester-area=\"active-forums-module\"></div>\n</div>\n<div class=\"layout__content\">\n<div class=\"hidden-sidebar\" data-role=\"alert-message\"></div>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"isSessionUser") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":14,"column":0},"end":{"line":16,"column":7}}})) != null ? stack1 : "")
    + "<div class=\"sidebar-scrollable profile-scrollable scrollable-measure-selector\"\ndata-role=\"content-area\"></div>\n</div>\n</div>\n<aside class=\"layout__aside hidden-md\">\n<div data-role=\"sign-up-module\"></div>\n<div data-role=\"comments-module\" data-jester-area=\"comments-module\" class=\"module--aside\"></div>\n<div data-role=\"badges-module\" data-jester-area=\"badges-module\" class=\"module--aside\"></div>\n<div data-role=\"recommended-module\" data-jester-area=\"recommended-module\" class=\"module--aside\"></div>\n<div class=\"text-smaller text-gray\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"homeFooter"),depth0,{"name":"homeFooter","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n</aside>\n</div>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/templates/privateProfile',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"empty-message empty-message-private\">\n<div class=\"empty-message-private-face-wrapper\">\n<svg class=\"art-private-sunglasses\"xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" version=\"1.1\" x=\"0px\" y=\"0px\" viewBox=\"0 0 150.5 25\" enable-background=\"new 0 0 150.5 25\" xml:space=\"preserve\">\n<polygon points=\"10.5,0 10.5,5 31.5,5 31.5,10 35.5,10 35.5,15 40.5,15 40.5,20 45.5,20 45.5,25 80.5,25 80.5,20 85.5,20 85.5,15 90.5,15 90.5,10 100.5,10 100.5,15 105.5,15 105.5,20 140.5,20 140.5,15 145.5,15 145.5,10 150.5,10 150.5,5 150.5,0\"/>\n<rect x=\"0.5\" y=\"5\" width=\"10\" height=\"5\"/>\n<rect x=\"40.5\" y=\"5\" width=\"5\" height=\"5\" class=\"shading\"/>\n<rect x=\"45.5\" y=\"10\" width=\"5\" height=\"5\" class=\"shading\"/>\n<rect x=\"50.5\" y=\"15\" width=\"5\" height=\"5\" class=\"shading\"/>\n<rect x=\"60.5\" y=\"15\" width=\"5\" height=\"5\" class=\"shading\"/>\n<rect x=\"55.5\" y=\"10\" width=\"5\" height=\"5\" class=\"shading\"/>\n<rect x=\"110.5\" y=\"10\" width=\"5\" height=\"5\" class=\"shading\"/>\n<rect x=\"120.5\" y=\"10\" width=\"5\" height=\"5\" class=\"shading\"/>\n<rect x=\"50.5\" y=\"5\" width=\"5\" height=\"5\" class=\"shading\"/>\n<rect x=\"105.5\" y=\"5\" width=\"5\" height=\"5\" class=\"shading\"/>\n<rect x=\"115.5\" y=\"5\" width=\"5\" height=\"5\" class=\"shading\"/>\n</svg>\n<svg class=\"art-private-face\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" version=\"1.1\" x=\"0px\" y=\"0px\" viewBox=\"0 0 130 130\" enable-background=\"new 0 0 130 130\" xml:space=\"preserve\"><circle cx=\"65\" cy=\"65\" r=\"65\"/><path d=\"M14 41.6c0-5.5 4.7-10 10.5-10S35 36.1 35 41.6s-4.7 10-10.5 10 S14 47.2 14 41.6z\"/><path d=\"M95 40.6c0-5.5 4.7-10 10.5-10s10.5 4.5 10.5 10s-4.7 10-10.5 10 S95 46.2 95 40.6z\"/><rect x=\"51\" y=\"62.6\" width=\"46\" height=\"4\"/></svg>\n</div>\n<div> \n<svg class=\"art-private-text\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" version=\"1.1\" x=\"0px\" y=\"0px\" viewBox=\"0 0 240 35\" enable-background=\"new 0 0 240 35\" xml:space=\"preserve\">\n<rect x=\"80\" width=\"5\" height=\"35\"/>\n<polygon points=\"165,0 160,0 160,10 155,10 155,15 160,15 160,35 165,35 165,15 170,15 170,10 165,10\"/>\n<polygon points=\"180,10 180,0 175,0 175,35 180,35 180,15 190,15 190,10\"/>\n<rect x=\"190\" y=\"15\" width=\"5\" height=\"20\"/>\n<polygon points=\"5,30 5,5 20,5 20,0 0,0 0,35 20,35 20,30\"/>\n<polygon points=\"45,20 35,20 35,15 30,15 30,30 35,30 35,25 50,25 50,15 45,15\"/>\n<rect x=\"35\" y=\"10\" width=\"10\" height=\"5\"/>\n<polygon points=\"60,10 60,15 70,15 70,30 60,30 60,35 75,35 75,10\"/>\n<rect x=\"105\" y=\"10\" width=\"5\" height=\"20\"/>\n<rect x=\"120\" y=\"10\" width=\"5\" height=\"20\"/>\n<rect x=\"135\" y=\"10\" width=\"5\" height=\"20\"/>\n<rect x=\"145\" y=\"10\" width=\"5\" height=\"25\"/>\n<rect x=\"145\" width=\"5\" height=\"5\"/>\n<polygon points=\"235,10 235,0 230,0 230,10 225,10 225,15 230,15 230,35 235,35 235,15 240,15 240,10\"/>\n<rect x=\"215\" y=\"10\" width=\"5\" height=\"25\"/>\n<rect x=\"215\" width=\"5\" height=\"5\"/>\n<rect x=\"110\" y=\"30\" width=\"10\" height=\"5\"/>\n<rect x=\"125\" y=\"30\" width=\"10\" height=\"5\"/>\n<rect x=\"35\" y=\"30\" width=\"10\" height=\"5\"/>\n<rect x=\"55\" y=\"15\" width=\"5\" height=\"15\"/>\n<rect x=\"20\" y=\"5\" width=\"5\" height=\"25\"/>\n</svg>\n</div>\n<div class=\"empty-message__content\">\n<p class=\"text-gray text-medium\">This user's activity is private <span class=\"icon-lock icon__position -inline-swap\"></span></span></p>\n<a href=\"/home/explore/people/\" class=\"button button-fill--brand button-padding-wider text-large\">"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Find other interesting people »",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":46,"column":98},"end":{"line":46,"column":143}}}))
    + "</a>\n</div>\n\n</div>\n";
},"useData":true})

});
define('home/templates/profileAlertBlockError',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Unfortunately this user could not be blocked; you have reached the limit for number of users blocked.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":4,"column":0},"end":{"line":4,"column":115}}}))
    + "\n";
},"3":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Something went wrong while trying to block this user. Please try again later.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":6,"column":0},"end":{"line":6,"column":91}}}))
    + "\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"alert alert--error text-small\">\n<span class=\"icon-warning icon-tiny icon__position -inline\"></span>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"isLimitError") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"data":data,"loc":{"start":{"line":3,"column":0},"end":{"line":7,"column":7}}})) != null ? stack1 : "")
    + "</div>\n";
},"useData":true})

});
define('home/templates/profileAlertPrivate',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"alert alert--brand text-small\">\n<span class=\"icon-lock icon-tiny icon__position -inline\"></span>\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"This user's profile has been set to private.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":3,"column":0},"end":{"line":3,"column":58}}}))
    + "\n</div>\n";
},"useData":true})

});
define('home/views/ProfileView',[
    'underscore',
    'backbone-marionette',

    'core/api',
    'core/strings',
    'core/switches',

    'home/utils/backboneUtils',

    'home/views/common/TabbedView',
    'home/views/ProfileCoverView',
    'home/views/ProfileCardCollectionView',
    'home/views/ProfileBadgesEmptyView',
    'home/views/ProfileCommentsEmptyView',
    'home/views/ProfileFavoritesEmptyView',
    'home/views/ProfileFollowersEmptyView',
    'home/views/ProfileRecentEmptyView',
    'home/views/ProfileUserModuleView',
    'home/views/ProfileModerationDetailsModuleView',
    'home/views/common/FetchableCollectionLayout',
    'home/views/ProfileFollowingView',
    'home/views/FollowerCollectionView',
    'home/views/ForumBadgesCollectionView',
    'home/views/ProfileRecommendedModuleView',
    'home/views/ProfileBadgesModuleView',
    'home/views/ProfileCommentsModuleView',
    'home/views/ProfileModuleEmptyView',
    'home/views/UserActiveForumsModuleView',

    'home/templates/blockedProfile',
    'home/templates/profileView',
    'home/templates/spinnerTall',
    'home/templates/privateProfile',
    'home/templates/profileAlertBlockError',
    'home/templates/profileAlertPrivate',

    'home/mixins/withClickLinkTracking',
    'home/mixins/withEmailVerificationAlert',
    'home/mixins/withLoginOverlay',
    'home/models/Session',
], function (
    _,
    Marionette,

    api,
    strings,
    switches,

    backboneUtils,

    TabbedView,
    ProfileCoverView,
    ProfileCardCollectionView,
    ProfileBadgesEmptyView,
    ProfileCommentsEmptyView,
    ProfileFavoritesEmptyView,
    ProfileFollowersEmptyView,
    ProfileRecentEmptyView,
    ProfileUserModuleView,
    ProfileModerationDetailsModuleView,
    FetchableCollectionLayout,
    ProfileFollowingView,
    FollowerCollectionView,
    ForumBadgesCollectionView,
    ProfileRecommendedModuleView,
    ProfileBadgesModuleView,
    ProfileCommentsModuleView,
    ProfileModuleEmptyView,
    UserActiveForumsModuleView,

    blockedProfileTemplate,
    profileViewTemplate,
    spinnerTallTemplate,
    privateProfileTemplate,
    alertBlockErrorTemplate,
    alertPrivateTemplate,

    withClickLinkTracking,
    withEmailVerificationAlert,
    withLoginOverlay,
    Session
) {
    'use strict';

    var gettext = strings.get;

    var ProfileView = TabbedView.extend({
        defaultTab: 'comments',

        /**
         * Determines which template to show. If the user has not been
         * fetched, shows a loading icon. Otherwise renders the profile
         * view.
         * This is done because both the feed area and the cover area show
         * spinners while loading their respective content, and 2 spinners on
         * the page looks weird.
         * @param  {Object} data - JSON representation of this view's model
         * @returns {function}    - The function to return the html for this view
         */
        template: function (data) {
            if (!data.user.name) {
                return spinnerTallTemplate;
            }

            return profileViewTemplate(data);
        },

        templateHelpers: function () {
            return {
                isSessionUser: this.model.user.isSessionUser(),
            };
        },

        regions: _.defaults({
            coverRegion: '[data-role=cover-area]',
            userModuleRegion: '[data-role=user-module]',
            badgesModuleRegion: '[data-role=badges-module]',
            recommendedModuleRegion: '[data-role=recommended-module]',
            commentsModuleRegion: '[data-role=comments-module]',
            alertRegion: '[data-role=alert-message]',
            activeForumsModuleRegion: '[data-role=active-forums-module]',
            moderationModuleRegion: '[data-role=moderation-module]',
        }, TabbedView.prototype.regions),

        events: _.defaults({
            'click a[data-link-name]': 'trackClickLink',
        }, TabbedView.prototype.events),

        initialize: function (options) {
            TabbedView.prototype.initialize.apply(this, arguments);

            this.listenTo(this.model.user, 'change:isBlocked sync', this.render);
            this.subTab = options && options.subTab;
            this.session = Session.get();

            this.listenTo(this, 'change:activeTab', this.updateTabSpecificModules);

            this.listenTo(this.model, 'moderationDetailsReady', this.onDomRefresh);
            this.listenTo(this.model.user, 'blockError', this.onUserBlockError);
            this.listenTo(this.model.user, 'reportError', this.onUserReportError);
        },

        getMetaAttrs: function () {
            var user = this.model.user;
            return backboneUtils.getPromiseFor(user, 'name')
                .then(function (userDisplayName) {
                    return {
                        type: 'profile',
                        title: strings.interpolate(gettext('%(name)s · Profile'), { name: userDisplayName }),
                        description: _.escape(user.get('about')),
                        image: user.has('avatar') && user.get('avatar').cache,
                    };
                });
        },

        updateTabContent: function () {
            if (this.model.isBlocked()) {
                this.contentRegion.show(new Marionette.ItemView({
                    template: blockedProfileTemplate,
                }));
            } else if (this.model.isPrivate() && !this.session.user.isGlobalAdmin()) {
                this.contentRegion.show(new Marionette.ItemView({
                    template: privateProfileTemplate,
                }));

                // Triggers the 'Deal With It' animation for the private profile (can't be triggered through CSS)
                var self = this;
                _.defer(function () {
                    self.$('.empty-message-private').addClass('loaded');
                });
            } else {
                TabbedView.prototype.updateTabContent.apply(this, arguments);
            }
        },

        /*
         * Shows and hides modules that are specific to a particular tab based on what
         * the current active tab is.
         */
        updateTabSpecificModules: function (activeTab) {
            var self = this;
            var regions = {
                comments: self.commentsModuleRegion,
                favorites: self.recommendedModuleRegion,
            };

            // Only show badges sidebar module if the user has badges
            if (this.model.user.get('badges') && this.model.user.get('badges').length) {
                regions.badges = self.badgesModuleRegion;
            }

            // No modules are available if the user is private so return here if so.
            if (self.model.isPrivate() || self.model.isBlocked()) {
                return;
            }

            Object.keys(regions).forEach(function (id) {
                if (id === activeTab) {
                    self.hideRegion(regions[id]);
                } else {
                    regions[id].$el.show();
                    // Re-render module so truncation occurs when browsing through different profile pages and tabs
                    regions[id].currentView.render();
                }
            });
        },

        hideRegion: function (region) {
            if (region.$el) {
                region.$el.hide();
            }
        },

        showProfileModerationModule: function () {
            this.moderationModuleRegion.show(
                new ProfileModerationDetailsModuleView({ model: this.model.moderationDetails })
            );
        },

        onDomRefresh: function () {
            if (this.$(this.coverRegion.el).length) {
                this.coverRegion.show(new ProfileCoverView({ model: this.model.user }));
            }

            if (!this.model.isBlocked()) {
                var isGlobalAdmin = this.session.user.isGlobalAdmin();

                this.userModuleRegion.show(new ProfileUserModuleView({ model: this.model.user }));

                if (!this.model.isPrivate() || isGlobalAdmin) {
                    if (this.model.user.get('badges') && this.model.user.get('badges').length) {
                        this.badgesModuleRegion.show(new ProfileBadgesModuleView({
                            model: this.model.user,
                            collection: this.model.getBadgesCollection(),
                            emptyView: ProfileModuleEmptyView,
                        }));
                    }

                    this.recommendedModuleRegion.show(new ProfileRecommendedModuleView({
                        model: this.model.user,
                        collection: this.model.favorites.items,
                        emptyView: ProfileModuleEmptyView,
                    }));

                    this.commentsModuleRegion.show(new ProfileCommentsModuleView({
                        model: this.model.user,
                        collection: this.model.posts.items,
                        emptyView: ProfileModuleEmptyView,
                    }));

                    this.activeForumsModuleRegion.show(new UserActiveForumsModuleView({
                        model: this.model.mostActiveForums,
                        collection: this.model.mostActiveForums.items,
                        emptyView: ProfileModuleEmptyView,
                    }));
                }

                // Display indicator that let NetMods know their displaying a private profile
                if (this.model.isPrivate() && isGlobalAdmin) {
                    this.alertRegion.show(new Marionette.ItemView({
                        model: this.model.user,
                        template: alertPrivateTemplate,
                    }));
                }

                if (isGlobalAdmin) {
                    this.showProfileModerationModule();
                }
            }

            TabbedView.prototype.onDomRefresh.apply(this, arguments);
        },

        onUserBlockError: function (xhr) {
            var errorCode = xhr && xhr.responseJSON && xhr.responseJSON.code;
            this.alertRegion.show(new Marionette.ItemView({
                model: this.model.user,
                templateHelpers: {
                    isLimitError: errorCode === api.ERROR_CODES.MAX_ITEMS_REACHED,
                },
                template: alertBlockErrorTemplate,
            }));
        },

        onUserReportError: function () {
            this.alertRegion.show(new Marionette.ItemView({
                template: alertBlockErrorTemplate,
            }));
        },

        getTrackingSection: function (activeTab) {
            switch (activeTab) {
            case 'following':
                return 'following';
            case 'followers':
                return 'followers';
            case 'badges':
                return 'badges';
            case 'favorites':
                return 'favorites';
            case 'discussions':
                return 'discussions';
            case 'comments':
            default:
                return 'comments';
            }

            // Main comments feed is default, return nothing
        },

        getTabView: function (activeTab) {
            var view;

            switch (activeTab) {
            case 'following':
                view = new ProfileFollowingView({
                    model: this.model.user,
                    userProfile: this.model,
                    activeTab: this.subTab,
                });
                view.$el.attr({
                    'class': 'card-wrap',
                });

                // Propagate badTab event up to be handled by the router
                this.listenTo(view, 'badTab', _.bind(this.trigger, this, 'badTab'));

                return view;
            case 'followers':
                view = new FetchableCollectionLayout({
                    user: this.model.user,
                    model: this.model.followers,
                    collection: this.model.followers.get('items'),
                    fetchableCollectionView: FollowerCollectionView,
                    emptyView: ProfileFollowersEmptyView,
                    infiniteScroll: true,
                });
                view.$el.attr({
                    'class': 'card-wrap',
                });

                return view;
            case 'badges':
                view = new FetchableCollectionLayout({
                    user: this.model.user,
                    model: this.model.forumBadges,
                    collection: this.model.forumBadges.get('items'),
                    fetchableCollectionView: ForumBadgesCollectionView,
                    emptyView: ProfileBadgesEmptyView,
                    infiniteScroll: true,
                });
                return view;
            case 'favorites':
                return this.getProfileCardCollectionView(
                    this.model.user,
                    this.model.favorites,
                    ProfileFavoritesEmptyView
                );
            case 'discussions':
                return this.getProfileCardCollectionView(
                    this.model.user,
                    this.model.threads,
                    ProfileRecentEmptyView
                );
            case 'recent':
                return this.getProfileCardCollectionView(
                    this.model.user,
                    this.model.profileFeed,
                    ProfileRecentEmptyView
                );
            case 'comments':
            default:
                return this.getProfileCardCollectionView(
                    this.model.user,
                    this.model.posts,
                    ProfileCommentsEmptyView
                );
            }
        },

        getProfileCardCollectionView: function (user, collection, emptyView) {
            return new FetchableCollectionLayout({
                model: collection,
                collection: collection.get('items'),
                user: user,
                fetchableCollectionView: ProfileCardCollectionView,
                emptyView: emptyView,
                infiniteScroll: true,
            });
        },
    });

    withClickLinkTracking.call(ProfileView.prototype);
    withEmailVerificationAlert.call(ProfileView.prototype);
    withLoginOverlay.call(ProfileView.prototype,
        strings.interpolate(
            gettext('Join %(disqus)s to get your own profile like this.'),
            { disqus: 'Disqus' }
        ));

    return ProfileView;
});

define('home/templates/discussionCreate',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Starting a discussion:",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":9,"column":0},"end":{"line":9,"column":36}}}))
    + "\n";
},"3":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Edit your discussion:",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":11,"column":0},"end":{"line":11,"column":35}}}))
    + "\n";
},"5":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<li class=\"spacing-narrow\">\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(alias1,"%(emailMods)s to channel mods if you have concerns.",{"name":"gettext","hash":{"emailMods":lookupProperty(helpers,"tag").call(alias1,"a",{"name":"tag","hash":{"text":lookupProperty(helpers,"gettext").call(alias1,"Send an email",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":29,"column":7},"end":{"line":29,"column":32}}}),"href":(depth0 != null ? lookupProperty(depth0,"emailHref") : depth0),"class":"link-inverted text-semibold"},"data":data,"loc":{"start":{"line":26,"column":12},"end":{"line":30,"column":1}}})},"data":data,"loc":{"start":{"line":25,"column":0},"end":{"line":30,"column":3}}}))
    + "\n</li>\n";
},"7":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(alias1,lookupProperty(helpers,"gt").call(alias1,((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1)) != null ? lookupProperty(stack1,"daysThreadAlive") : stack1),0,{"name":"gt","hash":{},"data":data,"loc":{"start":{"line":37,"column":6},"end":{"line":37,"column":41}}}),{"name":"if","hash":{},"fn":container.program(8, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":37,"column":0},"end":{"line":47,"column":7}}})) != null ? stack1 : "");
},"8":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<li class=\"spacing-narrow\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,lookupProperty(helpers,"eq").call(alias1,((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1)) != null ? lookupProperty(stack1,"daysThreadAlive") : stack1),1,{"name":"eq","hash":{},"data":data,"loc":{"start":{"line":39,"column":6},"end":{"line":39,"column":41}}}),{"name":"if","hash":{},"fn":container.program(9, data, 0),"inverse":container.program(11, data, 0),"data":data,"loc":{"start":{"line":39,"column":0},"end":{"line":45,"column":7}}})) != null ? stack1 : "")
    + "</li>\n";
},"9":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Discussions automatically close after 1 day.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":40,"column":0},"end":{"line":40,"column":58}}}))
    + "\n";
},"11":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Discussions automatically close after %(numDays)s days.",{"name":"gettext","hash":{"numDays":((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1)) != null ? lookupProperty(stack1,"daysThreadAlive") : stack1)},"data":data,"loc":{"start":{"line":42,"column":0},"end":{"line":44,"column":2}}}))
    + "\n";
},"13":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"alert alert--brand align-min-tablet align--between align--middle text-medium spacing-bottom\">\n<div class=\"align__item\">\n<strong>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"First time creating a discussion?",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":56,"column":8},"end":{"line":56,"column":55}}}))
    + "</strong>\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Checkout these %(formatTips)s to make sure it's the best it can be.",{"name":"gettext","hash":{"formatTips":lookupProperty(helpers,"tag").call(alias1,"button",{"name":"tag","hash":{"text":lookupProperty(helpers,"gettext").call(alias1,"formatting tips",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":61,"column":5},"end":{"line":61,"column":32}}}),"data-action":"show-formatting","class":"button-link-inverted text-medium"},"data":data,"loc":{"start":{"line":58,"column":13},"end":{"line":61,"column":33}}})},"data":data,"loc":{"start":{"line":57,"column":0},"end":{"line":62,"column":2}}}))
    + "\n</div>\n<div class=\"align__item button--formatting\">\n<button class=\"button button-wide button-outline text-medium\" data-action=\"show-formatting\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Formatting",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":66,"column":0},"end":{"line":66,"column":24}}}))
    + " <span class=\"icon-formatting text-gray-dark\">A</span>\n</button>\n</div>\n</div>\n";
},"15":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"spacing-bottom\">\n<div class=\"alert -warning text-medium\">\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(alias1,"%(channelName)s requires you to %(verifyEmail)s before starting a discussion.",{"name":"gettext","hash":{"channelName":(depth0 != null ? lookupProperty(depth0,"channelName") : depth0),"verifyEmail":lookupProperty(helpers,"tag").call(alias1,"a",{"name":"tag","hash":{"text":lookupProperty(helpers,"gettext").call(alias1,"verify your email address",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":78,"column":5},"end":{"line":78,"column":42}}}),"data-forum":((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1)) != null ? lookupProperty(stack1,"id") : stack1),"data-action":"verify-email","href":"#"},"data":data,"loc":{"start":{"line":75,"column":14},"end":{"line":78,"column":43}}})},"data":data,"loc":{"start":{"line":74,"column":0},"end":{"line":80,"column":2}}}))
    + "\n</div>\n</div>\n";
},"17":function(container,depth0,helpers,partials,data) {
    return " disabled";
},"19":function(container,depth0,helpers,partials,data) {
    return " class=\"disabled\"";
},"21":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"media spacing-bottom\">\n<div class=\"media-left\">\n<input id=\"dicussion-form-invite-checkbox\" type=\"checkbox\" name=\"invite-active-users\">\n</div>\n<label for=\"dicussion-form-invite-checkbox\" class=\"text-small text-gray-dark media-body media-heading\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Invite most active users",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":127,"column":0},"end":{"line":127,"column":38}}}))
    + "\n<p class=\"text-gray\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"This will invite the most active users on %(channelName)s when you submit this discussion. Do this ONLY when the thread is final and ready for publishing.",{"name":"gettext","hash":{"channelName":(depth0 != null ? lookupProperty(depth0,"channelName") : depth0)},"data":data,"loc":{"start":{"line":129,"column":0},"end":{"line":129,"column":194}}}))
    + "\n</p>\n</label>\n</div>\n";
},"23":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Create Discussion",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":145,"column":0},"end":{"line":145,"column":31}}}))
    + "\n";
},"25":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Update Discussion",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":147,"column":0},"end":{"line":147,"column":31}}}))
    + "\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div data-role=\"banner\"></div>\n<div class=\"section-contained form--discussion\">\n<div class=\"layout\">\n<div class=\"layout__main-with-aside\">\n<div class=\"layout__nav\">\n<div class=\"aside__wrap -brand\">\n<h2 class=\"text-large spacing-bottom-narrow\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"isNew") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"data":data,"loc":{"start":{"line":8,"column":0},"end":{"line":12,"column":7}}})) != null ? stack1 : "")
    + "</h2>\n<ul class=\"list-bullet spacing-narrow text-medium\">\n<li class=\"spacing-narrow\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Stay on topic for %(channelLink)s.",{"name":"gettext","hash":{"channelLink":lookupProperty(helpers,"tag").call(alias1,"a",{"name":"tag","hash":{"text":(depth0 != null ? lookupProperty(depth0,"channelName") : depth0),"href":(depth0 != null ? lookupProperty(depth0,"channelUrl") : depth0),"class":"link-inverted text-semibold"},"data":data,"loc":{"start":{"line":17,"column":14},"end":{"line":21,"column":1}}})},"data":data,"loc":{"start":{"line":16,"column":0},"end":{"line":21,"column":3}}}))
    + "\n</li>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"emailHref") : depth0),{"name":"if","hash":{},"fn":container.program(5, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":23,"column":0},"end":{"line":32,"column":7}}})) != null ? stack1 : "")
    + "<li class=\"spacing-narrow\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Follow the %(channel)s Rules.",{"name":"gettext","hash":{"channel":"Channel"},"data":data,"loc":{"start":{"line":34,"column":0},"end":{"line":34,"column":63}}}))
    + "\n</li>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"isNew") : depth0),{"name":"if","hash":{},"fn":container.program(7, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":36,"column":0},"end":{"line":48,"column":7}}})) != null ? stack1 : "")
    + "</ul>\n</div>\n</div>\n<section class=\"layout__content\">\n"
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"sessionUserNumPosts") : depth0),{"name":"unless","hash":{},"fn":container.program(13, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":53,"column":0},"end":{"line":70,"column":11}}})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"sessionUserVerified") : depth0),{"name":"unless","hash":{},"fn":container.program(15, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":71,"column":0},"end":{"line":83,"column":11}}})) != null ? stack1 : "")
    + "<form>\n<div class=\"card-wrap\">\n<div class=\"card__body\">\n<div class=\"form-attribute-input\" data-role=\"channel-categories\" data-attribute=\"category\"></div>\n\n<div class=\"spacing-bottom form-attribute-input\" data-attribute=\"title\">\n<h3 class=\"spacing-default text-gray-darker\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Title",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":91,"column":0},"end":{"line":91,"column":19}}}))
    + "\n<span class=\"text-gray text-small\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"(Required)",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":92,"column":35},"end":{"line":92,"column":59}}}))
    + "</span>\n</h3>\n<input class=\"input--textbox -text-large text-semibold\" name=\"title\" type=\"text\"\nplaceholder=\""
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Headline for your discussion",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":95,"column":13},"end":{"line":95,"column":55}}}))
    + "\" value=\""
    + alias2(container.lambda((depth0 != null ? lookupProperty(depth0,"title") : depth0), depth0))
    + "\""
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"sessionUserVerified") : depth0),{"name":"unless","hash":{},"fn":container.program(17, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":95,"column":74},"end":{"line":95,"column":125}}})) != null ? stack1 : "")
    + " />\n<div data-role=\"attribute-error\" class=\"form-message-error spacing-default text-small\"></div>\n</div>\n\n<div class=\"spacing-bottom form-attribute-input\" data-attribute=\"topics displayName\" data-role=\"topic-input\"></div>\n\n<div class=\"spacing-bottom form-attribute-input\" data-attribute=\"message\">\n<h3 class=\"spacing-default text-gray-darker\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Describe your discussion",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":104,"column":45},"end":{"line":104,"column":83}}}))
    + "</h3>\n<div data-role=\"postbox\""
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"sessionUserVerified") : depth0),{"name":"unless","hash":{},"fn":container.program(19, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":105,"column":24},"end":{"line":105,"column":83}}})) != null ? stack1 : "")
    + "></div>\n<div data-role=\"attribute-error\" class=\"form-message-error spacing-default text-small\"></div>\n<div class=\"align align--between spacing-top-narrow\" data-role=\"toolbar\"></div>\n</div>\n</div>\n</div>\n<div class=\"align-min-tablet align--between spacing-bottom\">\n<div class=\"align__item discussion-form__input-block\">\n<div class=\"media spacing-bottom\">\n<div class=\"media-left\">\n<label class=\"text-small text-gray-dark media-body media-heading\">\n<input type=\"checkbox\" name=\"subscribe\" checked>\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Subscribe for email updates to this discussion",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":117,"column":0},"end":{"line":117,"column":60}}}))
    + "\n</label>\n</div>\n</div>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"canInviteActiveUsers") : depth0),{"name":"if","hash":{},"fn":container.program(21, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":121,"column":0},"end":{"line":133,"column":7}}})) != null ? stack1 : "")
    + "</div>\n<div class=\"align__item clearfix\">\n<div class=\"align-max-mobile\">\n<div class=\"align__item--swap-first discussion-form__loading\">\n<div class=\"spinner-small\"></div>\n</div>\n<button type=\"button\" id=\"cancel-button\" data-action=\"cancel-create\" class=\"button text-medium align__item--swap-first\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Cancel",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":141,"column":0},"end":{"line":141,"column":20}}}))
    + "\n</button>\n<button type=\"submit\" id=\"submit-button\" class=\"button button-fill--brand button--discussion-form text-medium align__item--swap-last\""
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"sessionUserVerified") : depth0),{"name":"unless","hash":{},"fn":container.program(17, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":143,"column":133},"end":{"line":143,"column":184}}})) != null ? stack1 : "")
    + ">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"isNew") : depth0),{"name":"if","hash":{},"fn":container.program(23, data, 0),"inverse":container.program(25, data, 0),"data":data,"loc":{"start":{"line":144,"column":0},"end":{"line":148,"column":7}}})) != null ? stack1 : "")
    + "</button>\n</div>\n</div>\n</div>\n</form>\n</section>\n</div>\n<aside class=\"layout__aside\">\n<div class=\"card-wrap\">\n<div class=\"card__header -default\">\n<h3 class=\"text-gray-darker\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Basic Rules",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":160,"column":0},"end":{"line":160,"column":25}}}))
    + "\n</h3>\n</div>\n<div class=\"text-medium text-gray-darker card__body spacing-inner rules__wrapper -discussion\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"homeRules"),depth0,{"name":"homeRules","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n</div>\n<div class=\"text-smaller text-gray hidden-md\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"homeFooter"),depth0,{"name":"homeFooter","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n</aside>\n</div>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/templates/editDiscussionCategory',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data,blockParams,depths) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, alias3=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<label class=\"align spacing-narrow\">\n<div class=\"align__item spacing-right\">\n<input type=\"radio\" name=\"category\" value=\""
    + alias2(alias1((data && lookupProperty(data,"key")), depth0))
    + "\" alt=\""
    + alias2(alias1(depth0, depth0))
    + "\" "
    + ((stack1 = lookupProperty(helpers,"if").call(alias3,lookupProperty(helpers,"eq").call(alias3,(data && lookupProperty(data,"key")),(depths[1] != null ? lookupProperty(depths[1],"category") : depths[1]),{"name":"eq","hash":{},"data":data,"loc":{"start":{"line":12,"column":74},"end":{"line":12,"column":95}}}),{"name":"if","hash":{},"fn":container.program(2, data, 0, blockParams, depths),"inverse":container.noop,"data":data,"loc":{"start":{"line":12,"column":68},"end":{"line":12,"column":111}}})) != null ? stack1 : "")
    + " />\n</div>\n<div class=\"spacing-bottom-small align__item text-medium text-gray-darker\">\n"
    + alias2(alias1((data && lookupProperty(data,"key")), depth0))
    + "\n<p class=\"text-gray\">\n"
    + alias2(alias1(depth0, depth0))
    + "\n</p>\n</div>\n</label>\n";
},"2":function(container,depth0,helpers,partials,data) {
    return "checked";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data,blockParams,depths) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<h3 class=\"text-gray-darker\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Choose Category",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":2,"column":0},"end":{"line":2,"column":29}}}))
    + "\n<span data-toggle=\"tooltip\" data-placement=\"bottom\"\ntitle=\""
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"%(channelTitle)s requires that you choose a category to guide your discussion. This helps maintain a common theme throughout discussions on this channel.",{"name":"gettext","hash":{"channelTitle":(depth0 != null ? lookupProperty(depth0,"name") : depth0)},"data":data,"loc":{"start":{"line":4,"column":7},"end":{"line":4,"column":192}}}))
    + "\">\n<span class=\"icon-questions icon__position icon-tiny text-gray\"></span>\n</span>\n</h3>\n<div data-role=\"attribute-error\" class=\"form-message-error text-small spacing-default\"></div>\n"
    + ((stack1 = lookupProperty(helpers,"each").call(alias1,(depth0 != null ? lookupProperty(depth0,"categories") : depth0),{"name":"each","hash":{},"fn":container.program(1, data, 0, blockParams, depths),"inverse":container.noop,"data":data,"loc":{"start":{"line":9,"column":0},"end":{"line":21,"column":9}}})) != null ? stack1 : "");
},"useData":true,"useDepths":true})

});
define('home/views/EditDiscussionCategoryView',[
    'jquery',
    'backbone-marionette',

    'home/templates/editDiscussionCategory',
], function (
    $,
    Marionette,

    editDiscussionCategoryTemplate
) {
    'use strict';

    var EditDiscussionCategoryView = Marionette.ItemView.extend({
        template: editDiscussionCategoryTemplate,
        className: 'discussion-form__categories',

        templateHelpers: function () {
            return {
                categories: this.model.thread.forum.channel.getCategories(),
                existingCategory: this.existingCategory,
            };
        },

        initialize: function () {
            this.existingCategory = this.model.topics.getCategoryTopics()[0];
        },

        events: {
            'change input[name=category]': 'categoryChanged',
        },

        onDomRefresh: function () {
            this.$('[data-toggle=tooltip]').tooltip();
        },

        categoryChanged: function (evt) {
            this.model.set({ category: $(evt.currentTarget).val() });
        },
    });

    return EditDiscussionCategoryView;
});

define('home/templates/topicInput',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<h3 class=\"spacing-default text-gray-darker\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Topics",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":2,"column":0},"end":{"line":2,"column":20}}}))
    + "\n</h3>\n\n<div data-attribute=\"topics\" class=\"input-group\">\n<div data-role=\"topics\"></div>\n<input class=\"input-group__text\" name=\"topics\" type=\"text\"\nplaceholder=\""
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Add topics here, separate with commas.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":8,"column":13},"end":{"line":8,"column":65}}}))
    + "\" />\n</div>\n\n<div data-role=\"attribute-error\" class=\"form-message-error text-small spacing-default\"></div>\n";
},"useData":true})

});
define('home/views/TopicInputView',[
    'underscore',
    'backbone-marionette',

    'home/models/Topic',

    'home/templates/topicInput',

    'home/views/TopicTagView',
], function (
    _,
    Marionette,

    Topic,

    topicInputTemplate,

    TopicTagView
) {
    'use strict';

    var TopicInputView = Marionette.CompositeView.extend({
        className: 'topic-group__wrapper',
        template: topicInputTemplate,
        itemView: TopicTagView,
        itemViewContainer: '[data-role=topics]',

        initialize: function () {
            this.listenTo(this, 'itemview:removeTag', this.handleRemoveTopicByTag);
        },

        events: {
            'keydown [name=topics]': 'handleTopicInputKeydown',
            'blur input[name=topics]': 'handleTopicInputBlur',
        },

        ui: {
            topics: '[name=topics]',
        },

        handleTopicInputKeydown: function (evt) {
            if (_.contains(TopicInputView.TOPIC_INSERTION_KEYS, evt.keyCode) && !evt.shiftKey) {
                // User pressed a key used to insert a topic. Prevent the user from
                // entering that character and then parse the typed topic.
                evt.preventDefault();
                this.parseTopicInput();
            } else if (evt.keyCode === 8) {
                // This allows the user to remove the last non-hidden topic by typing backspace
                // if there's no text in the input field.
                var inputLength = this.ui.topics.val().length;
                if (!inputLength) {
                    var lastTopic = _.last(this.collection.filter(function (topic) {
                        return !topic.get('hidden');
                    }));
                    if (lastTopic)
                        this.collection.remove(lastTopic);
                }
            }
        },

        handleTopicInputBlur: function () {
            this.parseTopicInput();
        },

        parseTopicInput: function () {
            var inputValue = this.ui.topics.val();
            if (inputValue) {
                // Split the input by comma to cover the case where a user pastes in
                // a comma-separated list of topic names. However, in most cases this
                // will only be a single value because we prevent the user from typing
                // commas individually and execute this function without it.
                var topicNames = inputValue.split(',');
                _.each(topicNames, function (topicName) {
                    var topic = Topic.getOrCreateTopic(topicName);
                    if (topic)
                        this.collection.add(topic);
                }, this);
                this.clearTopicInput();
            }
        },

        clearTopicInput: function () {
            this.ui.topics.val('');
        },

        handleRemoveTopicByTag: function (topicItemView) {
            this.collection.remove(topicItemView.model);
        },

    }, {

        TOPIC_INSERTION_KEYS: [
            9, // tab
            188, // comma
            13, // enter
            186, // semicolon
        ],

    });

    return TopicInputView;
});

define('home/mixins/withChannelBanner',[
    'underscore',

    'home/models/Channel',
], function (
    _,

    Channel
) {
    'use strict';

    var BANNER_COLOR_CLASSES = _.chain(Channel.BANNER_COLORS)
        .keys()
        .map(function (color) {
            return '-' + color;
        })
        .value()
        .join(' ');


    /**
     * Used on a view that contains a channel banner. Will properly render/update
     * the banner to show the appropriate color or image as indicated/updated in
     * the backing channel model.
     *
     * Expects this.model to be a Channel.
     * Banner element should have data-role=banner.
     */
    var withChannelBanner = {
        ui: {
            // this data-role must also include .banner__wrapper for
            // banner colors to display visually
            bannerWrapper: '[data-role=banner]',
        },

        initialize: function (_initialize, options) {
            _initialize.call(this, options);

            this.listenTo(this.model, 'change:bannerColor change:banner change:options', this.updateBanner);
        },

        onRender: function (_onRender) {
            if (_onRender)
                _onRender.apply(this, _.rest(arguments));

            this.updateBanner();
        },

        updateBanner: function () {
            this.ui.bannerWrapper
                .removeClass(BANNER_COLOR_CLASSES)
                .removeClass('-image-background')
                .css({
                    'background-image': '',
                });

            var backgroundColor = this.model.get('bannerColor');
            var backgroundImage = this.model.get('banner') || this.model.get('options').alertBackground;

            // Until we're able to preview an image file before saving, show a placeholder which
            // indicates a custom image banner background.
            if (backgroundImage instanceof window.File)
                backgroundImage = '//media.disquscdn.com/home/channels/banner-image-upload.png';

            if (backgroundImage) {
                this.ui.bannerWrapper
                    .addClass('-image-background')
                    .css({
                        'background-image': 'url(' + backgroundImage + ')',
                        'background-position': '0 0;',
                    });
            }

            if (backgroundColor)
                this.ui.bannerWrapper.addClass('-' + backgroundColor.toLowerCase());
        },
    };

    return function () {
        this.ui = _.extend({}, withChannelBanner.ui, this.ui);
        this.initialize = _.wrap(this.initialize, withChannelBanner.initialize);
        this.onRender = _.wrap(this.onRender, withChannelBanner.onRender);

        _.defaults(this, _.pick(withChannelBanner, [
            'updateBanner',
        ]));
    };
});

define('home/templates/channelBanner',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"banner__wrapper\" data-role=\"banner\">\n<a href=\"/home/channel/"
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"slug") : depth0), depth0))
    + "/\" class=\"link-inverted\">\n<div class=\"channel-cover section-contained align align--middle\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"channelCoverLogo"),depth0,{"name":"channelCoverLogo","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n</a>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/ChannelBannerView',[
    'backbone-marionette',

    'home/mixins/withChannelBanner',
    'home/mixins/withClickLinkTracking',

    'home/templates/channelBanner',
], function (
    Marionette,

    withChannelBanner,
    withClickLinkTracking,

    channelBannerTemplate
) {
    'use strict';

    var ChannelBannerView = Marionette.ItemView.extend({
        template: channelBannerTemplate,

        events: {
            'click a': 'trackClickLink',
        },
    });

    var proto = ChannelBannerView.prototype;

    withClickLinkTracking.call(proto, 'channel_top_banner');
    withChannelBanner.call(proto);

    return ChannelBannerView;
});

define('home/models/formatting/LinkPopover',[
    'backbone',
], function (
    Backbone
) {
    'use strict';

    var isEmpty = function (val) {
        return !(val && val.trim());
    };

    var LinkPopover = Backbone.Model.extend({
        defaults: {
            originalText: '',
            text: '',
            url: '',
        },

        validate: function (attrs) {
            if (isEmpty(attrs.text)) {
                return {
                    attrName: 'text',
                    message: 'Link text is required.',
                };
            }

            if (isEmpty(attrs.url)) {
                return {
                    attrName: 'url',
                    message: 'Link URL is required.',
                };
            }
        },
    });

    return LinkPopover;
});

define('home/templates/linkInsertTooltip',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<form data-role=\"link-form\">\n<div class=\"spacing-bottom-narrow form-attribute-input\" data-attribute=\"text\">\n<input name=\"text\" class=\"input--textbox\" placeholder=\"Link text\" value=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"text") : depth0), depth0))
    + "\">\n<div data-role=\"attribute-error\" class=\"form-message-error spacing-default text-small\"></div>\n</div>\n<div class=\"spacing-bottom-narrow form-attribute-input\" data-attribute=\"url\">\n<input name=\"url\" class=\"input--textbox\" placeholder=\"Link URL\" value=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"url") : depth0), depth0))
    + "\">\n<div data-role=\"attribute-error\" class=\"form-message-error spacing-default text-small\"></div>\n</div>\n<div class=\"text-center\">\n<button type=\"submit\" data-action=\"insert-link\" class=\"button button-outline button-wide button-small\">\nAdd Link\n</button>\n</div>\n</form>\n";
},"useData":true})

});
define('home/views/BasePopoverView',[
    'jquery',
    'backbone',
], function (
    $,
    Backbone
) {
    'use strict';

    /**
     * Abstract base class for popover views.
     *
     * Implements several helpers for displaying and hiding the popover.
     *
     * Subclasses must bind a click event to onBodyClick for the view to hide correctly.
     */
    var BasePopoverView = Backbone.View.extend({
        className: 'popover notch-up notch--mobile-hidden',

        initialize: function (options) {
            this.$target = options.$target;
        },

        move: function () {
            // Append to viewport so that the tooltip doesn't
            // appear over the fixed nav header
            this.$el.detach().appendTo('.viewport');

            this.render();

            this.delegateEvents();

            this.updatePosition(this.$target, '.viewport');
        },

        /*
         * Positions the popover below the target element.
         *
         * Will try to position popover horizontally so it doesn't get cut off
         * on either side.
         */
        updatePosition: function ($target, containerSelector) {
            var targetTop = $target.offset().top;
            var targetLeft = $target.offset().left;
            var targetHeight = $target.height();
            var targetWidth = $target.width();

            var popoverWidth = this.$el.width();

            var $win = $(window);
            var winWidth = $win.width();
            var viewportTop = $(containerSelector).offset().top;

            var alignment = this.constructor.calculateHorizontalAlignment(
                targetLeft, targetWidth, popoverWidth, winWidth);

            // toggle classes so the notch moves accordingly
            this.$el.toggleClass('-right', alignment.position === 'right');
            this.$el.toggleClass('-left', alignment.position === 'left');

            this.$el.css({
                top: targetTop + targetHeight + this.constructor.TOP_MARGIN - viewportTop,
                left: alignment.left,
                bottom: 'inherit',
                'z-index': this.constructor.Z_INDEX,
            });
        },

        show: function () {
            this.move();

            this.$el.addClass('open');
        },

        hide: function () {
            this.$el.removeClass('open');
        },

        /**
         * Event handler for any click events.
         * Will hide the view if the click is not on the target or the card.
         */
        onBodyClick: function (evt) {
            var $evtTarget = $(evt.target);

            // if the target element was clicked on, don't do anything
            if ($evtTarget.closest(this.$target).length)
                return;

            // if the card itself was clicked on, don't do anything
            if ($evtTarget.closest(this.$el).length)
                return;

            this.hide();
        },
    }, {
        // Space above card so notch does not overlap target
        TOP_MARGIN: 20,  /* px */

        Z_INDEX: 550,

        /**
         * Calculates how the popover should be horizontally aligned to the target.
         *
         * Prefers centering when possible, but will fall back on left or right alignment
         * if part of the popover card would be outside the window.
         */
        calculateHorizontalAlignment: function (targetLeft, targetWidth, popoverWidth, winWidth) {
            var centeredLeft = targetLeft - (popoverWidth - targetWidth) / 2;
            var rightAlignedLeft = targetLeft + targetWidth - popoverWidth;
            var leftAlignedLeft = targetLeft;

            // right align when center-aligning cuts off to the right and right-aligning doesn't cut off to the left
            var shouldRightAlign = centeredLeft + popoverWidth > winWidth && rightAlignedLeft > 0;

            // left align when center-aligning cuts off to the left and left-aligning doesn't cut off to the right
            var shouldLeftAlign = centeredLeft < 0 && leftAlignedLeft + popoverWidth < winWidth;

            // center-align when center-aligning doesn't cut off to the right or left
            var shouldCenterAlign = centeredLeft + popoverWidth < winWidth && centeredLeft > 0;

            var left, position;
            if (shouldCenterAlign) {
                position = 'centered';
                left = centeredLeft;
            } else if (shouldRightAlign) {
                position = 'right';
                left = rightAlignedLeft;
            } else if (shouldLeftAlign) {
                position = 'left';
                left = leftAlignedLeft;
            } else {
                // if all else fails, just position at left edge of page
                position = 'leftEdge';
                left = 0;
            }

            return {
                position: position,
                left: left,
            };
        },
    });

    return BasePopoverView;
});

define('home/views/formatting/LinkPopoverView',[
    'jquery',
    'underscore',

    'core/utils',

    'home/templates/linkInsertTooltip',
    'home/views/BasePopoverView',
], function (
    $,
    _,

    utils,

    linkInsertTooltipTemplate,
    BasePopoverView
) {
    'use strict';

    var handler = utils.preventDefaultHandler;

    var parent = BasePopoverView;
    var parentProto = parent.prototype;

    var InsertLinkPopoverView = parent.extend({
        events: {
            'blur input': 'saveModel',
            'submit [data-role=link-form]': 'insertLink',
        },

        template: linkInsertTooltipTemplate,

        initialize: function () {
            parentProto.initialize.apply(this, arguments);

            // Listen for changes to the form model
            // This must be done per-field to avoid clearing any
            // validation errors which were added to the form
            this.listenTo(this.model, {
                'change:text': function (_model, text) {
                    this.$('[name=text]').val(text);
                },
                'change:url': function (_model, url) {
                    this.$('[name=url]').val(url);
                },
            });

            this._open = false;

            this.onBodyClick = _.bind(this.onBodyClick, this);
        },

        render: function () {
            this.$el.html(this.template(this.model.toJSON()));

            return this;
        },

        remove: function () {
            this.removeBodyEvent();

            parentProto.remove.apply(this, arguments);
        },

        attachBodyEvent: function () {
            $('body').on('click', this.onBodyClick);
        },

        removeBodyEvent: function () {
            $('body').off('click', this.onBodyClick);
        },

        show: function () {
            // Set up a delay to focus the first form field after rendering
            // FIXME: It's not clear why this must be delayed. If the focus
            // call is immediately after rendering (via .show), or even
            // after rendering by a small delay (ex. 10ms), it will not
            // focus the input element. The delay chosen here (50ms) is
            // arbitrary but appears to consistently work.
            _.delay(_.bind(function () {
                this.$('input').eq(0).focus();
            }, this), 50);

            // Avoid re-rendering if already open to prevent loss of user input
            if (this._open)
                return;

            this._open = true;

            this.attachBodyEvent();

            parentProto.show.apply(this, arguments);
        },

        hide: function () {
            parentProto.hide.apply(this, arguments);

            // FIXME: This is to avoid the hide event forcing the selection when the popover
            // is already closed, but this is really a concern of the containing view; the
            // event needs to be re-examined
            if (!this._open)
                return;

            this._open = false;

            this.removeBodyEvent();

            this.saveModel();

            this.trigger('hide');
        },

        saveModel: function () {
            this.model.set({
                url: this.$('[name=url]').val().trim(),
                // Do not trim text, as surrounding whitespace may be significant
                // (depending on initial user selection)
                text: this.$('[name=text]').val(),
            });
        },

        insertLink: handler(function () {
            // Update model from form values again; if user uses
            // keyboard enter to submit form, there will not be
            // a blur event to trigger a model save
            this.saveModel();

            if (this.model.isValid())
                this.trigger('submit', this.model.toJSON());
            else
                this.displayError(this.model.validationError);
        }),

        displayError: function (error) {
            // Remove any existing error first
            this.$('.form-attribute-input').removeClass('is-error');

            this.$('[data-attribute=' + error.attrName + ']')
                .addClass('is-error')
                .find('[data-role=attribute-error]')
                .text(error.message);
        },
    });

    return InsertLinkPopoverView;
});

define('home/templates/formattingButtons',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    return "<button type=\"button\" data-action=\"toggle-formatting\" data-formatting=\"bold\" class=\"button link-gray text-smaller\">\n<strong title=\"Bold\">B</strong>\n</button>\n<button type=\"button\" data-action=\"toggle-formatting\" data-formatting=\"italics\" class=\"button link-gray text-smaller\">\n<em title=\"Italic\">I</em>\n</button>\n<button type=\"button\" data-action=\"toggle-formatting\" data-formatting=\"underline\" class=\"button link-gray text-smaller\">\n<u title=\"Underline\">U</u>\n</button>\n<button type=\"button\" data-action=\"toggle-formatting\" data-formatting=\"blockquote\" class=\"button link-gray text-smaller\">\n❛❛\n</button>\n<button type=\"button\" data-action=\"insert-link\" class=\"button link-gray text-smaller\">\n<span class=\"icon icon-link icon__position -inline icon-small\" title=\"Link\"></span>\n</button>\n";
},"useData":true})

});
define('home/views/formatting/FormattingButtonsView',[
    'underscore',
    'backbone',

    'home/models/formatting/LinkPopover',
    'home/views/formatting/LinkPopoverView',

    'home/templates/formattingButtons',
], function (
    _,
    Backbone,

    LinkPopoverModel,
    LinkPopoverView,

    formattingButtonsTemplate
) {
    'use strict';

    var parent = Backbone.View;
    var parentProto = parent.prototype;

    var FormattingButtonsView = parent.extend({
        template: formattingButtonsTemplate,

        events: {
            'click [data-action=toggle-formatting]': 'onFormattingClick',
            'click [data-action=insert-link]': 'onInsertLinkClick',
        },

        initialize: function (options) {
            this.getPostbox = options.getPostbox;

            this.linkModel = new LinkPopoverModel();
        },

        render: function () {
            this.$el.html(this.template());

            if (this._popoverView)
                return this;

            this._popoverView = new LinkPopoverView({
                $target: this.$('[data-action=insert-link]'),
                model: this.linkModel,
            });

            this.listenTo(this._popoverView, {
                hide: function () {
                    // Attempt to restore the textarea selection.
                    // This is necessary as the selection is lost when the
                    // popover is opened (because the popover has its own
                    // input fields).
                    // If the popover is closed, and the user did not close
                    // it by focusing on another input, the textarea selection
                    // should be restored.
                    var activeElement = window.document.activeElement;
                    if (!activeElement || activeElement.tagName !== 'INPUT')
                        this.getPostbox().textarea.restoreSelection();
                },
                submit: function (data) {
                    this.insertFormattingTags('link', {
                        url: data.url,
                        text: data.text,
                    });

                    this._popoverView.hide();

                    // Reset the link model
                    this.linkModel.clear();
                },
            });

            return this;
        },

        remove: function () {
            if (this._popoverView)
                this._popoverView.remove();

            parentProto.remove.apply(this, arguments);
        },

        insertFormattingTags: function (operation, options) {
            var textarea = this.getPostbox().textarea;

            if (operation === 'link') {
                var wrappedText = '<a href="' + _.escape(options.url) + '">' +
                    this.constructor.escapeCommentHtml(options.text) +
                    '</a>';
                textarea.insertAtCursor(wrappedText);
            } else {
                var tagName = FormattingButtonsView.FORMATTING_TAGS[operation];

                if (!tagName)
                    throw new Error('Invalid formatting operation: ' + operation);

                textarea.insertAroundSelection('<' + tagName + '>', '</' + tagName + '>');
            }
        },

        onFormattingClick: function (evt) {
            var kind = evt.currentTarget.getAttribute('data-formatting');
            this.insertFormattingTags(kind);
        },

        onInsertLinkClick: function () {
            var textarea = this.getPostbox().textarea;
            var text = textarea.getSelected();

            var attrs = {
                originalText: text,
            };

            // Override the text if it does not look like the user has customized it
            var linkText = this.linkModel.get('text');
            if (!linkText || linkText === this.linkModel.get('originalText'))
                attrs.text = text;

            this.linkModel.set(attrs);

            this._popoverView.show();
        },
    }, {
        FORMATTING_TAGS: {
            bold: 'strong',
            blockquote: 'blockquote',
            italics: 'em',
            underline: 'u',
        },

        // Selectively escapes text. It attempts to avoid escaping if
        // the server will be able to escape the text without issue.
        //
        // > escapeCommentHtml('1 < 2, 3<4')
        // '1 < 2, 3&lt;4'
        // > escapeCommentHtml('a&b, c & d')
        // 'a&amp;b, c & d'
        //
        // WARNING: This function is solely intended for use with text which will
        // be submitted to the server as part of a comment or discussion body.
        escapeCommentHtml: function (text) {
            return text
                    .replace(/&(?=\S)/g, '&amp;')
                    .replace(/<(?=\S)/g, '&lt;');
        },
    });

    return FormattingButtonsView;
});

define('home/templates/discussionCreateToolbar',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"input--formatting-region\">\n<span data-role=\"formatting-buttons\"></span>\n<span data-role=\"upload-button\"></span>\n</div>\n\n<div class=\"align__item hidden-md\">\n<button data-action=\"show-formatting\" type=\"button\" class=\"button text-smaller link-gray\">\n<span class=\"icon-formatting\">A</span>\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Formatting Help",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":9,"column":0},"end":{"line":9,"column":29}}}))
    + "\n</button>\n</div>\n";
},"useData":true})

});
define('home/templates/formatting',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"modal-formatting\">\n<div class=\"modal-body text-medium\">\n<h1 class=\"text-larger spacing-bottom-narrow\">\n<span class=\"icon-formatting\">A</span> "
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Formatting Tips",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":4,"column":39},"end":{"line":4,"column":68}}}))
    + "\n</h1>\n<div class=\"align-min-tablet modal-formatting__block\">\n<label class=\"modal-formatting__label\"><a>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Linking text",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":7,"column":42},"end":{"line":7,"column":68}}}))
    + "</a></label>\n<textarea class=\"modal-formatting__textarea\">&lt;a href=\"https://www.website.com/\"&gt;"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"This is a link",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":8,"column":86},"end":{"line":8,"column":114}}}))
    + "&lt;/a&gt;</textarea>\n</div>\n<div class=\"align-min-tablet modal-formatting__block\">\n<label class=\"modal-formatting__label\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Line Break",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":11,"column":39},"end":{"line":11,"column":63}}}))
    + "</label>\n<textarea class=\"modal-formatting__textarea\">&lt;br&gt;</textarea>\n</div>\n<div class=\"align-min-tablet modal-formatting__block\">\n<label class=\"modal-formatting__label\"><strong>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Bold",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":15,"column":47},"end":{"line":15,"column":65}}}))
    + "</strong></label>\n<textarea class=\"modal-formatting__textarea\">&lt;strong&gt;"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Defines bold text",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":16,"column":59},"end":{"line":16,"column":90}}}))
    + "&lt;/strong&gt;</textarea>\n</div>\n<div class=\"align-min-tablet modal-formatting__block\">\n<label class=\"modal-formatting__label\"><blockquote>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Block Quote",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":19,"column":51},"end":{"line":19,"column":76}}}))
    + "</blockquote></label>\n<textarea class=\"modal-formatting__textarea\">&lt;blockquote&gt;"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Defines a long quotation",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":20,"column":63},"end":{"line":20,"column":101}}}))
    + "&lt;/blockquote&gt;</textarea>\n</div>\n<div class=\"align-min-tablet modal-formatting__block\">\n<label class=\"modal-formatting__label\"><em>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Italic",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":23,"column":43},"end":{"line":23,"column":63}}}))
    + "</em></label>\n<textarea class=\"modal-formatting__textarea\">&lt;em&gt;"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Defines italic text",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":24,"column":55},"end":{"line":24,"column":88}}}))
    + "&lt;/em&gt;</textarea>\n</div>\n<div class=\"align-min-tablet modal-formatting__block\">\n<label class=\"modal-formatting__label\"><strike>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Strikethrough",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":27,"column":47},"end":{"line":27,"column":74}}}))
    + "</strike></label>\n<textarea class=\"modal-formatting__textarea\">&lt;strike&gt;"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Defines strikethrough text",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":28,"column":59},"end":{"line":28,"column":99}}}))
    + "&lt;/strike&gt;</textarea>\n</div>\n<div class=\"align-min-tablet modal-formatting__block\">\n<label class=\"modal-formatting__label\"><u>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Underlined",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":31,"column":42},"end":{"line":31,"column":66}}}))
    + "</u></label>\n<textarea class=\"modal-formatting__textarea\">&lt;u&gt;"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Defines underlined text",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":32,"column":54},"end":{"line":32,"column":91}}}))
    + "&lt;/u&gt;</textarea>\n</div>\n</div>\n</div>\n";
},"useData":true})

});
define('home/templates/uploadButton',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    return "<button type=\"button\" class=\"button text-smaller link-gray\" data-action=\"attach\" title=\"Upload Images\">\n<span class=\"icon-photo icon__position -inline\"></span>\n</button>\n<input type=\"file\" class=\"hidden\" data-role=\"media-upload\" tabindex=\"-1\" accept=\"image/*\">\n";
},"useData":true})

});
define('home/views/DiscussionCreateToolbarView',[
    'backbone-marionette',

    'core/views/media/UploadButtonView',

    'home/mixins/withSubviews',
    'home/utils/confirmModal',
    'home/views/formatting/FormattingButtonsView',

    'home/templates/discussionCreateToolbar',
    'home/templates/formatting',
    'home/templates/uploadButton',
], function (
    Marionette,

    UploadButtonView,

    withSubviews,
    confirmModal,
    FormattingButtonsView,

    discussionCreateToolbarTemplate,
    formattingTemplate,
    uploadButtonTemplate
) {
    'use strict';

    var parent = Marionette.ItemView;
    var parentProto = parent.prototype;

    // This class provides UI elements for actions which may be
    // applied to the postbox in the discussion create form,
    // including uploads and formatting.
    var DiscussionCreateToolbarView = parent.extend({
        template: discussionCreateToolbarTemplate,

        events: {
            'click [data-action=show-formatting]': 'showFormatting',
        },

        regions: {
            formattingButtonsRegion: '[data-role=formatting-buttons]',
            uploadButtonRegion: '[data-role=upload-button]',
        },

        initialize: function (options) {
            // Accepts an accessor function to retrieve the postbox view.
            // This is done via a function to avoid being tied to a
            // particular rendering approach in the parent views.
            this.getPostbox = options.getPostbox;
        },

        render: function () {
            parentProto.render.call(this);

            this.activateRegion(this.uploadButtonRegion, this.createUploadButton);
            this.activateRegion(this.formattingButtonsRegion, this.createFormattingButtons);

            return this;
        },

        createUploadButton: function () {
            var view = new UploadButtonView({
                el: this.uploadButtonRegion.el,
                template: uploadButtonTemplate,
            });

            // Hook event to postbox's upload callback
            this.listenTo(view, 'uploader:attachMedia', function () {
                var postbox = this.getPostbox();
                postbox.handleUploadViaButton.apply(postbox, arguments);
            });

            return view;
        },

        createFormattingButtons: function () {
            return new FormattingButtonsView({
                el: this.formattingButtonsRegion.el,
                getPostbox: this.getPostbox,
            });
        },

        showFormatting: function () {
            confirmModal.confirmationPromise(
                confirmModal.TYPES.CLOSE,
                formattingTemplate(this.model.thread.forum.channel.toJSON())
            );
        },
    });

    withSubviews.call(DiscussionCreateToolbarView.prototype);

    return DiscussionCreateToolbarView;
});

define('home/templates/discussionChannelInfo',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<img class=\"favicon\" src=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"options") : depth0)) != null ? lookupProperty(stack1,"favicon") : stack1), depth0))
    + "\" alt=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"name") : depth0), depth0))
    + "\"/>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a class=\"discussion-origin-name truncate-line\" href=\"/home/channel/"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"slug") : depth0), depth0))
    + "/\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = (depth0 != null ? lookupProperty(depth0,"options") : depth0)) != null ? lookupProperty(stack1,"favicon") : stack1),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":2,"column":0},"end":{"line":4,"column":7}}})) != null ? stack1 : "")
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"name") : depth0), depth0))
    + "\n</a>\n";
},"useData":true})

});
define('home/templates/threadSubmitError',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"modal-header\">\n<h4 class=\"modal-title\">"
    + alias1(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Uh oh, we weren't unable to save your discussion",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":2,"column":24},"end":{"line":2,"column":86}}}))
    + "</h4>\n</div>\n<div class=\"modal-body\">\n<p>"
    + alias1(container.lambda(((stack1 = (depth0 != null ? lookupProperty(depth0,"responseJSON") : depth0)) != null ? lookupProperty(stack1,"response") : stack1), depth0))
    + "</p>\n</div>\n";
},"useData":true})

});
define('home/views/DiscussionCreateView',[
    'underscore',
    'backbone-marionette',

    'core/mixins/withEmailVerifyLink',
    'core/strings',

    'home/mixins/withSubviews',
    'home/models/Thread',
    'home/templates/discussionCreate',

    'home/utils/features',
    'home/utils/backboneUtils',
    'home/utils/confirmModal',
    'home/utils/trackingUtils',
    'home/views/PostReplyView',
    'home/views/EditDiscussionCategoryView',
    'home/views/TopicInputView',
    'home/views/ChannelBannerView',
    'home/views/DiscussionCreateToolbarView',
    'home/templates/discussionChannelInfo',
    'home/templates/threadSubmitError',
], function (
    _,
    Marionette,

    withEmailVerifyLink,
    strings,

    withSubviews,
    Thread,
    discussionCreateTemplate,

    featureUtils,
    backboneUtils,
    confirmModal,
    trackingUtils,
    PostReplyView,
    EditDiscussionCategoryView,
    TopicInputView,
    ChannelBannerView,
    DiscussionCreateToolbarView,
    discussionChannelInfoTmpl,
    threadSubmitErrorTemplate
) {
    'use strict';

    var gettext = strings.get;

    var parent = Marionette.ItemView;
    var parentProto = parent.prototype;


    var DiscussionCreateView = parent.extend({
        template: discussionCreateTemplate,
        templateHelpers: function () {
            var modEmail = this.model.thread.forum.channel.get('options').modEmail;
            var isChannelModerator = _.contains(this.session.moderatedForums, this.model.thread.forum.id);

            return {
                isNew: this.isNew,
                sessionUserNumPosts: this.session.user.get('numPosts'),
                sessionUserVerified: this.session.user.get('isVerified'),
                emailHref: modEmail ? 'mailto:' + modEmail : '',
                channelName: this.model.thread.forum.channel.get('name'),
                channelUrl: '/home/channel/' + this.model.thread.forum.channel.get('slug') + '/',
                canInviteActiveUsers: isChannelModerator,
                canModifyTopics: this.canModifyTopics,
            };
        },

        events: {
            'submit': 'submitThread',
            'click [data-action=cancel-create]': 'navigateBack',
            'blur input[name=title]': 'updateTitle',
        },

        ui: {
            title: '[name=title]',
            subscribe: '[name=subscribe]',
            inviteActiveUsers: '[name=invite-active-users]',
        },

        initialize: function (options) {
            var thread = this.model.thread;
            this.isNew = thread.isNew();
            trackingUtils.setSection(this.isNew ? 'create' : 'edit');

            this.listenTo(this.model, 'change:category', this.categoryChanged);
            this.listenTo(this.model, 'change', this.updateValidationErrors);
            this.listenTo(this.model.topics, 'add remove reset', this.updateValidationErrors);
            this.listenTo(this.model, 'invalid', this.handleValidationError);

            this.session = options.session;
        },

        regions: {
            postboxRegion: '[data-role=postbox]',
            channelInfoRegion: '[data-role=channel-info]',
            categoriesRegion: '[data-role=channel-categories]',
            topicInputRegion: '[data-role=topic-input]',
            bannerRegion: '[data-role=banner]',
            toolbarRegion: '[data-role=toolbar]',
        },

        getThread: function () {
            return this.model.thread;
        },

        getForum: function () {
            return this.model.thread.forum;
        },

        getMetaAttrs: function () {
            return backboneUtils.getPromiseFor(this.model.thread.forum, 'name')
                .then(function (name) {
                    return strings.interpolate(gettext('Create new discussion on %(name)s'), { name: name });
                });

        },

        render: function () {
            parentProto.render.call(this);

            if (!this.session.fetched)
                return void this.session.fetch().then(_.bind(this.render, this));

            this.activateRegion(this.postboxRegion, this.createPostbox);
            this.activateRegion(this.toolbarRegion, this.createToolbarView);

            var channel = this.model.thread.forum.channel;
            if (channel) {
                this.activateRegion(this.channelInfoRegion, this.createChannelView);
                this.activateRegion(this.bannerRegion, this.createBanner);
                this.activateRegion(this.topicInputRegion, this.createTopicInput);

                var categories = channel.getCategories();
                if (categories)
                    this.activateRegion(this.categoriesRegion, this.createCategoriesView);
            }

            return this;
        },

        createToolbarView: function () {
            return new DiscussionCreateToolbarView({
                el: this.toolbarRegion.el,
                model: this.model,
                getPostbox: _.bind(function () {
                    return this.postboxRegion.currentView;
                }, this),
            });
        },

        createBanner: function () {
            return new ChannelBannerView({
                el: this.bannerRegion.el,
                model: this.model.thread.forum.channel,
            });
        },

        createChannelView: function () {
            return new Marionette.ItemView({
                el: this.channelInfoRegion.el,
                model: this.model.thread.forum.channel,
                template: discussionChannelInfoTmpl,
            });
        },

        createCategoriesView: function () {
            var view = new EditDiscussionCategoryView({
                model: this.model,
            });

            this.bindTitleCategoryHandlers();

            return view;
        },

        /**
         * Adds the chosen category as a prefix to the title input and
         * makes that part of the input read-only.
         */
        categoryChanged: function (_model, newCategory) {
            var $title = this.ui.title;

            // Remove any existing category prefix from the title
            var prevCategory = this.model._previousAttributes.category;
            if (prevCategory) {
                var strippedTitle = $title.val().match(
                    new RegExp(prevCategory + Thread.CATEGORY_TITLE_SEPARATOR + '(.*)')
                );

                if (strippedTitle)
                    $title.val(strippedTitle[1]);
            }

            $title.val(newCategory + Thread.CATEGORY_TITLE_SEPARATOR + $title.val());
            this.updateTitle();
        },

        /**
         * Adds listeners for input into the title input which prevent the user from
         * editing or deleting the category.
         */
        bindTitleCategoryHandlers: function () {
            if (this.titleCategoryHandlerBound)
                return;

            var $title = this.ui.title;

            // Use a partial here to pass this view's model as an argument to the handler so
            // that we don't overwrite the context, which is used, and so we don't
            // reference variables outside the function scope, which is more
            // expensive, on a handler that is called many many times.
            var titleCategoryHandler = _.partial(function (model, evt) {
                var category = model.get('category');
                var prefixLength = category && (category + Thread.CATEGORY_TITLE_SEPARATOR).length;

                // Prevent keypresses other than the allowed keys while in the
                // read-only category section of the title input, and prevent
                // backspace if at the end of the category section.
                if (!_.contains(DiscussionCreateView.NON_EDITING_KEYS, evt.which) &&
                    ((this.selectionStart < prefixLength) ||
                    (this.selectionStart === prefixLength && evt.which === 8))
                )
                    return false;
            }, this.model);

            $title.on('keydown', titleCategoryHandler);

            this.titleCategoryHandlerBound = true;
        },

        submitThread: function (ev) {
            ev.preventDefault();

            var postbox,
                message;

            if (this._submitLocked || !this.model.isValid())
                return;

            // Save the text in the form to thread.message
            postbox = this.postboxRegion.currentView;
            message = postbox.textarea.get();

            if (!this._oldMessage && !this._oldRawMessage) {
                // Should not override to preserve the original message
                // in case the user unsuccessfully submits multiple times
                // then cancels
                this._oldMessage = this.model.thread.get('message');
                this._oldRawMessage = this.model.thread.get('raw_message');
            }

            this._submitLocked = this.model.thread.save({
                title: this.ui.title.val(),
                message: message,
                shouldSanitizeMessage: true,
            }, {
                success: _.bind(this.handleThreadCreate, this),
                error: _.bind(this.handleSaveError, this),
            });

            if (this._submitLocked) {
                this.$el.find('form').addClass('is-submitting');
                this.$el.find('#submit-button').prop('disabled', true);
                this.$el.find('#cancel-button').prop('disabled', true);
            }
        },

        createPostbox: function () {
            var postbox = new PostReplyView({
                // Normally you pass a post model to PostReplyView but it turns out
                // the thread model and post model are both similar enough to be
                // consumed by PostReplyView
                model: this.model.thread,
                // Thread must also be passed here; while the model was used
                // for basic functionality, thread is used to check settings
                thread: this.model.thread,
                placeholder: gettext('Tell people what you want your discussion to be about.  Use gifs and images too.'),
                session: this.session,
                canUseContentEditable: featureUtils.canUseContentEditable(),
                showSubmitButton: false,
                showAvatar: false,
                showMediaPreviews: true,
                showMustVerifyAlert: false,
            });

            this.listenTo(postbox, 'blur', this.updateMessage);

            return postbox;
        },

        createTopicInput: function () {
            return new TopicInputView({
                collection: this.model.topics,
            });
        },

        handleThreadCreate: function () {
            this.model.thread.set('shouldSanitizeMessage', false); // successfully created, have sanitized response
            if (typeof this.ui.subscribe !== 'object' || typeof this.ui.inviteActiveUsers !== 'object')
                // User navigated away from page before thread was created,
                // can no longer access check boxes
                return;

            // Should the author be subscribed to this thread upon thread creation
            var shouldSubscribe = this.ui.subscribe.prop('checked');
            if (shouldSubscribe)
                this.model.thread.subscribe();

            // Whether the most active users in this channel should be invited
            var shouldInviteActiveUsers = this.ui.inviteActiveUsers.prop('checked');
            if (shouldInviteActiveUsers)
                this.model.thread.inviteUserGroup('good_forum_commenters');

            // Save any topics that might have been added or removed
            this.model.saveVisibleTopics();

            if (this.isNew)
                // Indicate that this thread has been recently created
                this.model.thread.set('isNew', true);

            // Trigger 'createThread' so code upstream knows we're
            // done creating/updating this original thread
            this.trigger('createThread');
        },

        updateTitle: function () {
            this.model.set({
                title: this.ui.title.val(),
            });
        },

        updateMessage: function () {
            var postbox = this.postboxRegion.currentView;

            this.model.set({
                message: postbox.textarea.get(),
            });
        },

        updateValidationErrors: function () {
            // Assume all inputs are valid, remove the invalid styling
            this.$('.form-attribute-input').removeClass('is-error');

            // Run validation, if it fails, it will trigger an invalid event
            // which will cause the invalid styling to reappear
            this.model.isValid();
        },

        handleValidationError: function (_model, errs) {
            _.each(errs, function (err) {
                // Attribute input elements may have multiple attributes specified in
                // data-attribute, because there may be multiple attributes editable
                // in that input group and errors for all of those attributes should
                // show up in the same way.
                this.$('.form-attribute-input[data-attribute*=' + err.attrName + ']')
                    .addClass('is-error')
                    .find('[data-role=attribute-error]')
                    .text(err.message);
            }, this);
        },

        handleSaveError: function (_thread, response) {
            this._submitLocked = false;
            this.$('form').removeClass('is-submitting');
            this.$('#cancel-button').prop('disabled', false);
            this.$('#submit-button').prop('disabled', false);
            confirmModal.confirmationPromise(
                confirmModal.TYPES.CLOSE,
                threadSubmitErrorTemplate(response)
            );
        },

        navigateBack: function () {
            if (this.model.thread.id) {
                // Thread exists, so user was editing it
                if (this._oldMessage && this._oldRawMessage) {
                    this.model.thread.set({
                        message: this._oldMessage,
                        raw_message: this._oldRawMessage,
                        shouldSanitizeMessage: false, // resetting messages to originals from server
                    });
                }
                this.trigger('createThread');
            } else {
                // User canceled creating new thread
                this.trigger('cancelThread');
            }
        },

        getPageTrackingParams: function () {
            return {
                forum: this.model.thread.forum.id,
            };
        },
    }, {
        // Which keys we allow to have effect while in
        // the category prefix part of the title input
        NON_EDITING_KEYS: [
            37, // left arrow
            39, // right arrow
            36, // home
            35, // end
            9, // tab
            13, // enter
        ],
    });


    withSubviews.call(DiscussionCreateView.prototype);
    withEmailVerifyLink.call(DiscussionCreateView.prototype);

    return DiscussionCreateView;
});

define('home/templates/discussionBanner',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"banner__wrapper grad-overlay__wrapper\" data-role=\"banner\">\n<div class=\"grad-overlay\">\n<a href=\"/home/channel/"
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"slug") : depth0), depth0))
    + "/\">\n<div class=\"channel-cover section-contained align align--middle align--between\">\n<div class=\"spacing-right truncate-line text-light\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"channelCoverLogo"),depth0,{"name":"channelCoverLogo","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n<div class=\"visible-lg btn-follow--inverted btn-follow--plain\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"genericFollowButton"),depth0,{"name":"genericFollowButton","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n</div>\n</a>\n</div>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/DiscussionBannerView',[
    'backbone-marionette',

    'home/mixins/withChannelBanner',
    'core/mixins/withChannelFollowing',
    'home/mixins/withClickLinkTracking',

    'home/templates/discussionBanner',
], function (
    Marionette,

    withChannelBanner,
    withChannelFollowing,
    withClickLinkTracking,

    discussionBannerTemplate
) {
    'use strict';

    /**
     * View is the cover view on the discussion page.
     * It has logo or channel name and in mobile, follow button.
     *
     * Expects channel as model.
     */
    var DiscussionBannerView = Marionette.ItemView.extend({
        template: discussionBannerTemplate,

        events: {
            'click a': 'trackClickLink',
        },

        initialize: function (options) {
            this.app = options.app;
            this.session = options.session;

            // toggled:follow event is triggered by the withChannelFollowing
            // mixin when a user clicks on the follow button. Rerender to update
            // the onboarding message.
            this.listenTo(this, 'toggled:follow', this.render);
        },
    });

    var proto = DiscussionBannerView.prototype;

    withClickLinkTracking.call(proto, 'discussion_top_banner');
    withChannelBanner.call(proto);

    withChannelFollowing.call(proto, function () {
        return this.model;
    });

    return DiscussionBannerView;
});

define('home/templates/discussionCoverActions',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    return " -wide";
},"3":function(container,depth0,helpers,partials,data) {
    return " is-recommended";
},"5":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<span class=\"button__count\">"
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"likes") : depth0), depth0))
    + "</span>\n";
},"7":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<li class=\"dropdown\" data-role=\"menu\">\n<a href=\"#\" class=\"button icon__rotate--right\" data-toggle=\"dropdown\">\n<span class=\"icon icon-show-more text-smaller\"></span>\n</a>\n<ul class=\"dropdown-menu dropdown--cards dropdown--discussion\" role=\"menu\" aria-labeledby=\"drop-discover\">\n<li>\n<a href=\"#\" class=\"link text-semibold\" data-action=\"toggle-subscription\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"userSubscription") : depth0),{"name":"if","hash":{},"fn":container.program(8, data, 0),"inverse":container.program(10, data, 0),"data":data,"loc":{"start":{"line":39,"column":0},"end":{"line":43,"column":7}}})) != null ? stack1 : "")
    + "</a>\n</li>\n</ul>\n</li>\n";
},"8":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Unsubscribe from discussion",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":40,"column":0},"end":{"line":40,"column":41}}}))
    + "\n";
},"10":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Subscribe to discussion",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":42,"column":0},"end":{"line":42,"column":37}}}))
    + "\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<ul class=\"list--inline\">\n<li class=\"button__wrapper--recommend -count"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,lookupProperty(helpers,"gt").call(alias1,(depth0 != null ? lookupProperty(depth0,"likes") : depth0),9,{"name":"gt","hash":{},"data":data,"loc":{"start":{"line":2,"column":50},"end":{"line":2,"column":62}}}),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":2,"column":44},"end":{"line":2,"column":77}}})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"favorited") : depth0),{"name":"if","hash":{},"fn":container.program(3, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":2,"column":77},"end":{"line":2,"column":116}}})) != null ? stack1 : "")
    + "\" data-action=\"favorite\">\n<a class=\"button--recommend text-medium\" href=\"#\">\n<span class=\"button__heart icon-heart\"></span>\n<span class=\"button__text hidden-md\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Recommend",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":5,"column":37},"end":{"line":5,"column":60}}}))
    + "</span>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"likes") : depth0),{"name":"if","hash":{},"fn":container.program(5, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":6,"column":0},"end":{"line":8,"column":7}}})) != null ? stack1 : "")
    + "</a>\n</li>\n<li class=\"dropdown\" data-dropdown=\"enabled\">\n<a class=\"button text-medium -share-discussion dropdown-toggle\" data-toggle=\"dropdown\" href=\"#\">\n<span class=\"icon-share-discussion text-smaller icon__position\"></span><span class=\"spacing-left-small hidden-md\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Share",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":14,"column":114},"end":{"line":14,"column":133}}}))
    + "</span>\n</a>\n<ul class=\"dropdown-menu dropdown--cards dropdown--share-discussion\">\n<li>\n<a class=\"link\" data-action=\"share\" data-network=\"twitter\" href=\"#\">\n<span class=\"icon icon-twitter text-smaller icon__position -inline\"></span>\n<strong>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Tweet this",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":20,"column":8},"end":{"line":20,"column":32}}}))
    + "</strong>\n</a>\n</li>\n<li>\n<a class=\"link\" data-action=\"share\" data-network=\"facebook\" href=\"#\">\n<span class=\"icon icon-facebook text-smaller icon__position -inline\"></span>\n<strong>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Post to Facebook",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":26,"column":8},"end":{"line":26,"column":38}}}))
    + "</strong>\n</a>\n</li>\n</ul>\n</li>\n"
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"isDeleted") : depth0),{"name":"unless","hash":{},"fn":container.program(7, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":31,"column":0},"end":{"line":48,"column":11}}})) != null ? stack1 : "")
    + "</ul>\n";
},"useData":true})

});
define('home/views/DiscussionCoverActionsView',[
    'home/views/ThreadCardDefaultFooterView',

    'home/templates/discussionCoverActions',
], function (
    ThreadCardDefaultFooterView,

    discussionCoverActionsTemplate
) {
    'use strict';

    var parent = ThreadCardDefaultFooterView;
    var parentProto = parent.prototype;

    var DiscussionCoverActionsView = parent.extend({
        template: discussionCoverActionsTemplate,

        toggleThreadFavorited: function (evt) {
            parentProto.toggleThreadFavorited.call(this, evt);
            this.$('[data-action=favorite]').addClass('animate-recommend');
        },
    });

    return DiscussionCoverActionsView;
});

define('home/views/common/DiscussionCoverBaseView',[
    'backbone-marionette',

    'core/strings',
    'core/bus',

    'home/models/Session',

    'home/views/DiscussionBannerView',
    'home/views/DiscussionCoverActionsView',
    'home/views/TopicTagCollectionView',
    'home/mixins/withLoginOverlay',
    'home/mixins/withTruncate',
    'home/mixins/withSubviews',
], function (
    Marionette,

    strings,
    bus,

    Session,

    DiscussionBannerView,
    DiscussionCoverActionsView,
    TopicTagCollectionView,
    withLoginOverlay,
    withTruncate,
    withSubviews
) {
    'use strict';

    var parent = Marionette.ItemView;
    var gettext = strings.get;

    // Not intended to be instantiated. Should be subclassed.
    var DiscussionCoverBaseView = parent.extend({
        events: {
            'click [data-role=message] a': 'trackClickLink',
        },

        trackClickLink: function (evt) {
            bus.trigger('uiAction:clickLink', evt, {
                adjective: 'message',
            });
        },

        templateHelpers: function () {
            var thread = this.model.thread;
            var channel = this.model.channel;

            return {
                relativeTime: thread.getRelativeCreatedAt(),
                channel: channel && channel.toJSON(),
                image: thread.getImage(),
                discussionRoute: thread.getDiscussionRoute(this.channel),
            };
        },

        initialize: function (options) {
            this.app = options.app;
            this.session = Session.get();

            this.channel = this.model.channel;
            if (this.channel)
                // If channel is passed as an option, it it likely specified because it is not
                // fetchable as part of the forum, so it will require a separate fetch and
                // will need a rerender once fetched.
                this.listenTo(this.channel, 'change', this.render);

            this.listenTo(this.model.thread, {
                'sync': this.render,
                'change:extending': this.render,
            });
        },

        regions: {
            bannerRegion: '[data-role=banner]',
            topicsRegion: '[data-role=topics]',
            threadActionsRegion: '[data-role=thread-actions]',
        },

        onRender: function () {
            var channel = this.model.channel;
            if (channel) {
                this.activateRegion(this.bannerRegion, this.createBanner);
                this.activateRegion(this.topicsRegion, this.createTopicsView);
            }

            this.activateRegion(this.threadActionsRegion, this.createThreadActions);
        },

        createBanner: function () {
            return new DiscussionBannerView({
                model: this.model.channel,
                app: this.app,
                session: this.session,
            });
        },

        createThreadActions: function () {
            return new DiscussionCoverActionsView({
                el: this.threadActionsRegion.el,
                model: this.model.thread,
                channel: this.model.channel,
            });
        },

        createTopicsView: function () {
            var topics = this.model.thread.topics;
            var channel = this.model.channel;

            return new TopicTagCollectionView({
                collection: topics,
                channel: channel,
            });
        },
    });

    var proto = DiscussionCoverBaseView.prototype;
    withLoginOverlay.call(proto,
        strings.interpolate(
            gettext('Join %(disqus)s to discover more great discussions like these.'),
            { disqus: 'Disqus' }
        ));
    withTruncate.call(proto);
    withSubviews.call(proto);

    return DiscussionCoverBaseView;
});

define('home/templates/networkDiscussionCover',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    return " is-deleted";
},"3":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a class=\"spacing-right\" href=\"/home/forum/"
    + alias2(alias1(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + "/\"\ndata-role=\"publisher-link\">\n<img class=\"img-round-sm block__item\" src=\""
    + alias2(alias1(((stack1 = ((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1)) != null ? lookupProperty(stack1,"favicon") : stack1)) != null ? lookupProperty(stack1,"cache") : stack1), depth0))
    + "\" alt=\""
    + alias2(alias1(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1)) != null ? lookupProperty(stack1,"name") : stack1), depth0))
    + "\"/>\n</a>\n";
},"5":function(container,depth0,helpers,partials,data) {
    return " has-image";
},"7":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card-content__media\">\n<div style=\"background-image: url("
    + container.escapeExpression(container.lambda(((stack1 = (depth0 != null ? lookupProperty(depth0,"image") : depth0)) != null ? lookupProperty(stack1,"src") : stack1), depth0))
    + ")\" class=\"img-cards\"></div>\n</div>\n";
},"9":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"spacing-bottom-small\">\n<p class=\"truncate\" data-truncate-lines=\"2\" dir=\"auto\">\n"
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"description") : depth0), depth0))
    + "\n</p>\n</div>\n";
},"11":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"text-smaller link-inner-gray spacing-bottom-narrow\">\n<span class=\"icon icon-communities icon__position -inline icon-tiny\"></span>\n"
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"forumFriendlyUrl") : depth0), depth0))
    + "\n</div>\n";
},"13":function(container,depth0,helpers,partials,data) {
    return "<span class=\"icon icon-lock icon-tiny spacing-right-small\"></span>\n";
},"15":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"1 Comment",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":56,"column":0},"end":{"line":56,"column":23}}}))
    + "\n";
},"17":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"%(number)s Comments",{"name":"gettext","hash":{"number":((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"posts") : stack1)},"data":data,"loc":{"start":{"line":58,"column":0},"end":{"line":58,"column":55}}}))
    + "\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.lambda, alias3=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"discussion-page--network\">\n<header data-role=\"banner\"></header>\n<div class=\"section-contained\">\n<div class=\"layout layout--tablet-no-aside"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"isDeleted") : stack1),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":4,"column":42},"end":{"line":4,"column":84}}})) != null ? stack1 : "")
    + "\">\n<div class=\"layout__main-with-aside\">\n<div class=\"layout__content -centered\">\n<header class=\"align align--middle spacing-bottom\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"hasFavicon") : depth0),{"name":"if","hash":{},"fn":container.program(3, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":8,"column":0},"end":{"line":13,"column":7}}})) != null ? stack1 : "")
    + "<div class=\"discussion__byline truncate-line\">\n<a href=\"/home/forum/"
    + alias3(alias2(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + "/\">\n<strong>"
    + alias3(alias2(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1)) != null ? lookupProperty(stack1,"name") : stack1), depth0))
    + "</strong>\n</a>\n<time class=\"bullet text-gray\">"
    + alias3(alias2((depth0 != null ? lookupProperty(depth0,"relativeTime") : depth0), depth0))
    + "</time>\n</div>\n</header>\n<section class=\"discussion__content\">\n<a href=\""
    + alias3(alias2(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"link") : stack1), depth0))
    + "\"\nclass=\"card-wrap -link\"\ndata-role=\"article-link\"\ndata-link-out=\""
    + alias3(alias2(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"signedLink") : stack1), depth0))
    + "\">\n<div class=\"card__content -network"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"image") : depth0),{"name":"if","hash":{},"fn":container.program(5, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":26,"column":34},"end":{"line":26,"column":64}}})) != null ? stack1 : "")
    + "\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"image") : depth0),{"name":"if","hash":{},"fn":container.program(7, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":27,"column":0},"end":{"line":31,"column":7}}})) != null ? stack1 : "")
    + "<div class=\"card-content__body\">\n<h2 class=\"discussion-title text-brand link-default-hover\" dir=\"auto\">\n"
    + alias3(alias2(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"clean_title") : stack1), depth0))
    + "\n</h2>\n<div class=\"card-content__summary\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"description") : depth0),{"name":"if","hash":{},"fn":container.program(9, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":37,"column":0},"end":{"line":43,"column":7}}})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"forumFriendlyUrl") : depth0),{"name":"if","hash":{},"fn":container.program(11, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":44,"column":0},"end":{"line":49,"column":7}}})) != null ? stack1 : "")
    + "<div class=\"text-medium text-gray-darker\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"isClosed") : stack1),{"name":"if","hash":{},"fn":container.program(13, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":51,"column":0},"end":{"line":53,"column":7}}})) != null ? stack1 : "")
    + "<strong>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,lookupProperty(helpers,"eq").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"posts") : stack1),1,{"name":"eq","hash":{},"data":data,"loc":{"start":{"line":55,"column":6},"end":{"line":55,"column":25}}}),{"name":"if","hash":{},"fn":container.program(15, data, 0),"inverse":container.program(17, data, 0),"data":data,"loc":{"start":{"line":55,"column":0},"end":{"line":59,"column":7}}})) != null ? stack1 : "")
    + "</strong>\n</div>\n</div>\n</div>\n</div>\n</a>\n</section>\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"threadPostActivity"),depth0,{"name":"threadPostActivity","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n</div>\n<div class=\"layout__aside hidden-lg\">\n<div class=\"absolute__wrapper -aside\">\n<div data-role=\"sign-up-module\"></div>\n<div data-role=\"channel-module\" data-jester-area=\"channel_sidebar\" class=\"module--aside\"></div>\n</div>\n</div>\n</div>\n</div>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/NetworkDiscussionCoverView',[
    'underscore',
    'backbone',

    'home/views/ChannelsModuleView',
    'home/views/common/DiscussionCoverBaseView',

    'home/templates/networkDiscussionCover',
], function (
    _,
    Backbone,

    ChannelsModuleView,
    DiscussionCoverBaseView,

    networkDiscussionCoverTemplate
) {
    'use strict';

    var parent = DiscussionCoverBaseView;
    var parentProto = DiscussionCoverBaseView.prototype;

    var NetworkDiscussionCoverView = parent.extend({
        template: networkDiscussionCoverTemplate,

        templateHelpers: function () {
            var existing = DiscussionCoverBaseView.prototype.templateHelpers.apply(this, arguments);
            var thread = this.model.thread;

            return _.defaults({
                hasFavicon: thread.forum.hasFavicon(),
                forumFriendlyUrl: thread.forum.getFriendlyUrl(),
                description: thread.getPlainDescription(),
            }, existing);
        },

        regions: _.defaults({
            channelRegion: '[data-role=channel-module]',
        }, parentProto.regions),

        onRender: function () {
            parentProto.onRender.call(this);
            this.activateRegion(this.channelRegion, this.createChannelsView);
        },

        createChannelsView: function () {
            var shuffledChannels = new Backbone.Collection();

            this.model.channels.ensureFetched().then(_.bind(function () {
                // Once the channels have been fetched, reset the ChannelsModuleView's collection
                // with a shuffled copy of the channels.
                // (Make a copy instead of mutating the collection, as it may be used elsewhere)
                shuffledChannels.reset(_.shuffle(this.model.channels.items.models));
            }, this));

            return new ChannelsModuleView({
                collection: shuffledChannels,
            });
        },
    });

    return NetworkDiscussionCoverView;
});

define('core/WindowBus',[
    'jquery',
    'underscore',
    'backbone',
    'modernizr',
], function (
    $,
    _,
    Backbone,
    Modernizr
) {
    'use strict';

    /**
     * WindowBus: A cross-frame / tab message passing bus.
     *
     * WindowBus passes messages using localStorage,
     * which means messages are secure, though they persist
     * after the browser session closes.
     *
     * Messages may only be passed between the same domains.
     */
    var WindowBus = Backbone.Model.extend({
        initialize: function () {
            if (Modernizr.localstorage)
                $(window).on('storage', _.bind(this.onStorageEvent, this));
        },

        broadcast: function (name, data) {
            if (!Modernizr.localstorage)
                return;

            var message = JSON.stringify({
                name: name,
                data: data,

                // We need to append a cache buster to the storage key so that
                // `storage` events are correctly triggered in other frames =/
                time: new Date().getTime(),
            });

            try {
                window.localStorage.setItem(this.constructor.STORAGE_KEY, message);
            } catch (error) {
                // TODO: log error w/ Raven.js
            }

        },

        onStorageEvent: function (evt) {
            var key = evt.originalEvent.key;
            var message = evt.originalEvent.newValue;

            if (!(message && key === this.constructor.STORAGE_KEY))
                return;

            try {
                message = JSON.parse(message);
                this.trigger(message.name, message.data);
            } catch (error) {
                // TODO: log error w/ Raven.js
            }
        },
    }, {
        STORAGE_KEY: 'disqus.bus',
    });

    return WindowBus;
});

define('home/templates/relatedDiscussion',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"module-recent__media\">\n<a href=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"discussionRoute") : depth0), depth0))
    + "\">\n<img src=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"image") : depth0)) != null ? lookupProperty(stack1,"src") : stack1), depth0))
    + "\" class=\"img-fit-sm\" />\n</a>\n</div>\n";
},"3":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"1 Comment",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":17,"column":0},"end":{"line":17,"column":23}}}))
    + "\n";
},"5":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"%(number)s Comments",{"name":"gettext","hash":{"number":((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"posts") : stack1)},"data":data,"loc":{"start":{"line":19,"column":0},"end":{"line":19,"column":55}}}))
    + "\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.lambda, alias3=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"image") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":1,"column":0},"end":{"line":7,"column":7}}})) != null ? stack1 : "")
    + "<div class=\"media-body\">\n<a href=\""
    + alias3(alias2((depth0 != null ? lookupProperty(depth0,"discussionRoute") : depth0), depth0))
    + "\" class=\"module-recent__title spacing-bottom-small\">\n<div class=\"spacing-bottom-narrow\">\n<h2 class=\"truncate\" data-truncate-lines=\"2\" dir=\"auto\">\n"
    + alias3(alias2(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"clean_title") : stack1), depth0))
    + "\n</h2>\n</div>\n<p class=\"text-small text-gray\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,lookupProperty(helpers,"eq").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"posts") : stack1),1,{"name":"eq","hash":{},"data":data,"loc":{"start":{"line":16,"column":6},"end":{"line":16,"column":25}}}),{"name":"if","hash":{},"fn":container.program(3, data, 0),"inverse":container.program(5, data, 0),"data":data,"loc":{"start":{"line":16,"column":0},"end":{"line":20,"column":7}}})) != null ? stack1 : "")
    + "</p>\n</a>\n</div>\n";
},"useData":true})

});
define('home/views/RelatedDiscussionView',[
    'backbone-marionette',

    'home/templates/relatedDiscussion',
    'home/mixins/withTruncate',
], function (
    Marionette,

    relatedDiscussionTemplate,
    withTruncate
) {
    'use strict';

    /**
     * A view that shows a recommended discussion item.
     * Template assumes an Activity object with a `thread` path.
     */
    var RelatedDiscussionView = Marionette.ItemView.extend({
        template: relatedDiscussionTemplate,
        className: 'module-recent__item',

        initialize: function (options) {
            this.hideImage = options && options.hideImage;
        },

        templateHelpers: function () {
            var thread = this.model.thread;

            return {
                image: !this.hideImage && this.model.thread.getImage(),
                discussionRoute: thread.getDiscussionRoute(),
            };
        },
    });

    withTruncate.call(RelatedDiscussionView.prototype);

    return RelatedDiscussionView;
});

define('home/templates/relatedDiscussionsModule',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<header class=\"module-header -plain\">\n<div class=\"module-header__title\">\n<h2 class=\"text-gray-darker\">\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(alias1,"More from %(source)s",{"name":"gettext","hash":{"source":lookupProperty(helpers,"getPartial").call(alias1,"channelAwareForumLink",(depth0 != null ? lookupProperty(depth0,"forum") : depth0),{"name":"getPartial","hash":{},"data":data,"loc":{"start":{"line":4,"column":42},"end":{"line":4,"column":84}}})},"data":data,"loc":{"start":{"line":4,"column":0},"end":{"line":4,"column":86}}}))
    + "\n</h2>\n</div>\n</header>\n<div data-role=\"discussions\" class=\"module-body\"></div>\n";
},"useData":true})

});
define('home/views/RelatedDiscussionsModuleView',[
    'backbone-marionette',

    'home/views/RelatedDiscussionView',
    'home/views/ProfileModuleEmptyView',

    'home/templates/relatedDiscussionsModule',
], function (
    Marionette,

    RelatedDiscussionView,
    ProfileModuleEmptyView,

    relatedDiscussionsModuleTemplate
) {
    'use strict';
    /**
     * A view that shows a recommended discussion module with a list of discussions.
     * The model is assumed to be a `Backbone.Collection` object.
     */
    var RelatedDiscussionsModuleView = Marionette.CompositeView.extend({
        template: relatedDiscussionsModuleTemplate,
        itemView: RelatedDiscussionView,
        itemViewContainer: '[data-role=discussions]',
        emptyView: ProfileModuleEmptyView,
    });

    return RelatedDiscussionsModuleView;
});

define('home/templates/discussionPageChannelInfo',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<img src=\""
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"channelAvatar") : depth0), depth0))
    + "\" class=\"img-round-sm block__item\" />\n";
},"3":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = (depth0 != null ? lookupProperty(depth0,"options") : depth0)) != null ? lookupProperty(stack1,"favicon") : stack1),{"name":"if","hash":{},"fn":container.program(4, data, 0),"inverse":container.program(6, data, 0),"data":data,"loc":{"start":{"line":8,"column":0},"end":{"line":12,"column":7}}})) != null ? stack1 : "");
},"4":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<img src=\""
    + container.escapeExpression(container.lambda(((stack1 = (depth0 != null ? lookupProperty(depth0,"options") : depth0)) != null ? lookupProperty(stack1,"favicon") : stack1), depth0))
    + "\" class=\"img-round-sm block__item\" />\n";
},"6":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = container.invokePartial(lookupProperty(partials,"defaultChannelAvatar"),depth0,{"name":"defaultChannelAvatar","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "");
},"8":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<p class=\"spacing-narrow spacing-top\">\n<a href=\""
    + alias2(alias1(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"channel") : depth0)) != null ? lookupProperty(stack1,"options") : stack1)) != null ? lookupProperty(stack1,"aboutUrlPath") : stack1), depth0))
    + "\"\ndata-link-name=\"about\"\ndata-channel-slug=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"channel") : depth0)) != null ? lookupProperty(stack1,"slug") : stack1), depth0))
    + "\"\nclass=\"button button-outline button-wide text-medium\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Community Guidelines",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":28,"column":0},"end":{"line":28,"column":34}}}))
    + "\n</a>\n</p>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, alias3=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"aside__wrap\">\n<div class=\"aside__header padding-gutter -border-bottom \">\n<div class=\"align align--middle truncate-line text-medium--discussion\">\n<a href=\"/home/channel/"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"slug") : depth0), depth0))
    + "/\" class=\"spacing-right\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias3,(depth0 != null ? lookupProperty(depth0,"channelAvatar") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"data":data,"loc":{"start":{"line":5,"column":0},"end":{"line":13,"column":7}}})) != null ? stack1 : "")
    + "</a>\n<a href=\"/home/channel/"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"slug") : depth0), depth0))
    + "/\" class=\"link-gray-darker truncate-line\">\n<strong>"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"name") : depth0), depth0))
    + "</strong>\n</a>\n</div>\n<p class=\"text-gray-dark spacing-top-narrow\">\n"
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"options") : depth0)) != null ? lookupProperty(stack1,"description") : stack1), depth0))
    + "\n</p>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias3,((stack1 = (depth0 != null ? lookupProperty(depth0,"options") : depth0)) != null ? lookupProperty(stack1,"aboutUrlPath") : stack1),{"name":"if","hash":{},"fn":container.program(8, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":22,"column":0},"end":{"line":31,"column":7}}})) != null ? stack1 : "")
    + "</div>\n<div class=\"padding-gutter align align--middle\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"channelMetadataStats"),depth0,{"name":"channelMetadataStats","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n</div>\n<div class=\"aside__wrap\" data-role=\"guidelines-section\">\n<div class=\"aside__header -padded -border-bottom text-gray-darker\">\n<h2>"
    + alias2(lookupProperty(helpers,"gettext").call(alias3,"Basic Rules",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":39,"column":4},"end":{"line":39,"column":29}}}))
    + "</h2>\n</div>\n<div class=\"padding-gutter\">\n<div class=\"guidelines\" data-role=\"guidelines\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"homeRules"),depth0,{"name":"homeRules","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n<a data-link-name=\"guidelines\"\nclass=\"curtain-truncate text-small\"\ndata-action=\"expand\" data-target=\"[data-role=guidelines]\"\nhref=\"#\"\ndata-channel-slug=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"channel") : depth0)) != null ? lookupProperty(stack1,"slug") : stack1), depth0))
    + "\">\n\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias3,"Show guidelines",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":51,"column":0},"end":{"line":51,"column":29}}}))
    + "\n<span class=\"icon__position -inline icon-arrow icon\"></span>\n</a>\n<a data-action=\"collapse\" data-target=\"[data-role=guidelines]\" class=\"hidden text-small\" href=\"#\">\n<span class=\"icon__position -inline icon-arrow-2 icon\"></span>\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias3,"Collapse guidelines",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":56,"column":0},"end":{"line":56,"column":33}}}))
    + "\n</a>\n</div>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/DiscussionPageChannelInfoView',[
    'backbone-marionette',

    'home/mixins/withChannelAvatar',
    'core/mixins/withChannelFollowing',
    'home/mixins/withCollapsing',
    'home/templates/discussionPageChannelInfo',
], function (
    Marionette,

    withChannelAvatar,
    withChannelFollowing,
    withCollapsing,
    discussionPageChannelInfo
) {
    'use strict';

    /**
     * View shows the channel info and a follow button
     *
     * Expects a Channel model for model and the router instance in options.app.
     */
    var DiscussionPageChannelInfoView = Marionette.ItemView.extend({
        template: discussionPageChannelInfo,

        templateHelpers: function () {
            var primaryForum = this.model.primaryForum;
            var numThreads = primaryForum.get('numThreads');
            var numFollowers = primaryForum.get('numFollowers');

            return {
                // Attributes may be null during fetch
                numThreads: numThreads && numThreads.toLocaleString(),
                numFollowers: numFollowers && numFollowers.toLocaleString(),
                previouslyFollowing: this.previouslyFollowing,
            };
        },

        initialize: function (options) {
            this.app = options.app;
            this.session = options.session;
            this.previouslyFollowing = this.getIsFollowing();
            this.bindToPrimaryForum();

            // toggled:follow event is triggered by the withChannelFollowing
            // mixin when a user clicks on the follow button. Rerender to update
            // the onboarding message.
            this.listenTo(this, 'toggled:follow', this.render);
        },

        bindToPrimaryForum: function () {
            if (!this.model.primaryForum) {
                this.listenToOnce(this.model, 'changeRelated:primaryForum', this.bindToPrimaryForum);
                return;
            }

            this.listenTo(this.model.primaryForum,
                'change:numFollowers change:numThreads',
                this.render);
        },

    });

    withChannelFollowing.call(DiscussionPageChannelInfoView.prototype, function () {
        return this.model;
    });

    withChannelAvatar.call(DiscussionPageChannelInfoView.prototype, function () {
        return this.model;
    });

    withCollapsing.call(DiscussionPageChannelInfoView.prototype, {
        maxHeight: 200, // px
        collapsibleSelector: '[data-role=guidelines-section]',
    });

    return DiscussionPageChannelInfoView;
});


define('home/mixins/withExpiration',[
    'underscore',
    'modernizr',
], function (
    _,
    Modernizr
) {
    'use strict';

    var localStorageSupported = Modernizr.localstorage;

    /**
     * Mixin for views that are meant to be shown X number of times or until it has
     * been closed. Given a string unique to this view with which to store the
     * number of times it has been viewed, and optionally the number of times the view
     * should show before hiding. (Default is 5)
     *
     * Javascript:
     *     withExpiration.call(View.prototype, 'notificationOnboardViewsRemaining')
     *         OR
     *     withExpiration.call(View.prototype, 'notificationOnboardViewsRemaining', 10)
     *
     * viewExpired is passed into the template to show or hide the view.
     *
     * Template:
     *    {{#unless viewExpired}}
     *        <div>
     *            <div> some content </div>
     *
     *            {{! hides view permanently when clicked }}
     *            <a href="#" class="close" data-action="force-expiration"><span class="icon-cancel"></span></a>
     *        </div>
     *    {{/unless}}
     *
     */
    var ExpirationMixin = {
        templateHelpers: function (_templateHelpers) {
            if (_.isFunction(_templateHelpers))
                _templateHelpers = _templateHelpers.call(this);

            return _.extend({
                // Hide the view if the local storage value indicates not
                // to show the view anymore
                viewExpired: !localStorageSupported || this.getRemainingViews() <= 0,
            }, _templateHelpers);
        },

        events: {
            'click [data-action=force-expiration]': 'forceExpire',
        },

        onShow: function (_onShow) {
            if (_.isFunction(_onShow))
                _onShow.call(this);

            this.decrementRemainingViews();
        },

        /**
         * Updates local storage to indicate that this user should not
         * see the view ever again.
         */
        forceExpire: function (evt) {
            if (evt)
                evt.preventDefault();
            this.setRemainingViews(-1);
            this.remove();
        },

        /**
         * At most once per app load, decrements the counter for how many times the
         * user has left to see the view
         */
        decrementRemainingViews: _.once(function () {
            var toSeeCount = this.getRemainingViews();

            if (toSeeCount > 0)
                this.setRemainingViews(toSeeCount - 1);
        }),

        /**
         * Reads the local storage tracking how many times this user has
         * left to see the view.
         * If value does not exist, or if local storage not supported, returns
         * the default number of views.
         * @returns {integer}
         */
        getRemainingViews: function () {
            if (localStorageSupported) {
                var remainingViews = parseInt(window.localStorage.getItem(this.getExpirationKey()), 10);
                if (!isNaN(remainingViews))
                    return remainingViews;
            }

            return this.getNumberOfViews();
        },

        /**
         * Returns how many times this view should be shown before being hidden.
         * Defaults to 5.
         */
        getNumberOfViews: function () {
            return this.defaultViews || 5;
        },

        /**
         * Writes to local storage tracking how many times this user has
         * left to see the view.
         * Does nothing if local storage is not supported
         * @param  {integer} value the new value
         */
        setRemainingViews: function (value) {
            if (localStorageSupported)
                window.localStorage.setItem(this.getExpirationKey(), value);
        },

        getExpirationKey: function () {
            return _.result(this, 'expirationKey');
        },
    };

    return function withExpiration() {
        this.templateHelpers = _.wrap(this.templateHelpers, ExpirationMixin.templateHelpers);
        this.onShow = _.wrap(this.onShow, ExpirationMixin.onShow);
        this.events = _.defaults({}, this.events, ExpirationMixin.events);

        _.extend(this, _.pick(ExpirationMixin,
            'forceExpire',
            'decrementRemainingViews',
            'getRemainingViews',
            'getNumberOfViews',
            'setRemainingViews',
            'getExpirationKey'
        ));
    };
});

define('home/templates/followChannelPrompt',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"unless").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"viewExpired") : depth0),{"name":"unless","hash":{},"fn":container.program(2, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":2,"column":0},"end":{"line":25,"column":11}}})) != null ? stack1 : "");
},"2":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"follow-prompt__wrapper\">\n<div class=\"alert -outline spacing-narrow\">\n<div class=\"media\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"options") : depth0)) != null ? lookupProperty(stack1,"favicon") : stack1),{"name":"if","hash":{},"fn":container.program(3, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":6,"column":0},"end":{"line":12,"column":7}}})) != null ? stack1 : "")
    + "<div class=\"media-right\">\n<p class=\"text-larger\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Enjoy %(channelName)s?",{"name":"gettext","hash":{"channelName":lookupProperty(helpers,"tag").call(alias1,"strong",{"name":"tag","hash":{"text":(depth0 != null ? lookupProperty(depth0,"name") : depth0)},"data":data,"loc":{"start":{"line":15,"column":49},"end":{"line":15,"column":75}}})},"data":data,"loc":{"start":{"line":15,"column":0},"end":{"line":15,"column":78}}}))
    + "\n</p>\n<p class=\"spacing-narrow\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"It's easy to keep up with %(channelName)s. Just follow and you'll start seeing the latest updates in your home feed. You can follow other channels too!",{"name":"gettext","hash":{"channelName":(depth0 != null ? lookupProperty(depth0,"name") : depth0)},"data":data,"loc":{"start":{"line":18,"column":0},"end":{"line":18,"column":185}}}))
    + "\n</p>\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"genericFollowButton"),depth0,{"name":"genericFollowButton","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n</div>\n</div>\n</div>\n";
},"3":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"media-left spacing-right\">\n<a href=\"/home/channel/"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"slug") : depth0), depth0))
    + "/\">\n<img src=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"options") : depth0)) != null ? lookupProperty(stack1,"favicon") : stack1), depth0))
    + "\" alt=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"name") : depth0), depth0))
    + "\" class=\"img-avatar-lg\">\n</a>\n</div>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"shouldShowAlert") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":1,"column":0},"end":{"line":26,"column":7}}})) != null ? stack1 : "");
},"usePartial":true,"useData":true})

});
define('home/views/FollowChannelPromptView',[
    'backbone-marionette',

    'remote/config',

    'core/mixins/withChannelFollowing',
    'home/mixins/withExpiration',
    'home/models/Session',
    'home/templates/followChannelPrompt',
], function (
    Marionette,

    remoteConfig,

    withChannelFollowing,
    withExpiration,
    Session,
    followChannelPromptTemplate
) {
    'use strict';

    var FollowChannelPromptView = Marionette.ItemView.extend({
        template: followChannelPromptTemplate,

        templateHelpers: function () {
            return {
                shouldShowAlert: this.session.isLoggedIn() && !this.model.primaryForum.get('isFollowing'),
            };
        },

        initialize: function () {
            this.session = Session.get();
            this.expirationKey = 'followChannelPrompt-' + this.model.get('slug');
            this.defaultViews = remoteConfig.lounge.follow_channel_prompt_views;

            this.listenTo(this.session, 'change:id', this.render);
        },

    });

    withChannelFollowing.call(FollowChannelPromptView.prototype);
    withExpiration.call(FollowChannelPromptView.prototype);

    return FollowChannelPromptView;
});

define('home/templates/userGeneratedDiscussionCover',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    return " is-deleted";
},"3":function(container,depth0,helpers,partials,data) {
    return " is-spam";
},"5":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"alert alert--brand spacing-bottom-double align-min-tablet align--between align--middle text-center\">\n<div class=\"text-semibold\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Share your discussion to get comments!",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":18,"column":27},"end":{"line":18,"column":79}}}))
    + "</div>\n<div class=\"spacing-narrow\">\n<button class=\"button button-inverted -border-light text-small\" data-action=\"share\" data-network=\"facebook\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Share on %(facebook)s",{"name":"gettext","hash":{"facebook":"Facebook"},"data":data,"loc":{"start":{"line":21,"column":0},"end":{"line":21,"column":57}}}))
    + "\n</button>\n<button class=\"button button-inverted -border-light text-small spacing-left\" data-action=\"share\" data-network=\"twitter\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Share on %(twitter)s",{"name":"gettext","hash":{"twitter":"Twitter"},"data":data,"loc":{"start":{"line":24,"column":0},"end":{"line":24,"column":54}}}))
    + "\n</button>\n</div>\n</div>\n";
},"7":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"alert alert--warning text-medium\">\n<strong>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"This discussion has been removed.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":32,"column":8},"end":{"line":32,"column":55}}}))
    + "</strong>\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Seem wrong? Contact %(support)s.",{"name":"gettext","hash":{"support":lookupProperty(helpers,"tag").call(alias1,"a",{"name":"tag","hash":{"text":lookupProperty(helpers,"gettext").call(alias1,"%(disqus)s Support",{"name":"gettext","hash":{"disqus":"Disqus"},"data":data,"loc":{"start":{"line":35,"column":5},"end":{"line":35,"column":51}}}),"href":"http://disqus.com/support"},"data":data,"loc":{"start":{"line":34,"column":10},"end":{"line":35,"column":52}}})},"data":data,"loc":{"start":{"line":33,"column":0},"end":{"line":35,"column":54}}}))
    + "\n</div>\n";
},"9":function(container,depth0,helpers,partials,data) {
    return "<span class=\"icon-lock icon-small spacing-right-small\"></span>\n";
},"11":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"1 Comment",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":51,"column":0},"end":{"line":51,"column":23}}}))
    + "\n";
},"13":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"%(number)s Comments",{"name":"gettext","hash":{"number":((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"posts") : stack1)},"data":data,"loc":{"start":{"line":53,"column":0},"end":{"line":53,"column":55}}}))
    + "\n";
},"15":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\"/home/edit/"
    + alias2(alias1(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + "/"
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"slug") : stack1), depth0))
    + "/\" class=\"spacing-left text-semibold\">\n<span class=\"icon-cog icon-small spacing-right-small\"></span>"
    + alias2(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Edit",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":58,"column":61},"end":{"line":58,"column":79}}}))
    + "\n</a>\n";
},"17":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\"#\"\nclass=\"tooltipped icon__position -inline -allstar\"\ndata-action=\"show-allstar-modal\"\ndata-toggle=\"tooltip\"\ndata-placement=\"top\"\ntitle=\""
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"All-Star",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":76,"column":7},"end":{"line":76,"column":29}}}))
    + "\"><span class=\"icon-allstar allstar__icon\"></span></a>";
},"19":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"reading-block\" data-role=\"message\">\n"
    + ((stack1 = container.lambda((depth0 != null ? lookupProperty(depth0,"description") : depth0), depth0)) != null ? stack1 : "")
    + "\n</div>\n";
},"21":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\""
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"embedlyLink") : depth0), depth0))
    + "\"\nclass=\"card-wrap -link card-wrap--sm link-gray-dark\"\ndata-role=\"article-link\">\n<div class=\"card__content"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"image") : depth0),{"name":"if","hash":{},"fn":container.program(22, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":97,"column":25},"end":{"line":97,"column":55}}})) != null ? stack1 : "")
    + "\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"image") : depth0),{"name":"if","hash":{},"fn":container.program(24, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":98,"column":0},"end":{"line":102,"column":7}}})) != null ? stack1 : "")
    + "<div class=\"card-content__body text-medium\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"content") : stack1)) != null ? lookupProperty(stack1,"title") : stack1),{"name":"if","hash":{},"fn":container.program(26, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":104,"column":0},"end":{"line":108,"column":7}}})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"content") : stack1)) != null ? lookupProperty(stack1,"description") : stack1),{"name":"if","hash":{},"fn":container.program(28, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":109,"column":0},"end":{"line":113,"column":7}}})) != null ? stack1 : "")
    + "</div>\n</div>\n</a>\n";
},"22":function(container,depth0,helpers,partials,data) {
    return " has-image";
},"24":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card-content__media\">\n<div style=\"background-image: url("
    + container.escapeExpression(container.lambda(((stack1 = (depth0 != null ? lookupProperty(depth0,"image") : depth0)) != null ? lookupProperty(stack1,"src") : stack1), depth0))
    + ")\" class=\"img-cards\"></div>\n</div>\n";
},"26":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<h3 class=\"spacing-bottom-small text-brand link-default-hover\" dir=\"auto\">\n"
    + container.escapeExpression(container.lambda(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"content") : stack1)) != null ? lookupProperty(stack1,"title") : stack1), depth0))
    + "\n</h3>\n";
},"28":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<p class=\"truncate-line link-default-hover\" dir=\"auto\">\n"
    + container.escapeExpression(container.lambda(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"content") : stack1)) != null ? lookupProperty(stack1,"description") : stack1), depth0))
    + "\n</p>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, alias3=container.lambda, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<header data-role=\"banner\"></header>\n<div class=\"section-contained\">\n<div class=\"layout -top-spacing layout--tablet-no-aside"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"isDeleted") : stack1),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":3,"column":55},"end":{"line":3,"column":97}}})) != null ? stack1 : "")
    + "\">\n<div class=\"layout__main-with-aside\">\n<div class=\"layout__content -centered\">\n<div class=\"alert alert--error spacing-bottom-double spam-hidden"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"showSpamAlert") : depth0),{"name":"if","hash":{},"fn":container.program(3, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":6,"column":64},"end":{"line":6,"column":100}}})) != null ? stack1 : "")
    + "\" data-role=\"spam-alert\">\n<div class=\"align-min-tablet align--between align--middle\">\n<div class=\"spacing-narrow\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"This discussion has been marked as spam.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":9,"column":0},"end":{"line":9,"column":54}}}))
    + "\n</div>\n<div>\n<button data-action=\"mark-spam\" class=\"button button-small button-inverted -hover-opaque\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"This isn't spam",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":12,"column":90},"end":{"line":12,"column":119}}}))
    + "</button>\n</div>\n</div>\n</div>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"showSharePrompt") : depth0),{"name":"if","hash":{},"fn":container.program(5, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":16,"column":0},"end":{"line":28,"column":7}}})) != null ? stack1 : "")
    + "\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"isDeleted") : stack1),{"name":"if","hash":{},"fn":container.program(7, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":30,"column":0},"end":{"line":37,"column":7}}})) != null ? stack1 : "")
    + "<div class=\"spacing-bottom\">\n<header class=\"spacing-bottom-small\" data-role=\"title-area\">\n<div data-role=\"topics\" class=\"topics--small topics--discussion\"></div>\n<h1 class=\"text-title text-gray-darker\">\n"
    + alias2(alias3(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"clean_title") : stack1), depth0))
    + "\n</h1>\n</header>\n<div class=\"padding-top-bottom\">\n<a href=\"#disqus_thread\" class=\"spacing-right text-semibold\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"isClosed") : stack1),{"name":"if","hash":{},"fn":container.program(9, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":47,"column":0},"end":{"line":49,"column":7}}})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,lookupProperty(helpers,"eq").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"posts") : stack1),1,{"name":"eq","hash":{},"data":data,"loc":{"start":{"line":50,"column":6},"end":{"line":50,"column":25}}}),{"name":"if","hash":{},"fn":container.program(11, data, 0),"inverse":container.program(13, data, 0),"data":data,"loc":{"start":{"line":50,"column":0},"end":{"line":54,"column":7}}})) != null ? stack1 : "")
    + "</a>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"canEdit") : depth0),{"name":"if","hash":{},"fn":container.program(15, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":56,"column":0},"end":{"line":60,"column":7}}})) != null ? stack1 : "")
    + "</div>\n</div>\n<section class=\"discussion__content\">\n<div class=\"align\">\n<a class=\"spacing-right\" href=\"/by/"
    + alias2(alias3(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"author") : stack1)) != null ? lookupProperty(stack1,"username") : stack1), depth0))
    + "/\">\n<img class=\"img-avatar-md block__item\"\nsrc=\""
    + alias2(alias3(((stack1 = ((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"author") : stack1)) != null ? lookupProperty(stack1,"avatar") : stack1)) != null ? lookupProperty(stack1,"cache") : stack1), depth0))
    + "\" alt=\""
    + alias2(alias3(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"author") : stack1)) != null ? lookupProperty(stack1,"name") : stack1), depth0))
    + "\" />\n</a>\n<div class=\"discussion__byline\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"author") : stack1)) != null ? lookupProperty(stack1,"isPowerContributor") : stack1),{"name":"if","hash":{},"fn":container.program(17, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":70,"column":0},"end":{"line":77,"column":9}}})) != null ? stack1 : "")
    + "<a href=\"/by/"
    + alias2(alias3(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"author") : stack1)) != null ? lookupProperty(stack1,"username") : stack1), depth0))
    + "/\">\n<strong>"
    + alias2(alias3(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"author") : stack1)) != null ? lookupProperty(stack1,"name") : stack1), depth0))
    + "</strong>\n</a>\n<br>\n<a href=\"/by/"
    + alias2(alias3(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"author") : stack1)) != null ? lookupProperty(stack1,"username") : stack1), depth0))
    + "/\" class=\"link-gray-dark\">\n@"
    + alias2(alias3(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"author") : stack1)) != null ? lookupProperty(stack1,"username") : stack1), depth0))
    + "\n</a>\n<time class=\"bullet text-gray\">"
    + alias2(alias3((depth0 != null ? lookupProperty(depth0,"relativeTime") : depth0), depth0))
    + "</time>\n</div>\n</div>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"description") : depth0),{"name":"if","hash":{},"fn":container.program(19, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":88,"column":0},"end":{"line":92,"column":7}}})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"hasEmbedlyData") : depth0),{"name":"if","hash":{},"fn":container.program(21, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":93,"column":0},"end":{"line":117,"column":7}}})) != null ? stack1 : "")
    + "</section>\n<div class=\"visible-lg\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"discussionModerationActions"),depth0,{"name":"discussionModerationActions","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"threadPostActivity"),depth0,{"name":"threadPostActivity","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "<div data-role=\"follow-channel-prompt\"></div>\n</div>\n</div>\n<div class=\"layout__aside hidden-lg\">\n<div class=\"absolute__wrapper -aside\" data-role=\"right-module\">\n<div data-role=\"sign-up-module\"></div>\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"discussionModerationActions"),depth0,{"name":"discussionModerationActions","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "<div data-role=\"channel-info\" class=\"module--plain\" data-jester-area=\"channel_info\"></div>\n<div data-role=\"related-stories\" data-jester-area=\"related_sidebar\"></div>\n</div>\n</div>\n</div>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/templates/guidelines',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"padding-double\">\n<h4 class=\"text-larger\">"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"%(disqus)s Basic Rules",{"name":"gettext","hash":{"disqus":"Disqus"},"data":data,"loc":{"start":{"line":2,"column":24},"end":{"line":2,"column":78}}}))
    + "</h4>\n<div class=\"spacing-inner -medium spacing-top text-medium\">"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"homeRules"),depth0,{"name":"homeRules","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/UserGeneratedDiscussionCoverView',[
    'underscore',

    'core/mixins/withRichMedia',
    'core/WindowBus',
    'core/UniqueModel',

    'home/mixins/withAllstarPopover',
    'home/mixins/withChannelAvatar',
    'core/mixins/withChannelFollowing',
    'home/mixins/withThreadSharing',

    'home/models/UserProfile',

    'home/views/RelatedDiscussionsModuleView',
    'home/views/common/DiscussionCoverBaseView',
    'home/views/DiscussionPageChannelInfoView',
    'home/views/FollowChannelPromptView',
    'home/templates/userGeneratedDiscussionCover',
    'home/templates/guidelines',
    'home/utils/confirmModal',
], function (
    _,

    withRichMedia,
    WindowBus,
    UniqueModel,

    withAllstarPopover,
    withChannelAvatar,
    withChannelFollowing,
    withThreadSharing,

    UserProfile,

    RelatedDiscussionsModuleView,
    DiscussionCoverBaseView,
    DiscussionPageChannelInfoView,
    FollowChannelPromptView,
    userGeneratedDiscussionCoverTemplate,
    guidelinesTemplate,
    confirmModal
) {
    'use strict';

    var parent = DiscussionCoverBaseView;
    var parentProto = DiscussionCoverBaseView.prototype;

    /**
     * View that displays channel info on top of the discussion page
     *
     * View expects to be backed by a DiscussionViewModel and the router instance in options.app
     */
    var UserGeneratedDiscussionCoverView = parent.extend({
        template: userGeneratedDiscussionCoverTemplate,
        templateHelpers: function () {
            var existing = parentProto.templateHelpers.apply(this, arguments);
            var thread = this.model.thread;
            var embedlyData = thread.get('content');
            var isGlobalAdmin = this.session.user.get('isGlobalAdmin');
            var canEdit = thread.get('canEdit');
            var canModerate = thread.get('canModerate');
            var isSpam = thread.get('isSpam');

            return _.defaults({
                description: thread.getFullDescription(),
                hasEmbedlyData: embedlyData.title || embedlyData.description || embedlyData.image.url,
                embedlyLink: thread.getLinks()[0],
                canEdit: canEdit,
                isGlobalAdmin: isGlobalAdmin,
                showSharePrompt: thread.get('isNew') &&
                    thread.author && thread.author.isSessionUser(),
                canModerate: canModerate,
                isSpam: isSpam,
                showSpamAlert: isSpam && canModerate,
            }, existing);
        },

        regions: _.defaults({
            followChannelPromptRegion: '[data-role=follow-channel-prompt]',
            channelInfoRegion: '[data-role=channel-info]',
            relatedStoriesRegion: '[data-role=related-stories]',
        }, parentProto.regions),

        events: _.defaults({
            'click [data-action=delete-thread]': 'deleteThread',
            'click [data-action=close-thread]': 'closeThread',
            'click [data-action=open-thread]': 'openThread',
            'click [data-action=mark-spam]': 'toggleIsSpam',
            'click [data-action=show-guidelines]': 'showGuidelines',
            'click [data-action=moderation-dropdown]': 'toggleDropdown',
            'click [data-action=blacklist-forum]': 'blacklistAuthorOnForum',
            'click [data-action=blacklist-global]': 'toggleBlacklistAuthorGlobally',
        }, parentProto.events),

        initialize: function (options) {
            parentProto.initialize.call(this, options);

            // Ensure computations for values that will be used in this view
            this.model.thread.getModeratePermissions(this.session);
            this.model.thread.getEditPermissions(this.session);

            this.listenTo(this.model.thread, {
                'change:isClosed change:isDeleted change:canEdit change:canModerate': this.render,
                'change:isSpam': this.updateSpamIndicators,
            });

            if (this.model.thread.author) {
                this.bindToAuthor();
            } else {
                this.model.thread.fetchAuthor().then(_.bind(function () {
                    this.bindToAuthor();
                    this.render();
                }, this));
            }

            var windowBus = new WindowBus();

            // posts.create messages comes directly from the embed when a user makes a comment
            this.listenTo(windowBus, 'posts.create', this.showFollowChannelPromptView);

            this.updateSpamIndicators();
        },

        updateSpamIndicators: function () {
            this.$('[data-role=spam-alert]').toggleClass('is-spam', this.model.thread.get('isSpam'));
        },

        bindToAuthor: function () {
            this.listenTo(this.model.thread.author, 'change', this.render);
        },

        onRender: function () {
            parentProto.onRender.call(this);

            var media = this.model.thread.getMedia();
            if (media && media.length)
                this.renderRichMedia(media);

            this.activateRegion(this.channelInfoRegion, _.partial(this.createChannelInfoView, this.model.channel));
            this.activateRegion(this.relatedStoriesRegion, this.createRelatedLinksView);
        },

        createRelatedLinksView: function () {
            return new RelatedDiscussionsModuleView({
                collection: this.model.coverRelatedCollection,
                className: 'module--plain',
                model: this.model.thread,
            });
        },

        /*
         * Show user a prompt to follow the channel, when the user makes a comment if:
         *   - comment is a top level comment (no parent)
         *   - comment is on a thread from this channel
         *   - follow prompt has not been shown to the user yet (view uses the withExpiration mixin)
         */
        showFollowChannelPromptView: function (postData) {
            if (
                this.model.channel && this.model.channel.primaryForum &&
                !postData.parent && postData.forum === this.model.channel.primaryForum.get('id')
            ) {
                this.activateRegion(this.followChannelPromptRegion, _.partial(
                    this.createFollowChannelPromptView, this.model.channel
                ));
            }
        },

        createChannelInfoView: function (channel) {
            return new DiscussionPageChannelInfoView({
                model: channel,
                app: this.app,
                session: this.session,
            });
        },

        createFollowChannelPromptView: function (channel) {
            return new FollowChannelPromptView({
                model: channel,
            });
        },

        blacklistAuthorOnForum: function () {
            // We need to build a full `UserProfile` here because it listens for blacklist events on the `User`
            // model so it can do additional work such as kill their discussions. `User` doesn't have all the
            // information available to do this work alone.
            this.getAuthorProfile().user.confirmBlacklist({
                forum: this.model.thread.forum.id,
                notes: 'Added via discussion page',
                retroactive: true,
            });
        },

        toggleBlacklistAuthorGlobally: function () {
            var userProfile = this.getAuthorProfile();
            var user = userProfile.user;

            if (user.get('isOnGlobalBlacklist'))
                user.removeFromBlacklist();
            else
                user.confirmBlacklist({ notes: 'Added via discussion page', retroactive: true });
        },

        toggleIsSpam: function () {
            this.model.thread.toggleIsSpam();
        },

        getAuthorProfile: function () {
            return new UniqueModel(UserProfile, this.model.thread.author.attributes);
        },

        deleteThread: function () {
            this.model.thread.confirmDelete();
        },

        closeThread: function () {
            this.model.thread.close();
        },

        openThread: function () {
            this.model.thread.open();
        },

        showGuidelines: function () {
            confirmModal.confirmationPromise(confirmModal.TYPES.CLOSE,
                guidelinesTemplate(this.model.thread.forum.channel.toJSON()));
        },

        toggleDropdown: function () {
            var $navItem = this.$('.nav-dropdown__item');
            $navItem.toggleClass('dropdown-open');
        },
    });

    withAllstarPopover.call(UserGeneratedDiscussionCoverView.prototype);

    withRichMedia.call(UserGeneratedDiscussionCoverView.prototype);
    withChannelFollowing.call(UserGeneratedDiscussionCoverView.prototype, function () {
        return this.model.channel;
    });
    withChannelAvatar.call(UserGeneratedDiscussionCoverView.prototype, function () {
        return this.model.channel;
    });
    withThreadSharing.call(UserGeneratedDiscussionCoverView.prototype);

    return UserGeneratedDiscussionCoverView;
});

define('home/utils/embed',[
    'home/models/Session',
], function (
    Session
) {
    'use strict';

    // Called via embed callback, configured in template
    // that loads embed
    var onEmbedComment = function () {
        var user = Session.get().user;
        user.set({
            numPosts: user.get('numPosts') + 1,
        });
    };

    var onEmbedLoaded = function () {};

    return {
        onEmbedComment: onEmbedComment,
        onEmbedLoaded: onEmbedLoaded,
    };
});

define('home/templates/embedContainer',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    return "<div class=\"story-thread\" id=\"disqus_thread\" data-role=\"embed\"></div>\n";
},"useData":true})

});
define('home/views/EmbedContainerView',[
    'jquery',
    'underscore',
    'backbone-marionette',

    'core/switches',
    'core/utils/url/serialize',
    'core/WindowBus',

    'home/utils/embed',

    'home/templates/embedContainer',
    'home/mixins/withAllstarPopover',
], function (
    $,
    _,
    Marionette,

    switches,
    serialize,
    WindowBus,

    embedUtils,

    embedContainerTemplate,
    withAllstarPopover
) {
    'use strict';

    var windowBus = new WindowBus();

    function getServerSideConfig(thread) {
        var forumId = thread.forum.get('pk');
        var experiment = 'network_default';
        var variant = 'fallthrough';
        var service = 'dynamic';

        return {
            forum_id: forumId,
            forum: {
                id: forumId,
            },
            bin: ['embed', 'promoted_discovery', service, experiment, variant].join(':'),
            experiment: experiment,
            service: service,
            variant: variant,
        };
    }

    function disqusConfig(thread, sortOrder) {
        this.disable_ads = true;
        this.forum = thread.forum.id;
        this.page.slug = thread.get('slug');
        this.page.title = thread.get('title');
        this.page.url = thread.get('link');
        this.experiment.force_auto_styles = true;
        this.experiment.enable_scroll_container = true;
        if (sortOrder) {
            this.experiment.sort_order = sortOrder;
        }
        this.callbacks.onNewComment.push(embedUtils.onEmbedComment);
        this.server_side = getServerSideConfig(thread);

        this.callbacks.onReady = [function (_data, frame) {
            // Scroll has an offset of 90px to give some breathing room
            // between the Embed frame and the Home navbar
            if (window.document.location.hash === '#disqus_thread') {
                window.scrollTo(0, $(frame.elem).offset().top - 90);
            }
        }];
    }


    var EmbedContainerView = Marionette.ItemView.extend({
        template: embedContainerTemplate,

        initialize: function (options) {
            this.sortOrder = options && options.sortOrder;

            // posts.create messages comes directly from the embed when a user makes a comment
            this.listenTo(windowBus, 'click:allstar', this.showAllstarModal);
        },

        onShow: function () {
            // Thread must be fetched before loading the embed.
            // This prevents issues where the embed will be reset multiple times when
            // a discussion page is loaded directly, as well as issues where some of
            // the config settings are not accurate.
            if (!this.model.id) {
                return;
            }

            window.DISQUS.reset({
                reload: true,
                config: _.partial(disqusConfig, this.model, this.sortOrder),
            });
        },
    });

    withAllstarPopover.call(EmbedContainerView.prototype);

    return EmbedContainerView;
});


define('home/views/LoungeView',[
    'backbone-marionette',
], function (
    Marionette
) {
    'use strict';

    var parent = Marionette.ItemView;

    return parent.extend({
        template: function () {
            return 'hello world';
        },
    });
});

define('home/templates/deletedThreadError',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"empty-message\">\n<img src=\""
    + alias2(lookupProperty(helpers,"urlfor").call(alias1,"cdn",{"name":"urlfor","hash":{},"data":data,"loc":{"start":{"line":2,"column":10},"end":{"line":2,"column":26}}}))
    + "/img/Pam_Error.png\" class=\"img-responsive\" />\n<h2>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Darn it!",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":3,"column":4},"end":{"line":3,"column":26}}}))
    + "</h2>\n<div class=\"text-small\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"This discussion could not be found.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":5,"column":0},"end":{"line":5,"column":49}}}))
    + "\n</div>\n<div class=\"text-small\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Please visit %(discussDisqus)s to learn more.",{"name":"gettext","hash":{"discussDisqus":lookupProperty(helpers,"tag").call(alias1,"a",{"name":"tag","hash":{"text":"Discuss Disqus","href":"//disqus.com/home/channel/discussdisqus/"},"data":data,"loc":{"start":{"line":9,"column":16},"end":{"line":10,"column":22}}})},"data":data,"loc":{"start":{"line":8,"column":0},"end":{"line":10,"column":24}}}))
    + "\n</div>\n</div>\n";
},"useData":true})

});
define('home/templates/discussionPage',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"discussion-page\">\n<section data-role=\"discussion-cover\"></section>\n<div class=\"section-contained\">\n<div class=\"layout -top-flush layout--tablet-no-aside\">\n<div class=\"layout__main-with-aside\">\n<div class=\"layout__content -centered\">\n<section class=\"discussion__comments\" id=\"discussion-comments\"></section>\n<div class=\"spacing-bottom spacing-top\">\n<button data-action=\"scroll-top\" class=\"button button-outline -border-muted button-padding-taller button-wide text-medium\">\n<span class=\"icon-arrow-up icon-tiny spacing-right-small\"></span>"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Back to Top",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":10,"column":65},"end":{"line":10,"column":90}}}))
    + "\n</button>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n";
},"useData":true})

});
define('home/views/DiscussionPageView',[
    'jquery',
    'underscore',

    'core/bus',
    'core/utils/storage',

    'home/utils/backboneUtils',
    'home/views/common/TabbedView',
    'home/views/NetworkDiscussionCoverView',
    'home/views/UserGeneratedDiscussionCoverView',
    'home/views/EmbedContainerView',
    'home/views/LoungeView',
    'home/views/FetchingView',

    'home/templates/deletedThreadError',
    'home/templates/discussionPage',

    'home/mixins/withClickLinkTracking',
], function (
    $,
    _,

    bus,
    storage,

    backboneUtils,
    TabbedView,
    NetworkDiscussionCoverView,
    UserGeneratedDiscussionCoverView,
    EmbedContainerView,
    LoungeView,
    FetchingView,

    deletedThreadErrorTemplate,
    discussionPageTemplate,

    withClickLinkTracking
) {
    'use strict';

    var parent = TabbedView;
    var parentProto = parent.prototype;

    /**
     * A page for reading a thread, either a network thread or a user-generated thread.
     * View expects to be backed by a DiscussionViewModel and the router instance in options.app.
     */
    var DiscussionPageView = parent.extend({
        defaultTab: function () {
            var userDefault = storage.get('disqus.sort');
            var defaultTab;

            if (userDefault) {
                defaultTab = _.findKey(DiscussionPageView.TAB_SORTS, function (val) {
                    return val === userDefault;
                });
            }

            return defaultTab || 'best';
        },

        saveDefaultTab: function (activeTab) {
            storage.set(
                'disqus.sort',
                DiscussionPageView.TAB_SORTS[activeTab] || DiscussionPageView.TAB_SORTS.best
            );
        },

        template: function (data) {
            return data.thread.isDeleted ? deletedThreadErrorTemplate(data) : discussionPageTemplate(data);
        },

        regions: _.defaults({
            cover: '[data-role=discussion-cover]',
            contentRegion: '#discussion-comments',
            relatedRegion: '[data-role=related]',
        }, parentProto.regions),

        initialize: function (options) {
            parentProto.initialize.call(this, options);

            this.app = options.app;

            this.listenToOnce(this.cover, 'show', function () {
                bus.trigger('showDiscussionCover', 'discussion');
            });

            this.listenTo(this, 'change:activeTab', this.saveDefaultTab);
            this.listenTo(this.model.thread, 'sync', this.render);

            this.noEmbed = options.noEmbed;
        },

        events: _.defaults({
            'click a[data-link-name]': 'trackClickLink',
            'click button[data-action=scroll-top]': 'scrollToTop',
        }, parentProto.events),

        onDomRefresh: function () {
            parentProto.onDomRefresh.call(this);

            this.showCover();
        },

        showCover: function () {
            // Until thread is fetched, we can't be sure if it user-generated or network.
            // Show a fetching view until we can determine which cover view to show.
            if (this.model.thread.shouldFetch()) {
                this.cover.show(new FetchingView());
                return;
            }

            var CoverView = this.model.thread.get('isUserGenerated') ?
                UserGeneratedDiscussionCoverView :
                NetworkDiscussionCoverView;

            var coverView = new CoverView({
                model: this.model,
                app: this.app,
            });

            // if cover re-renders, we need to show the correct tab as active
            coverView.listenTo(coverView, 'dom:refresh', _.bind(this.updateTabClasses, this));

            this.cover.show(coverView);
        },

        getPageTitle: function () {
            var thread = this.model.thread;
            return $.when(
                backboneUtils.getPromiseFor(thread, 'title'),
                backboneUtils.getPromiseFor(thread.forum, 'name')
            ).then(function (threadTitle, forumName) {
                return threadTitle + ' · ' + forumName;
            });
        },

        getMetaAttrs: function () {
            var thread = this.model.thread;
            return this.getPageTitle().then(function (pageTitle) {
                var image = thread.getUserGeneratedImage();
                return {
                    title: pageTitle,

                    // `mettags.set` method takes care of stripping and
                    // cleaning a chunk of HTML to turn it into a description.
                    description: thread.get('message'),
                    image: image && image.src,
                    type: 'article',
                };
            });
        },

        getChannelSlug: function () {
            var channel = this.model.channel;

            // If channel has already been fetched or id was given in the
            // url, can return immediately.
            if (channel)
                return channel.get('slug');

            // If the thread is fully fetched and there's no channel, this
            // is a network thread and doesn't have a channel. Return null.
            if (!this.model.thread.shouldFetch())
                return null;

            // Fetch the thread and check once that's done for the channel.
            var deferred = $.Deferred();
            this.model.thread.fetch().then(_.bind(function () {
                var channel = this.model.channel;
                deferred.resolve(channel ? channel.get('slug') : null);
            }, this));

            return deferred.promise();
        },

        getPageTrackingParams: function () {
            // Guaranteed to have forum id here from the url
            var params = {
                forum: this.model.thread.forum.id,
            };

            return $.when(this.getChannelSlug(), this.getPageTitle())
                .then(_.bind(function (channelSlug, pageTitle) {
                    if (channelSlug)
                        params.channel_slug = channelSlug;

                    if (pageTitle)
                        params.title = pageTitle;

                    // Channel discussion pages (with the channel in the url)
                    // fetch the author along with the thread. We can use that
                    // author info in tracking. Non-channel discussion pages
                    // for user generated threads will have the author created
                    // but not yet fetched at this point. Don't bother waiting,
                    // we don't link to such pages anyway (though they do work)
                    var author = this.model.thread.author;
                    var authorUsername = author && author.get('username');
                    if (authorUsername)
                        params.author = authorUsername;

                    return params;
                }, this));
        },

        getTrackingSection: function (activeTab) {
            return activeTab;
        },

        getTabView: function (activeTab) {
            var ContentView = this.noEmbed ? LoungeView : EmbedContainerView;
            var options = {
                model: this.model.thread,
                sortOrder: DiscussionPageView.TAB_SORTS[activeTab] || 'popular',
            };

            return new ContentView(options);
        },

        scrollToTop: function () {
            window.scrollTo(0, 0);
        },
    }, {
        TAB_SORTS: {
            'best': 'popular',
            'newest': 'desc',
            'oldest': 'asc',
        },
    });

    withClickLinkTracking.call(DiscussionPageView.prototype);

    return DiscussionPageView;
});

define('home/templates/welcome',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"spacing-bottom animate-fade-up-out\">\n<span class=\"button button-fill--green text-medium\">"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Email verified!",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":4,"column":52},"end":{"line":4,"column":81}}}))
    + "</span>\n</div>\n";
},"3":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div>\n<a class=\"text-small\" href=\"/home/\" data-action=\"complete-onboarding\">\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Skip",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":26,"column":0},"end":{"line":26,"column":18}}}))
    + "\n</a>\n</div>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"welcome__wrapper text-center padding-default\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"showVerifiedMessage") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":2,"column":0},"end":{"line":6,"column":7}}})) != null ? stack1 : "")
    + "<div class=\"padding-gutter\">\n<img class=\"img-responsive\" src=\""
    + alias2(lookupProperty(helpers,"urlfor").call(alias1,"cdn",{"name":"urlfor","hash":{},"data":data,"loc":{"start":{"line":8,"column":33},"end":{"line":8,"column":49}}}))
    + "/img/empty-states/discussions.png\">\n</div>\n<h1 class=\"text-largest text-gray-darker padding-default\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Welcome to %(disqus)s, %(name)s!",{"name":"gettext","hash":{"name":((stack1 = (depth0 != null ? lookupProperty(depth0,"user") : depth0)) != null ? lookupProperty(stack1,"name") : stack1),"disqus":"Disqus"},"data":data,"loc":{"start":{"line":11,"column":0},"end":{"line":13,"column":19}}}))
    + "</h1>\n<p class=\"padding-default text-large text-gray-dark\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Easily find %(greatdiscussions)s being started by people just like you in our channels.",{"name":"gettext","hash":{"greatdiscussions":lookupProperty(helpers,"tag").call(alias1,"strong",{"name":"tag","hash":{"text":lookupProperty(helpers,"gettext").call(alias1,"great discussions",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":16,"column":40},"end":{"line":16,"column":69}}})},"data":data,"loc":{"start":{"line":16,"column":19},"end":{"line":16,"column":70}}})},"data":data,"loc":{"start":{"line":15,"column":0},"end":{"line":16,"column":72}}}))
    + "\n</p>\n<div class=\"padding-default\">\n<a class=\"button button-fill--brand button-padding-wider text-large\" href=\"/home/explore/\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Let's go!",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":20,"column":0},"end":{"line":20,"column":23}}}))
    + "\n</a>\n</div>\n"
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"registeredThisWeek") : depth0),{"name":"unless","hash":{},"fn":container.program(3, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":23,"column":0},"end":{"line":29,"column":11}}})) != null ? stack1 : "")
    + "</div>\n";
},"useData":true})

});
define('home/views/WelcomeView',[
    'backbone-marionette',

    'core/utils/url/parseQueryString',

    'home/templates/welcome',
], function (
    Marionette,

    parseQueryString,

    welcomeTemplate
) {
    'use strict';

    return Marionette.ItemView.extend({
        template: welcomeTemplate,

        templateHelpers: function () {
            return {
                user: this.session.user.toJSON(),
                registeredThisWeek: this.session.user.registeredThisWeek(),
                showVerifiedMessage: this.showVerifiedMessage(),
            };
        },

        events: {
            'click [data-action=complete-onboarding]': 'completeOnboarding',
        },

        initialize: function (options) {
            this.session = options.session;
            this.listenTo(this.session, 'change:id', this.render);
        },

        showVerifiedMessage: function () {
            return Boolean(parseQueryString().email_verified);
        },

        getMetaAttrs: function () {
            return 'Welcome';
        },

        completeOnboarding: function () {
            this.session.user.setHomeOnboardComplete(true);
        },

    });
});

define('home/templates/channelCover',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"banner__wrapper\" data-role=\"banner\">\n<div class=\"grad-overlay\">\n<div class=\"section-contained\">\n<div class=\"channel-cover align align--middle align--between\">\n<div class=\"metadata-hidden\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"channelCoverLogo"),depth0,{"name":"channelCoverLogo","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n<div class=\"metadata-hidden visible-md spacing-left-small\">\n<button\nclass=\"button button-inverted -thick text-large feed-content\"\ntitle="
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Info",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":13,"column":6},"end":{"line":13,"column":24}}}))
    + "\ndata-action=\"show-metadata\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"About",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":15,"column":0},"end":{"line":15,"column":19}}}))
    + "\n</button>\n</div>\n<div class=\"metadata-visible\">\n<button\nclass=\"spacing-top-small link-inverted pull-left\"\ntitle="
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Feed",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":21,"column":6},"end":{"line":21,"column":24}}}))
    + "\ndata-action=\"hide-metadata\">\n<span class=\"icon icon-left-bracket text-large icon__position\"></span>\n</button>\n<h1 class=\"text-largest text-center\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"About this Channel",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":25,"column":37},"end":{"line":25,"column":69}}}))
    + "</h1>\n</div>\n</div>\n</div>\n</div>\n</div>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"unless").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"shouldFetch") : depth0),{"name":"unless","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":2,"column":0},"end":{"line":31,"column":11}}})) != null ? stack1 : "");
},"usePartial":true,"useData":true})

});
define('home/views/ChannelCoverView',[
    'backbone-marionette',

    'home/models/Session',

    'home/mixins/withChannelBanner',
    'home/templates/channelCover',
], function (
    Marionette,

    Session,

    withChannelBanner,
    channelCoverTemplate
) {
    'use strict';

    var ChannelCoverView = Marionette.ItemView.extend({
        template: channelCoverTemplate,
        templateHelpers: function () {
            return {
                shouldFetch: this.model.shouldFetch(),
            };
        },

        events: {
            'click [data-action=show-metadata]': 'showMetadata',
            'click [data-action=hide-metadata]': 'hideMetadata',
        },

        initialize: function () {
            this.session = Session.get();

            // Required if the session user is checked upon render, so that the
            // check(s) will occur properly after the session use is fetched
            this.listenTo(this.session, 'change:id', this.render);

            this.listenTo(this.model, 'changeRelated:primaryForum', this.render);
        },

        modelEvents: {
            'sync': 'render',
        },

        showMetadata: function () {
            this.trigger('showMetadata', true);
        },

        hideMetadata: function () {
            this.trigger('showMetadata', false);
        },
    });

    var proto = ChannelCoverView.prototype;
    withChannelBanner.call(proto);

    return ChannelCoverView;
});

define('home/templates/channelLeadingUser',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"spacing-right\">\n<span class=\"label--default\">"
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"displayIndex") : depth0), depth0))
    + "</span>\n</div>\n";
},"3":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"isModerator") : depth0),{"name":"if","hash":{},"fn":container.program(4, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":12,"column":0},"end":{"line":14,"column":7}}})) != null ? stack1 : "");
},"4":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<span class=\"label--default -inline\">"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Mod",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":13,"column":37},"end":{"line":13,"column":54}}}))
    + "</span>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"displayIndex") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":1,"column":0},"end":{"line":5,"column":7}}})) != null ? stack1 : "")
    + "<div class=\"avatar-sm__wrapper spacing-right-small\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"userAvatar"),depth0,{"name":"userAvatar","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n<div>\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"userName"),depth0,{"name":"userName","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"hideModBadge") : depth0),{"name":"unless","hash":{},"fn":container.program(3, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":11,"column":0},"end":{"line":15,"column":11}}})) != null ? stack1 : "")
    + "</div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/ChannelLeadingUserView',[
    'underscore',
    'backbone-marionette',

    'home/mixins/withChannelAvatar',
    'home/mixins/withAllstarPopover',
    'home/templates/channelLeadingUser',
], function (
    _,
    Marionette,

    withChannelAvatar,
    withAllstarPopover,
    channelLeadingUserTemplate
) {
    'use strict';

    /**
     * A view showing a user that is a channel leader or moderator.
     *
     * Expects to be given a User model, and the following options:
     * channel - the channel for which this user is a leader
     * index - the index of this user in the list of leaders
     * showIndex - whether or not to display the index
     * hideModBadge - whether or not to display the mod badge, if this
     *                user is a moderator
     */
    var ChannelLeadingUserView = Marionette.ItemView.extend({
        template: channelLeadingUserTemplate,
        tagName: 'li',
        className: 'leader-list__item align align--middle',

        templateHelpers: function () {
            var moderatedForums = this.model.get('moderatedForums') || [];
            var primaryForum = this.channel && this.channel.primaryForum;

            return {
                isModerator: primaryForum && _.contains(moderatedForums, primaryForum.id),
                displayIndex: this.showIndex && this.index + 1,
                hideModBadge: this.hideModBadge,
            };
        },

        modelEvents: {
            'change:moderatedForums': 'render',
        },

        initialize: function (options) {
            options = options || {};
            this.channel = options.channel;
            this.index = options.index;
            this.showIndex = options.showIndex;
            this.hideModBadge = options.hideModBadge;
        },
    });

    withChannelAvatar.call(ChannelLeadingUserView.prototype);
    withAllstarPopover.call(ChannelLeadingUserView.prototype);

    return ChannelLeadingUserView;
});

define('home/templates/channelLeadersEmpty',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"text-center text-gray padding-double\">"
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"message") : depth0), depth0))
    + "</div>\n";
},"useData":true})

});
define('home/views/ChannelLeadersEmptyView',[
    'backbone-marionette',

    'core/strings',

    'home/templates/channelLeadersEmpty',
], function (
    Marionette,

    strings,

    channelLeadersEmptyTemplate
) {
    'use strict';

    var gettext = strings.get;

    /**
     * The empty view for when one of the tabs in the ChannelLeadersModuleView
     * is empty.
     * Expects to be passed the type of leaders which is empty, either leaders
     * (top contributors) or mods (moderators).
     */
    var ChannelLeadersEmptyView = Marionette.ItemView.extend({
        template: channelLeadersEmptyTemplate,
        templateHelpers: function () {
            return {
                message: this.constructor.MESSAGES[this.type],
            };
        },

        initialize: function (options) {
            this.type = options.type;
        },
    }, {
        MESSAGES: {
            leaders: gettext('No top contributors yet'),
            mods: gettext('No moderators yet'),
        },
    });

    return ChannelLeadersEmptyView;
});

define('home/views/ChannelLeadersCollectionView',[
    'underscore',
    'backbone-marionette',

    'home/views/ChannelLeadingUserView',
    'home/views/ChannelLeadersEmptyView',
], function (
    _,
    Marionette,

    ChannelLeadingUserView,
    ChannelLeadersEmptyView
) {
    'use strict';

    /**
     * A view of a collection of users who are leaders (either top contributors or mods) for
     * a channel.
     *
     * Expects to be given a collection of users, a model that contains the channel for which
     * the users are leaders, the index after which items in the collection are collapsed,
     * and the type of leaders list represented (leaders or mods).
     */
    var ChannelLeadersCollectionView = Marionette.CollectionView.extend({
        itemView: ChannelLeadingUserView,
        emptyView: ChannelLeadersEmptyView,
        tagName: 'ul',
        className: 'leader-list',

        initialize: function (options) {
            this.collapsedSize = options.collapsedSize;
            this.type = options.type;
        },

        itemViewOptions: function (_item, index) {
            // emptyView expects to be passed the type
            if (this._showingEmptyView) {
                return {
                    type: this.type,
                };
            }

            // Used in className which is called without this as the context
            var collapsedSize = this.collapsedSize;

            return {
                channel: this.model.channel,
                index: index,
                showIndex: this.type === 'leaders',
                hideModBadge: this.type === 'mods',
                className: function () {
                    var existing = ChannelLeadingUserView.prototype.className;
                    if (_.isFunction(existing))
                        existing = existing.call(this);

                    var className = existing || '';

                    // Mark items beyond some threshold to be collapsible. These
                    // won't be shown when the module is collapsed and will be
                    // shown when the module is expanded.
                    if (index >= collapsedSize)
                        className += ' collapsible';

                    return className;
                },
            };
        },
    });

    return ChannelLeadersCollectionView;
});

define('home/templates/channelLeadersModule',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<ul class=\"nav-tabs -small\">\n<li data-action=\"switch-tab\" data-tab=\"leaders\">\n<a href=\"#\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Top Contributors",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":4,"column":0},"end":{"line":4,"column":30}}}))
    + "\n</a>\n</li>\n<li data-action=\"switch-tab\" data-tab=\"mods\">\n<a href=\"#\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Mods %(numberFollowing)s",{"name":"gettext","hash":{"numberFollowing":lookupProperty(helpers,"tag").call(alias1,"span",{"name":"tag","hash":{"text":(depth0 != null ? lookupProperty(depth0,"numMods") : depth0),"class":"nav-tab-stat--simple"},"data":data,"loc":{"start":{"line":9,"column":55},"end":{"line":9,"column":109}}})},"data":data,"loc":{"start":{"line":9,"column":0},"end":{"line":9,"column":111}}}))
    + "\n</a>\n</li>\n</ul>\n<div data-role=\"leaders-content-area\"></div>\n<div data-role=\"footer\" data-action=\"expand-module\" class=\"aside__expand text-small\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"See More",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":14,"column":85},"end":{"line":14,"column":107}}}))
    + "</div>\n";
},"useData":true})

});
define('home/views/ChannelLeadersModuleView',[
    'underscore',

    'home/views/common/TabbedView',
    'home/views/ChannelLeadersCollectionView',

    'home/templates/channelLeadersModule',
], function (
    _,

    TabbedView,
    ChannelLeadersCollectionView,

    channelLeadersModuleTemplate
) {
    'use strict';

    /**
     * The module view shown for a channel showing a list of top
     * contributors and/or mods for the channel.
     */
    var ChannelLeadersModuleView = TabbedView.extend({
        className: function () {
            return this.expanded ? '' : 'collapsed';
        },

        defaultTab: function () {
            if (this.model.moderators.items.length && !this.model.leaders.items.length)
                return 'mods';

            return 'leaders';
        },

        template: channelLeadersModuleTemplate,
        templateHelpers: function () {
            return {
                numMods: this.model.moderators.items.length,
            };
        },

        events: _.defaults({
            'click [data-action=expand-module]': 'expandModule',
        }, TabbedView.prototype.events),

        regions: _.defaults({
            // Overwrite content region selector from tabbed view since this module is
            // nested in another tabbed view and has a different content region selector
            // so as to not collide with another content region selector.
            contentRegion: '[data-role=leaders-content-area]',
        }, TabbedView.prototype.events),

        ui: {
            footer: '[data-role=footer]',
        },

        initialize: function (options) {
            TabbedView.prototype.initialize.call(this, _.extend({
                isModule: true,
            }, options));

            var boundRender = _.bind(this.render, this);
            this.model.ensureFetchedLeaders().then(boundRender);
            this.model.ensureFetchedModerators().then(boundRender);

            this.listenTo(this, 'change:activeTab render', this.updateFooter);
        },

        /**
         * Expands any collapsed items in this module across all tabs. Once the
         * module is expanded on either tab, it remains expanded.
         */
        expandModule: function () {
            this.expanded = true;
            this.$el.attr('class', this.className());
            this.updateFooter();
        },

        /**
         * Shows or hides the expand option in the footer depending on whether or not
         * the current tab contains enough items so that some are collapsed.
         */
        updateFooter: function () {
            var collection = this.getTabCollection(this.activeTab || _.result(this, 'defaultTab'));
            var shouldHideFooter = this.expanded || collection.length <= this.constructor.COLLAPSED_SIZE;
            this.ui.footer.toggleClass('hidden', shouldHideFooter);
        },

        /**
         * Returns the user collection from the backing model that should be shown
         * depending on which tab we're currently viewing.
         * @param  {string} activeTab - Which tab is being viewed, either leaders or mods
         * @returns {UserCollection}
         */
        getTabCollection: function (activeTab) {
            var contentName = this.constructor.TAB_CONTENT[activeTab];
            if (contentName)
                return this.model[contentName].items;
        },

        getTabView: function (activeTab) {
            var tabCollection = this.getTabCollection(activeTab);
            if (!tabCollection)
                return;

            return new ChannelLeadersCollectionView({
                collection: tabCollection,
                model: this.model,
                collapsedSize: this.constructor.COLLAPSED_SIZE,
                type: activeTab,
            });
        },
    }, {
        TAB_CONTENT: {
            leaders: 'leaders',
            mods: 'moderators',
        },

        COLLAPSED_SIZE: 5,
    });

    return ChannelLeadersModuleView;
});

define('home/templates/channelMetadata',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"spacing-right\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"channel") : depth0),{"name":"if","hash":{},"fn":container.program(2, data, 0),"inverse":container.program(7, data, 0),"data":data,"loc":{"start":{"line":8,"column":0},"end":{"line":16,"column":7}}})) != null ? stack1 : "")
    + "</div>\n";
},"2":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"channelAvatar") : depth0),{"name":"if","hash":{},"fn":container.program(3, data, 0),"inverse":container.program(5, data, 0),"data":data,"loc":{"start":{"line":9,"column":0},"end":{"line":13,"column":7}}})) != null ? stack1 : "");
},"3":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<img class=\"img-round-sm\" src=\""
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"channelAvatar") : depth0), depth0))
    + "\" alt=\""
    + ((stack1 = container.invokePartial(lookupProperty(partials,"forumName"),depth0,{"name":"forumName","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "\">\n";
},"5":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = container.invokePartial(lookupProperty(partials,"defaultChannelAvatar"),depth0,{"name":"defaultChannelAvatar","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "");
},"7":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<img src=\""
    + container.escapeExpression(container.lambda(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"channel") : depth0)) != null ? lookupProperty(stack1,"options") : stack1)) != null ? lookupProperty(stack1,"favicon") : stack1), depth0))
    + "\" class=\"img-round-sm\" />\n";
},"9":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<p class=\"spacing-narrow spacing-top\">\n<a href=\""
    + alias2(alias1(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"channel") : depth0)) != null ? lookupProperty(stack1,"options") : stack1)) != null ? lookupProperty(stack1,"aboutUrlPath") : stack1), depth0))
    + "\"\ndata-link-name=\"about\"\ndata-channel-slug=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"channel") : depth0)) != null ? lookupProperty(stack1,"slug") : stack1), depth0))
    + "\"\nclass=\"button button-outline button-wide\">\n\n"
    + alias2(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Community Guidelines",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":30,"column":0},"end":{"line":30,"column":34}}}))
    + "\n</a>\n</p>\n";
},"11":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"aside__wrap hidden\" data-role=\"leaders\"></div>\n<div class=\"aside__wrap\" data-role=\"guidelines-section\">\n<div class=\"aside__header -padded -border-bottom\">\n<h2>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Basic Rules",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":54,"column":4},"end":{"line":54,"column":29}}}))
    + "</h2>\n</div>\n<div class=\"padding-gutter\">\n<div class=\"guidelines\" data-role=\"guidelines\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"homeRules"),depth0,{"name":"homeRules","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n<a data-link-name=\"guidelines\"\nclass=\"curtain-truncate text-small\"\ndata-action=\"expand\" data-target=\"[data-role=guidelines]\"\nhref=\"#\"\ndata-channel-slug=\""
    + alias2(container.lambda(((stack1 = (depth0 != null ? lookupProperty(depth0,"channel") : depth0)) != null ? lookupProperty(stack1,"slug") : stack1), depth0))
    + "\">\n\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Show guidelines",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":66,"column":0},"end":{"line":66,"column":29}}}))
    + "\n<span class=\"icon__position -inline icon-arrow icon\"></span>\n</a>\n<a data-action=\"collapse\" data-target=\"[data-role=guidelines]\" class=\"hidden text-small\" href=\"#\">\n<span class=\"icon__position -inline icon-arrow-2 icon\"></span>\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Collapse guidelines",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":71,"column":0},"end":{"line":71,"column":33}}}))
    + "\n</a>\n</div>\n</div>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.lambda, alias3=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"metadata-wrapper\">\n<div data-role=\"sign-up-module\"></div>\n<div class=\"aside__wrap\">\n<div class=\"aside__header padding-gutter -border-bottom\">\n<div class=\"align align--middle\">\n"
    + ((stack1 = lookupProperty(helpers,"if_any").call(alias1,(depth0 != null ? lookupProperty(depth0,"channel") : depth0),((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"channel") : depth0)) != null ? lookupProperty(stack1,"options") : stack1)) != null ? lookupProperty(stack1,"favicon") : stack1),{"name":"if_any","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":6,"column":0},"end":{"line":18,"column":11}}})) != null ? stack1 : "")
    + "<h2 class=\"spacing-bottom-small truncate-line\">"
    + alias3(alias2(((stack1 = (depth0 != null ? lookupProperty(depth0,"channel") : depth0)) != null ? lookupProperty(stack1,"name") : stack1), depth0))
    + "</h2>\n</div>\n<p class=\"text-gray spacing-top-narrow \">\n"
    + alias3(alias2(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"channel") : depth0)) != null ? lookupProperty(stack1,"options") : stack1)) != null ? lookupProperty(stack1,"description") : stack1), depth0))
    + "\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"channel") : depth0)) != null ? lookupProperty(stack1,"options") : stack1)) != null ? lookupProperty(stack1,"aboutUrlPath") : stack1),{"name":"if","hash":{},"fn":container.program(9, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":23,"column":0},"end":{"line":33,"column":7}}})) != null ? stack1 : "")
    + "</p>\n</div>\n<div class=\"padding-gutter align align--middle\" data-role=\"stats\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"channelMetadataStats"),depth0,{"name":"channelMetadataStats","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n</div>\n<div class=\"aside__wrap\">\n<div class=\"aside__content padding-gutter text-center\">\n<p class=\"spacing-top-narrow\">"
    + alias3(lookupProperty(helpers,"gettext").call(alias1,"Have questions about channels?",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":42,"column":30},"end":{"line":42,"column":74}}}))
    + "</p>\n<p class=\"spacing-top-narrow\">\n<a href=\"https://help.disqus.com/customer/en/portal/articles/2458906-channel-help\" class=\"button button-outline button-wide\">\n"
    + alias3(lookupProperty(helpers,"gettext").call(alias1,"Channel Help",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":45,"column":0},"end":{"line":45,"column":26}}}))
    + "\n</a>\n</p>\n</div>\n</div>\n"
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"channel") : depth0)) != null ? lookupProperty(stack1,"options") : stack1)) != null ? lookupProperty(stack1,"isCurationOnlyChannel") : stack1),{"name":"unless","hash":{},"fn":container.program(11, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":50,"column":0},"end":{"line":75,"column":11}}})) != null ? stack1 : "")
    + "<div data-role=\"create-channel-module\"></div>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/ChannelMetadataView',[
    'underscore',
    'backbone-marionette',
    'handlebars',

    'core/strings',

    'home/views/ChannelLeadersModuleView',
    'home/mixins/withChannelAvatar',
    'core/mixins/withChannelFollowing',
    'home/mixins/withCollapsing',
    'home/mixins/withLoginOverlay',

    'home/templates/channelMetadata',
], function (
    _,
    Marionette,
    Handlebars,

    strings,

    ChannelLeadersModuleView,
    withChannelAvatar,
    withChannelFollowing,
    withCollapsing,
    withLoginOverlay,

    channelMetadataTemplate
) {
    'use strict';

    var gettext = strings.get;

    var ChannelMetadataView = Marionette.Layout.extend({
        regions: {
            leadersRegion: '[data-role=leaders]',
        },

        template: channelMetadataTemplate,
        templateHelpers: function () {
            var primaryForum = this.model.channel.primaryForum;
            var numThreads = primaryForum.get('numThreads');
            var numFollowers = primaryForum.get('numFollowers');
            return {
                // Attributes may be null during fetch
                numThreads: numThreads && numThreads.toLocaleString(),
                numFollowers: numFollowers && numFollowers.toLocaleString(),
            };
        },

        initialize: function () {
            this.listenTo(this.model.channel, 'sync', this.render);
            this.bindToPrimaryForum();
        },

        bindToPrimaryForum: function () {
            if (!this.model.channel.primaryForum) {
                this.listenToOnce(this.model.channel, 'changeRelated:primaryForum', this.bindToPrimaryForum);
                return;
            }

            // Only rerender stats area of the view when numbers change so that the leaders module won't rerender
            // and lose state (ex: expanded, active tab)
            this.listenTo(this.model.channel.primaryForum,
                'change:numFollowers change:numThreads',
                this.renderStats);
        },

        renderStats: function () {
            var data = this.serializeData();
            data = this.mixinTemplateHelpers(data);
            this.$('[data-role=stats]').html(Handlebars.partials.channelMetadataStats(data));
        },

        onDomRefresh: function () {
            var boundShowLeadersModule = _.bind(this.showLeadersModule, this);
            this.model.ensureFetchedLeaders().then(boundShowLeadersModule);
            this.model.ensureFetchedModerators().then(boundShowLeadersModule);
            this.leadersRegion.show(new ChannelLeadersModuleView({ model: this.model }));
        },

        // Experts section is hidden until at least 1 expert is added, so that the
        // labels and expand links don't show for empty expert lists
        showLeadersModule: function () {
            if (this.model.leaders.items.length || this.model.moderators.items.length)
                this.$('[data-role=leaders]').removeClass('hidden');
        },
    });

    withChannelFollowing.call(ChannelMetadataView.prototype, function () {
        return this.model.channel;
    });

    withChannelAvatar.call(ChannelMetadataView.prototype, function () {
        return this.model.channel;
    });

    withCollapsing.call(ChannelMetadataView.prototype, {
        maxHeight: 200, // px
        collapsibleSelector: '[data-role=guidelines-section]',
    });

    withLoginOverlay.call(ChannelMetadataView.prototype,
        strings.interpolate(
            gettext('Join %(disqus)s to start your own channel like this one.'),
            { disqus: 'Disqus' }
        ));

    return ChannelMetadataView;
});

define('home/collections/CategoryCollection',[
    'underscore',
    'backbone',

    'core/api',
    'core/UniqueModel',

    'home/activityExpander',
    'home/models/Channel',
], function (
    _,
    Backbone,

    api,
    UniqueModel,

    activityExpander,
    Channel
) {
    'use strict';

    var _instance;

    /**
     * A collection of Channel models marked as Categories.
     *
     * Implemented as a singleton, since there is only 1 categories
     * list. Should be accessed using get.
     */
    var CategoryCollection = Backbone.Collection.extend({
        url: api.getURL('channels/listCategories'),
        model: UniqueModel.boundModel(Channel),

        parse: function (response) {
            response = Backbone.Collection.prototype.parse.call(this, response.response);

            // Endpoints uses reference/objects mapping for channels, which are expanded using
            // activityExpander
            return _.map(response.items, function (listedChannel) {
                return activityExpander.buildChannel(response.objects, listedChannel.reference);
            });
        },
    }, {
        get: function () {
            if (!_instance) {
                _instance = new CategoryCollection();
                _instance.fetch();
            }

            return _instance;
        },
    });

    return CategoryCollection;
});

define('home/templates/channelCreateForm',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<input class=\"input--textbox\" name=\"name\" type=\"text\" "
    + ((stack1 = lookupProperty(helpers,"unless").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"sessionUserVerified") : depth0),{"name":"unless","hash":{},"fn":container.program(2, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":11,"column":54},"end":{"line":11,"column":105}}})) != null ? stack1 : "")
    + " />\n";
},"2":function(container,depth0,helpers,partials,data) {
    return " disabled";
},"4":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<h2 class=\"text-larger spacing-bottom-narrow text-gray-darker\">"
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"name") : depth0), depth0))
    + "</h2>\n";
},"6":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"The best names are short, descriptive, and memorable",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":19,"column":0},"end":{"line":19,"column":66}}}))
    + "\n";
},"8":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"This can't be changed",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":21,"column":0},"end":{"line":21,"column":35}}}))
    + "\n";
},"10":function(container,depth0,helpers,partials,data) {
    return "selected";
},"12":function(container,depth0,helpers,partials,data,blockParams,depths) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, alias3=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<option value=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"slug") : depth0), depth0))
    + "\" "
    + ((stack1 = lookupProperty(helpers,"if").call(alias3,lookupProperty(helpers,"eq").call(alias3,((stack1 = (depths[1] != null ? lookupProperty(depths[1],"primaryCategory") : depths[1])) != null ? lookupProperty(stack1,"id") : stack1),(depth0 != null ? lookupProperty(depth0,"id") : depth0),{"name":"eq","hash":{},"data":data,"loc":{"start":{"line":59,"column":31},"end":{"line":59,"column":60}}}),{"name":"if","hash":{},"fn":container.program(10, data, 0, blockParams, depths),"inverse":container.noop,"data":data,"loc":{"start":{"line":59,"column":25},"end":{"line":59,"column":77}}})) != null ? stack1 : "")
    + ">\n"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"name") : depth0), depth0))
    + "\n</option>\n";
},"14":function(container,depth0,helpers,partials,data,blockParams,depths) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, alias3=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<option value=\""
    + alias2(alias1((data && lookupProperty(data,"key")), depth0))
    + "\" "
    + ((stack1 = lookupProperty(helpers,"if").call(alias3,lookupProperty(helpers,"eq").call(alias3,(depths[1] != null ? lookupProperty(depths[1],"bannerColor") : depths[1]),(data && lookupProperty(data,"key")),{"name":"eq","hash":{},"data":data,"loc":{"start":{"line":91,"column":31},"end":{"line":91,"column":55}}}),{"name":"if","hash":{},"fn":container.program(10, data, 0, blockParams, depths),"inverse":container.noop,"data":data,"loc":{"start":{"line":91,"column":25},"end":{"line":91,"column":72}}})) != null ? stack1 : "")
    + ">\n"
    + alias2(alias1(depth0, depth0))
    + "\n</option>\n";
},"16":function(container,depth0,helpers,partials,data) {
    return "checked";
},"18":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"spacing-right-small\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"channelAvatarWithDefault"),depth0,{"name":"channelAvatarWithDefault","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n";
},"20":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Create Channel",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":204,"column":0},"end":{"line":204,"column":28}}}))
    + "\n";
},"22":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Update Channel",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":206,"column":0},"end":{"line":206,"column":28}}}))
    + "\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data,blockParams,depths) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<form data-role=\"channel-form\">\n<div class=\"card-wrap\">\n<div class=\"card__body\">\n<div class=\"spacing-bottom form-attribute-input\" data-attribute=\"name\">\n<div class=\"spacing-default\">\n<h3 class=\"text-gray-darker\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Name",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":7,"column":0},"end":{"line":7,"column":18}}}))
    + "\n</h3>\n<p class=\"spacing-narrow\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"isNew") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0, blockParams, depths),"inverse":container.program(4, data, 0, blockParams, depths),"data":data,"loc":{"start":{"line":10,"column":0},"end":{"line":14,"column":7}}})) != null ? stack1 : "")
    + "</p>\n<div data-role=\"attribute-error\" class=\"form-message-error spacing-narrow\"></div>\n<p class=\"text-gray spacing-bottom\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"isNew") : depth0),{"name":"if","hash":{},"fn":container.program(6, data, 0, blockParams, depths),"inverse":container.program(8, data, 0, blockParams, depths),"data":data,"loc":{"start":{"line":18,"column":0},"end":{"line":22,"column":7}}})) != null ? stack1 : "")
    + "</p>\n</div>\n</div>\n<div class=\"spacing-bottom form-attribute-input\" data-attribute=\"description\">\n<div class=\"spacing-default\">\n<h3 class=\"text-gray-darker\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Description",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":29,"column":0},"end":{"line":29,"column":25}}}))
    + "\n</h3>\n<p class=\"spacing-narrow\">\n<textarea class=\"input--textbox\" name=\"description\" type=\"text\" "
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"sessionUserVerified") : depth0),{"name":"unless","hash":{},"fn":container.program(2, data, 0, blockParams, depths),"inverse":container.noop,"data":data,"loc":{"start":{"line":32,"column":64},"end":{"line":32,"column":115}}})) != null ? stack1 : "")
    + ">"
    + alias2(container.lambda(((stack1 = (depth0 != null ? lookupProperty(depth0,"options") : depth0)) != null ? lookupProperty(stack1,"description") : stack1), depth0))
    + "</textarea>\n</p>\n<div data-role=\"attribute-error\" class=\"form-message-error spacing-narrow\"></div>\n<p class=\"text-gray spacing-bottom\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Describe what your channel will be discussing in a sentence or two",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":37,"column":36},"end":{"line":37,"column":116}}}))
    + "</p>\n</div>\n</div>\n<div class=\"spacing-bottom\">\n<div class=\"spacing-default\">\n<h3 class=\"text-gray-darker\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Category",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":43,"column":0},"end":{"line":43,"column":22}}}))
    + "\n</h3>\n<p class=\"text-gray spacing-bottom\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"To make it easy for others to find your channel",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":46,"column":0},"end":{"line":46,"column":61}}}))
    + "</p>\n</p>\n\n<span class=\"form-attribute-input\" data-attribute=\"primaryCategory\">\n<label class=\"align align--middle spacing-bottom-narrow\">\n<div class=\"align align---middle\">\n<div class=\"spacing-right-small spacing-top-small\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Category (required)",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":53,"column":0},"end":{"line":53,"column":33}}}))
    + "\n</div>\n<div class=\"spacing-left-small\">\n<select class=\"input--select\" name=\"primary-category\" "
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"sessionUserVerified") : depth0),{"name":"unless","hash":{},"fn":container.program(2, data, 0, blockParams, depths),"inverse":container.noop,"data":data,"loc":{"start":{"line":56,"column":54},"end":{"line":56,"column":105}}})) != null ? stack1 : "")
    + ">\n<option value=\"\" "
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"primaryCategory") : depth0),{"name":"unless","hash":{},"fn":container.program(10, data, 0, blockParams, depths),"inverse":container.noop,"data":data,"loc":{"start":{"line":57,"column":17},"end":{"line":57,"column":63}}})) != null ? stack1 : "")
    + "></option>\n"
    + ((stack1 = lookupProperty(helpers,"each").call(alias1,(depth0 != null ? lookupProperty(depth0,"categories") : depth0),{"name":"each","hash":{},"fn":container.program(12, data, 0, blockParams, depths),"inverse":container.noop,"data":data,"loc":{"start":{"line":58,"column":0},"end":{"line":62,"column":9}}})) != null ? stack1 : "")
    + "</select>\n</div>\n</div>\n</label>\n<div data-role=\"attribute-error\" class=\"form-message-error spacing-narrow\"></div>\n<p class=\"text-gray spacing-bottom\"></p>\n</span>\n</div>\n</div>\n\n<hr>\n\n<div class=\"spacing-bottom form-attribute-input\" data-attribute=\"bannerColor\">\n<div class=\"spacing-default\">\n<h3 class=\"text-gray-darker\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Channel Color",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":78,"column":0},"end":{"line":78,"column":27}}}))
    + "\n</h3>\n<p class=\"text-gray spacing-bottom\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Shown in default banner and avatar",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":81,"column":0},"end":{"line":81,"column":48}}}))
    + "</p>\n</p>\n<label class=\"align align--middle spacing-bottom-narrow\">\n<div class=\"align align---middle\">\n<div class=\"spacing-right-small spacing-top-small\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Color",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":86,"column":0},"end":{"line":86,"column":19}}}))
    + "\n</div>\n<div class=\"spacing-left-small\">\n<select class=\"input--select\" name=\"bannerColor\" "
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"sessionUserVerified") : depth0),{"name":"unless","hash":{},"fn":container.program(2, data, 0, blockParams, depths),"inverse":container.noop,"data":data,"loc":{"start":{"line":89,"column":49},"end":{"line":89,"column":100}}})) != null ? stack1 : "")
    + ">\n"
    + ((stack1 = lookupProperty(helpers,"each").call(alias1,(depth0 != null ? lookupProperty(depth0,"bannerColors") : depth0),{"name":"each","hash":{},"fn":container.program(14, data, 0, blockParams, depths),"inverse":container.noop,"data":data,"loc":{"start":{"line":90,"column":0},"end":{"line":94,"column":9}}})) != null ? stack1 : "")
    + "</select>\n</div>\n</div>\n</label>\n<div data-role=\"attribute-error\" class=\"form-message-error spacing-narrow\"></div>\n<p class=\"text-gray spacing-bottom\"></p>\n</div>\n</div>\n\n<hr>\n\n<div class=\"spacing-bottom\">\n<div class=\"spacing-default\">\n<h3 class=\"text-gray-darker\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Banner Background",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":109,"column":0},"end":{"line":109,"column":31}}}))
    + "\n</h3>\n<p class=\"text-gray spacing-bottom\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"What's shown above",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":112,"column":0},"end":{"line":112,"column":32}}}))
    + "</p>\n</p>\n<label class=\"align align--middle spacing-bottom-narrow\">\n<div class=\"spacing-right\">\n<input type=\"radio\" name=\"banner-type\" value=\"color\" checked>\n</div>\n<div class=\"align align--middle\">\n<div class=\"spacing-right-small\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Use Channel Color",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":120,"column":0},"end":{"line":120,"column":31}}}))
    + "\n</div>\n</div>\n</label>\n<label class=\"align spacing-bottom-small\">\n<div class=\"spacing-right\">\n<input type=\"radio\" name=\"banner-type\" value=\"file\" "
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"banner") : depth0),{"name":"if","hash":{},"fn":container.program(16, data, 0, blockParams, depths),"inverse":container.noop,"data":data,"loc":{"start":{"line":126,"column":52},"end":{"line":126,"column":80}}})) != null ? stack1 : "")
    + ">\n</div>\n<div>\n<div class=\"align align--middle spacing-bottom-small\">\n<div class=\"spacing-right-small\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Custom Image",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":131,"column":0},"end":{"line":131,"column":26}}}))
    + "\n</div>\n<div class=\"spacing-left-small\">\n<input type=\"file\" name=\"banner-image\" data-role=\"banner-image-file-upload\">\n</div>\n</div>\n<p class=\"text-small text-gray\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"For the best results: 1600 x 220 pixels. May be cropped otherwise.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":137,"column":32},"end":{"line":137,"column":112}}}))
    + "</p>\n</div>\n</label>\n<div data-role=\"attribute-error\" class=\"form-message-error spacing-narrow\"></div>\n<p class=\"text-gray spacing-bottom\"></p>\n</div>\n</div>\n<hr>\n<div class=\"spacing-bottom form-attribute-input\" data-attribute=\"avatar\">\n<div class=\"spacing-default\">\n<h3 class=\"text-gray-darker\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Avatar",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":148,"column":0},"end":{"line":148,"column":20}}}))
    + "\n</h3>\n<p class=\"text-gray spacing-bottom\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Used when listing your channel",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":151,"column":0},"end":{"line":151,"column":44}}}))
    + "</p>\n</p>\n<label class=\"align align--middle spacing-bottom-narrow\">\n<div class=\"spacing-right\">\n<input type=\"radio\" name=\"avatarType\" value=\"default\" checked>\n</div>\n<div class=\"align align--middle\">\n<div class=\"spacing-right-small\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Default",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":159,"column":0},"end":{"line":159,"column":21}}}))
    + "\n</div>\n<div class=\"spacing-left-small\" data-role=\"default-avatar\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"defaultChannelAvatar"),depth0,{"name":"defaultChannelAvatar","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n</div>\n</label>\n<label class=\"align spacing-bottom-small\">\n<div class=\"spacing-right\">\n<input type=\"radio\" name=\"avatarType\" value=\"file\" "
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"channelAvatar") : depth0),{"name":"if","hash":{},"fn":container.program(16, data, 0, blockParams, depths),"inverse":container.noop,"data":data,"loc":{"start":{"line":168,"column":51},"end":{"line":168,"column":86}}})) != null ? stack1 : "")
    + ">\n</div>\n<div>\n<div class=\"align align--middle spacing-bottom-small\">\n<div class=\"spacing-right-small\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Custom Image",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":173,"column":0},"end":{"line":173,"column":26}}}))
    + "\n</div>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"channelAvatar") : depth0),{"name":"if","hash":{},"fn":container.program(18, data, 0, blockParams, depths),"inverse":container.noop,"data":data,"loc":{"start":{"line":175,"column":0},"end":{"line":179,"column":7}}})) != null ? stack1 : "")
    + "<div class=\"spacing-left-small\">\n<input type=\"file\" name=\"avatar\" data-role=\"avatar-file-upload\">\n</div>\n</div>\n<p class=\"text-small text-gray\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"For the best results: 200 x 200 pixels",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":184,"column":32},"end":{"line":184,"column":84}}}))
    + "</p>\n</div>\n</label>\n<div data-role=\"attribute-error\" class=\"form-message-error spacing-narrow\"></div>\n<p class=\"text-gray spacing-bottom\"></p>\n</div>\n</div>\n</div>\n</div>\n<div class=\"align align--between spacing-bottom\">\n<div></div>\n<div class=\"align-max-mobile\">\n<div class=\"discussion-form__loading\">\n<div class=\"spinner-small\"></div>\n</div>\n<button type=\"button\" data-action=\"cancel-create\" class=\"button text-medium\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Cancel",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":200,"column":0},"end":{"line":200,"column":20}}}))
    + "\n</button>\n<button type=\"submit\" data-role=\"channel-form-button\" class=\"button button-fill--brand button--discussion-form text-medium\""
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"sessionUserVerified") : depth0),{"name":"unless","hash":{},"fn":container.program(2, data, 0, blockParams, depths),"inverse":container.noop,"data":data,"loc":{"start":{"line":202,"column":123},"end":{"line":202,"column":174}}})) != null ? stack1 : "")
    + ">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"isNew") : depth0),{"name":"if","hash":{},"fn":container.program(20, data, 0, blockParams, depths),"inverse":container.program(22, data, 0, blockParams, depths),"data":data,"loc":{"start":{"line":203,"column":0},"end":{"line":207,"column":7}}})) != null ? stack1 : "")
    + "</button>\n</div>\n</div>\n</form>\n";
},"usePartial":true,"useData":true,"useDepths":true})

});
define('home/templates/channelCreateError',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"modal-header\">\n<h4 class=\"modal-title\">"
    + alias1(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Uh oh, we weren't able to create your channel",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":2,"column":24},"end":{"line":2,"column":83}}}))
    + "</h4>\n</div>\n<div class=\"modal-body\">\n<p>"
    + alias1(container.lambda(((stack1 = (depth0 != null ? lookupProperty(depth0,"responseJSON") : depth0)) != null ? lookupProperty(stack1,"response") : stack1), depth0))
    + "</p>\n</div>\n";
},"useData":true})

});
define('home/views/ChannelCreateFormView',[
    'underscore',
    'backbone-marionette',
    'handlebars',

    'core/UniqueModel',

    'home/models/Channel',
    'home/collections/CategoryCollection',
    'home/mixins/withChannelAvatar',
    'home/templates/channelCreateForm',
    'home/templates/channelCreateError',
    'home/utils/confirmModal',
], function (
    _,
    Marionette,
    Handlebars,

    UniqueModel,

    Channel,
    CategoryCollection,
    withChannelAvatar,
    channelCreateFormTemplate,
    channelCreateErrorTemplate,
    confirmModal
) {
    'use strict';

    /**
     * A view that contains a form for creating a channel.
     *
     * @param {Object} options - {
     *                               model: new instance of a channel model,
     *                               session: current session
     *                           }
     */
    var ChannelCreateFormView = Marionette.ItemView.extend({
        template: channelCreateFormTemplate,

        templateHelpers: function () {
            return {
                // only logged in verified users can create channels
                sessionUserVerified: this.session.user.get('isVerified'),
                bannerColors: Channel.BANNER_COLORS,
                categories: this.categories.toJSON(),
                isNew: this.isNew,
            };
        },

        events: {
            'submit': 'submitChannel',
            'keyup input[name=name]': 'handleNameKeyup',
            'change select[name=bannerColor]': 'updateBanner',
            'change input[name=banner-type]': 'updateBanner',
            'click input[name=banner-type][value=file]': 'handleBannerTypeFileClick',
            'change input[name=banner-image]': 'handleBannerImageChange',
            'click input[name=avatarType]': 'handleAvatarTypeFileClick',
            'change input[name=avatar]': 'handleAvatarImageChanage',
            'change select[name=primary-category]': 'handlePrimaryCategoryChange',
            'click [data-action=cancel-create]': 'navigateBack',
        },

        ui: {
            name: '[name=name]',
            bannerColor: '[name=bannerColor]',
            description: '[name=description]',
            avatar: '[name=avatar]',
            bannerImage: '[name=banner-image]',
            defaultAvatar: '[data-role=default-avatar]',
            form: '[data-role=channel-form]',
            buttons: '[data-role=channel-form-button]',
            primaryCategory: '[name=primary-category]',
        },

        initialize: function (options) {
            // Used if user cancels changes
            this.modelBackup = _.clone(this.model.attributes);

            this.session = options.session;
            this.categories = CategoryCollection.get();
            this.isNew = this.model.isNew();
            this.listenTo(this.model, 'invalid', this.handleValidationError);
            this.listenTo(this.model, 'change:bannerColor change:name', this.updateDefaultAvatar);
            this.listenTo(this.categories, 'sync add remove', this.render);
        },

        onClose: function () {
            this.cancelChanges();
        },

        updateDefaultAvatar: function () {
            var name = this.model.get('name') || '';
            var bannerColor = this.model.get('bannerColor');

            this.ui.defaultAvatar.html(Handlebars.partials.defaultChannelAvatar({
                bannerColorClass: bannerColor && ('-' + bannerColor),
                channelInitial: name.charAt(0),
            }));
        },

        /**
         * Returns the model attributes for the Category with the given slug.
         * At this point, the category models should exist and be fetched,
         * because the CategoryCollection was fetched during initialization.
         *
         * @param {string} slug - The slug for the category to return
         * @returns {Object} - Attributes for the specified category
         */
        getCategoryAttrs: function (slug) {
            if (slug)
                return new UniqueModel(Channel, { slug: slug }).attributes;
        },

        submitChannel: function (evt) {
            evt.preventDefault();

            // hide all displayed errors
            this.$('.form-attribute-input').removeClass('is-error');

            this.disableForm();

            var messageName = this.isNew ? 'created' : 'updated';

            var data = {
                name: this.isNew ? this.ui.name.val() : this.model.get('name'),
                bannerColor: this.ui.bannerColor.val(),
                description: this.ui.description.val(),

                // To update the related category models on the channel, update the
                // attribute, which change will trigger the channel model to update
                // the related category models. The attribute expects a plain object
                // value like it would receive from the server, not a Backbone Model.
                //
                // To clear out an existing related category, pass null, not undefined.
                // This is so that a change event will occur on the attribute, which
                // should previously have been undefined, since the category details
                // are stored in the related models, not in attributes.
                primaryCategory: this.getCategoryAttrs(this.ui.primaryCategory.val()) || null,
            };

            var avatarType = this.$('[name=avatarType]:checked').val();

            if (avatarType === 'file') {
                var avatarImageFile = this.getAvatarImageFile();
                if (avatarImageFile)
                    data.avatar = avatarImageFile;
            }

            var bannerType = this.getBannerType();
            var bannerImageFile = bannerType === 'file' && this.getBannerImageFile();
            if (bannerImageFile)
                data.banner = bannerImageFile;

            this.model.save(data, {
                avatarType: avatarType,
                bannerType: bannerType,
                success: _.bind(this.handleSaveSuccess, this, messageName),
                error: _.bind(this.handleSaveError, this),
            });
        },

        handleSaveSuccess: function (messageName, model) {
            this.modelBackup = _.clone(this.model.attributes);
            this.enableForm();
            this.trigger(messageName, model);
        },

        handleNameKeyup: function () {
            var channelName = this.ui.name.val().trim();
            this.model.set('name', channelName);
        },

        getBannerType: function () {
            return this.$('[name=banner-type]:checked').val();
        },

        getBannerImageFile: function () {
            return this.ui.bannerImage[0].files[0];
        },

        getAvatarImageFile: function () {
            return this.ui.avatar[0].files[0];
        },

        bannerImageExists: function () {
            return Boolean(this.getBannerImageFile() ||
                this.model.get('banner') ||
                this.modelBackup.banner ||

                // Legacy support
                this.model.get('options').alertBackground ||
                this.modelBackup.options.alertBackground);
        },

        avatarImageExists: function () {
            return Boolean(this.getAvatarImageFile() ||
                this.model.get('avatar') ||
                this.modelBackup.avatar ||

                // Legacy support
                this.model.get('options').favicon ||
                this.modelBackup.options.favicon);
        },

        /**
         * Called when user tries to select the banner image radio button.
         * If there's no file previously chosen, brings up the file chooser
         * and prevents the radio button from being selected. This is done to
         * prevent the invalid state where the image radio button is selected
         * but there's no file chosen.
         *
         * @returns {boolean} - Returns false if user action is invalid to prevent
         *                      the UI change.
         */
        handleBannerTypeFileClick: function () {
            if (!this.bannerImageExists()) {
                this.ui.bannerImage.click();
                return false;
            }

            this.updateBanner();
        },

        /**
         * Called when user tries to select the avatar image radio button.
         * If there's no file previously chosen, brings up the file chooser
         * and prevents the raiod button from being selected. This is done to
         * prevent the invalid state where the image radio button is selected
         * but there's no file chosen.
         *
         * @returns {boolean} - Returns false if user action is invalid to prevent
         *                      the UI change.
         */
        handleAvatarTypeFileClick: function () {
            if (!this.avatarImageExists()) {
                this.ui.avatar.click();
                return false;
            }
        },

        /**
         * Called when a banner image file is selected. Automatically selects the
         * correct banner type radio button depending on if a file was chosen or
         * not, to prevent the invalid state of having the file radio button selected
         * with no file chosen.
         */
        handleBannerImageChange: function () {
            var shouldSelectFileRadio = Boolean(this.bannerImageExists());
            this.$('input[name=banner-type][value=file]').prop('checked', shouldSelectFileRadio);
            this.$('input[name=banner-type][value=color]').prop('checked', !shouldSelectFileRadio);
            this.updateBanner();
        },

        /**
         * Called when an avatar image file is selected. Automatically selects the
         * correct avatar type radio button depending on if a file was chosen or not,
         * to prevent the invalid state of having the file radio button selected with
         * no file chosen.
         */
        handleAvatarImageChanage: function () {
            var shouldSelectFileRadio = Boolean(this.avatarImageExists());
            this.$('input[name=avatarType][value=file]').prop('checked', shouldSelectFileRadio);
            this.$('input[name=avatarType][value=default]').prop('checked', !shouldSelectFileRadio);
        },

        /**
         * Rerenders the banner to show either the channel color or the image placeholder,
         * depending on which type is selected.
         */
        updateBanner: function () {
            // If user selected banner type file, show a preview.
            var bannerImage;
            if (this.getBannerType() === 'file') {
                // If user hasn't selected a new banner image, they may have a previously uploaded banner image.
                // Get it from the backup attrs that haven't been mutated, in case the user cleared out the
                // previous image on the current model.
                bannerImage = this.getBannerImageFile() ||
                    this.modelBackup.banner ||
                    this.modelBackup.options.alertBackground;
            }

            this.model.set({
                bannerColor: this.ui.bannerColor.val(),
                banner: bannerImage,
            });
        },

        cancelChanges: function () {
            // Revert all the changes made during editing
            this.model.set(this.modelBackup);
        },

        navigateBack: function () {
            this.cancelChanges();
            window.history.back();
        },

        handleValidationError: function (_model, errs) {
            this.enableForm();

            _.each(errs, function (err) {
                this.$('.form-attribute-input[data-attribute*=' + err.attrName + ']')
                    .addClass('is-error')
                    .find('[data-role=attribute-error]')
                    .text(err.message);
            }, this);
        },

        handleSaveError: function (_channel, response) {
            this.enableForm();

            confirmModal.confirmationPromise(
                confirmModal.TYPES.CLOSE,
                channelCreateErrorTemplate(response)
            );
        },

        enableForm: function () {
            this.ui.form.removeClass('is-submitting');
            this.ui.buttons.removeAttr('disabled');
        },

        disableForm: function () {
            this.ui.form.addClass('is-submitting');
            this.ui.buttons.attr('disabled', 'disabled');
        },

    });

    withChannelAvatar.call(ChannelCreateFormView.prototype);

    return ChannelCreateFormView;
});

define('home/templates/channelDiscussionFeed',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.escapeExpression, alias2=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card-wrap -padded\">\n<a href=\"/home/discuss/"
    + alias1(container.lambda(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"channel") : depth0)) != null ? lookupProperty(stack1,"primaryForum") : stack1)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + "/\" class=\"button button-padding-taller button-wide\">\n<div class=\"align align--between align--middle\">\n<div class=\"align__item\">\n<span class=\"icon-create-discussion text-small icon__position -inline\"></span>\n"
    + alias1(lookupProperty(helpers,"gettext").call(alias2,"What do you want to discuss?",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":7,"column":0},"end":{"line":7,"column":42}}}))
    + "\n</div>\n<div class=\"align__item\">\n<button class=\"button button-outline text-medium\">"
    + alias1(lookupProperty(helpers,"gettext").call(alias2,"Discuss",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":10,"column":50},"end":{"line":10,"column":71}}}))
    + "</button>\n</div>\n</div>\n</a>\n</div>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"unless").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"channel") : depth0)) != null ? lookupProperty(stack1,"options") : stack1)) != null ? lookupProperty(stack1,"isCurationOnlyChannel") : stack1),{"name":"unless","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":1,"column":0},"end":{"line":15,"column":11}}})) != null ? stack1 : "")
    + "<div data-role=\"content-area\"></div>\n<div data-role=\"footer-area\"></div>\n";
},"useData":true})

});
define('home/views/ChannelDiscussionFeedView',[
    'home/views/common/FetchableCollectionLayout',
    'home/templates/channelDiscussionFeed',
], function (
    FetchableCollectionLayout,
    channelDiscussionFeedTemplate
) {
    'use strict';

    /**
     * The view shown in the tab area of a channel page. Should be used only
     * for discussion feed tabs, as it shows a prompt above the feed prompting the
     * user to begin a discussion.
     */
    var ChannelDiscussionFeedView = FetchableCollectionLayout.extend({
        template: channelDiscussionFeedTemplate,
        templateHelpers: function () {
            return {
                channel: this.channel.toJSON(),
            };
        },

        initialize: function (options) {
            FetchableCollectionLayout.prototype.initialize.call(this, options);
            this.channel = options.channel;
        },
    });

    return ChannelDiscussionFeedView;
});

define('home/templates/channelTopicTab',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<span class=\"button--tag -inverted button-large\">"
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"topicName") : depth0), depth0))
    + "</span>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"alert alert--topics\">\n<div class=\"align align--between\">\n<div class=\"align align--wrap align--middle\">\n<div class=\"spacing-right\">\n<strong>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Channel Topic",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":5,"column":8},"end":{"line":5,"column":35}}}))
    + ":</strong>\n</div>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"topicName") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":7,"column":0},"end":{"line":9,"column":7}}})) != null ? stack1 : "")
    + "</div>\n\n<a href=\"/home/channel/"
    + alias2(container.lambda(((stack1 = (depth0 != null ? lookupProperty(depth0,"channel") : depth0)) != null ? lookupProperty(stack1,"slug") : stack1), depth0))
    + "/\" class=\"link-green-dark\" title=\""
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Remove Filter",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":12,"column":73},"end":{"line":12,"column":100}}}))
    + "\">\n<span class=\"icon-cancel icon-tiny\"></span>\n</a>\n</div>\n</div>\n<div data-role=\"header-area\"></div>\n<div data-role='content-area'></div>\n<div data-role='footer-area'></div>\n";
},"useData":true})

});
define('home/views/ChannelTopicTabView',[
    'home/views/common/FetchableCollectionLayout',
    'home/templates/channelTopicTab',
], function (
    FetchableCollectionLayout,
    channelTopicTabTemplate
) {
    'use strict';

    /**
     * The view shown in the topic-filtered feed area of a channel page.
     * Includes a header that shows the topic on which the feed is filtered.
     */
    var ChannelTopicTabView = FetchableCollectionLayout.extend({
        template: channelTopicTabTemplate,
        templateHelpers: function () {
            return {
                topicName: this.filteredTopic.get('displayName'),
                channel: this.channel.toJSON(),
            };
        },

        initialize: function (options) {
            FetchableCollectionLayout.prototype.initialize.call(this, options);
            this.channel = options.channel;
            this.filteredTopic = options.filteredTopic;
            this.listenTo(this.filteredTopic, 'change:displayName', this.render);
        },
    });

    return ChannelTopicTabView;
});

define('home/templates/channelModeratorUser',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<span class=\"label--default -inline\">"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Creator",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":6,"column":37},"end":{"line":6,"column":58}}}))
    + "</span>\n";
},"3":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"user-card__button\">\n<button class=\"button button-outline button-small\" data-action=\"remove-moderator\">\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Remove",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":12,"column":0},"end":{"line":12,"column":20}}}))
    + "\n</button>\n</div>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card--user\">\n<div class=\"user-card__block\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"userAvatar"),depth0,{"name":"userAvatar","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + ((stack1 = container.invokePartial(lookupProperty(partials,"userName"),depth0,{"name":"userName","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"isChannelOwner") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":5,"column":0},"end":{"line":7,"column":7}}})) != null ? stack1 : "")
    + "</div>\n"
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"isChannelOwner") : depth0),{"name":"unless","hash":{},"fn":container.program(3, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":9,"column":0},"end":{"line":15,"column":11}}})) != null ? stack1 : "")
    + "</div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/ChannelModeratorUserView',[
    'backbone-marionette',

    'home/templates/channelModeratorUser',
], function (
    Marionette,

    channelModeratorUserTemplate
) {
    'use strict';

    /**
     * Shows a single channel moderator card. Shows a creator badge if user
     * is the channel creator, but not a mod badge since the item is assumed
     * to appear in a list where every user is a moderator.
     *
     * Expects a User model and a Channel given as an option.
     */
    var ChannelModeratorUserView = Marionette.ItemView.extend({
        className: 'card',

        template: channelModeratorUserTemplate,
        templateHelpers: function () {
            return {
                isChannelOwner: this.isChannelOwner,
            };
        },

        initialize: function (options) {
            this.channel = options.channel;
            var ownerId = this.channel.get('owner_id');
            this.isChannelOwner = ownerId === this.model.get('id');
        },

        events: {
            'click [data-action=remove-moderator]': 'removeModerator',
        },

        /**
         * Removes the backing User as a moderator on the given Channel.
         * Does not handle backend errors, since user should not be able to
         * kick off this api call unless requirements are already satisfied
         */
        removeModerator: function () {
            this.model.moderateChannel(this.channel, false);
        },
    });

    return ChannelModeratorUserView;
});

define('home/templates/channelModeratorForm',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<form data-role=\"channel-moderator-form\">\n<div class=\"form-attribute-input\" data-attribute=\"username\">\n<div class=\"align spacing-bottom\">\n<div class=\"align__item--grow spacing-right\">\n<input class=\"input--textbox\" name=\"username\" type=\"text\"\nplaceholder=\""
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Add a new moderator by username",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":6,"column":13},"end":{"line":6,"column":58}}}))
    + "\" >\n</div>\n<button type=\"submit\" class=\"button button-outline button-small\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Add",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":9,"column":0},"end":{"line":9,"column":17}}}))
    + "\n</button>\n</div>\n<p data-role=\"attribute-error\" class=\"form-message-error spacing-bottom-narrow text-semibold text-small\"></p>\n</div>\n<p data-role=\"subtext\" class=\"spacing-narrow text-gray text-small\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"People you add will receive a notification that they're now a moderator of this channel.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":15,"column":0},"end":{"line":15,"column":102}}}))
    + "\n</p>\n</form>\n";
},"useData":true})

});
define('home/views/ChannelModeratorFormView',[
    'underscore',
    'backbone-marionette',

    'core/strings',
    'core/UniqueModel',

    'home/models/User',
    'home/templates/channelModeratorForm',
], function (
    _,
    Marionette,

    strings,
    UniqueModel,

    User,
    channelModeratorFormTemplate
) {
    'use strict';

    var gettext = strings.get;

    /**
     * A form for adding a new moderator to a channel.
     *
     * Expects a ChannelProfile model.
     */
    var ChannelModeratorFormView = Marionette.ItemView.extend({
        template: channelModeratorFormTemplate,

        ui: {
            'username': 'input[name=username]',
            'form': 'form[data-role=channel-moderator-form]',
            'submit': 'button[type=submit]',
        },

        events: {
            'submit': 'addModerator',
            'blur input[name=username]': 'clearValidationErrors',
        },

        addModerator: function (evt) {
            if (evt)
                evt.preventDefault();

            var username = this.ui.username.val();
            var user = new UniqueModel(
                User,
                {
                    username: username,
                }
            );

            var validationError = this.model.validateNewModerator(user);
            if (validationError) {
                this.handleValidationError(this.model, validationError);
                return;
            }

            this.disableForm();

            user.moderateChannel(this.model.channel, true)
                .always(_.bind(this.enableForm, this))

                // Only clear input on success so that if there was an error
                // the user can adjust their input
                .done(_.bind(this.clearForm, this))

                .fail(_.bind(this.handleSaveError, this));
        },

        handleSaveError: function (response) {
            // Try to handle all the known error responses with proper translated messages.
            // Fall back to showing the untranslated backend error if given an unknown error.
            var responseMessage = response.responseJSON.response;
            if (/User matching query does not exist/.test(responseMessage))
                responseMessage = gettext('No user exists with that username');
            else if (/(?:You must be authenticated)|(?:You do not have admin privileges)/.test(responseMessage))
                responseMessage = gettext('You do not have permission to add moderators to this channel');

            this.handleValidationError(this.model, {
                attrName: 'username',
                message: responseMessage,
            });
        },

        /**
         * @type ValidationError
         * @property {string} attrName The attribute name that failed validation
         * @property {string} message The validation error message
         */

        /**
         * Displays the given errors on inputs designated for the attributes
         * related to the errors.
         * @param {Model} model Not used. Passed by Backbone's `invalid` event.
         * @param {ValidationError|ValidationError[]} errs An error object or array of error
         *                                                 objects with keys attrName and message.
         */
        handleValidationError: function (_model, errs) {
            if (!_.isArray(errs))
                errs = [errs];

            _.each(errs, function (err) {
                this.$('.form-attribute-input[data-attribute*=' + err.attrName + ']')
                    .addClass('is-error')
                    .find('[data-role=attribute-error]')
                    .text(err.message);
            }, this);
        },

        clearValidationErrors: function () {
            this.$('.form-attribute-input.is-error').removeClass('is-error');
        },

        clearForm: function () {
            this.ui.username.val('');
        },

        enableForm: function () {
            this.ui.form.removeClass('is-submitting');
            this.ui.submit.removeAttr('disabled');
        },

        disableForm: function () {
            this.ui.form.addClass('is-submitting');
            this.ui.submit.attr('disabled', 'disabled');
        },
    });

    return ChannelModeratorFormView;
});

define('home/templates/channelModerators',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"padding-default\">\n<div class=\"spacing-default\">\n<h1 class=\"text-larger text-gray-darker spacing-bottom-narrow\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Moderators",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":3,"column":63},"end":{"line":3,"column":87}}}))
    + "</h1>\n<p class=\"text-gray\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Add moderators to help manage your channel. Moderators can mark discussions and comments as spam, as well as ban unwanted users.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":4,"column":21},"end":{"line":4,"column":163}}}))
    + "</p>\n</div>\n</div>\n<section data-role=\"moderators\" class=\"channel-mod__list\"></section>\n<div class=\"padding-default\">\n<section data-role=\"moderator-form\" class=\"spacing-default\"></section>\n</div>\n";
},"useData":true})

});
define('home/views/ChannelModeratorsView',[
    'backbone-marionette',

    'home/views/ChannelModeratorUserView',
    'home/views/ChannelModeratorFormView',

    'home/mixins/withSubviews',
    'home/templates/channelModerators',
], function (
    Marionette,

    ChannelModeratorUserView,
    ChannelModeratorFormView,

    withSubviews,
    channelModeratorsTemplate
) {
    'use strict';

    var ChannelModeratorsView = Marionette.ItemView.extend({
        template: channelModeratorsTemplate,
        className: 'card-wrap',

        regions: {
            moderatorsRegion: '[data-role=moderators]',
            moderatorFormRegion: '[data-role=moderator-form]',
        },

        onRender: function () {
            this.activateRegion(this.moderatorsRegion, this.createModeratorsView);
            this.activateRegion(this.moderatorFormRegion, this.createModeratorFormView);
        },

        createModeratorsView: function () {
            return new Marionette.CollectionView({
                itemView: ChannelModeratorUserView,
                itemViewOptions: {
                    channel: this.model.channel,
                },
                collection: this.model.moderators.items,
            });
        },

        createModeratorFormView: function () {
            return new ChannelModeratorFormView({
                model: this.model,
            });
        },
    });

    withSubviews.call(ChannelModeratorsView.prototype);

    return ChannelModeratorsView;
});

define('home/templates/channelProfile',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<li data-action=\"switch-tab\" data-tab=\"recent\" class=\"nav__item\">\n<a href=\"/home/channel/"
    + alias1(container.lambda(((stack1 = (depth0 != null ? lookupProperty(depth0,"channel") : depth0)) != null ? lookupProperty(stack1,"slug") : stack1), depth0))
    + "/recent/\" data-action=\"hide-metadata\" class=\"nav-lnk -color-muted\">\n<div class=\"nav-lnk__blk\">\n<span class=\"nav-lnk__icon icon icon-discussions\"></span>\n<span class=\"button__text\">"
    + alias1(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Latest",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":30,"column":27},"end":{"line":30,"column":47}}}))
    + "</span>\n</div>\n<div class=\"nav-lnk__pointer\">\n<span class=\"icon icon-right-bracket\"></span>\n</div>\n</a>\n</li>\n";
},"3":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, alias3=container.lambda, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<section data-role=\"admin-nav\" class=\"hidden-lg\">\n<div class=\"aside__subheadings\">\n<h2 class=\"text-subheading\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Channel settings",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":44,"column":28},"end":{"line":44,"column":58}}}))
    + "</h2>\n</div>\n<ul class=\"nav--aside\">\n<li class=\"nav__item\" data-action=\"switch-tab\" data-tab=\"basics\">\n<a href=\"/home/channel/"
    + alias2(alias3(((stack1 = (depth0 != null ? lookupProperty(depth0,"channel") : depth0)) != null ? lookupProperty(stack1,"slug") : stack1), depth0))
    + "/basics/\" data-action=\"hide-metadata\" class=\"nav-lnk -color-muted\">\n<div class=\"nav-lnk__blk\">\n<span class=\"button__text\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Basics",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":50,"column":27},"end":{"line":50,"column":47}}}))
    + "</span>\n</div>\n<div class=\"nav-lnk__pointer\">\n<span class=\"icon icon-right-bracket\"></span>\n</div>\n</a>\n</li>\n<li class=\"nav__item\" data-action=\"switch-tab\" data-tab=\"moderators\">\n<a href=\"/home/channel/"
    + alias2(alias3(((stack1 = (depth0 != null ? lookupProperty(depth0,"channel") : depth0)) != null ? lookupProperty(stack1,"slug") : stack1), depth0))
    + "/moderators/\" class=\"nav-lnk -color-muted\">\n<div class=\"nav-lnk__blk\">\n<span class=\"button__text\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Moderators",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":60,"column":27},"end":{"line":60,"column":51}}}))
    + "</span>\n</div>\n<div class=\"nav-lnk__pointer\">\n<span class=\"icon icon-right-bracket\"></span>\n</div>\n</a>\n</li>\n</ul>\n</section>\n";
},"5":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, alias3=container.lambda, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<section data-role=\"admin-nav\" class=\"hidden-lg\">\n<div class=\"aside__subheadings\">\n<h2 class=\"text-subheading\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Admin links",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":73,"column":28},"end":{"line":73,"column":53}}}))
    + "</h2>\n</div>\n<ul class=\"nav--aside\">\n<li class=\"nav__item\">\n<a href=\"//"
    + alias2(alias3(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"channel") : depth0)) != null ? lookupProperty(stack1,"primaryForum") : stack1)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + ".disqus.com/admin/moderate/\" class=\"nav-lnk -color-muted\" target=\"_blank\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Moderate",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":78,"column":0},"end":{"line":78,"column":22}}}))
    + "\n</a>\n</li>\n<li class=\"nav__item\">\n<a href=\"//"
    + alias2(alias3(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"channel") : depth0)) != null ? lookupProperty(stack1,"primaryForum") : stack1)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + ".disqus.com/admin/access/banned/\" class=\"nav-lnk -color-muted\" target=\"_blank\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Banned users",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":83,"column":0},"end":{"line":83,"column":26}}}))
    + "\n</a>\n</li>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"isDisqusAdmin") : depth0),{"name":"if","hash":{},"fn":container.program(6, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":86,"column":0},"end":{"line":92,"column":7}}})) != null ? stack1 : "")
    + "</ul>\n</section>\n";
},"6":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<li class=\"nav__item\">\n<a href=\"//"
    + alias1(container.lambda(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"channel") : depth0)) != null ? lookupProperty(stack1,"primaryForum") : stack1)) != null ? lookupProperty(stack1,"id") : stack1), depth0))
    + ".disqus.com/admin/analytics/\" class=\"nav-lnk -color-muted\" target=\"_blank\">\n"
    + alias1(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Analytics",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":89,"column":0},"end":{"line":89,"column":23}}}))
    + "\n</a>\n</li>\n";
},"8":function(container,depth0,helpers,partials,data,blockParams,depths) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"hidden-lg\">\n<div class=\"aside__subheadings text-subheading\">\n<h2>\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(alias1,"Channel topics",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":101,"column":0},"end":{"line":101,"column":28}}}))
    + "\n</h2>\n</div>\n<div class=\"aside__wrap\">\n<ul class=\"tag-list\">\n"
    + ((stack1 = lookupProperty(helpers,"each").call(alias1,(depth0 != null ? lookupProperty(depth0,"trendingTopics") : depth0),{"name":"each","hash":{},"fn":container.program(9, data, 0, blockParams, depths),"inverse":container.noop,"data":data,"loc":{"start":{"line":106,"column":0},"end":{"line":112,"column":9}}})) != null ? stack1 : "")
    + "</ul>\n</div>\n</div>\n";
},"9":function(container,depth0,helpers,partials,data,blockParams,depths) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<li data-action=\"switch-tab\" data-tab=\"topic-"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"identifier") : depth0), depth0))
    + "\">\n<a href=\"/home/channel/"
    + alias2(alias1(((stack1 = (depths[1] != null ? lookupProperty(depths[1],"channel") : depths[1])) != null ? lookupProperty(stack1,"slug") : stack1), depth0))
    + "/topics/"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"identifier") : depth0), depth0))
    + "\" class=\"button--tag\">\n"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"displayName") : depth0), depth0))
    + "\n</a>\n</li>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data,blockParams,depths) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<header data-role=\"cover\"></header>\n<div class=\"nav-wrapper feed-content\" id=\"content-area\">\n</div>\n<div class=\"section-contained\">\n<div class=\"layout\">\n<div class=\"layout__main-with-aside\">\n<nav class=\"layout__nav\">\n<section data-role=\"default-nav\">\n<div class=\"aside__subheadings hidden-lg\">\n<h2 class=\"text-subheading\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Discussions",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":11,"column":28},"end":{"line":11,"column":53}}}))
    + "</h2>\n</div>\n<ul class=\"nav--aside\">\n<li data-action=\"switch-tab\" data-tab=\"top\" class=\"nav__item\">\n<a href=\"/home/channel/"
    + alias2(container.lambda(((stack1 = (depth0 != null ? lookupProperty(depth0,"channel") : depth0)) != null ? lookupProperty(stack1,"slug") : stack1), depth0))
    + "/top/\" class=\"nav-lnk -color-muted\">\n<div class=\"nav-lnk__blk\">\n<span class=\"nav-lnk__icon icon icon-popular\"></span>\n<span class=\"button__text\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Recommended",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":18,"column":27},"end":{"line":18,"column":52}}}))
    + "</span>\n</div>\n<div class=\"nav-lnk__pointer\">\n<span class=\"icon icon-right-bracket\"></span>\n</div>\n</a>\n</li>\n"
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"channel") : depth0)) != null ? lookupProperty(stack1,"options") : stack1)) != null ? lookupProperty(stack1,"isCurationOnlyChannel") : stack1),{"name":"unless","hash":{},"fn":container.program(1, data, 0, blockParams, depths),"inverse":container.noop,"data":data,"loc":{"start":{"line":25,"column":0},"end":{"line":37,"column":11}}})) != null ? stack1 : "")
    + "</ul>\n</section>\n\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"isSessionUserChannelOwner") : depth0),{"name":"if","hash":{},"fn":container.program(3, data, 0, blockParams, depths),"inverse":container.noop,"data":data,"loc":{"start":{"line":41,"column":0},"end":{"line":69,"column":7}}})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"isChannelModerator") : depth0),{"name":"if","hash":{},"fn":container.program(5, data, 0, blockParams, depths),"inverse":container.noop,"data":data,"loc":{"start":{"line":70,"column":0},"end":{"line":95,"column":7}}})) != null ? stack1 : "")
    + "\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"trendingTopics") : depth0),{"name":"if","hash":{},"fn":container.program(8, data, 0, blockParams, depths),"inverse":container.noop,"data":data,"loc":{"start":{"line":97,"column":0},"end":{"line":116,"column":7}}})) != null ? stack1 : "")
    + "</nav>\n<section class=\"layout__content feed-content\">\n<div data-role=\"email-verification-alert\"></div>\n<div data-role=\"content-area\"></div>\n</section>\n</div>\n<aside class=\"layout__aside metadata-content\" data-role=\"metadata\">\n</aside>\n</div>\n</div>\n";
},"useData":true,"useDepths":true})

});
define('home/views/ChannelProfileView',[
    'underscore',

    'core/utils/auth',

    'home/utils/backboneUtils',
    'home/utils/confirmModal',
    'home/utils/navigationUtils',

    'home/views/common/TabbedView',
    'home/views/ChannelCoverView',
    'home/views/ChannelMetadataView',
    'home/views/ChannelCardCollectionView',
    'home/views/ChannelCreateFormView',
    'home/views/common/FetchableCollectionLayout',
    'home/views/ChannelFeedFooterView',
    'home/views/UserCollectionView',
    'home/views/ChannelDiscussionFeedView',
    'home/views/ChannelTopicTabView',
    'home/views/ChannelModeratorsView',

    'home/templates/channelProfile',
    'home/templates/guidelines',
    'home/templates/spinnerTall',

    'core/UniqueModel',
    'home/models/Session',
    'home/models/Topic',

    'home/mixins/withClickLinkTracking',
    'home/mixins/withEmailVerificationAlert',

    'core/strings',
], function (
    _,

    auth,

    backboneUtils,
    confirmModal,
    navigationUtils,

    TabbedView,
    ChannelCoverView,
    ChannelMetadataView,
    ChannelCardCollectionView,
    ChannelCreateFormView,
    FetchableCollectionLayout,
    ChannelFeedFooterView,
    UserCollectionView,
    ChannelDiscussionFeedView,
    ChannelTopicTabView,
    ChannelModeratorsView,

    channelProfileTemplate,
    guidelinesTemplate,
    spinnerTallTemplate,

    UniqueModel,
    Session,
    Topic,

    withClickLinkTracking,
    withEmailVerificationAlert,

    strings
) {
    'use strict';

    var gettext = strings.get;

    var ChannelProfileView = TabbedView.extend({
        className: 'channel-profile',

        defaultTab: function () {
            return 'top';
        },

        // If the channel model is not yet fetched, show a spinner.
        // This is so that model-dependent parts of the page don't require the whole
        // page to re-render on model fetch, which would cause all the subviews to
        // re-render as well.
        template: function (data) {
            return data.channel.name ?
                channelProfileTemplate(data) :
                spinnerTallTemplate(data);
        },

        templateHelpers: function () {
            var isDisqusAdmin = auth.getFromCookie().staff;
            var isChannelModerator = isDisqusAdmin || this.model.moderators.items.contains(this.session.user);

            return {
                isDisqusAdmin: isDisqusAdmin,
                isChannelModerator: isChannelModerator,
                isSessionUserChannelOwner: this.isSessionUserChannelOwner(),
            };
        },

        regions: _.defaults({
            coverRegion: '[data-role=cover]',
            metadataRegion: '[data-role=metadata]',
        }, TabbedView.prototype.regions),

        initialize: function (options) {
            if (options && options.activeTab === 'guidelines') {
                // guidelines are shown in a modal, not a tab
                options.activeTab = _.result(this, 'defaultTab');
                this.listenToOnce(this, 'show', this.showGuidelines);
            }

            this.session = Session.get();

            TabbedView.prototype.initialize.apply(this, arguments);

            this.listenTo(this.model.channel, 'sync', this.render);
            this.listenTo(this.model.moderators, 'items:sync', this.render);

            if (this.model.trendingTopics)
                this.listenTo(this.model.trendingTopics, 'items:sync', this.render);

            // When the tab changes, update any sidebar modules that should be shown or hidden
            // depending on which tab is active.
            this.listenTo(this, 'change:activeTab', this.updateTabSpecificModules);
        },

        events: _.defaults({
            'click a[data-link-name]': 'trackClickLink',
            'click [data-action=show-guidelines]': 'showGuidelines',
            'click [data-action=hide-metadata]': 'hideMetadata',
        }, TabbedView.prototype.events),

        hideMetadata: function () {
            this.trigger('showMetadata', false);
        },

        showGuidelines: function () {
            var self = this;
            backboneUtils.getPromiseFor(this.model.channel, 'name').then(function () {
                var modalHtml = guidelinesTemplate(self.model.channel.toJSON());

                confirmModal.confirmationPromise(confirmModal.TYPES.CLOSE, modalHtml).always(function () {
                    navigationUtils.navigate('/home/channel/' + self.model.id + '/', { replace: true, silent: true });
                });
            });
        },

        onDomRefresh: function () {
            if (!this.$(this.coverRegion.el).length)
                // Page has not yet rendered regions, still fetching models
                return;

            var coverView = new ChannelCoverView({
                model: this.model.channel,
            });
            this.listenTo(coverView, 'showMetadata', this.showMetadata);
            this.coverRegion.show(coverView);

            this.metadataRegion.show(new ChannelMetadataView({
                model: this.model,
            }));

            TabbedView.prototype.onDomRefresh.apply(this, arguments);
        },

        updateTabSpecificModules: function (activeTab) {
            var isTopicTab = /^topic-.+/.test(activeTab);
            this.$('[data-role=default-nav]').toggleClass('hidden', isTopicTab);
        },

        showMetadata: function (shouldShowMetadata) {
            this.$el.toggleClass('metadata-view', shouldShowMetadata);
        },

        getTrackingSection: function (activeTab) {
            // Return the tab name for tracking
            return activeTab;
        },

        getTabView: function (activeTab) {
            var view;

            switch (activeTab) {
            case 'recent':
                return new ChannelDiscussionFeedView({
                    model: this.model.recentActivities,
                    collection: this.model.recentActivities.items,
                    fetchableCollectionView: ChannelCardCollectionView,
                    fetchableCollectionFooterView: ChannelFeedFooterView,
                    channel: this.model.channel,
                    isChannelFeed: true,
                    infiniteScroll: true,
                    filterVerbs: ['trending'],
                });
            case 'top':
                return new ChannelDiscussionFeedView({
                    model: this.model.topActivities,
                    collection: this.model.topActivities.items,
                    fetchableCollectionView: ChannelCardCollectionView,
                    fetchableCollectionFooterView: ChannelFeedFooterView,
                    channel: this.model.channel,
                    isChannelFeed: true,
                    infiniteScroll: true,
                });
            case 'followers':
                view = new FetchableCollectionLayout({
                    model: this.model.followers,
                    collection: this.model.followers.items,
                    fetchableCollectionView: UserCollectionView,
                    fetchableCollectionFooterView: ChannelFeedFooterView,
                    infiniteScroll: true,
                });
                view.$el.attr({
                    'class': 'card-wrap',
                });

                return view;
            case 'basics':
                if (!this.isSessionUserChannelOwner()) {
                    this.trigger('badTab');
                    return;
                }

                view = new ChannelCreateFormView({
                    model: this.model.channel,
                    session: this.session,
                });

                this.listenTo(view, 'updated', function (model) {
                    navigationUtils.navigate('/home/channel/' + model.id + '/', { trigger: true });
                });

                return view;
            case 'moderators':
                if (!this.isSessionUserChannelOwner()) {
                    this.trigger('badTab');
                    return;
                }

                return new ChannelModeratorsView({
                    model: this.model,
                });
            }

            // Tabs that show a feed filtered to a topic have a naming format
            // of topic-<topicname>. If this is a topic tab, parse out the
            // name of the to topic on which to filter and show the feed
            // filtered to that topic.
            var topicTab = activeTab.match(/^topic-(.+)/);
            if (topicTab) {
                // TODO remove when releasing globally
                if (!this.model.trendingTopics)
                    return;

                var topicName = topicTab[1];
                var feed = this.model.getFetchedTopicFilteredFeed(topicName);

                return new ChannelTopicTabView({
                    model: feed,
                    collection: feed.items,
                    fetchableCollectionView: ChannelCardCollectionView,
                    fetchableCollectionFooterView: ChannelFeedFooterView,
                    filteredTopic: new UniqueModel(Topic, { identifier: topicName }),
                    channel: this.model.channel,
                    isChannelFeed: true,
                    infiniteScroll: true,
                });
            }
        },

        isSessionUserChannelOwner: function () {
            return this.model.channel.get('owner_id') === this.session.user.get('id');
        },

        getPageTitle: function () {
            var channel = this.model.channel;
            return backboneUtils.getPromiseFor(channel, 'name')
                .then(function (channelName) {
                    return strings.interpolate(gettext('%(name)s Channel'), { name: channelName });
                });
        },

        getMetaAttrs: function () {
            var channel = this.model.channel;
            return this.getPageTitle()
                .then(function (pageTitle) {
                    var options = channel.get('options') || {};
                    return {
                        title: pageTitle,
                        image: options.coverImage ? options.coverImage.cache : options.tile,
                        description: options.description,
                        type: 'article',
                    };
                });
        },

        getPageTrackingParams: function () {
            var channel = this.model.channel;
            return this.getPageTitle().then(function (pageTitle) {
                return {
                    channel_slug: channel.get('slug'),
                    title: pageTitle,
                };
            });
        },
    });

    withClickLinkTracking.call(ChannelProfileView.prototype);
    withEmailVerificationAlert.call(ChannelProfileView.prototype);

    return ChannelProfileView;
});

define('home/models/SettingsApp',[
    'core/config',

    'home/models/common/BaseSettings',
], function (
    config,

    BaseSettings
) {
    'use strict';

    var SettingsApp = BaseSettings.extend({

        url: function () {
            return config.urls.apiSettings + 'apps/' + this.id + '/';
        },

        toJSON: function () {
            return {
                'id': this.get('id'),
                'name': this.get('name'),
            };
        },

    });

    return SettingsApp;
});


define('home/collections/SettingsAppCollection',[
    'backbone',

    'core/config',

    'home/models/SettingsApp',
], function (
    Backbone,

    config,

    SettingsApp
) {
    'use strict';

    var SettingsAppCollection = Backbone.Collection.extend({
        url: config.urls.apiSettings + 'apps/',
        model: SettingsApp,
    });

    return SettingsAppCollection;
});

define('home/collections/SettingsBlockListCollection',[
    'core/api',
    'core/collections/PaginatedCollection',
    'core/UniqueModel',

    'home/models/User',
], function (
    api,
    PaginatedCollection,
    UniqueModel,

    User
) {
    'use strict';

    var SettingsBlockListCollection = PaginatedCollection.extend({
        PER_PAGE: 10,

        url: api.getURL('users/block/list.json'),
        model: UniqueModel.boundModel(User),
    });

    return SettingsBlockListCollection;
});

define('home/models/SettingsModeration',[
    'core/config',

    'home/models/common/BaseSettings',
    'core/UniqueModel',
], function (
    config,

    BaseSettings,
    UniqueModel
) {
    'use strict';

    var SettingsModeration = BaseSettings.extend({
        url: config.urls.apiSettings + 'moderation/',

        toJSON: function () {
            return {
                'disable_approved': this.get('disable_approved'),
                'receive_unapproved': this.get('receive_unapproved'),
                'receive_spam': this.get('receive_spam'),
                'forum_subscriptions': this.get('forum_subscriptions'),
            };
        },
    });

    UniqueModel.addType('SettingsModeration', SettingsModeration);

    return SettingsModeration;
});


define('home/models/SettingsProfile',[
    'underscore',

    'core/config',

    'home/models/common/BaseSettings',
    'home/models/User',
    'core/UniqueModel',
], function (
    _,

    config,

    BaseSettings,
    User,
    UniqueModel
) {
    'use strict';

    var SettingsProfile = BaseSettings.extend({
        url: config.urls.apiSettings + 'profile/',

        useMultiPartForm: true,

        initialize: function () {
            var userAttrs = {};
            userAttrs[User.prototype.idAttribute] = this.id;
            this.user = new UniqueModel(User, userAttrs);
            this.listenTo(this, 'change', this.updateUser);
        },

        save: function (attrs, options) {
            if (!attrs) {
                // Only send necessary attributes to api
                // (attrs like remote and avatar_permalink are unnecessary)
                attrs = _.pick(this.attributes, [
                    'display_name',
                    'about',
                    'location',
                    'url',
                    'is_private',
                    'avatar_file',
                    'avatar_source',
                    'avatar_facebook',
                    'avatar_twitter',
                ]);
            }

            return BaseSettings.prototype.save.call(this, attrs, options);
        },

        /**
         * Keeps user model up to date with values updated through the settings form,
         * which are stored and updated here.
         */
        updateUser: function () {
            var avatar = _.defaults({
                cache: this.get('avatar_cache'),
                permalink: this.get('avatar_permalink'),

                // TODO: Once the backend returns is_custom from the users/self/profile endpoint
                // we'll be able to use that and not compute it here in this hacky way.
                // Note this only works for users either created or with avatars edited after
                // http://phabricator.local.disqus.net/D19519, since before that fix the default
                // avatar was copied and renamed and wouldn't match /noavatar/.
                // https://trello.com/c/dRIfjJPj/350-add-avatar-is-custom-to-users-self-profile-endpoint-response
                isCustom: !/noavatar/.test(this.get('avatar_cache')),
            }, this.user.get('avatar'));

            this.user.set({
                about: this.get('about'),
                avatar: avatar,
                name: this.get('display_name'),
                isPrivate: this.get('is_private'),
                location: this.get('location'),
                url: this.get('url'),
            });
        },
    });

    UniqueModel.addType('SettingsProfile', SettingsProfile);

    return SettingsProfile;
});

define('home/models/SettingsEmailNotifications',[
    'core/config',

    'home/models/common/BaseSettings',
    'core/UniqueModel',
], function (
    config,

    BaseSettings,
    UniqueModel
) {
    'use strict';

    var SettingsEmailNotifications = BaseSettings.extend({
        url: config.urls.apiSettings + 'email/',

        toJSON: function () {
            return {
                'receive_notifications': this.get('receive_notifications'),
                'receive_welcome_emails': this.get('receive_welcome_emails'),
                'subscribe_thread_on_post': this.get('subscribe_thread_on_post'),
                'replies_to_comments': this.get('replies_to_comments'),
                'digest_frequency': this.get('digest_frequency'),
            };
        },

    }, {
        FREQUENCY_NEVER: 'never',
    });

    UniqueModel.addType('SettingsEmailNotifications', SettingsEmailNotifications);

    return SettingsEmailNotifications;
});


define('home/templates/settingsBlockingButtons',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    return " disabled";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"fieldset\" role=\"group\">\n<button class=\"button button-outline text-medium spacing-right\" data-action=\"prev-page\""
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"hasPrev") : depth0),{"name":"unless","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":2,"column":87},"end":{"line":2,"column":126}}})) != null ? stack1 : "")
    + ">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Previous",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":2,"column":127},"end":{"line":2,"column":149}}}))
    + "</button>\n<button class=\"button button-outline text-medium\" data-action=\"next-page\""
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"hasNext") : depth0),{"name":"unless","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":3,"column":73},"end":{"line":3,"column":112}}})) != null ? stack1 : "")
    + ">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Next",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":3,"column":113},"end":{"line":3,"column":131}}}))
    + "</button>\n</div>\n";
},"useData":true})

});
define('home/views/SettingsUserBlockingNavView',[
    'backbone-marionette',

    'home/templates/settingsBlockingButtons',
], function (
    Marionette,

    settingsBlockingButtonsTemplate
) {
    'use strict';

    return Marionette.ItemView.extend({
        events: {
            'click [data-action=prev-page]': 'prevPage',
            'click [data-action=next-page]': 'nextPage',
        },

        template: settingsBlockingButtonsTemplate,

        initialize: function () {
            this.listenTo(this.collection, 'remove sync', this.render);
        },

        templateHelpers: function () {
            return {
                hasNext: this.collection.hasNext(),
                hasPrev: this.collection.hasPrev(),
            };
        },

        prevPage: function (evt) {
            evt.preventDefault();
            this.collection.prev();
        },

        nextPage: function (evt) {
            evt.preventDefault();
            this.collection.next();
        },
    });
});

define('home/templates/settingsBlockingEmpty',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<p class=\"text-gray text-medium\">\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"You aren't blocking any users. To block a user, go to their profile and select \"Block User\" from the dropdown.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":2,"column":0},"end":{"line":2,"column":126}}}))
    + "\n</p>\n";
},"useData":true})

});
define('home/templates/settingsBlockingUser',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card--user\">\n<div class=\"user-card__block\">\n<a href=\"/by/"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"username") : depth0), depth0))
    + "/\">\n<strong>"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"name") : depth0), depth0))
    + "</strong>\n</a>\n</div>\n<div class=\"user-card__button\">\n<button class=\"button button-fill--brand text-medium\" data-action=\"unblock\" data-username=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"username") : depth0), depth0))
    + "\">"
    + alias2(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Unblock",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":8,"column":105},"end":{"line":8,"column":126}}}))
    + "</button>\n</div>\n</div>\n";
},"useData":true})

});
define('home/views/SettingsBlockingUserListView',[
    'backbone-marionette',

    'home/templates/settingsBlockingEmpty',
    'home/templates/settingsBlockingUser',
], function (
    Marionette,

    settingsBlockingEmptyTemplate,
    settingsBlockingUserTemplate
) {
    'use strict';

    var SettingsBlockingUserListView = Marionette.CollectionView.extend({
        itemView: Marionette.ItemView.extend({
            template: settingsBlockingUserTemplate,
            className: 'block-list',
        }),
        emptyView: Marionette.ItemView.extend({
            template: settingsBlockingEmptyTemplate,
            className: 'block-list',
        }),
    });

    return SettingsBlockingUserListView;
});

define('home/templates/settingsBlocking',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<form class=\"form\">\n<div class=\"form__header--mobile visible-md\">\n<a href=\"/home/settings/\" class=\"form__header--mobile-back\"><span class=\"icon-left-bracket\"></span></a>\n<h2>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Blocking",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":4,"column":4},"end":{"line":4,"column":26}}}))
    + "</h2>\n</div>\n<div class=\"form__header\">\n<h1 class=\"form-heading hidden-md\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Blocking",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":7,"column":35},"end":{"line":7,"column":57}}}))
    + "</h1>\n<p class=\"form-description text-gray text-medium\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Manage the users you've previously blocked on your account. Blocking hides a user's activity across Disqus. Learn more about User Blocking in our %(helpDoc)s.",{"name":"gettext","hash":{"helpDoc":lookupProperty(helpers,"tag").call(alias1,"a",{"name":"tag","hash":{"text":lookupProperty(helpers,"gettext").call(alias1,"help documentation",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":8,"column":309},"end":{"line":8,"column":339}}}),"href":"https://help.disqus.com/customer/portal/articles/2460515"},"data":data,"loc":{"start":{"line":8,"column":231},"end":{"line":8,"column":340}}})},"data":data,"loc":{"start":{"line":8,"column":50},"end":{"line":8,"column":342}}}))
    + "</p>\n</div>\n<div data-role=\"alert-message\"></div>\n<div data-role=\"users\"></div>\n<div class=\"form__footer\" data-role=\"buttons\"></div>\n</form>\n";
},"useData":true})

});
define('home/templates/settingsBlockingAlertError',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"alert alert--error text-small text-center\">\n<span class=\"icon-warning icon-tiny icon__position -inline\"></span>\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Something went wrong while trying to unblock this user. Please check your internet connection and try again.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":3,"column":0},"end":{"line":3,"column":122}}}))
    + "\n<button class=\"link-inverted spacing-left\" data-action=\"close-alert\">\n<span class=\"icon-cancel icon__position\"></span>\n</button>\n</div>\n";
},"useData":true})

});
define('home/views/SettingsBlockingView',[
    'backbone-marionette',

    'core/api',

    'home/views/SettingsUserBlockingNavView',
    'home/views/SettingsBlockingUserListView',

    'home/templates/settingsBlocking',
    'home/templates/settingsBlockingAlertError',
], function (
    Marionette,

    api,

    SettingsUserBlockingNavView,
    SettingsBlockingUserListView,

    settingsBlockingTemplate,
    settingsBlockingAlertErrorTemplate
) {
    'use strict';

    var SettingsBlockingView = Marionette.Layout.extend({
        events: {
            'click [data-action=unblock]': 'unblockUser',
            'click [data-action=close-alert]': 'closeAlert',
        },

        template: settingsBlockingTemplate,

        regions: {
            alertRegion: '[data-role=alert-message]',
            buttonsRegion: '[data-role=buttons]',
            usersRegion: '[data-role=users]',
        },

        closeAlert: function (evt) {
            evt.preventDefault();
            this.alertRegion.close();
        },

        unblockUser: function (evt) {
            evt.preventDefault();
            var username = evt.target.getAttribute('data-username');
            var collection = this.collection;
            var user = collection.findWhere({ username: username });
            var onSuccessfulUnBlock = function () {
                collection.remove(user);
                // Jump back to first page if we've run out of entries for this page
                if (!collection.size())
                    collection.fetch();
            };

            this.alertRegion.close();
            user.unblock().then(onSuccessfulUnBlock).fail(function (xhr) {
                var response = xhr && xhr.responseJSON && xhr.responseJSON;
                var errorCode = response && response.code;

                // If the user is already blocked there is no need to display an alert
                if (
                    errorCode === api.ERROR_CODES.OBJ_NOT_FOUND &&
                    response.response === 'UserBlock matching query does not exist.'
                )
                    return void onSuccessfulUnBlock();

                this.alertRegion.show(new Marionette.ItemView({
                    template: settingsBlockingAlertErrorTemplate,
                }));
            }.bind(this));
        },

        onDomRefresh: function () {
            this.usersRegion.show(new SettingsBlockingUserListView({
                collection: this.collection,
            }));

            this.buttonsRegion.show(new SettingsUserBlockingNavView({
                collection: this.collection,
            }));
        },
    });

    return SettingsBlockingView;
});

define('home/templates/settingsDelete',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<form class=\"form\">\n<div class=\"form__header--mobile visible-md\">\n<a href=\"/home/settings/\" class=\"form__header--mobile-back\"><span class=\"icon-left-bracket\"></span></a>\n<h2>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Confirm Account Deletion",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":4,"column":4},"end":{"line":4,"column":42}}}))
    + "</h2>\n</div>\n<div class=\"form__header\">\n<h1 class=\"form-heading\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Confirm Account Deletion",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":7,"column":25},"end":{"line":7,"column":63}}}))
    + "</h1>\n<p class=\"form-description text-gray text-medium\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Doing this will delete any registered sites under this account and the comments contained within them. Comments made by this account on other sites with replies will only be anonymized in order to maintain the context of their discussions. Are you sure?",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":8,"column":50},"end":{"line":8,"column":317}}}))
    + "</p>\n</div>\n<div class=\"form__content\">\n<div class=\"fieldset\" role=\"group\" data-role=\"notification\">\n<div class=\"fieldset__label align__item text-gray\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Let us know why you're leaving (required)",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":13,"column":0},"end":{"line":13,"column":55}}}))
    + "\n</div>\n<div class=\"fieldset__block align__item\">\n<div class=\"fieldset__block--radio\">\n<label class=\"text-medium\">\n<input type=\"radio\" name=\"reason\" value=\"0\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"I can't get %(Disqus)s to work on my site.",{"name":"gettext","hash":{"Disqus":"Disqus"},"data":data,"loc":{"start":{"line":19,"column":0},"end":{"line":19,"column":74}}}))
    + "\n</label>\n</div>\n<p class=\"fieldset__description -radio text-gray text-small hidden\" data-role=\"delete-resolution\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"The best place to start is our %(knowledgeBase)s. If you are still having issues shoot us an email at %(helpEmail)s and we'll get you taken care of.",{"name":"gettext","hash":{"helpEmail":lookupProperty(helpers,"tag").call(alias1,"a",{"name":"tag","hash":{"text":"help@disqus.com","href":"mailto:help@disqus.com"},"data":data,"loc":{"start":{"line":25,"column":12},"end":{"line":25,"column":74}}}),"knowledgeBase":lookupProperty(helpers,"tag").call(alias1,"a",{"name":"tag","hash":{"text":lookupProperty(helpers,"gettext").call(alias1,"Knowledge Base",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":24,"column":77},"end":{"line":24,"column":103}}}),"target":"_blank","href":"https://help.disqus.com"},"data":data,"loc":{"start":{"line":24,"column":16},"end":{"line":24,"column":104}}})},"data":data,"loc":{"start":{"line":23,"column":0},"end":{"line":26,"column":2}}}))
    + "\n</p>\n<div class=\"fieldset__block--radio\">\n<label class=\"text-medium\">\n<input type=\"radio\" name=\"reason\" value=\"1\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"I receive too many emails notifications.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":31,"column":0},"end":{"line":31,"column":54}}}))
    + "\n</label>\n</div>\n<p class=\"fieldset__description -radio text-gray text-small hidden\" data-role=\"delete-resolution\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"To help suppress the amount of email notifications you're receiving, you can change your options here: %(emailNotifications)s.",{"name":"gettext","hash":{"emailNotifications":lookupProperty(helpers,"tag").call(alias1,"a",{"name":"tag","hash":{"text":lookupProperty(helpers,"gettext").call(alias1,"Settings &gt; Email Notifications",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":36,"column":82},"end":{"line":36,"column":127}}}),"href":"https://disqus.com/home/settings/email/"},"data":data,"loc":{"start":{"line":36,"column":21},"end":{"line":36,"column":128}}})},"data":data,"loc":{"start":{"line":35,"column":0},"end":{"line":37,"column":2}}}))
    + "\n</p>\n<div class=\"fieldset__block--radio\">\n<label class=\"text-medium\">\n<input type=\"radio\" name=\"reason\" value=\"2\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"I spend too much time using %(Disqus)s.",{"name":"gettext","hash":{"Disqus":"Disqus"},"data":data,"loc":{"start":{"line":42,"column":0},"end":{"line":42,"column":71}}}))
    + "\n</label>\n</div>\n<p class=\"fieldset__description -radio text-gray text-small hidden\" data-role=\"delete-resolution\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"One way to control your interaction with %(Disqus)s is to limit the number of emails you receive from us at %(emailNotifications)s.",{"name":"gettext","hash":{"emailNotifications":lookupProperty(helpers,"tag").call(alias1,"a",{"name":"tag","hash":{"text":lookupProperty(helpers,"gettext").call(alias1,"Settings &gt; Email Notifications",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":48,"column":82},"end":{"line":48,"column":127}}}),"href":"https://disqus.com/home/settings/email/"},"data":data,"loc":{"start":{"line":48,"column":21},"end":{"line":48,"column":128}}}),"Disqus":"Disqus"},"data":data,"loc":{"start":{"line":46,"column":0},"end":{"line":49,"column":2}}}))
    + "\n</p>\n<div class=\"fieldset__block--radio\">\n<label class=\"text-medium\">\n<input type=\"radio\" name=\"reason\" value=\"3\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"I don't find %(Disqus)s useful.",{"name":"gettext","hash":{"Disqus":"Disqus"},"data":data,"loc":{"start":{"line":54,"column":0},"end":{"line":56,"column":2}}}))
    + "\n</label>\n</div>\n<p class=\"fieldset__description -radio text-gray text-small hidden\" data-role=\"delete-resolution\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"You may find %(Disqus)s more useful by connecting with more of your friends.",{"name":"gettext","hash":{"Disqus":"Disqus"},"data":data,"loc":{"start":{"line":60,"column":0},"end":{"line":62,"column":2}}}))
    + "\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"You can add more of your friends here %(followLink)s or by learning about all our features: %(aboutLink)s",{"name":"gettext","hash":{"aboutLink":lookupProperty(helpers,"tag").call(alias1,"a",{"name":"tag","hash":{"text":"https://disqus.com/about/","href":"https://disqus.com/about/"},"data":data,"loc":{"start":{"line":65,"column":12},"end":{"line":65,"column":87}}}),"followLink":lookupProperty(helpers,"tag").call(alias1,"a",{"name":"tag","hash":{"text":"https://disqus.com/follow/","href":"https://disqus.com/follow/"},"data":data,"loc":{"start":{"line":64,"column":13},"end":{"line":64,"column":90}}})},"data":data,"loc":{"start":{"line":63,"column":0},"end":{"line":66,"column":2}}}))
    + "\n</p>\n<div class=\"fieldset__block--radio\">\n<label class=\"text-medium\">\n<input type=\"radio\" name=\"reason\" value=\"4\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"I can't change my name.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":71,"column":0},"end":{"line":71,"column":37}}}))
    + "\n</label>\n</div>\n<p class=\"fieldset__description -radio text-gray text-small hidden\" data-role=\"delete-resolution\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"You can change your display name by going to your %(profileSettings)s",{"name":"gettext","hash":{"profileSettings":lookupProperty(helpers,"tag").call(alias1,"a",{"name":"tag","hash":{"text":lookupProperty(helpers,"gettext").call(alias1,"Profile settings",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":76,"column":81},"end":{"line":76,"column":109}}}),"href":"https://disqus.com/home/settings/profile/"},"data":data,"loc":{"start":{"line":76,"column":18},"end":{"line":76,"column":110}}})},"data":data,"loc":{"start":{"line":75,"column":0},"end":{"line":77,"column":2}}}))
    + "\n</p>\n<div class=\"fieldset__block--radio\">\n<label class=\"text-medium\">\n<input type=\"radio\" name=\"reason\" value=\"5\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Other",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":82,"column":0},"end":{"line":82,"column":19}}}))
    + "\n</label>\n</div>\n<p class=\"fieldset__description -radio text-gray text-small hidden\" data-role=\"delete-resolution\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Could you explain it further?",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":86,"column":0},"end":{"line":86,"column":43}}}))
    + "\n<br>\n<textarea class=\"input--textbox\" id=\"delete-other\" name=\"details\"></textarea>\n</p>\n</div>\n</div>\n<div class=\"fieldset\" role=\"group\">\n<label for=\"settings-delete-passwordusername\" class=\"fieldset__label align__item text-gray\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Password",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":93,"column":92},"end":{"line":93,"column":114}}}))
    + "</label>\n<div class=\"fieldset__block align__item\">\n<div class=\"fieldset__block--text\">\n<input type=\"password\" class=\"input--textbox\" name=\"password\" id=\"settings-delete-password\" required>\n</div>\n</div>\n</div>\n<div class=\"fieldset\" role=\"group\">\n<div class=\"fieldset__block align__item\">\n<p class=\"fieldset__description text-gray text-small\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Please note that it may take up to 24 hours for your account to be removed from the system.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":103,"column":0},"end":{"line":103,"column":105}}}))
    + "\n</p>\n<p class=\"fieldset__description fieldset__description--error text-small\" data-role=\"error-alert\"></p>\n</div>\n</div>\n</div>\n<div class=\"form__footer\">\n<div class=\"fieldset\" role=\"group\">\n<div class=\"fieldset__label\" data-role=\"save-status\"><div class=\"spinner-small\"></div><div class=\"icon-checkmark\"></div></div>\n<div class=\"fieldset__block\"><input type=\"submit\" class=\"button button-fill--brand text-medium\" value=\""
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Delete my account",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":112,"column":103},"end":{"line":112,"column":134}}}))
    + "\"></div>\n</div>\n</div>\n</form>\n";
},"useData":true})

});
define('home/views/SettingsDeleteView',[
    'jquery',
    'underscore',

    'core/api',
    'core/strings',

    'home/templates/settingsDelete',
    'home/views/common/BaseSettingsView',
], function (
    $,
    _,

    api,
    strings,

    settingsDeleteTemplate,
    BaseSettingsView
) {
    'use strict';

    var gettext = strings.get;

    var SettingsDeleteView = BaseSettingsView.extend({
        template: settingsDeleteTemplate,

        events: {
            'submit form': 'handleDeleteAccount',
            'change input[type=radio]': 'handleReasonChange',
        },

        initialize: function (options) {
            this.session = options.session;

            // We manually scroll to the top of the tab as when users click on 'delete account' button
            // at the bottom of the accounts tab, they will be sent to this tab but will only see the
            // bottom of the tab contents if they aren't scrolled to the top.
            //
            // TODO - This needs a rethink of the way we show the contents of tab, since we shouldn't be
            // forcing a scroll to the top.
            $(window).scrollTop(0);
        },

        handleReasonChange: function (ev) {
            ev.preventDefault();

            var $radio = $(ev.currentTarget);
            this.$('[data-role=delete-resolution]').addClass('hidden');
            $radio.parent().next('[data-role=delete-resolution]').removeClass('hidden');
        },

        handleDeleteAccount: function (ev) {
            ev.preventDefault();

            var confirmationMsg = gettext('This will delete your account permanently. Are you sure?');
            if (!window.confirm(confirmationMsg))  // eslint-disable-line no-alert
                return;

            this.updateStatus('is-saving');

            var data = _.reduce($(ev.originalEvent.target).serializeArray(), function (result, item) {
                result[item.name] = item.value;
                return result;
            }, {});
            this.deleteAccount(data)
                .done(_.bind(this.session.logout, this.session))
                .fail(_.bind(this.showError, this));
        },

        showError: function (error) {
            var response = error.responseJSON;
            var $errorElement = this.$('[data-role=error-alert]');

            if (response.code === 2) {
                if (response.response === 'Invalid password.')
                    $errorElement.text(gettext('Invalid password.'));
                else
                    $errorElement.text(gettext('Please select a reason.'));
            } else {
                $errorElement.text(response.response);
            }

            this.updateStatus('');
        },

        deleteAccount: function (data) {
            return api.call('internal/users/delete', {
                method: 'POST',
                data: data,
            });
        },

    });

    return SettingsDeleteView;
});

define('home/templates/settingsProfile',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<option value=\"gravatar\">"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Gravatar",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":26,"column":25},"end":{"line":26,"column":47}}}))
    + "</option>\n";
},"3":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<option value=\"twitter\">"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Twitter",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":29,"column":24},"end":{"line":29,"column":45}}}))
    + "</option>\n";
},"5":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<option value=\"facebook\">"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Facebook",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":32,"column":25},"end":{"line":32,"column":47}}}))
    + "</option>\n";
},"7":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<input type=\"hidden\" name=\"avatar_twitter\" value=\""
    + container.escapeExpression(container.lambda(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"remotes") : depth0)) != null ? lookupProperty(stack1,"twitter") : stack1)) != null ? lookupProperty(stack1,"avatar_url") : stack1), depth0))
    + "\">\n";
},"9":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<input type=\"hidden\" name=\"avatar_facebook\"value=\""
    + container.escapeExpression(container.lambda(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"remotes") : depth0)) != null ? lookupProperty(stack1,"facebook") : stack1)) != null ? lookupProperty(stack1,"username") : stack1), depth0))
    + "\">\n";
},"11":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"each").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = (depth0 != null ? lookupProperty(depth0,"errors") : depth0)) != null ? lookupProperty(stack1,"avatar_file") : stack1),{"name":"each","hash":{},"fn":container.program(12, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":43,"column":0},"end":{"line":45,"column":9}}})) != null ? stack1 : "");
},"12":function(container,depth0,helpers,partials,data) {
    return "<p class=\"fieldset__description fieldset__description--error text-small\">"
    + container.escapeExpression(container.lambda(depth0, depth0))
    + "</p>\n";
},"14":function(container,depth0,helpers,partials,data) {
    return "is-error";
},"16":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"each").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = (depth0 != null ? lookupProperty(depth0,"errors") : depth0)) != null ? lookupProperty(stack1,"display_name") : stack1),{"name":"each","hash":{},"fn":container.program(12, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":58,"column":0},"end":{"line":60,"column":9}}})) != null ? stack1 : "");
},"18":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"each").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = (depth0 != null ? lookupProperty(depth0,"errors") : depth0)) != null ? lookupProperty(stack1,"about") : stack1),{"name":"each","hash":{},"fn":container.program(12, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":76,"column":0},"end":{"line":78,"column":9}}})) != null ? stack1 : "");
},"20":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"each").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = (depth0 != null ? lookupProperty(depth0,"errors") : depth0)) != null ? lookupProperty(stack1,"url") : stack1),{"name":"each","hash":{},"fn":container.program(12, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":92,"column":0},"end":{"line":94,"column":9}}})) != null ? stack1 : "");
},"22":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"each").call(depth0 != null ? depth0 : (container.nullContext || {}),((stack1 = (depth0 != null ? lookupProperty(depth0,"errors") : depth0)) != null ? lookupProperty(stack1,"location") : stack1),{"name":"each","hash":{},"fn":container.program(12, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":108,"column":0},"end":{"line":110,"column":9}}})) != null ? stack1 : "");
},"24":function(container,depth0,helpers,partials,data) {
    return " checked";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, alias3=container.lambda, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<form class=\"form\">\n<div class=\"form__header--mobile visible-md\">\n<a href=\"/home/settings/\" class=\"form__header--mobile-back\"><span class=\"icon-left-bracket\"></span></a>\n<h2>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Profile",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":4,"column":4},"end":{"line":4,"column":25}}}))
    + "</h2>\n</div>\n<div class=\"form__header\">\n<h1 class=\"form-heading hidden-md\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Profile",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":7,"column":35},"end":{"line":7,"column":56}}}))
    + "</h1>\n<p class=\"form-description text-gray text-medium\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Control your profile information, both what it says and what other people see. User profiles are shown across all Disqus sites. To understand what's acceptable to display on profiles, please see %(helpDoc)s.",{"name":"gettext","hash":{"helpDoc":lookupProperty(helpers,"tag").call(alias1,"a",{"name":"tag","hash":{"text":lookupProperty(helpers,"gettext").call(alias1,"these rules",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":10,"column":159},"end":{"line":10,"column":182}}}),"target":"blank","href":"https://help.disqus.com/customer/portal/articles/1753105-basic-rules-for-disqus-powered-profiles-and-discussions"},"data":data,"loc":{"start":{"line":10,"column":10},"end":{"line":10,"column":183}}})},"data":data,"loc":{"start":{"line":9,"column":0},"end":{"line":11,"column":2}}}))
    + "\n</p>\n</div>\n<div class=\"form__content\">\n<div class=\"fieldset\" role=\"group\">\n<div class=\"fieldset__label align__item text-gray\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Avatar",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":16,"column":51},"end":{"line":16,"column":71}}}))
    + "</div>\n<div class=\"fieldset__block align__item\">\n<div class=\"fieldset__avatar align\">\n<div class=\"fieldset__avatar--img align__item\"><img src=\""
    + alias2(alias3((depth0 != null ? lookupProperty(depth0,"avatar_cache") : depth0), depth0))
    + "\" alt=\"profile image\" data-role=\"avatar-img\"></div>\n<div class=\"fieldset__avatar--options align__item\">\n<select name=\"avatar_source\">\n<option value=\"\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Choose a method",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":22,"column":17},"end":{"line":22,"column":47}}}))
    + "</option>\n<option value=\"computer\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Upload from computer",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":23,"column":25},"end":{"line":23,"column":59}}}))
    + "</option>\n<option value=\"default\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Default",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":24,"column":24},"end":{"line":24,"column":45}}}))
    + "</option>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"remotes") : depth0)) != null ? lookupProperty(stack1,"gravatar") : stack1),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":25,"column":0},"end":{"line":27,"column":7}}})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"remotes") : depth0)) != null ? lookupProperty(stack1,"twitter") : stack1),{"name":"if","hash":{},"fn":container.program(3, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":28,"column":0},"end":{"line":30,"column":7}}})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"remotes") : depth0)) != null ? lookupProperty(stack1,"facebook") : stack1),{"name":"if","hash":{},"fn":container.program(5, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":31,"column":0},"end":{"line":33,"column":7}}})) != null ? stack1 : "")
    + "</select>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"remotes") : depth0)) != null ? lookupProperty(stack1,"twitter") : stack1),{"name":"if","hash":{},"fn":container.program(7, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":35,"column":0},"end":{"line":37,"column":7}}})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"remotes") : depth0)) != null ? lookupProperty(stack1,"facebook") : stack1),{"name":"if","hash":{},"fn":container.program(9, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":38,"column":0},"end":{"line":40,"column":7}}})) != null ? stack1 : "")
    + "<input type=\"file\" name=\"avatar_file\" data-role=\"avatar-file-upload\" class=\"hidden\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"errors") : depth0)) != null ? lookupProperty(stack1,"avatar_file") : stack1),{"name":"if","hash":{},"fn":container.program(11, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":42,"column":0},"end":{"line":46,"column":7}}})) != null ? stack1 : "")
    + "</div>\n</div>\n</div>\n</div>\n<div class=\"fieldset\" role=\"group\">\n<label for=\"settings-name\" class=\"fieldset__label align__item text-gray\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Name",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":52,"column":73},"end":{"line":52,"column":91}}}))
    + "</label>\n<div class=\"fieldset__block align__item "
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"errors") : depth0)) != null ? lookupProperty(stack1,"display_name") : stack1),{"name":"if","hash":{},"fn":container.program(14, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":53,"column":40},"end":{"line":53,"column":82}}})) != null ? stack1 : "")
    + "\">\n<div class=\"fieldset__block--text\">\n<input type=\"text\" id=\"settings-name\" name=\"display_name\" class=\"input--textbox\" value=\""
    + alias2(alias3((depth0 != null ? lookupProperty(depth0,"display_name") : depth0), depth0))
    + "\">\n</div>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"errors") : depth0)) != null ? lookupProperty(stack1,"display_name") : stack1),{"name":"if","hash":{},"fn":container.program(16, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":57,"column":0},"end":{"line":61,"column":7}}})) != null ? stack1 : "")
    + "<p class=\"fieldset__description text-gray text-small\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"If blank, your username will be shown instead. To change your username, go to %(accountSettings)s.",{"name":"gettext","hash":{"accountSettings":lookupProperty(helpers,"tag").call(alias1,"a",{"name":"tag","hash":{"text":lookupProperty(helpers,"gettext").call(alias1,"Account",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":64,"column":63},"end":{"line":64,"column":82}}}),"href":"/home/settings/account/"},"data":data,"loc":{"start":{"line":64,"column":18},"end":{"line":64,"column":83}}})},"data":data,"loc":{"start":{"line":63,"column":0},"end":{"line":65,"column":2}}}))
    + "\n</p>\n</div>\n</div>\n<div class=\"fieldset\" role=\"group\">\n<label for=\"settings-bio\" class=\"fieldset__label align__item text-gray\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Biography",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":70,"column":72},"end":{"line":70,"column":95}}}))
    + "</label>\n<div class=\"fieldset__block align__item "
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"errors") : depth0)) != null ? lookupProperty(stack1,"about") : stack1),{"name":"if","hash":{},"fn":container.program(14, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":71,"column":40},"end":{"line":71,"column":75}}})) != null ? stack1 : "")
    + "\">\n<div class=\"fieldset__block--text\">\n<input type=\"text\" id=\"settings-bio\" name=\"about\" class=\"input--textbox\" value=\""
    + alias2(alias3((depth0 != null ? lookupProperty(depth0,"about") : depth0), depth0))
    + "\">\n</div>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"errors") : depth0)) != null ? lookupProperty(stack1,"about") : stack1),{"name":"if","hash":{},"fn":container.program(18, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":75,"column":0},"end":{"line":79,"column":7}}})) != null ? stack1 : "")
    + "<p class=\"fieldset__description text-gray text-small\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Describe yourself in a sentence or two. 200 characters max.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":81,"column":0},"end":{"line":81,"column":73}}}))
    + "\n</p>\n</div>\n</div>\n<div class=\"fieldset\" role=\"group\">\n<label for=\"settings-website\" class=\"fieldset__label align__item text-gray\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Website",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":86,"column":76},"end":{"line":86,"column":97}}}))
    + "</label>\n<div class=\"fieldset__block align__item "
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"errors") : depth0)) != null ? lookupProperty(stack1,"url") : stack1),{"name":"if","hash":{},"fn":container.program(14, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":87,"column":40},"end":{"line":87,"column":73}}})) != null ? stack1 : "")
    + "\">\n<div class=\"fieldset__block--text\">\n<input type=\"text\" id=\"settings-website\" class=\"input--textbox\" name=\"url\" value=\""
    + alias2(alias3((depth0 != null ? lookupProperty(depth0,"url") : depth0), depth0))
    + "\">\n</div>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"errors") : depth0)) != null ? lookupProperty(stack1,"url") : stack1),{"name":"if","hash":{},"fn":container.program(20, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":91,"column":0},"end":{"line":95,"column":7}}})) != null ? stack1 : "")
    + "<p class=\"fieldset__description text-gray text-small\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Link to your profile or website.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":97,"column":0},"end":{"line":97,"column":46}}}))
    + "\n</p>\n</div>\n</div>\n<div class=\"fieldset\" role=\"group\">\n<label for=\"settings-location\" class=\"fieldset__label align__item text-gray\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Location",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":102,"column":77},"end":{"line":102,"column":99}}}))
    + "</label>\n<div class=\"fieldset__block align__item "
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"errors") : depth0)) != null ? lookupProperty(stack1,"location") : stack1),{"name":"if","hash":{},"fn":container.program(14, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":103,"column":40},"end":{"line":103,"column":78}}})) != null ? stack1 : "")
    + "\">\n<div class=\"fieldset__block--text\">\n<input type=\"text\" id=\"settings-location\" class=\"input--textbox\" name=\"location\" value=\""
    + alias2(alias3((depth0 != null ? lookupProperty(depth0,"location") : depth0), depth0))
    + "\">\n</div>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"errors") : depth0)) != null ? lookupProperty(stack1,"location") : stack1),{"name":"if","hash":{},"fn":container.program(22, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":107,"column":0},"end":{"line":111,"column":7}}})) != null ? stack1 : "")
    + "<p class=\"fieldset__description  text-gray text-small\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Where you're commenting from. 100 characters max.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":112,"column":55},"end":{"line":112,"column":118}}}))
    + "</p>\n</div>\n</div>\n<div class=\"fieldset\" role=\"group\">\n<div class=\"fieldset__label align__item text-gray\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Privacy",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":116,"column":51},"end":{"line":116,"column":72}}}))
    + "</div>\n<div class=\"fieldset__block align__item\">\n<div class=\"fieldset__block--checkbox\">\n<label class=\"text-medium\">\n<input type=\"checkbox\" name=\"is_private\""
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"is_private") : depth0),{"name":"if","hash":{},"fn":container.program(24, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":120,"column":40},"end":{"line":120,"column":73}}})) != null ? stack1 : "")
    + ">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Keep your profile activity private",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":121,"column":0},"end":{"line":121,"column":48}}}))
    + "\n</label>\n</div>\n<p class=\"fieldset__description  text-gray text-small\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"This means no one can follow you or see comments on your profile.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":124,"column":55},"end":{"line":124,"column":134}}}))
    + "</p>\n</div>\n</div>\n</div>\n<div class=\"form__footer\">\n<div class=\"fieldset\" role=\"group\">\n<div class=\"fieldset__label\" data-role=\"save-status\"><div class=\"spinner-small\"></div><div class=\"icon-checkmark\"></div></div>\n<div class=\"fieldset__block\"><button class=\"button button-fill--brand button-padding-wider text-medium\" data-role=\"save-btn\" disabled>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Save",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":131,"column":134},"end":{"line":131,"column":152}}}))
    + "</button></div>\n</div>\n</div>\n</form>\n";
},"useData":true})

});
define('home/views/SettingsProfileView',[
    'jquery',
    'underscore',

    'core/config',

    'home/templates/settingsProfile',
    'home/views/common/BaseSettingsView',
], function (
    $,
    _,

    config,

    settingsProfileTemplate,
    BaseSettingsView
) {
    'use strict';

    var SettingsProfileView = BaseSettingsView.extend({
        template: settingsProfileTemplate,

        events: _.defaults({
            'change select[name=avatar_source]': 'sourceChangeHandler',
        }, BaseSettingsView.prototype.events),

        serializeData: function () {
            var data = BaseSettingsView.prototype.serializeData.call(this, arguments);

            // include the necessary model's attributes that aren't returned in it's
            // toJSON method
            return _.defaults(data, {
                remotes: this.model.get('remotes'),
                avatar_cache: this.model.get('avatar_cache'),
            });
        },

        sourceChangeHandler: function (ev) {
            var $select = $(ev.originalEvent.target);
            var $avatarFileUpload = $('[data-role=avatar-file-upload]');
            var $avatar = this.$el.find('[data-role=avatar-img]');

            var source = $select.val();

            // when user selects 'upload from computer', the value will
            // be 'computer' and we show the file upload input
            if (source === 'computer') {
                $avatarFileUpload.removeClass('hidden');
            } else {
                $avatarFileUpload.addClass('hidden');
                $avatar.attr('src', this.getAvatar(source));
            }
        },

        getAvatar: function (source) {
            switch (source) {
            case 'gravatar':
                return 'https://www.gravatar.com/avatar/' + this.model.get('remotes').gravatar.username;
            case 'twitter':
                // we store http twitter pic urls so we need to ensure the https version is used
                // https://dev.twitter.com/overview/general/user-profile-images-and-banners
                return this.ensureHttpsUrl(this.model.get('remotes').twitter.avatar_url);
            case 'facebook':
                // use graph api directly since profile pictures are always public
                // https://developers.facebook.com/docs/graph-api/reference/v2.2/user/picture
                return 'https://graph.facebook.com/' + this.model.get('remotes').facebook.username.replace('facebook-', '') + '/picture?&height=92&width=92';
            case 'default':
                return config.urls.avatar.generic;
            }
        },

        ensureHttpsUrl: function (url) {
            return url.replace('http:', 'https:');
        },

        getFormData: function () {
            var data = BaseSettingsView.prototype.getFormData.apply(this, arguments);

            // explicity set checkbox fields to true or false so that
            // the model is updated correctly
            data.is_private = Boolean(data.is_private);

            // serializeArray ignores file inputs
            data.avatar_file = this.$form.find('input[name=avatar_file]')[0].files[0] || '';

            return data;
        },
    });

    return SettingsProfileView;
});

define('home/templates/settingsMenu',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"empty-message\">\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Pick a settings page on the left",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":2,"column":0},"end":{"line":2,"column":46}}}))
    + "\n</div>\n";
},"useData":true})

});
define('home/views/SettingsMenuView',[
    'backbone-marionette',
    'home/templates/settingsMenu',
], function (
    Marionette,
    settingsMenuTemplate
) {
    'use strict';

    var SettingsMenuView = Marionette.ItemView.extend({
        template: settingsMenuTemplate,
    });

    return SettingsMenuView;
});

define('home/templates/settingsAccount',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"alert alert--success text-semibold\">"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Email verified. Now choose a username before someone else grabs it!",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":2,"column":48},"end":{"line":2,"column":129}}}))
    + "</div>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"showVerifiedMessage") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":1,"column":0},"end":{"line":3,"column":7}}})) != null ? stack1 : "")
    + "<div data-role=\"account-form\"></div>\n<div data-role=\"connected-accounts\"></div>\n<div class=\"form\">\n<div class=\"form__header\">\n<h1 class=\"form-heading\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Personalization",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":8,"column":25},"end":{"line":8,"column":54}}}))
    + "</h1>\n<p class=\"form-description text-gray text-medium\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"%(Disqus)s collects anonymous data from you in order to deliver better targeted content and advertising.",{"name":"gettext","hash":{"Disqus":"Disqus"},"data":data,"loc":{"start":{"line":10,"column":0},"end":{"line":12,"column":2}}}))
    + "\n</p>\n</div>\n<div class=\"form__content\">\n<a href=\"https://help.disqus.com/customer/portal/articles/1657951\" class=\"button button-fill--brand text-medium inline__item\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Configure",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":16,"column":126},"end":{"line":16,"column":149}}}))
    + "</a>\n</div>\n</div>\n\n<div data-role=\"delete-form\"></div>\n";
},"useData":true})

});
/*!
 * visibly - v0.7 Page Visibility API Polyfill
 * http://github.com/addyosmani
 * Copyright (c) 2011-2014 Addy Osmani
 * Dual licensed under the MIT and GPL licenses.
 *
 * Methods supported:
 * visibly.onVisible(callback)
 * visibly.onHidden(callback)
 * visibly.hidden()
 * visibly.visibilityState()
 * visibly.visibilitychange(callback(state));
 */

// Packaged for AMD by charles@disqus.com
define('core/engagement/vendor/visibly',[], function () {

    var exports = {
        q: document,
        p: undefined,
        prefixes: ['webkit', 'ms','o','moz','khtml'],
        props: ['VisibilityState', 'visibilitychange', 'Hidden'],
        m: ['focus', 'blur'],
        visibleCallbacks: [],
        hiddenCallbacks: [],
        genericCallbacks:[],
        _callbacks: [],
        cachedPrefix:"",
        fn:null,

        onVisible: function (_callback) {
            if(typeof _callback == 'function' ){
                this.visibleCallbacks.push(_callback);
            }
        },
        onHidden: function (_callback) {
            if(typeof _callback == 'function' ){
                this.hiddenCallbacks.push(_callback);
            }
        },
        getPrefix:function(){
            if(!this.cachedPrefix){
                for(var l=0;b=this.prefixes[l++];){
                    if(b + this.props[2] in this.q){
                        this.cachedPrefix =  b;
                        return this.cachedPrefix;
                    }
                }
             }
        },

        visibilityState:function(){
            return  this._getProp(0);
        },
        hidden:function(){
            return this._getProp(2);
        },
        visibilitychange:function(fn){
            if(typeof fn == 'function' ){
                this.genericCallbacks.push(fn);
            }

            var n =  this.genericCallbacks.length;
            if(n){
                if(this.cachedPrefix){
                     while(n--){
                        this.genericCallbacks[n].call(this, this.visibilityState());
                    }
                }else{
                    while(n--){
                        this.genericCallbacks[n].call(this, arguments[0]);
                    }
                }
            }

        },
        isSupported: function (index) {
            return ((this._getPropName(2)) in this.q);
        },
        _getPropName:function(index) {
            return (this.cachedPrefix == "" ? this.props[index].substring(0, 1).toLowerCase() + this.props[index].substring(1) : this.cachedPrefix + this.props[index]);
        },
        _getProp:function(index){
            return this.q[this._getPropName(index)];
        },
        _execute: function (index) {
            if (index) {
                this._callbacks = (index == 1) ? this.visibleCallbacks : this.hiddenCallbacks;
                var n =  this._callbacks.length;
                while(n--){
                    this._callbacks[n]();
                }
            }
        },
        _visible: function () {
            exports._execute(1);
            exports.visibilitychange.call(exports, 'visible');
        },
        _hidden: function () {
            exports._execute(2);
            exports.visibilitychange.call(exports, 'hidden');
        },
        _nativeSwitch: function () {
            this[this._getProp(2) ? '_hidden' : '_visible']();
        },
        _listen: function () {
            try { /*if no native page visibility support found..*/
                if (!(this.isSupported())) {
                    if (this.q.addEventListener) { /*for browsers without focusin/out support eg. firefox, opera use focus/blur*/
                        window.addEventListener(this.m[0], this._visible, 1);
                        window.addEventListener(this.m[1], this._hidden, 1);
                    } else { /*IE <10s most reliable focus events are onfocusin/onfocusout*/
                        if (this.q.attachEvent) {
                            this.q.attachEvent('onfocusin', this._visible);
                            this.q.attachEvent('onfocusout', this._hidden);
                        }
                    }
                } else { /*switch support based on prefix detected earlier*/
                    this.q.addEventListener(this._getPropName(1), function () {
                        exports._nativeSwitch.apply(exports, arguments);
                    }, 1);
                }
            } catch (e) {}
        },
        init: function () {
            this.getPrefix();
            this._listen();
        }
    };

    exports.init();
    return exports;
});

define('core/engagement/page',[
    'jquery',
    'underscore',
    'backbone',
    'core/bus',
    'core/utils',
    'core/engagement/vendor/visibly',
], function (
    $,
    _,
    Backbone,
    bus,
    utils,
    visibly
) {
    'use strict';

    /**
     * This module reports if the user is engaged on the current
     * page through an amalgamation of various HTML standards and
     * best guesses.
     *
     * Do not use this module for UX methods. We are intentionally
     * conservative when marking a user as engaged for reporting reasons.
     *
     * Inspiration from:
     * - https://chartbeat.com/public-release-methodology/
     * - http://upworthy.github.io/2014/06/implementing-attention-minutes-part-1/
     * - http://jsfiddle.net/zanes/mbGBr/
     * - http://static.chartbeat.com/js/chartbeat.js
     * - https://github.com/serkanyersen/ifvisible.js
     */

    // Exported Event object w/ initial defaults
    var exports = _.extend(Backbone.Events, {
        _initialized: false,
        isEngaged: false,
        resetTimeout: null,
        ACTIVE_TIMEOUT: 60 * 1000,
    });

    exports._markNotEngaged = function () {
        if (!exports.isEngaged)
            return;

        exports.isEngaged = false;
        exports.trigger('change:isEngaged', exports.isEngaged, exports);
    };

    exports._markIsEngaged = function () {
        // Restart the interaction timeout clock.
        if (exports.resetTimeout)
            exports.resetTimeout();

        if (exports.isEngaged)
            return;

        exports.isEngaged = true;
        exports.trigger('change:isEngaged', exports.isEngaged, exports);
    };

    exports.start = function () {
        if (exports._initialized)
            return;
        exports._initialized = true;

        // Page Visibility API

        // If the window is currently visible, mark the user as
        // engaged, just to start things off. If it's not, we'll
        // wait for an interaction event to fire first.
        if (!visibly.hidden())
            exports._markIsEngaged();

        // On mobile-like user agents all we need is the Page Visibility API.
        visibly.onVisible(exports._markIsEngaged);
        visibly.onHidden(exports._markNotEngaged);

        if (utils.isMobileUserAgent())
            return;

        // On desktop-like user agents, we'll additionally use interaction events
        // and a timeout clock to more closely track if a user is still
        // engaged on the page. Each time we record an interaction on the page
        // we reset the clock. If the clock reaches it's`ACTIVE_TIMEOUT` time, we
        // mark the user as no longer engaged with the page (see `_markIsEngaged` method).
        exports.resetTimeout = _.debounce(exports._markNotEngaged, exports.ACTIVE_TIMEOUT);
        exports.resetTimeout();

        // Bind into interaction events on the current page.
        $(window.document).on('mousemove keyup', exports._markIsEngaged);
        $(window).on('scroll', exports._markIsEngaged);

        // Then bind into interaction events from the parent page.
        exports.listenTo(bus.frame, 'window.mousemove window.scroll window.click', exports._markIsEngaged);
    };

    exports.stop = function () {
        if (!exports._initialized)
            return;
        exports._initialized = false;

        // Clean up the resetTimeout method.
        exports.resetTimeout = null;

        // Turn off listeners before changing
        // the state to off.
        exports.stopListening();
        exports.off();

        visibly.visibleCallbacks = [];
        visibly.hiddenCallbacks = [];

        $(window.document).off('mousemove keyup', exports._markIsEngaged);
        $(window).off('scroll', exports._markIsEngaged);

        exports._markNotEngaged();
    };

    return exports;
});

define('home/templates/settingsConnectedAccounts',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"fieldset__block--button\">\n<button class=\"button button-fill--brand text-medium\" data-action=\"disconnect\" data-social=\"facebook\">"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Disconnect",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":17,"column":102},"end":{"line":17,"column":126}}}))
    + "</button>\n<small class=\"text-gray text-small\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"settingsAccountSocialLink"),((stack1 = (depth0 != null ? lookupProperty(depth0,"items") : depth0)) != null ? lookupProperty(stack1,"facebook") : stack1),{"name":"settingsAccountSocialLink","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</small>\n</div>\n";
},"3":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"fieldset__block--button\">\n<button class=\"button button-fill--brand text-medium\" data-action=\"connect\" data-social=\"facebook\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Connect",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":24,"column":99},"end":{"line":24,"column":120}}}))
    + "</button>\n<small class=\"text-gray text-small\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Connect your Facebook account",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":25,"column":36},"end":{"line":25,"column":79}}}))
    + "</small>\n</div>\n";
},"5":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"fieldset__block--button\">\n<button class=\"button button-fill--brand text-medium\" data-action=\"disconnect\" data-social=\"twitter\">"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Disconnect",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":35,"column":101},"end":{"line":35,"column":125}}}))
    + "</button>\n<small class=\"text-gray text-small\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"settingsAccountSocialLink"),((stack1 = (depth0 != null ? lookupProperty(depth0,"items") : depth0)) != null ? lookupProperty(stack1,"twitter") : stack1),{"name":"settingsAccountSocialLink","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</small>\n</div>\n";
},"7":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"fieldset__block--button\">\n<button class=\"button button-fill--brand text-medium\" data-action=\"connect\" data-social=\"twitter\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Connect",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":42,"column":98},"end":{"line":42,"column":119}}}))
    + "</button>\n<small class=\"text-gray text-small\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Connect your Twitter account",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":43,"column":36},"end":{"line":43,"column":78}}}))
    + "</small>\n</div>\n";
},"9":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"fieldset__block--button\">\n<button class=\"button button-fill--brand text-medium\" data-action=\"disconnect\" data-social=\"google\">"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Disconnect",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":53,"column":100},"end":{"line":53,"column":124}}}))
    + "</button>\n<small class=\"text-gray text-small\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"settingsAccountSocialLink"),((stack1 = (depth0 != null ? lookupProperty(depth0,"items") : depth0)) != null ? lookupProperty(stack1,"google") : stack1),{"name":"settingsAccountSocialLink","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</small>\n</div>\n";
},"11":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"fieldset__block--button\">\n<button class=\"button button-fill--brand text-medium\" data-action=\"connect\" data-social=\"google\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Connect",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":60,"column":97},"end":{"line":60,"column":118}}}))
    + "</button>\n<small class=\"text-gray text-small\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Connect your Google account",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":61,"column":36},"end":{"line":61,"column":77}}}))
    + "</small>\n</div>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"form\">\n<div class=\"form__header\">\n<h1 class=\"form-heading\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Connected Accounts",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":3,"column":25},"end":{"line":3,"column":57}}}))
    + "</h1>\n<p class=\"form-description text-gray text-medium\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Connect your social media accounts for one-click login and to show off your online presence on your %(Disqus)s profile.",{"name":"gettext","hash":{"Disqus":"Disqus"},"data":data,"loc":{"start":{"line":5,"column":0},"end":{"line":7,"column":2}}}))
    + "\n</p>\n<p class=\"form-error text-medium\" data-role=\"connected-accounts-alert\"></p>\n</div>\n<div class=\"form__content\">\n<div class=\"fieldset\" role=\"group\">\n<div class=\"fieldset__label align__item text-gray\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Facebook",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":13,"column":51},"end":{"line":13,"column":73}}}))
    + "</div>\n<div class=\"fieldset__block align__item\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"items") : depth0)) != null ? lookupProperty(stack1,"facebook") : stack1),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"data":data,"loc":{"start":{"line":15,"column":0},"end":{"line":27,"column":7}}})) != null ? stack1 : "")
    + "</div>\n</div>\n<div class=\"fieldset\" role=\"group\">\n<div class=\"fieldset__label align__item text-gray\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Twitter",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":31,"column":51},"end":{"line":31,"column":72}}}))
    + "</div>\n<div class=\"fieldset__block align__item\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"items") : depth0)) != null ? lookupProperty(stack1,"twitter") : stack1),{"name":"if","hash":{},"fn":container.program(5, data, 0),"inverse":container.program(7, data, 0),"data":data,"loc":{"start":{"line":33,"column":0},"end":{"line":45,"column":7}}})) != null ? stack1 : "")
    + "</div>\n</div>\n<div class=\"fieldset\" role=\"group\">\n<div class=\"fieldset__label align__item text-gray\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Google",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":49,"column":51},"end":{"line":49,"column":71}}}))
    + "</div>\n<div class=\"fieldset__block align__item\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"items") : depth0)) != null ? lookupProperty(stack1,"google") : stack1),{"name":"if","hash":{},"fn":container.program(9, data, 0),"inverse":container.program(11, data, 0),"data":data,"loc":{"start":{"line":51,"column":0},"end":{"line":63,"column":7}}})) != null ? stack1 : "")
    + "</div>\n</div>\n</div>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/SettingsConnectedAccountsView',[
    'jquery',
    'backbone-marionette',
    'underscore',

    'core/config',
    'core/engagement/page',
    'core/strings',
    'core/utils',

    'home/models/Session',
    'home/models/SettingsSocialAccount',
    'home/templates/settingsConnectedAccounts',
], function (
    $,
    Marionette,
    _,

    config,
    pageEngagement,
    strings,
    utils,

    Session,
    SettingsSocialAccount,
    settingsConnectedAccountsTemplate
) {
    'use strict';

    var gettext = strings.get;

    var SettingsConnectedAccountsView = Marionette.ItemView.extend({

        template: settingsConnectedAccountsTemplate,

        events: {
            'click [data-action=connect]': 'connectHandler',
            'click [data-action=disconnect]': 'disconnectHandler',
        },

        initialize: function () {
            this.listenTo(this.collection, 'reset remove add', this.render);
            this.session = Session.get();
        },

        disconnectHandler: function (ev) {
            ev.preventDefault();

            var $btn = $(ev.originalEvent.target);
            var service = $btn.attr('data-social');
            var socialAccount = this.collection.get(service);
            var self = this;
            socialAccount
                .destroy({ wait: true })
                .fail(_.bind(self.showDisconnectError, self))
                .done(function (response) {
                    // Since this endpoint returns a 200 regardless of whether removing
                    // the social account was destroyed or not, we have to explicitly check
                    // for success here and manually add the model back into the collection
                    // if it wasn't successful
                    if (!response.success) {
                        this.collection.add(socialAccount);
                        self.showDisconnectError();
                    }
                });
        },

        showDisconnectError: function () {
            this.updateSocialStatus(gettext('Can\'t disconnect your account.'));
        },

        connectHandler: function (ev) {
            ev.preventDefault();

            var $btn = $(ev.originalEvent.target);
            var service = $btn.attr('data-social');
            this.authenticate(service);
        },

        authenticate: function (service) {
            var authWindow = this.openAuthWindow(service);

            if (utils.isMobileUserAgent())
                this.checkStatusOnPageVisible(service);
            else
                this.pollAuthWindow(service, authWindow);

        },

        openAuthWindow: function (service) {
            var params = 'location=0,status=0,width=800,height=400';
            var url = this.getConnectUrl(service);
            return window.open(url, service + 'Window', params);
        },

        getConnectUrl: function (service) {
            return config.urls.oauth[service] + '?ctkn=' + this.session.getCsrfToken();
        },

        pollAuthWindow: function (service, authWindow) {
            var self = this;
            var pollInterval = setInterval(function () {
                if (!authWindow.closed)
                    return;

                clearInterval(pollInterval);
                self.getAuthenticationStatus(service);
            }, 1000);
        },

        /**
         * On mobile browsers, the social auth tab either doesn't close or we can't check
         * if an open web view is closed on non native browsers. So we use Page
         * Visibility to check if this window comes back into focus and then force a
         * check of social auth status.
         */
        checkStatusOnPageVisible: function (service) {
            var self = this;
            var checkAuthStatus = function (isEngaged) {
                if (!isEngaged)
                    return;

                self.getAuthenticationStatus(service);
                pageEngagement.off('change:isEngaged', checkAuthStatus);
            };
            pageEngagement.on('change:isEngaged', checkAuthStatus);
        },

        getAuthenticationStatus: function (service) {
            var self = this;
            var socialAccount = new SettingsSocialAccount({
                id: service,
            });
            socialAccount
                .fetch()
                .fail(_.bind(self.showConnectError, self))
                .done(function (response) {
                    if (response.success)
                        self.collection.add(socialAccount);
                    else
                        self.showConnectError();
                });
        },

        showConnectError: function () {
            this.updateSocialStatus(gettext('Can\'t connect to your account.'));
        },

        updateSocialStatus: function (msg) {
            this.$('[data-role=connected-accounts-alert]').text(msg);
        },
    });

    return SettingsConnectedAccountsView;
});


define('home/templates/settingsDeleteForm',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"form\">\n<div class=\"form__header\">\n<h1 class=\"form-heading\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Delete Your %(Disqus)s Account",{"name":"gettext","hash":{"Disqus":"Disqus"},"data":data,"loc":{"start":{"line":3,"column":25},"end":{"line":3,"column":87}}}))
    + "</h1>\n<p class=\"form-description text-gray text-medium\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"This can't be reversed, so make sure you're sure this is what you want.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":4,"column":50},"end":{"line":4,"column":135}}}))
    + "</p>\n</div>\n<div class=\"form__content\">\n<a href=\"#\" class=\"button button-fill--brand text-medium inline__item\" data-action=\"switch-tab\" data-tab=\"delete\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Delete",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":7,"column":114},"end":{"line":7,"column":134}}}))
    + "</a>\n</div>\n</div>\n";
},"useData":true})

});
define('home/views/SettingsDeleteFormView',[
    'backbone-marionette',

    'home/templates/settingsDeleteForm',
], function (
    Marionette,

    settingsDeleteFormTemplate
) {
    'use strict';

    var SettingsDeleteFormView = Marionette.ItemView.extend({
        template: settingsDeleteFormTemplate,
    });

    return SettingsDeleteFormView;
});

define('home/views/SettingsAccountView',[
    'backbone-marionette',

    'core/utils/url/parseQueryString',

    'home/mixins/withSubviews',
    'home/templates/settingsAccount',
    'home/views/SettingsAccountFormView',
    'home/views/SettingsConnectedAccountsView',
    'home/views/SettingsDeleteFormView',
], function (
    Marionette,

    parseQueryString,

    withSubviews,
    settingsAccountTemplate,
    SettingsAccountFormView,
    SettingsConnectedAccountsView,
    SettingsDeleteFormView
) {
    'use strict';

    var SettingsAccountView = Marionette.ItemView.extend({
        template: settingsAccountTemplate,

        regions: {
            connectedAccountsRegion: '[data-role=connected-accounts]',
            formRegion: '[data-role=account-form]',
            deleteRegion: '[data-role=delete-form]',
        },

        templateHelpers: function () {
            return {
                showVerifiedMessage: this.showVerifiedMessage(),
            };
        },

        initialize: function (options) {
            this.session = options.session;
        },

        /**
         * Users are redirected to /home/settings/account/?email_verified=1 after verifying their email.
         * This method returns true if location.search contains email_verified=1.
         *
         * TODO: Remove this when users are directed to discover page after email confirmation
         */
        showVerifiedMessage: function () {
            return Boolean(parseQueryString().email_verified);
        },

        onRender: function () {
            this.activateRegion(this.connectedAccountsRegion, this.createConnectedAccountsView);
            this.activateRegion(this.formRegion, this.createFormView);
            this.activateRegion(this.deleteRegion, this.createDeleteFormView);
        },

        createFormView: function () {
            return new SettingsAccountFormView({
                el: this.formRegion.el,
                model: this.model,
            });
        },

        createDeleteFormView: function () {
            return new SettingsDeleteFormView({
                el: this.deleteRegion.el,
                session: this.session,
            });
        },

        createConnectedAccountsView: function () {
            return new SettingsConnectedAccountsView({
                el: this.connectedAccountsRegion.el,
                collection: this.model.socialAccounts,
            });
        },

    });

    withSubviews.call(SettingsAccountView.prototype);

    return SettingsAccountView;
});

define('home/templates/settingsEmail',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    return " checked";
},"3":function(container,depth0,helpers,partials,data) {
    return " checked=\"checked\"";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<form class=\"form\">\n<div class=\"form__header--mobile visible-md\">\n<a href=\"/home/settings/\" class=\"form__header--mobile-back\"><span class=\"icon-left-bracket\"></span></a>\n<h2>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Email Notifications",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":4,"column":4},"end":{"line":4,"column":37}}}))
    + "</h2>\n</div>\n<div class=\"form__header\">\n<h1 class=\"form-heading hidden-md\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Email Notifications",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":7,"column":35},"end":{"line":7,"column":68}}}))
    + "</h1>\n<p class=\"form-description text-gray text-medium\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Control the emails %(Disqus)s sends you.",{"name":"gettext","hash":{"Disqus":"Disqus"},"data":data,"loc":{"start":{"line":8,"column":50},"end":{"line":8,"column":122}}}))
    + "</p>\n</div>\n<div class=\"form__content\">\n<div class=\"fieldset\" role=\"group\">\n<div class=\"fieldset__label align__item text-gray\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Enable Emails",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":12,"column":51},"end":{"line":12,"column":78}}}))
    + "</div>\n<div class=\"fieldset__block align__item\">\n<div class=\"fieldset__block--checkbox\">\n<label class=\"text-medium\">\n<input type=\"checkbox\" name=\"receive_notifications\""
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"receive_notifications") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":16,"column":51},"end":{"line":16,"column":95}}})) != null ? stack1 : "")
    + ">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Receive emails from %(Disqus)s",{"name":"gettext","hash":{"Disqus":"Disqus"},"data":data,"loc":{"start":{"line":17,"column":0},"end":{"line":17,"column":62}}}))
    + "\n</label>\n</div>\n</div>\n</div>\n<div class=\"fieldset\" role=\"group\" data-role=\"notification\">\n<div class=\"fieldset__label align__item text-gray\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Digests",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":23,"column":51},"end":{"line":23,"column":72}}}))
    + "</div>\n<div class=\"fieldset__block align__item\">\n<div class=\"fieldset__block--checkbox\">\n<label class=\"text-medium\">\n<input type=\"checkbox\" name=\"receive_digests\""
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,lookupProperty(helpers,"ne").call(alias1,(depth0 != null ? lookupProperty(depth0,"digest_frequency") : depth0),(depth0 != null ? lookupProperty(depth0,"FREQUENCY_NEVER") : depth0),{"name":"ne","hash":{},"data":data,"loc":{"start":{"line":27,"column":51},"end":{"line":27,"column":88}}}),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":27,"column":45},"end":{"line":27,"column":105}}})) != null ? stack1 : "")
    + ">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Receive %(Disqus)s Digest emails",{"name":"gettext","hash":{"Disqus":"Disqus"},"data":data,"loc":{"start":{"line":28,"column":0},"end":{"line":28,"column":64}}}))
    + "\n</label>\n</div>\n<div class=\"fieldset__block--radio\" data-role=\"notification-digest\">\n<label class=\"text-medium\">\n<input type=\"radio\" name=\"digest_frequency\" value=\"daily\""
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,lookupProperty(helpers,"eq").call(alias1,(depth0 != null ? lookupProperty(depth0,"digest_frequency") : depth0),"daily",{"name":"eq","hash":{},"data":data,"loc":{"start":{"line":33,"column":63},"end":{"line":33,"column":92}}}),{"name":"if","hash":{},"fn":container.program(3, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":33,"column":57},"end":{"line":33,"column":119}}})) != null ? stack1 : "")
    + ">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Daily",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":34,"column":0},"end":{"line":34,"column":19}}}))
    + "\n</label>\n</div>\n<div class=\"fieldset__block--radio\" data-role=\"notification-digest\">\n<label class=\"text-medium\">\n<input type=\"radio\" name=\"digest_frequency\" value=\"weekly\""
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,lookupProperty(helpers,"eq").call(alias1,(depth0 != null ? lookupProperty(depth0,"digest_frequency") : depth0),"weekly",{"name":"eq","hash":{},"data":data,"loc":{"start":{"line":39,"column":64},"end":{"line":39,"column":94}}}),{"name":"if","hash":{},"fn":container.program(3, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":39,"column":58},"end":{"line":39,"column":121}}})) != null ? stack1 : "")
    + ">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Weekly",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":40,"column":0},"end":{"line":40,"column":20}}}))
    + "\n</label>\n</div>\n<p class=\"fieldset__description text-gray text-small\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Digests give you a daily or weekly view of activity on %(Disqus)s, customized for you. Visit the %(digestFaq)s to learn more.",{"name":"gettext","hash":{"digestFaq":lookupProperty(helpers,"tag").call(alias1,"a",{"name":"tag","hash":{"text":lookupProperty(helpers,"gettext").call(alias1,"Digest FAQ",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":45,"column":137},"end":{"line":45,"column":159}}}),"target":"blank","href":"https://help.disqus.com/customer/portal/articles/808919-disqus-digests"},"data":data,"loc":{"start":{"line":45,"column":30},"end":{"line":45,"column":160}}}),"Disqus":"Disqus"},"data":data,"loc":{"start":{"line":44,"column":0},"end":{"line":46,"column":2}}}))
    + "\n</p>\n</div>\n</div>\n<div class=\"fieldset\" role=\"group\" data-role=\"notification\">\n<div class=\"fieldset__label align__item text-gray\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Welcome",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":51,"column":51},"end":{"line":51,"column":72}}}))
    + "</div>\n<div class=\"fieldset__block align__item\">\n<div class=\"fieldset__block--checkbox\">\n<label class=\"text-medium\">\n<input type=\"checkbox\" name=\"receive_welcome_emails\""
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"receive_welcome_emails") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":55,"column":52},"end":{"line":55,"column":97}}})) != null ? stack1 : "")
    + ">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Receive a welcome email when commenting on a %(Disqus)s site for the first time",{"name":"gettext","hash":{"Disqus":"Disqus"},"data":data,"loc":{"start":{"line":56,"column":0},"end":{"line":56,"column":111}}}))
    + "\n</label>\n</div>\n</div>\n</div>\n<div class=\"fieldset\" role=\"group\" data-role=\"notification\">\n<div class=\"fieldset__label align__item text-gray\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Replies",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":62,"column":51},"end":{"line":62,"column":72}}}))
    + "</div>\n<div class=\"fieldset__block align__item\">\n<div class=\"fieldset__block--checkbox\">\n<label class=\"text-medium\">\n<input type=\"checkbox\" name=\"replies_to_comments\""
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"replies_to_comments") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":66,"column":49},"end":{"line":66,"column":91}}})) != null ? stack1 : "")
    + ">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Receive an email when someone replies to your comments",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":67,"column":0},"end":{"line":67,"column":68}}}))
    + "\n</label>\n</div>\n</div>\n</div>\n<div class=\"fieldset\" role=\"group\" data-role=\"notification\">\n<div class=\"fieldset__label align__item text-gray\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Subscribe",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":73,"column":51},"end":{"line":73,"column":74}}}))
    + "</div>\n<div class=\"fieldset__block align__item\">\n<div class=\"fieldset__block--checkbox\">\n<label class=\"text-medium\">\n<input type=\"checkbox\" name=\"subscribe_thread_on_post\""
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"subscribe_thread_on_post") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":77,"column":54},"end":{"line":77,"column":101}}})) != null ? stack1 : "")
    + ">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Subscribe automatically to discussions you comment on",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":78,"column":0},"end":{"line":78,"column":67}}}))
    + "\n</label>\n</div>\n<p class=\"fieldset__description text-gray text-small\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"You'll get an email for every new comment on discussions you're subscribed to.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":81,"column":54},"end":{"line":81,"column":147}}}))
    + "</p>\n</div>\n</div>\n</div>\n<div class=\"form__footer\">\n<div class=\"fieldset\" role=\"group\">\n<div class=\"fieldset__label\" data-role=\"save-status\"><div class=\"spinner-small\"></div><div class=\"icon-checkmark\"></div></div>\n<div class=\"fieldset__block\"><button class=\"button button-fill--brand button-padding-wider text-medium\" data-role=\"save-btn\" disabled>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Save",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":88,"column":134},"end":{"line":88,"column":152}}}))
    + "</button></div>\n</div>\n</div>\n</form>\n";
},"useData":true})

});
define('home/views/SettingsEmailView',[
    'jquery',
    'underscore',

    'home/models/SettingsEmailNotifications',
    'home/templates/settingsEmail',
    'home/views/common/BaseSettingsView',
], function (
    $,
    _,

    SettingsEmailNotifications,
    settingsEmailTemplate,
    BaseSettingsView
) {
    'use strict';

    var SettingsEmailView = BaseSettingsView.extend({
        template: settingsEmailTemplate,

        events: _.defaults({
            'change input[name=receive_notifications]': 'receiveNotificationsChangeHandler',
            'change input[name=receive_digests]': 'receiveDigestsChangeHandler',
        }, BaseSettingsView.prototype.events),

        templateHelpers: function () {
            return {
                FREQUENCY_NEVER: SettingsEmailNotifications.FREQUENCY_NEVER,
            };
        },

        receiveDigestsChangeHandler: function (ev) {
            this.updateDigestsDisplay($(ev.originalEvent.target).is(':checked'));
        },

        receiveNotificationsChangeHandler: function (ev) {
            this.updateNotificationsDisplay($(ev.originalEvent.target).is(':checked'));
        },

        onDomRefresh: function () {
            this.updateNotificationsDisplay(this.model.get('receive_notifications'));
            this.updateDigestsDisplay(this.shouldReceiveDigests());
        },

        shouldReceiveDigests: function () {
            var digestFrequency = this.model.get('digest_frequency');
            return digestFrequency && digestFrequency !== SettingsEmailNotifications.FREQUENCY_NEVER;
        },

        updateDigestsDisplay: function (receiveDigests) {
            var $digestElems = this.$el.find('[data-role=notification-digest]');
            if (receiveDigests) {
                $digestElems.show();
                this.setDefaultDigestFrequency();
            } else {
                $digestElems.hide();
            }
        },

        setDefaultDigestFrequency: function () {
            if (!this.$el.find('input[name=digest_frequency]:checked').val())
                this.$el.find('input[name=digest_frequency][value=daily]').attr('checked', 'checked');
        },

        updateNotificationsDisplay: function (receiveNotifications) {
            var $notificationElems = this.$el.find('[data-role=notification]');
            if (receiveNotifications)
                $notificationElems.removeClass('fieldset--hidden');
            else
                $notificationElems.addClass('fieldset--hidden');
        },

        getFormData: function () {
            var data = BaseSettingsView.prototype.getFormData.apply(this, arguments);

            // explicity set checkbox fields to true or false so that
            // the model is updated correctly
            data.receive_notifications = Boolean(data.receive_notifications);
            data.receive_welcome_emails = Boolean(data.receive_welcome_emails);
            data.replies_to_comments = Boolean(data.replies_to_comments);
            data.subscribe_thread_on_post = Boolean(data.subscribe_thread_on_post);

            // if user uncheck's receive_digests, set digest_frequency to never
            data.digest_frequency = data.receive_digests ? data.digest_frequency : SettingsEmailNotifications.FREQUENCY_NEVER;
            return data;
        },
    });

    return SettingsEmailView;
});

define('home/templates/settingsWeb',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    return "checked";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<form class=\"form\">\n<div class=\"form__header--mobile visible-md\">\n<a href=\"/home/settings/\" class=\"form__header--mobile-back\"><span class=\"icon-left-bracket\"></span></a>\n<h2>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Web Notifications",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":4,"column":4},"end":{"line":4,"column":35}}}))
    + "</h2>\n</div>\n<div class=\"form__header\">\n<h1 class=\"form-heading hidden-md\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Web Notifications",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":7,"column":35},"end":{"line":7,"column":66}}}))
    + "</h1>\n<p class=\"form-description text-gray text-medium\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Control what %(Disqus)s notifies you about in your %(inbox)s. Looking for email instead? Go to %(emailNotifications)s.",{"name":"gettext","hash":{"Disqus":"Disqus","emailNotifications":lookupProperty(helpers,"tag").call(alias1,"a",{"name":"tag","hash":{"text":lookupProperty(helpers,"gettext").call(alias1,"Email Notifications",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":11,"column":106},"end":{"line":11,"column":137}}}),"data-tab":"email","data-action":"switch-tab","href":"/home/settings/email/"},"data":data,"loc":{"start":{"line":11,"column":21},"end":{"line":11,"column":138}}}),"inbox":lookupProperty(helpers,"tag").call(alias1,"a",{"name":"tag","hash":{"text":lookupProperty(helpers,"gettext").call(alias1,"Notifications",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":10,"column":42},"end":{"line":10,"column":67}}}),"href":"/home/inbox/"},"data":data,"loc":{"start":{"line":10,"column":8},"end":{"line":10,"column":68}}})},"data":data,"loc":{"start":{"line":9,"column":0},"end":{"line":13,"column":2}}}))
    + "\n</p>\n</div>\n<div class=\"form__content\">\n<div class=\"fieldset\" role=\"group\">\n<div class=\"fieldset__label align__item text-gray\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Notify you when",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":18,"column":51},"end":{"line":18,"column":80}}}))
    + "</div>\n<div class=\"fieldset__block align__item\">\n<div class=\"fieldset__block--checkbox\">\n<label class=\"text-medium\">\n<input data-role=\"filter-checkbox\" data-filter=\"likepost\" type=\"checkbox\" name=\"show-upvote-notification\" value=\"likepost\" "
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"showUpvoteNotification") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":22,"column":123},"end":{"line":22,"column":167}}})) != null ? stack1 : "")
    + ">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Someone upvotes your comment",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":23,"column":0},"end":{"line":23,"column":42}}}))
    + "\n</label>\n</div>\n<div class=\"fieldset__block--checkbox\">\n<label class=\"text-medium\">\n<input data-role=\"filter-checkbox\" data-filter=\"invite\" type=\"checkbox\" name=\"show-invite-notification\" value=\"invite\" "
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"showInviteNotification") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":28,"column":119},"end":{"line":28,"column":163}}})) != null ? stack1 : "")
    + ">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Someone invites you to a discussion",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":29,"column":0},"end":{"line":29,"column":49}}}))
    + "\n</label>\n</div>\n<div class=\"fieldset__block--checkbox\">\n<label class=\"text-medium\">\n<input data-role=\"filter-checkbox\" data-filter=\"favoritethread\" type=\"checkbox\" name=\"show-recommend-notification\" value=\"favoritethread\" "
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"showRecommendNotification") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":34,"column":138},"end":{"line":34,"column":185}}})) != null ? stack1 : "")
    + ">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Someone recommends a discussion you started",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":35,"column":0},"end":{"line":35,"column":57}}}))
    + "\n</label>\n</div>\n<div class=\"fieldset__block--checkbox\">\n<label class=\"text-medium\">\n<input data-role=\"filter-checkbox\" data-filter=\"threadreplies\" type=\"checkbox\" name=\"show-threadreplies-notification\" value=\"threadreplies\" "
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"showThreadRepliesNotification") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":40,"column":140},"end":{"line":40,"column":191}}})) != null ? stack1 : "")
    + ">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Someone comments on a discussion you started",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":41,"column":0},"end":{"line":41,"column":58}}}))
    + "\n</label>\n</div>\n<div class=\"fieldset__block--checkbox\">\n<label class=\"text-medium\">\n<input data-role=\"filter-checkbox\" data-filter=\"mentions\" type=\"checkbox\" name=\"show-mentions-notification\" value=\"mentions\" "
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"showMentionsNotification") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":46,"column":125},"end":{"line":46,"column":171}}})) != null ? stack1 : "")
    + ">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Someone mentions you in a discussion",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":47,"column":0},"end":{"line":47,"column":50}}}))
    + "\n</label>\n</div>\n</div>\n</div>\n</div>\n<div class=\"form__footer\">\n<div class=\"fieldset\" role=\"group\">\n<div class=\"fieldset__label\" data-role=\"save-status\"><div class=\"spinner-small\"></div><div class=\"icon-checkmark\"></div></div>\n<div class=\"fieldset__block\"><button class=\"button button-fill--brand button-padding-wider text-medium\" disabled data-role=\"save-btn\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Save",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":56,"column":134},"end":{"line":56,"column":152}}}))
    + "</button></div>\n</div>\n</div>\n</form>\n";
},"useData":true})

});
define('home/views/SettingsWebView',[
    'jquery',
    'underscore',
    'backbone-marionette',

    'home/mixins/withFetchingView',
    'home/models/TimelineFilter',
    'home/templates/settingsWeb',
], function (
    $,
    _,
    Marionette,

    withFetchingView,
    TimelineFilter,
    settingsWebTemplate
) {
    'use strict';

    var SettingsWebView = Marionette.ItemView.extend({
        events: {
            'submit form': 'submitHandler',
            'change input[type=checkbox]': 'changeHandler',
        },

        template: settingsWebTemplate,

        initialize: function () {
            this.listenToOnce(this.collection, 'reset', this.doneFetching);
            this.listenTo(this.collection, 'sync', this.render);
        },

        templateHelpers: function () {
            return {
                showUpvoteNotification: !this.collection.get(TimelineFilter.FILTER_LIKEPOST),
                showInviteNotification: !this.collection.get(TimelineFilter.FILTER_INVITE),
                showRecommendNotification: !this.collection.get(TimelineFilter.FILTER_RECOMMEND),
                showThreadRepliesNotification: !this.collection.get(TimelineFilter.FILTER_THREADREPLIES),
                showMentionsNotification: !this.collection.get(TimelineFilter.FILTER_MENTIONS),
            };
        },

        onRender: function () {
            this.$form = this.$('form');
            this.$checkboxes = this.$form.find('[data-role=filter-checkbox]');
            this.$saveStatus = this.$('[data-role=save-status]');
            this.saveBtn = this.$('[data-role=save-btn]')[0];
        },

        changeHandler: function () {
            var changed = _.chain(this.$checkboxes)
                           .filter(this.hasFilterChanged, this)
                           .value();
            this.saveBtn.disabled = !changed.length;
        },

        doneFetching: function () {
            this.collection.fetched = true;
        },

        isDoneFetching: function () {
            return this.collection.fetched;
        },

        submitHandler: function (ev) {
            ev.preventDefault();

            this.updateStatus('is-saving');

            var promises = _.chain(this.$checkboxes)
                            .filter(this.hasFilterChanged, this)
                            .map(this.updateFilter, this)
                            .value();

            $.when.apply($, promises).done(_.bind(this.updateStatus, this, 'is-saved'));
        },

        hasFilterChanged: function (checkbox) {
            var $checkbox = $(checkbox);
            var showNotification = $checkbox.is(':checked');
            var filterExists = this.collection.get($checkbox.attr('data-filter'));
            return (showNotification && filterExists) || (!showNotification && !filterExists);
        },

        updateFilter: function (checkbox) {
            var $checkbox = $(checkbox);
            var method = $checkbox.is(':checked') ? 'removeFilter' : 'addFilter';
            return this.collection[method]($checkbox.attr('data-filter'));
        },

        updateStatus: function (status) {
            this.$el.find('[data-role=save-status]')
                    .removeClass('is-saving is-saved')
                    .addClass(status);
        },

    });

    withFetchingView.call(SettingsWebView.prototype);

    return SettingsWebView;
});

define('home/templates/settingsApps',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"fieldset\" role=\"group\" data-role=\"app-field\">\n<div class=\"fieldset__label align__item text-gray\">"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"name") : depth0), depth0))
    + "</div>\n<div class=\"fieldset__block align__item\">\n<div class=\"fieldset__block--button\">\n<button class=\"button button-fill--brand text-medium\" data-action='revoke-app' data-app-id='"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"id") : depth0), depth0))
    + "'>"
    + alias2(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"Revoke Access",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":16,"column":105},"end":{"line":16,"column":132}}}))
    + "</button>\n</div>\n</div>\n</div>\n";
},"3":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<p class=\"form-description text-gray text-medium\">"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"You haven't given access to any applications yet.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":21,"column":50},"end":{"line":21,"column":113}}}))
    + "</p>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"form\">\n<div class=\"form__header--mobile visible-md\">\n<a href=\"/home/settings/\" class=\"form__header--mobile-back\"><span class=\"icon-left-bracket\"></span></a>\n<h2>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Apps",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":4,"column":4},"end":{"line":4,"column":22}}}))
    + "</h2>\n</div>\n<div class=\"form__header\">\n<h1 class=\"form-heading hidden-md\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Apps",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":7,"column":35},"end":{"line":7,"column":53}}}))
    + "</h1>\n<p class=\"form-description text-gray text-medium\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Control what apps can access your %(Disqus)s account.",{"name":"gettext","hash":{"Disqus":"Disqus"},"data":data,"loc":{"start":{"line":8,"column":50},"end":{"line":8,"column":135}}}))
    + "</p>\n</div>\n<div class=\"form__content\">\n"
    + ((stack1 = lookupProperty(helpers,"each").call(alias1,(depth0 != null ? lookupProperty(depth0,"items") : depth0),{"name":"each","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"data":data,"loc":{"start":{"line":11,"column":0},"end":{"line":22,"column":9}}})) != null ? stack1 : "")
    + "</div>\n</div>\n";
},"useData":true})

});
define('home/views/SettingsAppsView',[
    'jquery',
    'backbone-marionette',

    'core/strings',

    'home/mixins/withFetchingView',
    'home/templates/settingsApps',
], function (
    $,
    Marionette,

    strings,

    withFetchingView,
    settingsAppsTemplate
) {
    'use strict';

    var gettext = strings.get;

    var SettingsAppsView = Marionette.ItemView.extend({
        events: {
            'click [data-action=revoke-app]': 'revokeAppHandler',
        },

        template: settingsAppsTemplate,

        initialize: function () {
            this.listenToOnce(this.collection, 'reset', this.doneFetching);
            this.listenTo(this.collection, 'reset remove', this.render);
        },

        doneFetching: function () {
            this.collection.fetched = true;
        },

        isDoneFetching: function () {
            return this.collection.fetched;
        },

        revokeAppHandler: function (ev) {
            var appId = $(ev.originalEvent.target).attr('data-app-id');
            var app = this.collection.get(appId);

            if (!app)
                return;

            var confirmationMsg = strings.interpolate(
                gettext('Revoke access for %(appName)s?'),
                { appName: app.get('name') }
            );

            if (!window.confirm(confirmationMsg))
                return;

            app.destroy({
                wait: true,
            });
        },
    });

    withFetchingView.call(SettingsAppsView.prototype);

    return SettingsAppsView;
});

define('home/templates/settingsModeration',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"fieldset\" role=\"group\">\n<div class=\"fieldset__label align__item text-gray\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Receive email notifications for comments that are",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":17,"column":51},"end":{"line":17,"column":114}}}))
    + "</div>\n<div class=\"fieldset__block align__item\">\n<div class=\"fieldset__block--checkbox\">\n<label class=\"text-medium\">\n<input type=\"checkbox\" name=\"receive_approved\""
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"disable_approved") : depth0),{"name":"unless","hash":{},"fn":container.program(2, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":21,"column":46},"end":{"line":21,"column":93}}})) != null ? stack1 : "")
    + ">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Newly posted",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":22,"column":0},"end":{"line":22,"column":26}}}))
    + "\n</label>\n</div>\n<div class=\"fieldset__block--checkbox\">\n<label class=\"text-medium\">\n<input type=\"checkbox\" name=\"receive_unapproved\""
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"receive_unapproved") : depth0),{"name":"if","hash":{},"fn":container.program(2, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":27,"column":48},"end":{"line":27,"column":89}}})) != null ? stack1 : "")
    + ">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Pending (waiting for moderation)",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":28,"column":0},"end":{"line":28,"column":46}}}))
    + "\n</label>\n</div>\n<div class=\"fieldset__block--checkbox\">\n<label class=\"text-medium\">\n<input type=\"checkbox\" name=\"receive_spam\""
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"receive_spam") : depth0),{"name":"if","hash":{},"fn":container.program(2, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":33,"column":42},"end":{"line":33,"column":77}}})) != null ? stack1 : "")
    + ">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Marked as spam",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":34,"column":0},"end":{"line":34,"column":28}}}))
    + "\n</label>\n</div>\n</div>\n</div>\n<div class=\"fieldset\" role=\"group\">\n<div class=\"fieldset__label align__item text-gray\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Sites to receive emails for",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":40,"column":51},"end":{"line":40,"column":92}}}))
    + "</div>\n<div class=\"fieldset__block align__item\">\n"
    + ((stack1 = lookupProperty(helpers,"each").call(alias1,(depth0 != null ? lookupProperty(depth0,"forum_subscriptions") : depth0),{"name":"each","hash":{},"fn":container.program(4, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":42,"column":0},"end":{"line":49,"column":9}}})) != null ? stack1 : "")
    + "</div>\n</div>\n</div>\n<div class=\"form__footer\">\n<div class=\"fieldset\" role=\"group\">\n<div class=\"fieldset__label\" data-role=\"save-status\"><div class=\"spinner-small\"></div><div class=\"icon-checkmark\"></div></div>\n<div class=\"fieldset__block\"><button class=\"button button-fill--brand button-padding-wider text-medium\" data-role=\"save-btn\" disabled>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Save",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":56,"column":134},"end":{"line":56,"column":152}}}))
    + "</button></div>\n</div>\n</div>\n";
},"2":function(container,depth0,helpers,partials,data) {
    return " checked";
},"4":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"fieldset__block--checkbox\">\n<label class=\"text-medium\">\n<input type=\"checkbox\" name=\"forum_"
    + alias2(alias1((data && lookupProperty(data,"key")), depth0))
    + "\""
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"subscribed") : depth0),{"name":"if","hash":{},"fn":container.program(2, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":45,"column":44},"end":{"line":45,"column":82}}})) != null ? stack1 : "")
    + ">\n"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"name") : depth0), depth0))
    + " ("
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"url") : depth0), depth0))
    + ")\n</label>\n</div>\n";
},"6":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<p class=\"form-description text-gray text-medium\">\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(alias1,"You aren't moderating any sites. To add a new site, %(addSite)s.",{"name":"gettext","hash":{"addSite":lookupProperty(helpers,"tag").call(alias1,"a",{"name":"tag","hash":{"text":lookupProperty(helpers,"gettext").call(alias1,"go here",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":62,"column":109},"end":{"line":62,"column":128}}}),"target":"_blank","href":"https://publishers.disqus.com/engage?utm_source=Home-Settings"},"data":data,"loc":{"start":{"line":62,"column":10},"end":{"line":62,"column":129}}})},"data":data,"loc":{"start":{"line":61,"column":0},"end":{"line":63,"column":2}}}))
    + "\n</p>\n\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<form class=\"form\">\n<div class=\"form__header--mobile visible-md\">\n<a href=\"/home/settings/\" class=\"form__header--mobile-back\"><span class=\"icon-left-bracket\"></span></a>\n<h2>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Moderation",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":4,"column":4},"end":{"line":4,"column":28}}}))
    + "</h2>\n</div>\n<div class=\"form__header\">\n<h1 class=\"form-heading hidden-md\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Moderation",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":7,"column":35},"end":{"line":7,"column":59}}}))
    + "</h1>\n<p class=\"form-description text-gray text-medium\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Control which moderation email notifications you receive for sites you moderate. To moderate comments posted on your site and adjust your site's settings, visit your %(moderatorLink)s.",{"name":"gettext","hash":{"moderatorLink":lookupProperty(helpers,"tag").call(alias1,"a",{"name":"tag","hash":{"text":lookupProperty(helpers,"gettext").call(alias1,"moderation panel",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":10,"column":45},"end":{"line":10,"column":73}}}),"href":"/admin/"},"data":data,"loc":{"start":{"line":10,"column":16},"end":{"line":10,"column":74}}})},"data":data,"loc":{"start":{"line":9,"column":0},"end":{"line":11,"column":2}}}))
    + "\n</p>\n</div>\n<div class=\"form__content\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"moderatesForums") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(6, data, 0),"data":data,"loc":{"start":{"line":15,"column":0},"end":{"line":66,"column":7}}})) != null ? stack1 : "")
    + "</form>\n";
},"useData":true})

});
define('home/views/SettingsModerationView',[
    'jquery',
    'underscore',

    'home/templates/settingsModeration',
    'home/views/common/BaseSettingsView',
], function (
    $,
    _,

    settingsModerationTemplate,
    BaseSettingsView
) {
    'use strict';

    var SettingsModerationView = BaseSettingsView.extend({
        template: settingsModerationTemplate,

        templateHelpers: function () {
            return {
                moderatesForums: !_.isEmpty(this.model.get('forum_subscriptions')),
            };
        },

        getFormData: function () {
            var data = BaseSettingsView.prototype.getFormData.apply(this, arguments);

            // explicitly set checkbox fields to true or false so that
            // the model is updated correctly
            data.receive_unapproved = Boolean(data.receive_unapproved);
            data.receive_spam = Boolean(data.receive_spam);

            // This is displayed in the html form as a 'receive_approved' checkbox,
            // and we have to flip it to get the correct value for disable_approved
            data.disable_approved = !data.receive_approved;

            // use $.extend to deep copy so that nested objects are not referenced in the new object
            // and changing the subscribed attribute won't be reflected in the model
            var forumSubscriptions = $.extend(true, {}, this.model.attributes.forum_subscriptions);

            _.each(forumSubscriptions, function (forum, forumId) {
                forum.subscribed = Boolean(data['forum_' + forumId]);

                // remove forum_* from data so it isn't set on the model
                delete data['forum_' + forumId];
            });

            data.forum_subscriptions = forumSubscriptions;

            return data;
        },
    });

    return SettingsModerationView;
});

define('home/templates/settings',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"aside__wrap -brand\">\n<div class=\"aside__content--settings text-center\">\n<img src=\""
    + alias2(lookupProperty(helpers,"urlfor").call(alias1,"cdn",{"name":"urlfor","hash":{},"data":data,"loc":{"start":{"line":87,"column":10},"end":{"line":87,"column":26}}}))
    + "/img/Pam_Settings.png\" width=\"170\" height=\"93\" />\n<h2 class=\"text-large\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Get more from Disqus",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":88,"column":23},"end":{"line":88,"column":57}}}))
    + "</h2>\n<p>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Follow channels for a personalized experience. Jump into channels to start your own discussion.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":89,"column":3},"end":{"line":89,"column":112}}}))
    + "</p>\n<p>\n<a href=\"/home/explore\" class=\"button button-inverted button-small button-padding-wider\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Find Channels To Join",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":91,"column":89},"end":{"line":91,"column":124}}}))
    + "</a>\n</p>\n</div>\n</div>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"section-contained\">\n<div class=\"layout layout--tablet-no-aside layout--mobile-flush settings--root\" data-role=\"settings-layout\">\n<div class=\"layout__main-with-aside\">\n<div class=\"layout__nav\">\n<ul class=\"nav-stacked\">\n<li data-action=\"switch-tab\" data-tab=\"profile\" class=\"nav__item active\">\n<a href=\"/home/settings/profile/\" class=\"nav-lnk -color-muted\">\n<div class=\"nav-lnk__blk\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Profile",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":9,"column":0},"end":{"line":9,"column":21}}}))
    + "\n</div>\n<div class=\"nav-lnk__pointer\">\n<span class=\"icon icon-right-bracket\"></span>\n</div>\n</a>\n</li>\n<li data-action=\"switch-tab\" data-tab=\"account\" class=\"nav__item\">\n<a href=\"/home/settings/account/\" class=\"nav-lnk -color-muted\">\n<div class=\"nav-lnk__blk\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Account",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":19,"column":0},"end":{"line":19,"column":21}}}))
    + "\n</div>\n<div class=\"nav-lnk__pointer\">\n<span class=\"icon icon-right-bracket\"></span>\n</div>\n</a>\n</li>\n<li data-action=\"switch-tab\" data-tab=\"email\" class=\"nav__item\">\n<a href=\"/home/settings/email/\" class=\"nav-lnk -color-muted\">\n<div class=\"nav-lnk__blk\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Email Notifications",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":29,"column":0},"end":{"line":29,"column":33}}}))
    + "\n</div>\n<div class=\"nav-lnk__pointer\">\n<span class=\"icon icon-right-bracket\"></span>\n</div>\n</a>\n</li>\n<li data-action=\"switch-tab\" data-tab=\"web\" class=\"nav__item\">\n<a href=\"/home/settings/web/\" class=\"nav-lnk -color-muted\">\n<div class=\"nav-lnk__blk\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Web Notifications",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":39,"column":0},"end":{"line":39,"column":31}}}))
    + "\n</div>\n<div class=\"nav-lnk__pointer\">\n<span class=\"icon icon-right-bracket\"></span>\n</div>\n</a>\n</li>\n<li data-action=\"switch-tab\" data-tab=\"apps\" class=\"nav__item\">\n<a href=\"/home/settings/apps/\" class=\"nav-lnk -color-muted\">\n<div class=\"nav-lnk__blk\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Apps",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":49,"column":0},"end":{"line":49,"column":18}}}))
    + "\n</div>\n<div class=\"nav-lnk__pointer\">\n<span class=\"icon icon-right-bracket\"></span>\n</div>\n</a>\n</li>\n<li data-action=\"switch-tab\" data-tab=\"moderation\" class=\"nav__item\">\n<a href=\"/home/settings/moderation/\" class=\"nav-lnk -color-muted\">\n<div class=\"nav-lnk__blk\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Moderation",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":59,"column":0},"end":{"line":59,"column":24}}}))
    + "\n</div>\n<div class=\"nav-lnk__pointer\">\n<span class=\"icon icon-right-bracket\"></span>\n</div>\n</a>\n</li>\n<li data-action=\"switch-tab\" data-tab=\"blocking\" class=\"nav__item\">\n<a href=\"/home/settings/blocking/\" class=\"nav-lnk -color-muted\">\n<div class=\"nav-lnk__blk\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Blocking",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":69,"column":0},"end":{"line":69,"column":22}}}))
    + "\n</div>\n<div class=\"nav-lnk__pointer\">\n<span class=\"icon icon-right-bracket\"></span>\n</div>\n</a>\n</li>\n</ul>\n</div>\n<div class=\"layout__content\">\n<div data-role=\"email-verification-alert\"></div>\n<div data-role=\"content-area\"></div>\n</div>\n</div>\n<aside class=\"layout__aside hidden-lg\">\n"
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"onboardingWithoutChannels") : depth0),{"name":"unless","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":84,"column":0},"end":{"line":95,"column":11}}})) != null ? stack1 : "")
    + "<div class=\"text-smaller text-gray\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"homeFooter"),depth0,{"name":"homeFooter","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n</aside>\n</div>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/SettingsLayout',[
    'underscore',

    'core/bus',
    'core/strings',

    'home/collections/SettingsAppCollection',
    'home/collections/SettingsBlockListCollection',

    'core/UniqueModel',
    'home/models/SettingsModeration',
    'home/models/SettingsProfile',
    'home/models/SettingsAccount',
    'home/models/SettingsEmailNotifications',
    'home/views/common/TabbedView',
    'home/views/SettingsBlockingView',
    'home/views/SettingsDeleteView',
    'home/views/SettingsProfileView',
    'home/views/SettingsMenuView',
    'home/views/SettingsAccountView',
    'home/views/SettingsEmailView',
    'home/views/SettingsWebView',
    'home/views/SettingsAppsView',
    'home/views/SettingsModerationView',
    'home/mixins/withEmailVerificationAlert',

    'home/templates/settings',

], function (
    _,

    bus,
    strings,

    SettingsAppCollection,
    SettingsBlockListCollection,

    UniqueModel,
    SettingsModeration,
    SettingsProfile,
    SettingsAccount,
    SettingsEmailNotifications,
    TabbedView,
    SettingsBlockingView,
    SettingsDeleteView,
    SettingsProfileView,
    SettingsMenuView,
    SettingsAccountView,
    SettingsEmailView,
    SettingsWebView,
    SettingsAppsView,
    SettingsModerationView,
    withEmailVerificationAlert,

    settingsTemplate
) {
    'use strict';

    var gettext = strings.get;

    var SettingsLayout = TabbedView.extend({
        defaultTab: 'menu',

        template: settingsTemplate,
        templateHelpers: function () {
            return {
                onboardingWithoutChannels: this.onboardingWithoutChannels,
            };
        },

        initialize: function (options) {
            this.session = options.session;
            this.user = this.session.user;
            this.onboardingWithoutChannels = options.onboardingWithoutChannels;

            // ensure these collections are created and fetched only once
            this.getSettingsAppCollection = _.once(this.getSettingsAppCollection);
            this.getNotificationFilters = _.once(this.getNotificationFilters);

            // Update layout's class on tab change so that we can vary css on mobile vs desktop:
            // Mobile:
            //  - for root settings page (/menu), only the left menu bar is shown
            //  - for each individual settings page, the left menu bar isn't shown
            // Desktop
            //  - for all settings pages, the left menu bar is always shown
            this.listenTo(this, 'change:activeTab', this.updateLayoutClass);

            this.listenTo(this, 'change:activeTab', this.trackOpenSection);

            TabbedView.prototype.initialize.apply(this, arguments);
        },

        updateLayoutClass: function () {
            this.$el.find('[data-role=settings-layout]')
                    .removeClass('settings--root settings--page')
                    .addClass(
                        this.activeTab === this.defaultTab ? 'settings--root' : 'settings--page'
                    );
        },

        getMetaAttrs: function () {
            return gettext('Settings');
        },

        getSettingsAppCollection: function () {
            var apps = new SettingsAppCollection();
            apps.fetch({ reset: true });
            return apps;
        },

        getNotificationFilters: function () {
            var notifications = this.session.getOrCreateNotifications();
            notifications.filters.fetch({ reset: true });
            return notifications.filters;
        },

        getSettingsBlockListCollection: function () {
            var blockList = new SettingsBlockListCollection();
            blockList.fetch();
            return blockList;
        },

        getTabView: function (activeTab) {
            switch (activeTab) {
            case 'menu':
                return new SettingsMenuView({
                    model: this.session.user,
                });
            case 'profile':
                return new SettingsProfileView({
                    model: new UniqueModel(
                        SettingsProfile,
                        { id: this.session.user.id }
                    ),
                });
            case 'account':
                return new SettingsAccountView({
                    session: this.session,
                    model: new UniqueModel(
                        SettingsAccount,
                        { id: this.session.user.id }
                    ),
                });
            case 'email':
                return new SettingsEmailView({
                    model: new UniqueModel(
                        SettingsEmailNotifications,
                        { id: this.session.user.id }
                    ),
                });
            case 'web':
                return new SettingsWebView({
                    collection: this.getNotificationFilters(),
                });
            case 'apps':
                return new SettingsAppsView({
                    collection: this.getSettingsAppCollection(),
                });
            case 'moderation':
                return new SettingsModerationView({
                    model: new UniqueModel(
                        SettingsModeration,
                        { id: this.session.user.id }
                    ),
                });
            case 'delete':
                return new SettingsDeleteView({
                    session: this.session,
                    model: new UniqueModel(
                        SettingsAccount,
                        { id: this.session.user.id }
                    ),
                });
            case 'blocking':
                return new SettingsBlockingView({
                    collection: this.getSettingsBlockListCollection(),
                });
            }
        },

        getTrackingSection: function (activeTab) {
            return activeTab;
        },

        trackOpenSection: function () {
            bus.trigger('openSection', this);
        },
    });

    withEmailVerificationAlert.call(SettingsLayout.prototype);

    return SettingsLayout;
});

define('home/templates/userChannels',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    return " hidden";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div data-role=\"email-verification-alert\"></div>\n\n<div class=\"spacing-bottom"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"hideManagedChannels") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":3,"column":26},"end":{"line":3,"column":67}}})) != null ? stack1 : "")
    + "\" data-role=\"managed-channels-wrapper\">\n<div class=\"card-wrap\" data-role=\"managed-channels\"></div>\n</div>\n\n<h2 class=\"text-subheading spacing-narrow\">"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(alias1,"Following",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":7,"column":43},"end":{"line":7,"column":66}}}))
    + "</h2>\n<div class=\"card-wrap\" data-role=\"followed-channels\"></div>\n";
},"useData":true})

});
define('home/views/UserChannelsView',[
    'underscore',
    'backbone-marionette',

    'home/mixins/withSubviews',
    'home/mixins/withEmailVerificationAlert',
    'home/views/ForumCardCollectionView',
    'home/views/ProfileFollowingCommunitiesEmptyView',

    'home/templates/userChannels',
], function (
    _,
    Marionette,

    withSubviews,
    withEmailVerificationAlert,
    ForumCardCollectionView,
    ProfileFollowingCommunitiesEmptyView,

    userChannelsTemplate
) {
    'use strict';

    /**
     * A view that shows the channels special to the given user; created, moderated,
     * or followed by.
     * Expects a UserProfile model
     */
    var UserChannelsView = Marionette.ItemView.extend({
        template: userChannelsTemplate,
        templateHelpers: function () {
            return {
                hideManagedChannels: this.shouldHideManagedChannels(),
            };
        },

        regions: {
            managedChannelsRegion: '[data-role=managed-channels]',
            followedChannelsRegion: '[data-role=followed-channels]',
        },

        initialize: function () {
            // Show/hide the managed channels section based on whether or not the collection is empty
            this.listenTo(this.model.managedChannels.items, 'reset add', function () {
                this.$('[data-role=managed-channels-wrapper]').toggleClass('hidden', this.shouldHideManagedChannels());
            });
        },

        shouldHideManagedChannels: function () {
            return this.model.managedChannels.items.length === 0;
        },

        onRender: function () {
            this.activateRegion(this.managedChannelsRegion, _.partial(this.createChannelsView, this.model.managedChannels));
            this.activateRegion(this.followedChannelsRegion, _.partial(this.createFollowedChannelsView, this.model.followedChannels));
        },

        // Adds additional interactions/visuals for the following channels feed that are
        // not necessary for the managed channels feed.
        createFollowedChannelsView: function (channelFeed) {
            return this.createChannelsView(channelFeed, {
                infiniteScroll: true,
                emptyView: ProfileFollowingCommunitiesEmptyView,
            });
        },

        // Creates a basic view to list channels in the given feed.
        createChannelsView: function (channelFeed, options) {
            return new ForumCardCollectionView(_.extend({
                user: this.model.user,
                model: channelFeed,
                collection: channelFeed.items,
            }, options));
        },
    });

    withSubviews.call(UserChannelsView.prototype);
    withEmailVerificationAlert.call(UserChannelsView.prototype);

    return UserChannelsView;
});

define('home/templates/channels',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    return "<div class=\"section-contained\">\n<div class=\"layout layout--tablet-no-aside\">\n<div class=\"layout__main-with-aside\">\n<section data-role=\"content-area\" class=\"spacing-bottom-large\"></section>\n</div>\n<div class=\"layout__aside hidden-lg\">\n<section data-role=\"recommend-module\" data-recommend-type=\"forum\" class=\"module--aside\"></section>\n<section data-role=\"recommend-module\" data-recommend-type=\"channel\" class=\"module--aside\"></section>\n<section data-role=\"recommend-module\" data-recommend-type=\"user\" class=\"module--aside\"></section>\n</div>\n</div>\n</div>\n";
},"useData":true})

});
define('home/views/ChannelsView',[
    'underscore',
    'backbone',
    'backbone-marionette',

    'core/strings',

    'home/models/Session',
    'home/views/RecommendationsModuleView',
    'home/views/UserChannelsView',
    'home/views/HomepageChannelsModuleView',

    'home/mixins/withEmailConfirmedModal',
    'home/mixins/withSubviews',

    'home/templates/channels',
], function (
    _,
    Backbone,
    Marionette,

    strings,

    Session,
    RecommendationsModuleView,
    UserChannelsView,
    HomepageChannelsModuleView,

    withEmailConfirmedModal,
    withSubviews,

    channelsTemplate
) {
    'use strict';

    var gettext = strings.get;

    /**
     * The view that shows for the Channels section in the nav.
     * Shows a list of channels of interest to the logged in user:
     * followed channels and managed channels.
     *
     * Expects a ChannelsViewModel
     * Expects the user to be logged in. Main content area is empty
     * for anon users.
     */
    var ChannelsView = Marionette.ItemView.extend({
        template: channelsTemplate,

        regions: {
            recommendedUsersModuleRegion: '[data-role=recommend-module][data-recommend-type=user]',
            recommendedChannelsModuleRegion: '[data-role=recommend-module][data-recommend-type=channel]',
            contentRegion: '[data-role=content-area]',
        },

        initialize: function () {
            var session = Session.get();
            session.loadPromise().always(_.bind(this.render, this));
        },

        onRender: function () {
            this.activateRegion(this.contentRegion, this.createContentView);
            // would check this.options.onboardingWithoutChannels here and not render the channels content
            // but this page is already channels doesn't make much difference here.
            this.activateRegion(this.recommendedUsersModuleRegion, this.createUserRecommendedModuleView);

            this.model.promotedChannels.ensureFetched().then(_.bind(function () {
                var filteredChannels = this.model.promotedChannels
                    .chain()
                    .reject(function (channel) {
                        return channel.primaryForum.get('isFollowing');
                    })
                    .shuffle()
                    .value();

                if (filteredChannels.length) {
                    // Only show channels module if there are some Channels
                    // the user hasn't followed yet.
                    this.activateRegion(this.recommendedChannelsModuleRegion,
                        _.bind(this.createChannelRecommendedModuleView, this, filteredChannels));
                }
            }, this));
        },

        createContentView: function () {
            return new UserChannelsView({
                model: this.model.sessionUserProfile,
            });
        },

        createUserRecommendedModuleView: function () {
            return RecommendationsModuleView.createUserRecommendedModuleView({
                model: this.model.interestingUsers,
            });
        },

        createChannelRecommendedModuleView: function (filteredChannels) {
            return new HomepageChannelsModuleView({
                collection: new Backbone.Collection(filteredChannels),
            });
        },

        getMetaAttrs: function () {
            return gettext('Channels');
        },
    });

    withEmailConfirmedModal.call(ChannelsView.prototype);
    withSubviews.call(ChannelsView.prototype);

    return ChannelsView;
});

define('core/constants/exploreModuleConstants',[
    'core/strings',
], function (
    strings
) {
    'use strict';

    var gettext = strings.get;

    return {
        TABS: {
            TOP: {
                id: 'top',
                name: gettext('Trending'),
                fetchName: 'trending',
            },
            POPULAR: {
                id: 'popular',
                name: gettext('Popular'),
                fetchName: 'popular',
            },
            RECENT: {
                id: 'recent',
                name: gettext('Newest'),
                fetchName: 'new',
            },
            DISCUSSIONS: {
                id: 'discussions',
                name: gettext('Discussions'),
            },
        },
    };
});

define('home/views/HideOnEndFooterView',[
    'home/views/common/FetchableCollectionFooterView',
], function (
    FetchableCollectionFooterView
) {
    'use strict';

    /**
     * A FetchableCollectionFooterView that only shows while there are
     * more pages to fetch. It will show a more button to kick off
     * another page load, and it will show a spinner while the next
     * page is being fetched. Once there are no more pages to fetch,
     * it will be hidden.
     */
    var HideOnEndFooterView = FetchableCollectionFooterView.extend({
        endOfItemsTemplate: function () {
            return '';
        },
    });

    return HideOnEndFooterView;
});

define('home/models/ChannelGroupProfile',[
    'underscore',
    'backbone',

    'core/api',
    'core/UniqueModel',

    'home/models/Channel',
    'home/models/Feed',
    'home/collections/FeedItemCollection',
    'home/collections/ChannelCollection',
], function (
    _,
    Backbone,

    api,
    UniqueModel,

    Channel,
    Feed,
    FeedItemCollection,
    ChannelCollection
) {
    'use strict';

    /**
     * A ChannelGroup and its feeds.
     *
     * Since a ChannelGroup is currently backed by a Channel, ChannelGroups
     * should be 1-to-1 with a Channel model.
     */
    var ChannelGroupProfile = Backbone.Model.extend({
        initialize: function (_attributes, options) {
            options = options || {};

            // The special instance of the ChannelGroupProfile that contains
            // content accross all channel groups, as indicated by a specific
            // id, does not have a single channel
            if (this.id && this.id !== this.constructor.ALL_CHANNEL_GROUPS_PROFILE_ID) {
                this.initializeRelated(
                    'channel',
                    options,
                    Channel
                );
            }

            this.rankedChannels = _.chain(this.constructor.RANKINGS)
                .map(function (ranking) {
                    var feed = new Feed({
                        fetchOptions: {
                            name: ranking.name,
                            channel: this.channel && this.channel.id,
                            attach: 'counters',
                        },
                    }, {
                        collectionClass: ChannelCollection,
                        collectionUrl: api.getURL('channels/listRanked'),
                    });

                    return [ranking.id, feed];
                }, this)
                .object()
                .value();

            this.topActivities = new Feed(options.topActivitiesOptions, {
                collectionClass: FeedItemCollection,
                collectionUrl: api.getURL('timelines/ranked'),
                collectionOptions: {
                    type: 'default',
                    target: this.channel && ('channel:' + this.channel.id),
                },
            });
        },

        toJSON: function () {
            // Don't bother calling prototype's toJSON since this is a ViewModel
            // that doesn't store any attributes itself, only groups other Models
            // and Collections.
            return {
                channel: this.channel.toJSON(),
            };
        },

        ensureFetched: function () {
            this.ensureFetchedChannel();
            this.ensureFetchedTopActivities();
            _.each(this.constructor.RANKINGS, function (ranking) {
                this.ensureFetchedRankedChannels(ranking.id);
            });
        },

        ensureFetchedChannel: function () {
            this.channel.ensureFetched();
        },

        ensureFetchedTopActivities: function () {
            this.topActivities.ensureFetched();
        },

        ensureFetchedRankedChannels: function (id) {
            var feed = this.rankedChannels[id];
            if (feed)
                feed.ensureFetched();
        },
    }, {
        RANKINGS: [
            {
                id: 'top',
                name: 'trending',
            },
            {
                id: 'popular',
                name: 'popular',
            },
            {
                id: 'recent',
                name: 'new',
            },
        ],

        // The id to use for the special ChannelGroupProfile that contains content
        // accross all Channel Groups.
        ALL_CHANNEL_GROUPS_PROFILE_ID: 'all channel groups',
    });

    UniqueModel.addType('ChannelGroupProfile', ChannelGroupProfile);

    return ChannelGroupProfile;
});

define('home/templates/forumCountCard',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<p class=\"channel-follow__description truncate-line text-medium\">\n"
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"channelDescription") : depth0), depth0))
    + "\n</p>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"channel-follow__wrapper\">\n<div class=\"channel-follow__block\">\n<div class=\"align align--middle spacing-bottom-small\">\n<a href=\"/home/channel/"
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"channel") : depth0)) != null ? lookupProperty(stack1,"slug") : stack1), depth0))
    + "/\"\nclass=\"avatar\"\ndata-link-name=\"forum_avatar\"\ndata-forum-pk=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"pk") : depth0), depth0))
    + "\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"channelAvatarWithDefault"),(depth0 != null ? lookupProperty(depth0,"channel") : depth0),{"name":"channelAvatarWithDefault","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</a>\n<p class=\"text-semibold\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"channelAwareForumLink"),depth0,{"name":"channelAwareForumLink","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</p>\n</div>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"channelDescription") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":14,"column":0},"end":{"line":18,"column":7}}})) != null ? stack1 : "")
    + "</div>\n<div class=\"channel-follow__stats align align--middle\" data-role=\"stats\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"channelMetadataStats"),depth0,{"name":"channelMetadataStats","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/ForumCountCardView',[
    'backbone-marionette',

    'core/mixins/withChannelFollowing',
    'home/templates/forumCountCard',
], function (
    Marionette,

    withChannelFollowing,
    forumCountCardTemplate
) {
    'use strict';

    /**
     * A card that shows a forum or channel. Shows the avatar, title, description, stats
     * following status, and follow action.
     *
     * Expects a forum model.
     */
    var ExploreChannelCardView = Marionette.ItemView.extend({
        className: 'card',
        template: forumCountCardTemplate,

        templateHelpers: function () {
            var channel = this.model.channel;
            var primaryForum = channel.primaryForum;
            var numThreads = primaryForum.get('numThreads');
            var numFollowers = primaryForum.get('numFollowers');

            return {
                // Attributes may be null during fetch
                numThreads: numThreads && numThreads.toLocaleString(),
                numFollowers: numFollowers && numFollowers.toLocaleString(),
                channelDescription: channel && channel.get('options').description,
                channel: channel && channel.toJSON(),
            };
        },

        initialize: function () {
            this.bindToPrimaryForum();
        },

        // TODO: Clean duplication with this & withChannelFollowing
        bindToPrimaryForum: function () {
            var channel = this.model.channel;

            if (!channel.primaryForum) {
                this.listenToOnce(channel, 'changeRelated:primaryForum', this.bindToPrimaryForum);
                return;
            }

            // When a change is found, only update the counts so the button animates
            this.listenTo(channel.primaryForum,
                'change:numFollowers change:numThreads',
                this.renderStats);
        },

        renderStats: function () {
            this.$('[data-role=discussion-count]').text(this.model.get('numThreads').toLocaleString());
            this.$('[data-role=followers-count]').text(this.model.get('numFollowers').toLocaleString());
        },
    });

    withChannelFollowing.call(ExploreChannelCardView.prototype, function () {
        return this.model.channel;
    });

    return ExploreChannelCardView;
});

define('home/views/ForumCountCardCollectionView',[
    'home/views/ForumCountCardView',
    'home/views/ForumCardCollectionView',
], function (
    ForumCountCardView,
    ForumCardCollectionView
) {
    'use strict';

    /**
     * Shows a list of channel cards with channel stats and the follow button.
     * It extends from ForumCardCollectionView where it adds in an empty state.
     &
     * Expects a collection of Forums or Channels with a link to their primaryForums.
     */
    var ForumCountCardCollectionView = ForumCardCollectionView.extend({
        itemView: ForumCountCardView,
    });

    return ForumCountCardCollectionView;
});

define('home/templates/channelCardExplore',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    return " has-image";
},"3":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"card-content__media\">\n<div style=\"background-image: url("
    + container.escapeExpression(container.lambda(((stack1 = (depth0 != null ? lookupProperty(depth0,"image") : depth0)) != null ? lookupProperty(stack1,"src") : stack1), depth0))
    + ")\" class=\"img-cards\"></div>\n</div>\n";
},"5":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(container.lambda(((stack1 = (depth0 != null ? lookupProperty(depth0,"threadOverrides") : depth0)) != null ? lookupProperty(stack1,"title") : stack1), depth0))
    + "\n";
},"7":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(container.lambda(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"clean_title") : stack1), depth0))
    + "\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, alias3=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\""
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"link") : stack1), depth0))
    + "\">\n<div class=\"card__header -feed\">\n<div class=\"card__reason -explore align align--middle\">\n<strong class=\"text-gray-darker\">"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"forumName"),((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"forum") : stack1),{"name":"forumName","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</strong>\n<time class=\"bullet text-gray\">"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"relativeTime") : depth0), depth0))
    + "</time>\n</div>\n</div>\n<div class=\"card__content -default"
    + ((stack1 = lookupProperty(helpers,"if").call(alias3,(depth0 != null ? lookupProperty(depth0,"image") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":8,"column":34},"end":{"line":8,"column":64}}})) != null ? stack1 : "")
    + "\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias3,(depth0 != null ? lookupProperty(depth0,"image") : depth0),{"name":"if","hash":{},"fn":container.program(3, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":9,"column":0},"end":{"line":13,"column":7}}})) != null ? stack1 : "")
    + "<div class=\"card-content__body\">\n<h2 class=\"discussion-title text-gray-darker\" dir=\"auto\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias3,((stack1 = (depth0 != null ? lookupProperty(depth0,"threadOverrides") : depth0)) != null ? lookupProperty(stack1,"title") : stack1),{"name":"if","hash":{},"fn":container.program(5, data, 0),"inverse":container.program(7, data, 0),"data":data,"loc":{"start":{"line":16,"column":0},"end":{"line":21,"column":7}}})) != null ? stack1 : "")
    + "</h2>\n\n<div class=\"card-content__summary text-gray-dark\">\n<div class=\"truncate\" data-truncate-lines=\"3\" dir=\"auto\">\n"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"threadDescription") : depth0), depth0))
    + "\n</div>\n</div>\n</div>\n</div>\n<div class=\"card__footer text-gray-dark text-semibold\">\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias3,"%(recommendCount)s recommends",{"name":"gettext","hash":{"recommendCount":((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"likes") : stack1)},"data":data,"loc":{"start":{"line":32,"column":0},"end":{"line":32,"column":73}}}))
    + "\n<span class=\"bullet\"></span>\n"
    + alias2(lookupProperty(helpers,"gettext").call(alias3,"%(commentCount)s comments",{"name":"gettext","hash":{"commentCount":((stack1 = (depth0 != null ? lookupProperty(depth0,"thread") : depth0)) != null ? lookupProperty(stack1,"posts") : stack1)},"data":data,"loc":{"start":{"line":34,"column":0},"end":{"line":34,"column":67}}}))
    + "\n</div>\n</a>\n";
},"usePartial":true,"useData":true})

});
define('home/views/ChannelCardExploreView',[
    'underscore',

    'core/config',

    'home/views/ChannelCardView',
    'home/templates/channelCardExplore',
], function (
    _,

    config,

    ChannelCardView,
    channelCardExploreTemplate
) {
    'use strict';

    /**
     * View is explore feed card that is stripped down
     * link version of the card.
     */

    var ChannelCardExploreView = ChannelCardView.extend({
        template: channelCardExploreTemplate,
        className: 'card-wrap card--channel -link',

        templateHelpers: function () {
            var templateHelpers = ChannelCardView.prototype.templateHelpers;

            return _.defaults({
                guestAvatar: config.urls.avatar.generic,
            }, _.isFunction(templateHelpers) ? templateHelpers.call(this) : templateHelpers);
        },
    });

    return ChannelCardExploreView;
});

define('home/templates/channelGroupFeeds',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data,blockParams,depths) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<ul class=\"list--inline text-center text-medium border-bottom\">\n"
    + ((stack1 = lookupProperty(helpers,"each").call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? lookupProperty(depth0,"tabs") : depth0),{"name":"each","hash":{},"fn":container.program(2, data, 0, blockParams, depths),"inverse":container.noop,"data":data,"loc":{"start":{"line":3,"column":0},"end":{"line":9,"column":9}}})) != null ? stack1 : "")
    + "</ul>\n";
},"2":function(container,depth0,helpers,partials,data,blockParams,depths) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<li data-action=\"switch-tab\" data-tab=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"id") : depth0), depth0))
    + "\" class=\"nav-bar__item\">\n<a href=\"/home/explore/"
    + ((stack1 = lookupProperty(helpers,"if").call(depth0 != null ? depth0 : (container.nullContext || {}),(depths[1] != null ? lookupProperty(depths[1],"exploreTab") : depths[1]),{"name":"if","hash":{},"fn":container.program(3, data, 0, blockParams, depths),"inverse":container.program(5, data, 0, blockParams, depths),"data":data,"loc":{"start":{"line":5,"column":23},"end":{"line":5,"column":84}}})) != null ? stack1 : "")
    + "/"
    + alias2(alias1(((stack1 = (depths[1] != null ? lookupProperty(depths[1],"channel") : depths[1])) != null ? lookupProperty(stack1,"slug") : stack1), depth0))
    + "/"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"id") : depth0), depth0))
    + "/\" class=\"nav-bar__link\">\n<strong>"
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"name") : depth0), depth0))
    + "</strong>\n</a>\n</li>\n";
},"3":function(container,depth0,helpers,partials,data,blockParams,depths) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(container.lambda((depths[1] != null ? lookupProperty(depths[1],"exploreTab") : depths[1]), depth0));
},"5":function(container,depth0,helpers,partials,data) {
    return "channels";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data,blockParams,depths) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return ((stack1 = lookupProperty(helpers,"if").call(alias1,lookupProperty(helpers,"gt").call(alias1,(depth0 != null ? lookupProperty(depth0,"numTabs") : depth0),1,{"name":"gt","hash":{},"data":data,"loc":{"start":{"line":1,"column":6},"end":{"line":1,"column":20}}}),{"name":"if","hash":{},"fn":container.program(1, data, 0, blockParams, depths),"inverse":container.noop,"data":data,"loc":{"start":{"line":1,"column":0},"end":{"line":11,"column":7}}})) != null ? stack1 : "")
    + "<div data-role=\"content-area\"></div>\n";
},"useData":true,"useDepths":true})

});
define('home/views/ChannelGroupFeedsView',[
    'core/constants/exploreModuleConstants',

    'home/views/common/FetchableCollectionLayout',
    'home/views/common/TabbedView',
    'home/views/HideOnEndFooterView',
    'home/views/ForumCountCardCollectionView',
    'home/views/ChannelCardExploreView',
    'home/views/ChannelCardCollectionView',

    'home/templates/channelGroupFeeds',
], function (
    exploreModuleConstants,

    FetchableCollectionLayout,
    TabbedView,
    HideOnEndFooterView,
    ForumCountCardCollectionView,
    ChannelCardExploreView,
    ChannelCardCollectionView,

    channelGroupFeedsTemplate
) {
    'use strict';

    /**
     * Shows feed(s) for a Channel Group. By Default only shows the top source channels
     * feed, but can be set to show other feeds as tabs.
     *
     * Expects a ChannelGroupProfile model.
     */
    var ChannelGroupFeedsView = TabbedView.extend({
        defaultTab: function () {
            if (this.tabs && this.tabs.length === 1)
                return this.tabs[0].id;

            return 'top';
        },

        template: channelGroupFeedsTemplate,
        templateHelpers: function () {
            return {
                tabs: this.tabs,
                numTabs: this.tabs.length,
                exploreTab: this.exploreTab,
                channelGroupTab: this.channelGroupTab,
            };
        },

        initialize: function (options) {
            options = options || {};
            TabbedView.prototype.initialize.call(this, options);
            this.tabs = options.tabs || [exploreModuleConstants.TABS.TOP];
            this.exploreTab = options.exploreTab;
            this.channelGroupTab = options.channelGroupTab;
            this.allChannelGroupsProfile = options.allChannelGroupsProfile;
        },

        getTabView: function (activeTab) {
            switch (activeTab) {
            case 'top':
            case 'popular':
            case 'recent':
                // For the ranked channels feeds, show the feeds from the
                // special all channel groups profile.
                var model = this.channelGroupTab === 'all' ? this.allChannelGroupsProfile : this.model;

                model.ensureFetchedRankedChannels(activeTab);
                var feed = model.rankedChannels[activeTab];
                return new FetchableCollectionLayout({
                    fetchableCollectionView: ForumCountCardCollectionView,
                    fetchableCollectionFooterView: HideOnEndFooterView,
                    model: feed,
                    collection: feed.items,
                    infiniteScroll: true,
                });
            case 'discussions':
                // For the top activities feed, show the feed from the
                // spotlight channel group profile.
                this.model.ensureFetchedTopActivities();
                return new FetchableCollectionLayout({
                    className: 'explore-discussion__wrapper',
                    model: this.model.topActivities,
                    collection: this.model.topActivities.items,
                    itemView: ChannelCardExploreView,
                    channel: this.model.channel,
                    fetchableCollectionView: ChannelCardCollectionView,
                    fetchableCollectionFooterView: HideOnEndFooterView,
                    infiniteScroll: true,
                });
            }
        },
    });

    return ChannelGroupFeedsView;
});

define('home/templates/channelGroupCard',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"exploreTab") : depth0), depth0));
},"3":function(container,depth0,helpers,partials,data) {
    return "channels";
},"5":function(container,depth0,helpers,partials,data) {
    var stack1, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"channel-cover__logo spacing-bottom-narrow\">\n<img src=\""
    + container.escapeExpression(container.lambda(((stack1 = ((stack1 = (depth0 != null ? lookupProperty(depth0,"options") : depth0)) != null ? lookupProperty(stack1,"titleLogo") : stack1)) != null ? lookupProperty(stack1,"cache") : stack1), depth0))
    + "\" class=\"img-responsive block__item\" />\n</div>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.lambda, alias3=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<a href=\"/home/explore/"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"exploreTab") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.program(3, data, 0),"data":data,"loc":{"start":{"line":1,"column":23},"end":{"line":1,"column":78}}})) != null ? stack1 : "")
    + "/"
    + alias3(alias2((depth0 != null ? lookupProperty(depth0,"slug") : depth0), depth0))
    + "/\" alt=\""
    + alias3(alias2((depth0 != null ? lookupProperty(depth0,"name") : depth0), depth0))
    + "\" class=\"explore__link link-gray-darker\">\n<div class=\"channel-tab__tile "
    + alias3(alias2((depth0 != null ? lookupProperty(depth0,"bannerColor") : depth0), depth0))
    + " text-medium\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,((stack1 = (depth0 != null ? lookupProperty(depth0,"options") : depth0)) != null ? lookupProperty(stack1,"titleLogo") : stack1),{"name":"if","hash":{},"fn":container.program(5, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":3,"column":0},"end":{"line":7,"column":7}}})) != null ? stack1 : "")
    + "<strong>"
    + alias3(alias2((depth0 != null ? lookupProperty(depth0,"name") : depth0), depth0))
    + "</strong>\n</div>\n</a>\n";
},"useData":true})

});
define('home/views/ChannelGroupCardView',[
    'backbone-marionette',

    'home/templates/channelGroupCard',
], function (
    Marionette,

    channelGroupCardTemplate
) {
    'use strict';

    /**
     * A card showing a channel group name and logo.
     *
     * Expects a channel model
     */
    var ChannelGroupCardView = Marionette.ItemView.extend({
        template: channelGroupCardTemplate,

        templateHelpers: function () {
            var bannerColor = this.model.get('bannerColor');

            return {
                bannerColor: bannerColor ? '-' + bannerColor : '',
                exploreTab: this.exploreTab,
            };
        },

        initialize: function (options) {
            this.exploreTab = options && options.exploreTab;
        },
    });

    return ChannelGroupCardView;
});

define('home/templates/channelGroupTabCollection',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var alias1=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"carousel\" data-role=\"tabs-container\">\n<div data-action=\"switch-tab\" data-tab=\"all\" class=\"channel-tab__item\">\n<a href=\"/home/explore/"
    + alias1(container.lambda((depth0 != null ? lookupProperty(depth0,"exploreTab") : depth0), depth0))
    + "/all/\" class=\"explore__link\">\n<div class=\"channel-tab__tile text-medium\">\n<strong>"
    + alias1(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"All Categories",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":5,"column":8},"end":{"line":5,"column":36}}}))
    + "</strong>\n</div>\n</a>\n</div>\n</div>\n";
},"useData":true})

});
/*
     _ _      _       _
 ___| (_) ___| | __  (_)___
/ __| | |/ __| |/ /  | / __|
\__ \ | | (__|   < _ | \__ \
|___/_|_|\___|_|\_(_)/ |___/
                   |__/

 Version: 1.3.15
  Author: Ken Wheeler
 Website: http://kenwheeler.github.io
    Docs: http://kenwheeler.github.io/slick
    Repo: http://github.com/kenwheeler/slick
  Issues: http://github.com/kenwheeler/slick/issues

 */

/* global window, document, define, jQuery, setInterval, clearInterval */

(function(factory) {
    'use strict';
    if (typeof define === 'function' && define.amd) {
        define('jquery.slick',['jquery'], factory);
    } else if (typeof exports !== 'undefined') {
        module.exports = factory(require('jquery'));
    } else {
        factory(jQuery);
    }

}(function($) {
    'use strict';
    var Slick = window.Slick || {};

    Slick = (function() {

        var instanceUid = 0;

        function Slick(element, settings) {

            var _ = this,
                responsiveSettings, breakpoint;

            _.defaults = {
                accessibility: true,
                adaptiveHeight: false,
                appendArrows: $(element),
                appendDots: $(element),
                arrows: true,
                asNavFor: null,
                prevArrow: '<button type="button" data-role="none" class="slick-prev">Previous</button>',
                nextArrow: '<button type="button" data-role="none" class="slick-next">Next</button>',
                autoplay: false,
                autoplaySpeed: 3000,
                centerMode: false,
                centerPadding: '50px',
                cssEase: 'ease',
                customPaging: function(slider, i) {
                    return '<button type="button" data-role="none">' + (i + 1) + '</button>';
                },
                dots: false,
                dotsClass: 'slick-dots',
                draggable: true,
                easing: 'linear',
                fade: false,
                focusOnSelect: false,
                infinite: true,
                initialSlide: 0,
                lazyLoad: 'ondemand',
                onBeforeChange: null,
                onAfterChange: null,
                onInit: null,
                onReInit: null,
                onSetPosition: null,
                pauseOnHover: true,
                pauseOnDotsHover: false,
                respondTo: 'window',
                responsive: null,
                rtl: false,
                slide: 'div',
                slidesToShow: 1,
                slidesToScroll: 1,
                speed: 500,
                swipe: true,
                swipeToSlide: false,
                touchMove: true,
                touchThreshold: 5,
                useCSS: true,
                variableWidth: false,
                vertical: false,
                waitForAnimate: true
            };

            _.initials = {
                animating: false,
                dragging: false,
                autoPlayTimer: null,
                currentDirection: 0,
                currentLeft: null,
                currentSlide: 0,
                direction: 1,
                $dots: null,
                listWidth: null,
                listHeight: null,
                loadIndex: 0,
                $nextArrow: null,
                $prevArrow: null,
                slideCount: null,
                slideWidth: null,
                $slideTrack: null,
                $slides: null,
                sliding: false,
                slideOffset: 0,
                swipeLeft: null,
                $list: null,
                touchObject: {},
                transformsEnabled: false
            };

            $.extend(_, _.initials);

            _.activeBreakpoint = null;
            _.animType = null;
            _.animProp = null;
            _.breakpoints = [];
            _.breakpointSettings = [];
            _.cssTransitions = false;
            _.paused = false;
            _.positionProp = null;
            _.respondTo = null;
            _.shouldClick = true;
            _.$slider = $(element);
            _.$slidesCache = null;
            _.transformType = null;
            _.transitionType = null;
            _.windowWidth = 0;
            _.windowTimer = null;

            _.options = $.extend({}, _.defaults, settings);

            _.currentSlide = _.options.initialSlide;

            _.originalSettings = _.options;
            responsiveSettings = _.options.responsive || null;

            if (responsiveSettings && responsiveSettings.length > -1) {
                _.respondTo = _.options.respondTo || "window";
                for (breakpoint in responsiveSettings) {
                    if (responsiveSettings.hasOwnProperty(breakpoint)) {
                        _.breakpoints.push(responsiveSettings[
                            breakpoint].breakpoint);
                        _.breakpointSettings[responsiveSettings[
                            breakpoint].breakpoint] =
                            responsiveSettings[breakpoint].settings;
                    }
                }
                _.breakpoints.sort(function(a, b) {
                    return b - a;
                });
            }

            _.autoPlay = $.proxy(_.autoPlay, _);
            _.autoPlayClear = $.proxy(_.autoPlayClear, _);
            _.changeSlide = $.proxy(_.changeSlide, _);
            _.clickHandler = $.proxy(_.clickHandler, _);
            _.selectHandler = $.proxy(_.selectHandler, _);
            _.setPosition = $.proxy(_.setPosition, _);
            _.swipeHandler = $.proxy(_.swipeHandler, _);
            _.dragHandler = $.proxy(_.dragHandler, _);
            _.keyHandler = $.proxy(_.keyHandler, _);
            _.autoPlayIterator = $.proxy(_.autoPlayIterator, _);

            _.instanceUid = instanceUid++;

            // A simple way to check for HTML strings
            // Strict HTML recognition (must start with <)
            // Extracted from jQuery v1.11 source
            _.htmlExpr = /^(?:\s*(<[\w\W]+>)[^>]*)$/;

            _.init();

            _.checkResponsive();

        }

        return Slick;

    }());

    Slick.prototype.addSlide = function(markup, index, addBefore) {

        var _ = this;

        if (typeof(index) === 'boolean') {
            addBefore = index;
            index = null;
        } else if (index < 0 || (index >= _.slideCount)) {
            return false;
        }

        _.unload();

        if (typeof(index) === 'number') {
            if (index === 0 && _.$slides.length === 0) {
                $(markup).appendTo(_.$slideTrack);
            } else if (addBefore) {
                $(markup).insertBefore(_.$slides.eq(index));
            } else {
                $(markup).insertAfter(_.$slides.eq(index));
            }
        } else {
            if (addBefore === true) {
                $(markup).prependTo(_.$slideTrack);
            } else {
                $(markup).appendTo(_.$slideTrack);
            }
        }

        _.$slides = _.$slideTrack.children(this.options.slide);

        _.$slideTrack.children(this.options.slide).detach();

        _.$slideTrack.append(_.$slides);

        _.$slides.each(function(index, element) {
            $(element).attr("index",index);
        });

        _.$slidesCache = _.$slides;

        _.reinit();

    };

    Slick.prototype.animateSlide = function(targetLeft, callback) {

        var animProps = {}, _ = this;

        if(_.options.slidesToShow === 1 && _.options.adaptiveHeight === true && _.options.vertical === false) {
            var targetHeight = _.$slides.eq(_.currentSlide).outerHeight(true);
            _.$list.animate({height: targetHeight},_.options.speed);
        }

        if (_.options.rtl === true && _.options.vertical === false) {
            targetLeft = -targetLeft;
        }
        if (_.transformsEnabled === false) {
            if (_.options.vertical === false) {
                _.$slideTrack.animate({
                    left: targetLeft
                }, _.options.speed, _.options.easing, callback);
            } else {
                _.$slideTrack.animate({
                    top: targetLeft
                }, _.options.speed, _.options.easing, callback);
            }

        } else {

            if (_.cssTransitions === false) {

                $({
                    animStart: _.currentLeft
                }).animate({
                    animStart: targetLeft
                }, {
                    duration: _.options.speed,
                    easing: _.options.easing,
                    step: function(now) {
                        if (_.options.vertical === false) {
                            animProps[_.animType] = 'translate(' +
                                now + 'px, 0px)';
                            _.$slideTrack.css(animProps);
                        } else {
                            animProps[_.animType] = 'translate(0px,' +
                                now + 'px)';
                            _.$slideTrack.css(animProps);
                        }
                    },
                    complete: function() {
                        if (callback) {
                            callback.call();
                        }
                    }
                });

            } else {

                _.applyTransition();

                if (_.options.vertical === false) {
                    animProps[_.animType] = 'translate3d(' + targetLeft + 'px, 0px, 0px)';
                } else {
                    animProps[_.animType] = 'translate3d(0px,' + targetLeft + 'px, 0px)';
                }
                _.$slideTrack.css(animProps);

                if (callback) {
                    setTimeout(function() {

                        _.disableTransition();

                        callback.call();
                    }, _.options.speed);
                }

            }

        }

    };

    Slick.prototype.asNavFor = function(index) {
        var _ = this, asNavFor = _.options.asNavFor != null ? $(_.options.asNavFor).getSlick() : null;
        if(asNavFor != null) asNavFor.slideHandler(index, true);
    };

    Slick.prototype.applyTransition = function(slide) {

        var _ = this,
            transition = {};

        if (_.options.fade === false) {
            transition[_.transitionType] = _.transformType + ' ' + _.options.speed + 'ms ' + _.options.cssEase;
        } else {
            transition[_.transitionType] = 'opacity ' + _.options.speed + 'ms ' + _.options.cssEase;
        }

        if (_.options.fade === false) {
            _.$slideTrack.css(transition);
        } else {
            _.$slides.eq(slide).css(transition);
        }

    };

    Slick.prototype.autoPlay = function() {

        var _ = this;

        if (_.autoPlayTimer) {
            clearInterval(_.autoPlayTimer);
        }

        if (_.slideCount > _.options.slidesToShow && _.paused !== true) {
            _.autoPlayTimer = setInterval(_.autoPlayIterator,
                _.options.autoplaySpeed);
        }

    };

    Slick.prototype.autoPlayClear = function() {

        var _ = this;
        if (_.autoPlayTimer) {
            clearInterval(_.autoPlayTimer);
        }

    };

    Slick.prototype.autoPlayIterator = function() {

        var _ = this;

        if (_.options.infinite === false) {

            if (_.direction === 1) {

                if ((_.currentSlide + 1) === _.slideCount -
                    1) {
                    _.direction = 0;
                }

                _.slideHandler(_.currentSlide + _.options.slidesToScroll);

            } else {

                if ((_.currentSlide - 1 === 0)) {

                    _.direction = 1;

                }

                _.slideHandler(_.currentSlide - _.options.slidesToScroll);

            }

        } else {

            _.slideHandler(_.currentSlide + _.options.slidesToScroll);

        }

    };

    Slick.prototype.buildArrows = function() {

        var _ = this;

        if (_.options.arrows === true && _.slideCount > _.options.slidesToShow) {

            _.$prevArrow = $(_.options.prevArrow);
            _.$nextArrow = $(_.options.nextArrow);

            if (_.htmlExpr.test(_.options.prevArrow)) {
                _.$prevArrow.appendTo(_.options.appendArrows);
            }

            if (_.htmlExpr.test(_.options.nextArrow)) {
                _.$nextArrow.appendTo(_.options.appendArrows);
            }

            if (_.options.infinite !== true) {
                _.$prevArrow.addClass('slick-disabled');
            }

        }

    };

    Slick.prototype.buildDots = function() {

        var _ = this,
            i, dotString;

        if (_.options.dots === true && _.slideCount > _.options.slidesToShow) {

            dotString = '<ul class="' + _.options.dotsClass + '">';

            for (i = 0; i <= _.getDotCount(); i += 1) {
                dotString += '<li>' + _.options.customPaging.call(this, _, i) + '</li>';
            }

            dotString += '</ul>';

            _.$dots = $(dotString).appendTo(
                _.options.appendDots);

            _.$dots.find('li').first().addClass(
                'slick-active');

        }

    };

    Slick.prototype.buildOut = function() {

        var _ = this;

        _.$slides = _.$slider.children(_.options.slide +
            ':not(.slick-cloned)').addClass(
            'slick-slide');
        _.slideCount = _.$slides.length;

        _.$slides.each(function(index, element) {
            $(element).attr("index",index);
        });

        _.$slidesCache = _.$slides;

        _.$slider.addClass('slick-slider');

        _.$slideTrack = (_.slideCount === 0) ?
            $('<div class="slick-track"/>').appendTo(_.$slider) :
            _.$slides.wrapAll('<div class="slick-track"/>').parent();

        _.$list = _.$slideTrack.wrap(
            '<div class="slick-list"/>').parent();
        _.$slideTrack.css('opacity', 0);

        if (_.options.centerMode === true) {
            _.options.slidesToScroll = 1;
        }

        $('img[data-lazy]', _.$slider).not('[src]').addClass('slick-loading');

        _.setupInfinite();

        _.buildArrows();

        _.buildDots();

        _.updateDots();

        if (_.options.accessibility === true) {
            _.$list.prop('tabIndex', 0);
        }

        _.setSlideClasses(typeof this.currentSlide === 'number' ? this.currentSlide : 0);

        if (_.options.draggable === true) {
            _.$list.addClass('draggable');
        }

    };

    Slick.prototype.checkResponsive = function() {

        var _ = this,
            breakpoint, targetBreakpoint, respondToWidth;
        var sliderWidth = _.$slider.width();
        var windowWidth = window.innerWidth || $(window).width();
        if (_.respondTo === "window") {
          respondToWidth = windowWidth;
        } else if (_.respondTo === "slider") {
          respondToWidth = sliderWidth;
        } else if (_.respondTo === "min") {
          respondToWidth = Math.min(windowWidth, sliderWidth);
        }

        if (_.originalSettings.responsive && _.originalSettings
            .responsive.length > -1 && _.originalSettings.responsive !== null) {

            targetBreakpoint = null;

            for (breakpoint in _.breakpoints) {
                if (_.breakpoints.hasOwnProperty(breakpoint)) {
                    if (respondToWidth < _.breakpoints[breakpoint]) {
                        targetBreakpoint = _.breakpoints[breakpoint];
                    }
                }
            }

            if (targetBreakpoint !== null) {
                if (_.activeBreakpoint !== null) {
                    if (targetBreakpoint !== _.activeBreakpoint) {
                        _.activeBreakpoint =
                            targetBreakpoint;
                        _.options = $.extend({}, _.originalSettings,
                            _.breakpointSettings[
                                targetBreakpoint]);
                        _.refresh();
                    }
                } else {
                    _.activeBreakpoint = targetBreakpoint;
                    _.options = $.extend({}, _.originalSettings,
                        _.breakpointSettings[
                            targetBreakpoint]);
                    _.refresh();
                }
            } else {
                if (_.activeBreakpoint !== null) {
                    _.activeBreakpoint = null;
                    _.options = _.originalSettings;
                    _.refresh();
                }
            }

        }

    };

    Slick.prototype.changeSlide = function(event, dontAnimate) {

        var _ = this,
            $target = $(event.target),
            indexOffset, slideOffset, unevenOffset,navigables, prevNavigable;

        // If target is a link, prevent default action.
        $target.is('a') && event.preventDefault();

        unevenOffset = (_.slideCount % _.options.slidesToScroll !== 0);
        indexOffset = unevenOffset ? 0 : (_.slideCount - _.currentSlide) % _.options.slidesToScroll;

        switch (event.data.message) {

            case 'previous':
                slideOffset = indexOffset === 0 ? _.options.slidesToScroll : _.options.slidesToShow - indexOffset;
                if (_.slideCount > _.options.slidesToShow) {
                    _.slideHandler(_.currentSlide  - slideOffset, false, dontAnimate);
                }
                break;

            case 'next':
                slideOffset = indexOffset === 0 ? _.options.slidesToScroll : indexOffset;
                if (_.slideCount > _.options.slidesToShow) {
                    _.slideHandler(_.currentSlide + slideOffset, false, dontAnimate);
                }
                break;

            case 'index':
                var index = event.data.index === 0 ? 0 :
                    event.data.index || $(event.target).parent().index() * _.options.slidesToScroll;

                navigables = _.getNavigableIndexes();
                prevNavigable = 0;
                if(navigables[index] && navigables[index] === index) {
                    if(index > navigables[navigables.length -1]){
                        index = navigables[navigables.length -1];
                    } else {
                        for(var n in navigables) {
                            if(index < navigables[n]) {
                                index = prevNavigable;
                                break;
                            }
                            prevNavigable = navigables[n];
                        }
                    }
                }
                _.slideHandler(index, false, dontAnimate);

            default:
                return;
        }

    };

    Slick.prototype.clickHandler = function(event) {

        var _ = this;

        if(_.shouldClick === false) {
            event.stopImmediatePropagation();
            event.stopPropagation();
            event.preventDefault();
        }

    }

    Slick.prototype.destroy = function() {

        var _ = this;

        _.autoPlayClear();

        _.touchObject = {};

        $('.slick-cloned', _.$slider).remove();
        if (_.$dots) {
            _.$dots.remove();
        }
        if (_.$prevArrow && (typeof _.options.prevArrow !== 'object')) {
            _.$prevArrow.remove();
        }
        if (_.$nextArrow && (typeof _.options.nextArrow !== 'object')) {
            _.$nextArrow.remove();
        }
        if (_.$slides.parent().hasClass('slick-track')) {
            _.$slides.unwrap().unwrap();
        }

        _.$slides.removeClass(
            'slick-slide slick-active slick-center slick-visible')
            .removeAttr('index')
            .css({
                position: '',
                left: '',
                top: '',
                zIndex: '',
                opacity: '',
                width: ''
            });

        _.$slider.removeClass('slick-slider');
        _.$slider.removeClass('slick-initialized');

        _.$list.off('.slick');
        $(window).off('.slick-' + _.instanceUid);
        $(document).off('.slick-' + _.instanceUid);

    };

    Slick.prototype.disableTransition = function(slide) {

        var _ = this,
            transition = {};

        transition[_.transitionType] = "";

        if (_.options.fade === false) {
            _.$slideTrack.css(transition);
        } else {
            _.$slides.eq(slide).css(transition);
        }

    };

    Slick.prototype.fadeSlide = function(oldSlide, slideIndex, callback) {

        var _ = this;

        if (_.cssTransitions === false) {

            _.$slides.eq(slideIndex).css({
                zIndex: 1000
            });

            _.$slides.eq(slideIndex).animate({
                opacity: 1
            }, _.options.speed, _.options.easing, callback);

            _.$slides.eq(oldSlide).animate({
                opacity: 0
            }, _.options.speed, _.options.easing);

        } else {

            _.applyTransition(slideIndex);
            _.applyTransition(oldSlide);

            _.$slides.eq(slideIndex).css({
                opacity: 1,
                zIndex: 1000
            });

            _.$slides.eq(oldSlide).css({
                opacity: 0
            });

            if (callback) {
                setTimeout(function() {

                    _.disableTransition(slideIndex);
                    _.disableTransition(oldSlide);

                    callback.call();
                }, _.options.speed);
            }

        }

    };

    Slick.prototype.filterSlides = function(filter) {

        var _ = this;

        if (filter !== null) {

            _.unload();

            _.$slideTrack.children(this.options.slide).detach();

            _.$slidesCache.filter(filter).appendTo(_.$slideTrack);

            _.reinit();

        }

    };

    Slick.prototype.getCurrent = function() {

        var _ = this;

        return _.currentSlide;

    };

    Slick.prototype.getDotCount = function() {

        var _ = this;

        var breakPoint = 0;
        var counter = 0;
        var pagerQty = 0;

        if(_.options.infinite === true) {
            pagerQty = Math.ceil(_.slideCount / _.options.slidesToScroll);
        } else {
            while (breakPoint < _.slideCount){
                ++pagerQty;
                breakPoint = counter + _.options.slidesToShow;
                counter += _.options.slidesToScroll <= _.options.slidesToShow ? _.options.slidesToScroll  : _.options.slidesToShow;
            }
        }

        return pagerQty - 1;

    };

    Slick.prototype.getLeft = function(slideIndex) {

        var _ = this,
            targetLeft,
            verticalHeight,
            verticalOffset = 0,
            slideWidth,
            targetSlide;

        _.slideOffset = 0;
        verticalHeight = _.$slides.first().outerHeight();

        if (_.options.infinite === true) {
            if (_.slideCount > _.options.slidesToShow) {
                _.slideOffset = (_.slideWidth * _.options.slidesToShow) * -1;
                verticalOffset = (verticalHeight * _.options.slidesToShow) * -1;
            }
            if (_.slideCount % _.options.slidesToScroll !== 0) {
                if (slideIndex + _.options.slidesToScroll > _.slideCount && _.slideCount > _.options.slidesToShow) {
                    if(slideIndex > _.slideCount) {
                        _.slideOffset = ((_.options.slidesToShow - (slideIndex - _.slideCount)) * _.slideWidth) * -1;
                        verticalOffset = ((_.options.slidesToShow - (slideIndex - _.slideCount)) * verticalHeight) * -1;
                    } else {
                        _.slideOffset = ((_.slideCount % _.options.slidesToScroll) * _.slideWidth) * -1;
                        verticalOffset = ((_.slideCount % _.options.slidesToScroll) * verticalHeight) * -1;
                    }
                }
            }
        } else {
            if(slideIndex + _.options.slidesToShow > _.slideCount) {
                _.slideOffset = ((slideIndex + _.options.slidesToShow) - _.slideCount) * _.slideWidth;
                verticalOffset = ((slideIndex + _.options.slidesToShow) - _.slideCount) * verticalHeight;
            }
        }

        if (_.slideCount <= _.options.slidesToShow){
            _.slideOffset = 0;
            verticalOffset = 0;
        }

        if (_.options.centerMode === true && _.options.infinite === true) {
            _.slideOffset += _.slideWidth * Math.floor(_.options.slidesToShow / 2) - _.slideWidth;
        } else if (_.options.centerMode === true) {
            _.slideOffset = 0;
            _.slideOffset += _.slideWidth * Math.floor(_.options.slidesToShow / 2);
        }

        if (_.options.vertical === false) {
            targetLeft = ((slideIndex * _.slideWidth) * -1) + _.slideOffset;
        } else {
            targetLeft = ((slideIndex * verticalHeight) * -1) + verticalOffset;
        }

        if (_.options.variableWidth === true) {

            if(_.slideCount <= _.options.slidesToShow || _.options.infinite === false) {
                targetSlide = _.$slideTrack.children('.slick-slide').eq(slideIndex);
            } else {
                targetSlide = _.$slideTrack.children('.slick-slide').eq(slideIndex + _.options.slidesToShow);
            }
            targetLeft = targetSlide[0] ? targetSlide[0].offsetLeft * -1 : 0;
            if (_.options.centerMode === true) {
                if(_.options.infinite === false) {
                    targetSlide = _.$slideTrack.children('.slick-slide').eq(slideIndex);
                } else {
                    targetSlide = _.$slideTrack.children('.slick-slide').eq(slideIndex + _.options.slidesToShow + 1);
                }
                targetLeft = targetSlide[0] ? targetSlide[0].offsetLeft * -1 : 0;
                targetLeft += (_.$list.width() - targetSlide.outerWidth()) / 2;
            }
        }

         // 1680

        return targetLeft;

    };

    Slick.prototype.getNavigableIndexes = function() {

        var _ = this;

        var breakPoint = 0;
        var counter = 0;
        var indexes = [];

        while (breakPoint < _.slideCount){
            indexes.push(breakPoint);
            breakPoint = counter + _.options.slidesToScroll;
            counter += _.options.slidesToScroll <= _.options.slidesToShow ? _.options.slidesToScroll  : _.options.slidesToShow;
        }

        return indexes;

    };

    Slick.prototype.getSlideCount = function() {

        var _ = this, slidesTraversed;

        if(_.options.swipeToSlide === true) {
            var swipedSlide = null;
            _.$slideTrack.find('.slick-slide').each(function(index, slide){
                if (slide.offsetLeft + ($(slide).outerWidth() / 2) > (_.swipeLeft * -1)) {
                    swipedSlide = slide;
                    return false;
                }
            });
            slidesTraversed = Math.abs($(swipedSlide).attr('index') - _.currentSlide);
            return slidesTraversed;
        } else {
            return _.options.slidesToScroll;
        }

    };

    Slick.prototype.init = function() {

        var _ = this;

        if (!$(_.$slider).hasClass('slick-initialized')) {

            $(_.$slider).addClass('slick-initialized');
            _.buildOut();
            _.setProps();
            _.startLoad();
            _.loadSlider();
            _.initializeEvents();
            _.updateArrows();
            _.updateDots();
        }

        if (_.options.onInit !== null) {
            _.options.onInit.call(this, _);
        }

    };

    Slick.prototype.initArrowEvents = function() {

        var _ = this;

        if (_.options.arrows === true && _.slideCount > _.options.slidesToShow) {
            _.$prevArrow.on('click.slick', {
                message: 'previous'
            }, _.changeSlide);
            _.$nextArrow.on('click.slick', {
                message: 'next'
            }, _.changeSlide);
        }

    };

    Slick.prototype.initDotEvents = function() {

        var _ = this;

        if (_.options.dots === true && _.slideCount > _.options.slidesToShow) {
            $('li', _.$dots).on('click.slick', {
                message: 'index'
            }, _.changeSlide);
        }

        if (_.options.dots === true && _.options.pauseOnDotsHover === true && _.options.autoplay === true) {
            $('li', _.$dots)
                .on('mouseenter.slick', function(){
                    _.paused = true;
                    _.autoPlayClear();
                })
                .on('mouseleave.slick', function(){
                    _.paused = false;
                    _.autoPlay();
                });
        }

    };

    Slick.prototype.initializeEvents = function() {

        var _ = this;

        _.initArrowEvents();

        _.initDotEvents();

        _.$list.on('touchstart.slick mousedown.slick', {
            action: 'start'
        }, _.swipeHandler);
        _.$list.on('touchmove.slick mousemove.slick', {
            action: 'move'
        }, _.swipeHandler);
        _.$list.on('touchend.slick mouseup.slick', {
            action: 'end'
        }, _.swipeHandler);
        _.$list.on('touchcancel.slick mouseleave.slick', {
            action: 'end'
        }, _.swipeHandler);

        _.$list.on('click.slick', _.clickHandler);

        if (_.options.pauseOnHover === true && _.options.autoplay === true) {
            _.$list.on('mouseenter.slick', function(){
                _.paused = true;
                _.autoPlayClear();
            });
            _.$list.on('mouseleave.slick', function(){
                _.paused = false;
                _.autoPlay();
            });
        }

        if(_.options.accessibility === true) {
            _.$list.on('keydown.slick', _.keyHandler);
        }

        if(_.options.focusOnSelect === true) {
            $(_.options.slide, _.$slideTrack).on('click.slick', _.selectHandler);
        }

        $(window).on('orientationchange.slick.slick-' + _.instanceUid, function() {
            _.checkResponsive();
            _.setPosition();
        });

        $(window).on('resize.slick.slick-' + _.instanceUid, function() {
            if ($(window).width() !== _.windowWidth) {
                clearTimeout(_.windowDelay);
                _.windowDelay = window.setTimeout(function() {
                    _.windowWidth = $(window).width();
                    _.checkResponsive();
                    _.setPosition();
                }, 50);
            }
        });

        $('*[draggable!=true]', _.$slideTrack).on('dragstart', function(e){ e.preventDefault(); })

        $(window).on('load.slick.slick-' + _.instanceUid, _.setPosition);
        $(document).on('ready.slick.slick-' + _.instanceUid, _.setPosition);

    };

    Slick.prototype.initUI = function() {

        var _ = this;

        if (_.options.arrows === true && _.slideCount > _.options.slidesToShow) {

            _.$prevArrow.show();
            _.$nextArrow.show();

        }

        if (_.options.dots === true && _.slideCount > _.options.slidesToShow) {

            _.$dots.show();

        }

        if (_.options.autoplay === true) {

            _.autoPlay();

        }

    };

    Slick.prototype.keyHandler = function(event) {

        var _ = this;

        if (event.keyCode === 37 && _.options.accessibility === true) {
            _.changeSlide({
                data: {
                    message: 'previous'
                }
            });
        } else if (event.keyCode === 39 && _.options.accessibility === true) {
            _.changeSlide({
                data: {
                    message: 'next'
                }
            });
        }

    };

    Slick.prototype.lazyLoad = function() {

        var _ = this,
            loadRange, cloneRange, rangeStart, rangeEnd;

        function loadImages(imagesScope) {
            $('img[data-lazy]', imagesScope).each(function() {
                var image = $(this),
                    imageSource = $(this).attr('data-lazy');

                image
                  .load(function() { image.animate({ opacity: 1 }, 200); })
                  .css({ opacity: 0 })
                  .attr('src', imageSource)
                  .removeAttr('data-lazy')
                  .removeClass('slick-loading');
            });
        }

        if (_.options.centerMode === true) {
            if (_.options.infinite === true) {
                rangeStart = _.currentSlide + (_.options.slidesToShow/2 + 1);
                rangeEnd = rangeStart + _.options.slidesToShow + 2;
            } else {
                rangeStart = Math.max(0, _.currentSlide - (_.options.slidesToShow/2 + 1));
                rangeEnd = 2 + (_.options.slidesToShow/2 + 1) + _.currentSlide;
            }
        } else {
            rangeStart = _.options.infinite ? _.options.slidesToShow + _.currentSlide : _.currentSlide;
            rangeEnd = rangeStart + _.options.slidesToShow;
            if (_.options.fade === true ) {
                if(rangeStart > 0) rangeStart--;
                if(rangeEnd <= _.slideCount) rangeEnd++;
            }
        }

        loadRange = _.$slider.find('.slick-slide').slice(rangeStart, rangeEnd);
        loadImages(loadRange);

          if (_.slideCount <= _.options.slidesToShow){
              cloneRange = _.$slider.find('.slick-slide')
              loadImages(cloneRange)
          }else
        if (_.currentSlide >= _.slideCount - _.options.slidesToShow) {
            cloneRange = _.$slider.find('.slick-cloned').slice(0, _.options.slidesToShow);
            loadImages(cloneRange)
        } else if (_.currentSlide === 0) {
            cloneRange = _.$slider.find('.slick-cloned').slice(_.options.slidesToShow * -1);
            loadImages(cloneRange);
        }

    };

    Slick.prototype.loadSlider = function() {

        var _ = this;

        _.setPosition();

        _.$slideTrack.css({
            opacity: 1
        });

        _.$slider.removeClass('slick-loading');

        _.initUI();

        if (_.options.lazyLoad === 'progressive') {
            _.progressiveLazyLoad();
        }

    };

    Slick.prototype.postSlide = function(index) {

        var _ = this;

        if (_.options.onAfterChange !== null) {
            _.options.onAfterChange.call(this, _, index);
        }

        _.animating = false;

        _.setPosition();

        _.swipeLeft = null;

        if (_.options.autoplay === true && _.paused === false) {
            _.autoPlay();
        }

    };

    Slick.prototype.progressiveLazyLoad = function() {

        var _ = this,
            imgCount, targetImage;

        imgCount = $('img[data-lazy]', _.$slider).length;

        if (imgCount > 0) {
            targetImage = $('img[data-lazy]', _.$slider).first();
            targetImage.attr('src', targetImage.attr('data-lazy')).removeClass('slick-loading').load(function() {
                targetImage.removeAttr('data-lazy');
                _.progressiveLazyLoad();
            })
         .error(function () {
          targetImage.removeAttr('data-lazy');
          _.progressiveLazyLoad();
         });
        }

    };

    Slick.prototype.refresh = function() {

        var _ = this,
            currentSlide = _.currentSlide;

        _.destroy();

        $.extend(_, _.initials);

        _.init();

        _.changeSlide({
            data: {
                message: 'index',
                index: currentSlide,
            }
        }, true);

    };

    Slick.prototype.reinit = function() {

        var _ = this;

        _.$slides = _.$slideTrack.children(_.options.slide).addClass(
            'slick-slide');

        _.slideCount = _.$slides.length;

        if (_.currentSlide >= _.slideCount && _.currentSlide !== 0) {
            _.currentSlide = _.currentSlide - _.options.slidesToScroll;
        }

        if (_.slideCount <= _.options.slidesToShow) {
            _.currentSlide = 0;
        }

        _.setProps();

        _.setupInfinite();

        _.buildArrows();

        _.updateArrows();

        _.initArrowEvents();

        _.buildDots();

        _.updateDots();

        _.initDotEvents();

        if(_.options.focusOnSelect === true) {
            $(_.options.slide, _.$slideTrack).on('click.slick', _.selectHandler);
        }

        _.setSlideClasses(0);

        _.setPosition();

        if (_.options.onReInit !== null) {
            _.options.onReInit.call(this, _);
        }

    };

    Slick.prototype.removeSlide = function(index, removeBefore, removeAll) {

        var _ = this;

        if (typeof(index) === 'boolean') {
            removeBefore = index;
            index = removeBefore === true ? 0 : _.slideCount - 1;
        } else {
            index = removeBefore === true ? --index : index;
        }

        if (_.slideCount < 1 || index < 0 || index > _.slideCount - 1) {
            return false;
        }

        _.unload();

        if(removeAll === true) {
            _.$slideTrack.children().remove();
        } else {
            _.$slideTrack.children(this.options.slide).eq(index).remove();
        }

        _.$slides = _.$slideTrack.children(this.options.slide);

        _.$slideTrack.children(this.options.slide).detach();

        _.$slideTrack.append(_.$slides);

        _.$slidesCache = _.$slides;

        _.reinit();

    };

    Slick.prototype.setCSS = function(position) {

        var _ = this,
            positionProps = {}, x, y;

        if (_.options.rtl === true) {
            position = -position;
        }
        x = _.positionProp == 'left' ? position + 'px' : '0px';
        y = _.positionProp == 'top' ? position + 'px' : '0px';

        positionProps[_.positionProp] = position;

        if (_.transformsEnabled === false) {
            _.$slideTrack.css(positionProps);
        } else {
            positionProps = {};
            if (_.cssTransitions === false) {
                positionProps[_.animType] = 'translate(' + x + ', ' + y + ')';
                _.$slideTrack.css(positionProps);
            } else {
                positionProps[_.animType] = 'translate3d(' + x + ', ' + y + ', 0px)';
                _.$slideTrack.css(positionProps);
            }
        }

    };

    Slick.prototype.setDimensions = function() {

        var _ = this;

        if (_.options.vertical === false) {
            if (_.options.centerMode === true) {
                _.$list.css({
                    padding: ('0px ' + _.options.centerPadding)
                });
            }
        } else {
            _.$list.height(_.$slides.first().outerHeight(true) * _.options.slidesToShow);
            if (_.options.centerMode === true) {
                _.$list.css({
                    padding: (_.options.centerPadding + ' 0px')
                });
            }
        }

        _.listWidth = _.$list.width();
        _.listHeight = _.$list.height();


        if(_.options.vertical === false && _.options.variableWidth === false) {
            _.slideWidth = Math.ceil(_.listWidth / _.options.slidesToShow);
            _.$slideTrack.width(Math.ceil((_.slideWidth * _.$slideTrack.children('.slick-slide').length)));

        } else if (_.options.variableWidth === true) {
            var trackWidth = 0;
            _.slideWidth = Math.ceil(_.listWidth / _.options.slidesToShow);
            _.$slideTrack.children('.slick-slide').each(function(){
                trackWidth += Math.ceil($(this).outerWidth(true));
            });
            _.$slideTrack.width(Math.ceil(trackWidth) + 1);
        } else {
            _.slideWidth = Math.ceil(_.listWidth);
            _.$slideTrack.height(Math.ceil((_.$slides.first().outerHeight(true) * _.$slideTrack.children('.slick-slide').length)));
        }

        var offset = _.$slides.first().outerWidth(true) - _.$slides.first().width();
        if (_.options.variableWidth === false) _.$slideTrack.children('.slick-slide').width(_.slideWidth - offset);

    };

    Slick.prototype.setFade = function() {

        var _ = this,
            targetLeft;

        _.$slides.each(function(index, element) {
            targetLeft = (_.slideWidth * index) * -1;
            if (_.options.rtl === true) {
                $(element).css({
                    position: 'relative',
                    right: targetLeft,
                    top: 0,
                    zIndex: 800,
                    opacity: 0
                });
            } else {
                $(element).css({
                    position: 'relative',
                    left: targetLeft,
                    top: 0,
                    zIndex: 800,
                    opacity: 0
                });
            }
        });

        _.$slides.eq(_.currentSlide).css({
            zIndex: 900,
            opacity: 1
        });

    };

    Slick.prototype.setHeight = function() {

        var _ = this;

        if(_.options.slidesToShow === 1 && _.options.adaptiveHeight === true && _.options.vertical === false) {
            var targetHeight = _.$slides.eq(_.currentSlide).outerHeight(true);
            _.$list.css('height', targetHeight);
        }

    };

    Slick.prototype.setPosition = function() {

        var _ = this;

        _.setDimensions();

        _.setHeight();

        if (_.options.fade === false) {
            _.setCSS(_.getLeft(_.currentSlide));
        } else {
            _.setFade();
        }

        if (_.options.onSetPosition !== null) {
            _.options.onSetPosition.call(this, _);
        }

    };

    Slick.prototype.setProps = function() {

        var _ = this,
            bodyStyle = document.body.style;

        _.positionProp = _.options.vertical === true ? 'top' : 'left';

        if (_.positionProp === 'top') {
            _.$slider.addClass('slick-vertical');
        } else {
            _.$slider.removeClass('slick-vertical');
        }

        if (bodyStyle.WebkitTransition !== undefined ||
            bodyStyle.MozTransition !== undefined ||
            bodyStyle.msTransition !== undefined) {
            if(_.options.useCSS === true) {
                _.cssTransitions = true;
            }
        }

        if (bodyStyle.OTransform !== undefined) {
            _.animType = 'OTransform';
            _.transformType = "-o-transform";
            _.transitionType = 'OTransition';
            if (bodyStyle.perspectiveProperty === undefined && bodyStyle.webkitPerspective === undefined) _.animType = false;
        }
        if (bodyStyle.MozTransform !== undefined) {
            _.animType = 'MozTransform';
            _.transformType = "-moz-transform";
            _.transitionType = 'MozTransition';
            if (bodyStyle.perspectiveProperty === undefined && bodyStyle.MozPerspective === undefined) _.animType = false;
        }
        if (bodyStyle.webkitTransform !== undefined) {
            _.animType = 'webkitTransform';
            _.transformType = "-webkit-transform";
            _.transitionType = 'webkitTransition';
            if (bodyStyle.perspectiveProperty === undefined && bodyStyle.webkitPerspective === undefined) _.animType = false;
        }
        if (bodyStyle.msTransform !== undefined) {
            _.animType = 'msTransform';
            _.transformType = "-ms-transform";
            _.transitionType = 'msTransition';
            if (bodyStyle.msTransform === undefined) _.animType = false;
        }
        if (bodyStyle.transform !== undefined && _.animType !== false) {
            _.animType = 'transform';
            _.transformType = "transform";
            _.transitionType = 'transition';
        }
        _.transformsEnabled = (_.animType !== null && _.animType !== false);

    };


    Slick.prototype.setSlideClasses = function(index) {

        var _ = this,
            centerOffset, allSlides, indexOffset, remainder;

        _.$slider.find('.slick-slide').removeClass('slick-active').removeClass('slick-center');
        allSlides = _.$slider.find('.slick-slide');

        if (_.options.centerMode === true) {

            centerOffset = Math.floor(_.options.slidesToShow / 2);

            if(_.options.infinite === true) {

                if (index >= centerOffset && index <= (_.slideCount - 1) - centerOffset) {
                    _.$slides.slice(index - centerOffset, index + centerOffset + 1).addClass('slick-active');
                } else {
                    indexOffset = _.options.slidesToShow + index;
                    allSlides.slice(indexOffset - centerOffset + 1, indexOffset + centerOffset + 2).addClass('slick-active');
                }

                if (index === 0) {
                    allSlides.eq(allSlides.length - 1 - _.options.slidesToShow).addClass('slick-center');
                } else if (index === _.slideCount - 1) {
                    allSlides.eq(_.options.slidesToShow).addClass('slick-center');
                }

            }

            _.$slides.eq(index).addClass('slick-center');

        } else {

            if (index >= 0 && index <= (_.slideCount - _.options.slidesToShow)) {
                _.$slides.slice(index, index + _.options.slidesToShow).addClass('slick-active');
            } else if ( allSlides.length <= _.options.slidesToShow ) {
                allSlides.addClass('slick-active');
            } else {
                remainder = _.slideCount%_.options.slidesToShow;
                indexOffset = _.options.infinite === true ? _.options.slidesToShow + index : index;
                if(_.options.slidesToShow == _.options.slidesToScroll && (_.slideCount - index) < _.options.slidesToShow) {
                    allSlides.slice(indexOffset-(_.options.slidesToShow-remainder), indexOffset + remainder).addClass('slick-active');
                } else {
                    allSlides.slice(indexOffset, indexOffset + _.options.slidesToShow).addClass('slick-active');
                }
            }

        }

        if (_.options.lazyLoad === 'ondemand') {
            _.lazyLoad();
        }

    };

    Slick.prototype.setupInfinite = function() {

        var _ = this,
            i, slideIndex, infiniteCount;

        if (_.options.fade === true) {
            _.options.centerMode = false;
        }

        if (_.options.infinite === true && _.options.fade === false) {

            slideIndex = null;

            if (_.slideCount > _.options.slidesToShow) {

                if (_.options.centerMode === true) {
                    infiniteCount = _.options.slidesToShow + 1;
                } else {
                    infiniteCount = _.options.slidesToShow;
                }

                for (i = _.slideCount; i > (_.slideCount -
                    infiniteCount); i -= 1) {
                    slideIndex = i - 1;
                    $(_.$slides[slideIndex]).clone(true).attr('id', '')
                        .attr('index', slideIndex-_.slideCount)
                        .prependTo(_.$slideTrack).addClass('slick-cloned');
                }
                for (i = 0; i < infiniteCount; i += 1) {
                    slideIndex = i;
                    $(_.$slides[slideIndex]).clone(true).attr('id', '')
                        .attr('index', slideIndex+_.slideCount)
                        .appendTo(_.$slideTrack).addClass('slick-cloned');
                }
                _.$slideTrack.find('.slick-cloned').find('[id]').each(function() {
                    $(this).attr('id', '');
                });

            }

        }

    };

    Slick.prototype.selectHandler = function(event) {

        var _ = this;
        var index = parseInt($(event.target).parents('.slick-slide').attr("index"));
        if(!index) index = 0;

        if(_.slideCount <= _.options.slidesToShow){
            _.$slider.find('.slick-slide').removeClass('slick-active');
            _.$slides.eq(index).addClass('slick-active');
            if(_.options.centerMode === true) {
                _.$slider.find('.slick-slide').removeClass('slick-center');
                _.$slides.eq(index).addClass('slick-center');
            }
            _.asNavFor(index);
            return;
        }
        _.slideHandler(index);

    };

    Slick.prototype.slideHandler = function(index,sync,dontAnimate) {

        var targetSlide, animSlide, oldSlide, slideLeft, unevenOffset, targetLeft = null,
            _ = this;

        sync = sync || false;

        if (_.animating === true && _.options.waitForAnimate === true) {
            return;
        }

        if (_.options.fade === true && _.currentSlide === index) {
            return;
        }

        if (_.slideCount <= _.options.slidesToShow) {
            return;
        }

        if (sync === false) {
            _.asNavFor(index);
        }

        targetSlide = index;
        targetLeft = _.getLeft(targetSlide);
        slideLeft = _.getLeft(_.currentSlide);

        _.currentLeft = _.swipeLeft === null ? slideLeft : _.swipeLeft;

        if (_.options.infinite === false && _.options.centerMode === false && (index < 0 || index > _.getDotCount() * _.options.slidesToScroll)) {
            if(_.options.fade === false) {
                targetSlide = _.currentSlide;
                if(dontAnimate!==true) {
                    _.animateSlide(slideLeft, function() {
                        _.postSlide(targetSlide);
                    });
                } else {
                    _.postSlide(targetSlide);
                }
            }
            return;
        } else if (_.options.infinite === false && _.options.centerMode === true && (index < 0 || index > (_.slideCount - _.options.slidesToScroll))) {
            if(_.options.fade === false) {
                targetSlide = _.currentSlide;
                if(dontAnimate!==true) {
                    _.animateSlide(slideLeft, function() {
                        _.postSlide(targetSlide);
                    });
                } else {
                    _.postSlide(targetSlide);
                }
            }
            return;
        }

        if (_.options.autoplay === true) {
            clearInterval(_.autoPlayTimer);
        }

        if (targetSlide < 0) {
            if (_.slideCount % _.options.slidesToScroll !== 0) {
                animSlide = _.slideCount - (_.slideCount % _.options.slidesToScroll);
            } else {
                animSlide = _.slideCount + targetSlide;
            }
        } else if (targetSlide >= _.slideCount) {
            if (_.slideCount % _.options.slidesToScroll !== 0) {
                animSlide = 0;
            } else {
                animSlide = targetSlide - _.slideCount;
            }
        } else {
            animSlide = targetSlide;
        }

        _.animating = true;

        if (_.options.onBeforeChange !== null && index !== _.currentSlide) {
            _.options.onBeforeChange.call(this, _, _.currentSlide, animSlide);
        }

        oldSlide = _.currentSlide;
        _.currentSlide = animSlide;

        _.setSlideClasses(_.currentSlide);

        _.updateDots();
        _.updateArrows();

        if (_.options.fade === true) {
            if(dontAnimate!==true) {
                _.fadeSlide(oldSlide,animSlide, function() {
                    _.postSlide(animSlide);
                });
            } else {
                _.postSlide(animSlide);
            }
            return;
        }

        if(dontAnimate!==true) {
            _.animateSlide(targetLeft, function() {
                _.postSlide(animSlide);
            });
        } else {
            _.postSlide(animSlide);
        }

    };

    Slick.prototype.startLoad = function() {

        var _ = this;

        if (_.options.arrows === true && _.slideCount > _.options.slidesToShow) {

            _.$prevArrow.hide();
            _.$nextArrow.hide();

        }

        if (_.options.dots === true && _.slideCount > _.options.slidesToShow) {

            _.$dots.hide();

        }

        _.$slider.addClass('slick-loading');

    };

    Slick.prototype.swipeDirection = function() {

        var xDist, yDist, r, swipeAngle, _ = this;

        xDist = _.touchObject.startX - _.touchObject.curX;
        yDist = _.touchObject.startY - _.touchObject.curY;
        r = Math.atan2(yDist, xDist);

        swipeAngle = Math.round(r * 180 / Math.PI);
        if (swipeAngle < 0) {
            swipeAngle = 360 - Math.abs(swipeAngle);
        }

        if ((swipeAngle <= 45) && (swipeAngle >= 0)) {
            return (_.options.rtl === false ? 'left' : 'right');
        }
        if ((swipeAngle <= 360) && (swipeAngle >= 315)) {
            return (_.options.rtl === false ? 'left' : 'right');
        }
        if ((swipeAngle >= 135) && (swipeAngle <= 225)) {
            return (_.options.rtl === false ? 'right' : 'left');
        }

        return 'vertical';

    };

    Slick.prototype.swipeEnd = function(event) {

        var _ = this, slideCount;

        _.dragging = false;

        _.shouldClick = (_.touchObject.swipeLength > 10) ? false : true;

        if (_.touchObject.curX === undefined) {
            return false;
        }

        if (_.touchObject.swipeLength >= _.touchObject.minSwipe) {

            switch (_.swipeDirection()) {
                case 'left':
                    _.slideHandler(_.currentSlide + _.getSlideCount());
                    _.currentDirection = 0;
                    _.touchObject = {};
                    break;

                case 'right':
                    _.slideHandler(_.currentSlide - _.getSlideCount());
                    _.currentDirection = 1;
                    _.touchObject = {};
                    break;
            }
        } else {
            if(_.touchObject.startX !== _.touchObject.curX) {
                _.slideHandler(_.currentSlide);
                _.touchObject = {};
            }
        }

    };

    Slick.prototype.swipeHandler = function(event) {

        var _ = this;

        if ((_.options.swipe === false) || ('ontouchend' in document && _.options.swipe === false)) {
           return;
        } else if (_.options.draggable === false && event.type.indexOf('mouse') !== -1) {
           return;
        }

        _.touchObject.fingerCount = event.originalEvent && event.originalEvent.touches !== undefined ?
            event.originalEvent.touches.length : 1;

        _.touchObject.minSwipe = _.listWidth / _.options
            .touchThreshold;

        switch (event.data.action) {

            case 'start':
                _.swipeStart(event);
                break;

            case 'move':
                _.swipeMove(event);
                break;

            case 'end':
                _.swipeEnd(event);
                break;

        }

    };

    Slick.prototype.swipeMove = function(event) {

        var _ = this,
            curLeft, swipeDirection, positionOffset, touches;

        touches = event.originalEvent !== undefined ? event.originalEvent.touches : null;

        if (!_.dragging || touches && touches.length !== 1) {
            return false;
        }

        curLeft = _.getLeft(_.currentSlide);

        _.touchObject.curX = touches !== undefined ? touches[0].pageX : event.clientX;
        _.touchObject.curY = touches !== undefined ? touches[0].pageY : event.clientY;

        _.touchObject.swipeLength = Math.round(Math.sqrt(
            Math.pow(_.touchObject.curX - _.touchObject.startX, 2)));

        swipeDirection = _.swipeDirection();

        if (swipeDirection === 'vertical') {
            return;
        }

        if (event.originalEvent !== undefined && _.touchObject.swipeLength > 4) {
            event.preventDefault();
        }

        positionOffset = (_.options.rtl === false ? 1 : -1) * (_.touchObject.curX > _.touchObject.startX ? 1 : -1);

        if (_.options.vertical === false) {
            _.swipeLeft = curLeft + _.touchObject.swipeLength * positionOffset;
        } else {
            _.swipeLeft = curLeft + (_.touchObject
                .swipeLength * (_.$list.height() / _.listWidth)) * positionOffset;
        }

        if (_.options.fade === true || _.options.touchMove === false) {
            return false;
        }

        if (_.animating === true) {
            _.swipeLeft = null;
            return false;
        }

        _.setCSS(_.swipeLeft);

    };

    Slick.prototype.swipeStart = function(event) {

        var _ = this,
            touches;

        if (_.touchObject.fingerCount !== 1 || _.slideCount <= _.options.slidesToShow) {
            _.touchObject = {};
            return false;
        }

        if (event.originalEvent !== undefined && event.originalEvent.touches !== undefined) {
            touches = event.originalEvent.touches[0];
        }

        _.touchObject.startX = _.touchObject.curX = touches !== undefined ? touches.pageX : event.clientX;
        _.touchObject.startY = _.touchObject.curY = touches !== undefined ? touches.pageY : event.clientY;

        _.dragging = true;

    };

    Slick.prototype.unfilterSlides = function() {

        var _ = this;

        if (_.$slidesCache !== null) {

            _.unload();

            _.$slideTrack.children(this.options.slide).detach();

            _.$slidesCache.appendTo(_.$slideTrack);

            _.reinit();

        }

    };

    Slick.prototype.unload = function() {

        var _ = this;

        $('.slick-cloned', _.$slider).remove();
        if (_.$dots) {
            _.$dots.remove();
        }
        if (_.$prevArrow && (typeof _.options.prevArrow !== 'object')) {
            _.$prevArrow.remove();
        }
        if (_.$nextArrow && (typeof _.options.nextArrow !== 'object')) {
            _.$nextArrow.remove();
        }
        _.$slides.removeClass(
            'slick-slide slick-active slick-visible').css('width', '');

    };

    Slick.prototype.updateArrows = function() {

        var _ = this, centerOffset;

        centerOffset = Math.floor(_.options.slidesToShow / 2)

        if (_.options.arrows === true && _.options.infinite !==
            true && _.slideCount > _.options.slidesToShow) {
            _.$prevArrow.removeClass('slick-disabled');
            _.$nextArrow.removeClass('slick-disabled');
            if (_.currentSlide === 0) {
                _.$prevArrow.addClass('slick-disabled');
                _.$nextArrow.removeClass('slick-disabled');
            } else if (_.currentSlide >= _.slideCount - _.options.slidesToShow && _.options.centerMode === false) {
                _.$nextArrow.addClass('slick-disabled');
                _.$prevArrow.removeClass('slick-disabled');
            } else if (_.currentSlide > _.slideCount - _.options.slidesToShow + centerOffset  && _.options.centerMode === true) {
                _.$nextArrow.addClass('slick-disabled');
                _.$prevArrow.removeClass('slick-disabled');
            }
        }

    };

    Slick.prototype.updateDots = function() {

        var _ = this;

        if (_.$dots !== null) {

            _.$dots.find('li').removeClass('slick-active');
            _.$dots.find('li').eq(Math.floor(_.currentSlide / _.options.slidesToScroll)).addClass('slick-active');

        }

    };

    $.fn.slick = function(options) {
        var _ = this;
        return _.each(function(index, element) {

            element.slick = new Slick(element, options);

        });
    };

    $.fn.slickAdd = function(slide, slideIndex, addBefore) {
        var _ = this;
        return _.each(function(index, element) {

            element.slick.addSlide(slide, slideIndex, addBefore);

        });
    };

    $.fn.slickCurrentSlide = function() {
        var _ = this;
        return _.get(0).slick.getCurrent();
    };

    $.fn.slickFilter = function(filter) {
        var _ = this;
        return _.each(function(index, element) {

            element.slick.filterSlides(filter);

        });
    };

    $.fn.slickGoTo = function(slide, dontAnimate) {
        var _ = this;
        return _.each(function(index, element) {

            element.slick.changeSlide({
                data: {
                    message: 'index',
                    index: parseInt(slide)
                }
            }, dontAnimate);

        });
    };

    $.fn.slickNext = function() {
        var _ = this;
        return _.each(function(index, element) {

            element.slick.changeSlide({
                data: {
                    message: 'next'
                }
            });

        });
    };

    $.fn.slickPause = function() {
        var _ = this;
        return _.each(function(index, element) {

            element.slick.autoPlayClear();
            element.slick.paused = true;

        });
    };

    $.fn.slickPlay = function() {
        var _ = this;
        return _.each(function(index, element) {

            element.slick.paused = false;
            element.slick.autoPlay();

        });
    };

    $.fn.slickPrev = function() {
        var _ = this;
        return _.each(function(index, element) {

            element.slick.changeSlide({
                data: {
                    message: 'previous'
                }
            });

        });
    };

    $.fn.slickRemove = function(slideIndex, removeBefore) {
        var _ = this;
        return _.each(function(index, element) {

            element.slick.removeSlide(slideIndex, removeBefore);

        });
    };

    $.fn.slickRemoveAll = function() {
        var _ = this;
        return _.each(function(index, element) {

            element.slick.removeSlide(null, null, true);

        });
    };

    $.fn.slickGetOption = function(option) {
        var _ = this;
        return _.get(0).slick.options[option];
    };

    $.fn.slickSetOption = function(option, value, refresh) {
        var _ = this;
        return _.each(function(index, element) {

            element.slick.options[option] = value;

            if (refresh === true) {
                element.slick.unload();
                element.slick.reinit();
            }

        });
    };

    $.fn.slickUnfilter = function() {
        var _ = this;
        return _.each(function(index, element) {

            element.slick.unfilterSlides();

        });
    };

    $.fn.unslick = function() {
        var _ = this;
        return _.each(function(index, element) {

          if (element.slick) {
            element.slick.destroy();
          }

        });
    };

    $.fn.getSlick = function() {
        var s = null;
        var _ = this;
        _.each(function(index, element) {
            s = element.slick;
        });

        return s;
    };

}));

define('home/views/ChannelGroupTabCollectionView',[  // eslint-disable-line requirejs/amd-function-arity
    'underscore',
    'backbone-marionette',
    'handlebars',

    'home/views/ChannelGroupCardView',
    'home/templates/channelGroupTabCollection',

    // imported for side effects
    'jquery.slick',
], function (
    _,
    Marionette,
    Handlebars,

    ChannelGroupCardView,
    channelGroupTabCollectionTemplate
) {
    'use strict';

    /**
     * A collection of Channel Group views, shown as slides in a
     * carousel, and used as tab navigation where each tab id is
     * the id of the Channel Group.
     *
     * Expects a collection of Channels
     */
    var ChannelGroupTabCollectionView = Marionette.CompositeView.extend({
        className: 'carousel-wrapper',

        templateHelpers: function () {
            return {
                exploreTab: this.exploreTab,
            };
        },
        template: channelGroupTabCollectionTemplate,

        initialize: function (options) {
            options = options || {};
            this.exploreTab = options.exploreTab;
            this.activeTab = options.activeTab;
        },

        itemViewContainer: '[data-role=tabs-container]',
        itemView: ChannelGroupCardView,
        itemViewOptions: function (channelGroup) {
            return {
                exploreTab: this.exploreTab,
                attributes: {
                    'data-action': 'switch-tab',
                    'data-tab': channelGroup.id,
                    'class': 'channel-tab__item',
                },
            };
        },

        /**
         * Returns the index of the currently active tab. Accounts
         * for special first tab, the 'all' tab.
         *
         * @returns {number} The index of the currently active tab.
         */
        getActiveTabIndex: function () {
            // Add 1 to the tab index to account for the special 'all' tab
            // that appears first.
            return 1 + _.findIndex(this.collection.models, _.bind(function (channelGroup) {
                return channelGroup.id === this.activeTab;
            }, this));
        },

        onCompositeCollectionRendered: function () {
            if (!this.children.length)
                return;

            _.defer(_.bind(this.slickify, this));
        },

        /**
         * Applies the slick.js plugin to the itemViewContainer
         */
        slickify: function () {
            this.$(this.itemViewContainer).slick({
                slidesToScroll: 1,
                slidesToShow: 5,
                centerMode: true,
                focusOnSelect: true,
                variableWidth: true,
                initialSlide: this.getActiveTabIndex(),
                prevArrow: Handlebars.partials.carouselArrowLeft(),
                nextArrow: Handlebars.partials.carouselArrowRight(),
            });
        },
    });

    return ChannelGroupTabCollectionView;
});

define('home/templates/exploreChannelGroups',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    return "<div data-role=\"channel-groups\" class=\"padding-gutter border-bottom\"></div>\n<div data-role=\"content-area\" class=\"explore__content\"></div>\n";
},"useData":true})

});
define('home/views/ExploreChannelGroupsView',[
    'underscore',

    'core/UniqueModel',

    'home/models/ChannelGroupProfile',
    'home/models/Channel',

    'home/views/common/TabbedView',
    'home/views/FetchingView',
    'home/views/ChannelGroupFeedsView',
    'home/views/ChannelGroupTabCollectionView',

    'home/templates/exploreChannelGroups',
], function (
    _,

    UniqueModel,

    ChannelGroupProfile,
    Channel,

    TabbedView,
    FetchingView,
    ChannelGroupFeedsView,
    ChannelGroupTabCollectionView,

    exploreChannelGroupsTemplate
) {
    'use strict';

    /**
     * View shows a list of channel groups, and the channel feeds available
     * for each channel group.
     *
     * Expects a collection of Channels
     */
    var ExploreChannelGroupsView = TabbedView.extend({
        defaultTab: 'all',

        template: exploreChannelGroupsTemplate,

        regions: _.defaults({
            channelGroupsRegion: '[data-role=channel-groups]',
        }, TabbedView.prototype.regions),

        collectionEvents: {
            sync: 'render',
        },

        initialize: function (options) {
            options = options || {};
            TabbedView.prototype.initialize.call(this, options);
            this.channelFeed = options.channelFeed;
            this.channelTabs = options.channelTabs;
            this.exploreTab = options.exploreTab;
        },

        onDomRefresh: function () {
            TabbedView.prototype.onDomRefresh.call(this);

            this.channelGroupsRegion.show(new ChannelGroupTabCollectionView({
                collection: this.collection,
                exploreTab: this.exploreTab,
                activeTab: this.activeTab,
            }));

            this.updateTabClasses();
        },

        onRender: function () {
            this.updateTabClasses();
        },

        getChannelGroupProfile: function (channel) {
            var channelGroupProfile = new UniqueModel(
                ChannelGroupProfile,
                {
                    id: channel.id,
                    channel: channel,
                }
            );
            channelGroupProfile.ensureFetchedChannel();

            return channelGroupProfile;
        },

        getTabView: function (activeTab) {
            if (!this.collection.length)
                return new FetchingView();

            var viewOptions = {
                activeTab: this.channelFeed,
                exploreTab: this.exploreTab,
                channelGroupTab: activeTab,
                tabs: this.channelTabs,
            };

            if (activeTab === 'all') {
                // The 'all' tab shows content across all channel groups, not any specific
                // channel group. Certain sub feeds under 'all' show content from the
                // spotlight channel, which is curated by hand to contain content from many
                // other channel groups. Other sub feeds under 'all' show content specifically
                // designed for 'all', and stored in a special 'all' ChannelGroupProfile.
                // Pass both the spotlight and the special 'all' ChannelGroupProfiles to the
                // subview.
                var spotlight = new UniqueModel(Channel, { slug: 'spotlight' });
                var spotlightProfile = this.getChannelGroupProfile(spotlight);

                var allChannelGroupsProfile = new UniqueModel(
                    ChannelGroupProfile,
                    {
                        id: ChannelGroupProfile.ALL_CHANNEL_GROUPS_PROFILE_ID,
                    }
                );

                viewOptions.model = spotlightProfile;
                viewOptions.allChannelGroupsProfile = allChannelGroupsProfile;
            } else {
                // The chosen tab shows content only for the selected channel. Pass the
                // ChannelGroupProfile model for that channel to the subview.
                var channel = this.collection.findWhere({ slug: activeTab });

                if (!channel)
                    return null;

                viewOptions.model = this.getChannelGroupProfile(channel);
            }

            return new ChannelGroupFeedsView(viewOptions);
        },
    });

    return ExploreChannelGroupsView;
});

define('home/mixins/withReactSubviews',[
    'underscore',
], function (
    _
) {
    'use strict';

    // Shared modules, only need to be required once
    var React, ReactDOM;
    var sharedModules = {};  // path to imported module

    /**
     * Called once a module has been fetched. Saves the module
     * for future uses, stores it in the component for future
     * rendering, and calls any onFetch callbacks that have
     * been saved on this component.
     *
     * @param  {function} module - The fetched module
     * @param  {Object} component - The component for this view/module
     */
    var handleOnFetch = function (module, component) {
        sharedModules[component.path] = module;
        component.module = module;
        component.fetching = false;

        _.each(component.onFetch, function (fn) {
            if (fn)
                fn();
        });
    };

    /**
     * Called once a component has been rendered into the DOM
     * and we have a reference to it. Saves the ref for future
     * component prop updates and calls on onRef callbacks that
     * have been saved on this component.
     *
     * @param {ReactElement} ref - The ReactElement that has
     *                               been rendered into the DOM
     * @param  {Object} component - The component for this view/module
     */
    var handleRef = function (ref, component) {
        component.ref = ref;

        _.each(component.onRef, function (fn) {
            fn.call(component.ref);
        });
    };

    /**
     * Lazy fetches react modules and react libraries. Tries to use
     * previous imports if module has been imported before, and
     * prevents multiple fetches from kicking off at once.
     *
     * @param  {Object}   component - The component whose module to fetch
     * @param  {function} [callback] - A callback to call once the module
     *                                 has been fetched/retrieved
     */
    var loadModule = function (component, callback) {
        component.onFetch.push(callback);

        if (sharedModules[component.path]) {
            handleOnFetch(sharedModules[component.path], component);
            return;
        }

        if (component.fetching)
            return;

        component.fetching = true;

        // Require subview before react libraries because in production
        // the libraries are bundled into the subview file and are not
        // available to load until the subview file has been loaded.
        require([
            component.path,
        ], function (Module) {
            if (!React || !ReactDOM) {
                require([
                    'react',
                    'react-dom',
                ], function (
                    iReact,
                    iReactDOM
                ) {
                    React = iReact;
                    ReactDOM = iReactDOM;

                    handleOnFetch(Module, component);
                });
            } else {
                handleOnFetch(Module, component);
            }
        });
    };

    /**
     * Mixin takes in a list of react modules that may be rendered by this view.
     * Each module is specified by a path which will be used to reference it during
     * render or updating the props for that subview.
     *
     * Rendering a react subview will automatically import the subview module
     * and react libraries.
     *
     * @param  {string[]} modules - The list of module paths
     */
    var mixin = function (modules) {
        this.initialize = _.wrap(this.initialize, function (_initialize) {
            _initialize.apply(this, _.rest(arguments));

            // Since we map components by path, this view can only have 1
            // instance of a component as a subview. Can change the mapping
            // if need be.
            this._components = _.chain(modules)
                .map(function (path) {
                    return [path, {
                        path: path,
                        onFetch: [],
                        onRef: [],
                    }];
                })
                .object()
                .value();
        });

        /**
         * Renders the specified react component with the given props into
         * the given element. Fetches the module and react libraries if
         * necessary.
         *
         * @param  {string}   path - The path to fetch the module.
         * @param  {Object}   props - The initial props to pass to the
         *                            component.
         * @param  {DOMElement}   el - The element into which to render
         *                             the component.
         * @param  {function} [callback] - A function that will be called
         *                                 once the component exists in
         *                                 the DOM.
         */
        this.renderReactSubview = function (path, props, el, callback) {
            var component = this._components[path];
            if (!component)
                return;

            if (!component.module) {
                loadModule(component, _.bind(this.renderReactSubview, this, path, props, el, callback));
                return;
            }

            var ref = ReactDOM.render(
                React.createElement(React.createClass({
                    displayName: 'wrapper',
                    getInitialState: function () {
                        return props;
                    },
                    render: function () {
                        // Wrap component in an element with data-view-type=react. This is used to prevent
                        // the global backbone anchor click handler from reloading when the clicks come
                        // from a react page.
                        return React.createElement('div', { 'data-view-type': 'react' },
                            React.createElement(component.module, this.state)
                        );
                    },
                })),
                el,
                callback
            );

            handleRef(ref, component);
        };

        /**
         * Updates the set of props given to the component specified by the
         * given path. Expects the component to have been rendered via
         * renderReactSubview previously, even if the module fetching/
         * rendering is not yet complete.
         *
         * @param  {string} path - The path of the module which maps to a
         *                         previously rendered component.
         * @param  {Object} props - The new props to pass to the rendered
         *                          component
         */
        this.updateComponentProps = function (path, props) {
            var component = this._components[path];
            if (!component)
                return;

            if (!component.ref) {
                component.onRef.push(function () {
                    component.ref.setState(props);
                });
                return;
            }

            component.ref.setState(props);
        };
    };

    // Used only for testing
    mixin.forget = function () {
        sharedModules = {};
        React = undefined;
        ReactDOM = undefined;
    };

    return mixin;
});

define('home/views/ExploreChannelGroupsReactViewWrapper',[
    'underscore',
    'backbone-marionette',

    'home/mixins/withReactSubviews',
    'home/utils/navigationUtils',
], function (
    _,
    Marionette,

    withReactSubviews,
    navigationUtils
) {
    'use strict';

    /**
     * An empty Marionette view that simply renders the react ExploreChannelGroupsView
     * into itself. This is done so that any TabbedViews that wish to render the
     * ExploreChannelGroupsView into their content area have a Marionette view that they
     * can render, as they expect.
     */
    var ExploreChannelGroupsReactViewWrapper = Marionette.ItemView.extend({
        template: function () {
            return '';
        },

        initialize: function (options) {
            this.channelGroupsCollection = options.channelGroupsCollection;
            this.rankings = options.rankings;
            this.explorePath = options.explorePath;
        },

        /**
         * Returns the channel groups as a non-backbone data structure to
         * be passed to the react view.
         *
         * @returns {Object[]} - an array of channel group objects
         */
        getChannelGroups: function () {
            return this.channelGroupsCollection.invoke('toJSON');
        },

        onDomRefresh: function () {
            // If the Backbone Collection is fetching, listen for it to
            // complete and update the component props once it does
            if (!this.channelGroupsCollection.length) {
                this.channelGroupsCollection.once('sync', _.bind(function () {
                    this.updateComponentProps(
                        this.constructor.COMPONENTS.CONTENT,
                        { channelGroups: this.getChannelGroups() }
                    );
                }, this));
            }

            this.renderReactSubview(
                this.constructor.COMPONENTS.CONTENT,
                {
                    channelGroups: this.getChannelGroups(),
                    rankings: this.rankings,
                    navigationUtils: navigationUtils,
                    explorePath: this.explorePath,
                },
                this.$el[0]
            );
        },
    }, {
        COMPONENTS: {
            CONTENT: 'core/views/react/ExploreChannelGroupsView',
        },
    });

    withReactSubviews.call(ExploreChannelGroupsReactViewWrapper.prototype,
        ExploreChannelGroupsReactViewWrapper.COMPONENTS);

    return ExploreChannelGroupsReactViewWrapper;
});

define('home/views/AllstarCollectionView',[
    'home/views/UserCollectionView',
], function (
    UserCollectionView
) {
    'use strict';

    /**
     * Shows a list of user cards. Hides private users, since All Stars
     * aren't supposed to be private.
     *
     * Expects a Collection of User Models.
     */
    var AllstarCollectionView = UserCollectionView.extend({
        addItemView: function (item, ItemView, index) {
            if (item.get('isPrivate'))
                return;

            return UserCollectionView.prototype.addItemView.call(this, item, ItemView, index);
        },
    });

    return AllstarCollectionView;
});

define('home/templates/explore',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<li data-action=\"switch-tab\" data-tab=\"people\" class=\"nav__item\">\n<a href=\"/home/explore/people/\" class=\"nav-lnk -color-muted\">\n<div class=\"nav-lnk__blk\">\n<span class=\"button__text\">"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(depth0 != null ? depth0 : (container.nullContext || {}),"People",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":20,"column":27},"end":{"line":20,"column":47}}}))
    + "</span>\n</div>\n<div class=\"nav-lnk__pointer\">\n<span class=\"icon icon-right-bracket\"></span>\n</div>\n</a>\n</li>\n";
},"3":function(container,depth0,helpers,partials,data) {
    var alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<header data-role=\"header\" data-tab=\"people\" class=\"hidden module-header text-center\">\n<div class=\"align-inline spacing-top\">\n<div class=\"module-header__icon spacing-right text-larger\">\n<span class=\"icon-allstar allstar__icon icon__position\"></span>\n</div>\n<div class=\"module-header__title\">\n<h1 class=\"text-larger text-darker\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"All-Stars",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":52,"column":36},"end":{"line":52,"column":59}}}))
    + "</h1>\n</div>\n</div>\n<p class=\"text-medium text-gray spacing-bottom-narrow\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"The star contributors and heart of the community. %(learnMore)s",{"name":"gettext","hash":{"learnMore":lookupProperty(helpers,"tag").call(alias1,"a",{"name":"tag","hash":{"text":"Learn more.","href":"https://disqus.com/home/channel/announcements/discussion/channel-announcements/all_stars/"},"data":data,"loc":{"start":{"line":55,"column":143},"end":{"line":55,"column":268}}})},"data":data,"loc":{"start":{"line":55,"column":55},"end":{"line":55,"column":270}}}))
    + "</p>\n</header>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"section-contained\">\n<div class=\"layout layout--tablet-no-aside\">\n<div class=\"layout__main\">\n<aside class=\"layout__nav\">\n<ul class=\"nav--no-aside\">\n<li data-action=\"switch-tab\" data-tab=\"channels\" class=\"nav__item active\">\n<a href=\"/home/explore/channels/\" class=\"nav-lnk -color-muted\">\n<div class=\"nav-lnk__blk\">\n<span class=\"button__text\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Channels",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":9,"column":27},"end":{"line":9,"column":49}}}))
    + "</span>\n</div>\n<div class=\"nav-lnk__pointer\">\n<span class=\"icon icon-right-bracket\"></span>\n</div>\n</a>\n</li>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"showPeople") : depth0),{"name":"if","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":16,"column":0},"end":{"line":27,"column":7}}})) != null ? stack1 : "")
    + "<li data-action=\"switch-tab\" data-tab=\"discussions\" class=\"nav__item\">\n<a href=\"/home/explore/discussions/\" class=\"nav-lnk -color-muted\">\n<div class=\"nav-lnk__blk\">\n<span class=\"button__text\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Discussions",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":31,"column":27},"end":{"line":31,"column":52}}}))
    + "</span>\n</div>\n<div class=\"nav-lnk__pointer\">\n<span class=\"icon icon-right-bracket\"></span>\n</div>\n</a>\n</li>\n</ul>\n</aside>\n<div class=\"layout__content\">\n<div class=\"content__wrap\">\n<header data-role=\"header\" data-tab=\"channels\" class=\"hidden module-header text-center\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"channelsHeader"),depth0,{"name":"channelsHeader","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</header>\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,(depth0 != null ? lookupProperty(depth0,"showPeople") : depth0),{"name":"if","hash":{},"fn":container.program(3, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":45,"column":0},"end":{"line":57,"column":7}}})) != null ? stack1 : "")
    + "<header data-role=\"header\" data-tab=\"discussions\" class=\"hidden module-header text-center\">\n<div class=\"align-inline spacing-top\">\n<div class=\"module-header__icon spacing-right text-larger\">\n<span class=\"icon-notification-response text-brand icon__position\"></span>\n</div>\n<div class=\"module-header__title\">\n<h1 class=\"text-larger text-darker\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Discussions",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":64,"column":36},"end":{"line":64,"column":61}}}))
    + "</h1>\n</div>\n</div>\n<p class=\"text-medium text-gray spacing-bottom-narrow\">"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"What people are talking about.",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":67,"column":55},"end":{"line":67,"column":99}}}))
    + "</p>\n</header>\n<section id=\"content-area\" data-role=\"content-area\"></section>\n</div>\n</div>\n</div>\n</div>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/ExploreView',[
    'core/switches',
    'core/constants/exploreModuleConstants',

    'home/models/Session',
    'home/views/common/TabbedView',
    'home/views/common/FetchableCollectionLayout',
    'home/views/HideOnEndFooterView',
    'home/views/ExploreChannelGroupsView',
    'home/views/ExploreChannelGroupsReactViewWrapper',
    'home/views/AllstarCollectionView',

    'home/templates/explore',
], function (
    switches,
    exploreModuleConstants,

    Session,
    TabbedView,
    FetchableCollectionLayout,
    HideOnEndFooterView,
    ExploreChannelGroupsView,
    ExploreChannelGroupsReactViewWrapper,
    AllstarCollectionView,

    exploreTemplate
) {
    'use strict';

    var homeReact = switches.isFeatureActive('homeReact');

    /**
     * This is the view shown for Explore nav item. Shows tabs the user can
     * explore on the left, and the content in the center.
     */
    var ExploreView = TabbedView.extend({
        defaultTab: 'channels',

        template: exploreTemplate,
        templateHelpers: function () {
            return {
                // Need to be authenticated to fetch all stars list
                showPeople: !Session.isKnownToBeLoggedOut(),
            };
        },

        initialize: function (options) {
            options = options || {};
            TabbedView.prototype.initialize.call(this, options);
            this.channelId = options.channelId;
            this.channelFeed = options.channelFeed;
            this.session = Session.get();

            this.listenTo(this, 'change:activeTab', this.updateHeader);
        },

        updateHeader: function (activeTab) {
            this.$('[data-role=header]').addClass('hidden');
            this.$('[data-role=header][data-tab=' + activeTab + ']').removeClass('hidden');
        },

        getTabView: function (activeTab) {
            var channelGroupTabs = exploreModuleConstants.TABS;

            switch (activeTab) {
            case 'channels':
                this.model.exploreChannelCollection.ensureFetched();
                if (homeReact) {
                    return new ExploreChannelGroupsReactViewWrapper({
                        channelGroupsCollection: this.model.exploreChannelCollection,
                        rankings: [channelGroupTabs.TOP, channelGroupTabs.POPULAR, channelGroupTabs.RECENT],
                        explorePath: activeTab,
                    });
                }

                return new ExploreChannelGroupsView({
                    collection: this.model.exploreChannelCollection,
                    activeTab: this.channelId,
                    channelFeed: this.channelFeed,
                    channelTabs: [channelGroupTabs.TOP, channelGroupTabs.POPULAR, channelGroupTabs.RECENT],
                    exploreTab: activeTab,
                });
            case 'people':
                this.model.allStars.ensureFetched();
                return new FetchableCollectionLayout({
                    model: this.model.allStars,
                    collection: this.model.allStars.items,
                    fetchableCollectionView: AllstarCollectionView,
                    fetchableCollectionFooterView: HideOnEndFooterView,
                    infiniteScroll: true,
                });
            case 'discussions':
                this.model.exploreChannelCollection.ensureFetched();
                return new ExploreChannelGroupsView({
                    collection: this.model.exploreChannelCollection,
                    activeTab: this.channelId,
                    channelFeed: this.channelFeed,
                    channelTabs: [channelGroupTabs.DISCUSSIONS],
                    exploreTab: activeTab,
                });
            }
        },
    });

    return ExploreView;
});

define('home/templates/completeOnboarding',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=container.lambda, alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"onboard-complete__channel spacing-top\">\n<span data-steps=\""
    + alias2(alias1((depth0 != null ? lookupProperty(depth0,"steps") : depth0), depth0))
    + "\" data-duration=\"550\" class=\"onboard-complete__avatar relative__wrapper inline_block spacing-right\">\n<span class=\"onboard-complete__img\">"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"channelAvatarWithDefault"),(depth0 != null ? lookupProperty(depth0,"channel") : depth0),{"name":"channelAvatarWithDefault","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</span>\n<span class=\"onboard-complete__checkmark icon-checkmark\"></span>\n</span>\n<strong>"
    + alias2(alias1(((stack1 = (depth0 != null ? lookupProperty(depth0,"channel") : depth0)) != null ? lookupProperty(stack1,"name") : stack1), depth0))
    + "</strong>\n</div>\n";
},"3":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"spacing-top\">\n"
    + ((stack1 = lookupProperty(helpers,"if").call(alias1,lookupProperty(helpers,"eq").call(alias1,(depth0 != null ? lookupProperty(depth0,"overflowCount") : depth0),1,{"name":"eq","hash":{},"data":data,"loc":{"start":{"line":24,"column":6},"end":{"line":24,"column":26}}}),{"name":"if","hash":{},"fn":container.program(4, data, 0),"inverse":container.program(6, data, 0),"data":data,"loc":{"start":{"line":24,"column":0},"end":{"line":28,"column":7}}})) != null ? stack1 : "")
    + "</div>\n";
},"4":function(container,depth0,helpers,partials,data) {
    return "<strong>… and 1 other</strong>\n";
},"6":function(container,depth0,helpers,partials,data) {
    var lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<strong>… and "
    + container.escapeExpression(container.lambda((depth0 != null ? lookupProperty(depth0,"overflowCount") : depth0), depth0))
    + " others</strong>\n";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=container.escapeExpression, lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"onboard-complete\">\n<span class=\"spinner\"></span>\n\n<section data-steps=\"1\" data-duration=\"700\" class=\"onboard-complete__step text-gray-darker\">\n<strong>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Building your feed…",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":7,"column":8},"end":{"line":7,"column":41}}}))
    + "</strong>\n</section>\n\n<section data-steps=\""
    + alias2(container.lambda((depth0 != null ? lookupProperty(depth0,"channelsShownSteps") : depth0), depth0))
    + "\" data-role=\"channels\" class=\"onboard-complete__step text-center text-gray-darker\">\n<strong>"
    + alias2(lookupProperty(helpers,"gettext").call(alias1,"Adding channels you followed…",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":12,"column":8},"end":{"line":12,"column":51}}}))
    + "</strong>\n"
    + ((stack1 = lookupProperty(helpers,"each").call(alias1,(depth0 != null ? lookupProperty(depth0,"channels") : depth0),{"name":"each","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":13,"column":0},"end":{"line":21,"column":9}}})) != null ? stack1 : "")
    + ((stack1 = lookupProperty(helpers,"if_all").call(alias1,(depth0 != null ? lookupProperty(depth0,"overflowCount") : depth0),(depth0 != null ? lookupProperty(depth0,"isEnglish") : depth0),{"name":"if_all","hash":{},"fn":container.program(3, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":22,"column":0},"end":{"line":30,"column":11}}})) != null ? stack1 : "")
    + "</section>\n</div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/CompleteOnboardingView',[
    'underscore',
    'backbone-marionette',

    'home/mixins/withOnboarding',
    'home/templates/completeOnboarding',
], function (
    _,
    Marionette,

    withOnboarding,
    completeOnboardingTemplate
) {
    'use strict';

    /**
     * Shows messaging to user when they have completed onboarding.
     * Messages and icons are shown/hidden/changed in a step-by-step
     * flow, where the steps are transitioned on timers.
     */
    var CompleteOnboardingview = Marionette.ItemView.extend({
        template: completeOnboardingTemplate,
        templateHelpers: function () {
            var channelsFollowing = this.getChannelsFollowing();
            var channelData = this.getChannelsForRender(channelsFollowing);

            return {
                isEnglish: window.document.documentElement.lang === 'en',
                channels: channelData,
                overflowCount: Math.max(
                    channelsFollowing.length - this.constructor.NUM_CHANNELS_SHOWN,
                    0),

                // The steps during which the list of channels shows.
                channelsShownSteps: _.range(
                    this.constructor.ACTIVATE_CHANNEL_LIST_STEP,
                    this.constructor.ACTIVATE_CHANNEL_LIST_STEP + this.constructor.NUM_CHANNELS_SHOWN + 1
                ).join(' '),
            };
        },

        /**
         * Returns a subset of given channels, as many as is specified in class constants.
         * Each channel is returned along with the steps numbers that channel should
         * appear active for.
         *
         * @param {Backbone.Collection} channels A Backbone Collection of Forum models
         *                                       that have a Channel model relation.
         *
         * @returns {Object[]} Each returned item is an object of the form:
         *                     channel - The JSON of the followed channel
         *                     steps - A space separated string listing the
         *                             steps during which this channel should appear as active.
         */
        getChannelsForRender: function (channels) {
            var self = this;
            return _.chain(channels)
                .first(this.constructor.NUM_CHANNELS_SHOWN)
                .map(function (forum, index) {
                    return {
                        channel: forum.channel.toJSON(),

                        // The first channel is activated on the step after the step
                        // that activated the list of channels.
                        // Each subsequent step is activated in turn.
                        // Once a step has been activated it remains active for the
                        // rest of the channel activation steps.
                        steps: _.range(
                            index + self.constructor.ACTIVATE_CHANNEL_LIST_STEP + 1,
                            self.constructor.ACTIVATE_CHANNEL_LIST_STEP + self.constructor.NUM_CHANNELS_SHOWN + 1
                        ).join(' '),
                    };
                })
                .value();
        },

        onShow: function () {
            this.activateSteps(1);
        },

        /**
         * Activates the given step for the length of time specified by
         * data attrs before queuing up the activation of the next step.
         * When there are no steps left, triggers completion.
         *
         * @param {number} curStep - Which step the messaging is currently on.
         *                           Only elements that show for this step will
         *                           receive an active class.
         */
        activateSteps: function (curStep) {
            this.$('[data-steps]').removeClass('active');
            var $curElements = this.$('[data-steps~=' + curStep + ']');

            if (!$curElements.length) {
                this.trigger('complete');
                return;
            }

            $curElements.addClass('active');
            var duration = this.$('[data-steps~=' + curStep + '][data-duration]').attr('data-duration') ||
                this.constructor.DEFAULT_STEP_DURATION;

            _.delay(_.bind(this.activateSteps, this, curStep + 1), duration);
        },
    }, {
        // The amount of time for a step to remain active if that time is
        // not specified in the DOM.
        DEFAULT_STEP_DURATION: 1000,

        // The step during which the list of channels is activated.
        ACTIVATE_CHANNEL_LIST_STEP: 2,

        // The number of channels to show. If more channel are followed,
        // the overflow count is shown.
        NUM_CHANNELS_SHOWN: 3,
    });

    withOnboarding.call(CompleteOnboardingview.prototype);

    return CompleteOnboardingview;
});

define('home/templates/onboarding',['handlebars', 'handlebars.partials', 'core/extensions/handlebars.helpers'], function(Handlebars) {

return Handlebars.template({"1":function(container,depth0,helpers,partials,data) {
    return " is-complete";
},"compiler":[8,">= 4.3.0"],"main":function(container,depth0,helpers,partials,data) {
    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {}), lookupProperty = container.lookupProperty || function(parent, propertyName) {
        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
          return parent[propertyName];
        }
        return undefined
    };

  return "<div class=\"onboard-banner align align--stretch"
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"numRemainingSteps") : depth0),{"name":"unless","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":1,"column":47},"end":{"line":1,"column":99}}})) != null ? stack1 : "")
    + "\" data-role=\"banner-wrapper\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"onboardingBanner"),depth0,{"name":"onboardingBanner","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n<div class=\"onboard-banner-scrolled text-center text-semibold"
    + ((stack1 = lookupProperty(helpers,"unless").call(alias1,(depth0 != null ? lookupProperty(depth0,"numRemainingSteps") : depth0),{"name":"unless","hash":{},"fn":container.program(1, data, 0),"inverse":container.noop,"data":data,"loc":{"start":{"line":4,"column":61},"end":{"line":4,"column":113}}})) != null ? stack1 : "")
    + "\" data-role=\"fixed-banner\">\n<div class=\"onboard-banner-scrolled__message\" data-role=\"instructions\">\n"
    + ((stack1 = container.invokePartial(lookupProperty(partials,"onboardingBannerInstructions"),depth0,{"name":"onboardingBannerInstructions","data":data,"helpers":helpers,"partials":partials,"decorators":container.decorators})) != null ? stack1 : "")
    + "</div>\n<button data-action=\"finish\" class=\"onboard-banner-scrolled__continue button button-medium button-outline button-padding-wider -border-light\">\n"
    + container.escapeExpression(lookupProperty(helpers,"gettext").call(alias1,"Continue",{"name":"gettext","hash":{},"data":data,"loc":{"start":{"line":9,"column":0},"end":{"line":9,"column":22}}}))
    + " &raquo;\n</button>\n</div>\n<div class=\"onboard__channels section-contained-narrow content__wrap\" data-role=\"explore\"></div>\n<div class=\"onboard-overlay is-hidden align align--middle align--center\" data-role=\"overlay\"></div>\n";
},"usePartial":true,"useData":true})

});
define('home/views/OnboardingView',[
    'jquery',
    'handlebars',
    'underscore',
    'backbone-marionette',

    'core/constants/exploreModuleConstants',
    'core/utils/url/parseQueryString',
    'core/UniqueModel',

    'home/mixins/withOnboarding',

    'home/models/Session',
    'home/models/Forum',

    'home/views/CompleteOnboardingView',
    'home/views/ExploreChannelGroupsView',
    'home/templates/onboarding',
], function (
    $,
    Handlebars,
    _,
    Marionette,

    exploreModuleConstants,
    parseQueryString,
    UniqueModel,

    withOnboarding,

    Session,
    Forum,

    CompleteOnboardingView,
    ExploreChannelGroupsView,
    onboardingTemplate
) {
    'use strict';

    var OnboardingView = Marionette.Layout.extend({
        className: 'is-onboard-welcome',
        template: onboardingTemplate,
        templateHelpers: function () {
            var numTotalSteps = this.constructor.NUM_STEPS;
            return {
                numTotalSteps: numTotalSteps,
                numRemainingSteps: Math.max(numTotalSteps - this.getStepNumber() + 1, 0),
                emailVerified: Boolean(parseQueryString().email_verified),
                canSkip: this.userCanSkip(),

                // this.user isn't set until session loads
                sessionUser: this.user && this.user.toJSON(),
            };
        },

        regions: {
            exploreRegion: '[data-role=explore]',
            overlayRegion: '[data-role=overlay]',
        },

        ui: {
            bannerWrapper: '[data-role=banner-wrapper]',
            fixedBanner: '[data-role=fixed-banner]',
        },

        events: {
            'click [data-action=finish]': 'showCompleteOverlay',
            'click [data-action=hide-welcome]': 'hideWelcomeOverlay',
        },

        initialize: function (options) {
            options = options || {};
            this.channelId = options.channelId;
            this.initForum();

            this.session = Session.get();
            this.session.loadPromise().then(_.bind(function () {
                this.user = this.session.user;
                this.render();
            }, this));

            this.listenTo(this, 'change:stepNumber', this.updateBanners);

            this.onScroll = _.bind(this.onScroll, this);
            $(window).on('scroll', this.onScroll);
        },

        onClose: function () {
            $(window).off('scroll', this.onScroll);
        },

        initForum: function () {
            var forumId = parseQueryString().forum_id;

            if (forumId) {
                this.forum = new UniqueModel(Forum, { id: forumId });

                if (this.forum.shouldFetch()) {
                    this.forum.fetch().always(_.bind(this.handleWelcome, this));
                    return;
                }
            }

            this.handleWelcome();
        },

        onScroll: _.debounce(function () {
            var showFixedBanner = $(window).scrollTop() >= this.bannerBottom;
            this.ui.fixedBanner.toggleClass('is-visible', showFixedBanner);
        }, 100),

        updateBanners: function () {
            var data = this.serializeData();
            this.mixinTemplateHelpers(data);
            this.ui.bannerWrapper.html(Handlebars.partials.onboardingBanner(data));

            this.ui.bannerWrapper.toggleClass('is-complete', !data.numRemainingSteps);
            this.ui.fixedBanner.toggleClass('is-complete', !data.numRemainingSteps);
        },

        onDomRefresh: function () {
            var channelGroupTabs = exploreModuleConstants.TABS;

            this.collection.ensureFetched();
            this.exploreRegion.show(new ExploreChannelGroupsView({
                collection: this.collection,
                activeTab: this.channelId,
                channelTabs: [channelGroupTabs.TOP],

                // When in onboarding, the only top level tab available to
                // explore is channels (not discussions or people).
                exploreTab: 'channels',
            }));

            this.bannerBottom = this.ui.bannerWrapper.outerHeight();
        },

        /**
         * If the user arrived from the embed, an overlay is shown with a message
         * including the referring forum. The user must click to close this overlay.
         *
         * If there is no referring forum, or after the user clicks to close the
         * overlay, the page transitions through a time-based welcome animation
         * controlled by class changes.
         */
        handleWelcome: function () {
            if (!this.forum) {
                this.beginWelcomeAnimation();
                return;
            }

            this.overlayRegion.ensureEl();
            this.overlayRegion.$el
                .removeClass('is-hidden')
                .html(Handlebars.partials.welcomeOverlay({
                    forum: this.forum.toJSON(),
                }));
        },

        showCompleteOverlay: function () {
            var completeOnboardingView = new CompleteOnboardingView();
            this.listenTo(completeOnboardingView, 'complete', this.completeOnboarding);

            this.overlayRegion.show(completeOnboardingView);
            this.overlayRegion.$el.removeClass('is-hidden');
        },

        hideWelcomeOverlay: function () {
            this.overlayRegion.ensureEl();
            this.overlayRegion.$el.addClass('is-hidden');
            this.beginWelcomeAnimation();
        },

        beginWelcomeAnimation: function () {
            _.delay(
                _.bind(this.$el.removeClass, this.$el, 'is-onboard-welcome'),
                this.constructor.WELCOME_MESSAGE_DURATION
            );
        },
    }, {
        WELCOME_MESSAGE_DURATION: 2000,
    });

    withOnboarding.call(OnboardingView.prototype);

    return OnboardingView;
});

define('home/viewmodels/DiscussionCreateViewModel',[
    'underscore',
    'backbone',

    'home/utils/backboneUtils',

    'home/models/Thread',
    'home/models/Topic',
    'core/UniqueModel',
    'home/collections/TopicCollection',
], function (
    _,
    Backbone,

    backboneUtils,

    Thread,
    Topic,
    UniqueModel,
    TopicCollection
) {
    'use strict';

    var DiscussionCreateViewModel = Backbone.Model.extend({
        editableThreadAttrs: [
            'title',
            'message',
        ],

        initialize: function (_attributes, options) {
            this.thread = options.thread || new Thread({
                forum: options.forum,
            });

            // Add forum details so that they are available for rendering on the
            // Discussion page when this form is submitted
            if (this.thread.forum.shouldFetch())
                this.thread.forum.fetch();

            this.topics = new TopicCollection([], { thread: this.thread });

            this.listenTo(this, 'change:category', this.updateTopicCategory);

            backboneUtils.getPromiseFor(this.thread, 'id').then(_.bind(this.onThreadInit, this));
        },

        onThreadInit: function () {
            UniqueModel.set(Thread, this.thread);

            // Copy the attributes needed for the view onto this. This will store
            // the value as shown in the view, that can be edited. The value will
            // not be updated on the thread model until the changes are saved.
            // This way if the edit is cancelled, the thread model is in the
            // correct unchanged state.
            this.set(this.thread.pick(this.editableThreadAttrs));

            this.topics.add(this.thread.topics.models);

            this.initCategory();
        },

        initCategory: function () {
            var channel = this.thread.forum.channel;
            var categories = channel && channel.getCategories();

            if (!categories)
                return;

            // Since categories are chosen by adding the category as a topic, technically
            // a thread could have multiple categories. Topic Collection validation should
            // prevent this, so assume the chosenCategories returned has max length 1.
            var chosenCategories = this.topics.getCategoryTopics();

            // TODO remove
            // Temporary backwards compatibility, parses the category from the title prefix
            // where it used to be stored before it used topics
            if (!chosenCategories.length) {
                var titlePrefix = this.get('title').split(Thread.CATEGORY_TITLE_SEPARATOR)[0];

                if (titlePrefix && categories[titlePrefix])
                    chosenCategories = [Topic.getOrCreateTopic(titlePrefix)];
            }

            // Make sure a previusly saved category is hidden from the user
            if (chosenCategories.length) {
                chosenCategories[0].set({ hidden: true });

                this.set({
                    category: chosenCategories[0].get('displayName'),
                });
            }
        },

        updateTopicCategory: function (_model, newCategory) {
            if (!newCategory)
                return;

            var chosenCategories = this.topics.getCategoryTopics();
            _.each(chosenCategories, this.topics.remove, this.topics);

            var newTopic = Topic.getOrCreateTopic(newCategory);
            newTopic.set({ hidden: true });
            this.topics.add(newTopic);
        },

        validate: function (attrs) {
            var errs = _.compact([
                this.thread.validate(_.pick(attrs, this.editableThreadAttrs)),
                this.topics.validate(),
            ]);

            return errs.length ? errs : null;
        },

        toJSON: function () {
            return _.defaults({
                thread: this.thread.toJSON(),
            }, Backbone.Model.prototype.toJSON.call(this));
        },

        saveVisibleTopics: function () {
            this.topics.save();
        },

    });

    return DiscussionCreateViewModel;
});

define('home/viewmodels/ChannelsViewModel',[
    'backbone',

    'core/UniqueModel',

    'home/collections/ChannelCollection',
    'home/models/FollowRecommendationFeed',
    'home/models/Session',
], function (
    Backbone,

    UniqueModel,

    ChannelCollection,
    FollowRecommendationFeed,
    Session
) {
    'use strict';

    var ChannelsViewModel = Backbone.Model.extend({
        initialize: function () {
            var recommendationAttrs = {
                fetchOptions: {
                    limit: 5,
                },
            };
            this.interestingUsers = FollowRecommendationFeed.createUserFollowRecommendationFeed(recommendationAttrs);
            this.promotedChannels = new ChannelCollection([], { listName: 'promoted' });
            this.sessionUserProfile = Session.get().userProfile;
        },

        ensureFetched: function () {
            this.interestingUsers.ensureFetched();
            this.promotedChannels.ensureFetched();
            this.sessionUserProfile.ensureFetchedAllChannels();
        },
    });

    UniqueModel.addType('ChannelsViewModel', ChannelsViewModel);

    return ChannelsViewModel;
});


define('home/collections/common/SelectiveCollection',[
    'jquery',
    'underscore',
    'backbone',
], function (
    $,
    _,
    Backbone
) {
    'use strict';

    /**
     * Builds a collection from a given ordered backer collection. Selects
     * only certain items to a certain limit.
     *
     * The given backing collection of models will be scanned in order, each
     * model checked for selectability. The first items that pass the
     * selectability test will be inserted into this collection, up to the
     * max number specified.
     *
     * If there are not enough items that pass the selectability test, there
     * will be less than the specified number of items shown.
     *
     * Initialization Options:
     *
     * {Collection} toSelect (required) - A collection of models that may be
     *     selected for this collection. These will be checked in order for
     *     selectability, and the top <maxSize> will be added to this collection.
     *
     * {function} shouldSelect (optional) - A function that takes an item from
     *     <toSelect> and returns a promise (or bool). If this promise is resolved, the
     *     item will be added to this collection. If the promise is rejected, the
     *     next item in <toSelect> will be checked for selectability. If not given,
     *     all items will be assumed to be selectable.
     *
     * {number} maxSize (optional) - The number of items from <toSelect> that
     *     should be selected (assuming there are enough that pass <shouldSelect>).
     *     If not given, all the items from <toSelect> that pass <shouldSelect> will
     *     be added to this collection.
     *
     * {function} order (optional) - The ordering to test the items in <toFeature> for
     *     featurability. Takes the collection and converts to an array of models.
     */
    var SelectiveCollection = Backbone.Collection.extend({
        initialize: function (models, options) {
            if (models)
                // If models is defined, even as an empty array, this collection will be reset
                // with the given models after this initialization, which will overwrite any
                // selected items that have already resolved and been added.
                throw new Error('SelectiveCollection should be initialized with undefined models to be allowed to populate itself from a given toSelect collection');

            if (!options || !options.toSelect || !(options.toSelect instanceof Backbone.Collection))
                throw new Error('SelectiveCollection must be initialized with a toSelect collection');

            this.toSelect = options.toSelect;
            this.shouldSelect = options.shouldSelect || this.shouldSelect;
            this.maxSize = options.maxSize;
            this.order = options.order || this.order;

            this.selectComplete = $.Deferred();

            if (this.toSelect.length)
                this.selectFrom(this.toSelect);
            else
                this.toSelect.once('sync', this.selectFrom, this);
        },

        selectFrom: function (collection) {
            if (!collection.length) {
                this.completeSelection();
                return;
            }

            this.maxSize = _.isNumber(this.maxSize) ?
                this.maxSize :
                collection.length;

            var stack = this.order(collection);
            this.resolveSelectability(stack.shift(), stack);
        },

        resolveSelectability: function (item, rest) {
            if (!item) {
                this.completeSelection();
                return;
            }

            var self = this;

            // Want to select items in the order they are checked for selectability. Should
            // only check 1 item at a time for selectability. Once selectability has been
            // resolved, can start checking the next item. Otherwise items may be selected
            // out of order if a later check resolves first.
            $.when(this.shouldSelect(item)).then(function (shouldSelect) {
                if (shouldSelect)
                    self.select(item);

                // If we need more items to fill this collection, check the next item in
                // order for selectibility
                if (self.length < self.maxSize)
                    self.resolveSelectability(rest.shift(), rest);
                else
                    self.completeSelection();
            });
        },

        /**
         * Returns a promise which resolves when the selection process is complete.
         * @returns {Promise}
         */
        isComplete: function () {
            return this.selectComplete.promise();
        },

        /**
         * Marks the selection as completed.
         */
        completeSelection: function () {
            this.selectComplete.resolve();
        },

        /**
         * Given an item, add it to this collection
         */
        select: function (model) {
            // if already selected the max number of items, don't do anything
            if (this.length >= this.maxSize) {
                this.completeSelection();
                return;
            }

            this.add(model);
        },

        /**
         * Default shouldSelect function (always select) if not passed
         * via `options.shouldSelect` in initialization
         * @returns {boolean} should the model passed in be selected
         */
        shouldSelect: function (/* model */) {
            return true;
        },

        /**
         * Default order function if not passed via `options.order` in
         * initialization - simply returns the array of models in their
         * current order in the collection
         * @param  {Collection} collection the toSelect collection
         * @returns {Array}            an array of Models in selection order
         */
        order: function (collection) {
            return collection.toArray();
        },
    });

    return SelectiveCollection;
});

define('home/viewmodels/DiscussionViewModel',[
    'underscore',
    'backbone',

    'core/UniqueModel',

    'home/collections/common/SelectiveCollection',
    'home/models/ChannelProfile',
    'home/models/ChannelProfileFeed',
], function (
    _,
    Backbone,

    UniqueModel,

    SelectiveCollection,
    ChannelProfile,
    ChannelProfileFeed
) {
    'use strict';

    // Implement a Unique DiscussionViewModel by the related Thread model.
    var pool = {};

    var parent = Backbone.Model;
    var parentProto = parent.prototype;

    var DiscussionViewModel = parent.extend({
        initialize: function (_attributes, options) {
            this.thread = options.thread;

            // Sometimes the channel is passed in via options.channel.
            // This occurs primarily when a user clicks onto a discussion
            // page for a "network thread" from a channel feed.
            // If not, check if the thread's forum has a channel once it's
            // fetched.
            this.channel = options.channel || this.thread.forum.channel;
            if (!this.channel && this.thread.shouldFetch()) {
                this.listenToOnce(this.thread, 'sync', function () {
                    this.channel = this.thread.forum.channel;
                    this.trigger('changeRelated:channel');
                });
            }

            this.channels = new UniqueModel(ChannelProfileFeed, {
                listName: ChannelProfileFeed.LIST_NAMES.promoted,
            });

            this.buildRelatedCollections();
        },

        buildRelatedCollections: function () {
            if (!this.channel)
                return;

            var channelProfile = new UniqueModel(
                ChannelProfile,
                {
                    id: this.channel.id,
                    channel: this.channel,
                }
            );
            channelProfile.ensureFetchedTopActivities();
            var relatedThreads = channelProfile.topActivities.get('items');
            var self = this;

            // Builds the collection of 5 related threads shown in the cover area.
            // Ensures that the collection does not contain the current thread.
            this.coverRelatedCollection = new SelectiveCollection(undefined, {
                toSelect: relatedThreads,
                maxSize: 5,
                shouldSelect: function (activityFeedItem) {
                    // Feature if it's not the same as the thread
                    // currently shown on page
                    return activityFeedItem.thread !== self.thread;
                },
                order: function (collection) {
                    return collection.shuffle();
                },
            });
        },

        /**
         * Tries to determines if the thread is generated by the embed or through a manual user entry.
         *
         * @returns {boolean} `true` if we certainly know thread is a network thread,
         *                    `false` otherwise (user-generated, indeterminate etc.).
         */
        isKnownToBeNetworkThread: function () {
            return this.thread.has('isUserGenerated') && !this.thread.get('isUserGenerated');
        },

        ensureFetched: function () {
            this.channels.ensureFetched();
            this.ensureFetchedChannel();
        },

        ensureFetchedChannel: function () {
            if (this.channel)
                this.channel.ensureFetchedWithCounters();
            else
                this.listenTo(this, 'changeRelated:channel', this.ensureFetchedChannel);
        },

        toJSON: function (options) {
            return _.defaults({
                thread: this.thread.toJSON(),
            }, parentProto.toJSON.call(this, options));
        },
    }, {
        getOrCreate: function (attrs, options) {
            var thread = options && options.thread;

            // Can't use thread id because we may not have it at this point, we may have thread slug
            // and forum shortname. But since thread uses UniqueModel, should work to use thread.cid
            // to ensure uniqueness of DiscussionViewModel. In worst case, we fetch the view model
            // multiple times, but nothing should break.
            var existing = thread && pool[thread.cid];

            if (existing)
                return existing;

            var model = new DiscussionViewModel(attrs, options);

            if (thread)
                pool[thread.cid] = model;

            model.ensureFetched();

            return model;
        },
    });

    return DiscussionViewModel;
});

define('home/collections/MostLikedUserCollection',[
    'underscore',
    'core/api',
    'core/collections/PaginatedCollection',
    'core/UniqueModel',
    'home/models/User',
], function (
    _,
    api,
    PaginatedCollection,
    UniqueModel,
    User
) {
    'use strict';

    return PaginatedCollection.extend({

        initialize: function (_models, options) {
            this.forum = options.forum;  // forum is shortname/url string
        },

        model: UniqueModel.boundModel(User),
        url: api.getURL('forums/listMostLikedUsers'),

        fetch: function (options) {
            options = options || {};

            options.data = _.defaults({
                forum: this.forum,
                limit: 20,
            }, options.data);

            return PaginatedCollection.prototype.fetch.call(this, options);
        },

        parse: function () {
            var users = PaginatedCollection.prototype.parse.apply(this, arguments);
            _.each(users, function (user) {
                user.verb = 'topcommenter';
            });
            // Filter out users that have low reputation scores
            return _.filter(users, function (user) {
                if (parseFloat(user.rep) > 0.7)
                    return user;
            });
        },
    });
});

define('home/models/ForumFeed',[
    'home/collections/FeedItemCollection',

    'core/UniqueModel',
    'home/models/Feed',
], function (
    FeedItemCollection,

    UniqueModel,
    Feed
) {
    'use strict';

    var ForumFeed = Feed.extend({
        initialize: function () {
            Feed.prototype.initialize.call(this, {}, {
                collectionClass: FeedItemCollection,
                collectionOptions: {
                    type: 'profile',
                    target: 'forum:' + this.id,
                },
            });
        },

        shouldFetch: function () {
            return !this.get('items').length && !this.get('fetching');
        },

        fetch: function (options) {
            if (!this.get('items').length && !this.get('fetching'))
                this.fetchItems(options);
        },

        parse: function (response) {
            return response.response;
        },
    });

    UniqueModel.addType('ForumFeed', ForumFeed);

    return ForumFeed;
});

define('home/models/ForumProfile',[
    'underscore',
    'backbone',

    'core/UniqueModel',

    'home/collections/MostLikedUserCollection',
    'home/models/Feed',
    'home/models/FollowRecommendationFeed',
    'home/models/Forum',
    'home/models/ForumFeed',
], function (
    _,
    Backbone,

    UniqueModel,

    MostLikedUserCollection,
    Feed,
    FollowRecommendationFeed,
    Forum,
    ForumFeed
) {
    'use strict';

    var ForumProfile = Backbone.Model.extend({
        initialize: function (_attributes, options) {
            this.initializeRelated(
                'forum',
                _.defaults({
                    forum: { id: this.id },
                }, options),
                Forum
            );

            this.recent = new UniqueModel(ForumFeed, {
                id: this.id,
            });

            var fetchOptions = {
                forum: this.id,
            };

            this.mostLikedUsers = new Feed({
                fetchOptions: fetchOptions,
            }, {
                collectionClass: MostLikedUserCollection,
            });

            this.interestingForums = FollowRecommendationFeed.createForumFollowRecommendationFeed();
            this.interestingUsers = FollowRecommendationFeed.createUserFollowRecommendationFeed();
        },

        ensureFetched: function () {
            this.interestingForums.ensureFetched();
            this.interestingUsers.ensureFetched();
        },

        toJSON: function () {
            return _.defaults({
                forum: this.forum.toJSON(),
                recent: this.recent.toJSON(),
                mostLikedUsers: this.mostLikedUsers.toJSON(),
            }, Backbone.Model.prototype.toJSON.call(this));
        },
    });

    UniqueModel.addType('ForumProfile', ForumProfile);

    return ForumProfile;
});

define('home/models/ActivityFeed',[
    'underscore',

    'home/models/Feed',
    'home/collections/FeedItemCollection',
], function (
    _,

    Feed,
    FeedItemCollection
) {
    'use strict';

    var ActivityFeed = Feed.extend({
        initialize: function (attrs, options) {
            Feed.prototype.initialize.call(this, attrs, _.extend({
                collectionClass: FeedItemCollection,
            }, options));
        },
    });

    return ActivityFeed;
});

define('home/models/HomepageProfile',[
    'jquery',
    'underscore',
    'backbone',

    'core/UniqueModel',
    'core/strings',
    'core/config',

    'home/models/Session',
    'home/models/Feed',
    'home/models/ChannelProfile',
    'home/models/ChannelProfileFeed',
    'home/models/FollowRecommendationFeed',
    'home/models/ActivityFeed',
    'home/collections/FeedItemCollection',
], function (
    $,
    _,
    Backbone,

    UniqueModel,
    strings,
    coreConfig,

    Session,
    Feed,
    ChannelProfile,
    ChannelProfileFeed,
    FollowRecommendationFeed,
    ActivityFeed,
    FeedItemCollection
) {
    'use strict';

    var gettext = strings.get;

    var HomepageProfile = Backbone.Model.extend({
        initialize: function () {
            var fetchOptions = {
                routingVersion: coreConfig.feedApiVersion,
            };

            this.popular = new ActivityFeed({
                fetchOptions: fetchOptions,
            }, {
                collectionOptions: {
                    type: 'home',
                },
            });

            this.comments = new Feed({
                fetchOptions: fetchOptions,
            }, {
                collectionClass: FeedItemCollection,
                collectionOptions: {
                    type: 'comments',
                },
            });

            this.discussions = new ActivityFeed({
                fetchOptions: fetchOptions,
            }, {
                collectionOptions: {
                    type: 'discussions',
                },
            });

            this.interestingChannels = new UniqueModel(ChannelProfileFeed, {
                listName: ChannelProfileFeed.LIST_NAMES.promoted,
            });

            this.interestingUsers = FollowRecommendationFeed.createUserFollowRecommendationFeed();

            // Spotlight top feed is shown if popular feed is empty. It will only be fetched if necessary.
            this.spotlightProfile = new UniqueModel(ChannelProfile, {
                id: this.constructor.SPOTLIGHT_ID, // must have id for UniqueModel
                channel: this.constructor.SPOTLIGHT_ID,
            }, {
                topActivitiesOptions: {
                    fetchOptions: {
                        limit: 3,
                    },
                },
            });
        },

        ensureFetchedSpotlightProfile: function () {
            this.spotlightProfile.ensureFetchedTopActivities();
        },

        ensureFetched: function () {
            if (Session.isKnownToBeLoggedOut()) {
                // If user is logged out, don't kick off fetch for his/her popular feed/comments/discussions.
                // Also mark the feeds as already fetched so that calling ensureFetched
                // later won't try to kick off any fetches that we know will fail.
                this.comments.set({ fetched: true });

                // Also need to set comments.fetchPromise for this.commentsPromise below, used by the view.
                this.comments.fetchPromise = $.Deferred().resolve().promise();

                this.popular.set({ fetched: true });
                this.discussions.set({ fetched: true });

                // Spotlight top feed is shown to logged out users
                this.ensureFetchedSpotlightProfile();
            } else {
                // Spotlight top feed is shown if popular feed is empty. Only
                // fetch it after it is known to be necessary.
                this.popular.ensureFetched().always(_.bind(function () {
                    if (!this.popular.items.length)
                        this.ensureFetchedSpotlightProfile();
                }, this));

                this.comments.ensureFetched();
                this.discussions.ensureFetched();
            }
            this.commentsPromise = this.comments.fetchPromise;

            this.interestingUsers.ensureFetched();

            this.interestingChannels.ensureFetched();
        },

        initializeAndFetchInterestingForums: function () {
            if (!this.interestingForums)
                this.interestingForums = FollowRecommendationFeed.createForumFollowRecommendationFeed();

            this.interestingForums.ensureFetched();
        },
    }, {
        SPOTLIGHT_ID: 'spotlight',
        MAX_SPOTLIGHT_ITEMS: {
            // NUM is used to show/fetch the correct number of spotlight items, TEXT is used in templates.
            // They must be the same number.
            NUM: 3,
            TEXT: gettext('3'),
        },
    });

    UniqueModel.addType('HomepageProfile', HomepageProfile);

    return HomepageProfile;
});

define('home/models/ExploreViewModel',[
    'backbone',

    'core/api',
    'core/collections/ChannelCollection',

    'home/models/Feed',
    'home/collections/PaginatedUserCollection',
], function (
    Backbone,

    api,
    ChannelCollection,

    Feed,
    PaginatedUserCollection
) {
    'use strict';

    var ExploreViewModel = Backbone.Model.extend({
        initialize: function () {
            this.exploreChannelCollection = new ChannelCollection([], {
                listName: 'explore',
            });

            this.allStars = new Feed({}, {
                collectionClass: PaginatedUserCollection,
                collectionUrl: api.getURL('internal/users/listPowerContributors'),
            });
        },
    });

    return ExploreViewModel;
});

define('home/backbone.overrides',[
    'underscore',
    'backbone',

    'core/api',
    'core/UniqueModel',
], function (
    _,
    Backbone,

    api,
    UniqueModel
) {
    'use strict';
    Backbone.ajax = _.wrap(Backbone.ajax, function (originalAjax, options) {
        // set options.traditional in order to force jQuery to serialize query
        // string parameters according to backend expectations. In other words
        // avoid square brackets in query parameters: b[]=1&b[]=2&b[]=3
        options.traditional = true;

        if (/(?:disqus\.com|dev.disqus.org[^/]*)\/api/.test(options.url))
            return api.call(options.url, options);

        return originalAjax(options);
    });
    /* eslint-disable valid-jsdoc */
    /**
     * Creates a sets a related model on this model.
     * Tries to use an existing model, otherwise creates a new model
     * of the given type with the given attributes or id.
     * Looks for the existing model/attributes/id first in the passed
     * options and then in this model's attributes.
     * If no model/attributes/id given, the related model set will
     * be empty.
     *
     * @param  {string} name       - The name of the related model. This
     *                               is the key that will be used to look
     *                               up the data for the related model, and
     *                               will also be the name of the property
     *                               containing the related model
     * @param  {Object} options    - The first place that will be searched
     *                               for the model/attributes/id for the
     *                               related model
     * @param  {class}  ModelClass - The class of the related model
     */
    /* eslint-enable valid-jsdoc */
    Backbone.Model.prototype.initializeRelated = function (name, options, ModelClass) {
        var obj = (options && options[name]) || this.get(name);

        if (!obj)
            throw new Error('missing the id, attributes, or model for related model ' + name);

        if (_.isString(obj) || _.isNumber(obj)) {
            var id = obj;
            obj = {};
            obj[ModelClass.prototype.idAttribute || 'id'] = id;
        }

        if (!(obj instanceof ModelClass)) {
            obj = new UniqueModel(
                ModelClass,
                obj,
                options
            );
        }

        // Clear out attributes so we're only storing the data in one place
        this.unset(name);

        this[name] = obj;
    };
});

define('home/overrides/marionette.overrides',[
    'backbone-marionette',
], function (
    Marionette
) {
    'use strict';

    /**
      * New function, not an override.
      * This will rerender the model portion of the template for a composite view
      * but will not rerender the collection portion.
      */
    Marionette.CompositeView.prototype.rerenderModel = function () {
        var $itemViewContainer = this.$(this.itemViewContainer).detach();
        this.$el.html(this.renderModel());
        this.$(this.itemViewContainer).replaceWith($itemViewContainer);

        this.triggerMethod('render', this);
    };
});

define('Router',[  // eslint-disable-line requirejs/amd-function-arity
    'underscore',
    'jquery',
    'modernizr',
    'backbone',
    'backbone-marionette',

    'home/templates/preload',

    'home/views/MainLayout',
    'home/views/HomepageView',
    'home/views/ActivityFeedView',
    'home/views/NotificationsView',
    'home/views/NotificationsLoggedOutView',
    'home/views/ForumProfileView',
    'home/views/ProfileView',
    'home/views/DiscussionCreateView',
    'home/views/DiscussionPageView',
    'home/views/WelcomeView',
    'home/views/ChannelProfileView',
    'home/views/SettingsLayout',
    'home/views/ChannelsView',
    'home/views/ExploreView',
    'home/views/OnboardingView',
    'home/viewmodels/DiscussionCreateViewModel',
    'home/viewmodels/ChannelsViewModel',
    'home/viewmodels/DiscussionViewModel',

    'home/collections/common/ExtensibleCollection',
    'home/collections/ChannelCollection',

    'home/models/Session',
    'core/UniqueModel',
    'home/models/UserProfile',
    'home/models/Thread',
    'home/models/Forum',
    'home/models/Channel',
    'home/models/ChannelProfile',
    'home/models/ForumProfile',
    'home/models/HomepageProfile',
    'home/models/ExploreViewModel',

    'home/utils/navigationUtils',
    'home/utils/trackingUtils',
    'core/utils/auth',
    'core/utils/url/parseQueryString',
    'core/api',
    'core/engagement/page',
    'core/strings',
    'core/switches',
    'remote/config',
    'core/config/urls',

    // imported for side effects
    'home/backbone.overrides',
    'home/overrides/marionette.overrides',

    'disqus.sdk',  // needed to load the embed on Discussion pages
], function (
    _,
    $,
    Modernizr,
    Backbone,
    Marionette,

    preloadTemplate,

    MainLayout,
    HomepageView,
    AnonHomepageView,
    NotificationsView,
    NotificationsLoggedOutView,
    ForumProfileView,
    ProfileView,
    DiscussionCreateView,
    DiscussionPageView,
    WelcomeView,
    ChannelProfileView,
    SettingsLayout,
    ChannelsView,
    ExploreView,
    OnboardingView,
    DiscussionCreateViewModel,
    ChannelsViewModel,
    DiscussionViewModel,

    ExtensibleCollection,
    ChannelCollection,

    Session,
    UniqueModel,
    UserProfile,
    Thread,
    Forum,
    Channel,
    ChannelProfile,
    ForumProfile,
    HomepageProfile,
    ExploreViewModel,

    NavigationUtils,
    TrackingUtils,
    auth,
    parseQueryString,
    api,
    pageEngagement,
    strings,
    switches,
    remoteConfig,
    urls
) {
    'use strict';

    var localStorageSupported = Modernizr.localstorage;

    /* eslint-disable no-unused-expressions */
    // This line causes the grunt task to add the Modernizr Touch test
    // which in turn causes Modernizr to add a css class touch/no-touch
    // to the <html> tag
    Modernizr.touch;

    // Add flexbox/no-flexbox detection for IE9
    Modernizr.flexbox;
    /* eslint-disable no-unused-expressions */

    // TODO: move this to jesterUtils
    var logStatsD = function (eventName) {
        new window.Image().src = urls.jester + '/stat.gif?event=' + eventName;
    };

    var gettext = strings.get;

    var Router = Backbone.Router.extend({

        name: 'home',

        routes: {
            'home/discuss/:forum(/)': 'startDiscussion',
            'home/edit/:forum/:thread(/)': 'editDiscussion',
            'home/search(/)': 'search',
            'home/user(s)(/:username)(/:feed)(/)': 'profile',
            'home/user(s)/(:username)(/:feed)(/:subfeed)(/)': 'profile',
            'by/:username(/:feed)(/)': 'profile',
            'by/:username(/:feed)(/:subfeed)(/)': 'profile',
            'home/inbox(/:feed)(/)': 'inbox',
            'home/preload(/)': 'preload',
            'home/account(/)': 'account',
            'home/notifications(/)': 'notifications',
            'home/topic(s)/:topicId(/)': 'topics',
            'home/forum(s)/:forumId(/:feed)(/)': 'forums',
            'home/discussion(s)/:forum/:thread(/:activeTab)(/:permalink)(/)': 'discussion',
            'home/ndiscussion(s)/:forum/:thread(/:activeTab)(/:permalink)(/)': 'nativeDiscussion',
            'home/follow/channel(s)/:channelId(/)': 'followChannel',

            'home/channel(s)(/)': 'channelsPage',
            'home/channel(s)/:channelId(/:feed)(/)': 'channels',
            'home/channel(s)/:channelId/topics/:topic(/)': 'channelTopics',
            'home/channel(s)/:channelId/discussion(s)/:forumId/:thread(/:activeTab)(/:permalink)(/)': 'channelDiscussion',
            'home/channel(s)/:channelId/ndiscussion(s)/:forumId/:thread(/:activeTab)(/:permalink)(/)': 'nativeChannelDiscussion',
            'home/settings(/:section)/': 'settings',

            // TODO: remove this once nowhere in disqus-web is directing users to /home/discover
            // (specifically after email verification, possibly other places)
            // Note: also remove 'discover' route handler in trackingUtils zone names
            'home/discover(/)': 'channelsPage',

            'home/explore(/)': 'explore',
            'home/explore/:activeTab(/)': 'explore',
            'home/explore/channels/:channelId(/:activeTab)(/)': 'exploreChannel',
            'home/explore/discussions/:channelId(/)': 'exploreDiscussions',

            // This must remain as the last item so that it doesn't match this router when
            // it should match something more specific (ex: home/inbox/)
            'home(/:feed)(/)': 'home',
        },

        initialize: function (options) {
            this.CDN_ROOT = options.CDN_ROOT;
            this.feeds = {};
            this.listenTo(this, 'route', this.handleRouteChange);

            this.listenTo(this, 'route', this.logRouteChange);

            this.messages = [];

            this.onboardingWithoutChannels = switches.isFeatureActive('onboarding_without_channels');
        },

        /*
         * Start the application by running through a
         * sequence of initialization steps.
         */
        bootstrap: function () {
            this.initSession();
            this.initTracking();
            this.initPageEngagementTracking();
            this.initLinkHandling();
            this.initMainLayout();
        },

        initTracking: function () {
            TrackingUtils.init();
            TrackingUtils.trackVisit();
        },

        initLinkHandling: function () {
            $('body').on('click', 'a[href]', _.bind(NavigationUtils.handleLinkClicks, NavigationUtils));
        },

        initSession: function () {
            var session = this.session = Session.get();
            session.load();
            session.loadPromise().then(_.bind(function () {
                if (window.Raven) {
                    window.Raven.setUser({
                        id: session.user.get('id'),
                        username: session.user.get('username'),
                    });
                }

                this.loadModeratedForums();
            }, this));

            session.loadPromise().fail(function () {
                var provider = session.provider();
                // If we know the session provider and we are rejecting the
                // session authentication anyway, then there was something wrong
                // with our disqusauth cookie (or the user is an "SSO" publisher account).
                if (provider)  // don't log all the random provider domains, just do 'remote' instead
                    logStatsD('home.session.rejected.' + (provider === 'disqus' ? 'disqus' : 'remote'));
            });

            this.initUserProfile();

            return session;
        },

        initMainLayout: function () {
            this.layout = new MainLayout({
                container: 'body',
                session: this.session,
                app: this,
            });
            // We do not render here because rendering kicks off the creation of
            // certain subviews (e.g., NavView) that rely on Backbone.history.start
            // having been called, which does not occur until after app.bootstrap.
            // And we cannot init the MainLayout AFTER History.start because History.start
            // will trigger a route that relies on MainLayout existing. And we cannot
            // hook into the route event because that is fired after the route handler
            // has been executed.
        },

        /*
         * Returns the view currently showing in the main content area of the page.
         * Useful for anything external to the content view (ex: NavView) to get
         * the current view/model being shown.
         */
        getCurrentView: function () {
            return this.layout.content.currentView;
        },

        initPageEngagementTracking: function () {
            pageEngagement.start();
        },

        /*
         * When the asEmbedApp mixin is applied, loadModeratedForums is only called
         * when the 'showPath' message is received via the FrameBus.
         */
        loadModeratedForums: function () {
            this.session.loadModeratedForums();
        },

        logRouteChange: function (route) {
            // Log the page view to 'events.*.route.<page path>'
            logStatsD(this.name + '.route.' + route);
        },

        /*
         * When the asEmbedApp mixin is applied, initUserProfile is only called when
         * the 'showPath' message is received via the FrameBus.
         */
        initUserProfile: function () {
            var username = Session.fromCookie().username;

            if (username) {
                // It appears the user is logged in. Fetch all the necessary user details
                // asynchronously using the username from the auth cookie.
                // (If the user turns out to be not logged in, or session expired, it'll be
                // handled on api response)
                this.session.initUserProfile(username);
            } else {
                // If we can't get the username from the cookie, wait until users/details
                // returns and then fetch the rest of the user details using the fetched username
                this.session.once('change:id', function (user) {
                    this.session.initUserProfile(user.get('username'));
                }, this);
            }
        },

        /*
         * Inherits + overrides parent .execute method
         * Handle pre-view setup and post-view cleanup before executing a route handler.
         */
        execute: function () {
            // Before showing a new view remove the logged-in requirement handling that may have been
            // added for the previous view.
            api.off('error', NavigationUtils.navigateToLoginOnAuthFail);

            TrackingUtils.pageChanged();

            Backbone.Router.prototype.execute.apply(this, arguments);
        },

        ensureAuthenticated: function (callback) {

            // Reset the api 'error' handler so we don't bind this
            // more than necessary.
            api.off('error', NavigationUtils.navigateToLoginOnAuthFail);

            if (Session.isKnownToBeLoggedOut())
                return NavigationUtils.navigateToLogin();

            // If we expect the user to be logged in, but we make
            // an API call that returns an error, we should direct the
            // user to the login page.
            api.on('error', NavigationUtils.navigateToLoginOnAuthFail);

            // Ensure the session is fetched. Once it is, call the
            // callback. If fetch fails, prompt user to login
            this.session.loadPromise().then(
                _.bind(callback, this, _.tail(arguments)),
                NavigationUtils.navigateToLogin
            );
        },

        navigateToLandingPage: function (options) {
            return NavigationUtils.navigate('/home/', options);
        },

        /*
         * Ensures that logged in users are redirected to onboarding step 1 if
         * they have not completed it yet. Logged out users are not affected.
         */
        ensureOnboardingComplete: function (callback) {
            // TODO: @taylangocmen once channels is removed kill this onboarding flow
            if (this.onboardingWithoutChannels || Session.isKnownToBeLoggedOut())
                return callback.apply(this);

            this.session.loadPromise().always(_.bind(function () {
                if (this.session.isLoggedIn() && this.session.user.shouldHomeOnboard())
                    // Defer this so that the current route event is triggered before navigating to the 1st step of
                    // onboarding. Not deferring it will result in route events being triggered in the wrong order.
                    _.defer(this.navigateToOnboarding);
                else
                    callback.apply(this);
            }, this));
        },

        navigateToOnboarding: function () {
            var welcomeRoute = 'home/explore/';
            var params = parseQueryString();
            var toKeep = {};

            // Retain certain params for use later.
            // Only retain them if given truthy values, so that checks later
            // for these params can skip value check and only check existence.
            if (params.email_verified)
                toKeep.email_verified = params.email_verified;

            if (params.forum_id)
                toKeep.forum_id = params.forum_id;

            if (_.size(toKeep))
                welcomeRoute += '?' + $.param(toKeep);

            NavigationUtils.navigate(welcomeRoute, { trigger: true, replace: true });
        },

        /*
         * Verifies the forum with the given id has a channel and that
         * this user can create on that channel.
         */
        ensureCanCreateOnChannel: function (callback, forumId) {
            var forum = new UniqueModel(Forum, {
                id: forumId,
            });

            // If forum hasn't been fetched yet, wait until fetching is complete
            // and then re-call this function
            if (forum.shouldFetch()) {
                forum.fetch();
                this.listenToOnce(forum, 'sync', _.bind.apply(_, [this.ensureCanCreateOnChannel, this].concat(_.toArray(arguments))));
                return;
            }

            // If the forum is not the primary forum for a channel, or if the
            // current user does not have create permissions for the channel,
            // redirect to an error page.
            if ((!forum.channel && forumId !== 'gabalafou-test') ||
                !forum.channel.userCanCreate(this.session.user))

                // TODO: this should redirect to a page with a message like:
                // "You do not have permission to view this page"
                return this.notFound();

            // The forum has a channel. Call the callback.
            callback.apply(this, _.tail(arguments));
        },

        /**
         * Listens for a tabbed view in case it throws a badTab event. If that occurs,
         * rewrites the url to the given route silently. It's expected that the tabbed
         * view will handle the event gracefully.
         *
         * @param  {tabbedView} tabbedView - A view instance that triggers a badTab event
         *                                   in the case that an invalid tab is navigated
         *                                   to, as TabbedView does.
         * @param  {string} redirectRoute - The route to rewrite if the tab is not supported
         */
        ensureTab: function (tabbedView, redirectRoute) {
            tabbedView.listenTo(tabbedView, 'badTab', function () {
                NavigationUtils.navigate(redirectRoute, { silent: true, replace: true });
            });
        },

        preventBlacklisted: function (options) {
            if (_.contains(remoteConfig.timelines.BLACKLISTED_FORUMS, options.forum))
                window.top.location = 'https://help.disqus.com/customer/portal/articles/1689402-redirected-from-home';
        },

        preload: function () {
            this.preloadView = new (Marionette.ItemView.extend({ template: preloadTemplate }))();

            this.layout.showView(this.preloadView);
        },

        /*
         * Append a trailing slash to the current route if it
         * doesn't have one.
         *
         * Saves the current and previous route names as properties so it can
         * be used by the NavView.
         */
        handleRouteChange: function (routeName) {
            this.setCurrentRouteName(routeName);
            NavigationUtils.coerceTrailingSlash(window.location);
        },

        setCurrentRouteName: function (routeName) {
            this._previousRouteName = this.getCurrentRouteName();
            this._currentRouteName = routeName;
        },

        getCurrentRouteName: function () {
            return this._currentRouteName;
        },

        getPreviousRouteName: function () {
            return this._previousRouteName;
        },

        onboarding: function () {
            return this.ensureAuthenticated(function () {
                this.layout.showView(new WelcomeView({ session: this.session }), { lightBackground: true });
            });
        },

        _explore: function (options) {
            this.session.loadPromise()
                .always(Function.bind.call(function () {
                    var showOnboarding = this.session.isLoggedIn() && this.session.user.shouldHomeOnboard();
                    if (showOnboarding) {
                        options.collection = new ChannelCollection([], { listName: 'explore' });
                        this.layout.showView(new OnboardingView(options));
                    } else {
                        options.model = new ExploreViewModel();
                        this.layout.showView(new ExploreView(options));
                    }
                }, this));
        },

        explore: function () {
            return this.navigateToLandingPage({ replace: true });
        },

        exploreChannel: function () {
            return this.navigateToLandingPage({ replace: true });
        },

        exploreDiscussions: function () {
            return this.navigateToLandingPage({ replace: true });
        },

        // When user goes to /user, take them to /user/<username>
        renavigateToProfile: function (user) {
            var username = user.get('username');

            // Prevent potential infinite loop
            // .profile() -> .renavigateToProfile() -> .profile() -> ...
            // (happens when username never gets set to truthy value)
            if (!username) {
                this.navigateToLandingPage({ replace: true });
                return void this.home();
            }

            NavigationUtils.navigate('/by/' + username + '/', {
                replace: true,
            });
            this.profile(username);
        },

        settings: function (section) {
            return this.ensureAuthenticated(function () {
                this.layout.showView(new SettingsLayout({
                    session: this.session,
                    activeTab: section,
                    onboardingWithoutChannels: this.onboardingWithoutChannels,
                }));
            });
        },

        channelsPage: function () {
            // remove everything but discussdisqus

            // Channels page shows channels followed/managed by the authenticated user.
            // Don't allow anon users to visit the page.
            if (Session.isKnownToBeLoggedOut()) {
                NavigationUtils.navigate('/', { replace: true });
                return this.home();
            }

            this.ensureOnboardingComplete(function () {
                var model = new UniqueModel(ChannelsViewModel, { id: 'discover-view-model' });
                model.ensureFetched();

                this.layout.showView(new ChannelsView({
                    model: model,
                    onboardingWithoutChannels: this.onboardingWithoutChannels,
                }));
            });
        },

        search: function () {
            return this.navigateToLandingPage({ replace: true });
        },

        profile: function (username, feedName, subFeedName) {
            // If we get here and we aren't on the /by/ profile path,
            // then rewrite the URL to be correct. NavigationUtils knows
            // how to rewrite the home/user URL correctly, so just pass the
            // task off to there.
            if (window.location.pathname.indexOf('home/user') !== -1)
                NavigationUtils.navigate(window.location, { replace: true, silent: true });

            if (!username) {
                return this.ensureAuthenticated(function () {
                    var session = this.session;
                    var sessionUser = session.user;

                    if (!sessionUser.get('username'))
                        return void this.listenToOnce(session, 'change:id', this.renavigateToProfile);

                    return void this.renavigateToProfile(sessionUser);
                });
            }

            var userProfile = _.find(UniqueModel.pool(UserProfile), function (userProfile) {
                return userProfile.user.get('username') === username;
            });

            if (!userProfile)
                userProfile = new UniqueModel(UserProfile, { username: username });

            userProfile.ensureFetched();

            var view = new ProfileView({
                model: userProfile,
                activeTab: feedName,
                subTab: subFeedName,
            });
            this.ensureTab(view, '/by/' + username + '/');

            this.layout.showView(view);
        },

        home: function (feedName, callback) {
            var isKnownToBeLoggedOut = Session.isKnownToBeLoggedOut();

            if (isKnownToBeLoggedOut) {
                if (parseQueryString().email_verified)
                    // Always try to login in users who have the email_verified param
                    // in their url, so we can send them through onboarding if necessary
                    NavigationUtils.navigateToLogin();
                else
                    // Logged out users who were not sent to home via an email verification
                    // link should be taken to the main homepage
                    NavigationUtils.navigateToHomepage();

                return;
            }


            this.ensureOnboardingComplete(function () {
                // If we get here and we aren't on the / home page path,
                // then rewrite the URL to be correct. NavigationUtils knows
                // how to rewrite the /home/ to /.
                if (window.location.pathname === '/home/')
                    NavigationUtils.navigate(window.location, { replace: true, silent: true });

                var model, contentView;

                if (isKnownToBeLoggedOut) {
                    var exploreChannelCollection = new ChannelCollection([], {
                        listName: 'explore',
                    });
                    exploreChannelCollection.ensureFetched();
                    contentView = new AnonHomepageView({
                        collection: exploreChannelCollection,
                    });

                    this.layout.showView(contentView, { lightBackground: true });
                } else {
                    model = new UniqueModel(HomepageProfile, { id: 'home-view-model' });
                    model.ensureFetched();
                    contentView = new HomepageView({
                        model: model,
                        activeTab: feedName,
                        onboardingWithoutChannels: this.onboardingWithoutChannels,
                    });
                    this.ensureTab(contentView, '/');

                    this.layout.showView(contentView);
                }

                // Check that callback is a function before calling.
                // This is necessary since `home` is called by the router,
                // which may pass a query string as an argument.
                if (_.isFunction(callback))
                    callback();

                this.cleanLocalStorage();
            });
        },

        // Previously the Home feed view used local storage to determine whether
        // or not to show a banner message to the user. With the removal of those
        // banner views we can clean up local storage that they were using.
        cleanLocalStorage: function () {
            if (!localStorageSupported)
                return;

            try {
                window.localStorage.removeItem('dhome_v2oo');
                window.localStorage.removeItem('whatsNewViewsRemaining');
                window.localStorage.removeItem('v2SwitchoverViewsRemaining');
            } catch (err) {
                /* pass */
            }
        },

        account: function () {
            return NavigationUtils.navigate('/home/settings/account/', { trigger: true, replace: true });
        },

        notifications: function () {
            return NavigationUtils.navigate('/home/settings/email/', { trigger: true, replace: true });
        },

        ensureAdmin: function (routeHandler, args) {
            var session = this.session;

            // If we got here but the session hasn't been
            // fetched, fetch the session first, and then try again
            if (!session.fetched) {
                return void session.fetch().then(
                    _.bind(this.ensureAdmin, this, routeHandler, args),
                    _.bind(this.notFound, this));
            }

            // Checks if session user is a global admin, and
            // checks Jones config for any additional accounts
            if (!auth.getFromCookie().staff)
                return this.notFound();

            return routeHandler.apply(this, args);
        },

        followChannel: function (channelId) {
            if (channelId === 'disqusfun')
                return this.ensureAdmin(this._followChannel, arguments);

            return this._followChannel.apply(this, arguments);
        },

        _followChannel: function (channelId) {
            // Follow action will fail and prompt user to log in, so check first, before
            // replacing the url, so that the login page will have the correct return url
            this.ensureAuthenticated(function () {
                var channel = new UniqueModel(Channel, { slug: channelId });

                if (channel.primaryForum && !channel.primaryForum.get('isFollowing')) {
                    channel.primaryForum.follow();
                } else {
                    this.listenToOnce(channel, 'changeRelated:primaryForum', function () {
                        if (!channel.primaryForum.get('isFollowing'))
                            channel.primaryForum.follow();
                    });
                }

                NavigationUtils.navigate('/home/channel/' + channelId + '/', { trigger: true, replace: true });
            });
        },

        channels: function (channelId) {
            if (channelId !== 'discussdisqus')
                return this.navigateToLandingPage({ replace: true });

            if (channelId === 'disqusfun' || channelId === 'gabalafou-test')
                return this.ensureAdmin(this._channels, arguments);

            return this._channels.apply(this, arguments);
        },

        channelTopics: function (channelId, topicName) {
            if (channelId !== 'discussdisqus')
                return this.navigateToLandingPage({ replace: true });

            return this.channels(channelId, 'topic-' + topicName);
        },

        _channels: function (channelId, feedName) {
            var channelProfile = new UniqueModel(
                ChannelProfile,
                {
                    id: channelId, // must have id for UniqueModel
                    channel: channelId,
                }
            );

            channelProfile.ensureFetched();

            var contentView = new ChannelProfileView({
                model: channelProfile,
                activeTab: feedName,
            });
            this.ensureTab(contentView, 'home/channel/' + channelId + '/');
            this.layout.showView(contentView);
        },

        _forums: function (forumId, feedName) {
            var forumProfile = new UniqueModel(
                ForumProfile,
                {
                    id: forumId,
                }
            );

            var forum = forumProfile.forum;
            var self = this;

            // If this is the primary forum for a channel, redirect to the channel page
            if (forum.channel) {
                NavigationUtils.navigate('/home/channel/' + forum.channel.id + '/', { trigger: true, replace: true });
                return;
            }

            forum.fetch().then(function () {
                if (forum.channel)
                    self._forums(forumId);
            }, this.notFound);

            forumProfile.ensureFetched();

            var view = new ForumProfileView({
                model: forumProfile,
                activeTab: feedName,
                onboardingWithoutChannels: this.onboardingWithoutChannels,
            });
            this.ensureTab(view, '/home/forum/' + forumId + '/');

            this.layout.showView(view);
        },

        forums: function (forumId) {
            this.preventBlacklisted({ forum: forumId });

            if (forumId === 'disqus-disqusfun')
                return this.ensureAdmin(this._forums, arguments);

            return this._forums.apply(this, arguments);
        },

        topics: function () {
            return this.navigateToLandingPage({ replace: true });
        },

        inbox: function (feedName) {
            var view;
            var notifications = this.session.getOrCreateNotifications();

            // Kick off fetch(es) for items needed on the notifications view.
            // Notifications and counters will have already been fetched by
            // the Nav bar
            notifications.ensureFetchedRecommendations();

            // If the user isn't logged in via Disqus or an SSO account (via embed sidebar), show the logged out
            // notifications inbox.
            if (!this.isSSOAuthenticated && Session.isKnownToBeLoggedOut()) {
                view = new NotificationsLoggedOutView({
                    model: notifications,
                    onboardingWithoutChannels: this.onboardingWithoutChannels,
                });
            } else {

                if (window.location.search.indexOf('email_verified') > -1) {
                    var message = strings.interpolate(
                        gettext('Your email\'s verified! Have a look around -- %(Disqus)s is a lot more than comments'),
                        { Disqus: 'Disqus' }
                    );
                    this.messages.push({ message: message });
                }

                view = new NotificationsView({
                    model: notifications,
                    activeTab: feedName,
                    disableMOTD: this.disableMOTD,
                    onboardingWithoutChannels: this.onboardingWithoutChannels,
                });
            }

            this.ensureTab(view, '/home/inbox/');
            this.layout.showView(view);
        },

        _showDiscussionForm: function (forumId, options) {
            var discussionForm = new DiscussionCreateView({
                session: this.session,
                model: new DiscussionCreateViewModel({}, _.extend({ forum: forumId }, options)),
            });

            this.listenTo(discussionForm, 'createThread', function () {
                var thread = discussionForm.getThread();
                // Add the recently created thread to an extensible collection so that embedly
                // requests (if any) will be made before showing the newly created discussion.
                new ExtensibleCollection().add(thread);
                NavigationUtils.navigate(thread.getDiscussionRoute(), {
                    trigger: true,
                });
            });
            this.listenTo(discussionForm, 'cancelThread', function () {
                NavigationUtils.navigate('home/' + discussionForm.getForum().getForumRoute(), {
                    trigger: true,
                });
            });

            this.layout.showView(discussionForm);
        },

        startDiscussion: function (forumId) {
            // return if a non discussdisqus channel
            if (forumId.indexOf('channel-') !== -1 && forumId !== 'channel-discussdisqus')
                return this.navigateToLandingPage({ replace: true });

            // Must be logged in and on the primary forum for a channel in order to create a discussion
            return this.ensureAuthenticated(function () {
                this.ensureCanCreateOnChannel(function () {

                    this._showDiscussionForm.apply(this, arguments);
                }, forumId);
            }, arguments);
        },

        editDiscussion: function (forumId, threadSlug) {
            // return if a non discussdisqus channel
            if (forumId.indexOf('channel-') !== -1 && forumId !== 'channel-discussdisqus')
                return this.navigateToLandingPage({ replace: true });

            var session = this.session;
            var thread = Thread.getOrCreateThread(forumId, threadSlug);
            var fetchPromises = [thread.getEditPermissions(session)];

            // If we got here but the session hasn't been
            // fetched, fetch the session first, and then try again
            if (thread.shouldFetch())
                fetchPromises.push(thread.fetch());

            return $.when.apply($, fetchPromises).then(
                _.bind(function (canEdit) {
                    if (canEdit)
                        return this._showDiscussionForm(forumId, { thread: thread });

                    return void NavigationUtils.navigate(thread.getDiscussionRoute(),
                        { trigger: true, replace: true });
                }, this),
                _.bind(this.notFound, this)
            );
        },

        discussionPage: function (forumId, threadSlug, activeTab, options) {
            options = options || {};

            var thread = Thread.getOrCreateThread(forumId, threadSlug, options.threadFetchOptions);
            var model = DiscussionViewModel.getOrCreate({}, {
                channel: options.channel,
                thread: thread,
            });

            var discussionPage = new DiscussionPageView(_.extend({
                model: model,
                session: this.session,
                activeTab: activeTab,
                app: this,
            }, options));

            this.layout.showView(discussionPage, { lightBackground: true });
        },

        _discussion: function (forumId, threadSlug, activeTab, options) {
            this.preventBlacklisted({ forum: forumId });

            if (forumId === 'disqus-disqusfun')
                return this.ensureAdmin(this.discussionPage, [forumId, threadSlug, activeTab, options]);

            return this.discussionPage(forumId, threadSlug, activeTab, options);
        },

        discussion: function (forumId, threadSlug, activeTab) {
            if (forumId.indexOf('channel-') !== -1 && forumId !== 'channel-discussdisqus')
                return this.navigateToLandingPage({ replace: true });

            return this._discussion(forumId, threadSlug, activeTab);
        },

        channelDiscussion: function (channelId, forumId, threadSlug, activeTab, options) {
            if (forumId.indexOf('channel-') !== -1 && forumId !== 'channel-discussdisqus')
                return this.navigateToLandingPage({ replace: true });

            options = options || {};

            var channel = new UniqueModel(Channel, { slug: channelId });

            // Must fetch this for network threads linked through a channel.
            // User generated threads will end up fetching this again as
            // part of the forum fetch, but network threads won't, and they
            // need channel details for this view.
            if (channel.shouldFetch())
                channel.fetch();

            return this._discussion(forumId, threadSlug, activeTab, {
                channel: channel,
                threadFetchOptions: {
                    data: {
                        related: ['author'],
                    },
                },
                noEmbed: options.noEmbed,
            });
        },

        // Native = no embed, iframe-less comments section
        nativeDiscussion: function (forumId, threadId, activeTab) {
            if (forumId.indexOf('channel-') !== -1 && forumId !== 'channel-discussdisqus')
                return this.navigateToLandingPage({ replace: true });

            return this._discussion(forumId, threadId, activeTab, {
                noEmbed: true,
            });
        },

        // Native = no embed, iframe-less comments section
        nativeChannelDiscussion: function (channelId, forumId, threadSlug, activeTab) {
            if (channelId !== 'discussdisqus')
                return this.navigateToLandingPage({ replace: true });

            return this.channelDiscussion(channelId, forumId, threadSlug, activeTab, {
                noEmbed: true,
            });
        },

        notFound: NavigationUtils.notFoundRouteHandler,
    });

    return Router;
});

define('home/mixins/asEmbedApp',[
    'jquery',
    'underscore',

    'core/api',
    'core/frameBus',
    'core/bus',
    'core/utils',

    'home/utils/navigationUtils',
], function (
    $,
    _,

    api,
    FrameBus,
    coreBus,
    coreUtils,

    NavigationUtils
) {
    'use strict';

    // Will be resolved once the sidebar is open. This is pretty hacky right now.
    // TODO: find a way to attach this variable to either the Router or the Session instance.
    var _showPathReceived;

    /**
     * A mixin around the Router that handles special cases for
     * showing the home app in the sidebar
     */
    var asEmbedRouter = {
        initialize: function (_initialize) {

            _showPathReceived = $.Deferred();

            this.name = 'embed_sidebar';

            // deferred object that gets resolved when the mainLayout onDomRefresh
            // event is triggered
            this.mainLayoutIsRendered = $.Deferred();
            this.listenTo(FrameBus, 'mainlayoutRendered', this.mainLayoutIsRendered.resolve);

            this.listenTo(coreBus, 'after:render', function () {
                FrameBus.sendHostMessage('after:render');
            });

            _initialize.apply(this, _.rest(arguments));

            // first message received from host to load data.
            this.listenTo(FrameBus, 'showPath', this.loadPath);

            // once openReady is sent to embed, embed will send back
            // a open event when the iframe is being shown
            this.listenTo(FrameBus, 'open', this.openDrawer);

            // send back ready message to let embed know we are
            // ready to receive messages
            FrameBus.sendHostMessage('ready');

        },

        initUserProfile: function (_initUserProfile) {
            _showPathReceived.done(_initUserProfile);
        },

        // We don't need moderated forums list in the Embed at all.
        loadModeratedForums: $.noop,

        setSsoHeaders: function (sso) {
            api.headers({
                'X-Disqus-Publisher-API-Key': sso.apiKey,
                'X-Disqus-Remote-Auth': sso.remoteAuthS3,
            });
        },

        /**
         * Manually routes the user to the path, so we don't need to
         * reload the entire page. loadPath is called when the embed
         * sends a 'showPath' message to the home iframe.
         *
         * @param {Object} data - Host configuration data
         */
        loadPath: function (data) {
            // If sso and credentials present, set headers.
            // This must be done before anything else in this function.
            if (data.sso && data.sso.apiKey && data.sso.remoteAuthS3) {
                this.setSsoHeaders(data.sso);
                this.isSSOAuthenticated = true;
            }

            _showPathReceived.resolveWith(this);

            this.disableMOTD = data.disableMOTD;

            this.mainLayoutIsRendered.done(function () {
                var navigated = NavigationUtils.navigate(data.path, { trigger: true });
                if (navigated === undefined) {
                    // If undefined, we had already loaded the path.
                    // Still trigger viewSection because it will be
                    // viewed without navigating to the path again.
                    coreBus.trigger('viewSection', this.session && this.session.config);
                }
                FrameBus.sendHostMessage('openReady');
            });
        },

        openDrawer: function () {
            var $body = $('body');
            var self = this;
            $body.addClass('active');
            $body.one(coreUtils.transitionEndEvent, function () {
                FrameBus.sendHostMessage('after:render');
                window.document.querySelector('a').focus();

                self.trigger('drawer:open');
            });
        },
    };

    /**
     * A mixin around the Session model that defers server fetches
     * until the sidebar has been opened
     */
    var asEmbedSession = {
        initialize: function (_initialize) {
            this.listenToOnce(FrameBus, 'setForum', function (shortname) {
                this.forum = { shortname: shortname };
            });

            this.listenToOnce(FrameBus, 'setConfig', function (config) {
                this.config = _.extend(this.config || {}, config);
                this.trigger('config:ready');
            });

            _initialize.apply(this, _.rest(arguments));
        },

        fetch: function (_fetch, options) {
            return _showPathReceived.then(_.bind(_fetch, this, options));
        },

        fetchFollowedForums: $.noop,
        fetchFollowedChannels: $.noop,
    };

    /**
     * Adds mixins to various classes to support showing the
     * home app in the sidebar.
     *
     * TODO: probably a good idea to find a way to not do a mixin
     *       that takes two prototypes. OR, we could do _all_ of the
     *       asEmbed prototypes here. Food for thought ...
     *
     * @param  {Class} Router - The prototype for the Router
     * @param  {Class} Session - The prototype for the Session
     */
    var asEmbedApp = function (Router, Session) {
        // Mixin asEmbedRouter into the Router prototype
        Router.initialize = _.wrap(Router.initialize, asEmbedRouter.initialize);
        Router.initUserProfile = _.wrap(Router.initUserProfile, asEmbedRouter.initUserProfile);

        Router.loadModeratedForums = asEmbedRouter.loadModeratedForums;
        Router.setSsoHeaders = asEmbedRouter.setSsoHeaders;
        Router.loadPath = asEmbedRouter.loadPath;
        Router.openDrawer = asEmbedRouter.openDrawer;
        Router.navigateToPath = asEmbedRouter.navigateToPath;
        Router.isSSOAuthenticated = asEmbedRouter.isSSOAuthenticated;


        // Mixin asEmbedSession into the Session prototype
        Session.initialize = _.wrap(Session.initialize, asEmbedSession.initialize);
        Session.fetch = _.wrap(Session.fetch, asEmbedSession.fetch);
        Session.fetchFollowedForums = asEmbedSession.fetchFollowedForums;
        Session.fetchFollowedChannels = asEmbedSession.fetchFollowedChannels;
    };

    return asEmbedApp;
});

/* ========================================================================
 * Bootstrap: dropdown.js v3.1.1
 * http://getbootstrap.com/javascript/#dropdowns
 * ========================================================================
 * Copyright 2011-2014 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */


+function ($) {
  'use strict';

  // DROPDOWN CLASS DEFINITION
  // =========================

  var backdrop = '.dropdown-backdrop'
  var toggle   = '[data-toggle=dropdown]'
  var Dropdown = function (element) {
    $(element).on('click.bs.dropdown', this.toggle)
  }

  Dropdown.prototype.toggle = function (e) {
    var $this = $(this)

    if ($this.is('.disabled, :disabled')) return

    var $parent  = getParent($this)
    var isActive = $parent.hasClass('open')

    clearMenus()

    if (!isActive) {
      if ('ontouchstart' in document.documentElement && !$parent.closest('.navbar-nav').length) {
        // if mobile we use a backdrop because click events don't delegate
        $('<div class="dropdown-backdrop"/>').insertAfter($(this)).on('click', clearMenus)
      }

      var relatedTarget = { relatedTarget: this }
      $parent.trigger(e = $.Event('show.bs.dropdown', relatedTarget))

      if (e.isDefaultPrevented()) return

      $parent
        .toggleClass('open')
        .trigger('shown.bs.dropdown', relatedTarget)

      $this.focus()
    }

    return false
  }

  Dropdown.prototype.keydown = function (e) {
    if (!/(38|40|27)/.test(e.keyCode)) return

    var $this = $(this)

    e.preventDefault()
    e.stopPropagation()

    if ($this.is('.disabled, :disabled')) return

    var $parent  = getParent($this)
    var isActive = $parent.hasClass('open')

    if (!isActive || (isActive && e.keyCode == 27)) {
      if (e.which == 27) $parent.find(toggle).focus()
      return $this.click()
    }

    var desc = ' li:not(.divider):visible a'
    var $items = $parent.find('[role=menu]' + desc + ', [role=listbox]' + desc)

    if (!$items.length) return

    var index = $items.index($items.filter(':focus'))

    if (e.keyCode == 38 && index > 0)                 index--                        // up
    if (e.keyCode == 40 && index < $items.length - 1) index++                        // down
    if (!~index)                                      index = 0

    $items.eq(index).focus()
  }

  function clearMenus(e) {
    $(backdrop).remove()
    $(toggle).each(function () {
      var $parent = getParent($(this))
      var relatedTarget = { relatedTarget: this }
      if (!$parent.hasClass('open')) return
      $parent.trigger(e = $.Event('hide.bs.dropdown', relatedTarget))
      if (e.isDefaultPrevented()) return
      $parent.removeClass('open').trigger('hidden.bs.dropdown', relatedTarget)
    })
  }

  function getParent($this) {
    var selector = $this.attr('data-target')

    if (!selector) {
      selector = $this.attr('href')
      selector = selector && /#[A-Za-z]/.test(selector) && selector.replace(/.*(?=#[^\s]*$)/, '') //strip for ie7
    }

    var $parent = selector && $(selector)

    return $parent && $parent.length ? $parent : $this.parent()
  }


  // DROPDOWN PLUGIN DEFINITION
  // ==========================

  var old = $.fn.dropdown

  $.fn.dropdown = function (option) {
    return this.each(function () {
      var $this = $(this)
      var data  = $this.data('bs.dropdown')

      if (!data) $this.data('bs.dropdown', (data = new Dropdown(this)))
      if (typeof option == 'string') data[option].call($this)
    })
  }

  $.fn.dropdown.Constructor = Dropdown


  // DROPDOWN NO CONFLICT
  // ====================

  $.fn.dropdown.noConflict = function () {
    $.fn.dropdown = old
    return this
  }


  // APPLY TO STANDARD DROPDOWN ELEMENTS
  // ===================================

  $(document)
    .on('click.bs.dropdown.data-api', clearMenus)
    .on('click.bs.dropdown.data-api', '.dropdown form', function (e) { e.stopPropagation() })
    .on('click.bs.dropdown.data-api', toggle, Dropdown.prototype.toggle)
    .on('keydown.bs.dropdown.data-api', toggle + ', [role=menu], [role=listbox]', Dropdown.prototype.keydown)

}(jQuery);

define("bootstrap/dropdown", ["jquery"], function(){});

/* ========================================================================
 * Bootstrap: tooltip.js v3.1.1
 * http://getbootstrap.com/javascript/#tooltip
 * Inspired by the original jQuery.tipsy by Jason Frame
 * ========================================================================
 * Copyright 2011-2014 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */


+function ($) {
  'use strict';

  // TOOLTIP PUBLIC CLASS DEFINITION
  // ===============================

  var Tooltip = function (element, options) {
    this.type       =
    this.options    =
    this.enabled    =
    this.timeout    =
    this.hoverState =
    this.$element   = null

    this.init('tooltip', element, options)
  }

  Tooltip.DEFAULTS = {
    animation: true,
    placement: 'top',
    selector: false,
    template: '<div class="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>',
    trigger: 'hover focus',
    title: '',
    delay: 0,
    html: false,
    container: false
  }

  Tooltip.prototype.init = function (type, element, options) {
    this.enabled  = true
    this.type     = type
    this.$element = $(element)
    this.options  = this.getOptions(options)

    var triggers = this.options.trigger.split(' ')

    for (var i = triggers.length; i--;) {
      var trigger = triggers[i]

      if (trigger == 'click') {
        this.$element.on('click.' + this.type, this.options.selector, $.proxy(this.toggle, this))
      } else if (trigger != 'manual') {
        var eventIn  = trigger == 'hover' ? 'mouseenter' : 'focusin'
        var eventOut = trigger == 'hover' ? 'mouseleave' : 'focusout'

        this.$element.on(eventIn  + '.' + this.type, this.options.selector, $.proxy(this.enter, this))
        this.$element.on(eventOut + '.' + this.type, this.options.selector, $.proxy(this.leave, this))
      }
    }

    this.options.selector ?
      (this._options = $.extend({}, this.options, { trigger: 'manual', selector: '' })) :
      this.fixTitle()
  }

  Tooltip.prototype.getDefaults = function () {
    return Tooltip.DEFAULTS
  }

  Tooltip.prototype.getOptions = function (options) {
    options = $.extend({}, this.getDefaults(), this.$element.data(), options)

    if (options.delay && typeof options.delay == 'number') {
      options.delay = {
        show: options.delay,
        hide: options.delay
      }
    }

    return options
  }

  Tooltip.prototype.getDelegateOptions = function () {
    var options  = {}
    var defaults = this.getDefaults()

    this._options && $.each(this._options, function (key, value) {
      if (defaults[key] != value) options[key] = value
    })

    return options
  }

  Tooltip.prototype.enter = function (obj) {
    var self = obj instanceof this.constructor ?
      obj : $(obj.currentTarget)[this.type](this.getDelegateOptions()).data('bs.' + this.type)

    clearTimeout(self.timeout)

    self.hoverState = 'in'

    if (!self.options.delay || !self.options.delay.show) return self.show()

    self.timeout = setTimeout(function () {
      if (self.hoverState == 'in') self.show()
    }, self.options.delay.show)
  }

  Tooltip.prototype.leave = function (obj) {
    var self = obj instanceof this.constructor ?
      obj : $(obj.currentTarget)[this.type](this.getDelegateOptions()).data('bs.' + this.type)

    clearTimeout(self.timeout)

    self.hoverState = 'out'

    if (!self.options.delay || !self.options.delay.hide) return self.hide()

    self.timeout = setTimeout(function () {
      if (self.hoverState == 'out') self.hide()
    }, self.options.delay.hide)
  }

  Tooltip.prototype.show = function () {
    var e = $.Event('show.bs.' + this.type)

    if (this.hasContent() && this.enabled) {
      this.$element.trigger(e)

      if (e.isDefaultPrevented()) return
      var that = this;

      var $tip = this.tip()

      this.setContent()

      if (this.options.animation) $tip.addClass('fade')

      var placement = typeof this.options.placement == 'function' ?
        this.options.placement.call(this, $tip[0], this.$element[0]) :
        this.options.placement

      var autoToken = /\s?auto?\s?/i
      var autoPlace = autoToken.test(placement)
      if (autoPlace) placement = placement.replace(autoToken, '') || 'top'

      $tip
        .detach()
        .css({ top: 0, left: 0, display: 'block' })
        .addClass(placement)

      this.options.container ? $tip.appendTo(this.options.container) : $tip.insertAfter(this.$element)

      var pos          = this.getPosition()
      var actualWidth  = $tip[0].offsetWidth
      var actualHeight = $tip[0].offsetHeight

      if (autoPlace) {
        var $parent = this.$element.parent()

        var orgPlacement = placement
        var docScroll    = document.documentElement.scrollTop || document.body.scrollTop
        var parentWidth  = this.options.container == 'body' ? window.innerWidth  : $parent.outerWidth()
        var parentHeight = this.options.container == 'body' ? window.innerHeight : $parent.outerHeight()
        var parentLeft   = this.options.container == 'body' ? 0 : $parent.offset().left

        placement = placement == 'bottom' && pos.top   + pos.height  + actualHeight - docScroll > parentHeight  ? 'top'    :
                    placement == 'top'    && pos.top   - docScroll   - actualHeight < 0                         ? 'bottom' :
                    placement == 'right'  && pos.right + actualWidth > parentWidth                              ? 'left'   :
                    placement == 'left'   && pos.left  - actualWidth < parentLeft                               ? 'right'  :
                    placement

        $tip
          .removeClass(orgPlacement)
          .addClass(placement)
      }

      var calculatedOffset = this.getCalculatedOffset(placement, pos, actualWidth, actualHeight)

      this.applyPlacement(calculatedOffset, placement)
      this.hoverState = null

      var complete = function() {
        that.$element.trigger('shown.bs.' + that.type)
      }

      $.support.transition && this.$tip.hasClass('fade') ?
        $tip
          .one($.support.transition.end, complete)
          .emulateTransitionEnd(150) :
        complete()
    }
  }

  Tooltip.prototype.applyPlacement = function (offset, placement) {
    var replace
    var $tip   = this.tip()
    var width  = $tip[0].offsetWidth
    var height = $tip[0].offsetHeight

    // manually read margins because getBoundingClientRect includes difference
    var marginTop = parseInt($tip.css('margin-top'), 10)
    var marginLeft = parseInt($tip.css('margin-left'), 10)

    // we must check for NaN for ie 8/9
    if (isNaN(marginTop))  marginTop  = 0
    if (isNaN(marginLeft)) marginLeft = 0

    offset.top  = offset.top  + marginTop
    offset.left = offset.left + marginLeft

    // $.fn.offset doesn't round pixel values
    // so we use setOffset directly with our own function B-0
    $.offset.setOffset($tip[0], $.extend({
      using: function (props) {
        $tip.css({
          top: Math.round(props.top),
          left: Math.round(props.left)
        })
      }
    }, offset), 0)

    $tip.addClass('in')

    // check to see if placing tip in new offset caused the tip to resize itself
    var actualWidth  = $tip[0].offsetWidth
    var actualHeight = $tip[0].offsetHeight

    if (placement == 'top' && actualHeight != height) {
      replace = true
      offset.top = offset.top + height - actualHeight
    }

    if (/bottom|top/.test(placement)) {
      var delta = 0

      if (offset.left < 0) {
        delta       = offset.left * -2
        offset.left = 0

        $tip.offset(offset)

        actualWidth  = $tip[0].offsetWidth
        actualHeight = $tip[0].offsetHeight
      }

      this.replaceArrow(delta - width + actualWidth, actualWidth, 'left')
    } else {
      this.replaceArrow(actualHeight - height, actualHeight, 'top')
    }

    if (replace) $tip.offset(offset)
  }

  Tooltip.prototype.replaceArrow = function (delta, dimension, position) {
    this.arrow().css(position, delta ? (50 * (1 - delta / dimension) + '%') : '')
  }

  Tooltip.prototype.setContent = function () {
    var $tip  = this.tip()
    var title = this.getTitle()

    $tip.find('.tooltip-inner')[this.options.html ? 'html' : 'text'](title)
    $tip.removeClass('fade in top bottom left right')
  }

  Tooltip.prototype.hide = function () {
    var that = this
    var $tip = this.tip()
    var e    = $.Event('hide.bs.' + this.type)

    function complete() {
      if (that.hoverState != 'in') $tip.detach()
      that.$element.trigger('hidden.bs.' + that.type)
    }

    this.$element.trigger(e)

    if (e.isDefaultPrevented()) return

    $tip.removeClass('in')

    $.support.transition && this.$tip.hasClass('fade') ?
      $tip
        .one($.support.transition.end, complete)
        .emulateTransitionEnd(150) :
      complete()

    this.hoverState = null

    return this
  }

  Tooltip.prototype.fixTitle = function () {
    var $e = this.$element
    if ($e.attr('title') || typeof($e.attr('data-original-title')) != 'string') {
      $e.attr('data-original-title', $e.attr('title') || '').attr('title', '')
    }
  }

  Tooltip.prototype.hasContent = function () {
    return this.getTitle()
  }

  Tooltip.prototype.getPosition = function () {
    var el = this.$element[0]
    return $.extend({}, (typeof el.getBoundingClientRect == 'function') ? el.getBoundingClientRect() : {
      width: el.offsetWidth,
      height: el.offsetHeight
    }, this.$element.offset())
  }

  Tooltip.prototype.getCalculatedOffset = function (placement, pos, actualWidth, actualHeight) {
    return placement == 'bottom' ? { top: pos.top + pos.height,   left: pos.left + pos.width / 2 - actualWidth / 2  } :
           placement == 'top'    ? { top: pos.top - actualHeight, left: pos.left + pos.width / 2 - actualWidth / 2  } :
           placement == 'left'   ? { top: pos.top + pos.height / 2 - actualHeight / 2, left: pos.left - actualWidth } :
        /* placement == 'right' */ { top: pos.top + pos.height / 2 - actualHeight / 2, left: pos.left + pos.width   }
  }

  Tooltip.prototype.getTitle = function () {
    var title
    var $e = this.$element
    var o  = this.options

    title = $e.attr('data-original-title')
      || (typeof o.title == 'function' ? o.title.call($e[0]) :  o.title)

    return title
  }

  Tooltip.prototype.tip = function () {
    return this.$tip = this.$tip || $(this.options.template)
  }

  Tooltip.prototype.arrow = function () {
    return this.$arrow = this.$arrow || this.tip().find('.tooltip-arrow')
  }

  Tooltip.prototype.validate = function () {
    if (!this.$element[0].parentNode) {
      this.hide()
      this.$element = null
      this.options  = null
    }
  }

  Tooltip.prototype.enable = function () {
    this.enabled = true
  }

  Tooltip.prototype.disable = function () {
    this.enabled = false
  }

  Tooltip.prototype.toggleEnabled = function () {
    this.enabled = !this.enabled
  }

  Tooltip.prototype.toggle = function (e) {
    var self = e ? $(e.currentTarget)[this.type](this.getDelegateOptions()).data('bs.' + this.type) : this
    self.tip().hasClass('in') ? self.leave(self) : self.enter(self)
  }

  Tooltip.prototype.destroy = function () {
    clearTimeout(this.timeout)
    this.hide().$element.off('.' + this.type).removeData('bs.' + this.type)
  }


  // TOOLTIP PLUGIN DEFINITION
  // =========================

  var old = $.fn.tooltip

  $.fn.tooltip = function (option) {
    return this.each(function () {
      var $this   = $(this)
      var data    = $this.data('bs.tooltip')
      var options = typeof option == 'object' && option

      if (!data && option == 'destroy') return
      if (!data) $this.data('bs.tooltip', (data = new Tooltip(this, options)))
      if (typeof option == 'string') data[option]()
    })
  }

  $.fn.tooltip.Constructor = Tooltip


  // TOOLTIP NO CONFLICT
  // ===================

  $.fn.tooltip.noConflict = function () {
    $.fn.tooltip = old
    return this
  }

}(jQuery);

define("bootstrap/tooltip", ["jquery"], function(){});

/* ========================================================================
 * Bootstrap: modal.js v3.1.1
 * http://getbootstrap.com/javascript/#modals
 * ========================================================================
 * Copyright 2011-2014 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */


+function ($) {
  'use strict';

  // MODAL CLASS DEFINITION
  // ======================

  var Modal = function (element, options) {
    this.options   = options
    this.$element  = $(element)
    this.$backdrop =
    this.isShown   = null

    if (this.options.remote) {
      this.$element
        .find('.modal-content')
        .load(this.options.remote, $.proxy(function () {
          this.$element.trigger('loaded.bs.modal')
        }, this))
    }
  }

  Modal.DEFAULTS = {
    backdrop: true,
    keyboard: true,
    show: true
  }

  Modal.prototype.toggle = function (_relatedTarget) {
    return this[!this.isShown ? 'show' : 'hide'](_relatedTarget)
  }

  Modal.prototype.show = function (_relatedTarget) {
    var that = this
    var e    = $.Event('show.bs.modal', { relatedTarget: _relatedTarget })

    this.$element.trigger(e)

    if (this.isShown || e.isDefaultPrevented()) return

    this.isShown = true

    this.escape()

    this.$element.on('click.dismiss.bs.modal', '[data-dismiss="modal"]', $.proxy(this.hide, this))

    this.backdrop(function () {
      var transition = $.support.transition && that.$element.hasClass('fade')

      if (!that.$element.parent().length) {
        that.$element.appendTo(document.body) // don't move modals dom position
      }

      that.$element
        .show()
        .scrollTop(0)

      if (transition) {
        that.$element[0].offsetWidth // force reflow
      }

      that.$element
        .addClass('in')
        .attr('aria-hidden', false)

      that.enforceFocus()

      var e = $.Event('shown.bs.modal', { relatedTarget: _relatedTarget })

      transition ?
        that.$element.find('.modal-dialog') // wait for modal to slide in
          .one($.support.transition.end, function () {
            that.$element.focus().trigger(e)
          })
          .emulateTransitionEnd(300) :
        that.$element.focus().trigger(e)
    })
  }

  Modal.prototype.hide = function (e) {
    if (e) e.preventDefault()

    e = $.Event('hide.bs.modal')

    this.$element.trigger(e)

    if (!this.isShown || e.isDefaultPrevented()) return

    this.isShown = false

    this.escape()

    $(document).off('focusin.bs.modal')

    this.$element
      .removeClass('in')
      .attr('aria-hidden', true)
      .off('click.dismiss.bs.modal')

    $.support.transition && this.$element.hasClass('fade') ?
      this.$element
        .one($.support.transition.end, $.proxy(this.hideModal, this))
        .emulateTransitionEnd(300) :
      this.hideModal()
  }

  Modal.prototype.enforceFocus = function () {
    $(document)
      .off('focusin.bs.modal') // guard against infinite focus loop
      .on('focusin.bs.modal', $.proxy(function (e) {
        if (this.$element[0] !== e.target && !this.$element.has(e.target).length) {
          this.$element.focus()
        }
      }, this))
  }

  Modal.prototype.escape = function () {
    if (this.isShown && this.options.keyboard) {
      this.$element.on('keyup.dismiss.bs.modal', $.proxy(function (e) {
        e.which == 27 && this.hide()
      }, this))
    } else if (!this.isShown) {
      this.$element.off('keyup.dismiss.bs.modal')
    }
  }

  Modal.prototype.hideModal = function () {
    var that = this
    this.$element.hide()
    this.backdrop(function () {
      that.removeBackdrop()
      that.$element.trigger('hidden.bs.modal')
    })
  }

  Modal.prototype.removeBackdrop = function () {
    this.$backdrop && this.$backdrop.remove()
    this.$backdrop = null
  }

  Modal.prototype.backdrop = function (callback) {
    var animate = this.$element.hasClass('fade') ? 'fade' : ''

    if (this.isShown && this.options.backdrop) {
      var doAnimate = $.support.transition && animate

      this.$backdrop = $('<div class="modal-backdrop ' + animate + '" />')
        .appendTo(document.body)

      this.$element.on('click.dismiss.bs.modal', $.proxy(function (e) {
        if (e.target !== e.currentTarget) return
        this.options.backdrop == 'static'
          ? this.$element[0].focus.call(this.$element[0])
          : this.hide.call(this)
      }, this))

      if (doAnimate) this.$backdrop[0].offsetWidth // force reflow

      this.$backdrop.addClass('in')

      if (!callback) return

      doAnimate ?
        this.$backdrop
          .one($.support.transition.end, callback)
          .emulateTransitionEnd(150) :
        callback()

    } else if (!this.isShown && this.$backdrop) {
      this.$backdrop.removeClass('in')

      $.support.transition && this.$element.hasClass('fade') ?
        this.$backdrop
          .one($.support.transition.end, callback)
          .emulateTransitionEnd(150) :
        callback()

    } else if (callback) {
      callback()
    }
  }


  // MODAL PLUGIN DEFINITION
  // =======================

  var old = $.fn.modal

  $.fn.modal = function (option, _relatedTarget) {
    return this.each(function () {
      var $this   = $(this)
      var data    = $this.data('bs.modal')
      var options = $.extend({}, Modal.DEFAULTS, $this.data(), typeof option == 'object' && option)

      if (!data) $this.data('bs.modal', (data = new Modal(this, options)))
      if (typeof option == 'string') data[option](_relatedTarget)
      else if (options.show) data.show(_relatedTarget)
    })
  }

  $.fn.modal.Constructor = Modal


  // MODAL NO CONFLICT
  // =================

  $.fn.modal.noConflict = function () {
    $.fn.modal = old
    return this
  }


  // MODAL DATA-API
  // ==============

  $(document).on('click.bs.modal.data-api', '[data-toggle="modal"]', function (e) {
    var $this   = $(this)
    var href    = $this.attr('href')
    var $target = $($this.attr('data-target') || (href && href.replace(/.*(?=#[^\s]+$)/, ''))) //strip for ie7
    var option  = $target.data('bs.modal') ? 'toggle' : $.extend({ remote: !/#/.test(href) && href }, $target.data(), $this.data())

    if ($this.is('a')) e.preventDefault()

    $target
      .modal(option, this)
      .one('hide', function () {
        $this.is(':visible') && $this.focus()
      })
  })

  $(document)
    .on('show.bs.modal', '.modal', function () { $(document.body).addClass('modal-open') })
    .on('hidden.bs.modal', '.modal', function () { $(document.body).removeClass('modal-open') })

}(jQuery);

define("bootstrap/modal", ["jquery"], function(){});

/* ========================================================================
 * Bootstrap: collapse.js v3.1.1
 * http://getbootstrap.com/javascript/#collapse
 * ========================================================================
 * Copyright 2011-2014 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */


+function ($) {
  'use strict';

  // COLLAPSE PUBLIC CLASS DEFINITION
  // ================================

  var Collapse = function (element, options) {
    this.$element      = $(element)
    this.options       = $.extend({}, Collapse.DEFAULTS, options)
    this.transitioning = null

    if (this.options.parent) this.$parent = $(this.options.parent)
    if (this.options.toggle) this.toggle()
  }

  Collapse.DEFAULTS = {
    toggle: true
  }

  Collapse.prototype.dimension = function () {
    var hasWidth = this.$element.hasClass('width')
    return hasWidth ? 'width' : 'height'
  }

  Collapse.prototype.show = function () {
    if (this.transitioning || this.$element.hasClass('in')) return

    var startEvent = $.Event('show.bs.collapse')
    this.$element.trigger(startEvent)
    if (startEvent.isDefaultPrevented()) return

    var actives = this.$parent && this.$parent.find('> .panel > .in')

    if (actives && actives.length) {
      var hasData = actives.data('bs.collapse')
      if (hasData && hasData.transitioning) return
      actives.collapse('hide')
      hasData || actives.data('bs.collapse', null)
    }

    var dimension = this.dimension()

    this.$element
      .removeClass('collapse')
      .addClass('collapsing')
      [dimension](0)

    this.transitioning = 1

    var complete = function () {
      this.$element
        .removeClass('collapsing')
        .addClass('collapse in')
        [dimension]('auto')
      this.transitioning = 0
      this.$element.trigger('shown.bs.collapse')
    }

    if (!$.support.transition) return complete.call(this)

    var scrollSize = $.camelCase(['scroll', dimension].join('-'))

    this.$element
      .one($.support.transition.end, $.proxy(complete, this))
      .emulateTransitionEnd(350)
      [dimension](this.$element[0][scrollSize])
  }

  Collapse.prototype.hide = function () {
    if (this.transitioning || !this.$element.hasClass('in')) return

    var startEvent = $.Event('hide.bs.collapse')
    this.$element.trigger(startEvent)
    if (startEvent.isDefaultPrevented()) return

    var dimension = this.dimension()

    this.$element
      [dimension](this.$element[dimension]())
      [0].offsetHeight

    this.$element
      .addClass('collapsing')
      .removeClass('collapse')
      .removeClass('in')

    this.transitioning = 1

    var complete = function () {
      this.transitioning = 0
      this.$element
        .trigger('hidden.bs.collapse')
        .removeClass('collapsing')
        .addClass('collapse')
    }

    if (!$.support.transition) return complete.call(this)

    this.$element
      [dimension](0)
      .one($.support.transition.end, $.proxy(complete, this))
      .emulateTransitionEnd(350)
  }

  Collapse.prototype.toggle = function () {
    this[this.$element.hasClass('in') ? 'hide' : 'show']()
  }


  // COLLAPSE PLUGIN DEFINITION
  // ==========================

  var old = $.fn.collapse

  $.fn.collapse = function (option) {
    return this.each(function () {
      var $this   = $(this)
      var data    = $this.data('bs.collapse')
      var options = $.extend({}, Collapse.DEFAULTS, $this.data(), typeof option == 'object' && option)

      if (!data && options.toggle && option == 'show') option = !option
      if (!data) $this.data('bs.collapse', (data = new Collapse(this, options)))
      if (typeof option == 'string') data[option]()
    })
  }

  $.fn.collapse.Constructor = Collapse


  // COLLAPSE NO CONFLICT
  // ====================

  $.fn.collapse.noConflict = function () {
    $.fn.collapse = old
    return this
  }


  // COLLAPSE DATA-API
  // =================

  $(document).on('click.bs.collapse.data-api', '[data-toggle=collapse]', function (e) {
    var $this   = $(this), href
    var target  = $this.attr('data-target')
        || e.preventDefault()
        || (href = $this.attr('href')) && href.replace(/.*(?=#[^\s]+$)/, '') //strip for ie7
    var $target = $(target)
    var data    = $target.data('bs.collapse')
    var option  = data ? 'toggle' : $this.data()
    var parent  = $this.attr('data-parent')
    var $parent = parent && $(parent)

    if (!data || !data.transitioning) {
      if ($parent) $parent.find('[data-toggle=collapse][data-parent="' + parent + '"]').not($this).addClass('collapsed')
      $this[$target.hasClass('in') ? 'addClass' : 'removeClass']('collapsed')
    }

    $target.collapse(option)
  })

}(jQuery);

define("bootstrap/collapse", ["jquery"], function(){});

/**!
 * trunk8 v1.3.1
 * https://github.com/rviscomi/trunk8
 *
 * Copyright 2012 Rick Viscomi
 * Released under the MIT License.
 *
 * Date: September 26, 2012
 */

(function ($) {
    var methods,
        utils,
        SIDES = {
            /* cen...ter */
            center: 'center',
            /* ...left */
            left: 'left',
            /* right... */
            right: 'right'
        },
        WIDTH = {
            auto: 'auto'
        };

    function trunk8(element) {
        this.$element = $(element);
        this.original_text = this.$element.html();
        this.settings = $.extend({}, $.fn.trunk8.defaults);
    }

    trunk8.prototype.updateSettings = function (options) {
        this.settings = $.extend(this.settings, options);
    };

    function stripHTML(html) {
        var tmp = document.createElement("DIV");
        tmp.innerHTML = html;
        return tmp.textContent||tmp.innerText;
    }

    function getHtmlArr(str) {
        /* Builds an array of strings and designated */
        /* HTML tags around them. */
        if (stripHTML(str) === str) {
            return str.split(/\s/g);
        }
        var allResults = [],
            reg = /<([a-z]+)([^<]*)(?:>(.*?(?!<\1>)*)<\/\1>|\s+\/>)(['.?!,]*)|((?:[^<>\s])+['.?!,]*\w?|<br\s?\/?>)/ig,
            outArr = reg.exec(str),
            lastI,
            ind;
        while (outArr && lastI !== reg.lastIndex) {
            lastI = reg.lastIndex;
            if (outArr[5]) {
                allResults.push(outArr[5]);
            } else if (outArr[1]) {
                allResults.push({
                    tag: outArr[1],
                    attribs: outArr[2],
                    content: outArr[3],
                    after: outArr[4]
                });
            }
            outArr = reg.exec(str);
        }
        for (ind = 0; ind < allResults.length; ind++) {
            if (typeof allResults[ind] !== 'string' &&
                    allResults[ind].content) {
                allResults[ind].content = getHtmlArr(allResults[ind].content);
            }
        }
        return allResults;
    }

    function rebuildHtmlFromBite(bite, htmlObject, fill) {
        // Take the processed bite after binary-search
        // truncated and re-build the original HTML
        // tags around the processed string.
        bite = bite.replace(fill, '');

        var biteHelper = function(contentArr, tagInfo) {
                var retStr = '',
                    content,
                    biteContent,
                    biteLength,
                    nextWord,
                    i;
                for (i = 0; i < contentArr.length; i++) {
                    content = contentArr[i];
                    biteLength = $.trim(bite).split(' ').length;
                    if ($.trim(bite).length) {
                        if (typeof content === 'string') {
                            if (!/<br\s*\/?>/.test(content)) {
                                if (biteLength === 1 && $.trim(bite).length <= content.length) {
                                    content = bite;
                                    // We want the fill to go inside of the last HTML
                                    // element if the element is a container.
                                    if (tagInfo === 'p' || tagInfo === 'div') {
                                        content += fill;
                                    }
                                    bite = '';
                                } else {
                                    bite = bite.replace(content, '');
                                }
                            }
                            retStr += $.trim(content) + ((i === contentArr.length-1 || biteLength <= 1) ? '' : ' ');
                        } else {
                            biteContent = biteHelper(content.content, content.tag);
                            if (content.after) bite = bite.replace(content.after, '');
                            if (biteContent) {
                                if (!content.after) content.after = ' ';
                                retStr += '<'+content.tag+content.attribs+'>'+biteContent+'</'+content.tag+'>' + content.after;
                            }
                        }
                    }
                }
                return retStr;
            },
            htmlResults = biteHelper(htmlObject);

        // Add fill if doesn't exist. This will place it outside the HTML elements.
        if (htmlResults.slice(htmlResults.length - fill.length) === fill) {
            htmlResults += fill;
        }

        return htmlResults;
    }

    function truncate() {
        var data = this.data('trunk8'),
            settings = data.settings,
            width = settings.width,
            side = settings.side,
            fill = settings.fill,
            parseHTML = settings.parseHTML,
            line_height = utils.getLineHeight(this) * settings.lines,
            str = data.original_text,
            length = str.length,
            max_bite = '',
            lower, upper,
            bite_size,
            bite,
            text,
            htmlObject;

        /* Reset the field to the original string. */
        this.html(str);
        text = this.text();

        /* If string has HTML and parse HTML is set, build */
        /* the data struct to house the tags */
        if (parseHTML && stripHTML(str) !== str) {
            htmlObject = getHtmlArr(str);
            str = stripHTML(str);
            length = str.length;
        }

        if (width === WIDTH.auto) {
            /* Assuming there is no "overflow: hidden". */
            if (this.height() <= line_height) {
                /* Text is already at the optimal trunkage. */
                return;
            }

            /* Binary search technique for finding the optimal trunkage. */
            /* Find the maximum bite without overflowing. */
            lower = 0;
            upper = length - 1;

            while (lower <= upper) {
                bite_size = lower + ((upper - lower) >> 1);

                bite = utils.eatStr(str, side, length - bite_size, fill);

                if (parseHTML && htmlObject) {
                    bite = rebuildHtmlFromBite(bite, htmlObject, fill);
                }

                this.html(bite);

                /* Check for overflow. */
                if (this.height() > line_height) {
                    upper = bite_size - 1;
                }
                else {
                    lower = bite_size + 1;

                    /* Save the bigger bite. */
                    max_bite = (max_bite.length > bite.length) ? max_bite : bite;
                }
            }

            /* Reset the content to eliminate possible existing scroll bars. */
            this.html('');

            /* Display the biggest bite. */
            this.html(max_bite);

            if (settings.tooltip) {
                this.attr('title', text);
            }
        }
        else if (!isNaN(width)) {
            bite_size = length - width;

            bite = utils.eatStr(str, side, bite_size, fill);

            this.html(bite);

            if (settings.tooltip) {
                this.attr('title', str);
            }
        }
        else {
            $.error('Invalid width "' + width + '".');
        }
    }

    methods = {
        init: function (options) {
            return this.each(function () {
                var $this = $(this),
                    data = $this.data('trunk8');

                if (!data) {
                    $this.data('trunk8', (data = new trunk8(this)));
                }

                data.updateSettings(options);

                truncate.call($this);
            });
        },

        /** Updates the text value of the elements while maintaining truncation. */
        update: function (new_string) {
            return this.each(function () {
                var $this = $(this);

                /* Update text. */
                if (new_string) {
                    $this.data('trunk8').original_text = new_string;
                }

                /* Truncate accordingly. */
                truncate.call($this);
            });
        },

        revert: function () {
            return this.each(function () {
                /* Get original text. */
                var text = $(this).data('trunk8').original_text;

                /* Revert element to original text. */
                $(this).html(text);
            });
        },

        /** Returns this instance's settings object. NOT CHAINABLE. */
        getSettings: function () {
            return $(this.get(0)).data('trunk8').settings;
        }
    };

    utils = {
        /** Replaces [bite_size] [side]-most chars in [str] with [fill]. */
        eatStr: function (str, side, bite_size, fill) {
            var length = str.length,
                key = utils.eatStr.generateKey.apply(null, arguments),
                half_length,
                half_bite_size;

            /* If the result is already in the cache, return it. */
            if (utils.eatStr.cache[key]) {
                return utils.eatStr.cache[key];
            }

            /* Common error handling. */
            if ((typeof str !== 'string') || (length === 0)) {
                $.error('Invalid source string "' + str + '".');
            }
            if ((bite_size < 0) || (bite_size > length)) {
                $.error('Invalid bite size "' + bite_size + '".');
            }
            else if (bite_size === 0) {
                /* No bite should show no truncation. */
                return str;
            }
            if (typeof (fill + '') !== 'string') {
                $.error('Fill unable to be converted to a string.');
            }

            /* Compute the result, store it in the cache, and return it. */
            switch (side) {
                case SIDES.right:
                    /* str... */
                    return utils.eatStr.cache[key] =
                            $.trim(str.substr(0, length - bite_size)) + fill;

                case SIDES.left:
                    /* ...str */
                    return utils.eatStr.cache[key] =
                            fill + $.trim(str.substr(bite_size));

                case SIDES.center:
                    /* Bit-shift to the right by one === Math.floor(x / 2) */
                    half_length = length >> 1; // halve the length
                    half_bite_size = bite_size >> 1; // halve the bite_size

                    /* st...r */
                    return utils.eatStr.cache[key] =
                            $.trim(utils.eatStr(str.substr(0, length - half_length), SIDES.right, bite_size - half_bite_size, '')) +
                            fill +
                            $.trim(utils.eatStr(str.substr(length - half_length), SIDES.left, half_bite_size, ''));

                default:
                    $.error('Invalid side "' + side + '".');
            }
        },

        getLineHeight: function (elem) {
                var floats = $(elem).css('float');
                if (floats !== 'none') {
                    $(elem).css('float', 'none');
                }
                var pos = $(elem).css('position');
                if (pos === 'absolute') {
                    $(elem).css('position', 'static');
                }

                var html = $(elem).html(),
                wrapper_id = 'line-height-test',
                line_height;

                /* Set the content to a small single character. */
                $(elem).html('i');

                /* Calculate the line height by measuring the parent element.*/
                line_height = $(elem).parent().innerHeight();

                /* Reset the content. */
                $(elem).html(html).css({ 'float': floats, 'position': pos });

                return line_height;
            }
    };

    utils.eatStr.cache = {};
    utils.eatStr.generateKey = function () {
        return Array.prototype.join.call(arguments, '');
    };

    $.fn.trunk8 = function (method) {
        if (methods[method]) {
            return methods[method].apply(this, Array.prototype.slice.call(arguments, 1));
        }
        else if (typeof method === 'object' || !method) {
            return methods.init.apply(this, arguments);
        }
        else {
            $.error('Method ' + method + ' does not exist on jQuery.trunk8');
        }
    };

    /* Default trunk8 settings. */
    $.fn.trunk8.defaults = {
        fill: '&hellip;',
        lines: 1,
        side: SIDES.right,
        tooltip: true,
        width: WIDTH.auto,
        parseHTML: false
    };
})(jQuery);

define("jquery.trunk8", ["jquery"], function(){});

define('home/main',[  // eslint-disable-line requirejs/amd-function-arity
    'home/config',
    'home/utils/layoutUtils',
    'Router',
    'home/models/Session',
    'core/config/urls',

    'jquery',
    'backbone',

    'home/mixins/asEmbedApp',
    'home/utils/sidebarUtils',
    'home/utils/navigationUtils',

    // imported for side effects
    'bootstrap/dropdown',
    'bootstrap/tooltip',
    'bootstrap/modal',
    'bootstrap/collapse',
    'jquery.trunk8',
], function (
    config,
    layoutUtils,

    Router,
    Session,
    urls,

    $,
    Backbone,

    asEmbedApp,
    sidebarUtils,
    navigationUtils
) {
    'use strict';

    var initFixtures = function (callback) {
        if (window.IS_DEV)
            require(['fixtures/fixtures'], callback);
        else
            callback();
    };

    /**
     * Backwards compatibility layer to support old #-based routes
     * e.g., /home/#account
     */
    function transitionUrl() {
        var location = window.location;

        // If we are at the /home/ prefix and we happen to also have a
        // hash that matches one of our routes, then we should try to
        // direct the user to that route instead of just going to /home/.
        // NOTE: this hash routing feature is only to support a few legacy
        //       urls like disqus.com/home/#account.
        if (location.hash.length > 1 && (location.pathname === '/home' || location.pathname === '/home/')) {
            // Construct a new location object that contains the hash's route
            // as well as search params, etc.
            var loc = {
                pathname: '/home/' + location.hash.slice(1).replace(/^\//, ''),
                search: location.search,
                hash: '',
                host: location.host,
            };

            if (navigationUtils.matchesRoute(loc))
                return navigationUtils.navigate(loc, true);
        }

        return Backbone.history.loadUrl();
    }

    return {
        _init: function (options) {
            var app = new Router(options);

            // Start
            app.bootstrap();

            // overwrite tooltip support so they don't show
            if (layoutUtils.isNarrowLayout())
                $.fn.tooltip = $.noop;

            window.DISQUS = window.DISQUS || {};
            window.DISQUS.home = {
                app: app,
            };

            // Wait for fixtures to initialize (for dev) before beginning navigation
            initFixtures(function () {
                Backbone.history.start({
                    pushState: true,
                    hashChange: false,
                    root: config.appRoot,
                    silent: true,
                });

                // If we don't have a matching route, call notFound
                if (!transitionUrl())
                    app.notFound();
            });
        },

        init: function (options) {
            urls.cdn = options.CDN_ROOT;
            var self = this;

            if (sidebarUtils.isSidebar())
                asEmbedApp(Router.prototype, Session.prototype);

            $(function () {
                self._init(options);
            });
        },
    };
});

/*! Raven.js 3.27.0 (200cffcc) | github.com/getsentry/raven-js */
!function(a){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=a();else if("function"==typeof define&&define.amd)define('raven',[],a);else{var b;b="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,b.Raven=a()}}(function(){return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){function d(a){this.name="RavenConfigError",this.message=a}d.prototype=new Error,d.prototype.constructor=d,b.exports=d},{}],2:[function(a,b,c){var d=a(5),e=function(a,b,c){var e=a[b],f=a;if(b in a){var g="warn"===b?"warning":b;a[b]=function(){var a=[].slice.call(arguments),h=d.safeJoin(a," "),i={level:g,logger:"console",extra:{arguments:a}};"assert"===b?a[0]===!1&&(h="Assertion failed: "+(d.safeJoin(a.slice(1)," ")||"console.assert"),i.extra.arguments=a.slice(1),c&&c(h,i)):c&&c(h,i),e&&Function.prototype.apply.call(e,f,a)}}};b.exports={wrapMethod:e}},{5:5}],3:[function(a,b,c){(function(c){function d(){return+new Date}function e(a,b){return s(b)?function(c){return b(c,a)}:b}function f(){this.a=!("object"!=typeof JSON||!JSON.stringify),this.b=!r(S),this.c=!r(T),this.d=null,this.e=null,this.f=null,this.g=null,this.h=null,this.i=null,this.j={},this.k={release:R.SENTRY_RELEASE&&R.SENTRY_RELEASE.id,logger:"javascript",ignoreErrors:[],ignoreUrls:[],whitelistUrls:[],includePaths:[],headers:null,collectWindowErrors:!0,captureUnhandledRejections:!0,maxMessageLength:0,maxUrlLength:250,stackTraceLimit:50,autoBreadcrumbs:!0,instrument:!0,sampleRate:1,sanitizeKeys:[]},this.l={method:"POST",referrerPolicy:K()?"origin":""},this.m=0,this.n=!1,this.o=Error.stackTraceLimit,this.p=R.console||{},this.q={},this.r=[],this.s=d(),this.t=[],this.u=[],this.v=null,this.w=R.location,this.x=this.w&&this.w.href,this.y();for(var a in this.p)this.q[a]=this.p[a]}var g=a(6),h=a(7),i=a(8),j=a(1),k=a(5),l=k.isErrorEvent,m=k.isDOMError,n=k.isDOMException,o=k.isError,p=k.isObject,q=k.isPlainObject,r=k.isUndefined,s=k.isFunction,t=k.isString,u=k.isArray,v=k.isEmptyObject,w=k.each,x=k.objectMerge,y=k.truncate,z=k.objectFrozen,A=k.hasKey,B=k.joinRegExp,C=k.urlencode,D=k.uuid4,E=k.htmlTreeAsString,F=k.isSameException,G=k.isSameStacktrace,H=k.parseUrl,I=k.fill,J=k.supportsFetch,K=k.supportsReferrerPolicy,L=k.serializeKeysForMessage,M=k.serializeException,N=k.sanitize,O=a(2).wrapMethod,P="source protocol user pass host port path".split(" "),Q=/^(?:(\w+):)?\/\/(?:(\w+)(:\w+)?@)?([\w\.-]+)(?::(\d+))?(\/.*)/,R="undefined"!=typeof window?window:"undefined"!=typeof c?c:"undefined"!=typeof self?self:{},S=R.document,T=R.navigator;f.prototype={VERSION:"3.27.0",debug:!1,TraceKit:g,config:function(a,b){var c=this;if(c.g)return this.z("error","Error: Raven has already been configured"),c;if(!a)return c;var d=c.k;b&&w(b,function(a,b){"tags"===a||"extra"===a||"user"===a?c.j[a]=b:d[a]=b}),c.setDSN(a),d.ignoreErrors.push(/^Script error\.?$/),d.ignoreErrors.push(/^Javascript error: Script error\.? on line 0$/),d.ignoreErrors=B(d.ignoreErrors),d.ignoreUrls=!!d.ignoreUrls.length&&B(d.ignoreUrls),d.whitelistUrls=!!d.whitelistUrls.length&&B(d.whitelistUrls),d.includePaths=B(d.includePaths),d.maxBreadcrumbs=Math.max(0,Math.min(d.maxBreadcrumbs||100,100));var e={xhr:!0,console:!0,dom:!0,location:!0,sentry:!0},f=d.autoBreadcrumbs;"[object Object]"==={}.toString.call(f)?f=x(e,f):f!==!1&&(f=e),d.autoBreadcrumbs=f;var h={tryCatch:!0},i=d.instrument;return"[object Object]"==={}.toString.call(i)?i=x(h,i):i!==!1&&(i=h),d.instrument=i,g.collectWindowErrors=!!d.collectWindowErrors,c},install:function(){var a=this;return a.isSetup()&&!a.n&&(g.report.subscribe(function(){a.A.apply(a,arguments)}),a.k.captureUnhandledRejections&&a.B(),a.C(),a.k.instrument&&a.k.instrument.tryCatch&&a.D(),a.k.autoBreadcrumbs&&a.E(),a.F(),a.n=!0),Error.stackTraceLimit=a.k.stackTraceLimit,this},setDSN:function(a){var b=this,c=b.G(a),d=c.path.lastIndexOf("/"),e=c.path.substr(1,d);b.H=a,b.h=c.user,b.I=c.pass&&c.pass.substr(1),b.i=c.path.substr(d+1),b.g=b.J(c),b.K=b.g+"/"+e+"api/"+b.i+"/store/",this.y()},context:function(a,b,c){return s(a)&&(c=b||[],b=a,a={}),this.wrap(a,b).apply(this,c)},wrap:function(a,b,c){function d(){var d=[],f=arguments.length,g=!a||a&&a.deep!==!1;for(c&&s(c)&&c.apply(this,arguments);f--;)d[f]=g?e.wrap(a,arguments[f]):arguments[f];try{return b.apply(this,d)}catch(h){throw e.L(),e.captureException(h,a),h}}var e=this;if(r(b)&&!s(a))return a;if(s(a)&&(b=a,a=void 0),!s(b))return b;try{if(b.M)return b;if(b.N)return b.N}catch(f){return b}for(var g in b)A(b,g)&&(d[g]=b[g]);return d.prototype=b.prototype,b.N=d,d.M=!0,d.O=b,d},uninstall:function(){return g.report.uninstall(),this.P(),this.Q(),this.R(),this.S(),Error.stackTraceLimit=this.o,this.n=!1,this},T:function(a){this.z("debug","Raven caught unhandled promise rejection:",a),this.captureException(a.reason,{mechanism:{type:"onunhandledrejection",handled:!1}})},B:function(){return this.T=this.T.bind(this),R.addEventListener&&R.addEventListener("unhandledrejection",this.T),this},P:function(){return R.removeEventListener&&R.removeEventListener("unhandledrejection",this.T),this},captureException:function(a,b){if(b=x({trimHeadFrames:0},b?b:{}),l(a)&&a.error)a=a.error;else{if(m(a)||n(a)){var c=a.name||(m(a)?"DOMError":"DOMException"),d=a.message?c+": "+a.message:c;return this.captureMessage(d,x(b,{stacktrace:!0,trimHeadFrames:b.trimHeadFrames+1}))}if(o(a))a=a;else{if(!q(a))return this.captureMessage(a,x(b,{stacktrace:!0,trimHeadFrames:b.trimHeadFrames+1}));b=this.U(b,a),a=new Error(b.message)}}this.d=a;try{var e=g.computeStackTrace(a);this.V(e,b)}catch(f){if(a!==f)throw f}return this},U:function(a,b){var c=Object.keys(b).sort(),d=x(a,{message:"Non-Error exception captured with keys: "+L(c),fingerprint:[i(c)],extra:a.extra||{}});return d.extra.W=M(b),d},captureMessage:function(a,b){if(!this.k.ignoreErrors.test||!this.k.ignoreErrors.test(a)){b=b||{},a+="";var c,d=x({message:a},b);try{throw new Error(a)}catch(e){c=e}c.name=null;var f=g.computeStackTrace(c),h=u(f.stack)&&f.stack[1];h&&"Raven.captureException"===h.func&&(h=f.stack[2]);var i=h&&h.url||"";if((!this.k.ignoreUrls.test||!this.k.ignoreUrls.test(i))&&(!this.k.whitelistUrls.test||this.k.whitelistUrls.test(i))){if(this.k.stacktrace||b.stacktrace||""===d.message){d.fingerprint=null==d.fingerprint?a:d.fingerprint,b=x({trimHeadFrames:0},b),b.trimHeadFrames+=1;var j=this.X(f,b);d.stacktrace={frames:j.reverse()}}return d.fingerprint&&(d.fingerprint=u(d.fingerprint)?d.fingerprint:[d.fingerprint]),this.Y(d),this}}},captureBreadcrumb:function(a){var b=x({timestamp:d()/1e3},a);if(s(this.k.breadcrumbCallback)){var c=this.k.breadcrumbCallback(b);if(p(c)&&!v(c))b=c;else if(c===!1)return this}return this.u.push(b),this.u.length>this.k.maxBreadcrumbs&&this.u.shift(),this},addPlugin:function(a){var b=[].slice.call(arguments,1);return this.r.push([a,b]),this.n&&this.F(),this},setUserContext:function(a){return this.j.user=a,this},setExtraContext:function(a){return this.Z("extra",a),this},setTagsContext:function(a){return this.Z("tags",a),this},clearContext:function(){return this.j={},this},getContext:function(){return JSON.parse(h(this.j))},setEnvironment:function(a){return this.k.environment=a,this},setRelease:function(a){return this.k.release=a,this},setDataCallback:function(a){var b=this.k.dataCallback;return this.k.dataCallback=e(b,a),this},setBreadcrumbCallback:function(a){var b=this.k.breadcrumbCallback;return this.k.breadcrumbCallback=e(b,a),this},setShouldSendCallback:function(a){var b=this.k.shouldSendCallback;return this.k.shouldSendCallback=e(b,a),this},setTransport:function(a){return this.k.transport=a,this},lastException:function(){return this.d},lastEventId:function(){return this.f},isSetup:function(){return!!this.a&&(!!this.g||(this.ravenNotConfiguredError||(this.ravenNotConfiguredError=!0,this.z("error","Error: Raven has not been configured.")),!1))},afterLoad:function(){var a=R.RavenConfig;a&&this.config(a.dsn,a.config).install()},showReportDialog:function(a){if(S){if(a=x({eventId:this.lastEventId(),dsn:this.H,user:this.j.user||{}},a),!a.eventId)throw new j("Missing eventId");if(!a.dsn)throw new j("Missing DSN");var b=encodeURIComponent,c=[];for(var d in a)if("user"===d){var e=a.user;e.name&&c.push("name="+b(e.name)),e.email&&c.push("email="+b(e.email))}else c.push(b(d)+"="+b(a[d]));var f=this.J(this.G(a.dsn)),g=S.createElement("script");g.async=!0,g.src=f+"/api/embed/error-page/?"+c.join("&"),(S.head||S.body).appendChild(g)}},L:function(){var a=this;this.m+=1,setTimeout(function(){a.m-=1})},$:function(a,b){var c,d;if(this.b){b=b||{},a="raven"+a.substr(0,1).toUpperCase()+a.substr(1),S.createEvent?(c=S.createEvent("HTMLEvents"),c.initEvent(a,!0,!0)):(c=S.createEventObject(),c.eventType=a);for(d in b)A(b,d)&&(c[d]=b[d]);if(S.createEvent)S.dispatchEvent(c);else try{S.fireEvent("on"+c.eventType.toLowerCase(),c)}catch(e){}}},_:function(a){var b=this;return function(c){if(b.aa=null,b.v!==c){b.v=c;var d;try{d=E(c.target)}catch(e){d="<unknown>"}b.captureBreadcrumb({category:"ui."+a,message:d})}}},ba:function(){var a=this,b=1e3;return function(c){var d;try{d=c.target}catch(e){return}var f=d&&d.tagName;if(f&&("INPUT"===f||"TEXTAREA"===f||d.isContentEditable)){var g=a.aa;g||a._("input")(c),clearTimeout(g),a.aa=setTimeout(function(){a.aa=null},b)}}},ca:function(a,b){var c=H(this.w.href),d=H(b),e=H(a);this.x=b,c.protocol===d.protocol&&c.host===d.host&&(b=d.relative),c.protocol===e.protocol&&c.host===e.host&&(a=e.relative),this.captureBreadcrumb({category:"navigation",data:{to:b,from:a}})},C:function(){var a=this;a.da=Function.prototype.toString,Function.prototype.toString=function(){return"function"==typeof this&&this.M?a.da.apply(this.O,arguments):a.da.apply(this,arguments)}},Q:function(){this.da&&(Function.prototype.toString=this.da)},D:function(){function a(a){return function(b,d){for(var e=new Array(arguments.length),f=0;f<e.length;++f)e[f]=arguments[f];var g=e[0];return s(g)&&(e[0]=c.wrap({mechanism:{type:"instrument",data:{"function":a.name||"<anonymous>"}}},g)),a.apply?a.apply(this,e):a(e[0],e[1])}}function b(a){var b=R[a]&&R[a].prototype;b&&b.hasOwnProperty&&b.hasOwnProperty("addEventListener")&&(I(b,"addEventListener",function(b){return function(d,f,g,h){try{f&&f.handleEvent&&(f.handleEvent=c.wrap({mechanism:{type:"instrument",data:{target:a,"function":"handleEvent",handler:f&&f.name||"<anonymous>"}}},f.handleEvent))}catch(i){}var j,k,l;return e&&e.dom&&("EventTarget"===a||"Node"===a)&&(k=c._("click"),l=c.ba(),j=function(a){if(a){var b;try{b=a.type}catch(c){return}return"click"===b?k(a):"keypress"===b?l(a):void 0}}),b.call(this,d,c.wrap({mechanism:{type:"instrument",data:{target:a,"function":"addEventListener",handler:f&&f.name||"<anonymous>"}}},f,j),g,h)}},d),I(b,"removeEventListener",function(a){return function(b,c,d,e){try{c=c&&(c.N?c.N:c)}catch(f){}return a.call(this,b,c,d,e)}},d))}var c=this,d=c.t,e=this.k.autoBreadcrumbs;I(R,"setTimeout",a,d),I(R,"setInterval",a,d),R.requestAnimationFrame&&I(R,"requestAnimationFrame",function(a){return function(b){return a(c.wrap({mechanism:{type:"instrument",data:{"function":"requestAnimationFrame",handler:a&&a.name||"<anonymous>"}}},b))}},d);for(var f=["EventTarget","Window","Node","ApplicationCache","AudioTrackList","ChannelMergerNode","CryptoOperation","EventSource","FileReader","HTMLUnknownElement","IDBDatabase","IDBRequest","IDBTransaction","KeyOperation","MediaController","MessagePort","ModalWindow","Notification","SVGElementInstance","Screen","TextTrack","TextTrackCue","TextTrackList","WebSocket","WebSocketWorker","Worker","XMLHttpRequest","XMLHttpRequestEventTarget","XMLHttpRequestUpload"],g=0;g<f.length;g++)b(f[g])},E:function(){function a(a,c){a in c&&s(c[a])&&I(c,a,function(c){return b.wrap({mechanism:{type:"instrument",data:{"function":a,handler:c&&c.name||"<anonymous>"}}},c)})}var b=this,c=this.k.autoBreadcrumbs,d=b.t;if(c.xhr&&"XMLHttpRequest"in R){var e=R.XMLHttpRequest&&R.XMLHttpRequest.prototype;I(e,"open",function(a){return function(c,d){return t(d)&&d.indexOf(b.h)===-1&&(this.ea={method:c,url:d,status_code:null}),a.apply(this,arguments)}},d),I(e,"send",function(c){return function(){function d(){if(e.ea&&4===e.readyState){try{e.ea.status_code=e.status}catch(a){}b.captureBreadcrumb({type:"http",category:"xhr",data:e.ea})}}for(var e=this,f=["onload","onerror","onprogress"],g=0;g<f.length;g++)a(f[g],e);return"onreadystatechange"in e&&s(e.onreadystatechange)?I(e,"onreadystatechange",function(a){return b.wrap({mechanism:{type:"instrument",data:{"function":"onreadystatechange",handler:a&&a.name||"<anonymous>"}}},a,d)}):e.onreadystatechange=d,c.apply(this,arguments)}},d)}c.xhr&&J()&&I(R,"fetch",function(a){return function(){for(var c=new Array(arguments.length),d=0;d<c.length;++d)c[d]=arguments[d];var e,f=c[0],g="GET";if("string"==typeof f?e=f:"Request"in R&&f instanceof R.Request?(e=f.url,f.method&&(g=f.method)):e=""+f,e.indexOf(b.h)!==-1)return a.apply(this,c);c[1]&&c[1].method&&(g=c[1].method);var h={method:g,url:e,status_code:null};return a.apply(this,c).then(function(a){return h.status_code=a.status,b.captureBreadcrumb({type:"http",category:"fetch",data:h}),a})["catch"](function(a){throw b.captureBreadcrumb({type:"http",category:"fetch",data:h,level:"error"}),a})}},d),c.dom&&this.b&&(S.addEventListener?(S.addEventListener("click",b._("click"),!1),S.addEventListener("keypress",b.ba(),!1)):S.attachEvent&&(S.attachEvent("onclick",b._("click")),S.attachEvent("onkeypress",b.ba())));var f=R.chrome,g=f&&f.app&&f.app.runtime,h=!g&&R.history&&R.history.pushState&&R.history.replaceState;if(c.location&&h){var i=R.onpopstate;R.onpopstate=function(){var a=b.w.href;if(b.ca(b.x,a),i)return i.apply(this,arguments)};var j=function(a){return function(){var c=arguments.length>2?arguments[2]:void 0;return c&&b.ca(b.x,c+""),a.apply(this,arguments)}};I(R.history,"pushState",j,d),I(R.history,"replaceState",j,d)}if(c.console&&"console"in R&&console.log){var k=function(a,c){b.captureBreadcrumb({message:a,level:c.level,category:"console"})};w(["debug","info","warn","error","log"],function(a,b){O(console,b,k)})}},R:function(){for(var a;this.t.length;){a=this.t.shift();var b=a[0],c=a[1],d=a[2];b[c]=d}},S:function(){for(var a in this.q)this.p[a]=this.q[a]},F:function(){var a=this;w(this.r,function(b,c){var d=c[0],e=c[1];d.apply(a,[a].concat(e))})},G:function(a){var b=Q.exec(a),c={},d=7;try{for(;d--;)c[P[d]]=b[d]||""}catch(e){throw new j("Invalid DSN: "+a)}if(c.pass&&!this.k.allowSecretKey)throw new j("Do not specify your secret key in the DSN. See: http://bit.ly/raven-secret-key");return c},J:function(a){var b="//"+a.host+(a.port?":"+a.port:"");return a.protocol&&(b=a.protocol+":"+b),b},A:function(a,b){b=b||{},b.mechanism=b.mechanism||{type:"onerror",handled:!1},this.m||this.V(a,b)},V:function(a,b){var c=this.X(a,b);this.$("handle",{stackInfo:a,options:b}),this.fa(a.name,a.message,a.url,a.lineno,c,b)},X:function(a,b){var c=this,d=[];if(a.stack&&a.stack.length&&(w(a.stack,function(b,e){var f=c.ga(e,a.url);f&&d.push(f)}),b&&b.trimHeadFrames))for(var e=0;e<b.trimHeadFrames&&e<d.length;e++)d[e].in_app=!1;return d=d.slice(0,this.k.stackTraceLimit)},ga:function(a,b){var c={filename:a.url,lineno:a.line,colno:a.column,"function":a.func||"?"};return a.url||(c.filename=b),c.in_app=!(this.k.includePaths.test&&!this.k.includePaths.test(c.filename)||/(Raven|TraceKit)\./.test(c["function"])||/raven\.(min\.)?js$/.test(c.filename)),c},fa:function(a,b,c,d,e,f){var g=(a?a+": ":"")+(b||"");if(!this.k.ignoreErrors.test||!this.k.ignoreErrors.test(b)&&!this.k.ignoreErrors.test(g)){var h;if(e&&e.length?(c=e[0].filename||c,e.reverse(),h={frames:e}):c&&(h={frames:[{filename:c,lineno:d,in_app:!0}]}),(!this.k.ignoreUrls.test||!this.k.ignoreUrls.test(c))&&(!this.k.whitelistUrls.test||this.k.whitelistUrls.test(c))){var i=x({exception:{values:[{type:a,value:b,stacktrace:h}]},transaction:c},f),j=i.exception.values[0];null==j.type&&""===j.value&&(j.value="Unrecoverable error caught"),!i.exception.mechanism&&i.mechanism&&(i.exception.mechanism=i.mechanism,delete i.mechanism),i.exception.mechanism=x({type:"generic",handled:!0},i.exception.mechanism||{}),this.Y(i)}}},ha:function(a){var b=this.k.maxMessageLength;if(a.message&&(a.message=y(a.message,b)),a.exception){var c=a.exception.values[0];c.value=y(c.value,b)}var d=a.request;return d&&(d.url&&(d.url=y(d.url,this.k.maxUrlLength)),d.Referer&&(d.Referer=y(d.Referer,this.k.maxUrlLength))),a.breadcrumbs&&a.breadcrumbs.values&&this.ia(a.breadcrumbs),a},ia:function(a){for(var b,c,d,e=["to","from","url"],f=0;f<a.values.length;++f)if(c=a.values[f],c.hasOwnProperty("data")&&p(c.data)&&!z(c.data)){d=x({},c.data);for(var g=0;g<e.length;++g)b=e[g],d.hasOwnProperty(b)&&d[b]&&(d[b]=y(d[b],this.k.maxUrlLength));a.values[f].data=d}},ja:function(){if(this.c||this.b){var a={};return this.c&&T.userAgent&&(a.headers={"User-Agent":T.userAgent}),R.location&&R.location.href&&(a.url=R.location.href),this.b&&S.referrer&&(a.headers||(a.headers={}),a.headers.Referer=S.referrer),a}},y:function(){this.ka=0,this.la=null},ma:function(){return this.ka&&d()-this.la<this.ka},na:function(a){var b=this.e;return!(!b||a.message!==b.message||a.transaction!==b.transaction)&&(a.stacktrace||b.stacktrace?G(a.stacktrace,b.stacktrace):!a.exception&&!b.exception||F(a.exception,b.exception))},oa:function(a){if(!this.ma()){var b=a.status;if(400===b||401===b||429===b){var c;try{c=J()?a.headers.get("Retry-After"):a.getResponseHeader("Retry-After"),c=1e3*parseInt(c,10)}catch(e){}this.ka=c?c:2*this.ka||1e3,this.la=d()}}},Y:function(a){var b=this.k,c={project:this.i,logger:b.logger,platform:"javascript"},e=this.ja();if(e&&(c.request=e),a.trimHeadFrames&&delete a.trimHeadFrames,a=x(c,a),a.tags=x(x({},this.j.tags),a.tags),a.extra=x(x({},this.j.extra),a.extra),a.extra["session:duration"]=d()-this.s,this.u&&this.u.length>0&&(a.breadcrumbs={values:[].slice.call(this.u,0)}),this.j.user&&(a.user=this.j.user),b.environment&&(a.environment=b.environment),b.release&&(a.release=b.release),b.serverName&&(a.server_name=b.serverName),a=this.pa(a),Object.keys(a).forEach(function(b){(null==a[b]||""===a[b]||v(a[b]))&&delete a[b]}),s(b.dataCallback)&&(a=b.dataCallback(a)||a),a&&!v(a)&&(!s(b.shouldSendCallback)||b.shouldSendCallback(a)))return this.ma()?void this.z("warn","Raven dropped error due to backoff: ",a):void("number"==typeof b.sampleRate?Math.random()<b.sampleRate&&this.qa(a):this.qa(a))},pa:function(a){return N(a,this.k.sanitizeKeys)},ra:function(){return D()},qa:function(a,b){var c=this,d=this.k;if(this.isSetup()){if(a=this.ha(a),!this.k.allowDuplicates&&this.na(a))return void this.z("warn","Raven dropped repeat event: ",a);this.f=a.event_id||(a.event_id=this.ra()),this.e=a,this.z("debug","Raven about to send:",a);var e={sentry_version:"7",sentry_client:"raven-js/"+this.VERSION,sentry_key:this.h};this.I&&(e.sentry_secret=this.I);var f=a.exception&&a.exception.values[0];this.k.autoBreadcrumbs&&this.k.autoBreadcrumbs.sentry&&this.captureBreadcrumb({category:"sentry",message:f?(f.type?f.type+": ":"")+f.value:a.message,event_id:a.event_id,level:a.level||"error"});var g=this.K;(d.transport||this._makeRequest).call(this,{url:g,auth:e,data:a,options:d,onSuccess:function(){c.y(),c.$("success",{data:a,src:g}),b&&b()},onError:function(d){c.z("error","Raven transport failed to send: ",d),d.request&&c.oa(d.request),c.$("failure",{data:a,src:g}),d=d||new Error("Raven send failed (no additional details provided)"),b&&b(d)}})}},_makeRequest:function(a){var b=a.url+"?"+C(a.auth),c=null,d={};if(a.options.headers&&(c=this.sa(a.options.headers)),a.options.fetchParameters&&(d=this.sa(a.options.fetchParameters)),J()){d.body=h(a.data);var e=x({},this.l),f=x(e,d);return c&&(f.headers=c),R.fetch(b,f).then(function(b){if(b.ok)a.onSuccess&&a.onSuccess();else{var c=new Error("Sentry error code: "+b.status);c.request=b,a.onError&&a.onError(c)}})["catch"](function(){a.onError&&a.onError(new Error("Sentry error code: network unavailable"))})}var g=R.XMLHttpRequest&&new R.XMLHttpRequest;if(g){var i="withCredentials"in g||"undefined"!=typeof XDomainRequest;i&&("withCredentials"in g?g.onreadystatechange=function(){if(4===g.readyState)if(200===g.status)a.onSuccess&&a.onSuccess();else if(a.onError){var b=new Error("Sentry error code: "+g.status);b.request=g,a.onError(b)}}:(g=new XDomainRequest,b=b.replace(/^https?:/,""),a.onSuccess&&(g.onload=a.onSuccess),a.onError&&(g.onerror=function(){var b=new Error("Sentry error code: XDomainRequest");b.request=g,a.onError(b)})),g.open("POST",b),c&&w(c,function(a,b){g.setRequestHeader(a,b)}),g.send(h(a.data)))}},sa:function(a){var b={};for(var c in a)if(a.hasOwnProperty(c)){var d=a[c];b[c]="function"==typeof d?d():d}return b},z:function(a){this.q[a]&&(this.debug||this.k.debug)&&Function.prototype.apply.call(this.q[a],this.p,[].slice.call(arguments,1))},Z:function(a,b){r(b)?delete this.j[a]:this.j[a]=x(this.j[a]||{},b)}},f.prototype.setUser=f.prototype.setUserContext,f.prototype.setReleaseContext=f.prototype.setRelease,b.exports=f}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{1:1,2:2,5:5,6:6,7:7,8:8}],4:[function(a,b,c){(function(c){var d=a(3),e="undefined"!=typeof window?window:"undefined"!=typeof c?c:"undefined"!=typeof self?self:{},f=e.Raven,g=new d;g.noConflict=function(){return e.Raven=f,g},g.afterLoad(),b.exports=g,b.exports.Client=d}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{3:3}],5:[function(a,b,c){(function(c){function d(a){return"object"==typeof a&&null!==a}function e(a){switch(Object.prototype.toString.call(a)){case"[object Error]":return!0;case"[object Exception]":return!0;case"[object DOMException]":return!0;default:return a instanceof Error}}function f(a){return"[object ErrorEvent]"===Object.prototype.toString.call(a)}function g(a){return"[object DOMError]"===Object.prototype.toString.call(a)}function h(a){return"[object DOMException]"===Object.prototype.toString.call(a)}function i(a){return void 0===a}function j(a){return"function"==typeof a}function k(a){return"[object Object]"===Object.prototype.toString.call(a)}function l(a){return"[object String]"===Object.prototype.toString.call(a)}function m(a){return"[object Array]"===Object.prototype.toString.call(a)}function n(a){if(!k(a))return!1;for(var b in a)if(a.hasOwnProperty(b))return!1;return!0}function o(){try{return new ErrorEvent(""),!0}catch(a){return!1}}function p(){try{return new DOMError(""),!0}catch(a){return!1}}function q(){try{return new DOMException(""),!0}catch(a){return!1}}function r(){if(!("fetch"in U))return!1;try{return new Headers,new Request(""),new Response,!0}catch(a){return!1}}function s(){if(!r())return!1;try{return new Request("pickleRick",{referrerPolicy:"origin"}),!0}catch(a){return!1}}function t(){return"function"==typeof PromiseRejectionEvent}function u(a){function b(b,c){var d=a(b)||b;return c?c(d)||d:d}return b}function v(a,b){var c,d;if(i(a.length))for(c in a)z(a,c)&&b.call(null,c,a[c]);else if(d=a.length)for(c=0;c<d;c++)b.call(null,c,a[c])}function w(a,b){return b?(v(b,function(b,c){a[b]=c}),a):a}function x(a){return!!Object.isFrozen&&Object.isFrozen(a)}function y(a,b){if("number"!=typeof b)throw new Error("2nd argument to `truncate` function should be a number");return"string"!=typeof a||0===b?a:a.length<=b?a:a.substr(0,b)+"…"}function z(a,b){return Object.prototype.hasOwnProperty.call(a,b)}function A(a){for(var b,c=[],d=0,e=a.length;d<e;d++)b=a[d],l(b)?c.push(b.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")):b&&b.source&&c.push(b.source);return new RegExp(c.join("|"),"i")}function B(a){var b=[];return v(a,function(a,c){b.push(encodeURIComponent(a)+"="+encodeURIComponent(c))}),b.join("&")}function C(a){if("string"!=typeof a)return{};var b=a.match(/^(([^:\/?#]+):)?(\/\/([^\/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?$/),c=b[6]||"",d=b[8]||"";return{protocol:b[2],host:b[4],path:b[5],relative:b[5]+c+d}}function D(){var a=U.crypto||U.msCrypto;if(!i(a)&&a.getRandomValues){var b=new Uint16Array(8);a.getRandomValues(b),b[3]=4095&b[3]|16384,b[4]=16383&b[4]|32768;var c=function(a){for(var b=a.toString(16);b.length<4;)b="0"+b;return b};return c(b[0])+c(b[1])+c(b[2])+c(b[3])+c(b[4])+c(b[5])+c(b[6])+c(b[7])}return"xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"===a?b:3&b|8;return c.toString(16)})}function E(a){for(var b,c=5,d=80,e=[],f=0,g=0,h=" > ",i=h.length;a&&f++<c&&(b=F(a),!("html"===b||f>1&&g+e.length*i+b.length>=d));)e.push(b),g+=b.length,a=a.parentNode;return e.reverse().join(h)}function F(a){var b,c,d,e,f,g=[];if(!a||!a.tagName)return"";if(g.push(a.tagName.toLowerCase()),a.id&&g.push("#"+a.id),b=a.className,b&&l(b))for(c=b.split(/\s+/),f=0;f<c.length;f++)g.push("."+c[f]);var h=["type","name","title","alt"];for(f=0;f<h.length;f++)d=h[f],e=a.getAttribute(d),e&&g.push("["+d+'="'+e+'"]');return g.join("")}function G(a,b){return!!(!!a^!!b)}function H(a,b){return i(a)&&i(b)}function I(a,b){return!G(a,b)&&(a=a.values[0],b=b.values[0],a.type===b.type&&a.value===b.value&&(!H(a.stacktrace,b.stacktrace)&&J(a.stacktrace,b.stacktrace)))}function J(a,b){if(G(a,b))return!1;var c=a.frames,d=b.frames;if(void 0===c||void 0===d)return!1;if(c.length!==d.length)return!1;for(var e,f,g=0;g<c.length;g++)if(e=c[g],f=d[g],e.filename!==f.filename||e.lineno!==f.lineno||e.colno!==f.colno||e["function"]!==f["function"])return!1;return!0}function K(a,b,c,d){if(null!=a){var e=a[b];a[b]=c(e),a[b].M=!0,a[b].O=e,d&&d.push([a,b,e])}}function L(a,b){if(!m(a))return"";for(var c=[],d=0;d<a.length;d++)try{c.push(String(a[d]))}catch(e){c.push("[value cannot be serialized]")}return c.join(b)}function M(a){return~-encodeURI(a).split(/%..|./).length}function N(a){return M(JSON.stringify(a))}function O(a){if("string"==typeof a){var b=40;return y(a,b)}if("number"==typeof a||"boolean"==typeof a||"undefined"==typeof a)return a;var c=Object.prototype.toString.call(a);return"[object Object]"===c?"[Object]":"[object Array]"===c?"[Array]":"[object Function]"===c?a.name?"[Function: "+a.name+"]":"[Function]":a}function P(a,b){return 0===b?O(a):k(a)?Object.keys(a).reduce(function(c,d){return c[d]=P(a[d],b-1),c},{}):Array.isArray(a)?a.map(function(a){return P(a,b-1)}):O(a)}function Q(a,b,c){if(!k(a))return a;b="number"!=typeof b?V:b,c="number"!=typeof b?W:c;var d=P(a,b);return N(T(d))>c?Q(a,b-1):d}function R(a,b){if("number"==typeof a||"string"==typeof a)return a.toString();if(!Array.isArray(a))return"";if(a=a.filter(function(a){return"string"==typeof a}),0===a.length)return"[object has no keys]";if(b="number"!=typeof b?X:b,a[0].length>=b)return a[0];for(var c=a.length;c>0;c--){var d=a.slice(0,c).join(", ");if(!(d.length>b))return c===a.length?d:d+"…"}return""}function S(a,b){function c(a){return m(a)?a.map(function(a){return c(a)}):k(a)?Object.keys(a).reduce(function(b,d){return b[d]=e.test(d)?f:c(a[d]),b},{}):a}if(!m(b)||m(b)&&0===b.length)return a;var d,e=A(b),f="********";try{d=JSON.parse(T(a))}catch(g){return a}return c(d)}var T=a(7),U="undefined"!=typeof window?window:"undefined"!=typeof c?c:"undefined"!=typeof self?self:{},V=3,W=51200,X=40;b.exports={isObject:d,isError:e,isErrorEvent:f,isDOMError:g,isDOMException:h,isUndefined:i,isFunction:j,isPlainObject:k,isString:l,isArray:m,isEmptyObject:n,supportsErrorEvent:o,supportsDOMError:p,supportsDOMException:q,supportsFetch:r,supportsReferrerPolicy:s,supportsPromiseRejectionEvent:t,wrappedCallback:u,each:v,objectMerge:w,truncate:y,objectFrozen:x,hasKey:z,joinRegExp:A,urlencode:B,uuid4:D,htmlTreeAsString:E,htmlElementAsString:F,isSameException:I,isSameStacktrace:J,parseUrl:C,fill:K,safeJoin:L,serializeException:Q,serializeKeysForMessage:R,sanitize:S}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{7:7}],6:[function(a,b,c){(function(c){function d(){return"undefined"==typeof document||null==document.location?"":document.location.href}function e(){return"undefined"==typeof document||null==document.location?"":document.location.origin?document.location.origin:document.location.protocol+"//"+document.location.hostname+(document.location.port?":"+document.location.port:"")}var f=a(5),g={collectWindowErrors:!0,debug:!1},h="undefined"!=typeof window?window:"undefined"!=typeof c?c:"undefined"!=typeof self?self:{},i=[].slice,j="?",k=/^(?:[Uu]ncaught (?:exception: )?)?(?:((?:Eval|Internal|Range|Reference|Syntax|Type|URI|)Error): )?(.*)$/;g.report=function(){function a(a){m(),s.push(a)}function b(a){for(var b=s.length-1;b>=0;--b)s[b]===a&&s.splice(b,1)}function c(){n(),s=[]}function e(a,b){var c=null;if(!b||g.collectWindowErrors){for(var d in s)if(s.hasOwnProperty(d))try{s[d].apply(null,[a].concat(i.call(arguments,2)))}catch(e){c=e}if(c)throw c}}function l(a,b,c,h,i){var l=null,m=f.isErrorEvent(i)?i.error:i,n=f.isErrorEvent(a)?a.message:a;if(v)g.computeStackTrace.augmentStackTraceWithInitialElement(v,b,c,n),o();else if(m&&f.isError(m))l=g.computeStackTrace(m),e(l,!0);else{var p,r={url:b,line:c,column:h},s=void 0;if("[object String]"==={}.toString.call(n)){var p=n.match(k);p&&(s=p[1],n=p[2])}r.func=j,l={name:s,message:n,url:d(),stack:[r]},e(l,!0)}return!!q&&q.apply(this,arguments)}function m(){r||(q=h.onerror,h.onerror=l,r=!0)}function n(){r&&(h.onerror=q,r=!1,q=void 0)}function o(){var a=v,b=t;t=null,v=null,u=null,e.apply(null,[a,!1].concat(b))}function p(a,b){var c=i.call(arguments,1);if(v){if(u===a)return;o()}var d=g.computeStackTrace(a);if(v=d,u=a,t=c,setTimeout(function(){u===a&&o()},d.incomplete?2e3:0),b!==!1)throw a}var q,r,s=[],t=null,u=null,v=null;return p.subscribe=a,p.unsubscribe=b,p.uninstall=c,p}(),g.computeStackTrace=function(){function a(a){if("undefined"!=typeof a.stack&&a.stack){for(var b,c,f,g=/^\s*at (?:(.*?) ?\()?((?:file|https?|blob|chrome-extension|native|eval|webpack|<anonymous>|[a-z]:|\/).*?)(?::(\d+))?(?::(\d+))?\)?\s*$/i,h=/^\s*at (?:((?:\[object object\])?.+) )?\(?((?:file|ms-appx(?:-web)|https?|webpack|blob):.*?):(\d+)(?::(\d+))?\)?\s*$/i,i=/^\s*(.*?)(?:\((.*?)\))?(?:^|@)((?:file|https?|blob|chrome|webpack|resource|moz-extension).*?:\/.*?|\[native code\]|[^@]*bundle)(?::(\d+))?(?::(\d+))?\s*$/i,k=/(\S+) line (\d+)(?: > eval line \d+)* > eval/i,l=/\((\S*)(?::(\d+))(?::(\d+))\)/,m=a.stack.split("\n"),n=[],o=(/^(.*) is undefined$/.exec(a.message),0),p=m.length;o<p;++o){if(c=g.exec(m[o])){var q=c[2]&&0===c[2].indexOf("native"),r=c[2]&&0===c[2].indexOf("eval");r&&(b=l.exec(c[2]))&&(c[2]=b[1],c[3]=b[2],c[4]=b[3]),f={url:q?null:c[2],func:c[1]||j,args:q?[c[2]]:[],line:c[3]?+c[3]:null,column:c[4]?+c[4]:null}}else if(c=h.exec(m[o]))f={url:c[2],func:c[1]||j,args:[],line:+c[3],column:c[4]?+c[4]:null};else{if(!(c=i.exec(m[o])))continue;var r=c[3]&&c[3].indexOf(" > eval")>-1;r&&(b=k.exec(c[3]))?(c[3]=b[1],c[4]=b[2],c[5]=null):0!==o||c[5]||"undefined"==typeof a.columnNumber||(n[0].column=a.columnNumber+1),f={url:c[3],func:c[1]||j,args:c[2]?c[2].split(","):[],line:c[4]?+c[4]:null,column:c[5]?+c[5]:null}}if(!f.func&&f.line&&(f.func=j),f.url&&"blob:"===f.url.substr(0,5)){var s=new XMLHttpRequest;if(s.open("GET",f.url,!1),s.send(null),200===s.status){var t=s.responseText||"";t=t.slice(-300);var u=t.match(/\/\/# sourceMappingURL=(.*)$/);if(u){var v=u[1];"~"===v.charAt(0)&&(v=e()+v.slice(1)),f.url=v.slice(0,-4)}}}n.push(f)}return n.length?{name:a.name,message:a.message,url:d(),stack:n}:null}}function b(a,b,c,d){var e={url:b,line:c};if(e.url&&e.line){if(a.incomplete=!1,e.func||(e.func=j),a.stack.length>0&&a.stack[0].url===e.url){if(a.stack[0].line===e.line)return!1;if(!a.stack[0].line&&a.stack[0].func===e.func)return a.stack[0].line=e.line,
!1}return a.stack.unshift(e),a.partial=!0,!0}return a.incomplete=!0,!1}function c(a,e){for(var h,i,k=/function\s+([_$a-zA-Z\xA0-\uFFFF][_$a-zA-Z0-9\xA0-\uFFFF]*)?\s*\(/i,l=[],m={},n=!1,o=c.caller;o&&!n;o=o.caller)if(o!==f&&o!==g.report){if(i={url:null,func:j,line:null,column:null},o.name?i.func=o.name:(h=k.exec(o.toString()))&&(i.func=h[1]),"undefined"==typeof i.func)try{i.func=h.input.substring(0,h.input.indexOf("{"))}catch(p){}m[""+o]?n=!0:m[""+o]=!0,l.push(i)}e&&l.splice(0,e);var q={name:a.name,message:a.message,url:d(),stack:l};return b(q,a.sourceURL||a.fileName,a.line||a.lineNumber,a.message||a.description),q}function f(b,e){var f=null;e=null==e?0:+e;try{if(f=a(b))return f}catch(h){if(g.debug)throw h}try{if(f=c(b,e+1))return f}catch(h){if(g.debug)throw h}return{name:b.name,message:b.message,url:d()}}return f.augmentStackTraceWithInitialElement=b,f.computeStackTraceFromStackProp=a,f}(),b.exports=g}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{5:5}],7:[function(a,b,c){function d(a,b){for(var c=0;c<a.length;++c)if(a[c]===b)return c;return-1}function e(a,b,c,d){return JSON.stringify(a,g(b,d),c)}function f(a){var b={stack:a.stack,message:a.message,name:a.name};for(var c in a)Object.prototype.hasOwnProperty.call(a,c)&&(b[c]=a[c]);return b}function g(a,b){var c=[],e=[];return null==b&&(b=function(a,b){return c[0]===b?"[Circular ~]":"[Circular ~."+e.slice(0,d(c,b)).join(".")+"]"}),function(g,h){if(c.length>0){var i=d(c,this);~i?c.splice(i+1):c.push(this),~i?e.splice(i,1/0,g):e.push(g),~d(c,h)&&(h=b.call(this,g,h))}else c.push(h);return null==a?h instanceof Error?f(h):h:a.call(this,g,h)}}c=b.exports=e,c.getSerialize=g},{}],8:[function(a,b,c){function d(a,b){var c=(65535&a)+(65535&b),d=(a>>16)+(b>>16)+(c>>16);return d<<16|65535&c}function e(a,b){return a<<b|a>>>32-b}function f(a,b,c,f,g,h){return d(e(d(d(b,a),d(f,h)),g),c)}function g(a,b,c,d,e,g,h){return f(b&c|~b&d,a,b,e,g,h)}function h(a,b,c,d,e,g,h){return f(b&d|c&~d,a,b,e,g,h)}function i(a,b,c,d,e,g,h){return f(b^c^d,a,b,e,g,h)}function j(a,b,c,d,e,g,h){return f(c^(b|~d),a,b,e,g,h)}function k(a,b){a[b>>5]|=128<<b%32,a[(b+64>>>9<<4)+14]=b;var c,e,f,k,l,m=1732584193,n=-271733879,o=-1732584194,p=271733878;for(c=0;c<a.length;c+=16)e=m,f=n,k=o,l=p,m=g(m,n,o,p,a[c],7,-680876936),p=g(p,m,n,o,a[c+1],12,-389564586),o=g(o,p,m,n,a[c+2],17,606105819),n=g(n,o,p,m,a[c+3],22,-1044525330),m=g(m,n,o,p,a[c+4],7,-176418897),p=g(p,m,n,o,a[c+5],12,1200080426),o=g(o,p,m,n,a[c+6],17,-1473231341),n=g(n,o,p,m,a[c+7],22,-45705983),m=g(m,n,o,p,a[c+8],7,1770035416),p=g(p,m,n,o,a[c+9],12,-1958414417),o=g(o,p,m,n,a[c+10],17,-42063),n=g(n,o,p,m,a[c+11],22,-1990404162),m=g(m,n,o,p,a[c+12],7,1804603682),p=g(p,m,n,o,a[c+13],12,-40341101),o=g(o,p,m,n,a[c+14],17,-1502002290),n=g(n,o,p,m,a[c+15],22,1236535329),m=h(m,n,o,p,a[c+1],5,-165796510),p=h(p,m,n,o,a[c+6],9,-1069501632),o=h(o,p,m,n,a[c+11],14,643717713),n=h(n,o,p,m,a[c],20,-373897302),m=h(m,n,o,p,a[c+5],5,-701558691),p=h(p,m,n,o,a[c+10],9,38016083),o=h(o,p,m,n,a[c+15],14,-660478335),n=h(n,o,p,m,a[c+4],20,-405537848),m=h(m,n,o,p,a[c+9],5,568446438),p=h(p,m,n,o,a[c+14],9,-1019803690),o=h(o,p,m,n,a[c+3],14,-187363961),n=h(n,o,p,m,a[c+8],20,1163531501),m=h(m,n,o,p,a[c+13],5,-1444681467),p=h(p,m,n,o,a[c+2],9,-51403784),o=h(o,p,m,n,a[c+7],14,1735328473),n=h(n,o,p,m,a[c+12],20,-1926607734),m=i(m,n,o,p,a[c+5],4,-378558),p=i(p,m,n,o,a[c+8],11,-2022574463),o=i(o,p,m,n,a[c+11],16,1839030562),n=i(n,o,p,m,a[c+14],23,-35309556),m=i(m,n,o,p,a[c+1],4,-1530992060),p=i(p,m,n,o,a[c+4],11,1272893353),o=i(o,p,m,n,a[c+7],16,-155497632),n=i(n,o,p,m,a[c+10],23,-1094730640),m=i(m,n,o,p,a[c+13],4,681279174),p=i(p,m,n,o,a[c],11,-358537222),o=i(o,p,m,n,a[c+3],16,-722521979),n=i(n,o,p,m,a[c+6],23,76029189),m=i(m,n,o,p,a[c+9],4,-640364487),p=i(p,m,n,o,a[c+12],11,-421815835),o=i(o,p,m,n,a[c+15],16,530742520),n=i(n,o,p,m,a[c+2],23,-995338651),m=j(m,n,o,p,a[c],6,-198630844),p=j(p,m,n,o,a[c+7],10,1126891415),o=j(o,p,m,n,a[c+14],15,-1416354905),n=j(n,o,p,m,a[c+5],21,-57434055),m=j(m,n,o,p,a[c+12],6,1700485571),p=j(p,m,n,o,a[c+3],10,-1894986606),o=j(o,p,m,n,a[c+10],15,-1051523),n=j(n,o,p,m,a[c+1],21,-2054922799),m=j(m,n,o,p,a[c+8],6,1873313359),p=j(p,m,n,o,a[c+15],10,-30611744),o=j(o,p,m,n,a[c+6],15,-1560198380),n=j(n,o,p,m,a[c+13],21,1309151649),m=j(m,n,o,p,a[c+4],6,-145523070),p=j(p,m,n,o,a[c+11],10,-1120210379),o=j(o,p,m,n,a[c+2],15,718787259),n=j(n,o,p,m,a[c+9],21,-343485551),m=d(m,e),n=d(n,f),o=d(o,k),p=d(p,l);return[m,n,o,p]}function l(a){var b,c="",d=32*a.length;for(b=0;b<d;b+=8)c+=String.fromCharCode(a[b>>5]>>>b%32&255);return c}function m(a){var b,c=[];for(c[(a.length>>2)-1]=void 0,b=0;b<c.length;b+=1)c[b]=0;var d=8*a.length;for(b=0;b<d;b+=8)c[b>>5]|=(255&a.charCodeAt(b/8))<<b%32;return c}function n(a){return l(k(m(a),8*a.length))}function o(a,b){var c,d,e=m(a),f=[],g=[];for(f[15]=g[15]=void 0,e.length>16&&(e=k(e,8*a.length)),c=0;c<16;c+=1)f[c]=909522486^e[c],g[c]=1549556828^e[c];return d=k(f.concat(m(b)),512+8*b.length),l(k(g.concat(d),640))}function p(a){var b,c,d="0123456789abcdef",e="";for(c=0;c<a.length;c+=1)b=a.charCodeAt(c),e+=d.charAt(b>>>4&15)+d.charAt(15&b);return e}function q(a){return unescape(encodeURIComponent(a))}function r(a){return n(q(a))}function s(a){return p(r(a))}function t(a,b){return o(q(a),q(b))}function u(a,b){return p(t(a,b))}function v(a,b,c){return b?c?t(b,a):u(b,a):c?r(a):s(a)}b.exports=v},{}]},{},[4])(4)});
//# sourceMappingURL=raven.min.js.map;

//# sourceMappingURL=main.js.map