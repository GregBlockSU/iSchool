cd advanced-databases
docker-compose up -d
docker-compose start jupyter drill zookeeper broker ksqldb-server ksqldb-cli schema-registry connect
docker-compose exec ksqldb-cli ksql http://ksqldb-server:8088

# 0. Start the ATM producer example from Jupyter, located at:
# /work/examples/Kafka-Producer.ipynb

CREATE STREAM atm (Id varchar, Location varchar, User varchar, TimeStamp bigint, Amount int, Status varchar) 
WITH (KAFKA_TOPIC='atm', VALUE_FORMAT='JSON', TIMESTAMP='TimeStamp');

# 1. Write a Drill query to display only the ATM transactions that ended in an Error status. Show all 
# columns and sort output so the newest errors are first. 
# NOTE: It is strongly suggested you use `backticks` and table aliases when working in Drill.

SELECT *
FROM kafka.`atm`
WHERE Status = 'error'
ORDER BY 'TimeStamp' DESC 

# 2. Write a Drill query to display the total amount withdrawn by user and do not include error 
# transactions in the totals.

SELECT a.`User`, SUM(Amount) AS TotalAmountWithdran
FROM kafka.`atm` AS A
GROUP BY a.`User`

# 3. Write KSQL to create a stream named weblogs from the JSON keys in the weblogs Kafka topic. Make 
# sure to set the TIMESTAMP property to the timestamp from the stream.

CREATE STREAM weblogs (Uri varchar, User varchar, TimeStamp bigint, Browser varchar, OS varchar)
WITH (KAFKA_TOPIC='weblogs', VALUE_FORMAT='JSON', TIMESTAMP='TimeStamp');

# 4. Write a KSQL statement to create a persistent stream/table called homepage that only displays 
# visitors to the root of the website (/). It should display all columns from the weblogs stream.

CREATE STREAM homepage AS SELECT * FROM weblogs WHERE Uri = '/';

SHOW QUERIES;

SHOW STREAMS;

DESCRIBE weblogs;

SELECT * FROM homepage EMIT CHANGES;

# 5. Write a KSQL statement to count operating systems users (OS) in 60-second windows. After 
#60 seconds, the counter should reset and counts should begin again.

SELECT Os, COUNT(*) FROM weblogs WINDOW TUMBLING (SIZE 60 SECONDS) GROUP BY Os EMIT CHANGES;

# 6. Write a KSQL persistent stream/table called user_activity, which will display a count of user activity 
# on the website within 1-minute sessions.

CREATE TABLE user_activity AS SELECT User, COUNT(*) FROM weblogs WINDOW TUMBLING (SIZE 60 SECONDS) GROUP BY User EMIT CHANGES;
