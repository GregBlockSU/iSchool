# from the command line
docker-compose start jupyter drill minio namenode datanode
docker run -it --name drill -p 8047:8047 -p 31010:31010 apache/drill
docker-compose ps

# from jupyter console
mc mb minio/labe

# from browser, view https://raw.githubusercontent.com/mafudge/datasets/master/weather/syracuse-ny.csv
# save file to downloads

# from minio console on browser (http://localhost:9001)
browse to labe bucket
upload file syracuse-ny.csv from Downloads

# from the command line, launch vscode
# look for drill-storage-plugins folder
# open file minio-drill.json and put all text into the clipboard
code .

# in drill browser, click on storage tab
# create a new storage plugin called labe and paste JSON code
# be sure to change bucket to labe
# click on query tab and type:
# note the back-ticks

SELECT * FROM labe.`syracuse-ny.csv`

# then edit the labe storage profile to add the segment below
# to the csv section
,
      "extractHeader": true


-- 2. Write a Drill SQL query to get the overall average min and max temperatures 
-- by year and month. Use Drillâ€™s SPLIT() function to separate Year, Month. 
-- You might need to use cast() to ensure the min and max temperatures are 
-- numeric types. Your output should include four columns: Year, Month, 
-- the average minimum temperature for that month, and the average 
-- maximum temperature for that month.
-- EST: 1970-01-01

CREATE VIEW labe.monthly_syracuse_weather_averages
AS
WITH
Source 
AS
(
	SELECT 	cast(split(EST, '-')[0] AS int) AS year, 
	        cast(split(EST, '-')[1] AS int) AS month, 
		    cast(Min_TemperatureF AS int) as mintemp, 
		    cast(Max_TemperatureF AS int) AS maxtemp
	FROM labe.`syracuse-ny.csv`
)
SELECT year, month, AVG(mintemp) AS avgmintemp, AVG(maxtemp) AS avgmaxtemp
FROM Source
GROUP BY year, month
ORDER BY year, month

-- 3 . Create a view called monthly_syracuse_weather_averages from the query you wrote in Question 2 and 
-- store it back on the labe bucket. (If you cannot get Question 2 working, use a similar query.) Provide your 
-- Drill SQL code and a screenshot showing the view file is on the Minio bucket.
-- NOTE: If you get an error about an immutable object, you need to change your storage config so you can 
-- write to the storage location.

SELECT *
FROM labe.monthly_syracuse_weather_averages
WHERE month = 7

